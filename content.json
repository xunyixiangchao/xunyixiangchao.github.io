{"pages":[{"title":"","text":"ä¸ªäººç®€ä»‹ åˆ†äº«å¾ˆå–œæ¬¢çš„è€ç½—çš„ä¸€æ®µè¯ï¼š â€œæ¯ä¸€ä¸ªç”Ÿå‘½æ¥åˆ°ä¸–é—´éƒ½æ³¨å®šæ”¹å˜ä¸–ç•Œï¼Œåˆ«æ— é€‰æ‹©ã€‚è¦ä¹ˆå˜å¾—å¥½ä¸€ç‚¹ï¼Œè¦ä¹ˆå˜å¾—åä¸€ç‚¹ã€‚ä½ å¦‚æœèµ°è¿›ç¤¾ä¼šä¸ºäº†ç”Ÿå­˜ä¸ºäº†ä»€ä¹ˆä¸è¦è„¸çš„ç†ç”±ï¼Œå˜æˆäº†ä¸€ä¸ªæ¶å¿ƒçš„æˆå¹´äººç¤¾ä¼šä¸­çš„ä¸€å‘˜ï¼Œé‚£ä½ å°±æŠŠè¿™ä¸ªä¸–ç•Œå˜å¾—æ¶å¿ƒäº†ä¸€ç‚¹ç‚¹ã€‚å¦‚æœä½ ä¸€ç”Ÿåˆšæ­£ä¸é˜¿ï¼Œå¦‚æœä½ ä¸€ç”Ÿè€¿ç›´ï¼Œæ²¡æœ‰åšä»»ä½•æ¶å¿ƒçš„äº‹æƒ…ï¼Œæ²¡åšå¯¹åˆ«äººæœ‰å®³çš„äº‹æƒ…ï¼Œä¸€è¾ˆå­æ‹¼äº†è€å‘½å‹‰å¼ºæŠŠè‡ªå·±èº«è¾¹çš„å‡ ä¸ªäººç…§é¡¾å¥½äº†ï¼Œæ²¡æœ‰æˆåæ²¡æœ‰å‘è´¢ï¼Œæ²¡æœ‰æˆå°±ä¼Ÿå¤§çš„äº‹ä¸šï¼Œç„¶åè€¿ç€è„–å­ä¸€ç”Ÿæ­£ç›´ï¼Œåˆ°äº†ä¸ƒå…«åå²è€¿ç€è„–å­å»ä¸–äº†ã€‚ä½ è¿™ä¸€ç”Ÿæ˜¯ä¸æ˜¯æ²¡æœ‰æ”¹å˜ä¸–ç•Œï¼Ÿä½ è¿˜æ˜¯æ”¹å˜ä¸–ç•Œäº†ï¼Œä½ æŠŠè¿™ä¸ªä¸–ç•Œå˜å¾—ç¾å¥½äº†ä¸€ç‚¹ç‚¹ã€‚å› ä¸ºä¸–ç•Œä¸Šåˆå¤šäº†ä¸€ä¸ªå¥½äººã€‚â€œ å–„æ¶ç»ˆæœ‰æŠ¥,å¤©é“å¥½è½®å›ã€‚ä¸ä¿¡æŠ¬å¤´çœ‹,è‹å¤©é¥¶è¿‡è°ã€‚æ— è®ºä½•æ—¶ä½•åœ°ï¼Œæˆ‘ä»¬éƒ½è¦ä¿æŒä¸€é¢—ç§¯æä¹è§‚ã€å–„è‰¯æ„Ÿæ©çš„å¿ƒã€‚ä½†è¡Œå¥½äº‹è«é—®å‰ç¨‹ï¼Œæ°¸è¿œå¹´è½»ï¼Œæ°¸è¿œçƒ­å†…ç›ˆçœ¶ï¼Œæ°¸è¿œä¿æŒæ­£èƒ½é‡ã€‚ğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ªå†²é¸­ï¼ï¼ï¼ï¼ -&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ä¸ªäººä¿¡æ¯ï¼šè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ä¸“ä¸šä»äº‹JAVAåç«¯å¼€å‘ç ç•œä¸€æšåšä¿¡ä»£ç æ”¹å˜ä¸–ç•Œ åšå®¢ä¿¡æ¯ ç½‘ç«™é‡‡ç”¨çš„Icarusä¸»é¢˜ è¿½æ±‚å°½å¯èƒ½çš„ç®€æ´ï¼Œæ¸…æ™°ï¼Œæ˜“ç”¨ã€‚ åœ¨Icarusä¸»é¢˜ä¹‹ä¸Šè¿›è¡Œäº†éƒ¨åˆ†ä¿®æ”¹ã€‚ æ›´æ–°æ—¥å¿—ï¼šâ€“2020.09.20ï¼šicarus4.0é€‚é…â€“2020.01.18ï¼šicarus3.0é€‚é…â€“2019.11.17ï¼šå¢åŠ æ·±è‰²ä¸»é¢˜å¼€å…³â€“2019.10.30ï¼šå»å›¾ï¼Œç²¾ç®€å¡ç‰‡â€“2019.10.22ï¼šæ”¹ç‰ˆéƒ¨åˆ†æ˜¾ç¤ºï¼Œä¼˜åŒ–é€Ÿåº¦â€“2019.10.16ï¼šæ–‡ç« åˆ—è¡¨åŠ ä¸Šè¯„è®ºæ•°æ˜¾ç¤ºâ€“2019.10.13ï¼šæ”¹ç‰ˆè¯„è®ºâ€“2019.09.25ï¼šå›¾ç‰‡ã€èµ„æºæ¥å…¥CDNå…è´¹jsDelivrã€æ–‡ç« åŠ å…¥ç½®é¡¶â€“2019.09.19ï¼šå¼€æºåšå®¢ä»£ç â€“2019.09.19ï¼šä¿®æ”¹å¸ƒå±€ï¼Œæ‹‰ä¼¸å¸ƒå±€ï¼Œæ›´å®½çš„å±•ç¤ºâ€“2019.09.18ï¼šä¿®æ”¹å‹é“¾uiä¸ºä¸€è¡Œä¸‰ä¸ªï¼Œå¹¶é€‚é…ç§»åŠ¨ç«¯ï¼Œæš—é»‘æ¨¡å¼æ–‡ç« å¢åŠ è¯„è®ºé“¾æ¥ï¼Œå¢åŠ ç•™è¨€é“¾æ¥â€“2019.09.14ï¼šå¢åŠ ç²¾ç®€nextä¸»é¢˜â€“2019.09.14ï¼šåˆ©ç”¨ä¸­ç§‹èŠ‚æ”¾å‡ï¼Œé‡åšäº†é¦–é¡µçš„çƒ­é—¨æ¨èã€åŠ ä¸ªwidgetæœ€æ–°è¯„è®ºæ¡†ã€å½’æ¡£é¡µåŠ å…¥æ–‡ç« è´¡çŒ®æ¦‚è§ˆé¢æ¿ æœ¬ç«™æ¨èç´¢å¼• åšå®¢ä¸»é¢˜ç›¸å…³ github Issue ä½œä¸ºåšå®¢å¾®å‹æ•°æ®åº“çš„åº”ç”¨ github pageç½‘ç«™cdnä¼˜åŒ–åŠ é€Ÿ åšå®¢æºç åˆ†äº« åšå®¢æ¢è‚¤çš„ä¸€ç§å®ç°æ–¹å¼æ€è·¯ åšå®¢ä¸­gitalkæœ€æ–°è¯„è®ºçš„è·å– åšå®¢å›¾ç‰‡ä¸Šä¼ picgoå·¥å…·githubå›¾ä¼ ä½¿ç”¨ å®‰è£…ã€éƒ¨åˆ†é…ç½®icarusä¸»é¢˜ä¸­æ–‡ç‰ˆ æŠ€æœ¯çŸ¥è¯†ç‚¹ Javaå¹¶å‘çŸ¥è¯†ç‚¹ æ³•å¾‹æ³•è§„ æ³•å¾‹æ³•è§„æ•°æ®åº“ ä¸­åäººæ°‘å…±å’Œå›½å›½æ——æ³• ä¸­åäººæ°‘å…±å’Œå›½å®ªæ³• ä¸­åäººæ°‘å…±å’Œå›½æ¶ˆè´¹è€…æƒç›Šä¿æŠ¤æ³• ä¸­åäººæ°‘å…±å’Œå›½åˆ‘äº‹è¯‰è®¼æ³• ä¸­åäººæ°‘å…±å’Œå›½å©šå§»æ³• ä¸­åäººåå…±å’Œå›½ç½‘ç»œå®‰å…¨æ³• ä¸­åäººæ°‘å…±å’Œå›½åŠ³åŠ¨æ³• å…¶ä»– ç½‘æ˜“äº‘éŸ³ä¹æ­Œå•åˆ†äº« è®¡åˆ’2020è®¡åˆ’ 2019.12.31 2020-GOALS è·‘ä¸¤ä¸‰åœºé©¬æ‹‰æ¾ 2019è®¡åˆ’ 2018.12.31/21:59:00-&gt;æ›´æ–°äº2019.12.31 2019-GOALS è´­ä¹°çš„ä¸“ä¸šä¹¦ç±è‡³å°‘çœ‹å®Œä¸€éï¼ˆå¹¶å‘ã€é‡æ„ã€è®¾è®¡æ¨¡å¼â€¦ï¼‰-&gt; 95% é¢å¤–ï¼š è¿½äº†å¾ˆå¤šå‰§ æ€»ç»“ï¼š æœ‰ä¼˜ç‚¹æœ‰ç¼ºç‚¹ï¼Œæ²¡åšæŒä¸‹æ¥çš„è¿˜æ˜¯å¤ªå¤šï¼Œè¿½äº†å¤ªå¤šå‰§ã€‚ä»¥åå¤šå­¦ä¹ ï¼Œå¤šæ€è€ƒï¼ æ—¶é—´è½´è®°å½•","link":"/about/index.html"},{"title":"","text":"ğŸˆğŸˆå¾®ç¬‘å¢™ğŸˆğŸˆ å½­å°è‹’ å”è‰ºæ˜• æä¸€æ¡ gakki å›¾ç‰‡æœé›†äºäº’è”ç½‘ï¼Œä¾µæƒè¯·ç•™è¨€ï¼Œé©¬ä¸Šå¤„ç†ğŸ˜Šã€‚","link":"/album/index.html"},{"title":"","text":"ç”³è¯·å‹é“¾é¡»çŸ¥ åŸåˆ™ä¸Šåªå’ŒæŠ€æœ¯ç±»åšå®¢äº¤æ¢ï¼Œä½†ä¸åŒ…æ‹¬å«æœ‰å’Œè‰²æƒ…ã€æš´åŠ›ã€æ”¿æ²»æ•æ„Ÿçš„ç½‘ç«™ã€‚ ä¸å’Œå‰½çªƒã€ä¾µæƒã€æ— è¯šä¿¡çš„ç½‘ç«™äº¤æ¢ï¼Œä¼˜å…ˆå’Œå…·æœ‰åŸåˆ›ä½œå“çš„ç½‘ç«™äº¤æ¢ã€‚ ç”³è¯·è¯·æä¾›ï¼šç«™ç‚¹åç§°ã€ç«™ç‚¹é“¾æ¥ã€ç«™ç‚¹æè¿°ã€logoæˆ–å¤´åƒï¼ˆä¸è¦è®¾ç½®é˜²ç›—é“¾ï¼‰ã€‚ æ’åä¸åˆ†å…ˆåï¼Œåˆ·æ–°åé‡æ’ï¼Œæ›´æ–°ä¿¡æ¯åè¯·ç•™è¨€å‘ŠçŸ¥ã€‚ ä¼šå®šæœŸæ¸…ç†å¾ˆä¹…å¾ˆä¹…ä¸æ›´æ–°çš„ã€ä¸ç¬¦åˆè¦æ±‚çš„å‹é“¾ï¼Œä¸å†å¦è¡Œé€šçŸ¥ã€‚ æœ¬ç«™ä¸å­˜å‚¨å‹é“¾å›¾ç‰‡ï¼Œå¦‚æœå‹é“¾å›¾ç‰‡æ¢äº†æ— æ³•æ›´æ–°ã€‚å›¾ç‰‡è£‚äº†çš„ä¼šæ›¿æ¢æˆé»˜è®¤å›¾ï¼Œéœ€è¦æ›´æ¢çš„è¯·ç•™è¨€å‘ŠçŸ¥ã€‚ æœ¬ç«™å‹é“¾ä¿¡æ¯å¦‚ä¸‹ï¼Œç”³è¯·å‹é“¾å‰è¯·å…ˆæ·»åŠ æœ¬ç«™ä¿¡æ¯ï¼š ç½‘ç«™å›¾æ ‡ï¼šhttps://removeif.github.io/images/avatar.jpg ç½‘ç«™åç§°ï¼šè¾£æ¤’ã®é…± ç½‘ç«™åœ°å€ï¼šhttps://removeif.github.io ç½‘ç«™ç®€ä»‹ï¼šåç«¯å¼€å‘ï¼ŒæŠ€æœ¯åˆ†äº« åŠ è½½ä¸­ï¼Œç¨ç­‰å‡ ç§’...","link":"/friend/index.html"},{"title":"","text":"&nbsp;&nbsp;å¬å¬éŸ³ä¹ éŸ³ä¹æ’­æ”¾å™¨ç”±mePlayeræä¾›ï¼Œå¸ƒå±€å‚ç…§ç½‘å‹åšå®¢æ‰€ä½œï¼Œæ„Ÿè°¢ä½œè€…çš„è¾›å‹¤ä»˜å‡ºã€‚æ›´å¤šéŸ³ä¹åˆ†äº«è¯·æŸ¥çœ‹æ­Œå•ã€‚ &nbsp;&nbsp;çœ‹çœ‹è§†é¢‘ ->ç‚¹å‡»ä»¥ä¸‹æ¡ç›®å¼€å§‹æ’­æ”¾è§†é¢‘,å‘ä¸‹æ»‘åŠ¨æŸ¥çœ‹æ›´å¤š","link":"/media/index.html"},{"title":"","text":"æ¥è€Œä¸å¾€éç¤¼ä¹Ÿç•…æ‰€æ¬²è¨€ï¼Œæœ‰ç•™å¿…åº”","link":"/message/index.html"},{"title":"","text":"ç¢ç¢å¿µ tipsï¼šgithubç™»å½•åæŒ‰æ—¶é—´æ­£åºæŸ¥çœ‹ã€å¯ç‚¹èµåŠ â¤ï¸ã€æœ¬æ’ä»¶åœ°å€..ã€Œ+99æ¬¡æŸ¥çœ‹ã€ ç¢ç¢å¿µåŠ è½½ä¸­ï¼Œè¯·ç¨ç­‰... $.getScript(\"/js/gitalk_self.min.js\", function () { var gitalk = new Gitalk({ clientID: '46a9f3481b46ea0129d8', clientSecret: '79c7c9cb847e141757d7864453bcbf89f0655b24', id: '666666', repo: 'issue_database', owner: 'removeif', admin: \"removeif\", createIssueManually: true, distractionFreeMode: false }); gitalk.render('comment-container1'); });","link":"/self-talking/index.html"},{"title":"éŸ³ä¹æ­Œå•æ”¶è—","text":"æ¸©é¦¨æç¤ºï¼šé€‰æ‹©å–œæ¬¢çš„éŸ³ä¹åŒå‡»æ’­æ”¾ï¼Œç”±äºç‰ˆæƒåŸå› éƒ¨åˆ†ä¸èƒ½æ’­æ”¾ã€‚å¦‚æœå–œæ¬¢æ­Œå•æ”¶è—ä¸€ä¸‹ï¼Œå»ç½‘æ˜“äº‘éƒ½èƒ½æ’­æ”¾å“Ÿï¼","link":"/music/index.html"}],"posts":[{"title":"Activityå¯åŠ¨æ¨¡å¼","text":"ä»å››ä¸ªè§†è§’ç†è§£Android Activityå¯åŠ¨æ¨¡å¼ç³»ç»Ÿè§†è§’ï¼š 1. Androidçš„è½¯ä»¶ä½“ç³»ç»“æ„ 1.2 Task Activityä»£ç å±äºApplicationï¼Œä½†æ˜¯Taskå±äºAndroidæ“ä½œç³»ç»Ÿ Taskæ˜¯å¯ä»¥è·¨åº”ç”¨çš„ æ‰‹æœºæŸ¥çœ‹Taskï¼šï¼ˆç”¨æˆ·è§’åº¦ï¼‰æ‰‹æœºä¸­æŒ‰homeé”®æ—è¾¹é‚£ä¸ªæ–¹å½¢é”®ï¼ˆrecent-appsï¼‰æ—¶ï¼Œå±å¹•ä¸Šå±•ç¤ºçš„å°±æ˜¯ä¸€ä¸ªä¸ªtaskã€‚ ä»£ç ä¸­æŸ¥çœ‹Taskï¼šï¼ˆç¨‹åºè§’åº¦ï¼‰adb shell dumpsys activity activities | sed -En -e â€˜/Stack #/pâ€™ -e â€˜/Running activities/,/Run #0/pâ€™ sedå·¥å…·ä¸ç”¨å•ç‹¬ä¸‹è½½ï¼ŒD:\\soft\\Git\\usr\\bin\\sed.exe Gitå®‰è£…ç›®å½•ä¸‹åŒ…å«ï¼Œé…ç½®ä¸‹ç¯å¢ƒå˜é‡å°±å¯ä»¥ã€‚ ç”¨æˆ·è§†è§’ï¼š 2.1 Taskå¯åŠ¨æ–¹å¼(launcherå¯åŠ¨)Launcherå¯åŠ¨ 1ã€Taskä¸å­˜åœ¨ 2ã€Taskå­˜åœ¨ 2.2 Taskå¯åŠ¨æ–¹å¼ï¼ˆæ–°å»ºï¼‰1234Intent intent = new Intent(this, SecondActivity.class);intent.putExtra(&quot;message&quot;, &quot;message&quot;);intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);startActivity(intent); é€šçŸ¥ï¼š 1.ç³»ç»Ÿé€šçŸ¥2.è‡ªå·± å…¶ä»–ç¬¬ä¸‰æ–¹åº”ç”¨ï¼š 1ã€Schemeåè®®2ã€ç¬¬ä¸‰æ–¹åº”ç”¨start launcher,æ–°å»º éƒ½æ˜¯é€šè¿‡startActivityæ¥åˆ›å»ºçš„ã€‚ 2.3 Taskå¯åŠ¨æ–¹å¼ï¼ˆæ¢å¤ï¼‰æ¢å¤ è¿™å±äºActivityç”Ÿå‘½å‘¨æœŸç”±ä¸å¯è§åˆ°è·å¾—ç„¦ç‚¹çš„èŒƒç•´ ç¨‹åºè§†è§’ï¼š 3.1 Activityå’ŒFragmentFragmentæ˜¯Android3.0åå¼•å…¥çš„ä¸€ä¸ªæ–°çš„APIï¼Œä»–å‡ºç°çš„åˆè¡·æ˜¯ä¸ºäº†é€‚åº”å¤§å±å¹•çš„å¹³æ¿ç”µè„‘ï¼Œ å½“ç„¶ç°åœ¨ä»–ä»ç„¶æ˜¯å¹³æ¿APP UIè®¾è®¡çš„å® å„¿ï¼Œè€Œä¸”æˆ‘ä»¬æ™®é€šæ‰‹æœºå¼€å‘ä¹Ÿä¼šåŠ å…¥è¿™ä¸ªFragmentï¼Œ æˆ‘ä»¬å¯ä»¥æŠŠä»–çœ‹æˆä¸€ä¸ªå°å‹çš„Activityï¼Œåˆç§°Activityç‰‡æ®µï¼ 3.2 Activityçš„ç”Ÿå‘½å‘¨æœŸ Activityæ˜¯å¦å¯è§ï¼š PS:Fragmentç”Ÿå‘½å‘¨æœŸ Activityä¸Fragmentç”Ÿå‘½å‘¨æœŸ 3.3 ç›¸é‚»çŠ¶æ€ä¹‹é—´çš„åŒºåˆ« Aå¯åŠ¨B å’Œ Bè¿”å›A 1.onCreateå’ŒonStartä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ï¼ˆ1ï¼‰å¯è§ä¸ä¸å¯è§çš„åŒºåˆ«ã€‚å‰è€…ä¸å¯è§ï¼Œåè€…å¯è§ã€‚ï¼ˆ2ï¼‰æ‰§è¡Œæ¬¡æ•°çš„åŒºåˆ«ã€‚onCreateæ–¹æ³•åªåœ¨Activityåˆ›å»ºæ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œè€ŒonStartæ–¹æ³•åœ¨Activityçš„åˆ‡æ¢ä»¥åŠæŒ‰Homeé”®è¿”å›æ¡Œé¢å†åˆ‡å›åº”ç”¨çš„è¿‡ç¨‹ä¸­è¢«å¤šæ¬¡è°ƒç”¨ã€‚å› æ­¤Bundleæ•°æ®çš„æ¢å¤åœ¨onStartä¸­è¿›è¡Œæ¯”onCreateä¸­æ‰§è¡Œæ›´åˆé€‚ã€‚ ï¼ˆ3ï¼‰onCreateèƒ½åšçš„äº‹onStartå…¶å®éƒ½èƒ½åšï¼Œä½†æ˜¯onstartèƒ½åšçš„äº‹onCreateå´æœªå¿…é€‚åˆåšã€‚å¦‚å‰æ–‡æ‰€è¯´çš„ï¼ŒsetContentViewå’Œèµ„æºåˆå§‹åŒ–åœ¨ä¸¤è€…éƒ½èƒ½åšï¼Œç„¶è€Œæƒ³åŠ¨ç”»çš„åˆå§‹åŒ–åœ¨onStartä¸­åšæ¯”è¾ƒå¥½ã€‚ 2.onStartæ–¹æ³•å’ŒonResumeæ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ï¼ˆ1ï¼‰æ˜¯å¦åœ¨å‰å°ã€‚onStartæ–¹æ³•ä¸­Activityå¯è§ä½†ä¸åœ¨å‰å°ï¼Œä¸å¯äº¤äº’ï¼Œè€Œåœ¨onResumeä¸­åœ¨å‰å°ã€‚ï¼ˆ2ï¼‰èŒè´£ä¸åŒï¼ŒonStartæ–¹æ³•ä¸­ä¸»è¦è¿˜æ˜¯è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œè€ŒonResumeæ–¹æ³•ï¼Œæ ¹æ®å®˜æ–¹çš„å»ºè®®ï¼Œå¯ä»¥åšå¼€å¯åŠ¨ç”»å’Œç‹¬å è®¾å¤‡çš„æ“ä½œã€‚ 3.onPauseæ–¹æ³•å’ŒonStopæ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ï¼ˆ1ï¼‰æ˜¯å¦å¯è§ã€‚onPauseæ—¶Activityå¯è§ï¼ŒonStopæ—¶Activityä¸å¯è§ï¼Œä½†Activityå¯¹è±¡è¿˜åœ¨å†…å­˜ä¸­ã€‚ï¼ˆ2ï¼‰åœ¨ç³»ç»Ÿå†…å­˜ä¸è¶³çš„æ—¶å€™å¯èƒ½ä¸ä¼šæ‰§è¡ŒonStopæ–¹æ³•ï¼Œå› æ­¤ç¨‹åºçŠ¶æ€çš„ä¿å­˜ã€ç‹¬å è®¾å¤‡å’ŒåŠ¨ç”»çš„å…³é—­ã€ä»¥åŠä¸€äº›æ•°æ®çš„ä¿å­˜æœ€å¥½åœ¨onPauseä¸­è¿›è¡Œï¼Œä½†è¦æ³¨æ„ä¸èƒ½å¤ªè€—æ—¶ã€‚ 4.onStopæ–¹æ³•å’ŒonDestroyæ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ onStopé˜¶æ®µActivityè¿˜æ²¡æœ‰è¢«é”€æ¯ï¼Œå¯¹è±¡è¿˜åœ¨å†…å­˜ä¸­ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡åˆ‡æ¢Activityå†æ¬¡å›åˆ°è¯¥Activityï¼Œè€ŒonDestroyé˜¶æ®µAcivityè¢«é”€æ¯ **PS:**é—ªå±é¡µï¼šåœ¨onStop()æ–¹æ³•ä¸­è¿›è¡Œfinish(); 3.4 onNewIntentçš„ç”Ÿå‘½å‘¨æœŸ 1ã€åªå¯¹singleTopï¼ŒsingleTaskï¼ŒsingleInstanceæœ‰æ•ˆï¼Œå› ä¸ºstandardæ¯æ¬¡éƒ½æ˜¯æ–°å»º(ä¸æ˜¯ç»å¯¹ï¼Œä½¿ç”¨äº†Intent.FLAG_ACTIVITY_NEW_TASK,è¦å¯åŠ¨çš„Activityå·²ç»æœ‰Taskåœ¨è¿è¡Œäº†ï¼Œæ–°çš„activityä¸ä¼šå†åˆ›å»ºï¼Œè€Œæ˜¯æŠŠå½“å‰å †æ ˆçš„activityå¸¦åˆ°å‰å°)ï¼Œæ‰€ä»¥ä¸å­˜åœ¨onNewIntentï¼› 2ã€åªå¯¹startActivityæœ‰æ•ˆï¼Œå¯¹äºä»Navigationåˆ‡æ¢å›æ¥çš„æ¢å¤æ— æ•ˆï¼› 4.1 Activityå¯åŠ¨æ¨¡å¼ 4.2 standardå¯åŠ¨æ¨¡å¼1ã€standard é»˜è®¤æ¨¡å¼ ç³»ç»Ÿåœ¨å¯åŠ¨ Activity çš„ä»»åŠ¡ä¸­åˆ›å»º Activity çš„æ–°å®ä¾‹å¹¶å‘å…¶ä¼ é€ Intentã€‚Activity å¯ä»¥å¤šæ¬¡å®ä¾‹åŒ–ï¼Œä¸ç®¡è¿™ä¸ªå®ä¾‹æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œè€Œæ¯ä¸ªå®ä¾‹å‡å¯å±äºä¸åŒçš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¸€ä¸ªä»»åŠ¡å¯ä»¥æ‹¥æœ‰å¤šä¸ªå®ä¾‹ã€‚è¿™ç§æ¨¡å¼çš„ Activity è¢«åˆ›å»ºæ—¶å®ƒçš„ onCreateã€onStart éƒ½ä¼šè¢«è°ƒç”¨ã€‚è¿™æ˜¯ä¸€ç§å…¸å‹çš„å¤šå®ä¾‹å®ç°ï¼Œä¸€ä¸ªä»»åŠ¡æ ˆä¸­å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹ä¹Ÿå¯ä»¥å±äºä¸åŒçš„ä»»åŠ¡æ ˆã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œè°å¯åŠ¨äº†è¿™ä¸ª Activityï¼Œé‚£ä¹ˆè¿™ä¸ª Activity å°±è¿è¡Œåœ¨å¯åŠ¨å®ƒçš„é‚£ä¸ª Activity æ‰€åœ¨çš„æ ˆä¸­ã€‚ aã€å½“ä»éActivityçš„contextå¯åŠ¨activityæ—¶ï¼Œéœ€è¦å¸¦new_taskçš„flagï¼› bã€å½“å¯åŠ¨ä¸€ä¸ªå¸¦æœ‰affinityçš„activityï¼Œå¦‚æœè¿™ä¸ªactivityå·²ç»æœ‰å®ä¾‹å­˜åœ¨è¯¥taskï¼Œåˆ™ä¸ä¼šé‡æ–°åˆ›å»ºï¼› cã€å¦‚æœä»åº”ç”¨å†…å¯åŠ¨çš„standard activityçš„Affinityå°±æ˜¯Appé»˜è®¤çš„Affinityï¼Œåˆ™ä¼šæ¯æ¬¡æ–°å»ºä¸€ä¸ªå®ä¾‹ï¼› 4.3 singleTopå¯åŠ¨æ¨¡å¼ä¸€ä¸ªsingleTop Activity çš„å®ä¾‹å¯ä»¥æ— é™å¤šï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯å¦‚æœåœ¨æ ˆé¡¶å·²ç»æœ‰ä¸€ä¸ªç›¸åŒç±»å‹çš„Activityå®ä¾‹ï¼ŒIntentä¸ä¼šå†åˆ›å»ºä¸€ä¸ªActivityï¼Œè€Œæ˜¯é€šè¿‡onNewIntent()è¢«å‘é€åˆ°ç°æœ‰çš„Activityã€‚ 4.4 singleTaskæ¨¡å¼è¿™æ˜¯ä¸€ç§å•å®ä¾‹æ¨¡å¼ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œåªè¦ Activity åœ¨ä¸€ä¸ªæ ˆä¸­å­˜åœ¨ï¼Œé‚£ä¹ˆå¤šæ¬¡å¯åŠ¨æ­¤ Activity éƒ½ä¸ä¼šé‡æ–°åˆ›å»ºå®ä¾‹ï¼Œå’Œ singleTopä¸€æ ·ï¼Œç³»ç»Ÿä¹Ÿä¼šå›è°ƒå…¶ onNewIntentã€‚å½“ä¸€ä¸ªå…·æœ‰ singleTask æ¨¡å¼çš„Activityè¯·æ±‚å¯åŠ¨åï¼Œæ¯”å¦‚ Activity Aï¼Œç³»ç»Ÿé¦–å…ˆä¼šå¯»æ‰¾æ˜¯å¦å­˜åœ¨ A æƒ³è¦çš„ä»»åŠ¡æ ˆï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±é‡æ–°åˆ›å»ºä¸€ä¸ªä»»åŠ¡æ ˆï¼Œç„¶ååˆ›å»º A çš„å®ä¾‹åæŠŠ A æ”¾åˆ°æ ˆä¸­ã€‚å¦‚æœå­˜åœ¨ A æ‰€éœ€çš„ä»»åŠ¡æ ˆï¼Œè¿™æ—¶è¦çœ‹ A æ˜¯å¦åœ¨æ ˆä¸­æœ‰å®ä¾‹å­˜åœ¨ï¼Œå¦‚æœæœ‰å®ä¾‹å­˜åœ¨ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¼šæŠŠ A è°ƒåˆ°æ ˆé¡¶å¹¶è°ƒç”¨å®ƒçš„ onNewIntent æ–¹æ³•ï¼Œå¦‚æœå®ä¾‹ä¸å­˜åœ¨ï¼Œå°±åˆ›å»º A çš„å®ä¾‹å¹¶æŠŠ A å‹å…¥æ ˆä¸­ ã€‚ ä¸éœ€è¦å…³æ³¨NEW_TASK 4.5 singleInstanceæ¨¡å¼ä¸ singleTask ç›¸åŒï¼Œåªæ˜¯ç³»ç»Ÿä¸ä¼šå°†ä»»ä½•å…¶ä»– Activity å¯åŠ¨åˆ°åŒ…å«å®ä¾‹çš„ä»»åŠ¡ä¸­ã€‚è¯¥ Activity å§‹ç»ˆæ˜¯å…¶ä»»åŠ¡å”¯ä¸€ä»…æœ‰çš„æˆå‘˜ï¼›ç”±æ­¤ Activity å¯åŠ¨çš„ä»»ä½• Activity å‡åœ¨å•ç‹¬çš„ä»»åŠ¡ä¸­æ‰“å¼€ã€‚ä¹Ÿå°±æ˜¯æœ‰æ­¤ç§æ¨¡å¼çš„ Activity åªèƒ½å•ç‹¬åœ°ä½äºä¸€ä¸ªä»»åŠ¡æ ˆä¸­ PSï¼š4ç§æ¨¡å¼åªèƒ½åœ¨AndroidManifest.xmlä¸­å®šä¹‰ï¼ˆå®šä¹‰å±‚å®šä¹‰çš„ï¼‰ 4.6 Intent Activity Flagå¯åŠ¨å±‚å®šä¹‰ 5.1 å¯åŠ¨æ¨¡å¼çš„åº”ç”¨åœºæ™¯ launchMode ä½¿ç”¨åœºæ™¯ singleTop é€‚åˆå¯åŠ¨åŒç±»å‹çš„ Activityï¼Œä¾‹å¦‚ï¼š â€¢æ¥æ”¶é€šçŸ¥å¯åŠ¨çš„å†…å®¹æ˜¾ç¤ºé¡µé¢ â€¢è€—æ—¶æ“ä½œè¿”å›é¡µé¢ â€¢ç™»å½•é¡µé¢ singleTask é€‚åˆä½œä¸ºç¨‹åºå…¥å£ï¼Œä¾‹å¦‚ï¼š â€¢WebViewé¡µé¢ â€¢æ‰«ä¸€æ‰«é¡µé¢ â€¢ç¡®è®¤è®¢å•ç•Œé¢ â€¢ä»˜æ¬¾ç•Œé¢ singleInstance é€‚åˆéœ€è¦ä¸ç¨‹åºåˆ†ç¦»å¼€çš„é¡µé¢ï¼Œä¾‹å¦‚ï¼š â€¢é—¹é“ƒçš„å“é“ƒç•Œé¢ â€¢æ¥ç”µé¡µé¢ â€¢é”å±é¡µ","link":"/2020/12/11/activity/"},{"title":"AndroidStudioå¼€å‘Gradleæ’ä»¶","text":"é¡¹ç›®ç»“æ„ï¼šgradlePlugin app src build.gradle buildSrc src main java com.lis.buildsrc MyPlugin.java build.gradle build.gradle ç®€å•çš„Gradleæ’ä»¶BuildSrcå¦‚æœå¼€å‘çš„æ’ä»¶ä»…ç”¨äºå½“å‰é¡¹ç›®ï¼Œä¸éœ€è¦å‘å¸ƒçš„è¯ï¼Œåªéœ€è¦æ³¨æ„ä¸¤ç‚¹: æ’ä»¶çš„Moduleåç§°å¿…é¡»æ˜¯buildSrc(å¼€å¤´ä¸€å®šè¦å°å†™) æ— é¡»resourcesç›®å½• build.gradleçš„é…ç½®ï¼š 123456789101112131415apply plugin:'java' apply plugin:'groovy' repositories { google() jcenter() } dependencies { implementation gradleApi() //gradle sdk implementation localGroovy() //groovy sdk implementation 'com.android.tools.build:gradle:3.6.3' } sourceCompatibility = &quot;1.7&quot; targetCompatibility = &quot;1.7&quot; è¿™é‡Œå¼•å…¥groovy sdkå’Œgradle sdk,å› ä¸ºå¼€å‘Androidæ’ä»¶ï¼Œè¿˜éœ€è¦Androidä¸“ç”¨çš„gradleï¼ˆè¿™é‡Œéœ€è¦ä½¿ç”¨åˆ°googleä»“åº“ï¼‰ ç„¶åæˆ‘ä»¬ç¼–å†™æ’ä»¶ï¼ŒMyPlugin: 12345678910111213import org.gradle.api.Plugin;import org.gradle.api.Project;import org.gradle.api.logging.Logger;public class MyPlugin implements Plugin&lt;Project&gt; { @Override public void apply(Project project) { Logger logger = project.getLogger(); logger.error(&quot;=====================&quot;); logger.error(&quot;æœ€ç®€å•çš„Gradleæ’ä»¶&quot;); logger.error(&quot;=====================&quot;); }} åœ¨appçš„build.gradleä¸­æ·»åŠ ä½ çš„æ’ä»¶ æ³¨æ„ï¼šè¿™é‡Œä¸åŠ â€™ â€˜å•å¼•å· 1apply plugin: com.lis.buildsrc.MyPlugin æ‰§è¡Œï¼š**Build-make Module â€˜appâ€™**ç”Ÿæˆè¡¥ä¸ã€‚ åœ¨åº•éƒ¨çš„ Buid-Build Outputä¸­ä¾¿å¯ä»¥çœ‹åˆ°æ‰“å°æ—¥å¿—ï¼š =====================ç®€å•çš„Gradleæ’ä»¶ ===================== æ’ä»¶çš„å‘å¸ƒå¦‚æœæƒ³å¤ç”¨ä½ çš„gradleæ’ä»¶ï¼Œå°±éœ€è¦æŠŠå®ƒå‘å¸ƒå‡ºå»ã€‚ å‘å¸ƒåˆ°æœ¬åœ°ä»“åº“ å‘å¸ƒåˆ°è¿œç¨‹ä»“åº“ æœ¬åœ°ä»“åº“é¡¹ç›®ç»“æ„ï¼š gradlePlugin app src build.gradle buildSrc src main java com.lis.buildsrc MyPlugin.java resources META-INF.gradle-plugins com.lis.myplugin.properties build.gradle build.gradle åœ¨buildSrcçš„mainæ–‡ä»¶å¤¹ä¸‹æ·»åŠ resourcesæ–‡ä»¶å¤¹ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ·»åŠ *META-INF**ï¼ŒMETA-INF*æ–‡ä»¶å¤¹ä¸‹æ·»åŠ **gradle-plugins åœ¨**gradle-plugins**ä¸­æ·»åŠ com.lis.myplugin.properties è¿™é‡Œå‘½åä¸º com.lis.myplugin.properties ï¼Œä¸€å®šè¦æ³¨æ„åç¼€åç§°ï¼Œé‚£ä¹ˆä½¿ç”¨æ’ä»¶æ—¶çš„åç§°å°±æ˜¯com.lis.mypluginï¼Œæ–‡ä»¶é‡Œé¢çš„å†…å®¹å¡«å†™å¦‚ä¸‹ï¼š 1implementation-class=com.lis.buildsrc.MyPlugin è¿™é‡ŒæŒ‡å®šçš„è·¯å¾„ä¸ºMyPluginçš„ç±»åï¼Œå³æ’ä»¶çš„å…¥å£ç±» buidSrcä¸­çš„build.gradleï¼Œæ·»åŠ mavenæ’ä»¶åŠå‘å¸ƒç”¨åˆ°çš„é…ç½® 123456789101112131415161718192021222324apply plugin:'java'apply plugin:'groovy'apply plugin: 'maven'repositories { google() jcenter()}tasks.withType(JavaCompile) { options.encoding = &quot;UTF-8&quot; } //ç¼–ç æ ¼å¼dependencies { implementation gradleApi() //gradle sdk implementation localGroovy() //groovy sdk implementation 'com.android.tools.build:gradle:3.6.3'}uploadArchives { repositories.mavenDeployer { repository(url: uri('../repo')) //ä»“åº“çš„è·¯å¾„ï¼Œæ­¤å¤„æ˜¯é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ repo çš„æ–‡ä»¶å¤¹ pom.groupId = 'com.lis.gradleplugin' //groupId ï¼Œè‡ªè¡Œå®šä¹‰ï¼Œä¸€èˆ¬æ˜¯åŒ…å pom.artifactId = 'myplugin' //artifactId ï¼Œè‡ªè¡Œå®šä¹‰ pom.version = '1.0.0' //version ç‰ˆæœ¬å· }}sourceCompatibility = &quot;1.7&quot;targetCompatibility = &quot;1.7&quot; åŒæ­¥ååœ¨gradleæ¨¡å—å†…ï¼Œä¼šå‡ºç°å‘å¸ƒæŒ‰é’® åŒå‡»uploadArchives ,æ’ä»¶å°±å‘å¸ƒåˆ°äº†æœ¬åœ°çš„mavenä»“åº“ï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¯åœ¨é¡¹ç›®çš„æ ¹ç›®å½•é‡Œï¼Œæ‰€ä»¥ä¼šåœ¨GradlePluginä¸‹ç”Ÿæˆrepoæ–‡ä»¶å¤¹åŠæ–‡ä»¶ ä½¿ç”¨æ’ä»¶: åœ¨GradlePluginæ ¹ç›®å½•çš„build.gradleä¸­æ·»åŠ æœ¬åœ°ä»“åº“åŠæ’ä»¶å¼•ç”¨ 123456789101112131415161718192021222324252627282930313233buildscript { repositories { google() jcenter() //é¦–å…ˆéœ€è¦é…ç½®æœ¬åœ°çš„ maven ä»“åº“åœ°å€ï¼Œè¿™é‡Œå¡«å†™çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¨è·¯å¾„ maven { url uri('./repo') } } dependencies { classpath 'com.android.tools.build:gradle:3.6.3' //ç„¶åï¼Œæ·»åŠ ä¾èµ–çš„æ’ä»¶ï¼Œå½¢å¼æ˜¯ groupIdï¼šartifactIdï¼šversion //è¿™äº›éƒ½æ˜¯æ’ä»¶å‘å¸ƒæ—¶ï¼Œå®šä¹‰çš„åç§° classpath 'com.lis.gradleplugin:myplugin:1.0.0' }}allprojects { repositories { google() jcenter() maven { url uri('./repo') } }}task clean(type: Delete) { delete rootProject.buildDir} æœ€åï¼Œåœ¨appçš„build.gradleé‡Œï¼Œæ·»åŠ æ’ä»¶ 123456789101112131415161718192021222324252627282930313233apply plugin: 'com.android.application'apply plugin: 'com.lis.myplugin'//è¿™é‡Œå°±å¡«å†™ .properties æ–‡ä»¶çš„åç§°android { compileSdkVersion 29 buildToolsVersion &quot;29.0.3&quot; defaultConfig { applicationId &quot;com.lis.gradleplugin&quot; minSdkVersion 21 targetSdkVersion 29 versionCode 1 versionName &quot;1.0&quot; testInstrumentationRunner &quot;androidx.test.runner.AndroidJUnitRunner&quot; } buildTypes { release { minifyEnabled false proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro' } }}dependencies { implementation fileTree(dir: 'libs', include: ['*.jar']) implementation 'androidx.appcompat:appcompat:1.1.0' implementation 'androidx.constraintlayout:constraintlayout:1.1.3' testImplementation 'junit:junit:4.12' androidTestImplementation 'androidx.test.ext:junit:1.1.1' androidTestImplementation 'androidx.test.espresso:espresso-core:3.2.0'} apply plugin: 'com.lis.myplugin'è¿™é‡Œçš„com.lis.mypluginå³æˆ‘ä»¬ä¸Šé¢com.lis.myplugin.propertiesæ–‡ä»¶çš„åç§° è¿™å°±å®Œæˆäº†æœ¬åœ°ä»“åº“çš„æ’ä»¶ä½¿ç”¨ï¼","link":"/2020/12/08/gradle/"},{"title":"ç¬¬ä¸ƒç«  ç±»åŠ è½½å’Œå‡½æ•°è°ƒç”¨","text":"[è½¬]å®‰å“ç³»ç»Ÿå®šåˆ¶ï¼šä»å…¥é—¨åˆ°å®è·µ 7.1 åŒäº²å§”æ´¾æœºåˆ¶ 7.2 ç±»çš„åŠ è½½æµç¨‹ 7.3 å‡½æ•°è°ƒç”¨æµç¨‹ 7.4 ExecuteMterpImpl 7.5 ExecuteSwitch 7.6 æœ¬ç« å°ç»“ åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†åˆ†æAndroidè¿è¡Œçš„æ‰§è¡Œæµç¨‹ï¼Œå¹¶æ‰¾åˆ°åˆé€‚çš„æ—¶æœºæ¥æ’å…¥ä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œä»¥å®ç°ç‰¹å®šåŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œåœ¨åº”ç”¨å¯åŠ¨æµç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨å…¥DEXæ–‡ä»¶æˆ–åŠ¨æ€åº“æ–‡ä»¶æ¥å®ç°æŸäº›åŠŸèƒ½ã€‚é€šè¿‡nativeå‡½æ•°çš„æ³¨å†Œæµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹é™æ€æ³¨å†Œå’ŒåŠ¨æ€æ³¨å†Œä¿¡æ¯è¿›è¡Œæ‰“æ¡©è¾“å‡ºã€‚è€Œé€šè¿‡è§£æAndroidManifest.xmlæ–‡ä»¶çš„è¿‡ç¨‹ï¼Œåˆ™å¯ä»¥é¢å¤–æ·»åŠ é»˜è®¤æƒé™ã€‚ åœ¨æœ¬ç« ä¸­ï¼Œå°†è¯¦ç»†ä»‹ç»Androidæºç ä¸­åŠ è½½ç±»çš„æ‰§è¡Œæµç¨‹ã€‚äº†è§£Androidä¸­ç±»åŠ è½½æœºåˆ¶ä»¥åŠå‡½æ•°è°ƒç”¨æµç¨‹æ˜¯éå¸¸é‡è¦çš„åŸºç¡€çŸ¥è¯†ã€‚é€šè¿‡å­¦ä¹ è¿™äº›æ‰§è¡Œæµç¨‹åŸç†ï¼Œåœ¨å®šåˆ¶åŠŸèƒ½æ—¶èƒ½ä¸ºæˆ‘ä»¬æä¾›æ›´å¤šæ–¹å‘å’Œæ€è·¯ã€‚ 7.1 åŒäº²å§”æ´¾æœºåˆ¶åœ¨Androidç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç¨‹åºè¿è¡Œåœ¨Dalvikæˆ–ARTè™šæ‹Ÿæœºä¸Šã€‚å½“åº”ç”¨å¯åŠ¨æ—¶ï¼ŒAndroidç³»ç»Ÿä¼šæ ¹æ®åº”ç”¨ç¨‹åºåŒ…ä¸­çš„AndroidManifest.xmlæ–‡ä»¶ç¡®å®šéœ€è¦å¯åŠ¨å“ªäº›ç»„ä»¶ï¼Œå¹¶åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­åŠ è½½æ‰€éœ€çš„ç±»ã€‚ Androidä¸­çš„ç±»åŠ è½½å™¨éµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ã€‚å³æ¯ä¸ªç±»åŠ è½½å™¨åœ¨å°è¯•åŠ è½½ä¸€ä¸ªç±»ä¹‹å‰ï¼Œéƒ½ä¼šå…ˆå§”æ‰˜å…¶çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½è¯¥ç±»ã€‚åªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆä»»åŠ¡æ—¶ï¼Œå­ç±»åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±æ¥è¿›è¡ŒåŠ è½½ã€‚è¿™ä¸ªæ¨¡å‹ä¿è¯äº†ä¸åŒçš„ç±»åªä¼šè¢«åŠ è½½ä¸€æ¬¡ï¼Œå¹¶ä¸”ä¿æŠ¤äº†æ ¸å¿ƒJava APIä¸è¢«æ¶æ„ä»£ç ç¯¡æ”¹ã€‚ åœ¨Androidåº”ç”¨ç¨‹åºä¸­ï¼Œæ¯ä¸ªç±»éƒ½åˆ†é…åˆ°ä¸€ä¸ªç‰¹å®šçš„DEXæ–‡ä»¶ï¼ˆå³Dalvik Executableï¼‰ä¸­ã€‚DEXæ–‡ä»¶åŒ…å«è¯¥ç±»æ‰€æœ‰æ–¹æ³•å’Œå±æ€§çš„å­—èŠ‚ç ã€‚å½“åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œå®ƒçš„DEXæ–‡ä»¶å°†è¢«åŠ è½½åˆ°å†…å­˜å¹¶ç”±è™šæ‹Ÿæœºæ‰§è¡Œå…¶ä¸­çš„ä»£ç ã€‚ åœ¨å‡½æ•°è°ƒç”¨æµç¨‹ä¸­ï¼Œå½“ä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œè™šæ‹Ÿæœºä¼šä¿å­˜å½“å‰çº¿ç¨‹çŠ¶æ€ï¼Œå¹¶è·³è½¬åˆ°è¢«è°ƒå‡½æ•°å…¥å£åœ°å€å¼€å§‹æ‰§è¡Œè¯¥å‡½æ•°ã€‚è™šæ‹Ÿæœºå¯¹å‡½æ•°æŒ‡ä»¤è¿›è¡Œæ‰§è¡Œï¼Œå¹¶ç»´æŠ¤æ‰§è¡Œè¿‡ç¨‹æ‰€éœ€æ•°æ®ç»“æ„ï¼ˆå¦‚æ ˆå¸§ï¼‰ã€‚å½“å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œè™šæ‹Ÿæœºå°†ç»“æœè¿”å›ç»™è°ƒç”¨æ–¹å¹¶æ¢å¤ä¹‹å‰ä¿å­˜çš„çº¿ç¨‹çŠ¶æ€ã€‚ æ·±å…¥å­¦ä¹ Androidçš„ç±»åŠ è½½æœºåˆ¶å’Œå‡½æ•°æ‰§è¡Œè°ƒç”¨æµç¨‹å¯ä»¥æ›´å¥½åœ°ç†è§£åº”ç”¨ç¨‹åºçš„è¿è¡Œæœºåˆ¶ã€‚ åœ¨Androidä¸­ï¼Œç±»é€šå¸¸ä¿å­˜åœ¨DEXæ–‡ä»¶ä¸­ï¼Œè€ŒClassLoaderåˆ™è´Ÿè´£åŠ è½½DEXæ–‡ä»¶ã€‚æ¯ä¸ªåº”ç”¨ç¨‹åºåŒ…ï¼ˆAPKï¼‰éƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªDEXæ–‡ä»¶ï¼Œè¿™äº›DEXæ–‡ä»¶åŒ…å«åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ç±»ä¿¡æ¯ã€‚å½“éœ€è¦ä½¿ç”¨æŸä¸ªç±»æ—¶ï¼ŒClassLoaderä¼šä»ç›¸åº”çš„DEXæ–‡ä»¶ä¸­åŠ è½½è¯¥ç±»ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„Javaç±»ã€‚å› æ­¤ï¼ŒClassLoaderå’ŒDEXå¯†åˆ‡ç›¸å…³ï¼ŒClassLoaderæ˜¯DEXæ–‡ä»¶çš„è½½ä½“å’Œç®¡ç†è€…ã€‚ Android ä¸­çš„ ClassLoader ç±»å‹åˆ†ä¸ºä¸¤ç§ï¼š ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚ç³»ç»Ÿç±»åŠ è½½å™¨ä¸»è¦åŒ…æ‹¬BootClassLoaderã€PathClassLoaderå’ŒDexClassLoaderã€‚ è‡ªå®šä¹‰åŠ è½½å™¨ã€‚ ä¸€äº›å¸¸è§çš„åŠ è½½å™¨çš„ç”¨é€”å¦‚ä¸‹ï¼š BootClassLoaderï¼šä½äº ClassLoader å±‚æ¬¡ç»“æ„ä¸­çš„æœ€é¡¶å±‚ã€‚è´Ÿè´£åŠ è½½ç³»ç»Ÿçº§åˆ«çš„ç±»ï¼Œå¦‚ Java æ ¸å¿ƒåº“å’Œä¸€äº›åŸºç¡€åº“ã€‚ PathClassLoaderï¼šä»åº”ç”¨ç¨‹åºçš„ APK æ–‡ä»¶ä¸­åŠ è½½ç±»å’Œèµ„æºã€‚ç»§æ‰¿è‡ªBaseDexClassLoaderç±»ï¼Œå®ƒèƒ½å¤ŸåŠ è½½å·²ç»è¢«ä¼˜åŒ–çš„ Dex æ–‡ä»¶å’Œæœªç»è¿‡ä¼˜åŒ–çš„ Dex æ–‡ä»¶ã€‚PathClassLoader ä¸»è¦ç”¨äºåŠ è½½å·²ç»æ‰“åŒ…åœ¨ APK æ–‡ä»¶ä¸­çš„ä»£ç å’Œèµ„æºã€‚ DexClassLoaderï¼šä» .dex æˆ– .odex æ–‡ä»¶ä¸­åŠ è½½ç±»ã€‚ç»§æ‰¿è‡ªBaseDexClassLoaderç±»ï¼Œå®ƒæ”¯æŒåŠ¨æ€åŠ è½½ Dex æ–‡ä»¶ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¿è¡Œæ—¶è¿›è¡Œä¼˜åŒ–æ“ä½œã€‚DexClassLoader ä¸»è¦ç”¨äºåŠ è½½æœªå®‰è£…çš„ APK æ–‡ä»¶ä¸­çš„ä»£ç ã€‚ InMemoryDexClassLoaderï¼šç”¨äºä»å†…å­˜ä¸­åŠ è½½å·²ç»å­˜åœ¨äºå†…å­˜ä¸­çš„dexæ–‡ä»¶ã€‚ç»§æ‰¿è‡ª BaseDexClassLoaderï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†å¤šä¸ªdexæ–‡ä»¶ã€‚InMemoryDexClassLoader å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ dex æ–‡ä»¶ï¼Œå¹¶ä¸”ä¸éœ€è¦å°†æ–‡ä»¶ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼Œä»è€Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ BaseDexClassLoaderï¼šDexClassLoaderã€InMemoryDexClassLoader å’Œ PathClassLoader çš„åŸºç±»ï¼Œå°è£…äº†åŠ è½½ dex æ–‡ä»¶çš„åŸºæœ¬é€»è¾‘ï¼ŒåŒ…æ‹¬åˆ›å»º DexPathList å¯¹è±¡ã€æ‰“å¼€ dex æ–‡ä»¶ã€æŸ¥æ‰¾ç±»ç­‰æ“ä½œã€‚BaseDexClassLoader å®ç°äº†åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå³åœ¨è‡ªèº«æ— æ³•åŠ è½½ç±»æ—¶ï¼Œä¼šå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨è¿›è¡ŒæŸ¥æ‰¾ã€‚BaseDexClassLoader è¿˜æ”¯æŒå¤šä¸ª dex æ–‡ä»¶çš„åŠ è½½ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è¿è¡Œæ—¶è¿›è¡Œä¼˜åŒ–æ“ä½œã€‚ SecureClassLoaderï¼šç»§æ‰¿è‡ªClassLoaderæŠ½è±¡ç±»ï¼Œè¯¥ç±»ä¸»è¦å®ç°äº†ä¸€äº›æƒé™ç›¸å…³çš„åŠŸèƒ½ã€‚ URLClassLoaderï¼šSecureClassLoaderçš„å­ç±»ï¼Œå…¶å¯ä»¥ä½¿ç”¨urlè·¯å¾„åŠ è½½JARæ–‡ä»¶ä¸­çš„ç±»ã€‚ æ•´ä¸ªç±»åŠ è½½å™¨çš„ç»§æ‰¿ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç±»åŠ è½½å™¨é‡‡ç”¨äº†åŒäº²å§”æ´¾æœºåˆ¶ï¼ˆParent Delegation Modelï¼‰ï¼Œè¿™æ˜¯ä¸€ç§ç»å…¸çš„Javaç±»åŠ è½½æœºåˆ¶ã€‚ åŒäº²å§”æ´¾æœºåˆ¶æ˜¯æŒ‡å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°è¯·æ±‚å»åŠ è½½ä¸€ä¸ªç±»æ—¶ï¼Œå®ƒå¹¶ä¸ä¼šè‡ªå·±å»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªä»»åŠ¡å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆã€‚å¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨çˆ¶ç±»åŠ è½½å™¨ï¼Œè¿™ä¸ªè¯·æ±‚å°±ä¼šå‘ä¸Šé€’å½’ï¼Œç›´åˆ°è¾¾åˆ°æœ€é¡¶å±‚çš„BootClassLoaderä¸ºæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€å…ˆè°ƒç”¨åŠ è½½çš„ClassLoaderæ˜¯æœ€é¡¶å±‚çš„ï¼Œæœ€åå°è¯•åŠ è½½çš„æ˜¯å½“å‰çš„ClassLoaderã€‚ é‡‡ç”¨åŒäº²å§”æ´¾æœºåˆ¶å¯ä»¥æœ‰æ•ˆåœ°é¿å…ç±»çš„é‡å¤åŠ è½½ï¼Œå¹¶ä¿è¯æ ¸å¿ƒAPIçš„å®‰å…¨æ€§ã€‚å…·ä½“è¡¨ç°ä¸ºï¼š åœ¨ç±»åŠ è½½æ—¶ï¼Œé¦–å…ˆä»å½“å‰åŠ è½½å™¨çš„ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»åŠ åœ¨äº†è¯¥ç±»ï¼Œå¦‚æœå·²ç»åŠ åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ï¼› å¦‚æœæ²¡æœ‰åœ¨ç¼“å­˜ä¸­æ‰¾åˆ°è¯¥ç´¯ï¼Œåˆ™å°†åŠ åœ¨ä»»åŠ¡å§”æ´¾ç»™çˆ¶ç´¯åŠ ï¼Œåœ¨è€…å®Œæˆï¼› çˆ¶ç´¯åŠ å¦‚æœä¹Ÿæ²¡æœ‰æ‰¾é“è¯¥ç´¯ï¼Œåˆ™å°†ä¼šé€’å½’å‘ä¸Šå§”æ´¾, ç›´é“BootClassLoader; BootCLassLoaderæ— æ³•ä»£ç†æ·»åŠ å’Œå‘ç”Ÿé”™è¯¯ä¹‹å‰æ‰€åšè¿‡å¾—åŠªåŠ›, åˆ™ä¼šè®©å­ç±»åŠ è½½å™¨è‡ªè¡ŒåŠ è½½ã€‚ 7.2 ç±»çš„åŠ è½½æµç¨‹åœ¨Androidä¸­ï¼ŒClassLoaderç±»æ˜¯åŒäº²å§”æ´¾æœºåˆ¶çš„ä¸»è¦å®ç°è€…ã€‚è¯¥ç±»æä¾›äº†findClasså’ŒloadClassæ–¹æ³•ï¼Œå…¶ä¸­findClassæ˜¯ClassLoaderçš„æŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦ç”±å­ç±»å®ç°ã€‚æ¥ä¸‹æ¥å°†è·Ÿè¸ªæºç å®ç°ï¼Œè¯¦ç»†äº†è§£ClassLoaderæ˜¯å¦‚ä½•è¿›è¡Œç±»åŠ è½½æµç¨‹çš„ã€‚ åœ¨å‰æ–‡ä¸­æ›¾ç»ä»‹ç»è¿‡å¦‚ä½•ä½¿ç”¨DexClassLoaderåŠ è½½ä¸€ä¸ªç±»ï¼Œå¹¶è°ƒç”¨å…¶ä¸­çš„å‡½æ•°ï¼Œä¸‹é¢æ˜¯å½“æ—¶çš„åŠ è½½æ ·ä¾‹ä»£ç ã€‚ 12345678910111213141516171819202122232425protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); String dexPath = &quot;/system/framework/kjar.jar&quot;; String dexOutputDir = getApplicationInfo().dataDir; ClassLoader classLoader = new DexClassLoader(dexPath, dexOutputDir, null, getClass().getClassLoader()); Class&lt;?&gt; clazz2 = null; try { clazz2 = classLoader.loadClass(&quot;cn.rom.myjar.MyCommon&quot;); Method addMethod = clazz2.getDeclaredMethod(&quot;add&quot;, int.class,int.class); Object result = addMethod.invoke(null, 12,25); Log.i(&quot;MainActivity&quot;,&quot;getMyJarVer:&quot;+result); } catch (ClassNotFoundException e) { e.printStackTrace(); } catch (InvocationTargetException e) { e.printStackTrace(); } catch (NoSuchMethodException e) { e.printStackTrace(); } catch (IllegalAccessException e) { e.printStackTrace(); }} â€‹ ClassLoader åŠ è½½ç±»æ—¶ï¼ŒloadClass å’Œ findClasséƒ½å¯ä»¥å®Œæˆå¯¹ç±»çš„åŠ è½½å·¥ä½œï¼Œå®ƒä»¬åœ¨åŠ è½½ç±»æ—¶æœ‰ç€ä¸åŒçš„ä½œç”¨å’Œæ‰§è¡Œæµç¨‹ã€‚ â€‹ é¦–å…ˆçœ‹çœ‹loadClassçš„ç‰¹å¾ï¼Œå®ƒçš„æ–¹æ³•ç­¾åå¦‚ä¸‹ã€‚ 1protected Class&lt;?&gt; loadClass( final String class_name, final boolean resolve ) throws ClassNotFoundException; â€‹ å…¶ä¸­name å‚æ•°è¡¨ç¤ºè¦åŠ è½½çš„ç±»çš„å…¨åï¼›resolve å‚æ•°è¡¨ç¤ºæ˜¯å¦éœ€è¦åœ¨åŠ è½½å®Œæˆåè¿›è¡Œé“¾æ¥æ“ä½œã€‚å¦‚æœ resolve å‚æ•°ä¸º trueï¼Œåˆ™ä¼šå°è¯•åœ¨åŠ è½½å®Œæˆåå¯¹è¯¥ç±»è¿›è¡Œé“¾æ¥æ“ä½œï¼ŒåŒ…æ‹¬éªŒè¯ã€å‡†å¤‡å’Œè§£æç­‰æ­¥éª¤ã€‚å¦‚æœ resolve å‚æ•°ä¸º falseï¼Œåˆ™ä¸ä¼šè¿›è¡Œé“¾æ¥æ“ä½œã€‚ â€‹ åœ¨æ‰§è¡ŒloadClassæ–¹æ³•æ—¶ï¼ŒClassLoader ä¼šå…ˆæ£€æŸ¥è‡ªèº«æ˜¯å¦å·²ç»åŠ è½½è¿‡è¯¥ç±»ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥ç±»çš„ Class å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰åŠ è½½è¿‡ï¼Œåˆ™å°†ä»»åŠ¡å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨è¿›è¡Œå¤„ç†ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»ï¼Œåˆ™å†æ¬¡è°ƒç”¨è‡ªèº«çš„ findClass æ–¹æ³•è¿›è¡ŒåŠ è½½ã€‚å¦‚æœ findClass æ–¹æ³•ä»ç„¶æ— æ³•æ‰¾åˆ°è¯¥ç±»ï¼Œåˆ™æŠ›å‡º ClassNotFoundException å¼‚å¸¸ã€‚ â€‹ æ¥ä¸‹æ¥å†äº†è§£ä¸‹findClass æ–¹æ³•ï¼Œå®ƒ æ˜¯ BaseClassLoader ç±»ä¸­å®šä¹‰çš„ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œç”¨äºåœ¨ç‰¹å®šçš„æ•°æ®æºï¼ˆå¦‚æ–‡ä»¶ã€å†…å­˜ç­‰ï¼‰ä¸­æŸ¥æ‰¾æŒ‡å®šåç§°çš„ç±»ï¼Œå¹¶è¿”å›å¯¹åº”çš„ Class å¯¹è±¡ã€‚ä¸‹é¢æ˜¯æ–¹æ³•ç­¾åã€‚ 1protected abstract Class&lt;?&gt; findClass(String name) throws ClassNotFoundException; â€‹ ä¸ loadClass ä¸åŒï¼ŒfindClass æ–¹æ³•å¹¶ä¸ä¼šå…ˆå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥åœ¨å½“å‰ ClassLoader ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚å¦‚æœèƒ½å¤Ÿæ‰¾åˆ°æŒ‡å®šçš„ç±»ï¼Œåˆ™é€šè¿‡ defineClass æ–¹æ³•å°†å…¶è½¬æ¢æˆClasså¯¹è±¡ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡ï¼›å¦åˆ™ï¼ŒæŠ›å‡º ClassNotFoundException å¼‚å¸¸ã€‚ â€‹ æ˜ç™½äº†ä¸¤è€…çš„åŒºåˆ«åï¼Œæ¥ä¸‹æ¥å¼€å§‹è·Ÿè¸ªæºç ï¼Œäº†è§£åœ¨AOSPå…·ä½“æ˜¯å¦‚ä½•åŠ è½½ç±»çš„ã€‚é¦–å…ˆæ‰¾åˆ°DexClassLoaderä¸­loadClassçš„å®ç°ä»£ç ã€‚ 123456public class DexClassLoader extends BaseDexClassLoader { public DexClassLoader(String dexPath, String optimizedDirectory, String librarySearchPath, ClassLoader parent) { super(dexPath, null, librarySearchPath, parent); }} â€‹ å‘ç°å†…éƒ¨å¹¶æ²¡æœ‰ä»»ä½•ä»£ç ï¼Œè¯´æ˜è¯¥å®ç°æ¥è‡ªäºçˆ¶ç±»ä¸­ï¼Œæ¥ç€æ¥æŸ¥çœ‹çˆ¶ç±»BaseDexClassLoader 1234567891011121314151617181920212223242526272829public class BaseDexClassLoader extends ClassLoader { public BaseDexClassLoader(String dexPath, File optimizedDirectory, String librarySearchPath, ClassLoader parent) { ... } protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException { ... } protected URL findResource(String name) { ... } protected Enumeration&lt;URL&gt; findResources(String name) { ... } public String findLibrary(String name) { ... } protected synchronized Package getPackage(String name) { ... } public String toString() { ... }} â€‹ åŒæ ·æ²¡æœ‰æ‰¾åˆ°loadClassçš„å®ç°ï¼Œç»§ç»­çœ‹å®ƒçš„çˆ¶ç±»ClassLoaderçš„å®ç°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839public abstract class ClassLoader { ... // è°ƒç”¨äº†å¦å¤–ä¸€ä¸ªé‡è½½ï¼Œresolveå‚æ•°ä¸ä¼ çš„æƒ…å†µé»˜è®¤ä¸ºfalse public Class&lt;?&gt; loadClass(String name) throws ClassNotFoundException { return loadClass(name, false); } protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException { // å°è¯•åœ¨å·²ç»åŠ è½½è¿‡çš„é‡Œé¢æŸ¥æ‰¾ Class&lt;?&gt; c = findLoadedClass(name); if (c == null) { try { // æœ‰çˆ¶ç±»çš„æƒ…å†µï¼Œå°±è®©çˆ¶ç±»æ¥åŠ è½½ if (parent != null) { c = parent.loadClass(name, false); } else { // åˆ°è¾¾çˆ¶ç±»é¡¶ç«¯åï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªå‡½æ•°æŸ¥æ‰¾ï¼Œé€šå¸¸æ¥æŸ¥æ‰¾å¼•å¯¼ç±»å’Œæ‰©å±•ç±» c = findBootstrapClassOrNull(name); } } catch (ClassNotFoundException e) { // ClassNotFoundException thrown if class not found // from the non-null parent class loader } if (c == null) { // çˆ¶ç±»æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µï¼Œå†é€šè¿‡findClassæŸ¥æ‰¾ c = findClass(name); } } return c; } ... protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException { throw new ClassNotFoundException(name); }} â€‹ é€šè¿‡è¿™é‡Œçš„ä»£ç ï¼Œèƒ½å¤Ÿå¾ˆæ¸…æ™°çš„çœ‹åˆ°å‰æ–‡ä¸­ClassLoaderçš„åŒäº²å§”æ´¾æœºåˆ¶ï¼Œæ¥ç€ç»§ç»­è·Ÿè¸ªfindClassåˆ†æå½“å‰ClassLoaderæ˜¯å¦‚ä½•åŠ è½½ç±»çš„ï¼Œç”±äºClassLoaderæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè€ŒfindClassåœ¨è¯¥ç±»ä¸­å¹¶æœªå®ç°å…·ä½“ä»£ç ï¼Œæ‰€ä»¥è¯¥æ–¹æ³•æ˜¯åœ¨å­ç±»ä¸­å®ç°ï¼Œä¸Šé¢åœ¨BaseDexClassLoaderçš„ç±»ä¸­ï¼Œå°±å·²ç»çœ‹åˆ°çš„findClassçš„å‡½æ•°ï¼Œä¸‹é¢æ˜¯å…·ä½“å®ç°ã€‚ 123456789101112131415161718192021222324252627282930public class BaseDexClassLoader extends ClassLoader { ... private final DexPathList pathList; ... protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException { // é¦–å…ˆæ£€æŸ¥å½“å‰ClassLoaderæ˜¯å¦æœ‰å…±äº«åº“ï¼Œå¦‚æœæœ‰åˆ™éå†æ¯ä¸ªå…±äº«åº“çš„ClassLoaderå»å°è¯•åŠ è½½è¯¥ç±» if (sharedLibraryLoaders != null) { for (ClassLoader loader : sharedLibraryLoaders) { try { return loader.loadClass(name); } catch (ClassNotFoundException ignored) { } } } List&lt;Throwable&gt; suppressedExceptions = new ArrayList&lt;Throwable&gt;(); // å½“å‰ClassLoaderæ“ä½œçš„dexæ–‡ä»¶ä¸­æŸ¥æ‰¾è¯¥ç±» Class c = pathList.findClass(name, suppressedExceptions); if (c == null) { ClassNotFoundException cnfe = new ClassNotFoundException( &quot;Didn't find class \\&quot;&quot; + name + &quot;\\&quot; on path: &quot; + pathList); for (Throwable t : suppressedExceptions) { cnfe.addSuppressed(t); } throw cnfe; } return c; } ...} â€‹ pathListæ˜¯ä¸€ä¸ªDexPathListå¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰ClassLoaderæ‰€ç®¡ç†çš„ä¸€ç»„dexæ–‡ä»¶çš„è·¯å¾„åˆ—è¡¨ã€‚findClass()æ–¹æ³•é€šè¿‡è°ƒç”¨DexPathList.findClass()æ–¹æ³•æ¥æŸ¥æ‰¾æŒ‡å®šåç§°çš„ç±»ã€‚ç»§ç»­è·Ÿè¿›æŸ¥çœ‹ã€‚ 12345678910111213141516171819public final class DexPathList { ... private Element[] dexElements; ... public Class&lt;?&gt; findClass(String name, List&lt;Throwable&gt; suppressed) { for (Element element : dexElements) { Class&lt;?&gt; clazz = element.findClass(name, definingContext, suppressed); if (clazz != null) { return clazz; } } if (dexElementsSuppressedExceptions != null) { suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions)); } return null; } ...} â€‹ dexElementsçš„æ•°ç»„å­˜æ”¾ç€æ‰€æœ‰å·²ç»åŠ è½½çš„dexæ–‡ä»¶ä¸­çš„ç±»ä¿¡æ¯ã€‚å…·ä½“æ¥è¯´ï¼Œæ¯ä¸ªdexæ–‡ä»¶éƒ½è¢«è§£æä¸ºä¸€ä¸ªDexFileå¯¹è±¡ï¼Œè€ŒdexElementsæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªElementå¯¹è±¡ï¼Œä»£è¡¨äº†ä¸€ä¸ªdexæ–‡ä»¶å’Œå…¶ä¸­åŒ…å«çš„ç±»ä¿¡æ¯ã€‚è¿™äº›Elementå¯¹è±¡æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºæ’åˆ—ï¼Œä»¥ä¾¿ClassLoaderå¯ä»¥æ ¹æ®å®ƒä»¬çš„é¡ºåºæ¥æŸ¥æ‰¾ç±»å®šä¹‰ã€‚ç»§ç»­æŸ¥çœ‹Elementçš„findClassæ–¹æ³•å®ç°ã€‚ 1234567891011121314151617181920212223242526272829303132333435static class Element { ... // ç®¡ç†ç€ä¸€ä¸ªdexæ–‡ä»¶ private final DexFile dexFile; ... private String getDexPath() { if (path != null) { return path.isDirectory() ? null : path.getAbsolutePath(); } else if (dexFile != null) { // DexFile.getName() returns the path of the dex file. return dexFile.getName(); } return null; } @Override public String toString() { if (dexFile == null) { return (pathIsDirectory ? &quot;directory \\&quot;&quot; : &quot;zip file \\&quot;&quot;) + path + &quot;\\&quot;&quot;; } else if (path == null) { return &quot;dex file \\&quot;&quot; + dexFile + &quot;\\&quot;&quot;; } else { return &quot;zip file \\&quot;&quot; + path + &quot;\\&quot;&quot;; } } public Class&lt;?&gt; findClass(String name, ClassLoader definingContext, List&lt;Throwable&gt; suppressed) { return dexFile != null ? dexFile.loadClassBinaryName(name, definingContext, suppressed) : null; } ... } â€‹ å¯ä»¥çœ‹åˆ°è¿™é‡Œå®é™…å°±æ˜¯ç®¡ç†ä¸€ä¸ªå¯¹åº”çš„DexFileå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å…³è”ç€ä¸€ä¸ªå¯¹åº”çš„dexæ–‡ä»¶ï¼Œè¿™é‡Œé€šè¿‡è°ƒç”¨DexFileå¯¹è±¡çš„loadClassBinaryNameå»åŠ è½½è¿™ä¸ªç±»ï¼Œç»§ç»­è·Ÿè¸ªå®ƒçš„å®ç°ã€‚ 12345678910111213141516171819202122232425262728public final class DexFile { ... public Class loadClassBinaryName(String name, ClassLoader loader, List&lt;Throwable&gt; suppressed) { return defineClass(name, loader, mCookie, this, suppressed); } ... private static Class defineClass(String name, ClassLoader loader, Object cookie, DexFile dexFile, List&lt;Throwable&gt; suppressed) { Class result = null; try { result = defineClassNative(name, loader, cookie, dexFile); } catch (NoClassDefFoundError e) { if (suppressed != null) { suppressed.add(e); } } catch (ClassNotFoundException e) { if (suppressed != null) { suppressed.add(e); } } return result; } ... private static native Class defineClassNative(String name, ClassLoader loader, Object cookie, DexFile dexFile) throws ClassNotFoundException, NoClassDefFoundError;} â€‹ è¿™é‡Œçœ‹åˆ°ç»è¿‡å‡ å±‚è°ƒç”¨åï¼Œè¿›å…¥äº†nativeå®ç°äº†ï¼Œæ ¹æ®AOSPä¸­nativeæ³¨å†Œçš„å‘½åè§„åˆ™ï¼Œç›´æ¥æœç´¢DexFile_defineClassNativeæ‰¾åˆ°å¯¹åº”çš„å®ç°ä»£ç å¦‚ä¸‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647static jclass DexFile_defineClassNative(JNIEnv* env, jclass, jstring javaName, jobject javaLoader, jobject cookie, jobject dexFile) { std::vector&lt;const DexFile*&gt; dex_files; const OatFile* oat_file; // cookieè½¬æ¢æˆä¸€ç»„c++ä¸­çš„DexFileå¯¹è±¡ä»¥åŠOatFile if (!ConvertJavaArrayToDexFiles(env, cookie, /*out*/ dex_files, /*out*/ oat_file)) { VLOG(class_linker) &lt;&lt; &quot;Failed to find dex_file&quot;; DCHECK(env-&gt;ExceptionCheck()); return nullptr; } ... // å°†ç±»åè½¬æ¢ä¸ºc++çš„stringå­˜æ”¾åœ¨äº†descriptorä¸­ // è¿™é‡Œä¼šå°†javaä¸­çš„ç±»æè¿°ç¬¦è½¬æ¢ä¸ºc++ä½¿ç”¨çš„ç±»æè¿°ç¬¦ï¼Œä¾‹å¦‚ç±»ä¸­çš„.è½¬æ¢ä¸º\\ const std::string descriptor(DotToDescriptor(class_name.c_str())); const size_t hash(ComputeModifiedUtf8Hash(descriptor.c_str())); for (auto&amp; dex_file : dex_files) { // æ ¹æ®ç±»æè¿°ç¬¦æ‰¾åˆ°å¯¹åº”çš„ç±» const dex::ClassDef* dex_class_def = OatDexFile::FindClassDef(*dex_file, descriptor.c_str(), hash); if (dex_class_def != nullptr) { ScopedObjectAccess soa(env); ClassLinker* class_linker = Runtime::Current()-&gt;GetClassLinker(); ... // ä½¿ç”¨ç±»åŠ è½½å™¨å’Œ DEX æ–‡ä»¶å®šä¹‰ä¸€ä¸ªæ–°çš„ Java ç±»ï¼Œå¹¶è¿”å›ä¸€ä¸ªæè¿°è¯¥ç±»çš„ Class å¯¹è±¡æŒ‡é’ˆ ObjPtr&lt;mirror::Class&gt; result = class_linker-&gt;DefineClass(soa.Self(), descriptor.c_str(), hash, class_loader, *dex_file, *dex_class_def); // å°†DexFileæ’å…¥åˆ°ClassLoaderä¸­ã€‚ class_linker-&gt;InsertDexFileInToClassLoader(soa.Decode&lt;mirror::Object&gt;(dexFile), class_loader.Get()); if (result != nullptr) { VLOG(class_linker) &lt;&lt; &quot;DexFile_defineClassNative returning &quot; &lt;&lt; result &lt;&lt; &quot; for &quot; &lt;&lt; class_name.c_str(); return soa.AddLocalReference&lt;jclass&gt;(result); } } } VLOG(class_linker) &lt;&lt; &quot;Failed to find dex_class_def &quot; &lt;&lt; class_name.c_str(); return nullptr;} â€‹ ä»£ç ä¸­çœ‹åˆ°cookieä¸­èƒ½æ‹¿åˆ°æ‰€æœ‰DexFileï¼Œæœ€ç»ˆçš„Classå¯¹è±¡æ˜¯ç”±DefineClassæ–¹æ³•å®šä¹‰åè¿”å›çš„ã€‚ç»§ç»­çœ‹å…¶å®ç°è¿‡ç¨‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950ObjPtr&lt;mirror::Class&gt; ClassLinker::DefineClass(Thread* self, const char* descriptor, size_t hash, Handle&lt;mirror::ClassLoader&gt; class_loader, const DexFile&amp; dex_file, const dex::ClassDef&amp; dex_class_def) { ... DexFile const* new_dex_file = nullptr; dex::ClassDef const* new_class_def = nullptr; // ç±»è¢«åŠ è½½å‰çš„é¢„å¤„ç† Runtime::Current()-&gt;GetRuntimeCallbacks()-&gt;ClassPreDefine(descriptor, klass, class_loader, dex_file, dex_class_def, &amp;new_dex_file, &amp;new_class_def); // å°†dexæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ ObjPtr&lt;mirror::DexCache&gt; dex_cache = RegisterDexFile(*new_dex_file, class_loader.Get()); if (dex_cache == nullptr) { self-&gt;AssertPendingException(); return sdc.Finish(nullptr); } klass-&gt;SetDexCache(dex_cache); // åˆå§‹åŒ–ç±» SetupClass(*new_dex_file, *new_class_def, klass, class_loader.Get()); ... // å‘ç±»è¡¨ä¸­æ’å…¥ç±»å¯¹è±¡ ObjPtr&lt;mirror::Class&gt; existing = InsertClass(descriptor, klass.Get(), hash); ... // åŠ è½½å¹¶åˆå§‹åŒ–ç±»ï¼Œåœ¨å¿…è¦æ—¶åˆ›å»ºæ–°çš„ç±»å¯¹è±¡ LoadClass(self, *new_dex_file, *new_class_def, klass); ... MutableHandle&lt;mirror::Class&gt; h_new_class = hs.NewHandle&lt;mirror::Class&gt;(nullptr); // é“¾æ¥ç±»åŠå…¶ç›¸å…³ä¿¡æ¯ if (!LinkClass(self, descriptor, klass, interfaces, &amp;h_new_class)) { // Linking failed. if (!klass-&gt;IsErroneous()) { mirror::Class::SetStatus(klass, ClassStatus::kErrorUnresolved, self); } return sdc.Finish(nullptr); } return sdc.Finish(h_new_class);} â€‹ ClassPreDefineæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå®ƒåœ¨ç±»è¢«åŠ è½½ä¹‹å‰è¢«è°ƒç”¨ï¼Œç”¨äºè¿›è¡Œä¸€äº›é¢„å¤„ç†å·¥ä½œã€‚å…·ä½“æ¥è¯´ï¼ŒClassPreDefinä¼šè¢«è°ƒç”¨ä»¥æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š å¯¹æ–°å®šä¹‰çš„ç±»è¿›è¡ŒéªŒè¯å’Œè§£æï¼Œä»¥ç¡®ä¿ç±»ç»“æ„çš„æ­£ç¡®æ€§ã€‚ ä¸ºæ–°å®šä¹‰çš„ç±»åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶æ„é€ æ–°å¯¹è±¡çš„å®ä¾‹ã€‚ è®¾ç½®ç±»çš„è®¿é—®æ§åˆ¶æƒé™å¹¶æ›´æ–°å…³è”çš„ç¼“å­˜ä¿¡æ¯ã€‚ â€‹ RegisterDexFileç”¨äºæ³¨å†Œ DEX æ–‡ä»¶ã€‚è¯¥å‡½æ•°è´Ÿè´£å°† DEX æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶å°†å…¶ä¸­åŒ…å«çš„ç±»å’Œç›¸å…³ä¿¡æ¯æ³¨å†Œåˆ°è¿è¡Œæ—¶ç¯å¢ƒä¸­ï¼Œä»¥ä¾›åç»­çš„ç¨‹åºä½¿ç”¨ã€‚è¯¥å‡½æ•°çš„ä¸»è¦è´Ÿè´£ï¼š å°† DEX æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸ºå…¶åˆ†é…ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ã€‚ åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸­åˆ›å»ºmirror::DexFileå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«äº† DEXæ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚æ–‡ä»¶åã€MD5 å“ˆå¸Œå€¼ç­‰ã€‚ ä¸ºDEXæ–‡ä»¶ä¸­åŒ…å«çš„æ¯ä¸ªç±»åˆ›å»ºç›¸åº”çš„ mirror::Class å¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ç±»è¡¨ä¸­è¿›è¡Œç®¡ç†ã€‚ ä¸ºæ–°åˆ›å»ºçš„ mirror::Class å¯¹è±¡è®¾ç½®å…¶è®¿é—®æƒé™å’Œå…¶ä»–å±æ€§ï¼Œä¾‹å¦‚ç±»æ ‡å¿—ã€å­—æ®µã€æ–¹æ³•ç­‰ã€‚ åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª mirror::DexCache å¯¹è±¡ï¼Œè¯¥å¯¹è±¡è¡¨ç¤ºå·²æ³¨å†Œçš„DEXæ–‡ä»¶çš„ç¼“å­˜ä¿¡æ¯ã€‚ â€‹ SetupClass å‡½æ•°ç”¨äºåˆå§‹åŒ–ç±»ã€‚è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨ï¼š è§£æç±»å®šä¹‰ï¼Œå¹¶ä¸ºå…¶åˆ†é…å†…å­˜ç©ºé—´ã€‚ ä¸ºæ–°åˆ›å»ºçš„ç±»å¯¹è±¡è®¾ç½®ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚ç±»åã€è¶…ç±»ã€æ¥å£ä¿¡æ¯ç­‰ã€‚ è®¾ç½®ç±»å¯¹è±¡çš„è®¿é—®ä¿®é¥°ç¬¦å’Œæ ‡å¿—ã€‚ å°†ç±»å¯¹è±¡æ·»åŠ åˆ°è¿è¡Œæ—¶ç¯å¢ƒä¸­è¿›è¡Œç®¡ç†ã€‚ åœ¨å¿…è¦çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œä¸ç±»åŠ è½½ç”Ÿå‘½å‘¨æœŸæœ‰å…³çš„å›è°ƒå‡½æ•°ã€‚ â€‹ InsertClasså‡½æ•°ç”¨äºå‘ç±»è¡¨ä¸­æ’å…¥æ–°çš„ç±»å¯¹è±¡ï¼Œå¹¶ç¡®ä¿åœ¨æ’å…¥ä¹‹å‰å¯¹å…¶è¿›è¡Œå¿…è¦çš„éªŒè¯å’Œåˆå§‹åŒ–å·¥ä½œã€‚è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨ï¼š æ ¹æ®ç±»æè¿°ç¬¦å’Œå“ˆå¸Œå€¼æŸ¥æ‰¾ç±»è¡¨ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„ç±»å¯¹è±¡ã€‚ å¦‚æœå·²ç»å­˜åœ¨ç›¸åŒçš„ç±»å¯¹è±¡ï¼Œåˆ™è¿”å›å…¶æŒ‡é’ˆï¼Œå¦åˆ™å°†æ–°çš„ç±»å¯¹è±¡æ’å…¥åˆ°ç±»è¡¨ä¸­ï¼Œå¹¶è¿”å›å…¶æŒ‡é’ˆã€‚ åœ¨æ’å…¥æ–°çš„ç±»å¯¹è±¡ä¹‹å‰ï¼Œä¼šå…ˆè¿›è¡Œä¸€äº›éªŒè¯å·¥ä½œï¼Œä¾‹å¦‚æ£€æŸ¥ç±»çš„è®¿é—®æƒé™ï¼Œä»¥åŠç¡®ä¿ç±»çš„ç»“æ„å’Œè¶…ç±»çš„ç»§æ‰¿å…³ç³»æ­£ç¡®ç­‰ã€‚ åœ¨éœ€è¦æ—¶ï¼Œæ‰§è¡Œä¸ç±»åŠ è½½ç”Ÿå‘½å‘¨æœŸæœ‰å…³çš„å›è°ƒå‡½æ•°ã€‚ â€‹ LoadClass å‡½æ•°ç”¨äºåŠ è½½å¹¶åˆå§‹åŒ–ç±»ã€‚å¹¶å°†å…¶æ’å…¥åˆ°ç±»è¡¨ä¸­è¿›è¡Œç®¡ç†ã€‚ä¸»è¦ä½œç”¨ï¼š æ ¹æ®ç±»æè¿°ç¬¦æŸ¥æ‰¾ç±»è¡¨ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„ç±»å¯¹è±¡ï¼Œå¦‚å­˜åœ¨åˆ™ç›´æ¥è¿”å›å…¶æŒ‡é’ˆã€‚ å¦‚æœç±»è¡¨ä¸­ä¸å­˜åœ¨ç›¸åŒçš„ç±»å¯¹è±¡ï¼Œåˆ™å…ˆä½¿ç”¨ SetupClass() å‡½æ•°åˆ›å»ºæ–°çš„ç±»å¯¹è±¡ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°ç±»è¡¨ä¸­ã€‚æ­¤å¤„è°ƒç”¨äº† InsertClass() å‡½æ•°ã€‚ åŠ è½½å¹¶åˆå§‹åŒ–ç±»çš„è¶…ç±»åŠæ¥å£ä¿¡æ¯ï¼Œä»¥ç¡®ä¿ç±»çš„ç»§æ‰¿å…³ç³»æ­£ç¡®ã€‚ æ‰§è¡Œä¸ç±»åŠ è½½ç”Ÿå‘½å‘¨æœŸæœ‰å…³çš„å›è°ƒå‡½æ•°ã€‚ â€‹ LinkClass å‡½æ•°æ˜¯åœ¨ç”¨äºé“¾æ¥ç±»ï¼Œè¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ç±»å¯¹è±¡æŒ‡é’ˆï¼Œä»¥ä¾›è°ƒç”¨è€…ä½¿ç”¨ã€‚ä¸»è¦ä½œç”¨ï¼š é“¾æ¥ç±»çš„è¶…ç±»ï¼Œå¹¶æ‰§è¡Œä¸è¶…ç±»æœ‰å…³çš„åˆå§‹åŒ–å·¥ä½œã€‚ é“¾æ¥ç±»å®ç°çš„æ¥å£ï¼Œå¹¶æ‰§è¡Œä¸æ¥å£æœ‰å…³çš„åˆå§‹åŒ–å·¥ä½œã€‚ é“¾æ¥ç±»çš„å­—æ®µï¼Œå¹¶æ‰§è¡Œä¸å­—æ®µæœ‰å…³çš„åˆå§‹åŒ–å·¥ä½œã€‚ é“¾æ¥ç±»çš„æ–¹æ³•ï¼Œå¹¶æ‰§è¡Œä¸æ–¹æ³•æœ‰å…³çš„åˆå§‹åŒ–å·¥ä½œã€‚ åœ¨å¿…è¦æ—¶åˆ›å»ºæ–°çš„ç±»å¯¹è±¡ï¼Œå¹¶å°†å…¶è¿”å›ç»™è°ƒç”¨è€…ã€‚ â€‹ å°†åŠ è½½ç±»çš„è¿‡ç¨‹ä¸­å‡ ä¸ªå…³é”®çš„æ­¥éª¤ææ¸…æ¥šåï¼Œç»§ç»­æ·±å…¥æŸ¥çœ‹LoadClassæ˜¯å¦‚ä½•å®ç°çš„ï¼Œé‡ç‚¹å…³æ³¨æœ€åä¸€ä¸ªå‚æ•°kclassåšäº†äº›ä»€ä¹ˆã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081void ClassLinker::LoadClass(Thread* self, const DexFile&amp; dex_file, const dex::ClassDef&amp; dex_class_def, Handle&lt;mirror::Class&gt; klass) { ... Runtime* const runtime = Runtime::Current(); { ... // è·å–ç±»åŠ è½½å™¨çš„çº¿æ€§å†…å­˜åˆ†é…å™¨ LinearAlloc* const allocator = GetAllocatorForClassLoader(klass-&gt;GetClassLoader()); // ä¸ºç±»ä¸­çš„é™æ€å­—æ®µåˆ†é…å†…å­˜ç©ºé—´ LengthPrefixedArray&lt;ArtField&gt;* sfields = AllocArtFieldArray(self, allocator, accessor.NumStaticFields()); // ä¸ºç±»ä¸­çš„å®ä¾‹å­—æ®µåˆ†é…å†…å­˜ç©ºé—´ LengthPrefixedArray&lt;ArtField&gt;* ifields = AllocArtFieldArray(self, allocator, accessor.NumInstanceFields()); ... // è®¾ç½®ç±»çš„æ–¹æ³•åˆ—è¡¨æŒ‡é’ˆ klass-&gt;SetMethodsPtr( AllocArtMethodArray(self, allocator, accessor.NumMethods()), accessor.NumDirectMethods(), accessor.NumVirtualMethods()); size_t class_def_method_index = 0; uint32_t last_dex_method_index = dex::kDexNoIndex; size_t last_class_def_method_index = 0; // éå†ç±»çš„æ‰€æœ‰æ–¹æ³•å’Œå­—æ®µ accessor.VisitFieldsAndMethods([&amp;]( const ClassAccessor::Field&amp; field) REQUIRES_SHARED(Locks::mutator_lock_) { ... // éå†æ‰€æœ‰å­—æ®µï¼Œç”±last_static_field_idxåˆ¤æ–­æ˜¯å¦æ­£åœ¨å¤„ç†çš„æ˜¯é™æ€å­—æ®µ if (num_sfields == 0 || LIKELY(field_idx &gt; last_static_field_idx)) { // åŠ è½½å­—æ®µä¿¡æ¯ LoadField(field, klass, &amp;sfields-&gt;At(num_sfields)); ++num_sfields; last_static_field_idx = field_idx; } }, [&amp;](const ClassAccessor::Field&amp; field) REQUIRES_SHARED(Locks::mutator_lock_) { ... // åŠ è½½å®ä¾‹å­—æ®µä¿¡æ¯ if (num_ifields == 0 || LIKELY(field_idx &gt; last_instance_field_idx)) { LoadField(field, klass, &amp;ifields-&gt;At(num_ifields)); ++num_ifields; last_instance_field_idx = field_idx; } }, [&amp;](const ClassAccessor::Method&amp; method) REQUIRES_SHARED(Locks::mutator_lock_) { // è·å–å®ä¾‹æ–¹æ³• ArtMethod* art_method = klass-&gt;GetDirectMethodUnchecked(class_def_method_index, image_pointer_size_); // å°†dex_fileå‚æ•°ä¸­æŒ‡å‘Javaæ–¹æ³•å­—èŠ‚ç çš„æŒ‡é’ˆ(method)è§£æä¸ºæœºå™¨ç ï¼Œå¹¶å°†å®ƒå­˜å‚¨åˆ°art_methodå‚æ•°å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸­ï¼Œå®Œæˆå¯¹Javaæ–¹æ³•å®ç°ä»£ç çš„åŠ è½½ LoadMethod(dex_file, method, klass, art_method); // å°†art_methodå‚æ•°å¯¹åº”çš„å®ç°ä»£ç é“¾æ¥åˆ°oat_class_ptrå‚æ•°å¯¹åº”çš„oatæ–‡ä»¶ä¸­ LinkCode(this, art_method, oat_class_ptr, class_def_method_index); ... }, [&amp;](const ClassAccessor::Method&amp; method) REQUIRES_SHARED(Locks::mutator_lock_) { // å’Œä¸Šé¢å·®ä¸å¤šçš„ï¼Œä¸è¿‡è¿™é‡Œå¤„ç†çš„æ˜¯è™šæ–¹æ³• ArtMethod* art_method = klass-&gt;GetVirtualMethodUnchecked( class_def_method_index - accessor.NumDirectMethods(), image_pointer_size_); LoadMethod(dex_file, method, klass, art_method); LinkCode(this, art_method, oat_class_ptr, class_def_method_index); ++class_def_method_index; }); ... // å°†åŠ è½½å¥½çš„å­—æ®µä¿å­˜åˆ°kclass klass-&gt;SetSFieldsPtr(sfields); DCHECK_EQ(klass-&gt;NumStaticFields(), num_sfields); klass-&gt;SetIFieldsPtr(ifields); DCHECK_EQ(klass-&gt;NumInstanceFields(), num_ifields); } // Ensure that the card is marked so that remembered sets pick up native roots. WriteBarrier::ForEveryFieldWrite(klass.Get()); self-&gt;AllowThreadSuspension();} â€‹ ç„¶åå†äº†è§£ä¸€ä¸‹LoadFieldå’ŒLoadMethodæ˜¯å¦‚ä½•åŠ è½½çš„ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394void ClassLinker::LoadField(const ClassAccessor::Field&amp; field, Handle&lt;mirror::Class&gt; klass, ArtField* dst) { // å¯ä»¥çœ‹åˆ°å®é™…å°±æ˜¯å°†å€¼å¡«å……ç»™äº†dst const uint32_t field_idx = field.GetIndex(); dst-&gt;SetDexFieldIndex(field_idx); dst-&gt;SetDeclaringClass(klass.Get()); dst-&gt;SetAccessFlags(field.GetAccessFlags() | hiddenapi::CreateRuntimeFlags(field));}void ClassLinker::LoadMethod(const DexFile&amp; dex_file, const ClassAccessor::Method&amp; method, Handle&lt;mirror::Class&gt; klass, ArtMethod* dst) { const uint32_t dex_method_idx = method.GetIndex(); const dex::MethodId&amp; method_id = dex_file.GetMethodId(dex_method_idx); const char* method_name = dex_file.StringDataByIdx(method_id.name_idx_); ScopedAssertNoThreadSuspension ants(&quot;LoadMethod&quot;); dst-&gt;SetDexMethodIndex(dex_method_idx); dst-&gt;SetDeclaringClass(klass.Get()); ... // å¦‚æœåŠ è½½çš„æ˜¯finalizeæ–¹æ³• if (UNLIKELY(strcmp(&quot;finalize&quot;, method_name) == 0)) { ... } else if (method_name[0] == '&lt;') { // å¤„ç†æ„é€ å‡½æ•° bool is_init = (strcmp(&quot;&lt;init&gt;&quot;, method_name) == 0); bool is_clinit = !is_init &amp;&amp; (strcmp(&quot;&lt;clinit&gt;&quot;, method_name) == 0); if (UNLIKELY(!is_init &amp;&amp; !is_clinit)) { LOG(WARNING) &lt;&lt; &quot;Unexpected '&lt;' at start of method name &quot; &lt;&lt; method_name; } else { if (UNLIKELY((access_flags &amp; kAccConstructor) == 0)) { LOG(WARNING) &lt;&lt; method_name &lt;&lt; &quot; didn't have expected constructor access flag in class &quot; &lt;&lt; klass-&gt;PrettyDescriptor() &lt;&lt; &quot; in dex file &quot; &lt;&lt; dex_file.GetLocation(); // access_flagså­˜å‚¨äº†Javaæ–¹æ³•çš„è®¿é—®æ ‡å¿—ï¼Œå¦‚publicã€privateã€staticç­‰ã€‚kAccConstructoræ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œè¡¨ç¤ºJavaæ„é€ å‡½æ•°çš„è®¿é—®æ ‡å¿— access_flags |= kAccConstructor; } } } // åˆ¤æ–­æ˜¯å¦ä¸ºnativeå‡½æ•° if (UNLIKELY((access_flags &amp; kAccNative) != 0u)) { // Check if the native method is annotated with @FastNative or @CriticalNative. access_flags |= annotations::GetNativeMethodAnnotationAccessFlags( dex_file, dst-&gt;GetClassDef(), dex_method_idx); } // è®¾ç½®è¯¥æ–¹æ³•çš„è®¿é—®æ ‡å¿— dst-&gt;SetAccessFlags(access_flags); // åˆ¤æ–­æ˜¯å¦ä¸ºæ¥å£ç±»çš„æŠ½è±¡æ–¹æ³• if (klass-&gt;IsInterface() &amp;&amp; dst-&gt;IsAbstract()) { // è®¡ç®—å¹¶è®¾ç½®æŠ½è±¡æ–¹æ³•çš„IMTç´¢å¼•ã€‚IMT(Interface Method Table)æ˜¯ä¸€ä¸ªè™šæ‹Ÿè¡¨ï¼Œç”¨äºå­˜å‚¨æ¥å£ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ç´¢å¼•ã€‚ dst-&gt;CalculateAndSetImtIndex(); } // è¿™ä¸ªjavaæ–¹æ³•æ˜¯å¦æœ‰å¯æ‰§è¡Œä»£ç ï¼Œä¹Ÿå°±æ˜¯javaå­—èŠ‚ç ï¼Œæ–¹æ³•çš„å…·ä½“æ‰§è¡ŒæŒ‡ä»¤é›† if (dst-&gt;HasCodeItem()) { DCHECK_NE(method.GetCodeItemOffset(), 0u); // æ ¹æ®å½“å‰æ˜¯å¦é‡‡ç”¨AOTç¼–è¯‘å™¨æ¥è¿›è¡Œä¸åŒçš„æ–¹å¼å¡«å……å¯æ‰§è¡Œä»£ç ã€‚ if (Runtime::Current()-&gt;IsAotCompiler()) { dst-&gt;SetDataPtrSize(reinterpret_cast32&lt;void*&gt;(method.GetCodeItemOffset()), image_pointer_size_); } else { dst-&gt;SetCodeItem(dst-&gt;GetDexFile()-&gt;GetCodeItem(method.GetCodeItemOffset())); } } else { dst-&gt;SetDataPtrSize(nullptr, image_pointer_size_); DCHECK_EQ(method.GetCodeItemOffset(), 0u); } // æ£€æŸ¥è¯¥æ–¹æ³•çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹æ˜¯å¦ç¬¦åˆè¦æ±‚ const char* shorty = dst-&gt;GetShorty(); bool all_parameters_are_reference = true; bool all_parameters_are_reference_or_int = true; bool return_type_is_fp = (shorty[0] == 'F' || shorty[0] == 'D'); for (size_t i = 1, e = strlen(shorty); i &lt; e; ++i) { if (shorty[i] != 'L') { all_parameters_are_reference = false; if (shorty[i] == 'F' || shorty[i] == 'D' || shorty[i] == 'J') { all_parameters_are_reference_or_int = false; break; } } } // Javaæ–¹æ³•è®¾ç½®æ˜¯å¦å¯ç”¨Nterpå¿«é€Ÿè·¯å¾„ï¼Œå¦‚æœè¯¥å‡½æ•°énativeçš„ï¼Œå¹¶ä¸”å‚æ•°å…¨éƒ¨ä¸ºå¼•ç”¨ç±»å‹ï¼Œåˆ™è®¾ç½®è¯¥æ–¹æ³•çš„entry_point_from_interpreter_ä¸ºNterpå¿«é€Ÿè·¯å¾„ if (!dst-&gt;IsNative() &amp;&amp; all_parameters_are_reference) { dst-&gt;SetNterpEntryPointFastPathFlag(); } // è¿”å›å€¼ç±»å‹éæµ®ç‚¹å‹ï¼Œå¹¶ä¸”æ‰€æœ‰å‚æ•°ç±»å‹éƒ½æ˜¯å¼•ç”¨ç±»å‹æˆ–æ•´å‹ï¼Œåˆ™è®¾ç½®è¯¥æ–¹æ³•çš„invocation_count_ä¸ºNterpå¿«é€Ÿè·¯å¾„ if (!return_type_is_fp &amp;&amp; all_parameters_are_reference_or_int) { dst-&gt;SetNterpInvokeFastPathFlag(); }} â€‹ finalizeæ˜¯Javaä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®šä¹‰åœ¨Objectç±»ä¸­ï¼Œç”¨äºæ‰§è¡Œåƒåœ¾å›æ”¶å‰çš„èµ„æºæ¸…ç†å·¥ä½œã€‚å½“æŸä¸ªå¯¹è±¡ä¸å†è¢«å¼•ç”¨æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šè°ƒç”¨è¯¥å¯¹è±¡çš„finalizeæ–¹æ³•æ¥å®Œæˆä¸€äº›ç‰¹å®šçš„æ¸…ç†æ“ä½œï¼Œå¦‚é‡Šæ”¾éæ‰˜ç®¡èµ„æºç­‰ã€‚ â€‹ Nterpå¿«é€Ÿè·¯å¾„ï¼ˆNterp Fast Pathï¼‰æ˜¯ARTè™šæ‹Ÿæœºçš„ä¸€ç§æ‰§è¡Œæ¨¡å¼ï¼Œå¯ä»¥åœ¨ä¸è¿›è¡Œçº¿ç¨‹åˆ‡æ¢çš„æƒ…å†µä¸‹å¿«é€Ÿæ‰§è¡ŒJavaæ–¹æ³•ã€‚å…·ä½“æ¥è¯´ï¼ŒNterpå¿«é€Ÿè·¯å¾„ä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„ã€åŸºäºæŒ‡ä»¤è®¡æ•°å™¨çš„æ‰§è¡Œæ¨¡å¼æ¥å¤„ç†Javaæ–¹æ³•ï¼Œä»¥å®ç°æ›´é«˜æ•ˆçš„æ€§èƒ½ã€‚ â€‹ Nterpå¿«é€Ÿè·¯å¾„çš„ä½œç”¨æ˜¯æé«˜Javaæ–¹æ³•çš„æ‰§è¡Œé€Ÿåº¦å’Œæ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯åœ¨çƒ­ç‚¹ä»£ç éƒ¨åˆ†ï¼Œå¯ä»¥è·å¾—æ›´é«˜çš„ååé‡å’Œæ›´ä½çš„å»¶è¿Ÿã€‚å¦å¤–ï¼Œç”±äºé‡‡ç”¨äº†ä¸€äº›ç‰¹æ®Šçš„ä¼˜åŒ–æŠ€æœ¯ï¼Œå¦‚å‚æ•°ä¼ é€’æ–¹å¼æ”¹å˜ã€è¿”å›å€¼å¤„ç†æµç¨‹ä¼˜åŒ–ç­‰ï¼ŒNterpå¿«é€Ÿè·¯å¾„è¿˜å¯ä»¥å‡å°‘JNIå¼€é”€ï¼Œä»è€Œæå‡æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ€§èƒ½è¡¨ç°ã€‚ â€‹ åœ¨å‰æ–‡ä»‹ç»nativeçš„åŠ¨æ€æ³¨å†Œæ—¶ï¼Œæ›¾ç»ç®€å•çš„è®²è§£LinkCodeï¼Œè¿™é‡Œå†æ¬¡å¯¹è¿™ä¸ªé‡ç‚¹å‡½æ•°è¿›è¡Œè¯¦ç»†çš„äº†è§£ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445bool ClassLinker::ShouldUseInterpreterEntrypoint(ArtMethod* method, const void* quick_code) { ... if (quick_code == nullptr) { return true; } .. return false;}static void LinkCode(ClassLinker* class_linker, ArtMethod* method, const OatFile::OatClass* oat_class, uint32_t class_def_method_index) REQUIRES_SHARED(Locks::mutator_lock_) { ... const void* quick_code = nullptr; if (oat_class != nullptr) { const OatFile::OatMethod oat_method = oat_class-&gt;GetOatMethod(class_def_method_index); // è·å–ä¸€ä¸ªæ–¹æ³•çš„å¿«é€Ÿä»£ç ï¼ˆQuick Codeï¼‰ï¼Œç”¨äºè®¾ç½®è¯¥æ–¹æ³•çš„å…¥å£ç‚¹åœ°å€ quick_code = oat_method.GetQuickCode(); } // å¦‚æœæœ‰æ–¹æ³•çš„å¿«é€Ÿä»£ç ï¼Œå¦åˆ™ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œï¼Œåœ¨ä¸‹ä¸€èŠ‚çš„å‡½æ•°è°ƒç”¨ä¸­ä¼šè¯¦ç»†è®²åˆ° bool enter_interpreter = class_linker-&gt;ShouldUseInterpreterEntrypoint(method, quick_code); if (quick_code == nullptr) { // è®¾ç½®ä¸€ä¸ªæ–¹æ³•çš„å…¥å£ç‚¹ä½ç½®ï¼Œå¯ä»¥æ˜¯ç¼–è¯‘æˆæœºå™¨ç çš„å¿«é€Ÿæ‰§è¡Œå…¥å£ã€è§£é‡Šå™¨å…¥å£ï¼Œæˆ–è€…nativeå‡½æ•°çš„å…¥å£åœ°å€ method-&gt;SetEntryPointFromQuickCompiledCode( method-&gt;IsNative() ? GetQuickGenericJniStub() : GetQuickToInterpreterBridge()); } else if (enter_interpreter) { // è®¾ç½®è§£é‡Šå™¨å…¥å£ä¸ºè¯¥æ–¹æ³•çš„å…¥å£ç‚¹ä½ç½® method-&gt;SetEntryPointFromQuickCompiledCode(GetQuickToInterpreterBridge()); } else if (NeedsClinitCheckBeforeCall(method)) { DCHECK(!method-&gt;GetDeclaringClass()-&gt;IsVisiblyInitialized()); method-&gt;SetEntryPointFromQuickCompiledCode(GetQuickResolutionStub()); } else { // å·²ç»ç¼–è¯‘å¥½çš„æœºå™¨ç æ‰€åœ¨çš„å¿«é€Ÿæ‰§è¡Œå…¥å£ method-&gt;SetEntryPointFromQuickCompiledCode(quick_code); } // ç»™nativeè®¾ç½®å…¥å£åœ°å€çš„ï¼Œåœ¨ç¬¬å…­ç« åŠ¨æ€æ³¨å†Œä¸­è®²åˆ°ã€‚ if (method-&gt;IsNative()) { ... }} â€‹ å¿«é€Ÿä»£ç æ˜¯æŒ‡ä¸€ç§ä¼˜åŒ–åçš„æœ¬åœ°æœºå™¨ä»£ç ï¼Œå®ƒå¯ä»¥ç›´æ¥æ‰§è¡ŒJavaå­—èŠ‚ç å¯¹åº”çš„æŒ‡ä»¤ï¼Œä»è€Œå®ç°æ›´å¿«çš„å‡½æ•°è°ƒç”¨å’Œæ‰§è¡Œã€‚å¿«é€Ÿä»£ç é€šå¸¸æ˜¯é€šè¿‡å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰æˆ–é¢„ç¼–è¯‘æŠ€æœ¯ç”Ÿæˆçš„ï¼Œå¹¶ä¿å­˜åœ¨Oatæ–‡ä»¶ä¸­ã€‚åœ¨è¿è¡Œæ—¶ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•å·²ç»è¢«ç¼–è¯‘ä¸ºå¿«é€Ÿä»£ç ï¼Œåˆ™LinkCodeå‡½æ•°å¯ä»¥ç›´æ¥ä½¿ç”¨Oatæ–‡ä»¶ä¸­çš„æ–¹æ³•æè¿°ç¬¦è·å–å¿«é€Ÿä»£ç çš„åœ°å€ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºè¯¥æ–¹æ³•çš„å…¥å£ç‚¹åœ°å€ã€‚ â€‹ æ¥ä¸‹æ¥çœ‹çœ‹è®¾ç½®çš„è§£é‡Šå™¨å…¥å£æ˜¯ä»€ä¹ˆï¼Œè·Ÿè¸ªæ–¹æ³•GetQuickToInterpreterBridgeçš„å®ç°ã€‚ 123static inline const void* GetQuickToInterpreterBridge() { return reinterpret_cast&lt;const void*&gt;(art_quick_to_interpreter_bridge);} â€‹ è¿™é‡Œå’ŒnativeåŠ¨æ€æ³¨å†Œåˆ†ææ—¶çœ‹åˆ°å…¥å£è®¾ç½®éå¸¸ç±»ä¼¼ï¼ŒGetQuickToInterpreterBridgeæ˜¯ä¸€ä¸ªé™æ€å†…è”å‡½æ•°ï¼Œå®ƒå°†å…¨å±€å˜é‡art_quick_to_interpreter_bridgeçš„åœ°å€å¼ºåˆ¶è½¬æ¢ä¸ºconst void*ç±»å‹ï¼Œç„¶åè¿”å›è¯¥åœ°å€ã€‚art_quick_to_interpreter_bridgeæ˜¯ä¸€ä¸ªæŒ‡å‘è§£é‡Šå™¨å…¥å£ç‚¹çš„å‡½æ•°æŒ‡é’ˆï¼Œå®ƒåœ¨é“¾æ¥å™¨å¯åŠ¨æ—¶è¢«åˆå§‹åŒ–ï¼Œæ˜¯ç”±æ±‡ç¼–è¿›è¡Œå®ç°ã€‚ 123456789101112131415161718ENTRY art_quick_to_interpreter_bridge SETUP_SAVE_REFS_AND_ARGS_FRAME // Set up frame and save arguments. // x0 will contain mirror::ArtMethod* method. mov x1, xSELF // How to get Thread::Current() ??? mov x2, sp // uint64_t artQuickToInterpreterBridge(mirror::ArtMethod* method, Thread* self, // mirror::ArtMethod** sp) bl artQuickToInterpreterBridge RESTORE_SAVE_REFS_AND_ARGS_FRAME REFRESH_MARKING_REGISTER fmov d0, x0 RETURN_OR_DELIVER_PENDING_EXCEPTIONEND art_quick_to_interpreter_bridge æŸ¥çœ‹æ±‡ç¼–ä»£ç æ—¶ï¼Œå¯ä»¥æ³¨æ„åˆ°å…³é”®æ˜¯ä½¿ç”¨blæŒ‡ä»¤è°ƒç”¨artQuickToInterpreterBridgeå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯è§£é‡Šå™¨çš„å…¥å£å‡½æ•°ã€‚ è§£é‡Šå™¨ï¼ˆInterpreterï¼‰æ˜¯ä¸€ç§Javaå­—èŠ‚ç æ‰§è¡Œå¼•æ“ï¼Œå®ƒèƒ½å¤Ÿç›´æ¥è§£é‡Šå’Œæ‰§è¡ŒJavaå­—èŠ‚ç æŒ‡ä»¤ã€‚ä¸é¢„ç¼–è¯‘çš„æœ¬åœ°æœºå™¨ä»£ç ä¸åŒï¼Œè§£é‡Šå™¨ä»¥Javaå­—èŠ‚ç ä¸ºåŸºç¡€ï¼Œé€šè¿‡é€æ¡è§£é‡Šæ‰§è¡Œæ¥å®Œæˆå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ã€‚ å½“åº”ç”¨ç¨‹åºéœ€è¦æ‰§è¡Œä¸€ä¸ªJavaæ–¹æ³•æ—¶ï¼Œé“¾æ¥å™¨ä¼šå°†è¯¥æ–¹æ³•çš„å­—èŠ‚ç è¯»å…¥å†…å­˜ï¼Œå¹¶åˆ©ç”¨è§£é‡Šå™¨é€æ¡æŒ‡ä»¤æ‰§è¡Œã€‚è§£é‡Šå™¨ä¼šæ ¹æ®Javaå­—èŠ‚ç ç±»å‹è¿›è¡Œç›¸åº”çš„æ“ä½œï¼ŒåŒ…æ‹¬åˆ›å»ºå¯¹è±¡ã€è¯»å–/å†™å…¥å±€éƒ¨å˜é‡å’Œæ“ä½œæ•°æ ˆã€è·³è½¬æ“ä½œç­‰ã€‚åŒæ—¶ï¼Œè§£é‡Šå™¨è¿˜ä¼šå¤„ç†å¼‚å¸¸ã€åƒåœ¾å›æ”¶ã€çº¿ç¨‹åŒæ­¥ç­‰æ–¹é¢çš„æ“ä½œï¼Œä»è€Œä¿è¯Javaç¨‹åºçš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚ å°½ç®¡è§£é‡Šå™¨çš„æ‰§è¡Œé€Ÿåº¦æ¯”æœ¬åœ°æœºå™¨ä»£ç è¦æ…¢ä¸€äº›ï¼Œä½†å®ƒå…·æœ‰è®¸å¤šä¼˜ç‚¹ã€‚ä¾‹å¦‚ï¼Œè§£é‡Šå™¨å¯ä»¥å®ç°æ›´å¿«çš„ç¨‹åºå¯åŠ¨æ—¶é—´ã€æ›´å°çš„å†…å­˜å ç”¨å’Œæ›´å¥½çš„çµæ´»æ€§ï¼›åŒæ—¶ï¼Œå®ƒè¿˜å¯ä»¥é¿å…å› ç¡¬ä»¶å¹³å°å·®å¼‚ã€ç¼–è¯‘å™¨ä¼˜åŒ–ç­‰é—®é¢˜å¯¼è‡´ä»£ç æ‰§è¡Œå¼‚å¸¸å’Œå®‰å…¨éšæ‚£ã€‚ å½“ä¸€ä¸ªæ–¹æ³•ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œåœ¨è¿›è¡Œåˆæ­¥è§£é‡Šå’Œæ‰§è¡Œä¹‹åï¼Œè§£é‡Šå™¨ä¼šç”Ÿæˆç›¸åº”çš„Profileæ•°æ®ã€‚åç»­è°ƒç”¨å°†æ ¹æ®Profileæ•°æ®å†³å®šæ˜¯å¦ä½¿ç”¨JITç¼–è¯‘å™¨æˆ–AOTç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–ã€‚è¿™ç§æ··åˆçš„æ‰§è¡Œæ–¹å¼å¯ä»¥æœ‰æ•ˆåœ°å¹³è¡¡è¿è¡Œæ•ˆç‡å’Œå†…å­˜å¼€é”€ä¹‹é—´çš„å…³ç³»ï¼Œæé«˜Javaç¨‹åºçš„æ•´ä½“æ€§èƒ½å’Œå“åº”é€Ÿåº¦ã€‚ å½“ç±»åŠ è½½å®Œæˆåï¼Œå¯¹åº”çš„ç±»æ•°æ®å°†ä¼šå­˜å‚¨åœ¨ç›¸åº”çš„DexFileä¸­ã€‚åœ¨åç»­ä½¿ç”¨ä¸­ï¼Œå¯ä»¥é€šè¿‡DexFileæ¥è®¿é—®ç±»ä¸­çš„æˆå‘˜å’Œå‡½æ•°ã€‚ä¸‹é¢ç®€å•äº†è§£ä¸€ä¸‹DexFileç»“æ„ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697class DexFile { public: // dexæ–‡ä»¶é­”æ•°çš„å­—èŠ‚æ•°ã€‚ static constexpr size_t kDexMagicSize = 4; // dexæ–‡ä»¶ç‰ˆæœ¬å·çš„å­—èŠ‚æ•°ã€‚ static constexpr size_t kDexVersionLen = 4; static constexpr uint32_t kClassDefinitionOrderEnforcedVersion = 37; // SHA-1æ¶ˆæ¯æ‘˜è¦çš„é•¿åº¦ static constexpr size_t kSha1DigestSize = 20; // dexæ–‡ä»¶çš„å¤§å°ç«¯æ ‡å¿— static constexpr uint32_t kDexEndianConstant = 0x12345678; // æ— æ•ˆç´¢å¼•çš„å€¼ static constexpr uint16_t kDexNoIndex16 = 0xFFFF; static constexpr uint32_t kDexNoIndex32 = 0xFFFFFFFF; // è¡¨ç¤ºdexæ–‡ä»¶å¤´ç»“æ„ struct Header { uint8_t magic_[8] = {}; // é­”æ•° uint32_t checksum_ = 0; // æ ¡éªŒå’Œ uint8_t signature_[kSha1DigestSize] = {}; // SHA-1ç­¾å uint32_t file_size_ = 0; // æ–‡ä»¶æ€»å¤§å° uint32_t header_size_ = 0; // åç§»é‡åˆ°ä¸‹ä¸€éƒ¨åˆ†çš„èµ·å§‹ä½ç½® uint32_t endian_tag_ = 0; // å¤§å°ç«¯æ ‡å¿— uint32_t link_size_ = 0; uint32_t link_off_ = 0; uint32_t map_off_ = 0; uint32_t string_ids_size_ = 0; // å­—ç¬¦ä¸²IDçš„æ•°é‡ uint32_t string_ids_off_ = 0; // å­—ç¬¦ä¸²IDæ•°ç»„çš„æ–‡ä»¶åç§»é‡ uint32_t type_ids_size_ = 0; // ç±»å‹IDæ•°ï¼Œä¸æ”¯æŒè¶…è¿‡65535ä¸ª uint32_t type_ids_off_ = 0; // ç±»å‹IDæ•°ç»„çš„æ–‡ä»¶åç§»é‡ uint32_t proto_ids_size_ = 0; // ProtoIdçš„æ•°é‡ï¼Œä¸æ”¯æŒè¶…è¿‡65535ä¸ª uint32_t proto_ids_off_ = 0; // ProtoIdæ•°ç»„çš„æ–‡ä»¶åç§»é‡ uint32_t field_ids_size_ = 0; // FieldIdsçš„æ•°é‡ uint32_t field_ids_off_ = 0; // FieldIdsæ•°ç»„çš„æ–‡ä»¶åç§»é‡ uint32_t method_ids_size_ = 0; // MethodIdsçš„æ•°é‡ uint32_t method_ids_off_ = 0; // MethodIdsæ•°ç»„çš„æ–‡ä»¶åç§»é‡ uint32_t class_defs_size_ = 0; // ClassDefsçš„æ•°é‡ uint32_t class_defs_off_ = 0; // ClassDefæ•°ç»„çš„æ–‡ä»¶åç§»é‡ uint32_t data_size_ = 0; // æ•°æ®éƒ¨åˆ†çš„å¤§å° uint32_t data_off_ = 0; // æ•°æ®éƒ¨åˆ†çš„æ–‡ä»¶åç§»é‡ // è§£ç dexæ–‡ä»¶ç‰ˆæœ¬å·ã€‚ uint32_t GetVersion() const; }; ... protected: // æ”¯æŒé»˜è®¤æ–¹æ³•çš„ç¬¬ä¸€ä¸ªDexæ ¼å¼ç‰ˆæœ¬ã€‚ static constexpr uint32_t kDefaultMethodsVersion = 37; ... // dexæ–‡ä»¶æ•°æ®èµ·å§‹ä½ç½® const uint8_t* const begin_; // å†…å­˜åˆ†é…çš„å­—èŠ‚æ•°ã€‚ const size_t size_; // æ•°æ®èŠ‚çš„åŸºåœ°å€ï¼ˆå¯¹äºæ ‡å‡†dexï¼Œä¸Begin()ç›¸åŒï¼‰ã€‚ const uint8_t* const data_begin_; // æ•°æ®èŠ‚çš„å¤§å°ã€‚ const size_t data_size_; const std::string location_; const uint32_t location_checksum_; // Dexæ–‡ä»¶å¤´çš„æŒ‡é’ˆ const Header* const header_; // å­—ç¬¦ä¸²æ ‡è¯†ç¬¦åˆ—è¡¨çš„æŒ‡é’ˆ const dex::StringId* const string_ids_; // ç±»å‹æ ‡è¯†ç¬¦åˆ—è¡¨çš„æŒ‡é’ˆ const dex::TypeId* const type_ids_; // å­—æ®µæ ‡è¯†ç¬¦åˆ—è¡¨çš„æŒ‡é’ˆ const dex::FieldId* const field_ids_; // æ–¹æ³•æ ‡è¯†ç¬¦åˆ—è¡¨çš„æŒ‡é’ˆ const dex::MethodId* const method_ids_; // åŸå‹æ ‡è¯†ç¬¦åˆ—è¡¨çš„æŒ‡é’ˆ const dex::ProtoId* const proto_ids_; // ç±»å®šä¹‰åˆ—è¡¨çš„æŒ‡é’ˆ const dex::ClassDef* const class_defs_; // æ–¹æ³•å¥æŸ„åˆ—è¡¨çš„æŒ‡é’ˆ const dex::MethodHandleItem* method_handles_; // æ–¹æ³•å¥æŸ„åˆ—è¡¨ä¸­å…ƒç´ çš„æ•°é‡ size_t num_method_handles_; ...}; â€‹ æ¥ç€æŸ¥çœ‹DexFileçš„æ„é€ å‡½æ•°å®ç°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940DexFile::DexFile(const uint8_t* base, size_t size, const uint8_t* data_begin, size_t data_size, const std::string&amp; location, uint32_t location_checksum, const OatDexFile* oat_dex_file, std::unique_ptr&lt;DexFileContainer&gt; container, bool is_compact_dex) : begin_(base), size_(size), data_begin_(data_begin), data_size_(data_size), location_(location), location_checksum_(location_checksum), header_(reinterpret_cast&lt;const Header*&gt;(base)), string_ids_(reinterpret_cast&lt;const StringId*&gt;(base + header_-&gt;string_ids_off_)), type_ids_(reinterpret_cast&lt;const TypeId*&gt;(base + header_-&gt;type_ids_off_)), field_ids_(reinterpret_cast&lt;const FieldId*&gt;(base + header_-&gt;field_ids_off_)), method_ids_(reinterpret_cast&lt;const MethodId*&gt;(base + header_-&gt;method_ids_off_)), proto_ids_(reinterpret_cast&lt;const ProtoId*&gt;(base + header_-&gt;proto_ids_off_)), class_defs_(reinterpret_cast&lt;const ClassDef*&gt;(base + header_-&gt;class_defs_off_)), method_handles_(nullptr), num_method_handles_(0), call_site_ids_(nullptr), num_call_site_ids_(0), hiddenapi_class_data_(nullptr), oat_dex_file_(oat_dex_file), container_(std::move(container)), is_compact_dex_(is_compact_dex), hiddenapi_domain_(hiddenapi::Domain::kApplication) { CHECK(begin_ != nullptr) &lt;&lt; GetLocation(); CHECK_GT(size_, 0U) &lt;&lt; GetLocation(); // Check base (=header) alignment. // Must be 4-byte aligned to avoid undefined behavior when accessing // any of the sections via a pointer. CHECK_ALIGNED(begin_, alignof(Header)); InitializeSectionsFromMapList();} â€‹ å¯ä»¥çœ‹å‡ºheader_è¿™ä¸ªdexæ–‡ä»¶å¤´çš„ç»“æ„ä½“ä¸­å­˜å‚¨ç€æœ€é‡è¦çš„ä¿¡æ¯ï¼Œåˆå§‹åŒ–æ—¶å…ˆæ˜¯å¡«å……äº†header_ä¸­çš„æ•°æ®ï¼Œç„¶åå†æ ¹æ®header_æ–‡ä»¶å¤´ï¼Œå°†å…¶ä»–é‡è¦ä¿¡æ¯åˆå§‹åŒ–ã€‚å½“éœ€è¦å¯¹è¿™ä¸ªDexè¿›è¡Œè®¿é—®æ—¶ï¼Œåªéœ€è¦é€šè¿‡æ–‡ä»¶å¤´ä¿¡æ¯ï¼Œå°±å¯ä»¥ä¸ºæˆ‘ä»¬ç´¢å¼•æ‰¾åˆ°ä»»ä½•ä¸€æ®µä¿¡æ¯äº†ã€‚å®ƒæä¾›äº†æ•´ä¸ªæ–‡ä»¶çš„ç´¢å¼•ã€‚ â€‹ ä½¿ç”¨010 Editorå·¥å…·ï¼Œé€šè¿‡æ¨¡æ¿åº“åœ¨çº¿å®‰è£…DEX.btæ¨¡æ¿ï¼Œç„¶åæ‰“å¼€ä¹‹å‰çš„æ ·ä¾‹æ–‡ä»¶ï¼ŒæŸ¥çœ‹åœ¨ä¾‹å­ä¸­header_çš„çœŸå®æ•°æ®ã€‚ 7.3 å‡½æ•°è°ƒç”¨æµç¨‹åœ¨Androidä¸­ï¼ŒJavaå‡½æ•°å’Œnativeå‡½æ•°çš„è°ƒç”¨æ–¹å¼ç•¥æœ‰ä¸åŒã€‚ å¯¹äºJavaå‡½æ•°ï¼Œå®ƒä»¬çš„æ‰§è¡Œæ˜¯ç”±Android Runtimeè™šæ‹Ÿæœºå®Œæˆçš„ã€‚å…·ä½“æ¥è¯´ï¼Œå½“åº”ç”¨ç¨‹åºéœ€è¦è°ƒç”¨ä¸€ä¸ªJavaå‡½æ•°æ—¶ï¼ŒAndroid Runtimeä¼šæ ¹æ®è¯¥å‡½æ•°çš„çŠ¶æ€å’Œç±»å‹è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼ŒåŒ…æ‹¬è§£é‡Šå™¨æ‰§è¡Œã€JITç¼–è¯‘å™¨åŠ¨æ€ç”Ÿæˆæœºå™¨ç ç­‰ï¼›å½“å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œç»“æœä¼šè¢«ä¼ é€’å›åº”ç”¨ç¨‹åºã€‚ è€Œå¯¹äºnativeå‡½æ•°ï¼Œåˆ™æ˜¯ç”±æ“ä½œç³»ç»Ÿå†…æ ¸ç›´æ¥æ‰§è¡Œçš„ã€‚åº”ç”¨ç¨‹åºéœ€è¦é€šè¿‡JNIï¼ˆJava Native Interfaceï¼‰æ¥è°ƒç”¨native å‡½æ•°ã€‚é¦–å…ˆå°†Javaæ•°æ®ç»“æ„è½¬æ¢ä¸ºC/C++ç±»å‹, ç„¶åå°†å‚æ•°ä¼ é€’ç»™ native å‡½æ•°, æœ€ç»ˆå†å°†ç»“æœè½¬æ¢ä¸ºJavaæ•°æ®ç»“æ„å¹¶è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­, JNIæä¾›äº†ä¸€ç³»åˆ—çš„å‡½æ•°å’Œæ¥å£æ¥å®ç°Javaä¸æœ¬åœ°ä»£ç /æ•°æ®ä¹‹é—´çš„äº¤äº’å’Œè½¬æ¢ã€‚ ä¸‹é¢ä½¿ç”¨åç¼–è¯‘å·¥å…·jadxæ‰“å¼€å‰æ–‡ä¸­çš„æ ·ä¾‹ç¨‹åºï¼Œæ ·ä¾‹ç¨‹åºçš„ä»£ç å¦‚ä¸‹ã€‚ 12345678public class MyCommon { public static String getMyJarVer() { return &quot;v1.0&quot;; } public static int add(int a, int b) { return a + b; }} â€‹ åˆ‡æ¢ä¸ºå±•ç¤ºsmaliæŒ‡ä»¤ï¼Œå¹¶å³é”®é€‰æ‹©æ˜¾ç¤ºDalvikå­—èŠ‚ç ï¼Œçœ‹åˆ°å¦‚ä¸‹ä»£ç ã€‚ 12345678910111213.method public static add(II)I .registers 3 .param p0, &quot;a&quot;:I .param p1, &quot;b&quot;:I .line 11 002bf89c: 9000 0102 0000: add-int v0, p0, p1 .end local v1 # &quot;a&quot;:I .end local v2 # &quot;b&quot;:I 002bf8a0: 0f00 0002: return v0.end method â€‹ .registers 3è¡¨ç¤ºè¯¥å‡½æ•°ä¸­ä½¿ç”¨åˆ°äº†3ä¸ªå¯„å­˜å™¨ï¼Œåˆ†åˆ«ä¸ºä¸¤ä¸ªå‚æ•°å’Œè¿”å›å€¼ã€‚ â€‹ 002bf89c è¡¨ç¤ºçš„æ˜¯å½“å‰æŒ‡ä»¤çš„åç§»åœ°å€ã€‚ â€‹ 9000 0102 å°±æ˜¯è¯¥å‡½æ•°ä¸­çš„javaå­—èŠ‚ç ï¼Œå…¶ä¸­å‰ä¸¤ä¸ªå­—èŠ‚9000è¡¨ç¤ºçš„æ˜¯æ“ä½œç ï¼Œç”±äºå­—èŠ‚ç æ˜¯å¤§ç«¯åºå­˜å‚¨çš„ï¼Œæ‰€ä»¥è¿™é‡Œå®é™…æ“ä½œç è§£è¯»ä¸º0x0090ï¼Œä¸‹é¢åœ¨AOSPä¸­å¯¹Opcodesçš„å®šä¹‰ä¸­ä¹Ÿèƒ½çœ‹åˆ°0x90æ“ä½œç å¯¹åº”çš„æ“ä½œæ˜¯add-intã€‚ 12345public interface Opcodes { ... int OP_ADD_INT = 0x0090; ...} â€‹ ä½¿ç”¨010 Editorå·¥å…·ï¼Œå°†æ ·ä¾‹ç¨‹åºè§£å‹åè·å¾—çš„classes.dexæ‹–å…¥010 Editoræ‰“å¼€ã€‚çœ‹åˆ°ç»“æœå¦‚ä¸‹ã€‚ â€‹ æ¥ä¸‹æ¥åœ¨dex_class_defsä¸­å¯»æ‰¾åˆšåˆšåˆ†æçš„ç›®æ ‡ç±»MyCommonã€‚ 1struct class_def_item class_def[2205] public cn.rom.myjar.MyCommon 1243C4h 20h Fg: Bg:0xE0E0E0 Class ID â€‹ å°†å…¶å±•å¼€åï¼Œèƒ½çœ‹åˆ°è¯¥classçš„è¯¦ç»†ä¿¡æ¯ï¼Œåœ¨ä¸Šä¸€èŠ‚çš„ç±»åŠ è½½ä¸­ï¼Œå½“DEXè¢«è§£æåï¼ŒåŠ è½½çš„ç±»åœ¨å†…å­˜ä¸­å°±æ˜¯ä»¥è¿™æ ·çš„ç»“æ„å­˜å‚¨ç€æ•°æ®ã€‚ â€‹ åœ¨å…¶ä¸­çš„å‡½æ•°ç»“æ„ä½“ä¸‹é¢çš„code_itemç±»å‹çš„æ•°æ®ï¼Œå°±å­˜å‚¨ç€è¯¥å‡½æ•°è¦æ‰§è¡Œçš„javaå­—èŠ‚ç ï¼Œç»§ç»­å±•å¼€è¯¥ç»“æ„ã€‚ â€‹ è¿™é‡Œå°±èƒ½çœ‹åˆ°å¯¹è¯¥å‡½æ•°ç»“æ„çš„æè¿°äº†ï¼Œinsnsä¸­åˆ™å­˜å‚¨ç€å‡½æ•°è¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚æ¯ä¸ªæŒ‡ä»¤çš„å•ä½æ˜¯ushortï¼Œå³ä¸¤ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œå°†è¿™é‡Œçš„ä¸‰ä¸ªæŒ‡ä»¤è½¬æ¢ä¸º16è¿›åˆ¶è¡¨ç¤ºåˆ™æ˜¯ã€‚ 12345144 = 00 90 -&gt; å¤§ç«¯åº -&gt; 9000513 = 02 01 -&gt; å¤§ç«¯åº -&gt; 010215 = 00 0F -&gt; å¤§ç«¯åº -&gt; 0f00 â€‹ ç»“æœå’Œä¸Šé¢smaliå±•ç¤ºä¸­çš„ä¸€è‡´ã€‚è¿™å°±æ˜¯javaå­—èŠ‚ç ï¼Œåœ¨è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šç»è¿‡å±‚å±‚çš„è½¬æ¢å’Œè§£æï¼Œæœ€ç»ˆé€šè¿‡å¯¹å‡½æ•°ä¸­çš„æŒ‡ä»¤è¿›è¡Œæ‰§è¡Œæ¥å®Œæˆå‡½æ•°çš„è°ƒç”¨ã€‚ â€‹ æ¥ä¸‹æ¥æ ¹æ®ä¹‹å‰çš„ä¾‹å­ï¼Œå¼€å§‹å¯¹å‡½æ•°è°ƒç”¨æµç¨‹çš„ä»£ç è¿›è¡Œè·Ÿè¸ªåˆ†æã€‚ 123456protected void onCreate(Bundle savedInstanceState) { ... Object result = addMethod.invoke(null, 12,25); Log.i(&quot;MainActivity&quot;,&quot;getMyJarVer:&quot;+result); ...} â€‹ æ‰¾åˆ°Methodçš„invokeçš„å®ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªnativeå‡½æ•°ï¼Œæ‰€ä»¥ç»§ç»­æ‰¾å¯¹åº”çš„Method_invokeå‡½æ•°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445@FastNative public native Object invoke(Object obj, Object... args) throws IllegalAccessException, IllegalArgumentException, InvocationTargetException;static jobject Method_invoke(JNIEnv* env, jobject javaMethod, jobject javaReceiver, jobjectArray javaArgs) { ScopedFastNativeObjectAccess soa(env); return InvokeMethod&lt;kRuntimePointerSize&gt;(soa, javaMethod, javaReceiver, javaArgs);}jobject InvokeMethod(const ScopedObjectAccessAlreadyRunnable&amp; soa, jobject javaMethod, jobject javaReceiver, jobject javaArgs, size_t num_frames) { ... // Javaæ–¹æ³•å’ŒArtMethodä¹‹é—´å­˜åœ¨æ˜ å°„å…³ç³»ï¼ŒSOAæä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥å°†Javaå¯¹è±¡è½¬æ¢ä¸ºArtè™šæ‹Ÿæœºä¸­çš„æ•°æ®å¯¹è±¡ ObjPtr&lt;mirror::Executable&gt; executable = soa.Decode&lt;mirror::Executable&gt;(javaMethod); const bool accessible = executable-&gt;IsAccessible(); ArtMethod* m = executable-&gt;GetArtMethod(); ... if (!m-&gt;IsStatic()) { // Replace calls to String.&lt;init&gt; with equivalent StringFactory call. if (declaring_class-&gt;IsStringClass() &amp;&amp; m-&gt;IsConstructor()) { ... } else { ... // æŸ¥æ‰¾è™šæ–¹æ³•çš„çœŸå®å®ç° m = receiver-&gt;GetClass()-&gt;FindVirtualMethodForVirtualOrInterface(m, kPointerSize); } } // å¯¹javaæ–¹æ³•çš„å‚æ•°è¿›è¡Œè½¬æ¢ ObjPtr&lt;mirror::ObjectArray&lt;mirror::Object&gt;&gt; objects = soa.Decode&lt;mirror::ObjectArray&lt;mirror::Object&gt;&gt;(javaArgs); ... // è°ƒç”¨å‡½æ•° JValue result; const char* shorty; if (!InvokeMethodImpl(soa, m, np_method, receiver, objects, &amp;shorty, &amp;result)) { return nullptr; } return soa.AddLocalReference&lt;jobject&gt;(BoxPrimitive(Primitive::GetType(shorty[0]), result));} åœ¨ä¸Šé¢è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¸»è¦ä½¿ç”¨SOAå°†Javaå‡½æ•°ä»¥åŠå‡½æ•°çš„å‚æ•°è½¬æ¢ä¸ºC++å¯¹è±¡ã€‚ Structured Object Accessï¼ˆSOAï¼‰ç”¨äºä¼˜åŒ–Javaå¯¹è±¡åœ¨Nativeä»£ç å’ŒArtè™šæ‹Ÿæœºä¹‹é—´çš„ä¼ é€’å’Œå¤„ç†ã€‚SOAæŠ€æœ¯æä¾›äº†ä¸€ç§é«˜æ•ˆçš„æ–¹å¼ï¼Œå°†Javaå¯¹è±¡è½¬æ¢ä¸ºåŸºäºæŒ‡é’ˆçš„æœ¬åœ°C++å¯¹è±¡ï¼Œä»è€Œé¿å…äº†é¢‘ç¹çš„å¯¹è±¡å¤åˆ¶å’ŒGCæ“ä½œï¼Œæé«˜äº†ç¨‹åºçš„æ€§èƒ½å’Œæ‰§è¡Œæ•ˆç‡ã€‚ åœ¨SOAæŠ€æœ¯ä¸­ä½¿ç”¨Handleå’ŒObjPtrç­‰ç±»å‹çš„æŒ‡é’ˆæ¥ç®¡ç†Javaå¯¹è±¡å’Œæœ¬åœ°C++å¯¹è±¡ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚Handleæ˜¯ä¸€ç§åŒ…è£…å™¨ï¼Œç”¨äºç®¡ç†Javaå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ç¡®ä¿å…¶åœ¨è¢«è®¿é—®æ—¶ä¸ä¼šè¢«GCå›æ”¶ã€‚ObjPtråˆ™æ˜¯ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œç”¨äºç®¡ç†æœ¬åœ°C++å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ç¡®ä¿å…¶æ­£ç¡®é‡Šæ”¾å’Œé”€æ¯ã€‚ é€šè¿‡SOAå¯ä»¥åœ¨Nativeä»£ç ä¸­é«˜æ•ˆåœ°è®¿é—®å’Œæ“ä½œJavaå¯¹è±¡ï¼Œä¾‹å¦‚è°ƒç”¨Javaæ–¹æ³•ã€è¯»å–Javaå­—æ®µç­‰ã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒSOAæŠ€æœ¯ä¼šè‡ªåŠ¨è¿›è¡Œå¯¹è±¡çš„å†…å­˜åˆ†é…å’Œç®¡ç†ï¼Œä»¥ç¡®ä¿ç¨‹åºçš„æ­£ç¡®æ€§å’Œæ€§èƒ½è¡¨ç°ã€‚ æ¥ä¸‹æ¥ç»§ç»­äº†è§£InvokeMethodImplå‡½æ•°çš„å®ç°ã€‚ 123456789101112131415161718192021ALWAYS_INLINEbool InvokeMethodImpl(const ScopedObjectAccessAlreadyRunnable&amp; soa, ArtMethod* m, ArtMethod* np_method, ObjPtr&lt;mirror::Object&gt; receiver, ObjPtr&lt;mirror::ObjectArray&lt;mirror::Object&gt;&gt; objects, const char** shorty, JValue* result) REQUIRES_SHARED(Locks::mutator_lock_) { // å°†å‡½æ•°çš„å‚æ•°è½¬æ¢åï¼Œå­˜æ”¾åˆ°arg_arrayä¸­ã€‚ uint32_t shorty_len = 0; *shorty = np_method-&gt;GetShorty(&amp;shorty_len); ArgArray arg_array(*shorty, shorty_len); if (!arg_array.BuildArgArrayFromObjectArray(receiver, objects, np_method, soa.Self())) { CHECK(soa.Self()-&gt;IsExceptionPending()); return false; } // å‡½æ•°è°ƒç”¨ InvokeWithArgArray(soa, m, &amp;arg_array, result, *shorty); ... return true;} â€‹ ArgArrayä¸»è¦ç”¨äºç®¡ç†Javaæ–¹æ³•å‚æ•°åˆ—è¡¨çš„ç±»ã€‚ArgArrayå’ŒJavaä¸­çš„ç±»å‹å¯¹åº”å¦‚ä¸‹ï¼š â€‹ 1.åŸºæœ¬ç±»å‹ï¼šArgArrayä¸­çš„åŸºæœ¬ç±»å‹åˆ†åˆ«å¯¹åº”Javaä¸­çš„å…«ç§åŸºæœ¬ç±»å‹ booleanï¼š'Z' byteï¼š'B' shortï¼š'S' charï¼š'C' intï¼š'I' longï¼š'J' floatï¼š'F' doubleï¼š'D' â€‹ 2.å¼•ç”¨ç±»å‹ï¼šArgArrayä¸­çš„å¼•ç”¨ç±»å‹å¯¹åº”Javaä¸­çš„å¯¹è±¡ç±»å‹ï¼ŒåŒ…æ‹¬Stringã€Objectã€æ•°ç»„ç­‰ã€‚åœ¨ArgArrayä¸­ï¼Œå¼•ç”¨ç±»å‹ç”¨å­—ç¬¦'L'å¼€å¤´ï¼Œå¹¶ç´§è·Ÿç€å®Œæ•´ç±»åå’Œç»“å°¾çš„åˆ†å·';'è¡¨ç¤ºï¼Œä¾‹å¦‚'Landroid/content/Context;'è¡¨ç¤ºandroid.content.Contextç±»ã€‚ â€‹ 3.å¯å˜å‚æ•°ï¼šå¯å˜å‚æ•°åœ¨Javaä¸­ä½¿ç”¨â€œ...â€ç¬¦å·è¡¨ç¤ºï¼Œè€Œåœ¨ArgArrayä¸­ï¼Œåˆ™éœ€è¦å°†æ‰€æœ‰å¯å˜å‚æ•°æ‰“åŒ…ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå¹¶ä½¿ç”¨â€˜[â€™å’Œâ€˜]â€™ç¬¦å·è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œå¦‚æœJavaæ–¹æ³•å£°æ˜ä¸ºâ€œpublic void foo(int a, String... args)â€ï¼Œåˆ™åœ¨ArgArrayä¸­ï¼Œå‚æ•°åˆ—è¡¨çš„çŸ­ç±»å‹æè¿°ç¬¦ä¸ºâ€œILjava/lang/String;[â€ã€‚ â€‹ ç†è§£äº†C++å¦‚ä½•å­˜æ”¾å‚æ•°æ•°æ®åï¼Œç»§ç»­çœ‹ä¸‹ä¸€å±‚çš„å‡½æ•°è°ƒç”¨ã€‚ 123456789101112void InvokeWithArgArray(const ScopedObjectAccessAlreadyRunnable&amp; soa, ArtMethod* method, ArgArray* arg_array, JValue* result, const char* shorty) REQUIRES_SHARED(Locks::mutator_lock_) { // è·å–javaå‚æ•°çš„æ•°ç»„æŒ‡é’ˆ uint32_t* args = arg_array-&gt;GetArray(); if (UNLIKELY(soa.Env()-&gt;IsCheckJniEnabled())) { CheckMethodArguments(soa.Vm(), method-&gt;GetInterfaceMethodIfProxy(kRuntimePointerSize), args); } method-&gt;Invoke(soa.Self(), args, arg_array-&gt;GetNumBytes(), result, shorty);} è°ƒç”¨åˆ°äº†ArtMethodçš„Invokeå‡½æ•°ï¼Œè¿™é‡Œå°†å‚æ•°çš„æ•°ç»„æŒ‡é’ˆï¼Œå‚æ•°æ•°ç»„å¤§å°ï¼Œè¿”å›å€¼æŒ‡é’ˆï¼Œè°ƒç”¨å‡½æ•°çš„æè¿°ç¬¦å·ä¼ é€’äº†è¿‡å»ã€‚åœ¨å¼€å§‹è¿›å…¥å…³é”®å‡½æ•°å‰ï¼Œå…ˆå¯¹è¿”å›å€¼æŒ‡é’ˆJValue* resultè¿›è¡Œç®€å•ä»‹ç»ã€‚ JValueæ˜¯ç”¨äºå­˜å‚¨å’Œä¼ é€’Javaæ–¹æ³•è¿”å›å€¼çš„è”åˆä½“ã€‚åŒ…å«äº†å„ç§åŸºæœ¬ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„æˆå‘˜å˜é‡ã€‚ä¸‹é¢æ˜¯è¯¥è”åˆä½“çš„å®šä¹‰ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960union PACKED(alignof(mirror::Object*)) JValue { // We default initialize JValue instances to all-zeros. JValue() : j(0) {} template&lt;typename T&gt; ALWAYS_INLINE static JValue FromPrimitive(T v); int8_t GetB() const { return b; } void SetB(int8_t new_b) { j = ((static_cast&lt;int64_t&gt;(new_b) &lt;&lt; 56) &gt;&gt; 56); // Sign-extend to 64 bits. } uint16_t GetC() const { return c; } void SetC(uint16_t new_c) { j = static_cast&lt;int64_t&gt;(new_c); // Zero-extend to 64 bits. } double GetD() const { return d; } void SetD(double new_d) { d = new_d; } float GetF() const { return f; } void SetF(float new_f) { f = new_f; } int32_t GetI() const { return i; } void SetI(int32_t new_i) { j = ((static_cast&lt;int64_t&gt;(new_i) &lt;&lt; 32) &gt;&gt; 32); // Sign-extend to 64 bits. } int64_t GetJ() const { return j; } void SetJ(int64_t new_j) { j = new_j; } mirror::Object* GetL() const REQUIRES_SHARED(Locks::mutator_lock_) { return l; } ALWAYS_INLINE void SetL(ObjPtr&lt;mirror::Object&gt; new_l) REQUIRES_SHARED(Locks::mutator_lock_); int16_t GetS() const { return s; } void SetS(int16_t new_s) { j = ((static_cast&lt;int64_t&gt;(new_s) &lt;&lt; 48) &gt;&gt; 48); // Sign-extend to 64 bits. } uint8_t GetZ() const { return z; } void SetZ(uint8_t new_z) { j = static_cast&lt;int64_t&gt;(new_z); // Zero-extend to 64 bits. } mirror::Object** GetGCRoot() { return &amp;l; } private: uint8_t z; int8_t b; uint16_t c; int16_t s; int32_t i; int64_t j; float f; double d; mirror::Object* l;}; JValueç»“æ„ä½“çš„å¤§å°ä¸º8ä¸ªå­—èŠ‚å¯¹é½ï¼Œç»“æ„ä½“æä¾›äº†ä¸€äº›æˆå‘˜å‡½æ•°ï¼Œä¾‹å¦‚GetXXXå’ŒSetXXXç­‰å‡½æ•°ï¼Œç”¨äºè·å–å’Œè®¾ç½®ä¸åŒç±»å‹çš„è¿”å›å€¼ã€‚alignof(mirror::Object*)çš„å…·ä½“å€¼å–å†³äºç¼–è¯‘å™¨å’Œæ“ä½œç³»ç»Ÿçš„ä¸åŒï¼Œä¸€èˆ¬ä¸º4æˆ–8ã€‚ å¯¹å‚æ•°ä»¥åŠè¿”å›å€¼çš„åœ¨C++ä¸­çš„è¡¨ç¤ºæœ‰äº†åˆæ­¥çš„äº†è§£åï¼Œå¼€å§‹ç»§ç»­æŸ¥çœ‹å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­çš„å…³é”®å‡½æ•°ArtMethod::Invokeï¼Œä¸‹é¢æ˜¯å…·ä½“å®ç°ä»£ç ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152void ArtMethod::Invoke(Thread* self, uint32_t* args, uint32_t args_size, JValue* result, const char* shorty) { ... // å°†å½“å‰çš„ç¯å¢ƒï¼ˆä¹Ÿå°±æ˜¯å‡½æ•°è°ƒç”¨æ—¶çš„ç¨‹åºè®¡æ•°å™¨ã€å †æ ˆæŒ‡é’ˆç­‰ä¿¡æ¯ï¼‰ä¿å­˜åˆ°ä¸€ä¸ªæ ˆå¸§ä¸­ã€‚è¿™ä¸ªæ ˆå¸§é€šå¸¸ä¼šè¢«åˆ†é…åœ¨å †ä¸Šï¼Œå¹¶ä¸”ç”±åƒåœ¾å›æ”¶å™¨æ¥ç®¡ç†ã€‚åœ¨å‡½æ•°è¿”å›æ—¶ï¼Œè¿™ä¸ªæ ˆå¸§ä¼šè¢«å¼¹å‡ºï¼Œæ¢å¤ä¹‹å‰çš„ç¯å¢ƒã€‚ ManagedStack fragment; self-&gt;PushManagedStackFragment(&amp;fragment); Runtime* runtime = Runtime::Current(); // IsForceInterpreterä¸ºtrueè¡¨ç¤ºå¼ºåˆ¶ä½¿ç”¨è§£é‡Šå™¨æ‰§è¡Œå‡½æ•° // è¿™é‡Œçš„æ¡ä»¶æ˜¯ï¼Œå¦‚æœè®¾ç½®äº†å¼ºåˆ¶èµ°è§£é‡Šå™¨æ‰§è¡Œï¼Œå¹¶ä¸”énativeå‡½æ•°ï¼Œå¹¶ä¸”éä»£ç†å‡½æ•°ï¼Œå¹¶ä¸”å¯æ‰§è¡Œçš„å‡½æ•°ï¼Œåˆ™ç¬¦åˆæ¡ä»¶ if (UNLIKELY(!runtime-&gt;IsStarted() || (self-&gt;IsForceInterpreter() &amp;&amp; !IsNative() &amp;&amp; !IsProxyMethod() &amp;&amp; IsInvokable()))) { if (IsStatic()) { // é™æ€å‡½æ•°è°ƒç”¨ art::interpreter::EnterInterpreterFromInvoke( self, this, nullptr, args, result, /*stay_in_interpreter=*/ true); } else { // éé™æ€å‡½æ•°è°ƒç”¨ mirror::Object* receiver = reinterpret_cast&lt;StackReference&lt;mirror::Object&gt;*&gt;(&amp;args[0])-&gt;AsMirrorPtr(); art::interpreter::EnterInterpreterFromInvoke( self, this, receiver, args + 1, result, /*stay_in_interpreter=*/ true); } } else { ... // æ˜¯å¦æœ‰å·²ç¼–è¯‘çš„å¿«é€Ÿæ‰§è¡Œä»£ç çš„å…¥å£ç‚¹ bool have_quick_code = GetEntryPointFromQuickCompiledCode() != nullptr; if (LIKELY(have_quick_code)) { ... // èµ°å¿«é€Ÿè°ƒç”¨æ–¹å¼ï¼Œæ¯”è§£é‡Šå™¨æ‰§è¡Œçš„æ€§èƒ½é«˜ã€‚ if (!IsStatic()) { (*art_quick_invoke_stub)(this, args, args_size, self, result, shorty); } else { (*art_quick_invoke_static_stub)(this, args, args_size, self, result, shorty); } ... } else { LOG(INFO) &lt;&lt; &quot;Not invoking '&quot; &lt;&lt; PrettyMethod() &lt;&lt; &quot;' code=null&quot;; if (result != nullptr) { result-&gt;SetJ(0); } } } // ä»æ ˆå¸§ä¸­è¿˜åŸå½“å‰ç¯å¢ƒ self-&gt;PopManagedStackFragment(fragment);} æ ¹æ®ä»¥ä¸Šä»£ç å¾—åˆ°çš„ç»“è®ºæ˜¯ï¼Œå‡½æ•°æ‰§è¡Œçš„è·¯çº¿æœ‰ä¸¤æ¡ï¼ŒEnterInterpreterFromInvokeç”±è§£é‡Šå™¨æ‰§è¡Œå’Œart_quick_invoke_stubå¿«é€Ÿæ‰§è¡Œé€šé“ã€‚ art_quick_invoke_stubæ˜¯ç”±ä¸€æ®µæ±‡ç¼–å®Œæˆå¯¹å‡½æ•°çš„æ‰§è¡Œï¼Œè¯¥å‡½æ•°å……åˆ†åˆ©ç”¨å¯„å­˜å™¨å¹¶å°½å¯èƒ½åœ°å‡å°‘å †æ ˆè®¿é—®æ¬¡æ•°ï¼Œä»¥æé«˜Javaæ–¹æ³•çš„æ‰§è¡Œæ•ˆç‡ã€‚è™½ç„¶å¿«é€Ÿæ‰§è¡Œé€šé“çš„æ•ˆç‡ä¼šæ›´åŠ é«˜ï¼Œä½†æ˜¯å¯è¯»æ€§å·®ï¼Œä½†æ˜¯å¯¹äºå­¦ä¹ æ‰§è¡Œè¿‡ç¨‹å’Œä¿®æ”¹æ‰§è¡Œæµç¨‹æ¥è¯´ï¼Œè§£é‡Šå™¨æ‰§è¡Œä¼šæ›´åŠ ç®€å•æ˜“æ”¹ã€‚æ‰€ä»¥æ¥ä¸‹æ¥è·Ÿè¿›è§£é‡Šå™¨æ‰§è¡Œï¼Œäº†è§£æ‰§è¡Œçš„ç»†èŠ‚ã€‚ç»§ç»­è·Ÿè¸ªEnterInterpreterFromInvokeå‡½æ•°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111void EnterInterpreterFromInvoke(Thread* self, ArtMethod* method, ObjPtr&lt;mirror::Object&gt; receiver, uint32_t* args, JValue* result, bool stay_in_interpreter) { ... // è·å–å‡½æ•°ä¸­çš„æŒ‡ä»¤ä¿¡æ¯ CodeItemDataAccessor accessor(method-&gt;DexInstructionData()); uint16_t num_regs; uint16_t num_ins; if (accessor.HasCodeItem()) { // è·å–å¯„å­˜å™¨çš„æ•°é‡å’Œå‚æ•°çš„æ•°é‡ num_regs = accessor.RegistersSize(); num_ins = accessor.InsSize(); } else if (!method-&gt;IsInvokable()) { self-&gt;EndAssertNoThreadSuspension(old_cause); method-&gt;ThrowInvocationTimeError(); return; } else { DCHECK(method-&gt;IsNative()) &lt;&lt; method-&gt;PrettyMethod(); // ä»å‡½æ•°æè¿°ç¬¦ä¸­è®¡ç®—å‡ºå¯„å­˜å™¨æ•°é‡å’Œå‚æ•°æ•°é‡ // è¿™é‡Œå°†num_regså’Œnum_inséƒ½èµ‹å€¼çš„åŸå› æ˜¯ï¼Œæ–¹æ³•çš„å‰å‡ ä¸ªå‚æ•°é€šå¸¸ä¼šå­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­ï¼Œè€Œä¸æ˜¯å †æ ˆä¸­ã€‚å› æ­¤ï¼Œnum_regså’Œnum_insçš„å€¼åº”è¯¥æ˜¯ç›¸åŒçš„ï¼Œéƒ½ä»£è¡¨äº†å½“å‰æ–¹æ³•ä½¿ç”¨çš„å¯„å­˜å™¨æ•°é‡ï¼Œä¹Ÿå°±æ˜¯ç”¨äºå­˜å‚¨å‚æ•°å’Œå±€éƒ¨å˜é‡ç­‰æ•°æ®çš„å¯„å­˜å™¨æ•°é‡ã€‚ num_regs = num_ins = ArtMethod::NumArgRegisters(method-&gt;GetShorty()); // éé™æ€å‡½æ•°çš„æƒ…å†µï¼Œä¼šå¤šä¸€ä¸ªthiså‚æ•°ï¼Œæ‰€ä»¥å¯„å­˜å™¨æ•°é‡å’Œå‚æ•°æ•°é‡+1 if (!method-&gt;IsStatic()) { num_regs++; num_ins++; } } // åˆ›å»ºä¸€ä¸ªæ–°çš„ShadowFrameä½œä¸ºå½“å‰æ ˆï¼Œå°†å½“å‰ç¯å¢ƒä¿å­˜åœ¨å…¶ä¸­ï¼Œå¹¶ä¸”æ¨å…¥æ ˆå¸§ï¼Œä¾›å½“å‰çº¿ç¨‹è°ƒç”¨æ–¹æ³•æ—¶ä½¿ç”¨ ShadowFrame* last_shadow_frame = self-&gt;GetManagedStack()-&gt;GetTopShadowFrame(); ShadowFrameAllocaUniquePtr shadow_frame_unique_ptr = CREATE_SHADOW_FRAME(num_regs, last_shadow_frame, method, /* dex pc */ 0); ShadowFrame* shadow_frame = shadow_frame_unique_ptr.get(); self-&gt;PushShadowFrame(shadow_frame); // è®¡ç®—å‡ºå°†è¦ä½¿ç”¨çš„ç¬¬ä¸€ä¸ªå¯„å­˜å™¨ size_t cur_reg = num_regs - num_ins; // éé™æ€å‡½æ•°çš„æƒ…å†µï¼Œç¬¬ä¸€ä¸ªå¯„å­˜å™¨çš„å€¼ä¸ºthisï¼Œæ‰€ä»¥è®¾ç½®å…¶ä¸ºå¼•ç”¨ç±»å‹ if (!method-&gt;IsStatic()) { // receiverå˜é‡è¡¨ç¤ºæ–¹æ³•è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•° CHECK(receiver != nullptr); shadow_frame-&gt;SetVRegReference(cur_reg, receiver); ++cur_reg; } uint32_t shorty_len = 0; const char* shorty = method-&gt;GetShorty(&amp;shorty_len); // éå†æ‰€æœ‰å‚æ•° for (size_t shorty_pos = 0, arg_pos = 0; cur_reg &lt; num_regs; ++shorty_pos, ++arg_pos, cur_reg++) { DCHECK_LT(shorty_pos + 1, shorty_len); switch (shorty[shorty_pos + 1]) { //L è¡¨ç¤ºè¿™ä¸ªå‚æ•°æ˜¯ä¸ªå¼•ç”¨ç±»å‹ï¼Œæ¯”å¦‚Ljava/lang/String; case 'L': { ObjPtr&lt;mirror::Object&gt; o = reinterpret_cast&lt;StackReference&lt;mirror::Object&gt;*&gt;(&amp;args[arg_pos])-&gt;AsMirrorPtr(); // å°†è½¬æ¢å¥½çš„æ•°æ®è®¾ç½®åˆ°å½“å‰æ ˆä¸­ shadow_frame-&gt;SetVRegReference(cur_reg, o); break; } case 'J': case 'D': { // Jæˆ–è€…Dçš„æ•°æ®ç±»å‹è¦å ç”¨ä¸¤ä¸ªå¯„å­˜å™¨å­˜æ”¾ã€‚ uint64_t wide_value = (static_cast&lt;uint64_t&gt;(args[arg_pos + 1]) &lt;&lt; 32) | args[arg_pos]; // åˆå¹¶åçš„æ•°æ®è®¾ç½®åˆ°æ ˆä¸­ shadow_frame-&gt;SetVRegLong(cur_reg, wide_value); cur_reg++; arg_pos++; break; } default: // æ™®é€šçš„æ•´å‹æ•°æ®è®¾ç½®åˆ°æ ˆä¸­ shadow_frame-&gt;SetVReg(cur_reg, args[arg_pos]); break; } } self-&gt;EndAssertNoThreadSuspension(old_cause); // é™æ€å‡½æ•°çš„æƒ…å†µéœ€è¦æ£€æŸ¥æ‰€åœ¨çš„ç±»æ˜¯å¦å·²ç»æ­£å¸¸åˆå§‹åŒ–ã€‚ if (method-&gt;IsStatic()) { ObjPtr&lt;mirror::Class&gt; declaring_class = method-&gt;GetDeclaringClass(); if (UNLIKELY(!declaring_class-&gt;IsVisiblyInitialized())) { StackHandleScope&lt;1&gt; hs(self); Handle&lt;mirror::Class&gt; h_class(hs.NewHandle(declaring_class)); if (UNLIKELY(!Runtime::Current()-&gt;GetClassLinker()-&gt;EnsureInitialized( self, h_class, /*can_init_fields=*/ true, /*can_init_parents=*/ true))) { CHECK(self-&gt;IsExceptionPending()); self-&gt;PopShadowFrame(); return; } DCHECK(h_class-&gt;IsInitializing()); } } // énativeå‡½æ•°æ‰§è¡Œ if (LIKELY(!method-&gt;IsNative())) { // è§£é‡Šæ‰§è¡Œçš„å…³é”®å‡½æ•° JValue r = Execute(self, accessor, *shadow_frame, JValue(), stay_in_interpreter); if (result != nullptr) { *result = r; } } else { // nativeå‡½æ•°çš„è§£é‡Šæ‰§è¡Œ args = shadow_frame-&gt;GetVRegArgs(method-&gt;IsStatic() ? 0 : 1); if (!Runtime::Current()-&gt;IsStarted()) { UnstartedRuntime::Jni(self, method, receiver.Ptr(), args, result); } else { InterpreterJni(self, method, shorty, receiver, args, result); } } // å¼¹å‡ºæ ˆå¸§ï¼Œè¿˜åŸåˆ°æ‰§è¡Œåçš„æ ˆç¯å¢ƒ self-&gt;PopShadowFrame();} â€‹ åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¸ºå³å°†æ‰§è¡Œçš„å‡½æ•°å‡†å¤‡å¥½äº†æ ˆå¸§ç¯å¢ƒï¼Œå°†å‚æ•°å¡«å…¥äº†shadow_frameæ ˆå¸§ä¸­ã€‚å¹¶ä¸”è·å–å‡ºäº†å‡½æ•°è¦æ‰§è¡Œçš„æŒ‡ä»¤ä¿¡æ¯accessorã€‚æœ€åé€šè¿‡Executeæ‰§è¡Œè¯¥å‡½æ•°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091static inline JValue Execute( Thread* self, const CodeItemDataAccessor&amp; accessor, ShadowFrame&amp; shadow_frame, JValue result_register, bool stay_in_interpreter = false, bool from_deoptimize = false) REQUIRES_SHARED(Locks::mutator_lock_) { ... // æ˜¯å¦éœ€è¦ä»è§£é‡Šå™¨æ¨¡å¼åˆ‡æ¢åˆ°ç¼–è¯‘æ¨¡å¼ã€‚ if (LIKELY(!from_deoptimize)) { ... instrumentation::Instrumentation* instrumentation = Runtime::Current()-&gt;GetInstrumentation(); // ä»å½“å‰çº¿ç¨‹æ ˆå¸§ä¸­è·å–è¦æ‰§è¡Œçš„å‡½æ•° ArtMethod *method = shadow_frame.GetMethod(); // æ˜¯å¦æœ‰æ³¨å†ŒMethod Entry ç›‘å¬å™¨ if (UNLIKELY(instrumentation-&gt;HasMethodEntryListeners())) { // è§¦å‘ Method Entry ç›‘å¬å™¨ï¼Œå¹¶ä¼ é€’ç›¸åº”çš„å‚æ•° instrumentation-&gt;MethodEnterEvent(self, shadow_frame.GetThisObject(accessor.InsSize()), method, 0); ... // æ˜¯å¦æœ‰æœªå¤„ç†çš„å¼‚å¸¸ if (UNLIKELY(self-&gt;IsExceptionPending())) { ... return ret; } } // stay_in_interpreter è¡¨ç¤ºæ˜¯å¦éœ€è¦åœç•™åœ¨è§£é‡Šå™¨æ¨¡å¼ï¼Œself-&gt;IsForceInterpreter() è¡¨ç¤ºæ˜¯å¦å¼ºåˆ¶ä½¿ç”¨è§£é‡Šå™¨æ¨¡å¼ã€‚æ‰€ä»¥å†…éƒ¨æ˜¯ä¸èµ°è§£é‡Šå™¨æ‰§è¡Œçš„å¤„ç†ï¼Œèµ°ç¼–è¯‘æ¨¡å¼æ‰§è¡Œ if (!stay_in_interpreter &amp;&amp; !self-&gt;IsForceInterpreter()) { jit::Jit* jit = Runtime::Current()-&gt;GetJit(); if (jit != nullptr) { // åˆ¤æ–­å½“å‰æ–¹æ³•æ˜¯å¦å¯ä»¥ä½¿ç”¨ JIT ç¼–è¯‘åçš„æœºå™¨ç æ‰§è¡Œ jit-&gt;MethodEntered(self, shadow_frame.GetMethod()); if (jit-&gt;CanInvokeCompiledCode(method)) { JValue result; // ç›´æ¥æ ˆå¸§æ¨å‡º self-&gt;PopShadowFrame(); uint16_t arg_offset = accessor.RegistersSize() - accessor.InsSize(); // è°ƒç”¨è¯¥å‡½æ•°çš„æœºå™¨ç å®ç° ArtInterpreterToCompiledCodeBridge(self, nullptr, &amp;shadow_frame, arg_offset, &amp;result); // é‡æ–°æ¨å…¥æ ˆå¸§ self-&gt;PushShadowFrame(&amp;shadow_frame); return result; } } } } // ä»æ ˆå¸§ä¸­è·å–è¦æ‰§è¡Œçš„å½“å‰å‡½æ•° ArtMethod* method = shadow_frame.GetMethod(); ... // kSwitchImplKindï¼šè¡¨ç¤ºå½“å‰å®ç°æ˜¯å¦ä½¿ç”¨åŸºäº switch è¯­å¥çš„è§£é‡Šå™¨å®ç°ã€‚ if (kInterpreterImplKind == kSwitchImplKind || UNLIKELY(!Runtime::Current()-&gt;IsStarted()) || !method-&gt;IsCompilable() || method-&gt;MustCountLocks() || Runtime::Current()-&gt;IsActiveTransaction()) { // ä½¿ç”¨switchè§£é‡Šå™¨æ‰§è¡Œ return ExecuteSwitch( self, accessor, shadow_frame, result_register, /*interpret_one_instruction=*/ false); } CHECK_EQ(kInterpreterImplKind, kMterpImplKind); // ç¼–è¯‘æ‰§è¡Œå‡½æ•° while (true) { // æ˜¯å¦æ”¯æŒMterpè§£é‡Šå™¨æ‰§è¡Œ if (!self-&gt;UseMterp()) { return ExecuteSwitch( self, accessor, shadow_frame, result_register, /*interpret_one_instruction=*/ false); } // æ‰§è¡Œç›®æ ‡å‡½æ•° bool returned = ExecuteMterpImpl(self, accessor.Insns(), &amp;shadow_frame, &amp;result_register); if (returned) { return result_register; } else { // å¤±è´¥çš„æƒ…å†µç»§ç»­é‡‡ç”¨switchè§£é‡Šå™¨æ‰§è¡Œ result_register = ExecuteSwitch( self, accessor, shadow_frame, result_register, /*interpret_one_instruction=*/ true); if (shadow_frame.GetDexPC() == dex::kDexNoIndex) { return result_register; } } }} çœ‹å®Œè¯¥å‡½æ•°åï¼Œåœ¨ç»§ç»­æ·±å…¥å‰ï¼Œå…ˆå°†å…¶ä¸­çš„å‡ ä¸ªçŸ¥è¯†ç‚¹è¿›è¡Œä»‹ç»ã€‚ ç¼–è¯‘æ¨¡å¼ï¼ˆCompiled Modeï¼‰æ˜¯ä¸€ç§æ‰§è¡Œæ–¹å¼ï¼Œå®ƒå°†åº”ç”¨ç¨‹åºä»£ç ç¼–è¯‘æˆæœºå™¨ç åå†æ‰§è¡Œã€‚ç›¸è¾ƒäºè§£é‡Šå™¨æ¨¡å¼ï¼Œç¼–è¯‘æ¨¡å¼å…·æœ‰æ›´é«˜çš„æ‰§è¡Œæ•ˆç‡å’Œæ›´å¥½çš„æ€§èƒ½è¡¨ç°ã€‚ åœ¨Androidåº”ç”¨ç¨‹åºä¸­ï¼Œç¼–è¯‘æ¨¡å¼é‡‡ç”¨çš„æ˜¯ Just-In-Timeï¼ˆJITï¼‰ç¼–è¯‘æŠ€æœ¯ã€‚å½“ä¸€ä¸ªæ–¹æ³•è¢«å¤šæ¬¡è°ƒç”¨æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å…¶ç¼–è¯‘æˆæœ¬åœ°æœºå™¨ç ï¼Œå¹¶ç¼“å­˜èµ·æ¥ä»¥å¤‡ä¸‹æ¬¡ä½¿ç”¨ã€‚ å½“ä¸€ä¸ªæ–¹æ³•è¢«ç¼–è¯‘æˆæœ¬åœ°æœºå™¨ç åï¼Œå…¶æ‰§è¡Œé€Ÿåº¦å°†æ˜¾è‘—æé«˜ã€‚å› ä¸ºä¸è§£é‡Šå™¨æ¨¡å¼ç›¸æ¯”ï¼Œç¼–è¯‘æ¨¡å¼ä¸éœ€è¦é€æ¡è§£é‡Šä»£ç ï¼Œè€Œæ˜¯ç›´æ¥æ‰§è¡Œç¼–è¯‘å¥½çš„æœºå™¨ç ã€‚ ç”±äºç¼–è¯‘è¿‡ç¨‹éœ€è¦ä¸€å®šçš„æ—¶é—´ï¼Œå› æ­¤åœ¨ç¨‹åºå¯åŠ¨æˆ–è€…ç¬¬ä¸€æ¬¡è¿è¡Œæ–°æ–¹æ³•æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€äº›é¢å¤–çš„å»¶è¿Ÿã€‚æ‰€ä»¥ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œç³»ç»Ÿé€šå¸¸ä¼šé‡‡ç”¨ä¸€äº›ç­–ç•¥ï¼Œå¦‚é¢„çƒ­æœºåˆ¶ç­‰ï¼Œæ¥ä¼˜åŒ–ç¼–è¯‘æ¨¡å¼çš„æ€§èƒ½è¡¨ç°ã€‚ç¼–è¯‘æ¨¡å¼æ˜¯ä¸€ç§æ€§èƒ½æ›´é«˜ã€æ•ˆç‡æ›´å¥½çš„æ‰§è¡Œæ–¹å¼ï¼Œå¯ä»¥å¸®åŠ©åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶è·å¾—æ›´å¥½çš„å“åº”é€Ÿåº¦å’Œç”¨æˆ·ä½“éªŒã€‚ Method Entry ç›‘å¬å™¨æ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ç§ç›‘å¬å™¨ï¼Œå®ƒå¯ä»¥ç”¨æ¥ç›‘å¬åº”ç”¨ç¨‹åºçš„æ–¹æ³•å…¥å£ã€‚å½“ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œç³»ç»Ÿä¼šè§¦å‘Method Entryç›‘å¬å™¨ï¼Œå¹¶å°†å½“å‰çº¿ç¨‹ã€å½“å‰æ–¹æ³•å’Œè°ƒç”¨æ ˆä¿¡æ¯ç­‰ç›¸å…³æ•°æ®ä¼ é€’ç»™ç›‘å¬å™¨ã€‚ Android Studioåœ¨è°ƒè¯•æ¨¡å¼ä¸‹ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªçº¿ç¨‹å¯åŠ¨ä¸€ä¸ªç›‘å¬å™¨ï¼Œå¹¶åœ¨æ–¹æ³•è¿›å…¥å’Œé€€å‡ºæ—¶è§¦å‘ç›¸åº”çš„äº‹ä»¶ã€‚è¿™äº›äº‹ä»¶åŒ…æ‹¬ Method Entryï¼ˆæ–¹æ³•å…¥å£ï¼‰ã€Method Exitï¼ˆæ–¹æ³•å‡ºå£ï¼‰ç­‰ã€‚ â€‹ ä¸‹é¢å°†åˆ†åˆ«ä»‹ç»ExecuteMterpImplå’ŒExecuteSwitchæ˜¯å¦‚ä½•å®ç°æŒ‡ä»¤æµçš„æ‰§è¡Œã€‚ 7.4 ExecuteMterpImplExecuteMterpImplæ˜¯åŸºäºMterpï¼ˆMethod Interpreterï¼‰æŠ€æœ¯å®ç°ã€‚MterpæŠ€æœ¯ä½¿ç”¨æŒ‡ä»¤é›†è§£é‡Šå™¨æ¥æ‰§è¡Œåº”ç”¨ç¨‹åºçš„ä»£ç ï¼Œç›¸æ¯”äºJITç¼–è¯‘æ¨¡å¼å¯ä»¥æ›´å¿«åœ°å¯åŠ¨å’Œæ‰§è¡ŒçŸ­å°ç²¾æ‚çš„æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é¿å…JITç¼–è¯‘å¸¦æ¥çš„é¢å¤–å¼€é”€ã€‚ åœ¨Mterpæ¨¡å¼ä¸‹ï¼ŒDex æŒ‡ä»¤é›†è¢«è½¬åŒ–æˆäº†ä¸€ç»„C++çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯¹åº”DexæŒ‡ä»¤é›†ä¸­çš„æ¯ä¸€æ¡æŒ‡ä»¤ã€‚ExecuteMterpImplå®é™…ä¸Šå°±æ˜¯è°ƒç”¨è¿™äº›å‡½æ•°æ¥é€æ¡è§£é‡Šæ‰§è¡Œå½“å‰æ–¹æ³•çš„æŒ‡ä»¤é›†ã€‚ â€‹ åœ¨Android 4.4ä¸­ï¼Œç³»ç»Ÿé¦–æ¬¡å¼•å…¥äº† Mterp æŠ€æœ¯æ¥åŠ é€Ÿåº”ç”¨ç¨‹åºçš„è§£é‡Šæ‰§è¡Œã€‚åœ¨æ­¤ä¹‹åçš„ Androidç‰ˆæœ¬ä¸­ï¼ŒMterp æŠ€æœ¯å¾—åˆ°äº†ä¸æ–­ä¼˜åŒ–å’Œå®Œå–„ï¼Œå¹¶é€æ¸æˆä¸ºAndroidå¹³å°çš„ä¸»è¦æ–¹æ³•æ‰§è¡Œæ–¹å¼ä¹‹ä¸€ã€‚ â€‹ ä»Android 6.0å¼€å§‹ï¼ŒDalvik è¿è¡Œæ—¶ç¯å¢ƒè¢«å¼ƒç”¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ARTè¿è¡Œæ—¶ç¯å¢ƒã€‚ART è¿è¡Œæ—¶ç¯å¢ƒå¯ä»¥é€šè¿‡JITç¼–è¯‘ã€AOT ç¼–è¯‘å’ŒMterpç­‰å¤šç§æ–¹å¼æ¥æ‰§è¡Œåº”ç”¨ç¨‹åºçš„ä»£ç ï¼Œå…¶ä¸­MterpæŠ€æœ¯è¢«å¹¿æ³›ä½¿ç”¨äº Android åº”ç”¨ç¨‹åºçš„è§£é‡Šæ‰§è¡Œè¿‡ç¨‹ä¸­ã€‚ä½†æ˜¯å¯¹äºæŸäº›ç‰¹å®šçš„åœºæ™¯å’Œåº”ç”¨ç¨‹åºï¼Œç³»ç»Ÿå¯èƒ½è¿˜æ˜¯ä¼šé€‰æ‹©å…¶ä»–çš„æ‰§è¡Œæ–¹å¼æ¥è·å¾—æ›´å¥½çš„æ€§èƒ½å’Œæ•ˆç‡ã€‚ â€‹ ExecuteMterpImplä½¿ç”¨äº†æ±‡ç¼–è¯­è¨€å’Œ C++è¯­è¨€æ··åˆç¼–å†™ï¼Œéœ€è¦æœ‰ä¸€å®šçš„æ±‡ç¼–å’ŒC++ç¼–ç¨‹ç»éªŒæ‰èƒ½ç†è§£å…¶å«ä¹‰å’ŒåŠŸèƒ½ã€‚è¯¥ä»£ç ä¸»è¦å®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š â€‹ 1.ä¿å­˜å½“å‰æ–¹æ³•çš„è¿”å›å€¼å¯„å­˜å™¨å’ŒæŒ‡ä»¤é›† â€‹ 2.è®¾ç½®æ–¹æ³•æ‰§è¡Œçš„ç¯å¢ƒå’Œå‚æ•°ï¼ŒåŒ…æ‹¬vregsæ•°ç»„ã€dex_pc å¯„å­˜å™¨ç­‰ â€‹ 3.ä¸ºå½“å‰æ–¹æ³•è®¾ç½®çƒ­åº¦å€’è®¡æ—¶ï¼Œå¹¶æ ¹æ®çƒ­åº¦å€¼æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å¯ç”¨MterpæŠ€æœ¯ â€‹ 4.æ‰§è¡Œå½“å‰æ–¹æ³•çš„æŒ‡ä»¤é›†ï¼Œé€æ¡è§£é‡Šæ‰§è¡Œ Dex æŒ‡ä»¤ â€‹ ä¸‹é¢çœ‹ExecuteMterpImplå®ç°ä»£ç ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061// ä»xPCå¯„å­˜å™¨ä¸­è·å–ä¸€æ¡æŒ‡ä»¤.macro FETCH_INST ldrh wINST, [xPC].endm// ä»æŒ‡ä»¤ä¸­è·å–æ“ä½œç ï¼ŒæŒ‡ä»¤æœ€é¡¶éƒ¨2ä¸ªå­—èŠ‚å°±æ˜¯æ“ä½œç ï¼Œæ‰€ä»¥è¿™é‡Œæ‹¿æ“ä½œç æ˜¯ &amp; 0xffçš„æ„æ€.macro GET_INST_OPCODE reg and \\reg, xINST, #255.endm// è·³è½¬åˆ°æ“ä½œç å¤„ç†é€»è¾‘.macro GOTO_OPCODE reg add \\reg, xIBASE, \\reg, lsl #${handler_size_bits} br \\reg.endmENTRY ExecuteMterpImpl .cfi_startproc // ä¿å­˜å¯„å­˜å™¨ä¿¡æ¯ SAVE_TWO_REGS_INCREASE_FRAME xPROFILE, x27, 80 SAVE_TWO_REGS xIBASE, xREFS, 16 SAVE_TWO_REGS xSELF, xINST, 32 SAVE_TWO_REGS xPC, xFP, 48 SAVE_TWO_REGS fp, lr, 64 // fpå¯„å­˜å™¨æŒ‡å‘æ ˆé¡¶ add fp, sp, #64 /* è®°å½•å¯¹åº”è¿”å›å€¼çš„å¯„å­˜å™¨ */ str x3, [x2, #SHADOWFRAME_RESULT_REGISTER_OFFSET] /* è®°å½•dexæ–‡ä»¶ä¸­çš„æŒ‡ä»¤çš„æŒ‡é’ˆ */ str x1, [x2, #SHADOWFRAME_DEX_INSTRUCTIONS_OFFSET] mov xSELF, x0 ldr w0, [x2, #SHADOWFRAME_NUMBER_OF_VREGS_OFFSET] add xFP, x2, #SHADOWFRAME_VREGS_OFFSET // è®¡ç®—å±€éƒ¨å˜é‡è¡¨çš„åç§»åœ°å€ add xREFS, xFP, w0, uxtw #2 // è®¡ç®—å±€éƒ¨å˜é‡å¼•ç”¨è¡¨çš„åç§»åœ°å€ ldr w0, [x2, #SHADOWFRAME_DEX_PC_OFFSET] // è·å–å½“å‰Dexä¸­çš„PC add xPC, x1, w0, uxtw #1 // å°†Dex PCè½¬æ¢ä¸ºåœ°å€ï¼Œå¹¶ä¿å­˜åˆ°å¯„å­˜å™¨xPCä¸­ CFI_DEFINE_DEX_PC_WITH_OFFSET(CFI_TMP, CFI_DEX, 0) EXPORT_PC // å°†Dex PCå¯¼å‡º /* Starting ibase */ ldr xIBASE, [xSELF, #THREAD_CURRENT_IBASE_OFFSET] /* Set up for backwards branches &amp; osr profiling */ ldr x0, [xFP, #OFF_FP_METHOD] // è·å–å½“å‰æ–¹æ³•çš„æ–¹æ³•æŒ‡é’ˆ add x1, xFP, #OFF_FP_SHADOWFRAME // è®¡ç®—æ‹¿åˆ°å½“å‰çº¿ç¨‹çš„æ ˆå¸§ mov x2, xSELF // å°†å½“å‰çº¿ç¨‹å¯¹è±¡ä¿å­˜åˆ°å¯„å­˜å™¨x2ä¸­ bl MterpSetUpHotnessCountdown // çƒ­åº¦è®¡æ•°å™¨è°ƒæ•´ mov wPROFILE, w0 // å°†çƒ­åº¦è®¡æ•°å™¨çš„å®½åº¦èµ‹å€¼ç»™å¯„å­˜å™¨wPROFILE /* start executing the instruction at rPC */ FETCH_INST // è·å–ä¸‹ä¸€æ¡æŒ‡ä»¤ GET_INST_OPCODE ip // ä»æŒ‡ä»¤ä¸­è·å–æ“ä½œç  GOTO_OPCODE ip // è·³è½¬åˆ°æ“ä½œç å¤„ç†é€»è¾‘ /* NOTE: no fallthrough */ // cfi info continues, and covers the whole mterp implementation. END ExecuteMterpImpl â€‹ è¿™äº›æ“ä½œç å¯ä»¥é€šè¿‡Opcodesæ‰¾åˆ°å…¶å¯¹åº”çš„å¯¹åº”ï¼Œä»£ç å¦‚ä¸‹ã€‚ 12345678public interface Opcodes { ... int OP_IPUT_CHAR = 0x005e; int OP_IPUT_SHORT = 0x005f; int OP_SGET = 0x0060; int OP_SGET_WIDE = 0x0061; ...} â€‹ è€Œåœ¨åœ¨æ±‡ç¼–æ–‡ä»¶ä¸­ï¼Œä¼šæœ‰å…¶å¯¹åº”æ“ä½œç çš„å…·ä½“å®ç°ã€‚ 12345678910111213141516171819202122232425262728%def field(helper=&quot;&quot;): .extern $helper mov x0, xPC // arg0: æŒ‡ä»¤çš„åœ°å€ mov x1, xINST // arg1: æŒ‡ä»¤å¯¹åº”çš„16ä½æ•°å€¼ add x2, xFP, #OFF_FP_SHADOWFRAME // arg2: ShadowFrame* sf mov x3, xSELF // arg3: Thread* self PREFETCH_INST 2 // é¢„å¤‡å–ä¸‹ä¸€æ¡æŒ‡ä»¤ bl $helper // è°ƒç”¨ $helper å‡½æ•° cbz x0, MterpPossibleException ADVANCE 2 GET_INST_OPCODE ip // ä»æŒ‡ä»¤ä¸­è·å–æ“ä½œç  GOTO_OPCODE ip // è·³è½¬åˆ°æ“ä½œç å¤„ç†é€»è¾‘%def op_iput(helper=&quot;MterpIPutU32&quot;):% field(helper=helper)%def op_sget(helper=&quot;MterpSGetU32&quot;):% field(helper=helper)%def op_iput_char():% op_iput(helper=&quot;MterpIPutU16&quot;)%def op_iput_short():% op_iput(helper=&quot;MterpIPutI16&quot;)%def op_sget_wide():% op_sget(helper=&quot;MterpSGetU64&quot;) â€‹ åˆ°è¿™é‡Œï¼Œå°±æ‰¾åˆ°å¯¹åº”çš„æ‰§è¡ŒC++å‡½æ•°å°†Dexçš„æŒ‡ä»¤é€ä¸€è¿›è¡Œæ‰§è¡Œå¤„ç†ï¼Œå…¶å¯¹åº”çš„C++æ‰§è¡Œéƒ¨åˆ†åˆ™åœ¨æ–‡ä»¶mterp.ccæ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚Mterpçš„æ‰§è¡Œæµç¨‹åˆ°è¿™é‡Œå°±éå¸¸æ¸…æ™°äº†ã€‚ 7.5 ExecuteSwitchâ€‹ ExecuteSwitchæ˜¯åŸºäº switch è¯­å¥å®ç°çš„ä¸€ç§è§£é‡Šå™¨ï¼Œç”¨äºæ‰§è¡Œå½“å‰æ–¹æ³•çš„æŒ‡ä»¤é›†ã€‚åœ¨ Android åº”ç”¨ç¨‹åºä¸­ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½ä¼šå¯¹åº”ä¸€ç»„æŒ‡ä»¤é›†ï¼Œç”¨äºæè¿°è¯¥æ–¹æ³•çš„å…·ä½“å®ç°ã€‚å½“è¯¥æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œç³»ç»Ÿéœ€è¦æŒ‰ç…§æŒ‡ä»¤é›†æ¥æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œä»è€Œå®ç°è¯¥æ–¹æ³•çš„åŠŸèƒ½å¹¶è®¡ç®—å‡ºç»“æœã€‚ 12345678910111213141516171819202122232425static JValue ExecuteSwitch(Thread* self, const CodeItemDataAccessor&amp; accessor, ShadowFrame&amp; shadow_frame, JValue result_register, bool interpret_one_instruction) REQUIRES_SHARED(Locks::mutator_lock_) { // æ˜¯å¦å¤„äºäº‹åŠ¡ä¸­ if (Runtime::Current()-&gt;IsActiveTransaction()) { // æ˜¯å¦è·³è¿‡è®¿é—®æ£€æŸ¥ if (shadow_frame.GetMethod()-&gt;SkipAccessChecks()) { return ExecuteSwitchImpl&lt;false, true&gt;( self, accessor, shadow_frame, result_register, interpret_one_instruction); } else { return ExecuteSwitchImpl&lt;true, true&gt;( self, accessor, shadow_frame, result_register, interpret_one_instruction); } } else { if (shadow_frame.GetMethod()-&gt;SkipAccessChecks()) { return ExecuteSwitchImpl&lt;false, false&gt;( self, accessor, shadow_frame, result_register, interpret_one_instruction); } else { return ExecuteSwitchImpl&lt;true, false&gt;( self, accessor, shadow_frame, result_register, interpret_one_instruction); } }} â€‹ åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæ ¹æ®æ¡ä»¶è°ƒæ•´å‚æ•°ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ExecuteSwitchImplï¼Œä¸‹é¢ç»§ç»­çœ‹è§£é‡Šå™¨çš„å®ç°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950template&lt;bool do_access_check, bool transaction_active&gt;void ExecuteSwitchImplCpp(SwitchImplContext* ctx) { ... // è·å–åˆ°å½“å‰æ­£åœ¨æ‰§è¡Œçš„DexæŒ‡ä»¤åœ¨CodeItemä¸­çš„ç´¢å¼•ä½ç½® uint32_t dex_pc = shadow_frame.GetDexPC(); const auto* const instrumentation = Runtime::Current()-&gt;GetInstrumentation(); // è·å–æŒ‡ä»¤æµ const uint16_t* const insns = accessor.Insns(); // å°†å½“å‰æŒ‡ä»¤è½¬æ¢ä¸ºä¸“é—¨ç”¨æ¥æ“ä½œæŒ‡ä»¤çš„Instructionç±» const Instruction* next = Instruction::At(insns + dex_pc); DCHECK(!shadow_frame.GetForceRetryInstruction()) &lt;&lt; &quot;Entered interpreter from invoke without retry instruction being handled!&quot;; bool const interpret_one_instruction = ctx-&gt;interpret_one_instruction; while (true) { // è·å–ä¸‹ä¸€æ¡å¾…æ‰§è¡Œçš„æŒ‡ä»¤ const Instruction* const inst = next; dex_pc = inst-&gt;GetDexPc(insns); // æ›´æ–°pcä½ç½® shadow_frame.SetDexPC(dex_pc); TraceExecution(shadow_frame, inst, dex_pc); // ä»æŒ‡ä»¤ä¸­è·å–åˆ°æ“ä½œç  uint16_t inst_data = inst-&gt;Fetch16(0); bool exit = false; bool success; // Moved outside to keep frames small under asan. // æ‰§è¡ŒæŒ‡ä»¤å‰çš„é¢„å¤„ç† if (InstructionHandler&lt;do_access_check, transaction_active, Instruction::kInvalidFormat&gt;( ctx, instrumentation, self, shadow_frame, dex_pc, inst, inst_data, next, exit). Preamble()) { DCHECK_EQ(self-&gt;IsExceptionPending(), inst-&gt;Opcode(inst_data) == Instruction::MOVE_EXCEPTION); // è¿™æ˜¯ä¸€ä¸ªè¶…å¤§çš„switchï¼Œæ ¹æ®æ“ä½œç æ¥é€‰æ‹©å¦‚ä½•æ‰§è¡Œ switch (inst-&gt;Opcode(inst_data)) {#define OPCODE_CASE(OPCODE, OPCODE_NAME, NAME, FORMAT, i, a, e, v) \\ case OPCODE: { \\ next = inst-&gt;RelativeAt(Instruction::SizeInCodeUnits(Instruction::FORMAT)); \\ success = OP_##OPCODE_NAME&lt;do_access_check, transaction_active&gt;( \\ ctx, instrumentation, self, shadow_frame, dex_pc, inst, inst_data, next, exit); \\ if (success &amp;&amp; LIKELY(!interpret_one_instruction)) { \\ continue; \\ } \\ break; \\ } DEX_INSTRUCTION_LIST(OPCODE_CASE)#undef OPCODE_CASE } } ... }} â€‹ switchè§£é‡Šå™¨ï¼Œå°±æ˜¯æŒ‡çš„è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä½¿ç”¨switchæ¥å¯¹ä¸åŒçš„æ‰€æœ‰æ“ä½œç è¿›è¡Œå¯¹åº”çš„å¤„ç†ï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰çœ‹åˆ°éå¸¸å¤§çš„caseæ¡ä»¶ï¼Œè¿™æ˜¯å› ä¸ºä»£ç éƒ½åœ¨OPCODE_CASEå®šä¹‰ä¸­ï¼Œæ‰¾åˆ°è¿™ä¸ªå®šä¹‰çš„å®ç°å¦‚ä¸‹ã€‚ 123456789101112131415161718#define OPCODE_CASE(OPCODE, OPCODE_NAME, NAME, FORMAT, i, a, e, v) \\template&lt;bool do_access_check, bool transaction_active&gt; \\ASAN_NO_INLINE static bool OP_##OPCODE_NAME( \\ SwitchImplContext* ctx, \\ const instrumentation::Instrumentation* instrumentation, \\ Thread* self, \\ ShadowFrame&amp; shadow_frame, \\ uint16_t dex_pc, \\ const Instruction* inst, \\ uint16_t inst_data, \\ const Instruction*&amp; next, \\ bool&amp; exit) REQUIRES_SHARED(Locks::mutator_lock_) { \\ InstructionHandler&lt;do_access_check, transaction_active, Instruction::FORMAT&gt; handler( \\ ctx, instrumentation, self, shadow_frame, dex_pc, inst, inst_data, next, exit); \\ return LIKELY(handler.OPCODE_NAME()); \\}DEX_INSTRUCTION_LIST(OPCODE_CASE)#undef OPCODE_CASE â€‹ å¯ä»¥çœ‹åˆ°å†…éƒ¨æ˜¯è°ƒç”¨äº†åˆå§‹åŒ–äº†ä¸€ä¸ªInstructionHandlerå¯¹è±¡ï¼Œç„¶åhandler.OPCODE_NAME()è°ƒç”¨äº†å¯¹åº”çš„æ“ä½œç å‡½æ•°ã€‚æœ€åçœ‹çœ‹å…¶å®ç°ã€‚ 123456789101112131415161718192021222324252627282930313233class InstructionHandler { ... ALWAYS_INLINE InstructionHandler(SwitchImplContext* ctx, const instrumentation::Instrumentation* instrumentation, Thread* self, ShadowFrame&amp; shadow_frame, uint16_t dex_pc, const Instruction* inst, uint16_t inst_data, const Instruction*&amp; next, bool&amp; exit_interpreter_loop) : ctx_(ctx), instrumentation_(instrumentation), self_(self), shadow_frame_(shadow_frame), dex_pc_(dex_pc), inst_(inst), inst_data_(inst_data), next_(next), exit_interpreter_loop_(exit_interpreter_loop) { } ... HANDLER_ATTRIBUTES bool INVOKE_STATIC() { return HandleInvoke&lt;kStatic, /*is_range=*/ false&gt;(); } HANDLER_ATTRIBUTES bool INVOKE_STATIC_RANGE() { return HandleInvoke&lt;kStatic, /*is_range=*/ true&gt;(); } ...} æ‰€æœ‰æ“ä½œç å¯¹åº”çš„å®ç°éƒ½æ˜¯åœ¨InstructionHandlerä¸­è¿›è¡Œå®ç°ï¼Œswitchè§£é‡Šå™¨çš„åšæ³•éå¸¸ç®€å•ç²—æš´ï¼Œå°½é‡æ€§èƒ½è¾ƒå·®ï¼Œä½†æ˜¯å¯è¯»æ€§é«˜ï¼Œå½“éœ€æ±‚æ˜¯å¯¹è°ƒç”¨æµç¨‹è¿›è¡Œæ‰“æ¡©ï¼Œæˆ–è€…å®šåˆ¶ä¿®æ”¹æ—¶ï¼Œå¯ä»¥é€‰æ‹©å¼ºåˆ¶å…¶èµ°switchè§£é‡Šå™¨æ¥æ‰§è¡Œè¯¥å‡½æ•°ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ‰§è¡Œçš„ä¼˜åŒ–ä¸­ï¼Œå½“å¼ºåˆ¶èµ°è§£é‡Šå™¨æµç¨‹è°ƒç”¨åï¼Œå®ƒä¼šäº¤ç»™JITç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘ï¼Œç”Ÿæˆæœ¬åœ°æœºå™¨ç ã€‚åœ¨ç”Ÿæˆæœºå™¨ç çš„åŒæ—¶ï¼ŒJITç¼–è¯‘å™¨ä¼šå°†è¯¥å‡½æ•°çš„å…¥å£åœ°å€è®¾ç½®ä¸ºç”Ÿæˆçš„æœºå™¨ç çš„åœ°å€ã€‚åœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œè™šæ‹Ÿæœºå°±ä¼šè·³è¿‡è§£é‡Šå™¨é˜¶æ®µï¼Œç›´æ¥æ‰§è¡Œæœºå™¨ç ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚ 7.6 æœ¬ç« å°ç»“æœ¬ç« ä¸»è¦ä»‹ç»äº†å®‰å“ç³»ç»Ÿä¸­DEXæ–‡ä»¶çš„ç±»çš„åŠ è½½æœºåˆ¶ä¸ç»†èŠ‚ã€‚ç›¸æ¯”äºå®é™…æ“ä½œåŠ¨æ‰‹ä¿®æ”¹ä»£ç ï¼Œæœ¬ç« ä»‹ç»çš„å†…å®¹æ˜¾ç¤ºæ›´åŠ æ¯ç‡¥ä¹å‘³ï¼Œä½†æ˜¯æ·±å…¥äº†è§£ç³»ç»Ÿå†…éƒ¨çš„è¿è¡Œæœºåˆ¶ï¼Œæœ‰åŠ©äºæ›´å®è§‚è§†è§’çš„å»ç†è§£çš„ç¨‹åºæ‰§è¡Œã€‚æŒæ¡è¿™ä¸€éƒ¨åˆ†å†…å®¹ï¼Œåœ¨ä»£ç ä¿®æ”¹ç‚¹çš„é€‰æ‹©ä¸Šï¼Œå°¤å…¶æ˜¯ç³»ç»Ÿç»„ä»¶çš„éƒ¨åˆ†ä»£ç ï¼Œå°†ä¼šæ›´åŠ ç²¾å‡†ã€‚è€Œä¸”ï¼Œæœ¬ç« å†…å®¹åŒæ ·é€‚åˆäºäºŒè¿›åˆ¶å®‰å…¨å¯¹æŠ—ç ”ç©¶é¢†åŸŸï¼Œæ˜¯ç ”ç©¶è½¯ä»¶åŠ å¯†ä¸è§£å¯†å¿…ä¸å¯å°‘çš„åŸºç¡€çŸ¥è¯†ã€‚","link":"/2025/04/07/chapter-07/"},{"title":"Viewäº‹ä»¶åˆ†å‘","text":"ç›®å½• MotionEvent äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸æ¶ˆè´¹ æ€»æµç¨‹ onTouchå’ŒonClick æºç åˆ†æï¼š View.dispatchTouchEvent æ€»ç»“ï¼š äº‹ä»¶åˆ†å‘æºç è§£æï¼š äº‹ä»¶ï¼šACTION_DOWN 1.å‡è®¾onInterceptTouchEventæ²¡æœ‰æ‹¦æˆªï¼Œè¿™é‡Œinterceptedä¸ºfalse; 2.å‡è®¾onInterceptTouchEventç›´æ¥æ‹¦æˆªï¼Œè¿™é‡Œinterceptedä¸ºtrue; æ€»ç»“ï¼š äº‹ä»¶ï¼šACTION_MOVE 1.å‡è®¾onInterceptTouchEventæ²¡æœ‰æ‹¦æˆª æ€»ç»“ï¼š äº‹ä»¶å†²çª ViewGroup#onInterceptTouchEvent å†²çªè§£å†³ï¼š å†…éƒ¨æ‹¦æˆªæ³•ï¼ˆåœ¨å­Viewä¸­è§£å†³ï¼‰ å†…éƒ¨æ‹¦æˆªæ³•æ€»ç»“ï¼š å¤–éƒ¨æ‹¦æˆªæ³•ï¼ˆåœ¨çˆ¶Viewä¸­è§£å†³ï¼‰ MotionEvent äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸æ¶ˆè´¹ äº‹ä»¶åˆ†å‘ï¼šActivityï¼ŒViewGroupï¼Œ View äº‹ä»¶æ‹¦æˆªï¼š ViewGroup äº‹ä»¶æ¶ˆè´¹ï¼šActivityï¼Œ View æ€»æµç¨‹ onTouchå’ŒonClick12345678910111213textView.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { Log.e(&quot;Text&quot;, &quot;onClick&quot;); }});textView.setOnTouchListener(new View.OnTouchListener() { @Override public boolean onTouch(View v, MotionEvent event) { Log.e(&quot;Text&quot;, &quot;onTouch&quot;+event.getAction()); return false; }}); æºç åˆ†æï¼šView.dispatchTouchEvent12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455public boolean dispatchTouchEvent(MotionEvent event) { // If the event should be handled by accessibility focus first. if (event.isTargetAccessibilityFocus()) { // We don't have focus or no virtual descendant has it, do not handle the event. if (!isAccessibilityFocusedViewOrHost()) { return false; } // We have focus and got the event, then use normal event dispatch. event.setTargetAccessibilityFocus(false); } boolean result = false; if (mInputEventConsistencyVerifier != null) { mInputEventConsistencyVerifier.onTouchEvent(event, 0); } final int actionMasked = event.getActionMasked(); if (actionMasked == MotionEvent.ACTION_DOWN) { // Defensive cleanup for new gesture stopNestedScroll(); } if (onFilterTouchEventForSecurity(event)) { if ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) { result = true; } //noinspection SimplifiableIfStatement ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnTouchListener != null &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; li.mOnTouchListener.onTouch(this, event)) { result = true; } if (!result &amp;&amp; onTouchEvent(event)) { result = true; } } if (!result &amp;&amp; mInputEventConsistencyVerifier != null) { mInputEventConsistencyVerifier.onUnhandledEvent(event, 0); } // Clean up after nested scrolls if this is the end of a gesture; // also cancel it if we tried an ACTION_DOWN but we didn't want the rest // of the gesture. if (actionMasked == MotionEvent.ACTION_UP || actionMasked == MotionEvent.ACTION_CANCEL || (actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) { stopNestedScroll(); } return result;} 123456ListenerInfo li = mListenerInfo;if (li != null &amp;&amp; li.mOnTouchListener != null &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; li.mOnTouchListener.onTouch(this, event)) { result = true;} è¿™é‡Œliä¸ç­‰äºç©º åœ¨view.setOnTouchListeneræˆ–setOnClickListenerè°ƒç”¨æ—¶ éƒ½ä¼šè°ƒç”¨getListenerInfo()æ–¹æ³• 123public void setOnTouchListener(OnTouchListener l) { getListenerInfo().mOnTouchListener = l;} 1234567ListenerInfo getListenerInfo() { if (mListenerInfo != null) { return mListenerInfo; } mListenerInfo = new ListenerInfo(); return mListenerInfo;} æ‰€ä»¥è¿™é‡Œliè‚¯å®šä¸ä¸ºç©º (mViewFlags &amp; ENABLED_MASK) == ENABLEDè¿™é‡Œä»£è¡¨å¯viewå¯ç”¨çŠ¶æ€ æ‰€ä»¥li.mOnTouchListener.onTouch(this, event)è¿™é‡Œå¦‚æœè¿”å›ä¸º ä¸ºtrueæ—¶ result=true 123if (!result &amp;&amp; onTouchEvent(event)) { result = true;} æ‰€ä»¥è¿™é‡Œçš„onTouchEvent(event)æ–¹æ³•å°±ä¸ä¼šå†èµ°ã€‚ onTouchEventä¸­ 1234567891011public boolean onTouchEvent(MotionEvent event) { final float x = event.getX(); final float y = event.getY(); final int viewFlags = mViewFlags; final int action = event.getAction(); ... case MotionEvent.ACTION_UP: if (!post(mPerformClick)) { performClickInternal(); }} performClickInternalâ€“&gt;performClick 123456789101112131415161718192021public boolean performClick() { // We still need to call this method to handle the cases where performClick() was called // externally, instead of through performClickInternal() notifyAutofillManagerOnClick(); final boolean result; final ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnClickListener != null) { playSoundEffect(SoundEffectConstants.CLICK); li.mOnClickListener.onClick(this); result = true; } else { result = false; } sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED); notifyEnterOrExitForAutoFillIfNeeded(true); return result;} è¿™é‡Œ li.mOnClickListener.onClick(this);è°ƒç”¨äº†onClickæ–¹æ³•ï¼Œå¹¶è¿”å›true æ€»ç»“ï¼šonTouchè¿”å›fasleæ—¶ï¼Œè°ƒç”¨onTouchEvent,å†åˆ°onClick onTouchè¿”å›trueæ—¶ï¼Œä¸è°ƒç”¨onTouchEventå’ŒonClick onTouch=falseâ€”-&gt;onTouchEventâ€”-&gt;onClick onTouch=true ç»“æŸ äº‹ä»¶åˆ†å‘æºç è§£æï¼šActivity#dispatchTouchEvent 123456789public boolean dispatchTouchEvent(MotionEvent ev) { if (ev.getAction() == MotionEvent.ACTION_DOWN) { onUserInteraction(); } if (getWindow().superDispatchTouchEvent(ev)) { return true; } return onTouchEvent(ev);} getWindow().superDispatchTouchEvent(ev)â€“&gt;PhoneWindow#superDispatchTouchEvent 123public boolean superDispatchTouchEvent(MotionEvent event) { return mDecor.superDispatchTouchEvent(event);} mDecor.superDispatchTouchEvent(event)â€“&gt;DecorView#superDispatchTouchEvent 123public boolean superDispatchTouchEvent(MotionEvent event) { return super.dispatchTouchEvent(event);} è¿™é‡Œçš„dispatchTouchEventâ€“&gt;ViewGroup#dispatchTouchEvent äº‹ä»¶ï¼šACTION_DOWNä¸€è¿›å…¥downå°±ä¼šæ¸…é™¤äº‹ä»¶å’ŒçŠ¶æ€ 1234567if (actionMasked == MotionEvent.ACTION_DOWN) { // Throw away all previous state when starting a new touch gesture. // The framework may have dropped the up or cancel event for the previous gesture // due to an app switch, ANR, or some other state change. cancelAndClearTouchTargets(ev); resetTouchState();} æ˜¯å¦æ‹¦æˆªçš„æ ‡è¯† 1final boolean intercepted; 1.å‡è®¾onInterceptTouchEventæ²¡æœ‰æ‹¦æˆªï¼Œè¿™é‡Œinterceptedä¸ºfalse;1234@Overridepublic boolean onInterceptTouchEvent(MotionEvent ev) { return false;} 1234567891011121314if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // restore action in case it was changed } else { intercepted = false; }} else { // There are no touch targets and this action is not an initial down // so this view group continues to intercept touches. intercepted = true;} 12final boolean canceled = resetCancelNextUpFlag(this) || actionMasked == MotionEvent.ACTION_CANCEL; å‡è®¾è¿™é‡Œçš„canceledä¹Ÿä¸ºfalse(æ²¡æœ‰å–æ¶ˆ) æ‰€ä»¥è¿›å…¥äº†è¿™é‡Œ 123456789101112131415161718192021TouchTarget newTouchTarget = null;boolean alreadyDispatchedToNewTouchTarget = false;if (!canceled &amp;&amp; !intercepted) { View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus() ? findChildWithAccessibilityFocus() : null; if (actionMasked == MotionEvent.ACTION_DOWN || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN) || actionMasked == MotionEvent.ACTION_HOVER_MOVE) { final int actionIndex = ev.getActionIndex(); // always 0 for down final int idBitsToAssign = split ? 1 &lt;&lt; ev.getPointerId(actionIndex) : TouchTarget.ALL_POINTER_IDS; // Clean up earlier touch targets for this pointer id in case they // have become out of sync. removePointersFromTouchTargets(idBitsToAssign); final int childrenCount = mChildrenCount; if (newTouchTarget == null &amp;&amp; childrenCount != 0) { } } è¿™é‡ŒnewTouchTargetä¸ºnull,å¹¶ä¸”childrenCountä¹Ÿä¸å¯èƒ½ä¸º0 if (newTouchTarget == null &amp;&amp; childrenCount != 0)ä¸­ 1final ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList(); buildTouchDispatchChildList()æ–¹æ³•å¯¹å­Viewè¿›è¡Œæ’åº 12345678910111213for (int i = 0; i &lt; childrenCount; i++) { // add next child (in child order) to end of list final int childIndex = getAndVerifyPreorderedIndex(childrenCount, i, customOrder); final View nextChild = mChildren[childIndex]; final float currentZ = nextChild.getZ(); // insert ahead of any Views with greater Z int insertIndex = i; while (insertIndex &gt; 0 &amp;&amp; mPreSortedChildren.get(insertIndex - 1).getZ() &gt; currentZ) { insertIndex--; } mPreSortedChildren.add(insertIndex, nextChild);} è¿™é‡ŒZè½´è¶Šå¤§è¶Šåœ¨æ•°ç»„åé¢ï¼Œè¶Šå°è¶Šåœ¨æ•°ç»„å‰é¢ï¼ˆé¡µé¢ä¸ŠViewè¶Šåœ¨ä¸Šå±‚è¶Šåœ¨æ•°ç»„åé¢ï¼Œè¶Šåº•å±‚è¶Šåœ¨æ•°ç»„å‰é¢ï¼‰ â€‹ è¿™é‡Œä»æ’å¥½åºçš„preorderedListä¸­ï¼Œä»æœ€åå¾€å‰å–å€¼ï¼ˆå³å…ˆå–zè½´æœ€ä¸Šå±‚çš„viewï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758for (int i = childrenCount - 1; i &gt;= 0; i--) { final int childIndex = getAndVerifyPreorderedIndex( childrenCount, i, customOrder); final View child = getAndVerifyPreorderedView( preorderedList, children, childIndex); // If there is a view that has accessibility focus we want it // to get the event first and if not handled we will perform a // normal dispatch. We may do a double iteration but this is // safer given the timeframe. if (childWithAccessibilityFocus != null) { if (childWithAccessibilityFocus != child) { continue; } childWithAccessibilityFocus = null; i = childrenCount - 1; } if (!child.canReceivePointerEvents() || !isTransformedTouchPointInView(x, y, child, null)) { ev.setTargetAccessibilityFocus(false); continue; } newTouchTarget = getTouchTarget(child); if (newTouchTarget != null) { // Child is already receiving touch within its bounds. // Give it the new pointer in addition to the ones it is handling. newTouchTarget.pointerIdBits |= idBitsToAssign; break; } resetCancelNextUpFlag(child); if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) { // Child wants to receive touch within its bounds. mLastTouchDownTime = ev.getDownTime(); if (preorderedList != null) { // childIndex points into presorted list, find original index for (int j = 0; j &lt; childrenCount; j++) { if (children[childIndex] == mChildren[j]) { mLastTouchDownIndex = j; break; } } } else { mLastTouchDownIndex = childIndex; } mLastTouchDownX = ev.getX(); mLastTouchDownY = ev.getY(); newTouchTarget = addTouchTarget(child, idBitsToAssign); alreadyDispatchedToNewTouchTarget = true; break; } // The accessibility focus didn't handle the event, so clear // the flag and do a normal dispatch to all children. ev.setTargetAccessibilityFocus(false);} è¿™é‡Œåˆ¤æ–­å–åˆ°çš„Viewæ˜¯ä¸æ˜¯ç‚¹å‡»åˆ°çš„Viewï¼ˆåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿæ¥æ”¶æ‰‹æŒ‡äº‹ä»¶å’Œç‚¹å‡»åŒºåŸŸæ˜¯ä¸æ˜¯åœ¨Viewä¸Šï¼‰ ä¸æ˜¯çš„è¯ç»§ç»­å¾ªç¯æ‹¿å– 12345if (!child.canReceivePointerEvents() || !isTransformedTouchPointInView(x, y, child, null)) { ev.setTargetAccessibilityFocus(false); continue;} View.java 123protected boolean canReceivePointerEvents() { return (mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || getAnimation() != null;} 12345678910111213protected boolean isTransformedTouchPointInView(float x, float y, View child, PointF outLocalPoint) { final float[] point = getTempPoint(); point[0] = x; point[1] = y; transformPointToViewLocal(point, child); // pointInViewï¼šx &gt;= 0 &amp;&amp; localY &gt;= 0 &amp;&amp; y &lt; ((mRight - mLeft) + 0) &amp;&amp;y &lt; ((mBottom - mTop) + 0) åˆ¤æ–­è§¦ç‚¹æ˜¯å¦åœ¨Viewä¸Š final boolean isInView = child.pointInView(point[0], point[1]); if (isInView &amp;&amp; outLocalPoint != null) { outLocalPoint.set(point[0], point[1]); } return isInView;} 1234public boolean pointInView(float localX, float localY, float slop) { return localX &gt;= -slop &amp;&amp; localY &gt;= -slop &amp;&amp; localX &lt; ((mRight - mLeft) + slop) &amp;&amp; localY &lt; ((mBottom - mTop) + slop);} è¿™é‡Œè·å–TouchTargetï¼Œè¿™é‡Œè¿”å›çš„è¿˜æ˜¯ç©ºï¼Œå› ä¸ºmFirstTouchTargetåˆå§‹ä¸ºç©º 1newTouchTarget = getTouchTarget(child); 12345678private TouchTarget getTouchTarget(@NonNull View child) { for (TouchTarget target = mFirstTouchTarget; target != null; target = target.next) { if (target.child == child) { return target; } } return null;} dispatchTransformedTouchEvent â€“åˆ†å‘ç»™è°å¤„ç†äº‹ä»¶ 1dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign) 1234567891011121314151617181920212223private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel, View child, int desiredPointerIdBits) { final boolean handled; ... if (child == null) { handled = super.dispatchTouchEvent(transformedEvent); } else { final float offsetX = mScrollX - child.mLeft; final float offsetY = mScrollY - child.mTop; transformedEvent.offsetLocation(offsetX, offsetY); if (! child.hasIdentityMatrix()) { transformedEvent.transform(child.getInverseMatrix()); } handled = child.dispatchTouchEvent(transformedEvent); } // Done. transformedEvent.recycle(); return handled;} è¿™é‡Œchildä¸ä¸ºç©ºï¼Œæ‰€ä»¥å°±ä¼šè°ƒç”¨child.dispatchTouchEvent(transformedEvent)â€“&gt;å°±åˆ°äº†ä¸Šæ–‡onTouchå’ŒonClickçš„æºç åˆ†æView.dispatchTouchEvent View.dispatchTouchEventå¤„ç†äº‹ä»¶åï¼Œè¿”å›resultä¸ºtrue 123if (!result &amp;&amp; onTouchEvent(event)) { result = true;} å°±è¿›å…¥ifï¼Œç„¶åbreak;ç»“æŸæ•´ä¸ªforå¾ªç¯ï¼Œå…¶ä»–viewå°±å¤„ç†ä¸äº†äº‹ä»¶äº†ã€‚ 1234567891011121314151617181920if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) { mLastTouchDownTime = ev.getDownTime(); if (preorderedList != null) { // childIndex points into presorted list, find original index for (int j = 0; j &lt; childrenCount; j++) { if (children[childIndex] == mChildren[j]) { mLastTouchDownIndex = j; break; } } } else { mLastTouchDownIndex = childIndex; } mLastTouchDownX = ev.getX(); mLastTouchDownY = ev.getY(); newTouchTarget = addTouchTarget(child, idBitsToAssign); alreadyDispatchedToNewTouchTarget = true; break;} è¿™é‡Œä¼šè°ƒç”¨addTouchTarget(),è¿›è¡ŒnewTouchTargetèµ‹å€¼ã€‚ 123456private TouchTarget addTouchTarget(@NonNull View child, int pointerIdBits) { final TouchTarget target = TouchTarget.obtain(child, pointerIdBits); target.next = mFirstTouchTarget; mFirstTouchTarget = target; return target;} mFirstTouchTarget==newTouchTargetå¹¶ä¸”alreadyDispatchedToNewTouchTarget=true; å¦‚æœæ²¡æœ‰å¤„ç†ï¼Œå½“å‰å¾ªç¯å°±ç»“æŸäº†ï¼Œ è¿›è¡Œä¸‹ä¸€æ¬¡çš„forå¾ªç¯ã€‚ ç»§ç»­å¾€ä¸‹èµ°ï¼šè¿›å…¥elseäº† 12345678910111213141516171819202122232425262728293031323334if (mFirstTouchTarget == null) { handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS);} else { TouchTarget predecessor = null; TouchTarget target = mFirstTouchTarget; while (target != null) { final TouchTarget next = target.next; if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } else { final boolean cancelChild = resetCancelNextUpFlag(target.child) || intercepted; if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) { handled = true; } if (cancelChild) { if (predecessor == null) { mFirstTouchTarget = next; } else { predecessor.next = next; } target.recycle(); target = next; continue; } } predecessor = target; target = next; }} 1final TouchTarget next = target.next; è¿™é‡Œçš„nextä¸ºnullï¼Œæœ€åtarget = next; æ‰€ä»¥è¿™é‡Œçš„whileå¾ªç¯åªä¼šè¿›å…¥ä¸€æ¬¡ã€‚ï¼ˆè¿™é‡Œwhileæ˜¯ä¸ºå¤šæŒ‡è§¦æ‘¸å‡†å¤‡çš„ï¼Œå‡ ä¸ªæ‰‹æŒ‡å°±ä¼šå¾ªç¯å‡ æ¬¡ï¼‰ 123if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } è¿™é‡Œéƒ½æ»¡è¶³æ‰€ä»¥handledä¸ºtrue æœ€åè¿”å› handledã€‚æ•´ä¸ªDownäº‹ä»¶å°±ç»“æŸäº†ã€‚ 2.å‡è®¾onInterceptTouchEventç›´æ¥æ‹¦æˆªï¼Œè¿™é‡Œinterceptedä¸ºtrue;1234@Overridepublic boolean onInterceptTouchEvent(MotionEvent ev) { return true;} 1234567891011121314if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // restore action in case it was changed } else { intercepted = false; }} else { // There are no touch targets and this action is not an initial down // so this view group continues to intercept touches. intercepted = true;} 123if (!canceled &amp;&amp; !intercepted) { ...} è¿™é‡Œæ•´ä¸ªifè¯­å¥éƒ½ ä¸ä¼šè¿›å…¥ è€Œä¸”è¿™é‡Œæ‹¦æˆªäº†ä»¥åï¼ŒViewGroupçš„å­Viewå°±ä¸å†å¾€ä¸‹åˆ†å‘äº‹ä»¶ï¼ˆåˆ†å‘æ˜¯åœ¨è¿™ä¸ªifä¸­forå¾ªç¯ä¸­åˆ†å‘çš„ï¼‰ è¿™é‡ŒmFirstTouchTargetä¸ºnullï¼Œ 12345if (mFirstTouchTarget == null) { // No touch targets so treat this as an ordinary view. handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS);} è¿™é‡Œçš„childä¸ºnullä¼ å…¥ 1234567891011121314151617private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel, View child, int desiredPointerIdBits) { final boolean handled;... // Perform any necessary transformations and dispatch. if (child == null) { handled = super.dispatchTouchEvent(transformedEvent); } else { final float offsetX = mScrollX - child.mLeft; final float offsetY = mScrollY - child.mTop; transformedEvent.offsetLocation(offsetX, offsetY); if (! child.hasIdentityMatrix()) { transformedEvent.transform(child.getInverseMatrix()); } handled = child.dispatchTouchEvent(transformedEvent); } æ‰€ä»¥ä¼šè°ƒç”¨super.dispatchTouchEvent(transformedEvent); å³è°ƒç”¨ViewGroupè‡ªå·±çš„dispatchTouchEventæ–¹æ³•æ¥å¤„ç† æ€»ç»“ï¼šå½“ViewGroup#onInterceptTouchEventä¸ºfalseæ—¶ï¼Œå°±ä¼šè°ƒç”¨å­Viewçš„dispatchTouchEvent å½“ViewGroup#onInterceptTouchEventä¸ºtrueæ—¶ï¼Œå°±ä¼šè°ƒç”¨è‡ªèº«çš„dispatchTouchEvent äº‹ä»¶ï¼šACTION_MOVE1.å‡è®¾onInterceptTouchEventæ²¡æœ‰æ‹¦æˆªè¿™é‡ŒmFirstTouchTargetç»è¿‡Downäº‹ä»¶åä¸ä¸ºnull,æ‰€ä»¥interceptedä¸ºfalse 1234567891011121314if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // restore action in case it was changed } else { intercepted = false; }} else { // There are no touch targets and this action is not an initial down // so this view group continues to intercept touches. intercepted = true;} è¿›å…¥ä¸‹é¢ifä¹‹å‰boolean alreadyDispatchedToNewTouchTarget = false; if (!canceled &amp;&amp; !intercepted) ä¸­ç›´æ¥è¿›å…¥ä¸‹é¢ elseä¸­ 123456789101112131415161718192021222324252627282930313233if (mFirstTouchTarget == null) { handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS);} else { TouchTarget predecessor = null; TouchTarget target = mFirstTouchTarget; while (target != null) { final TouchTarget next = target.next; if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } else { final boolean cancelChild = resetCancelNextUpFlag(target.child) || intercepted; if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) { handled = true; } if (cancelChild) { if (predecessor == null) { mFirstTouchTarget = next; } else { predecessor.next = next; } target.recycle(); target = next; continue; } } predecessor = target; target = next; }} æ‰€ä»¥è¿™é‡Œwhileèµ°äº†else 12345678910111213141516171819202122232425while (target != null) { final TouchTarget next = target.next; if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } else { final boolean cancelChild = resetCancelNextUpFlag(target.child) || intercepted; if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) { handled = true; } if (cancelChild) { if (predecessor == null) { mFirstTouchTarget = next; } else { predecessor.next = next; } target.recycle(); target = next; continue; } } predecessor = target; target = next;} dispatchTransformedTouchEventæ–¹æ³• ä¸­èµ°äº†handled = child.dispatchTouchEvent(transformedEvent); æ€»ç»“ï¼šå½“ViewGroup#onInterceptTouchEventä¸ºfalseæ—¶ï¼Œå°±ä¼šè°ƒç”¨å­Viewçš„dispatchTouchEvent äº‹ä»¶å†²çªViewGroup#onInterceptTouchEventViewpager+Listview å†²çªè§£å†³ï¼šå†…éƒ¨æ‹¦æˆªæ³•ï¼ˆåœ¨å­Viewä¸­è§£å†³ï¼‰1234567891011121314151617181920212223int mLastX;int mLastY;@Overridepublic boolean dispatchTouchEvent(MotionEvent ev) { int x = (int) ev.getX(); int y = (int) ev.getY(); switch (ev.getAction()) { case MotionEvent.ACTION_DOWN: getParent().requestDisallowInterceptTouchEvent(true);//è¯·æ±‚ä¸å…è®¸ä¸­æ–­ break; case MotionEvent.ACTION_MOVE: int deltaX = x - mLastX; int deltaY = y - mLastY; if(Math.abs(deltaX)&gt; Math.abs(deltaY)){ //å·¦å³æ»‘ getParent().requestDisallowInterceptTouchEvent(false);//å…è®¸ä¸­æ–­ } break; } mLastX = x; mLastY = y; return super.dispatchTouchEvent(ev);} 12345678910111213141516171819@Overridepublic void requestDisallowInterceptTouchEvent(boolean disallowIntercept) { if (disallowIntercept == ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0)) { // We're already in this state, assume our ancestors are too return; } if (disallowIntercept) { mGroupFlags |= FLAG_DISALLOW_INTERCEPT; } else { mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT; } // Pass it up to our parent if (mParent != null) { mParent.requestDisallowInterceptTouchEvent(disallowIntercept); }} è¿™é‡Œè®¾ç½®äº† getParent().requestDisallowInterceptTouchEvent(true)åï¼ŒdisallowInterceptå°±ä¸ºtrueï¼Œå°±ä¸ä¼šèµ°çˆ¶Viewçš„onInterceptTouchEventæ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œå®ç°å­Viewæ¥æ”¶äº‹ä»¶ã€‚ 12345678910if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // restore action in case it was changed } else { intercepted = false; }} ä½†æ˜¯ï¼Œä¸èƒ½åœ¨MotionEvent.ACTION_DOWNæ–¹æ³•ä¸­è®¾ç½®ã€‚ åœ¨è¿›å…¥ä¸Šé¢äº‹ä»¶åˆ¤æ–­å‰ä¼šè¿›è¡ŒçŠ¶æ€çš„åˆå§‹åŒ–ã€‚æ‰€ä»¥åœ¨ACTION_DOWNäº‹ä»¶ä¸­onInterceptTouchEventè‚¯å®šä¼šæ‰§è¡Œã€‚ 1234if (actionMasked == MotionEvent.ACTION_DOWN) { cancelAndClearTouchTargets(ev); resetTouchState();} è§£å†³æ–¹æ³•ï¼šåœ¨çˆ¶Viewä¸­ä¸ºACTION_DOWNè¿”å›false 12345678@Overridepublic boolean onInterceptTouchEvent(MotionEvent ev) { if (ev.getAction() == MotionEvent.ACTION_DOWN) { super.onInterceptTouchEvent(ev); return false; } return true;} å†…éƒ¨æ‹¦æˆªæ³•æ€»ç»“ï¼šMotionEvent.ACTION_DOWNæ—¶ï¼Œçˆ¶Viewä¸­onInterceptTouchEventè®¾ä¸ºfalseï¼Œå­Viewè°ƒç”¨getParent().requestDisallowInterceptTouchEvent(true);æ–¹æ³• MotionEvent.ACTION_MOVEæ—¶ï¼Œçˆ¶Viewä¸­onInterceptTouchEventè®¾ä¸ºtrueï¼Œéå­Viewäº‹ä»¶æ—¶getParent().requestDisallowInterceptTouchEvent(false);æ–¹æ³• å¤–éƒ¨æ‹¦æˆªæ³•ï¼ˆåœ¨çˆ¶Viewä¸­è§£å†³ï¼‰åœ¨çˆ¶Viewå½“ä¸­è¿›è¡Œå¤„ç† 1234567891011121314151617181920212223int mLastX;int mLastY;@Overridepublic boolean onInterceptTouchEvent(MotionEvent ev) { int x = (int) ev.getX(); int y = (int) ev.getY(); switch (ev.getAction()) { case MotionEvent.ACTION_DOWN: mLastX= (int) ev.getX(); mLastY= (int) ev.getY(); break; case MotionEvent.ACTION_MOVE: int deltaX = x - mLastX; int deltaY = y - mLastY; if (Math.abs(deltaX) &gt; Math.abs(deltaY)) { //å·¦å³æ»‘ return true; } break; } return super.onInterceptTouchEvent(ev);}","link":"/2020/12/09/dispatch/"},{"title":"ç¬¬ä¸‰ç«  è®¤è¯†ç³»ç»Ÿç»„ä»¶","text":"[è½¬]å®‰å“ç³»ç»Ÿå®šåˆ¶ï¼šä»å…¥é—¨åˆ°å®è·µ 3.1 æºç ç»“æ„ä»‹ç» 3.2 Androidç³»ç»Ÿå¯åŠ¨æµç¨‹ 3.3 å†…æ ¸å¯åŠ¨ 3.4 Initè¿›ç¨‹å¯åŠ¨ 3.5 init.rc 3.6 Zygoteå¯åŠ¨ 3.7 Android appåº”ç”¨å¯åŠ¨ 3.8 äº†è§£Service 3.9 äº†è§£Framework 3.10 äº†è§£libcore 3.11 äº†è§£sepolicy 3.12 äº†è§£Linker 3.12.1 ELFæ–‡ä»¶æ ¼å¼ 3.12.2 åŠ¨æ€åº“åŠ è½½æµç¨‹ å°ç»“ åœ¨ä¸Šä¸€ç« çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸç¼–è¯‘äº†Android12ï¼Œä»¥åŠå¯¹åº”çš„ç³»ç»Ÿå†…æ ¸ï¼Œå¹¶ä¸”é€šè¿‡å¤šç§æ–¹å¼åˆ·å…¥æ‰‹æœºã€‚æ¥ä¸‹æ¥éœ€è¦å…ˆå¯¹Androidæºç çš„æ ¹ç»“æ„æœ‰ä¸€å®šçš„äº†è§£ï¼Œäº†è§£ç»“æ„æœ‰åŠ©äºæ›´å¿«åœ°å®šä½å’Œåˆ†ææºç ï¼ŒåŒæ—¶èƒ½è®©å¼€å‘äººå‘˜æ›´å¥½åœ°ç†è§£Androidç³»ç»Ÿã€‚åœ¨ä¿®æ”¹ç³»ç»Ÿæ—¶ï¼Œæœ‰äº›ç®€å•çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚nativeä¸­çš„æ–‡ä»¶è¯»å†™ã€javaç±»å‹çš„è½¬æ¢c++ç±»å‹ç­‰ï¼‰å¹¶ä¸éœ€è¦æˆ‘ä»¬é‡æ–°å®ç°ï¼Œå› ä¸ºè¿™äº›éœ€æ±‚å¤§å¤šæ•°åœ¨Androidç³»ç»Ÿæºç ä¸­éƒ½æœ‰ç±»ä¼¼çš„å®ç°ï¼Œç†Ÿç»ƒæŒæ¡Androidç³»ç»Ÿæºç ï¼Œäº†è§£ç³»ç»Ÿä¸­å¸¸ç”¨çš„é‚£äº›åŠŸèƒ½æ€§å‡½æ•°ï¼Œå¯ä»¥å¤§å¤§æé«˜å®šåˆ¶ç³»ç»Ÿçš„æ•ˆç‡ã€‚ åœ¨å­¦ä¹ ç³»ç»Ÿæºç æ—¶ï¼Œç¢°åˆ°é—®é¢˜ï¼Œè¦å­¦ä¼šæš‚æ—¶è®°å½•å¹¶è·³è¿‡ï¼Œç»å†è¿‡ä¸€ééå­¦ä¹ å’Œå®è·µåï¼Œä¹‹å‰é‡åˆ°çš„é—®é¢˜å¯èƒ½ç®€å•æ€è€ƒä¾¿ä¼šæ˜ç™½ï¼Œè¿™ä¸ä»…èŠ‚çœäº†æ—¶é—´ï¼Œä¹Ÿä¸ä¼šåœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é€æ¸å¤±å»ä¿¡å¿ƒã€‚ 3.1 æºç ç»“æ„ä»‹ç»â€‹ é¦–å…ˆçœ‹çœ‹Androidæºç æ ¹ç›®å½•ä¸‹ï¼Œå„ä¸ªç›®å½•çš„ç®€å•ä»‹ç»ã€‚ artï¼šè¯¥ç›®å½•æ˜¯åœ¨Android 5.0ä¸­æ–°å¢åŠ çš„ï¼Œä¸»è¦æ˜¯å®ç°Android RunTimeï¼ˆARTï¼‰çš„ç›®å½•ï¼Œå®ƒä½œä¸ºAndroid 4.4ä¸­çš„Dalvikè™šæ‹Ÿæœºçš„æ›¿ä»£ï¼Œä¸»è¦å¤„ç†Javaå­—èŠ‚ç æ‰§è¡Œã€‚ bionicï¼šAndroidçš„Cåº“ï¼ŒåŒ…å«äº†å¾ˆå¤šæ ‡å‡†çš„Cåº“å‡½æ•°å’Œå¤´æ–‡ä»¶ï¼Œè¿˜æœ‰ä¸€äº›Androidç‰¹æœ‰çš„å‡½æ•°å’Œå¤´æ–‡ä»¶ã€‚ buildï¼šè¯¥ç›®å½•åŒ…å«äº†ç¼–è¯‘Androidæºä»£ç æ‰€éœ€è¦çš„è„šæœ¬ï¼ŒåŒ…æ‹¬makefileæ–‡ä»¶å’Œä¸€äº›æ„å»ºå·¥å…·ã€‚ compatibilityï¼šAndroidè®¾å¤‡çš„å…¼å®¹æ€§æµ‹è¯•å¥—ä»¶ï¼ˆCTSï¼‰å’Œå…¼å®¹æ€§å®ç°ï¼ˆCompatibility Implementationï¼‰ã€‚ ctsï¼šAndroidè®¾å¤‡å…¼å®¹æ€§æµ‹è¯•å¥—ä»¶ï¼ˆCTSï¼‰ï¼Œä¸»è¦ç”¨æ¥æµ‹è¯•è®¾å¤‡æ˜¯å¦ç¬¦åˆAndroidæ ‡å‡†ã€‚ dalvikï¼šDalvikè™šæ‹Ÿæœºï¼Œå®ƒæ˜¯Android 2.3ç‰ˆæœ¬ä¹‹å‰çš„ä¸»è¦è™šæ‹Ÿæœºï¼Œå®ƒä¸»è¦å¤„ç†Javaå­—èŠ‚ç æ‰§è¡Œã€‚ developersï¼šAndroidå¼€å‘è€…æ–‡æ¡£å’Œæ ·ä¾‹ä»£ç ã€‚ developmentï¼šè°ƒè¯•å·¥å…·ï¼Œå¦‚systraceã€monkeyã€ddmsç­‰ã€‚ deviceï¼šç‰¹å®šçš„Androidè®¾å¤‡çš„é©±åŠ¨ç¨‹åºã€‚ externalï¼šç¬¬ä¸‰æ–¹åº“ï¼Œå¦‚WebKitã€OpenGLç­‰ã€‚ frameworksï¼šAndroidåº”ç”¨ç¨‹åºè°ƒç”¨åº•å±‚æœåŠ¡çš„APIã€‚ hardwareï¼šAndroidè®¾å¤‡ç¡¬ä»¶ç›¸å…³çš„é©±åŠ¨ä»£ç ï¼Œå¦‚æ‘„åƒå¤´é©±åŠ¨ã€è“ç‰™é©±åŠ¨ç­‰ã€‚ kernelï¼šAndroidç³»ç»Ÿå†…æ ¸çš„æºä»£ç ï¼Œå®ƒæ˜¯Androidç³»ç»Ÿçš„æ ¸å¿ƒéƒ¨åˆ†ã€‚ libcoreï¼šAndroidåº•å±‚åº“ï¼Œå®ƒæä¾›äº†ä¸€äº›åŸºæœ¬çš„APIï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€ç½‘ç»œæ“ä½œç­‰ã€‚ packagesï¼šAndroidç³»ç»Ÿä¸­çš„ç³»ç»Ÿåº”ç”¨ç¨‹åºçš„æºç ï¼Œä¾‹å¦‚çŸ­ä¿¡ã€ç”µè¯ã€æµè§ˆå™¨ã€ç›¸æœºç­‰ pdkï¼šAndroidå¹³å°å¼€å‘å¥—ä»¶ï¼Œå®ƒåŒ…å«äº†ä¸€äº›å·¥å…·å’ŒAPIï¼Œä»¥ä¾¿å¼€å‘è€…å¿«é€Ÿå¼€å‘Androidåº”ç”¨ç¨‹åºã€‚ platform_testingï¼šæµ‹è¯•å·¥å…·ï¼Œç”¨äºæµ‹è¯•Androidå¹³å°çš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚ prebuiltsï¼šé¢„å…ˆç¼–è¯‘çš„æ–‡ä»¶ï¼Œå¦‚ç¼–è¯‘å·¥å…·ã€é©±åŠ¨ç¨‹åºç­‰ã€‚ sdkï¼šAndroid SDKçš„æºä»£ç ï¼ŒAndroid SDKçš„APIæ–‡æ¡£ã€ä»£ç ç¤ºä¾‹ã€å·¥å…·ç­‰ã€‚ systemï¼šAndroidç³»ç»Ÿçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå¦‚ç³»ç»ŸæœåŠ¡ã€åº”ç”¨ç¨‹åºã€å†…å­˜ç®¡ç†æœºåˆ¶ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œåè®®ç­‰ã€‚ testï¼šæµ‹è¯•ä»£ç ï¼Œç”¨äºæµ‹è¯•Androidç³»ç»Ÿçš„å„ä¸ªç»„ä»¶ã€‚ toolchainï¼šç¼–è¯‘å™¨å’Œå·¥å…·é“¾ï¼Œå¦‚GCCã€Clangç­‰ï¼Œç”¨äºç¼–è¯‘Androidæºä»£ç ã€‚ toolsï¼šå¼€å‘å·¥å…·ï¼Œå¦‚Android SDKå·¥å…·ã€Android Studioã€Eclipseç­‰ã€‚ vendorï¼šç¡¬ä»¶å‚å•†æä¾›çš„é©±åŠ¨ç¨‹åºï¼Œå¦‚æ‘„åƒå¤´é©±åŠ¨ã€è“ç‰™é©±åŠ¨ç­‰ã€‚ â€‹ åœ¨ä¸Šè¿°ç›®å½•ä¸­ï¼Œå¹¶ä¸éœ€è¦å…¨éƒ¨è®°ä¸‹ï¼Œåªéœ€è¦è®°ä½å‡ ä¸ªé‡ç‚¹å³å¯ï¼Œä¾‹å¦‚artã€frameworkã€libcoreã€systemã€buildã€‚åœ¨å®è·µæ—¶ï¼Œä¸ºäº†å®ç°åŠŸèƒ½ï¼ŒæŸ¥é˜…ç¿»è¯»æºç æ—¶ï¼Œå°±ä¼šä¸æ–­åŠ æ·±ä½ å¯¹è¿™äº›ç›®å½•åˆ’åˆ†çš„äº†è§£ã€‚ 3.2 Androidç³»ç»Ÿå¯åŠ¨æµç¨‹â€‹ Androidç³»ç»Ÿå¯åŠ¨ä¸»è¦åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼šBootloaderé˜¶æ®µã€Kernelé˜¶æ®µã€Initè¿›ç¨‹é˜¶æ®µå’ŒSystem Serverå¯åŠ¨é˜¶æ®µï¼Œä¸‹é¢çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªé˜¶æ®µçš„å¯åŠ¨æµç¨‹ã€‚ Bootloaderé˜¶æ®µï¼š å½“æ‰‹æœºæˆ–å¹³æ¿ç”µè„‘å¼€æœºæ—¶ï¼Œé¦–å…ˆä¼šæ‰§è¡Œå¼•å¯¼åŠ è½½ç¨‹åºï¼ˆBootloaderï¼‰ï¼Œå®ƒä¼šåœ¨æ‰‹æœºçš„ROMä¸­å¯»æ‰¾å¯åŠ¨å†…æ ¸ï¼ˆKernelï¼‰çš„é•œåƒæ–‡ä»¶ï¼Œå¹¶å°†å…¶åŠ è½½è¿›RAMã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒAndroidç³»ç»Ÿå¹¶æ²¡æœ‰å®Œå…¨å¯åŠ¨ï¼Œåªæ˜¯å»ºç«‹äº†åŸºæœ¬çš„ç¡¬ä»¶å’Œå†…æ ¸ç¯å¢ƒã€‚ Kernelé˜¶æ®µï¼š Kernelé˜¶æ®µæ˜¯Androidå¯åŠ¨çš„ç¬¬äºŒé˜¶æ®µï¼Œå®ƒä¸»è¦è´Ÿè´£åˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡ã€åŠ è½½é©±åŠ¨ç¨‹åºã€è®¾ç½®å†…å­˜ç®¡ç†ç­‰ã€‚æ­¤å¤–ï¼ŒKernelè¿˜ä¼šåŠ è½½initramfsï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…å«äº†initç¨‹åºå’Œä¸€äº›è®¾å¤‡æ–‡ä»¶ã€‚ Initè¿›ç¨‹é˜¶æ®µï¼š Kernelä¼šå¯åŠ¨initè¿›ç¨‹ï¼Œå®ƒæ˜¯Androidç³»ç»Ÿä¸­çš„ç¬¬ä¸€ä¸ªç”¨æˆ·ç©ºé—´è¿›ç¨‹ã€‚Initè¿›ç¨‹çš„ä¸»è¦ä»»åŠ¡æ˜¯è¯»å–init.rcæ–‡ä»¶ï¼Œå¹¶æ ¹æ®è¯¥æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯å¯åŠ¨å’Œé…ç½®Androidç³»ç»Ÿçš„å„ä¸ªç»„ä»¶ã€‚åœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼Œç³»ç»Ÿä¼šä¾æ¬¡å¯åŠ¨å„ä¸ªæœåŠ¡å’Œè¿›ç¨‹ï¼ŒåŒ…æ‹¬å¯åŠ¨Zygoteè¿›ç¨‹å’Œåˆ›å»ºSystem Serverè¿›ç¨‹ã€‚ System Serverå¯åŠ¨é˜¶æ®µï¼š System Serveræ˜¯Androidç³»ç»Ÿçš„æ ¸å¿ƒæœåŠ¡è¿›ç¨‹ï¼Œå®ƒä¼šå¯åŠ¨æ‰€æœ‰çš„ç³»ç»ŸæœåŠ¡ã€‚å…¶ä¸­åŒ…æ‹¬Activity Managerã€Package Managerã€Window Managerã€Location Managerã€Telephony Managerã€Wi-Fi Serviceã€Bluetooth Serviceç­‰ã€‚System Serverå¯åŠ¨åï¼ŒAndroidç³»ç»Ÿå°±å®Œå…¨å¯åŠ¨äº†ï¼Œç”¨æˆ·å¯ä»¥è¿›å…¥æ¡Œé¢ï¼Œå¼€å§‹ä½¿ç”¨å„ç§åº”ç”¨ç¨‹åºã€‚ â€‹ åœ¨å¼€å§‹å¯åŠ¨æµç¨‹ä»£ç è¿½è¸ªå‰ï¼Œæœ€é‡è¦çš„æ˜¯ä¸è¦è¯•å›¾äº†è§£æ‰€æœ‰ç»†èŠ‚è¿‡ç¨‹ï¼Œåˆ†æä»£ç æ—¶è¦æŠ“ä½éœ€æ±‚é‡ç‚¹ï¼Œç„¶åå›´ç»•ç€éœ€æ±‚ç‚¹æ¥è¿›è¡Œæ·±å…¥åˆ†æã€‚å°½ç®¡Androidæºç æ˜¯ä¸€ä¸ªéå¸¸åºå¤§çš„ä½“ç³»ï¼Œé€‰æ‹©ä¸€ä¸ªæ–¹å‘æ¥ç†Ÿæ‚‰ä»£ç ï¼Œè¿™æ ·å°±èƒ½å¿«é€Ÿçš„è¾¾æˆç›®æ ‡ï¼Œé¿å…æ·±é™·ä»£ç æ³¥æ²¼ã€‚ 3.3 å†…æ ¸å¯åŠ¨â€‹ Bootloaderå…¶å®æ˜¯ä¸€æ®µç¨‹åºï¼Œè¿™ä¸ªç¨‹åºçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯ç”¨æ¥å¼•å¯¼ç³»ç»Ÿå¯åŠ¨ï¼Œä¹Ÿç§°ä¹‹ä¸ºå¼•å¯¼ç¨‹åºï¼Œè€Œè¿™ä¸ªå¼•å¯¼ç¨‹åºæ˜¯å­˜æ”¾åœ¨ä¸€ä¸ªåªè¯»çš„å¯„å­˜å™¨ä¸­ï¼Œä»ç‰©ç†åœ°å€0å¼€å§‹çš„ä¸€æ®µç©ºé—´åˆ†é…ç»™äº†è¿™ä¸ªåªè¯»å­˜å‚¨å™¨æ¥å­˜æ”¾å¼•å¯¼ç¨‹åºã€‚ â€‹ Bootloaderä¼šåˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡å¹¶å‡†å¤‡å†…å­˜ç©ºé—´æ˜ å°„ï¼Œä¸ºå¯åŠ¨å†…æ ¸å‡†å¤‡ç¯å¢ƒã€‚ç„¶åå¯»æ‰¾å†…æ ¸çš„é•œåƒæ–‡ä»¶ï¼ŒéªŒè¯bootåˆ†åŒºå’Œrecoveryåˆ†åŒºçš„å®Œæ•´æ€§ï¼Œç„¶åå°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæœ€åå¼€å§‹æ‰§è¡Œå†…æ ¸ã€‚å¯ä»¥é€šè¿‡å‘½ä»¤adb reboot bootloaderç›´æ¥é‡å¯è¿›å…¥å¼•å¯¼ç¨‹åºã€‚ â€‹ Bootloaderåˆå§‹åŒ–å®Œæˆåï¼Œä¼šåœ¨ç‰¹å®šçš„ç‰©ç†åœ°å€å¤„æŸ¥æ‰¾EFIå¼•å¯¼å¤´ï¼ˆefi_headï¼‰ã€‚å¦‚æœæŸ¥æ‰¾åˆ°EFIå¼•å¯¼å¤´ï¼Œbootloaderå°±ä¼šåŠ è½½EFIå¼•å¯¼å¤´æŒ‡å®šçš„EFIå¼•å¯¼ç¨‹åºï¼Œç„¶åå¼€å§‹æ‰§è¡ŒEFIå¼•å¯¼ç¨‹åºï¼Œä»¥è¿›è¡Œåç»­çš„EFIå¼•å¯¼æµç¨‹ã€‚è€Œè¿™ä¸ªefi_headå°±æ˜¯linuxå†…æ ¸æœ€æ—©çš„å…¥å£äº†ã€‚ â€‹ ä¸åšç³»ç»Ÿå¼•å¯¼å¼€å‘çš„æœ‹å‹ï¼Œå¹¶ä¸éœ€è¦å®Œå…¨çœ‹æ‡‚å†…æ ¸ä¸­çš„æ±‡ç¼–éƒ¨åˆ†ä»£ç ï¼Œäº†è§£å…¶æ‰§è¡Œçš„æµç¨‹å³å¯ï¼Œå› æ­¤ä¸éœ€è¦è¯»è€…æœ‰æ±‡ç¼–çš„åŠŸåº•ï¼Œåªéœ€è¦èƒ½çœ‹æ‡‚ç®€å•çš„å‡ ä¸ªæŒ‡ä»¤å³å¯ã€‚æ‰“å¼€ç¼–è¯‘å†…æ ¸æºç æ—¶çš„ç›®å½•ï¼Œæ‰¾åˆ°æ–‡ä»¶android-kernel/private/msm-google/arch/arm64/kernel/head.Sï¼ŒæŸ¥çœ‹å…¶æ±‡ç¼–ä»£ç å¦‚ä¸‹ã€‚ 1234567891011121314 __HEAD_head: /* * DO NOT MODIFY. Image header expected by Linux boot-loaders. */#ifdef CONFIG_EFI /* * This add instruction has no meaningful effect except that * its opcode forms the magic &quot;MZ&quot; signature required by UEFI. */ add x13, x18, #0x16 b stext#else b stext // branch to kernel start, magic â€‹ åœ¨armæŒ‡ä»¤é›†ä¸­ï¼ŒæŒ‡ä»¤bè¡¨ç¤ºè·³è½¬ï¼Œæ‰€ä»¥ï¼Œç»§ç»­æ‰¾åˆ°stextçš„å®šä¹‰ã€‚ 1234567891011121314151617181920212223242526 /* * The following callee saved general purpose registers are used on the * primary lowlevel boot path: * * Register Scope Purpose * x21 stext() .. start_kernel() FDT pointer passed at boot in x0 * x23 stext() .. start_kernel() physical misalignment/KASLR offset * x28 __create_page_tables() callee preserved temp register * x19/x20 __primary_switch() callee preserved temp registers */ENTRY(stext) bl preserve_boot_args // æŠŠå¼•å¯¼ç¨‹åºä¼ çš„4ä¸ªå‚æ•°ä¿å­˜åœ¨å…¨å±€æ•°ç»„boot_args bl el2_setup // Drop to EL1, w0=cpu_boot_mode adrp x23, __PHYS_OFFSET and x23, x23, MIN_KIMG_ALIGN - 1 // KASLR offset, defaults to 0 bl set_cpu_boot_mode_flag bl __create_page_tables // åˆ›å»ºé¡µè¡¨æ˜ å°„ x25=TTBR0, x26=TTBR1 /* * The following calls CPU setup code, see arch/arm64/mm/proc.S for * details. * On return, the CPU will be ready for the MMU to be turned on and * the TCR will have been set. */ bl __cpu_setup // // åˆå§‹åŒ–å¤„ç†å™¨ initialise processor b __primary_switchENDPROC(stext) â€‹ èƒ½çœ‹åˆ°æœ€åä¸€è¡Œæ˜¯è·³è½¬åˆ°__primary_switchï¼Œæ¥ä¸‹æ¥ç»§ç»­çœ‹å®ƒçš„å®ç°ä»£ç  12345678910111213141516171819202122232425262728293031323334353637383940__primary_switch:#ifdef CONFIG_RANDOMIZE_BASE mov x19, x0 // preserve new SCTLR_EL1 value mrs x20, sctlr_el1 // preserve old SCTLR_EL1 value#endif bl __enable_mmu#ifdef CONFIG_RELOCATABLE bl __relocate_kernel#ifdef CONFIG_RANDOMIZE_BASE ldr x8, =__primary_switched //å°†x8è®¾ç½®æˆ__primary_switchedçš„åœ°å€ adrp x0, __PHYS_OFFSET blr x8 //è°ƒç”¨__primary_switched /* * If we return here, we have a KASLR displacement in x23 which we need * to take into account by discarding the current kernel mapping and * creating a new one. */ msr sctlr_el1, x20 // disable the MMU isb bl __create_page_tables // recreate kernel mapping tlbi vmalle1 // Remove any stale TLB entries dsb nsh isb msr sctlr_el1, x19 // re-enable the MMU isb ic iallu // flush instructions fetched dsb nsh // via old mapping isb bl __relocate_kernel#endif#endif ldr x8, =__primary_switched adrp x0, __PHYS_OFFSET br x8ENDPROC(__primary_switch) â€‹ ç»§ç»­è·Ÿè¸ª__primary_switchedå‡½æ•°ï¼Œå°±èƒ½çœ‹åˆ°è°ƒç”¨é‡ç‚¹å‡½æ•°start_kerneläº†ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647__primary_switched: adrp x4, init_thread_union add sp, x4, #THREAD_SIZE adr_l x5, init_task msr sp_el0, x5 // Save thread_info adr_l x8, vectors // load VBAR_EL1 with virtual msr vbar_el1, x8 // vector table address isb stp xzr, x30, [sp, #-16]! mov x29, sp#ifdef CONFIG_SHADOW_CALL_STACK adr_l x18, init_shadow_call_stack // Set shadow call stack#endif str_l x21, __fdt_pointer, x5 // Save FDT pointer ldr_l x4, kimage_vaddr // Save the offset between sub x4, x4, x0 // the kernel virtual and str_l x4, kimage_voffset, x5 // physical mappings // Clear BSS adr_l x0, __bss_start mov x1, xzr adr_l x2, __bss_stop sub x2, x2, x0 bl __pi_memset dsb ishst // Make zero page visible to PTW#ifdef CONFIG_KASAN bl kasan_early_init#endif#ifdef CONFIG_RANDOMIZE_BASE tst x23, ~(MIN_KIMG_ALIGN - 1) // already running randomized? b.ne 0f mov x0, x21 // pass FDT address in x0 mov x1, x23 // pass modulo offset in x1 bl kaslr_early_init // parse FDT for KASLR options cbz x0, 0f // KASLR disabled? just proceed orr x23, x23, x0 // record KASLR offset ldp x29, x30, [sp], #16 // we must enable KASLR, return ret // to __primary_switch()0:#endif b start_kernel // å†…æ ¸çš„å…¥å£å‡½æ•°ENDPROC(__primary_switched) â€‹ ä¸Šé¢èƒ½çœ‹åˆ°æœ€åä¸€ä¸ªæŒ‡ä»¤å°±æ˜¯è°ƒç”¨start_kerneläº†ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å†…æ ¸çš„å…¥å£å‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯Cè¯­è¨€éƒ¨åˆ†çš„å…¥å£å‡½æ•°ã€‚æ¥ä¸‹æ¥ï¼ŒæŸ¥çœ‹æ–‡ä»¶android-kernel/private/msm-google/init/main.cï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­å¤§é‡çš„initåˆå§‹åŒ–å„ç§å­ç³»ç»Ÿçš„å‡½æ•°è°ƒç”¨ã€‚ 12345678910asmlinkage __visible void __init start_kernel(void){ // åŠ è½½å„ç§å­ç³»ç»Ÿ ... /* Do the rest non-__init'ed, we're now alive */ rest_init(); prevent_tail_call_optimization();} â€‹ ç»§ç»­è¿½è¸ªå…³é”®çš„å‡½æ•°rest_initï¼Œåœ¨è¿™é‡Œå¼€å¯çš„å†…æ ¸åˆå§‹åŒ–çº¿ç¨‹ä»¥åŠåˆ›å»ºå†…æ ¸çº¿ç¨‹ã€‚ 12345678static noinline void __ref rest_init(void){ ... kernel_thread(kernel_init, NULL, CLONE_FS); numa_default_policy(); pid = kernel_thread(kthreadd, NULL, CLONE_FS | CLONE_FILES); ...} â€‹ ç»§ç»­çœ‹çœ‹kernel_initå†…æ ¸åˆå§‹åŒ–çº¿ç¨‹çš„å®ç°ã€‚ 123456789101112static int __ref kernel_init(void *unused){ int ret; ... if (ramdisk_execute_command) { ret = run_init_process(ramdisk_execute_command); if (!ret) return 0; pr_err(&quot;Failed to execute %s (error %d)\\n&quot;, ramdisk_execute_command, ret); }} â€‹ åœ¨è¿™é‡Œï¼Œçœ‹åˆ°äº†åŸæ¥initè¿›ç¨‹æ˜¯ç”¨run_init_processå¯åŠ¨çš„ï¼Œramdisk_execute_commandè¢«åˆå§‹åŒ–ä¸ºäº†â€/initâ€ã€‚ 12345678910111213static int try_to_run_init_process(const char *init_filename){ int ret; ret = run_init_process(init_filename); if (ret &amp;&amp; ret != -ENOENT) { pr_err(&quot;Starting init: %s exists but couldn't execute it (error %d)\\n&quot;, init_filename, ret); } return ret;} è¿™é‡Œç®€å•åŒ…è£…è°ƒç”¨çš„run_init_processï¼Œç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç  1234567static int run_init_process(const char *init_filename){ argv_init[0] = init_filename; return do_execve(getname_kernel(init_filename), (const char __user *const __user *)argv_init, (const char __user *const __user *)envp_init);} â€‹ è¿™é‡Œèƒ½çœ‹åˆ°æœ€åæ˜¯é€šè¿‡execveæ‹‰èµ·æ¥äº†ç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œinitè¿›ç¨‹ã€‚æ€»ç»“å†…æ ¸å¯åŠ¨çš„ç®€å•æµç¨‹å›¾å¦‚ä¸‹ã€‚ 3.4 Initè¿›ç¨‹å¯åŠ¨â€‹ initè¿›ç¨‹æ˜¯Androidç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒåœ¨ç³»ç»Ÿå¯åŠ¨ä¹‹åå°±è¢«å¯åŠ¨ï¼Œå¹¶ä¸”ä¸€ç›´è¿è¡Œåˆ°ç³»ç»Ÿå…³é—­ï¼Œå®ƒæ˜¯Androidç³»ç»Ÿçš„æ ¸å¿ƒè¿›ç¨‹ï¼Œéš¶å±äºç³»ç»Ÿè¿›ç¨‹ï¼Œå…·æœ‰æœ€é«˜çš„æƒé™ï¼Œæ‰€æœ‰çš„å…¶ä»–è¿›ç¨‹éƒ½æ˜¯å®ƒçš„å­è¿›ç¨‹ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š â€‹ 1ã€å¯åŠ¨Androidç³»ç»Ÿçš„åŸºç¡€æœåŠ¡ï¼šinitè¿›ç¨‹è´Ÿè´£å¯åŠ¨Androidç³»ç»Ÿçš„åŸºç¡€æœåŠ¡ã€‚ â€‹ 2ã€ç®¡ç†ç³»ç»Ÿè¿›ç¨‹ï¼šinitè¿›ç¨‹ç®¡ç†ç³»ç»Ÿè¿›ç¨‹ï¼Œæ¯”å¦‚å¯åŠ¨å’Œå…³é—­ç³»ç»Ÿè¿›ç¨‹ã€‚ â€‹ 3ã€åŠ è½½è®¾å¤‡é©±åŠ¨ï¼šinitè¿›ç¨‹ä¼šåŠ è½½è®¾å¤‡çš„é©±åŠ¨ï¼Œä½¿è®¾å¤‡å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚ â€‹ 4ã€åŠ è½½ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼šinitè¿›ç¨‹ä¼šåŠ è½½ç³»ç»Ÿæ‰€éœ€è¦çš„ç¯å¢ƒå˜é‡ï¼Œå¦‚PATHã€LD_LIBRARY_PATHç­‰ã€‚ â€‹ 5ã€åŠ è½½ç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼šinitè¿›ç¨‹ä¼šåŠ è½½ç³»ç»Ÿæ‰€éœ€è¦çš„é…ç½®æ–‡ä»¶ã€‚ â€‹ 6ã€å¯åŠ¨ç”¨æˆ·è¿›ç¨‹ï¼šinitè¿›ç¨‹ä¼šå¯åŠ¨ç”¨æˆ·è¿›ç¨‹ï¼Œå¦‚æ¡Œé¢ç¨‹åºã€é»˜è®¤æµè§ˆå™¨ç­‰ã€‚ â€‹ initè¿›ç¨‹çš„å…¥å£æ˜¯åœ¨Androidæºç çš„system/core/init/main.cppã€‚ä¸‹é¢ï¼Œçœ‹çœ‹å…¥å£å‡½æ•°çš„å®ç°ã€‚ 1234567891011121314151617181920212223242526272829int main(int argc, char** argv) {#if __has_feature(address_sanitizer) __asan_set_error_report_callback(AsanReportCallback);#endif // Boost prio which will be restored later setpriority(PRIO_PROCESS, 0, -20); if (!strcmp(basename(argv[0]), &quot;ueventd&quot;)) { return ueventd_main(argc, argv); } if (argc &gt; 1) { if (!strcmp(argv[1], &quot;subcontext&quot;)) { android::base::InitLogging(argv, &amp;android::base::KernelLogger); const BuiltinFunctionMap&amp; function_map = GetBuiltinFunctionMap(); return SubcontextMain(argc, argv, &amp;function_map); } // ç¬¬äºŒæ­¥ è£…è½½selinuxç­–ç•¥ if (!strcmp(argv[1], &quot;selinux_setup&quot;)) { return SetupSelinux(argv); } // ç¬¬ä¸‰æ­¥ if (!strcmp(argv[1], &quot;second_stage&quot;)) { return SecondStageMain(argc, argv); } } // ç¬¬ä¸€æ­¥ æŒ‚è½½è®¾å¤‡èŠ‚ç‚¹ï¼Œåˆæ¬¡è¿›å…¥æ²¡æœ‰å‚æ•°å°†æ‰§è¡Œè¿™é‡Œ return FirstStageMain(argc, argv);} â€‹ æ ¹æ®ä¸Šä¸€ç« çš„å¯åŠ¨initçš„å‚æ•°ï¼Œå¯ä»¥åˆ¤æ–­ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶æ‰§è¡Œçš„æ˜¯FirstStageMainå‡½æ•°ï¼Œç»§ç»­çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°åˆå§‹åŒ–äº†ä¸€äº›åŸºç¡€ç³»ç»Ÿæ”¯æŒçš„ç›®å½•ï¼Œä»¥åŠä½¿ç”¨mountè¿›è¡ŒæŒ‚è½½ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445int FirstStageMain(int argc, char** argv) { ... CHECKCALL(clearenv()); CHECKCALL(setenv(&quot;PATH&quot;, _PATH_DEFPATH, 1)); // Get the basic filesystem setup we need put together in the initramdisk // on / and then we'll let the rc file figure out the rest. CHECKCALL(mount(&quot;tmpfs&quot;, &quot;/dev&quot;, &quot;tmpfs&quot;, MS_NOSUID, &quot;mode=0755&quot;)); CHECKCALL(mkdir(&quot;/dev/pts&quot;, 0755)); CHECKCALL(mkdir(&quot;/dev/socket&quot;, 0755)); CHECKCALL(mkdir(&quot;/dev/dm-user&quot;, 0755)); CHECKCALL(mount(&quot;devpts&quot;, &quot;/dev/pts&quot;, &quot;devpts&quot;, 0, NULL));#define MAKE_STR(x) __STRING(x) CHECKCALL(mount(&quot;proc&quot;, &quot;/proc&quot;, &quot;proc&quot;, 0, &quot;hidepid=2,gid=&quot; MAKE_STR(AID_READPROC)));#undef MAKE_STR // Don't expose the raw commandline to unprivileged processes. CHECKCALL(chmod(&quot;/proc/cmdline&quot;, 0440)); std::string cmdline; android::base::ReadFileToString(&quot;/proc/cmdline&quot;, &amp;cmdline); // Don't expose the raw bootconfig to unprivileged processes. chmod(&quot;/proc/bootconfig&quot;, 0440); std::string bootconfig; android::base::ReadFileToString(&quot;/proc/bootconfig&quot;, &amp;bootconfig); gid_t groups[] = {AID_READPROC}; CHECKCALL(setgroups(arraysize(groups), groups)); CHECKCALL(mount(&quot;sysfs&quot;, &quot;/sys&quot;, &quot;sysfs&quot;, 0, NULL)); CHECKCALL(mount(&quot;selinuxfs&quot;, &quot;/sys/fs/selinux&quot;, &quot;selinuxfs&quot;, 0, NULL)); CHECKCALL(mknod(&quot;/dev/kmsg&quot;, S_IFCHR | 0600, makedev(1, 11))); ... // é‡æ–°è°ƒç”¨æ‹‰èµ·initè¿›ç¨‹ï¼Œå¹¶ä¸”å‚æ•°è®¾ç½®ä¸ºselinux_setup const char* path = &quot;/system/bin/init&quot;; const char* args[] = {path, &quot;selinux_setup&quot;, nullptr}; auto fd = open(&quot;/dev/kmsg&quot;, O_WRONLY | O_CLOEXEC); dup2(fd, STDOUT_FILENO); dup2(fd, STDERR_FILENO); close(fd); // ä½¿ç”¨execvå†æ¬¡è°ƒç”¨initè¿›ç¨‹ execv(path, const_cast&lt;char**&gt;(args)); // execv() only returns if an error happened, in which case we // panic and never fall through this conditional. PLOG(FATAL) &lt;&lt; &quot;execv(\\&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\\&quot;) failed&quot;; return 1;} â€‹ åœ¨ç›®å½•åˆå§‹åŒ–å®Œæˆååˆæ‹‰èµ·äº†ä¸€ä¸ªinitè¿›ç¨‹ï¼Œå¹¶ä¸”ä¼ å…¥å‚æ•°selinux_setupï¼Œæ¥ä¸‹æ¥ï¼Œç›´æ¥çœ‹å‰é¢mainå…¥å£å‡½æ•°ä¸­åˆ¤æ–­å‡ºç°è¯¥å‚æ•°æ—¶è°ƒç”¨çš„SetupSelinuxå‡½æ•°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849int SetupSelinux(char** argv) { SetStdioToDevNull(argv); InitKernelLogging(argv); ... LOG(INFO) &lt;&lt; &quot;Opening SELinux policy&quot;; // Read the policy before potentially killing snapuserd. std::string policy; ReadPolicy(&amp;policy); auto snapuserd_helper = SnapuserdSelinuxHelper::CreateIfNeeded(); if (snapuserd_helper) { // Kill the old snapused to avoid audit messages. After this we cannot // read from /system (or other dynamic partitions) until we call // FinishTransition(). snapuserd_helper-&gt;StartTransition(); } LoadSelinuxPolicy(policy); if (snapuserd_helper) { // Before enforcing, finish the pending snapuserd transition. snapuserd_helper-&gt;FinishTransition(); snapuserd_helper = nullptr; } SelinuxSetEnforcement(); // We're in the kernel domain and want to transition to the init domain. File systems that // store SELabels in their xattrs, such as ext4 do not need an explicit restorecon here, // but other file systems do. In particular, this is needed for ramdisks such as the // recovery image for A/B devices. if (selinux_android_restorecon(&quot;/system/bin/init&quot;, 0) == -1) { PLOG(FATAL) &lt;&lt; &quot;restorecon failed of /system/bin/init failed&quot;; } setenv(kEnvSelinuxStartedAt, std::to_string(start_time.time_since_epoch().count()).c_str(), 1); // ç»§ç»­å†æ‹‰èµ·ä¸€ä¸ªinitè¿›ç¨‹,å‚æ•°è®¾ç½®second_stage const char* path = &quot;/system/bin/init&quot;; const char* args[] = {path, &quot;second_stage&quot;, nullptr}; execv(path, const_cast&lt;char**&gt;(args)); // execv() only returns if an error happened, in which case we // panic and never return from this function. PLOG(FATAL) &lt;&lt; &quot;execv(\\&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\\&quot;) failed&quot;; return 1;} â€‹ ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å®Œæˆselinuxçš„åŠ è½½å¤„ç†åï¼Œåˆæ‹‰èµ·äº†ä¸€ä¸ªinitè¿›ç¨‹ï¼Œå¹¶ä¸”ä¼ å…¥å‚æ•°second_stageã€‚æ¥ä¸‹æ¥ï¼Œçœ‹ç¬¬ä¸‰æ­¥SecondStageMainå‡½æ•°ã€‚ 123456789101112131415int SecondStageMain(int argc, char** argv) { ... // åˆå§‹åŒ–å±æ€§ç³»ç»Ÿ PropertyInit(); // å¼€å¯å±æ€§æœåŠ¡ StartPropertyService(&amp;property_fd); // è§£æinit.rc ä»¥åŠå¯åŠ¨å…¶ä»–ç›¸å…³è¿›ç¨‹ LoadBootScripts(am, sm); ... return 0;} â€‹ ç»§ç»­è·Ÿè¸ªLoadBootScriptså‡½æ•°ï¼Œäº†è§£å®ƒæ˜¯å¦‚ä½•è§£ææ‰§è¡Œinit.rcæ–‡ä»¶çš„ã€‚ï¼ˆä¿®æ”¹çš„æ„æ€æ˜¯å¦æ­£ç¡®ï¼Ÿï¼‰ 12345678910111213141516171819202122232425262728static void LoadBootScripts(ActionManager&amp; action_manager, ServiceList&amp; service_list) { Parser parser = CreateParser(action_manager, service_list); std::string bootscript = GetProperty(&quot;ro.boot.init_rc&quot;, &quot;&quot;); if (bootscript.empty()) { // è§£æå„ç›®å½•ä¸­çš„init.rc parser.ParseConfig(&quot;/system/etc/init/hw/init.rc&quot;); if (!parser.ParseConfig(&quot;/system/etc/init&quot;)) { late_import_paths.emplace_back(&quot;/system/etc/init&quot;); } // late_import is available only in Q and earlier release. As we don't // have system_ext in those versions, skip late_import for system_ext. parser.ParseConfig(&quot;/system_ext/etc/init&quot;); if (!parser.ParseConfig(&quot;/vendor/etc/init&quot;)) { late_import_paths.emplace_back(&quot;/vendor/etc/init&quot;); } if (!parser.ParseConfig(&quot;/odm/etc/init&quot;)) { late_import_paths.emplace_back(&quot;/odm/etc/init&quot;); } if (!parser.ParseConfig(&quot;/product/etc/init&quot;)) { late_import_paths.emplace_back(&quot;/product/etc/init&quot;); } } else { parser.ParseConfig(bootscript); }} â€‹ ç»§ç»­çœ‹çœ‹è§£æçš„é€»è¾‘ï¼Œå¯ä»¥çœ‹åˆ°å‚æ•°å¯ä»¥æ˜¯ç›®å½•æˆ–è€…æ–‡ä»¶ã€‚ 123456bool Parser::ParseConfig(const std::string&amp; path) { if (is_dir(path.c_str())) { return ParseConfigDir(path); } return ParseConfigFile(path);} â€‹ å¦‚æœæ˜¯ç›®å½•ï¼Œåˆ™éå†æ‰€æœ‰æ–‡ä»¶å†è°ƒç”¨è§£ææ–‡ä»¶ï¼Œæ‰€ä»¥ç›´æ¥çœ‹ParseConfigFileå°±å¥½äº†ã€‚ 12345bool Parser::ParseConfigFile(const std::string&amp; path) { ... ParseData(path, &amp;config_contents.value()); ...} â€‹ æœ€åçœ‹çœ‹ParseDataæ˜¯å¦‚ä½•è§£ææ•°æ®çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041void Parser::ParseData(const std::string&amp; filename, std::string* data) { ... for (;;) { switch (next_token(&amp;state)) { case T_EOF: ... return; case T_NEWLINE: { ... else if (section_parsers_.count(args[0])) { end_section(); // ä»section_parsers_ä¸­è·å–å‡ºæ¥çš„ section_parser = section_parsers_[args[0]].get(); section_start_line = state.line; // ä½¿ç”¨äº†ParseSectionè¿›è¡Œè§£æ if (auto result = section_parser-&gt;ParseSection(std::move(args), filename, state.line); !result.ok()) { parse_error_count_++; LOG(ERROR) &lt;&lt; filename &lt;&lt; &quot;: &quot; &lt;&lt; state.line &lt;&lt; &quot;: &quot; &lt;&lt; result.error(); section_parser = nullptr; bad_section_found = true; } } else if (section_parser) { // ä½¿ç”¨äº†ParseLineSectionè¿›è¡Œè§£æ if (auto result = section_parser-&gt;ParseLineSection(std::move(args), state.line); !result.ok()) { parse_error_count_++; LOG(ERROR) &lt;&lt; filename &lt;&lt; &quot;: &quot; &lt;&lt; state.line &lt;&lt; &quot;: &quot; &lt;&lt; result.error(); } } ... } case T_TEXT: args.emplace_back(state.text); break; } }} â€‹ ç®€å•è§£è¯»ä¸€ä¸‹è¿™é‡Œçš„ä»£ç ï¼Œé¦–å…ˆè¿™é‡Œçœ‹åˆ°ä»section_parsers_ä¸­å–å‡ºå¯¹åº”çš„èŠ‚ç‚¹è§£æå¯¹è±¡section_parserï¼Œé€šè¿‡section_parseræ‰§è¡ŒParseSectionæˆ–è€…ParseLineSectionå‡½æ•°è§£æ.rcæ–‡ä»¶ä¸­çš„æ•°æ®ã€‚æ‰€ä»¥éœ€è¦äº†è§£section_parsers_ä¸­å­˜å‚¨çš„æ˜¯ä»€ä¹ˆï¼ŒæŸ¥çœ‹å‡½æ•°CreateParserå°±æ˜ç™½äº†ã€‚æ‰€è°“çš„èŠ‚ç‚¹è§£æå¯¹è±¡ï¼Œå°±æ˜¯ServiceParserã€ActionParserã€ImportParserã€‚ 123456789101112131415void Parser::AddSectionParser(const std::string&amp; name, std::unique_ptr&lt;SectionParser&gt; parser) { section_parsers_[name] = std::move(parser);}Parser CreateParser(ActionManager&amp; action_manager, ServiceList&amp; service_list) { Parser parser; parser.AddSectionParser(&quot;service&quot;, std::make_unique&lt;ServiceParser&gt;( &amp;service_list, GetSubcontext(), std::nullopt)); parser.AddSectionParser(&quot;on&quot;, std::make_unique&lt;ActionParser&gt;(&amp;action_manager, GetSubcontext())); parser.AddSectionParser(&quot;import&quot;, std::make_unique&lt;ImportParser&gt;(&amp;parser)); return parser;} â€‹ å¦‚æœäº†è§£è¿‡init.rcæ–‡ä»¶æ ¼å¼çš„ï¼Œçœ‹åˆ°è¿™é‡Œå°±å¾ˆçœ¼ç†Ÿäº†ï¼Œè¿™å°±æ˜¯.rcæ–‡ä»¶ä¸­é…ç½®æ—¶ä½¿ç”¨çš„èŠ‚ç‚¹åç§°äº†ã€‚å®ƒä»¬çš„åŠŸèƒ½çš„ç®€å•æè¿°å¦‚ä¸‹ã€‚ service å®šä¹‰ä¸€ä¸ªæœåŠ¡ on è§¦å‘æŸä¸ªactionæ—¶ï¼Œæ‰§è¡Œå¯¹åº”çš„æŒ‡ä»¤ import è¡¨ç¤ºå¯¼å…¥å¦å¤–ä¸€ä¸ªrcæ–‡ä»¶ â€‹ å†è§£è¯»ä¸Šé¢çš„ä»£ç å°±æ˜¯ï¼Œæ ¹æ®rcæ–‡ä»¶çš„é…ç½®ä¸åŒï¼Œä½¿ç”¨ServiceParserã€ActionParserã€ImportParserè¿™ä¸‰ç§èŠ‚ç‚¹è§£æå¯¹è±¡çš„ParseSectionæˆ–è€…ParseLineSectionå‡½æ•°æ¥å¤„ç†ï¼ˆè¿™å¥ä¸å®Œæ•´ï¼Ÿï¼‰ã€‚ç»§ç»­çœ‹çœ‹è¿™ä¸‰ä¸ªå¯¹è±¡çš„è§£æå‡½æ•°å®ç°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384// serviceèŠ‚ç‚¹çš„è§£æå¤„ç†Result&lt;void&gt; ServiceParser::ParseSection(std::vector&lt;std::string&gt;&amp;&amp; args, const std::string&amp; filename, int line) { if (args.size() &lt; 3) { return Error() &lt;&lt; &quot;services must have a name and a program&quot;; } const std::string&amp; name = args[1]; if (!IsValidName(name)) { return Error() &lt;&lt; &quot;invalid service name '&quot; &lt;&lt; name &lt;&lt; &quot;'&quot;; } filename_ = filename; Subcontext* restart_action_subcontext = nullptr; if (subcontext_ &amp;&amp; subcontext_-&gt;PathMatchesSubcontext(filename)) { restart_action_subcontext = subcontext_; } std::vector&lt;std::string&gt; str_args(args.begin() + 2, args.end()); if (SelinuxGetVendorAndroidVersion() &lt;= __ANDROID_API_P__) { if (str_args[0] == &quot;/sbin/watchdogd&quot;) { str_args[0] = &quot;/system/bin/watchdogd&quot;; } } if (SelinuxGetVendorAndroidVersion() &lt;= __ANDROID_API_Q__) { if (str_args[0] == &quot;/charger&quot;) { str_args[0] = &quot;/system/bin/charger&quot;; } } service_ = std::make_unique&lt;Service&gt;(name, restart_action_subcontext, str_args, from_apex_); return {};}// on èŠ‚ç‚¹çš„è§£æå¤„ç†Result&lt;void&gt; ActionParser::ParseSection(std::vector&lt;std::string&gt;&amp;&amp; args, const std::string&amp; filename, int line) { std::vector&lt;std::string&gt; triggers(args.begin() + 1, args.end()); if (triggers.size() &lt; 1) { return Error() &lt;&lt; &quot;Actions must have a trigger&quot;; } Subcontext* action_subcontext = nullptr; if (subcontext_ &amp;&amp; subcontext_-&gt;PathMatchesSubcontext(filename)) { action_subcontext = subcontext_; } std::string event_trigger; std::map&lt;std::string, std::string&gt; property_triggers; if (auto result = ParseTriggers(triggers, action_subcontext, &amp;event_trigger, &amp;property_triggers); !result.ok()) { return Error() &lt;&lt; &quot;ParseTriggers() failed: &quot; &lt;&lt; result.error(); } auto action = std::make_unique&lt;Action&gt;(false, action_subcontext, filename, line, event_trigger, property_triggers); action_ = std::move(action); return {};}// importèŠ‚ç‚¹çš„è§£æå¤„ç†Result&lt;void&gt; ImportParser::ParseSection(std::vector&lt;std::string&gt;&amp;&amp; args, const std::string&amp; filename, int line) { if (args.size() != 2) { return Error() &lt;&lt; &quot;single argument needed for import\\n&quot;; } auto conf_file = ExpandProps(args[1]); if (!conf_file.ok()) { return Error() &lt;&lt; &quot;Could not expand import: &quot; &lt;&lt; conf_file.error(); } LOG(INFO) &lt;&lt; &quot;Added '&quot; &lt;&lt; *conf_file &lt;&lt; &quot;' to import list&quot;; if (filename_.empty()) filename_ = filename; imports_.emplace_back(std::move(*conf_file), line); return {};} â€‹ åˆ°è¿™é‡Œå¤§è‡´çš„initè¿›ç¨‹çš„å¯åŠ¨æµç¨‹ç›¸ä¿¡å¤§å®¶å·²ç»æœ‰äº†ä¸€å®šäº†è§£ã€‚æ˜ç™½initçš„åŸç†åï¼Œå¯¹äºinit.rcç›¸ä¿¡å¤§å®¶å·²ç»æœ‰äº†ç®€å•çš„å°è±¡ï¼Œæ¥ä¸‹æ¥å°†è¯¦ç»†å±•å¼€è®²è§£init.rcæ–‡ä»¶ã€‚ 3.5 init.rcâ€‹ init.rcæ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ä¸ªè„šæœ¬æ–‡ä»¶è€Œå¹¶éé…ç½®æ–‡ä»¶ï¼Œæ˜¯ä¸€ç§åä¸ºAndroid Init Languageçš„è„šæœ¬è¯­è¨€å†™æˆçš„æ–‡ä»¶ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç®€å•å½“ä½œé…ç½®æ–‡ä»¶æ¥ç†è§£ï¼Œä¸»è¦ç”¨äºå¯åŠ¨å’Œç®¡ç†Androidä¸Šçš„å…¶ä»–è¿›ç¨‹ä»¥å¯¹ç³»ç»Ÿè¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚ â€‹ å°†init.rcçœ‹ä½œæ˜¯initè¿›ç¨‹åŠŸèƒ½çš„åŠ¨æ€å»¶ç”³ï¼Œä¸€äº›å¯èƒ½éœ€è¦æ”¹åŠ¨çš„åˆå§‹åŒ–ç³»ç»Ÿä»»åŠ¡å°±æ”¾åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œç„¶åè¯»å–é…ç½®è§£æåå†è¿›è¡Œåˆå§‹åŒ–æ‰§è¡Œï¼Œå¦‚æ­¤å¯ä»¥æé«˜ä¸€å®šçš„çµæ´»æ€§ï¼Œç›¸ä¿¡å¾ˆå¤šå¼€å‘äººå‘˜åœ¨å·¥ä½œä¸­éƒ½æœ‰åšè¿‡ç±»ä¼¼çš„å°è£…ã€‚è€Œinit.rcå°±æ˜¯é…ç½®æ–‡ä»¶çš„å…¥å£ï¼Œåœ¨init.rcä¸­é€šè¿‡importèŠ‚ç‚¹æ¥å¯¼å…¥å…¶ä»–çš„é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥è¿™äº›æ–‡ä»¶éƒ½å¯ä»¥ç®—æ˜¯init.rcçš„ä¸€éƒ¨åˆ†ã€‚åœ¨ä¸Šä¸€ç« ï¼ˆç¡®å®šæ˜¯ç« ï¼Ÿï¼‰ï¼Œé€šè¿‡äº†è§£initè¿›ç¨‹çš„å·¥ä½œæµç¨‹ï¼Œæ˜ç™½äº†è§£æinit.rcæ–‡ä»¶çš„è¿‡ç¨‹ã€‚ â€‹ init.rcæ˜¯ç”±å¤šä¸ªsectionèŠ‚ç‚¹ç»„æˆçš„ï¼Œè€ŒèŠ‚ç‚¹çš„ç±»å‹åˆ†åˆ«ä¸»è¦æ˜¯serviceã€onã€importä¸‰ç§ã€‚ä¸Šä¸€èŠ‚ä¸­ï¼Œæœ‰ç®€å•çš„ä»‹ç»ï¼Œå®ƒä»¬çš„ä½œç”¨åˆ†åˆ«æ˜¯å®šä¹‰æœåŠ¡ã€äº‹ä»¶è§¦å‘ã€å¯¼å…¥å…¶ä»–rcæ–‡ä»¶ã€‚ä¸‹é¢ï¼Œæ¥çœ‹init.rcæ–‡ä»¶ä¸­çš„å‡ ä¸ªä¾‹å­ï¼ŒæŸ¥çœ‹æ–‡ä»¶system/core/rootdir/init.rcã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354// å¯¼å…¥å¦ä¸€ä¸ªrcæ–‡ä»¶import /init.environ.rcimport /system/etc/init/hw/init.usb.rcimport /init.${ro.hardware}.rcimport /vendor/etc/init/hw/init.${ro.hardware}.rcimport /system/etc/init/hw/init.usb.configfs.rcimport /system/etc/init/hw/init.${ro.zygote}.rc...// å½“åˆå§‹åŒ–è§¦å‘æ—¶,æ‰§è¡Œsectionä¸‹çš„å‘½ä»¤on init sysclktz 0 # Mix device-specific information into the entropy pool copy /proc/cmdline /dev/urandom copy /system/etc/prop.default /dev/urandom symlink /proc/self/fd/0 /dev/stdin symlink /proc/self/fd/1 /dev/stdout symlink /proc/self/fd/2 /dev/stderr # Create energy-aware scheduler tuning nodes mkdir /dev/stune/foreground...// å½“å±æ€§ro.debuggableå˜æ›´ä¸º1æ—¶è§¦å‘sectionå†…çš„å‘½ä»¤on property:ro.debuggable=1 # Give writes to anyone for the trace folder on debug builds. # The folder is used to store method traces. chmod 0773 /data/misc/trace # Give reads to anyone for the window trace folder on debug builds. chmod 0775 /data/misc/wmtrace # Give reads to anyone for the accessibility trace folder on debug builds. chmod 0775 /data/misc/a11ytrace...// å®šä¹‰ç³»ç»ŸæœåŠ¡ æœåŠ¡åç§°ueventd æœåŠ¡è·¯å¾„/system/bin/ueventd// æœåŠ¡ç±»å‹coreï¼Œå…³æœºè¡Œä¸ºcriticalï¼Œå®‰å…¨æ ‡ç­¾u:r:ueventd:s0service ueventd /system/bin/ueventd class core critical seclabel u:r:ueventd:s0 shutdown critical// å®šä¹‰ç³»ç»ŸæœåŠ¡ æœåŠ¡åç§°console æœåŠ¡è·¯å¾„/system/bin/sh// æœåŠ¡ç±»å‹core æœåŠ¡çŠ¶æ€disabled æœåŠ¡æ‰€å±ç”¨æˆ·shell æœåŠ¡æ‰€å±ç»„shell log readproc// å®‰å…¨æ ‡ç­¾u:r:shell:s0 è®¾ç½®ç¯å¢ƒå˜é‡HOSTNAME consoleservice console /system/bin/sh class core console disabled user shell group shell log readproc seclabel u:r:shell:s0 setenv HOSTNAME console â€‹ çœ‹å®Œå„ç§èŠ‚ç‚¹çš„æ ·ä¾‹åï¼Œå¤§æ¦‚äº†è§£init.rcä¸­åº”è¯¥å¦‚ä½•æ·»åŠ ä¸€ä¸ªsectionäº†ã€‚importéå¸¸ç®€å•ï¼Œåªéœ€è¦æŒ‡å®šä¸€ä¸ªrcæ–‡ä»¶çš„è·¯å¾„å³å¯ã€‚onèŠ‚ç‚¹åœ¨æºç ä¸­ï¼Œçœ‹åˆ°å¯¹åº”çš„å¤„ç†æ˜¯ActionParserï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯å½“è§¦å‘äº†ä¸€ä¸ªActionçš„äº‹ä»¶åå°±è‡ªä¸Šè€Œä¸‹ï¼Œä¾æ¬¡æ‰§è¡ŒèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å‘½ä»¤ï¼Œæ‰€ä»¥ï¼Œå°±å¾—äº†è§£ä¸€ä¸‹ä¸€å…±æœ‰å“ªäº›Actionäº‹ä»¶æä¾›ä½¿ç”¨ã€‚è¯¦ç»†ä»‹ç»å‚è€ƒè‡ªhttp://www.gaohaiyan.com/4047.html 123456789101112on boot #ç³»ç»Ÿå¯åŠ¨è§¦å‘on early-init #åœ¨åˆå§‹åŒ–ä¹‹å‰è§¦å‘on init #åœ¨åˆå§‹åŒ–æ—¶è§¦å‘ï¼ˆåœ¨å¯åŠ¨é…ç½®æ–‡ä»¶/init.confè¢«è£…è½½ä¹‹åï¼‰on late-init #åœ¨åˆå§‹åŒ–æ™šæœŸé˜¶æ®µè§¦å‘on charger #å½“å……ç”µæ—¶è§¦å‘on property:&lt;key&gt;=&lt;value&gt; #å½“å±æ€§å€¼æ»¡è¶³æ¡ä»¶æ—¶è§¦å‘on post-fs #æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿon post-fs-data #æŒ‚è½½dataon device-added-&lt;path&gt; #åœ¨æŒ‡å®šè®¾å¤‡è¢«æ·»åŠ æ—¶è§¦å‘on device-removed-&lt;path&gt; #åœ¨æŒ‡å®šè®¾å¤‡è¢«ç§»é™¤æ—¶è§¦å‘on service-exited-&lt;name&gt; #åœ¨æŒ‡å®šserviceé€€å‡ºæ—¶è§¦å‘on &lt;name&gt;=&lt;value&gt; #å½“å±æ€§&lt;name&gt;ç­‰äº&lt;value&gt;æ—¶è§¦å‘ â€‹ åœ¨è§¦å‘Actionäº‹ä»¶åå¯ä»¥æ‰§è¡Œçš„å‘½ä»¤å¦‚ä¸‹ã€‚ 1234567891011121314151617181920212223chdir &lt;dirc&gt; æ›´æ”¹å·¥ä½œç›®å½•ä¸º&lt;dirc&gt;chmod &lt;octal-mode&gt; &lt;path&gt; æ›´æ”¹æ–‡ä»¶è®¿é—®æƒé™chown &lt;owner&gt; &lt;group&gt; &lt;path&gt; æ›´æ”¹æ–‡ä»¶æ‰€æœ‰è€…å’Œç»„ç¾¤chroot &lt;direc&gt; æ›´æ”¹æ ¹ç›®å½•ä½ç½®class_start &lt;serviceclass&gt; å¦‚æœå®ƒä»¬ä¸åœ¨è¿è¡ŒçŠ¶æ€çš„è¯ï¼Œå¯åŠ¨ç”±&lt;serviceclass&gt;ç±»åæŒ‡å®šçš„æ‰€æœ‰ç›¸å…³æœåŠ¡class_stop &lt;serviceclass&gt; å¦‚æœå®ƒä»¬åœ¨è¿è¡ŒçŠ¶æ€çš„è¯ï¼Œåœæ­¢domainname &lt;name&gt; è®¾ç½®åŸŸåexec &lt;path&gt; [ &lt;argument&gt; ]* forkå¹¶æ‰§è¡Œä¸€ä¸ªç¨‹åºï¼Œå…¶è·¯å¾„ä¸º&lt;path&gt;ï¼Œè¿™æ¡å‘½ä»¤å°†é˜»å¡ç›´åˆ°è¯¥ç¨‹åºå¯åŠ¨å®Œæˆï¼Œå› æ­¤å®ƒæœ‰å¯èƒ½é€ æˆinitç¨‹åºåœ¨æŸä¸ªèŠ‚ç‚¹ä¸åœåœ°ç­‰å¾…export &lt;name&gt; &lt;value&gt; è®¾ç½®æŸä¸ªç¯å¢ƒå˜é‡&lt;name&gt;çš„å€¼ä¸º&lt;value&gt;ï¼Œè¿™æ˜¯å¯¹å…¨å±€æœ‰æ•ˆçš„ï¼Œå³å…¶åæ‰€æœ‰è¿›ç¨‹éƒ½å°†ç»§æ‰¿è¿™ä¸ªå˜é‡hostname &lt;name&gt; è®¾ç½®ä¸»æœºåifup &lt;interface&gt; ä½¿ç½‘ç»œæ¥å£&lt;interface&gt;æˆåŠŸè¿æ¥import &lt;filename&gt; å¼•å…¥ä¸€ä¸ªåä¸º&lt;filename&gt;çš„æ–‡ä»¶insmod &lt;path&gt; åœ¨&lt;path&gt;è·¯å¾„ä¸Šå®‰è£…ä¸€ä¸ªæ¨¡å—mkdir &lt;path&gt; [mode] [owner] [group] åœ¨&lt;path&gt;è·¯å¾„ä¸Šæ–°å»ºä¸€ä¸ªç›®å½•mount &lt;type&gt; &lt;device&gt; &lt;dir&gt; [&lt;mountoption&gt;]* å°è¯•åœ¨æŒ‡å®šè·¯å¾„ä¸ŠæŒ‚è½½ä¸€ä¸ªè®¾å¤‡setprop &lt;name&gt; &lt;value&gt; è®¾ç½®ç³»ç»Ÿå±æ€§&lt;name&gt;çš„å€¼ä¸º&lt;value&gt;setrlinit &lt;resource&gt; &lt;cur&gt; &lt;max&gt; è®¾ç½®ä¸€ç§èµ„æºçš„ä½¿ç”¨é™åˆ¶ã€‚è¿™ä¸ªæ¦‚å¿µäº¦å­˜åœ¨äºLinuxç³»ç»Ÿä¸­ï¼Œ&lt;cur&gt;è¡¨ç¤ºè½¯é™åˆ¶ï¼Œ&lt;max&gt;è¡¨ç¤ºç¡¬é™åˆ¶start &lt;service&gt; å¯åŠ¨ä¸€ä¸ªæœåŠ¡stop &lt;service&gt; åœæ­¢ä¸€ä¸ªæœåŠ¡symlink &lt;target&gt; &lt;path&gt; åˆ›å»ºä¸€ä¸ª&lt;path&gt;è·¯å¾„çš„è½¯é“¾æ¥ï¼Œç›®æ ‡ä¸º&lt;target&gt;sysclk &lt;mins_west_of_gmt&gt; è®¾ç½®åŸºå‡†æ—¶é—´ï¼Œå¦‚æœå½“å‰æ—¶é—´æ—¶GMTï¼Œè¿™ä¸ªå€¼æ˜¯0trigger &lt;event&gt; è§¦å‘ä¸€ä¸ªäº‹ä»¶write &lt;path&gt; &lt;string&gt; [&lt;string&gt;]* æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶å†™å…¥å­—ç¬¦ä¸² â€‹ è€ŒserviceèŠ‚ç‚¹ä¸»è¦æ˜¯å°†å¯æ‰§è¡Œç¨‹åºä½œä¸ºæœåŠ¡å¯åŠ¨ï¼Œä¸Šé¢çš„ä¾‹å­ï¼Œçœ‹åˆ°èŠ‚ç‚¹ä¸‹é¢æœ‰ä¸€ç³»åˆ—çš„å‚æ•°ï¼Œä¸‹é¢æ˜¯è¿™äº›å‚æ•°çš„è¯¦ç»†æè¿°ã€‚ 12345678910class &lt;name&gt; ä¸ºè¯¥æœåŠ¡æŒ‡å®šä¸€ä¸ªclassåï¼ŒåŒä¸€ä¸ªclassçš„æ‰€æœ‰æœåŠ¡å¿…é¡»åŒæ—¶å¯åŠ¨æˆ–è€…åœæ­¢ã€‚ é»˜è®¤æƒ…å†µä¸‹æœåŠ¡çš„classåæ˜¯â€œdefaultâ€ã€‚å¦å¤–è¿˜æœ‰core(å…¶å®ƒæœåŠ¡ä¾èµ–çš„åŸºç¡€æ€§æ ¸å¿ƒæœåŠ¡)ã€main(javaé¡»è¦çš„åŸºæœ¬æœåŠ¡)ã€late_start(å‚å•†å®šåˆ¶çš„æœåŠ¡)critical è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¯¹è®¾å¤‡è‡³å…³é‡è¦çš„ä¸€ä¸ªæœåŠ¡ï¼Œå¦‚æœå®ƒåœ¨å››åˆ†é’Ÿå†…é€€å‡ºè¶…è¿‡å››æ¬¡ï¼Œåˆ™è®¾å¤‡å°†é‡å¯è¿›å…¥æ¢å¤æ¨¡å¼disabled æ­¤æœåŠ¡ä¸ä¼šè‡ªåŠ¨å¯åŠ¨ï¼Œè€Œæ˜¯éœ€è¦é€šè¿‡æ˜¾å¼è°ƒç”¨æœåŠ¡åæ¥å¯åŠ¨group &lt;groupname&gt; [&lt;groupname&gt;]* åœ¨å¯åŠ¨æœåŠ¡å‰å°†ç”¨æˆ·ç»„åˆ‡æ¢ä¸º&lt;groupname&gt;oneshot åªå¯åŠ¨ä¸€æ¬¡ï¼Œå½“æ­¤æœåŠ¡é€€å‡ºæ—¶ï¼Œä¸è¦ä¸»åŠ¨å»é‡å¯å®ƒonrestart å½“æ­¤æœåŠ¡é‡å¯æ—¶ï¼Œæ‰§è¡ŒæŸäº›å‘½ä»¤setenv &lt;name&gt; &lt;value&gt; è®¾ç½®ç¯å¢ƒå˜é‡&lt;name&gt;ä¸ºæŸä¸ªå€¼&lt;value&gt;socket &lt;name&gt; &lt;type&gt; &lt;perm&gt; [ &lt;user&gt; [&lt;group&gt;]] åˆ›å»ºä¸€ä¸ªåä¸º/dev/socket/&lt;name&gt;çš„unix domain socketï¼Œç„¶åå°†å®ƒçš„fdå€¼ä¼ ç»™å¯åŠ¨å®ƒçš„è¿›ç¨‹ï¼Œæœ‰æ•ˆçš„&lt;type&gt;å€¼åŒ…æ‹¬dgramï¼Œstreamå’Œseqacketï¼Œè€Œuserå’Œgroupçš„é»˜è®¤å€¼æ˜¯0user &lt;username&gt; åœ¨å¯åŠ¨æœåŠ¡å‰å°†ç”¨æˆ·ç»„åˆ‡æ¢ä¸º&lt;username&gt;ï¼Œé»˜è®¤æƒ…å†µä¸‹ç”¨æˆ·éƒ½æ˜¯root â€‹ åˆ°è¿™é‡Œï¼Œç›¸ä¿¡å¤§å®¶åº”è¯¥èƒ½å¤Ÿçœ‹æ‡‚init.rcä¸­çš„å¤§å¤šæ•°sectionçš„å«ä¹‰äº†ã€‚ä¸‹é¢çš„ä¾‹å­å°†ç»„åˆä½¿ç”¨ï¼Œå®šä¹‰ä¸€ä¸ªè‡ªå·±çš„æœåŠ¡ï¼Œå¹¶ä¸”å¯åŠ¨å®ƒã€‚ 12345678910service kservice /system/bin/app_process -Djava.class.path=/system/framework/ksvr.jar /system/bin cn.ksvr.kSystemSvr svr class main user root group root oneshot seclabel u:r:su:s0on property:sys.boot_completed=1 bootchart stop start kservice â€‹ ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªkserviceçš„æœåŠ¡ï¼Œä½¿ç”¨/system/bin/app_processä½œä¸ºè¿›ç¨‹å¯åŠ¨ï¼Œå¹¶è®¾ç½®ç›®æ ‡jarä½œä¸ºåº”ç”¨çš„classpathï¼Œæœ€åè®¾ç½®jaræ–‡ä»¶çš„å…¥å£ç±»cn.ksvr.kSystemSvrï¼Œæœ€åçš„svræ˜¯åšä¸ºå‚æ•°ä¼ é€’ç»™kSystemSvrä¸­çš„mainå‡½æ•°ã€‚æ¥ä¸‹æ¥æ˜¯å½“å±æ€§sys.boot_completedå˜æ›´ä¸º1æ—¶è¡¨ç¤ºæ‰‹æœºå®Œæˆå¼•å¯¼ï¼Œæ‰§è¡ŒèŠ‚ç‚¹ä¸‹çš„å‘½ä»¤å¯åŠ¨åˆšåˆšå®šä¹‰çš„æœåŠ¡ã€‚ 3.6 Zygoteå¯åŠ¨â€‹ äº†è§£init.rcå®šä¹‰çš„åŸç†åï¼Œå°±å¯ä»¥ç»§ç»­é˜…è¯»init.rcè¿½è¸ªåç»­çš„å¯åŠ¨æµç¨‹äº†ã€‚ 1234567891011121314151617181920# å¯¼å…¥å«æœ‰zygoteæœåŠ¡å®šä¹‰çš„rcæ–‡ä»¶ï¼Œè¿™ä¸ªä¼šæ ¹æ®ç³»ç»Ÿæ‰€æ”¯æŒçš„å¯¹åº”æ¶æ„å¯¼å…¥import /system/etc/init/hw/init.${ro.zygote}.rc# initå®Œæˆåè§¦å‘zygote-startäº‹ä»¶on late-init ... # Now we can start zygote for devices with file based encryption trigger zygote-start ...# zygote-startäº‹ä»¶è§¦å‘æ—¶æ‰§è¡Œçš„èŠ‚ç‚¹ã€‚æœ€åå¯åŠ¨äº†zygoteå’Œzygote_secondaryon zygote-start &amp;&amp; property:ro.crypto.state=unencrypted wait_for_prop odsign.verification.done 1 # A/B update verifier that marks a successful boot. exec_start update_verifier_nonencrypted start statsd start netd start zygote start zygote_secondary â€‹ zygoteæœåŠ¡å®šä¹‰çš„rcæ–‡ä»¶åœ¨è·¯å¾„system/core/rootdir/ä¸­ã€‚åˆ†åˆ«æ˜¯init.zygote32.rcã€init.zygote64.rcã€init.zygote32_64.rcã€init.zygote64_32.rcï¼Œä¸‹é¢æŸ¥çœ‹zygote64çš„æ˜¯å¦‚ä½•å®šä¹‰çš„ã€‚ 123456789101112131415161718// --zygote ä¼ é€’ç»™app_processç¨‹åºçš„å‚æ•°,è¡¨ç¤ºè¿™æ˜¯å¯åŠ¨ä¸€ä¸ªå­µåŒ–å™¨ã€‚// --start-system-server ä¼ é€’ç»™app_processç¨‹åºçš„å‚æ•°ï¼Œè¡¨ç¤ºè¿›ç¨‹å¯åŠ¨åéœ€è¦å¯åŠ¨system_serverè¿›ç¨‹service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond writepid /dev/cpuset/foreground/tasks critical window=${zygote.critical_window.minute:-off} target=zygote-fatal â€‹ ä»å®šä¹‰ä¸­å¯ä»¥çœ‹åˆ°zygoteè¿›ç¨‹å®é™…å¯åŠ¨çš„å°±æ˜¯app_processè¿›ç¨‹ã€‚ â€‹ app_processæ˜¯Androidç³»ç»Ÿçš„ä¸»è¦è¿›ç¨‹ï¼Œå®ƒæ˜¯å…¶ä»–æ‰€æœ‰åº”ç”¨ç¨‹åºçš„å®¹å™¨ï¼Œå®ƒè´Ÿè´£åˆ›å»ºæ–°çš„è¿›ç¨‹ï¼Œå¹¶å¯åŠ¨å®ƒä»¬ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜ç®¡ç†åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢ä»»ä½•ä¸€ä¸ªåº”ç”¨ç¨‹åºå ç”¨èµ„æºè¿‡å¤šï¼Œæˆ–è€…åšå‡ºä¸è‰¯å½±å“ã€‚app_processè¿˜è´Ÿè´£åœ¨åº”ç”¨è¿è¡Œæ—¶ä¸ºå®ƒä»¬æä¾›ä¸Šä¸‹æ–‡ï¼Œä»¥åŠç®¡ç†åº”ç”¨è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚ â€‹ è·Ÿè¸ªapp_processçš„å®ç°ï¼Œå®ƒçš„å…¥å£æ˜¯åœ¨ç›®å½•frameworks/base/cmds/app_process/app_main.cppä¸­ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556#if defined(__LP64__)static const char ABI_LIST_PROPERTY[] = &quot;ro.product.cpu.abilist64&quot;;static const char ZYGOTE_NICE_NAME[] = &quot;zygote64&quot;;#elsestatic const char ABI_LIST_PROPERTY[] = &quot;ro.product.cpu.abilist32&quot;;static const char ZYGOTE_NICE_NAME[] = &quot;zygote&quot;;#endifint main(int argc, char* const argv[]){ ... // Parse runtime arguments. Stop at first unrecognized option. bool zygote = false; bool startSystemServer = false; bool application = false; String8 niceName; String8 className; ++i; // Skip unused &quot;parent dir&quot; argument. // å‚æ•°çš„å¤„ç† while (i &lt; argc) { const char* arg = argv[i++]; if (strcmp(arg, &quot;--zygote&quot;) == 0) { zygote = true; niceName = ZYGOTE_NICE_NAME; } else if (strcmp(arg, &quot;--start-system-server&quot;) == 0) { startSystemServer = true; } else if (strcmp(arg, &quot;--application&quot;) == 0) { application = true; } else if (strncmp(arg, &quot;--nice-name=&quot;, 12) == 0) { niceName.setTo(arg + 12); } else if (strncmp(arg, &quot;--&quot;, 2) != 0) { className.setTo(arg); break; } else { --i; break; } } ... if (!niceName.isEmpty()) { runtime.setArgv0(niceName.string(), true /* setProcName */); } // å¦‚æœå¯åŠ¨æ—¶è®¾ç½®--zygoteï¼Œåˆ™å¯åŠ¨ZygoteInitï¼Œå¦åˆ™å¯åŠ¨RuntimeInit if (zygote) { const char* zygoteName=&quot;com.android.internal.os.ZygoteInit&quot;; runtime.start(zygoteName, args, zygote); } else if (className) { const char* zygoteName=&quot;com.android.internal.os.RuntimeInit&quot;; runtime.start(zygoteName, args, zygote); } else { fprintf(stderr, &quot;Error: no class name or --zygote supplied.\\n&quot;); app_usage(); LOG_ALWAYS_FATAL(&quot;app_process: no class name or --zygote supplied.&quot;); }} â€‹ ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ä¸»è¦æ˜¯å¯¹å‚æ•°è¿›è¡Œå¤„ç†åŒ…è£…åï¼Œç„¶åæ ¹æ®æ˜¯å¦æºå¸¦--zygoteé€‰æ‹©å¯åŠ¨ZygoteInitæˆ–è€…æ˜¯RuntimeInitã€‚ â€‹ ZygoteInitè´Ÿè´£åŠ è½½å’Œåˆå§‹åŒ–Androidè¿è¡Œæ—¶ç¯å¢ƒï¼Œä¾‹å¦‚åº”ç”¨ç¨‹åºè¿è¡Œå™¨ã€åƒåœ¾æ”¶é›†å™¨ç­‰ï¼Œå¹¶ä¸”å®ƒå¯åŠ¨Androidç³»ç»Ÿä¸­çš„æ‰€æœ‰æ ¸å¿ƒæœåŠ¡ã€‚ â€‹ RuntimeInitè´Ÿè´£è”ç³»åº”ç”¨ç¨‹åºçš„æ‰§è¡Œç¯å¢ƒä¸ç³»ç»Ÿçš„è¿è¡Œç¯å¢ƒï¼Œç„¶åå°†åº”ç”¨ç¨‹åºçš„ä¸»ç±»åŠ è½½åˆ°è¿è¡Œæ—¶ï¼Œæœ€åå°†åº”ç”¨ç¨‹åºçš„æ§åˆ¶æƒäº¤ç»™åº”ç”¨ç¨‹åºçš„ä¸»ç±»ã€‚ â€‹ ä¸‹é¢ç»§ç»­çœ‹çœ‹runtime.startçš„å®ç°ï¼ŒæŸ¥çœ‹å¯¹åº”æ–‡ä»¶frameworks/base/core/jni/AndroidRuntime.cpp 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152void AndroidRuntime::start(const char* className, const Vector&lt;String8&gt;&amp; options, bool zygote){ ... //const char* kernelHack = getenv(&quot;LD_ASSUME_KERNEL&quot;); //ALOGD(&quot;Found LD_ASSUME_KERNEL='%s'\\n&quot;, kernelHack); /* å¯åŠ¨vmè™šæ‹Ÿæœº */ JniInvocation jni_invocation; jni_invocation.Init(NULL); JNIEnv* env; if (startVm(&amp;mJavaVM, &amp;env, zygote, primary_zygote) != 0) { return; } onVmCreated(env); /* * æ³¨å†Œæ¡†æ¶ä½¿ç”¨çš„JNIè°ƒç”¨ */ if (startReg(env) &lt; 0) { ALOGE(&quot;Unable to register all android natives\\n&quot;); return; } ... char* slashClassName = toSlashClassName(className != NULL ? className : &quot;&quot;); jclass startClass = env-&gt;FindClass(slashClassName); if (startClass == NULL) { ALOGE(&quot;JavaVM unable to locate class '%s'\\n&quot;, slashClassName); /* keep going */ } else { // è¿™é‡Œè°ƒç”¨ZygoteInitæˆ–è€…æ˜¯RuntimeInitçš„mainå‡½æ•° jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, &quot;main&quot;, &quot;([Ljava/lang/String;)V&quot;); if (startMeth == NULL) { ALOGE(&quot;JavaVM unable to find main() in '%s'\\n&quot;, className); /* keep going */ } else { env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);#if 0 if (env-&gt;ExceptionCheck()) threadExitUncaughtException(env);#endif } } free(slashClassName); ALOGD(&quot;Shutting down VM\\n&quot;); if (mJavaVM-&gt;DetachCurrentThread() != JNI_OK) ALOGW(&quot;Warning: unable to detach main thread\\n&quot;); if (mJavaVM-&gt;DestroyJavaVM() != 0) ALOGW(&quot;Warning: VM did not shut down cleanly\\n&quot;);} â€‹ é€šè¿‡JNIå‡½æ•°CallStaticVoidMethodè°ƒç”¨äº†ZygoteInitçš„mainå…¥å£å‡½æ•°ï¼Œç°åœ¨å°±æ¥åˆ°äº†javaå±‚ä¸­ï¼ŒæŸ¥çœ‹æ–‡ä»¶ä»£ç frameworks/base/core/java/com/android/internal/os/ZygoteInit.java 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public static void main(String[] argv) { ZygoteServer zygoteServer = null; ... try { ... if (!enableLazyPreload) { bootTimingsTraceLog.traceBegin(&quot;ZygotePreload&quot;); EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START, SystemClock.uptimeMillis()); // é¢„åŠ è½½èµ„æºï¼Œæ¯”å¦‚ç±»ã€ä¸»é¢˜èµ„æºã€å­—ä½“èµ„æºç­‰ç­‰ preload(bootTimingsTraceLog); EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END, SystemClock.uptimeMillis()); bootTimingsTraceLog.traceEnd(); // ZygotePreload } ... Zygote.initNativeState(isPrimaryZygote); ZygoteHooks.stopZygoteNoThreadCreation(); // åˆ›å»ºsocketæœåŠ¡ç«¯ zygoteServer = new ZygoteServer(isPrimaryZygote); // å‰é¢åœ¨init.rcä¸­æœ‰é…ç½®--start-system-serverçš„è¿›ç¨‹åˆ™ä¼šè¿›å…¥forkå¯åŠ¨SystemServer if (startSystemServer) { Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer); // {@code r == null} in the parent (zygote) process, and {@code r != null} in the // child (system_server) process. if (r != null) { r.run(); return; } } Log.i(TAG, &quot;Accepting command socket connections&quot;); // socketæœåŠ¡ç«¯ç­‰å¾…AMSçš„è¯·æ±‚ï¼Œæ”¶åˆ°è¯·æ±‚åå°±ä¼šç”±ZygoteæœåŠ¡ç«¯æ¥é€šè¿‡forkåˆ›å»ºåº”ç”¨ç¨‹åºçš„è¿›ç¨‹ caller = zygoteServer.runSelectLoop(abiList); } catch (Throwable ex) { Log.e(TAG, &quot;System zygote died with fatal exception&quot;, ex); throw ex; } finally { if (zygoteServer != null) { zygoteServer.closeServerSocket(); } } // We're in the child process and have exited the select loop. Proceed to execute the // command. if (caller != null) { caller.run(); } } â€‹ è¿™é‡Œçš„é‡ç‚¹æ˜¯åˆ›å»ºäº†zygoteServerï¼Œç„¶åæ ¹æ®å‚æ•°å†³å®šæ˜¯å¦forkSystemServerï¼Œæœ€årunSelectLoopç­‰å¾…AMSå‘é€æ¶ˆæ¯åˆ›å»ºåº”ç”¨ç¨‹åºçš„è¿›ç¨‹ã€‚ä¾æ¬¡ä»ä»£ç è§‚å¯Ÿå®ƒä»¬çš„æœ¬è´¨ã€‚é¦–å…ˆæ˜¯ZygoteServerçš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦æ˜¯åˆ›å»ºSocketå¥—æ¥å­—ã€‚ 123456789101112131415161718ZygoteServer(boolean isPrimaryZygote) { mUsapPoolEventFD = Zygote.getUsapPoolEventFD(); if (isPrimaryZygote) { mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME); mUsapPoolSocket = Zygote.createManagedSocketFromInitSocket( Zygote.USAP_POOL_PRIMARY_SOCKET_NAME); } else { mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME); mUsapPoolSocket = Zygote.createManagedSocketFromInitSocket( Zygote.USAP_POOL_SECONDARY_SOCKET_NAME); } mUsapPoolSupported = true; fetchUsapPoolPolicyProps(); } â€‹ æ¥ç€åˆ†æforkSystemServerï¼Œç›®çš„æ˜¯äº†è§£è¿”å›å€¼åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œè¿”å›å€¼çš„r.run()ä¼šè°ƒç”¨åˆ°å“ªé‡Œã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147private static Runnable forkSystemServer(String abiList, String socketName, ZygoteServer zygoteServer) { // æœåŠ¡å¯åŠ¨çš„ç›¸å…³å‚æ•°ï¼Œè¿™é‡Œæ³¨æ„åˆ°ç±»åæ˜¯com.android.server.SystemServer String[] args = { &quot;--setuid=1000&quot;, &quot;--setgid=1000&quot;, &quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,&quot; + &quot;1024,1032,1065,3001,3002,3003,3006,3007,3009,3010,3011&quot;, &quot;--capabilities=&quot; + capabilities + &quot;,&quot; + capabilities, &quot;--nice-name=system_server&quot;, &quot;--runtime-args&quot;, &quot;--target-sdk-version=&quot; + VMRuntime.SDK_VERSION_CUR_DEVELOPMENT, &quot;com.android.server.SystemServer&quot;, }; ZygoteArguments parsedArgs; int pid; try { ... // ä½¿ç”¨forkåˆ›å»ºä¸€ä¸ªSystemServerè¿›ç¨‹ /* Request to fork the system server process */ pid = Zygote.forkSystemServer( parsedArgs.mUid, parsedArgs.mGid, parsedArgs.mGids, parsedArgs.mRuntimeFlags, null, parsedArgs.mPermittedCapabilities, parsedArgs.mEffectiveCapabilities); } catch (IllegalArgumentException ex) { throw new RuntimeException(ex); } /* For child process */ if (pid == 0) { if (hasSecondZygote(abiList)) { waitForSecondaryZygote(socketName); } zygoteServer.closeServerSocket(); // pidä¸º0çš„éƒ¨åˆ†ï¼Œå°±æ˜¯ç”±è¿™é‡Œforkå‡ºæ¥çš„SystemServeræ‰§è¡Œçš„äº†ã€‚ return handleSystemServerProcess(parsedArgs); } return null; }private static Runnable handleSystemServerProcess(ZygoteArguments parsedArgs) { ... ClassLoader cl = getOrCreateSystemServerClassLoader(); if (cl != null) { Thread.currentThread().setContextClassLoader(cl); } // åˆå§‹åŒ–SystemServer return ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion, parsedArgs.mDisabledCompatChanges, parsedArgs.mRemainingArgs, cl); ...}public static Runnable zygoteInit(int targetSdkVersion, long[] disabledCompatChanges, String[] argv, ClassLoader classLoader) { ... // ç»§ç»­è·Ÿè¿›å» return RuntimeInit.applicationInit(targetSdkVersion, disabledCompatChanges, argv, classLoader); }protected static Runnable applicationInit(int targetSdkVersion, long[] disabledCompatChanges, String[] argv, ClassLoader classLoader) { ... // åå°„è·å–com.android.server.SystemServerçš„å…¥å£å‡½æ•°å¹¶è¿”å› return findStaticMain(args.startClass, args.startArgs, classLoader);}// å¯ä»¥çœ‹åˆ°å°±æ˜¯é€šè¿‡åå°„ï¼Œè·å–åˆ°å¯¹åº”ç±»çš„mainå‡½æ•°ï¼Œæœ€åå°è£…åˆ°MethodAndArgsCallerè¿”å›protected static Runnable findStaticMain(String className, String[] argv, ClassLoader classLoader) { Class&lt;?&gt; cl; try { cl = Class.forName(className, true, classLoader); } catch (ClassNotFoundException ex) { throw new RuntimeException( &quot;Missing class when invoking static main &quot; + className, ex); } Method m; try { m = cl.getMethod(&quot;main&quot;, new Class[] { String[].class }); } catch (NoSuchMethodException ex) { throw new RuntimeException( &quot;Missing static main on &quot; + className, ex); } catch (SecurityException ex) { throw new RuntimeException( &quot;Problem getting static main on &quot; + className, ex); } int modifiers = m.getModifiers(); if (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) { throw new RuntimeException( &quot;Main method is not public and static on &quot; + className); } /* * This throw gets caught in ZygoteInit.main(), which responds * by invoking the exception's run() method. This arrangement * clears up all the stack frames that were required in setting * up the process. */ return new MethodAndArgsCaller(m, argv);}// forkSystemServeræœ€ç»ˆè¿”å›çš„å°±æ˜¯MethodAndArgsCallerå¯¹è±¡static class MethodAndArgsCaller implements Runnable { /** method to call */ private final Method mMethod; /** argument array */ private final String[] mArgs; public MethodAndArgsCaller(Method method, String[] args) { mMethod = method; mArgs = args; } public void run() { try { mMethod.invoke(null, new Object[] { mArgs }); } catch (IllegalAccessException ex) { throw new RuntimeException(ex); } catch (InvocationTargetException ex) { Throwable cause = ex.getCause(); if (cause instanceof RuntimeException) { throw (RuntimeException) cause; } else if (cause instanceof Error) { throw (Error) cause; } throw new RuntimeException(ex); } }} â€‹ forkSystemServerå‡½æ•°èµ°åˆ°æœ€åæ˜¯é€šè¿‡åå°„è·å–com.android.server.SystemServerçš„å…¥å£å‡½æ•°mainï¼Œå¹¶å°è£…åˆ°MethodAndArgsCallerå¯¹è±¡ä¸­è¿”å›ã€‚æœ€åçš„è¿”å›ç»“æœè°ƒç”¨runæ—¶ï¼Œå°±ä¼šæ‰§è¡Œåˆ°SystemServerä¸­çš„mainå‡½æ•°ã€‚ç»§ç»­çœ‹çœ‹mainå‡½æ•°çš„å®ç°ï¼ŒæŸ¥çœ‹æ–‡ä»¶frameworks/base/services/java/com/android/server/SystemServer.java 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384public static void main(String[] args) { new SystemServer().run();}private void run() { ... // åˆ›å»ºä¸»çº¿ç¨‹Looper Looper.prepareMainLooper(); // åˆå§‹åŒ–ç³»ç»ŸContextä¸Šä¸‹æ–‡ createSystemContext(); // åˆ›å»ºSystemServiceManagerï¼Œç”±å®ƒç®¡ç†ç³»ç»Ÿçš„æ‰€æœ‰æœåŠ¡ mSystemServiceManager = new SystemServiceManager(mSystemContext); mSystemServiceManager.setStartInfo(mRuntimeRestart, mRuntimeStartElapsedTime, mRuntimeStartUptime); mDumper.addDumpable(mSystemServiceManager); LocalServices.addService(SystemServiceManager.class, mSystemServiceManager); ... // å¯åŠ¨å„ç§æœåŠ¡ try { t.traceBegin(&quot;StartServices&quot;); // å¯åŠ¨å¼•å¯¼æœåŠ¡ startBootstrapServices(t); // å¯åŠ¨æ ¸å¿ƒæœåŠ¡ startCoreServices(t); // å¯åŠ¨å…¶ä»–æœåŠ¡ startOtherServices(t); } catch (Throwable ex) { Slog.e(&quot;System&quot;, &quot;******************************************&quot;); Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex); throw ex; } finally { t.traceEnd(); // StartServices } ... // Loop forever. Looper.loop();}// å¯åŠ¨è´Ÿè´£å¼•å¯¼çš„æœåŠ¡private void startBootstrapServices(@NonNull TimingsTraceAndSlog t) { t.traceBegin(&quot;startBootstrapServices&quot;); ... // å¯åŠ¨ActivityManagerService t.traceBegin(&quot;StartActivityManager&quot;); ActivityTaskManagerService atm = mSystemServiceManager.startService( ActivityTaskManagerService.Lifecycle.class).getService(); mActivityManagerService = ActivityManagerService.Lifecycle.startService( mSystemServiceManager, atm); mActivityManagerService.setSystemServiceManager(mSystemServiceManager); mActivityManagerService.setInstaller(installer); mWindowManagerGlobalLock = atm.getGlobalLock(); t.traceEnd(); ...}private void startOtherServices(@NonNull TimingsTraceAndSlog t) { t.traceBegin(&quot;startOtherServices&quot;); ... // ä»systemReadyå¼€å§‹å¯ä»¥å¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨ mActivityManagerService.systemReady(() -&gt; { ... }, t); ...}// æœ€åçœ‹çœ‹systemReadyçš„å¤„ç†// frameworks/base/services/java/com/android/server/am/ActivitymanagerService.javapublic void systemReady(final Runnable goingCallback, @NonNull TimingsTraceAndSlog t) { ... Slog.i(TAG, &quot;System now ready&quot;); ... // å¯åŠ¨å¤šç”¨æˆ·ä¸‹çš„Home Activityï¼Œæœ€ç»ˆä¼šå¼€å¯ç³»ç»Ÿåº”ç”¨Luncheræ¡Œé¢æ˜¾ç¤º if (bootingSystemUser) { t.traceBegin(&quot;startHomeOnAllDisplays&quot;); mAtmInternal.startHomeOnAllDisplays(currentUserId, &quot;systemReady&quot;); t.traceEnd(); } ...} â€‹ åˆ°è¿™é‡Œå¤§è‡´çš„æœåŠ¡å¯åŠ¨æµç¨‹å°±æ¸…æ¥šäº†ï¼Œæœ€åæˆåŠŸæŠµè¾¾äº†Luncherçš„å¯åŠ¨ï¼Œé‡æ–°å›åˆ°æµç¨‹ä¸­ï¼Œç»§ç»­çœ‹çœ‹runSelectLoopå‡½æ•°æ˜¯å¦‚ä½•å®ç°çš„ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243Runnable runSelectLoop(String abiList) { ... socketFDs.add(mZygoteSocket.getFileDescriptor()); peers.add(null); mUsapPoolRefillTriggerTimestamp = INVALID_TIMESTAMP; while (true) { fetchUsapPoolPolicyPropsWithMinInterval(); mUsapPoolRefillAction = UsapPoolRefillAction.NONE; int[] usapPipeFDs = null; StructPollfd[] pollFDs; int pollReturnValue; try { pollReturnValue = Os.poll(pollFDs, pollTimeoutMs); } catch (ErrnoException ex) { throw new RuntimeException(&quot;poll failed&quot;, ex); } ... if (mUsapPoolRefillAction != UsapPoolRefillAction.NONE) { int[] sessionSocketRawFDs = socketFDs.subList(1, socketFDs.size()) .stream() .mapToInt(FileDescriptor::getInt$) .toArray(); final boolean isPriorityRefill = mUsapPoolRefillAction == UsapPoolRefillAction.IMMEDIATE; final Runnable command = fillUsapPool(sessionSocketRawFDs, isPriorityRefill); if (command != null) { return command; } else if (isPriorityRefill) { // Schedule a delayed refill to finish refilling the pool. mUsapPoolRefillTriggerTimestamp = System.currentTimeMillis(); } } } } â€‹ é‡ç‚¹ä¸»è¦æ”¾åœ¨è¿”å›å€¼çš„è·Ÿè¸ªä¸Šï¼Œç›´æ¥çœ‹fillUsapPoolå‡½æ•°åšäº†äº›ä»€ä¹ˆ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869Runnable fillUsapPool(int[] sessionSocketRawFDs, boolean isPriorityRefill) { ... while (--numUsapsToSpawn &gt;= 0) { Runnable caller = Zygote.forkUsap(mUsapPoolSocket, sessionSocketRawFDs, isPriorityRefill); if (caller != null) { return caller; } } ... return null; }// ç»§ç»­è¿½è¸ªå…³é”®è¿”å›å€¼çš„å‡½æ•°forkUsap// å¯¹åº”æ–‡ä»¶frameworks/base/core/java/com/android/internal/os/Zygote.javastatic @Nullable Runnable forkUsap(LocalServerSocket usapPoolSocket, int[] sessionSocketRawFDs, boolean isPriorityFork) { FileDescriptor readFD; FileDescriptor writeFD; try { FileDescriptor[] pipeFDs = Os.pipe2(O_CLOEXEC); readFD = pipeFDs[0]; writeFD = pipeFDs[1]; } catch (ErrnoException errnoEx) { throw new IllegalStateException(&quot;Unable to create USAP pipe.&quot;, errnoEx); } // è¿™é‡Œforkå‡ºä¸€ä¸ªå­è¿›ç¨‹å¹¶åˆå§‹åŒ–ä¿¡æ¯ï¼Œæœ€åè¿”å›pid int pid = nativeForkApp(readFD.getInt$(), writeFD.getInt$(), sessionSocketRawFDs, /*argsKnown=*/ false, isPriorityFork); if (pid == 0) { IoUtils.closeQuietly(readFD); // å¦‚æœæ˜¯å­è¿›ç¨‹å°±è°ƒç”¨childMainè·å–è¿”å›å€¼ return childMain(null, usapPoolSocket, writeFD); } else if (pid == -1) { // Fork failed. return null; } else { // readFD will be closed by the native code. See removeUsapTableEntry(); IoUtils.closeQuietly(writeFD); nativeAddUsapTableEntry(pid, readFD.getInt$()); return null; } }// ç»§ç»­çœ‹childMainçš„å®ç°private static Runnable childMain(@Nullable ZygoteCommandBuffer argBuffer, @Nullable LocalServerSocket usapPoolSocket, FileDescriptor writePipe) { ... // åˆå§‹åŒ–åº”ç”¨ç¨‹åºç¯å¢ƒï¼Œè®¾ç½®åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼Œåˆå§‹åŒ–åº”ç”¨ç¨‹åºçº¿ç¨‹ç­‰ç­‰ specializeAppProcess(args.mUid, args.mGid, args.mGids, args.mRuntimeFlags, rlimits, args.mMountExternal, args.mSeInfo, args.mNiceName, args.mStartChildZygote, args.mInstructionSet, args.mAppDataDir, args.mIsTopApp, args.mPkgDataInfoList, args.mAllowlistedDataInfoList, args.mBindMountAppDataDirs, args.mBindMountAppStorageDirs); Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); // åˆçœ‹åˆ°è¿™ä¸ªäº†ï¼Œåœ¨SystemServerçš„å¯åŠ¨ä¸­ï¼Œä¹‹å‰è¿½è¸ªè¿‡ // è¿™é‡Œæœ€åæ˜¯åå°„è·å–æŸä¸ªjavaç±»çš„mainå‡½æ•°å°è£…åè¿”å› return ZygoteInit.zygoteInit(args.mTargetSdkVersion, args.mDisabledCompatChanges, args.mRemainingArgs, null /* classLoader */); } â€‹ å‰é¢åˆ†æè¿‡äº†zygoteInitå‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸éœ€è¦å†ç»§ç»­è¿›å»çœ‹äº†ï¼Œçœ‹çœ‹å­µåŒ–å™¨è¿›ç¨‹æ˜¯å¦‚ä½•åˆå§‹åŒ–åº”ç”¨ç¨‹åºç¯å¢ƒçš„ï¼Œè¿½è¸ªspecializeAppProcesså‡½æ•°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283private static void specializeAppProcess(int uid, int gid, int[] gids, int runtimeFlags, int[][] rlimits, int mountExternal, String seInfo, String niceName, boolean startChildZygote, String instructionSet, String appDataDir, boolean isTopApp, String[] pkgDataInfoList, String[] allowlistedDataInfoList, boolean bindMountAppDataDirs, boolean bindMountAppStorageDirs) { // å‚æ•°ä¼ é€’åˆ°äº†nativeå±‚è¿›è¡Œåˆå§‹åŒ–å¤„ç†äº†ã€‚ nativeSpecializeAppProcess(uid, gid, gids, runtimeFlags, rlimits, mountExternal, seInfo, niceName, startChildZygote, instructionSet, appDataDir, isTopApp, pkgDataInfoList, allowlistedDataInfoList, bindMountAppDataDirs, bindMountAppStorageDirs); ... }// ç»§ç»­æŸ¥çœ‹nativeSpecializeAppProcess// æ–‡ä»¶æ‰€åœ¨frameworks/base/core/jni/com_android_internal_os_Zygote.cppstatic void com_android_internal_os_Zygote_nativeSpecializeAppProcess( JNIEnv* env, jclass, jint uid, jint gid, jintArray gids, jint runtime_flags, jobjectArray rlimits, jint mount_external, jstring se_info, jstring nice_name, jboolean is_child_zygote, jstring instruction_set, jstring app_data_dir, jboolean is_top_app, jobjectArray pkg_data_info_list, jobjectArray allowlisted_data_info_list, jboolean mount_data_dirs, jboolean mount_storage_dirs) { jlong capabilities = CalculateCapabilities(env, uid, gid, gids, is_child_zygote); SpecializeCommon(env, uid, gid, gids, runtime_flags, rlimits, capabilities, capabilities, mount_external, se_info, nice_name, false, is_child_zygote == JNI_TRUE, instruction_set, app_data_dir, is_top_app == JNI_TRUE, pkg_data_info_list, allowlisted_data_info_list, mount_data_dirs == JNI_TRUE, mount_storage_dirs == JNI_TRUE);}// ç»§ç»­æŸ¥çœ‹SpecializeCommonå®ç°static void SpecializeCommon(JNIEnv* env, uid_t uid, gid_t gid, jintArray gids, jint runtime_flags, jobjectArray rlimits, jlong permitted_capabilities, jlong effective_capabilities, jint mount_external, jstring managed_se_info, jstring managed_nice_name, bool is_system_server, bool is_child_zygote, jstring managed_instruction_set, jstring managed_app_data_dir, bool is_top_app, jobjectArray pkg_data_info_list, jobjectArray allowlisted_data_info_list, bool mount_data_dirs, bool mount_storage_dirs) { const char* process_name = is_system_server ? &quot;system_server&quot; : &quot;zygote&quot;; auto fail_fn = std::bind(ZygoteFailure, env, process_name, managed_nice_name, _1); auto extract_fn = std::bind(ExtractJString, env, process_name, managed_nice_name, _1); auto se_info = extract_fn(managed_se_info); auto nice_name = extract_fn(managed_nice_name); auto instruction_set = extract_fn(managed_instruction_set); auto app_data_dir = extract_fn(managed_app_data_dir); // åœ¨è¿™é‡Œçš„nick_nameå°±æ˜¯åº”ç”¨çš„åŒ…åäº† const char* nice_name_ptr = nice_name.has_value() ? nice_name.value().c_str() : nullptr; // å¦‚æœæ˜¯ç³»ç»ŸæœåŠ¡ï¼Œå°±åˆå§‹åŒ–ç³»ç»ŸæœåŠ¡çš„classloader if (is_system_server) { // Prefetch the classloader for the system server. This is done early to // allow a tie-down of the proper system server selinux domain. env-&gt;CallStaticObjectMethod(gZygoteInitClass, gGetOrCreateSystemServerClassLoader); if (env-&gt;ExceptionCheck()) { // Be robust here. The Java code will attempt to create the classloader // at a later point (but may not have rights to use AoT artifacts). env-&gt;ExceptionClear(); } } ... if (selinux_android_setcontext(uid, is_system_server, se_info_ptr, nice_name_ptr) == -1) { fail_fn(CREATE_ERROR(&quot;selinux_android_setcontext(%d, %d, \\&quot;%s\\&quot;, \\&quot;%s\\&quot;) failed&quot;, uid, is_system_server, se_info_ptr, nice_name_ptr)); } // Make it easier to debug audit logs by setting the main thread's name to the // nice name rather than &quot;app_process&quot;. if (nice_name.has_value()) { SetThreadName(nice_name.value()); } else if (is_system_server) { SetThreadName(&quot;system_server&quot;); } // è°ƒç”¨javaå±‚çš„callPostForkChildHookså‡½æ•° // è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨æ¥åœ¨æ–°åˆ›å»ºçš„å­è¿›ç¨‹ä¸­è°ƒç”¨å›è°ƒå‡½æ•°è¿›è¡Œåˆå§‹åŒ–ã€‚ env-&gt;CallStaticVoidMethod(gZygoteClass, gCallPostForkChildHooks, runtime_flags, is_system_server, is_child_zygote, managed_instruction_set); ...} â€‹ å¯ä»¥åœ¨è¿™é‡Œæ’å…¥ä¸€ä¸ªæ—¥å¿—ï¼Œçœ‹çœ‹åœ¨androidå¯åŠ¨å®Œæˆæ—¶ï¼Œå­µåŒ–å‡ºäº†å“ªäº›è¿›ç¨‹ã€‚ 123env-&gt;CallStaticVoidMethod(gZygoteClass, gCallPostForkChildHooks, runtime_flags, is_system_server, is_child_zygote, managed_instruction_set);ALOGW(&quot;start CallStaticVoidMethod current process:%s&quot;, nice_name_ptr); â€‹ ç„¶åç¼–è¯‘aospååˆ·å…¥æ‰‹æœºä¸­ã€‚ 1234567891011121314// æ‰§è¡Œè„šæœ¬åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒsource ./build/envsetup.sh// é€‰æ‹©è¦ç¼–è¯‘çš„ç‰ˆæœ¬lunch aosp_blueline-userdebug// å¤šçº¿ç¨‹ç¼–è¯‘make -j$(nproc --all)// è®¾ç½®åˆ·æœºç›®å½•export ANDROID_PRODUCT_OUT=~/android_src/out/target/product/blueline// æ‰‹æœºé‡å¯è¿›å…¥bootloaderadb reboot bootloader// æŸ¥çœ‹æ‰‹æœºæ˜¯å¦å·²ç»è¿›å…¥bootloaderäº†fastboot devices// å°†åˆšåˆšç¼–è¯‘çš„ç³»ç»Ÿåˆ·å…¥æ‰‹æœºfastboot flashall -w ä½¿ç”¨android studioçš„logcatæŸ¥çœ‹æ—¥å¿—ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨å‘½ä»¤adb logcat &gt; tmp.logå°†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œå†è¿›è¡Œè§‚å¯Ÿã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647system_process W start CallStaticVoidMethod current process:(null)com.android.bluetooth W start CallStaticVoidMethod current process:com.android.bluetoothcom.android.systemui W start CallStaticVoidMethod current process:com.android.systemuipid-2292 W start CallStaticVoidMethod current process:WebViewLoader-armeabi-v7apid-2293 W start CallStaticVoidMethod current process:WebViewLoader-arm64-v8acom.android.networkstack W start CallStaticVoidMethod current process:com.android.networkstack.processcom.qualcomm.qti.telephonyservice W start CallStaticVoidMethod current process:com.qualcomm.qti.telephonyservicepid-2401 W start CallStaticVoidMethod current process:webview_zygotecom.android.se W start CallStaticVoidMethod current process:com.android.secom.android.phone W start CallStaticVoidMethod current process:com.android.phonecom.android.settings W start CallStaticVoidMethod current process:com.android.settingsandroid.ext.services W start CallStaticVoidMethod current process:android.ext.servicescom.android.launcher3 W start CallStaticVoidMethod current process:com.android.launcher3com....cellbroadcastreceiver.module W start CallStaticVoidMethod current process:com.android.cellbroadcastreceiver.modulecom.android.carrierconfig W start CallStaticVoidMethod current process:com.android.carrierconfigcom.android.providers.blockednumber W start CallStaticVoidMethod current process:android.process.acorepid-2859 W start CallStaticVoidMethod current process:com.android.deskclockpid-2899 W start CallStaticVoidMethod current process:com.android.nfcpid-2927 W start CallStaticVoidMethod current process:com.android.keychainpid-2944 W start CallStaticVoidMethod current process:com.android.providers.media.modulepid-3028 W start CallStaticVoidMethod current process:com.android.quicksearchboxpid-3059 W start CallStaticVoidMethod current process:com.android.printspoolerpid-3077 W start CallStaticVoidMethod current process:com.android.musicpid-3112 W start CallStaticVoidMethod current process:com.android.traceurpid-3145 W start CallStaticVoidMethod current process:com.android.dialerpid-3151 W start CallStaticVoidMethod current process:android.process.mediapid-3213 W start CallStaticVoidMethod current process:com.android.calendarpid-3230 W start CallStaticVoidMethod current process:com.android.imsserviceentitlementpid-3256 W start CallStaticVoidMethod current process:com.android.camera2pid-3277 W start CallStaticVoidMethod current process:com.android.contactspid-3302 W start CallStaticVoidMethod current process:com.android.dynsystempid-3322 W start CallStaticVoidMethod current process:com.android.dynsystem:dynsystempid-3337 W start CallStaticVoidMethod current process:com.android.inputmethod.latinpid-3359 W start CallStaticVoidMethod current process:com.android.managedprovisioningpid-3380 W start CallStaticVoidMethod current process:com.android.messagingpid-3413 W start CallStaticVoidMethod current process:com.android.onetimeinitializerpid-3436 W start CallStaticVoidMethod current process:com.android.packageinstallerpid-3455 W start CallStaticVoidMethod current process:com.android.permissioncontrollerpid-3480 W start CallStaticVoidMethod current process:com.android.providers.calendarpid-3503 W start CallStaticVoidMethod current process:com.android.settingspid-3504 W start CallStaticVoidMethod current process:com.android.localtransportpid-3545 W start CallStaticVoidMethod current process:com.android.shellpid-3568 W start CallStaticVoidMethod current process:com.android.statementservicepid-3595 W start CallStaticVoidMethod current process:com.android.quicksearchboxpid-3615 W start CallStaticVoidMethod current process:com.android.cellbroadcastreceiver.modulepid-3638 W start CallStaticVoidMethod current process:com.android.externalstorage â€‹ ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°system_processè¿›ç¨‹æ˜¯å­µåŒ–å‡ºæ¥çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œæ¥ç€å­µåŒ–äº†ä¸€å †ç³»ç»Ÿç›¸å…³çš„è¿›ç¨‹ï¼ŒåŒ…æ‹¬launcheræ¡Œé¢åº”ç”¨ç®¡ç†çš„ç³»ç»Ÿåº”ç”¨ã€‚ â€‹ æ ¹æ®å‰æ–‡çœ‹åˆ°çš„ä¸€ç³»åˆ—çš„æºç ï¼Œåˆ†æåå¾—å‡ºä»¥ä¸‹å‡ ä¸ªç»“è®º zygoteå¯åŠ¨å®é™…æ˜¯å¯åŠ¨app_processè¿›ç¨‹ã€‚ ç”±initè¿›ç¨‹è§£æinit.rcæ—¶å¯åŠ¨äº†ç¬¬ä¸€ä¸ªzygoteè¿›ç¨‹ã€‚ åœ¨ç¬¬ä¸€ä¸ªzygoteè¿›ç¨‹ä¸­åˆ›å»ºçš„ZygoteServerï¼Œå¹¶å¼€å§‹ç›‘å¬æ¶ˆæ¯ã€‚ å…¶ä»–zygoteè¿›ç¨‹æ˜¯åœ¨ZygoteServerè¿™ä¸ªæœåŠ¡ä¸­æ”¶åˆ°æ¶ˆæ¯åï¼Œå†å»forkå‡ºçš„æ–°è¿›ç¨‹ã€‚ æ‰€æœ‰è¿›ç¨‹å‡æ¥è‡ªäºzygoteè¿›ç¨‹çš„forkè€Œæ¥ï¼Œæ‰€ä»¥zygoteæ˜¯è¿›ç¨‹çš„å§‹ç¥–ã€‚ â€‹ ç»“åˆè§‚æµ‹åˆ°çš„ä»£ç æµç¨‹ï¼Œå†çœ‹ä¸‹é¢çš„ä¸€ä¸ªæ±‡æ€»å›¾ã€‚ä¸éœ€è¦å®Œå…¨ç†è§£å¯åŠ¨è¿‡ç¨‹ä¸­çš„æ‰€æœ‰çš„å¤„ç†ï¼Œé‡ç‚¹æ˜¯åœ¨è¿™é‡Œç•™ä¸‹ä¸€ä¸ªå¤§è‡´çš„å°è±¡ä»¥åŠç®€å•çš„æ•´ç†ã€‚ 3.7 Android appåº”ç”¨å¯åŠ¨â€‹ ç»è¿‡ä¸€ç³»åˆ—çš„ä»£ç è·Ÿè¸ªï¼Œå­¦ä¹ äº†androidæ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Œç³»ç»ŸæœåŠ¡æ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Œè¿›ç¨‹æ˜¯å¦‚ä½•å¯åŠ¨ã€‚ç›¸ä¿¡å¤§å®¶ä¹Ÿå¥½å¥‡ï¼Œå½“ç‚¹å‡»æ‰“å¼€ä¸€ä¸ªåº”ç”¨åï¼Œç³»ç»Ÿåšäº†ä¸€ç³»åˆ—çš„ä»€ä¹ˆå·¥ä½œï¼Œæœ€ç»ˆæ‰“å¼€äº†è¿™ä¸ªappï¼Œè°ƒç”¨åˆ°MainActivityçš„onCreateçš„å‘¢ã€‚ â€‹ å½“AndroidæˆåŠŸè¿›å…¥ç³»ç»Ÿåï¼Œåœ¨ä¸»ç•Œé¢ä¸­æ˜¾ç¤ºçš„æ¡Œé¢æ˜¯ä¸€ä¸ªå«åšLauncherçš„ç³»ç»Ÿåº”ç”¨ï¼Œå®ƒæ˜¯ç”¨æ¥æ˜¾ç¤ºç³»ç»Ÿä¸­å·²ç»å®‰è£…çš„åº”ç”¨ç¨‹åºï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯çš„å›¾æ ‡ä½œä¸ºå¿«æ·æ–¹å¼æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œå½“ç”¨æˆ·ç‚¹å‡»å›¾æ ‡æ—¶ï¼ŒLauncherå°±ä¼šå¯åŠ¨å¯¹åº”çš„åº”ç”¨ã€‚åœ¨å‰æ–‡ä¸­ï¼Œä»forkSystemServerçš„æµç¨‹ä¸­ï¼Œæœ€åèƒ½çœ‹åˆ°ç³»ç»Ÿå¯åŠ¨å‡†å¤‡å°±ç»ªåæ‹‰èµ·äº†Launcherçš„åº”ç”¨ã€‚ â€‹ Launcheræ˜¯å¦‚ä½•æ‰“å¼€ä¸€ä¸ªåº”ç”¨çš„å‘¢ï¼Ÿå…¶å®Launcheræœ¬èº«å°±æ˜¯ä½œä¸ºç¬¬ä¸€ä¸ªåº”ç”¨åœ¨ç³»ç»Ÿå¯åŠ¨åé¦–å…ˆæ‰“å¼€çš„ï¼Œæ—¢ç„¶Launcherå°±æ˜¯åº”ç”¨ã€‚é‚£ä¹ˆåœ¨æ‰‹æœºä¸Šçœ‹åˆ°å„ç§åº”ç”¨çš„å›¾æ ‡ï¼Œå°±æ˜¯å®ƒè¯»å–åˆ°éœ€è¦å±•ç¤ºçš„æ•°æ®ï¼Œç„¶åå¸ƒå±€å±•ç¤ºå‡ºæ¥çš„ï¼Œç‚¹å‡»åæ‰“å¼€åº”ç”¨ï¼Œå°±æ˜¯ç»™æ¯ä¸ªitemè®¾ç½®çš„ç‚¹å‡»äº‹ä»¶è¿›è¡Œå¤„ç†çš„ã€‚æ¥ç€ï¼Œæ¥çœ‹çœ‹è¿™ä¸ªLauncheråº”ç”¨çš„æºç ã€‚ â€‹ æŸ¥çœ‹ä»£ç frameworks/base/core/java/android/app/LauncherActivity.javaã€‚ 123456789public abstract class LauncherActivity extends ListActivity { ... @Override protected void onListItemClick(ListView l, View v, int position, long id) { Intent intent = intentForPosition(position); startActivity(intent); } ...} â€‹ å¦‚æœä½ æ˜¯ä¸€åandroidå¼€å‘äººå‘˜ï¼Œç›¸ä¿¡ä½ å¯¹startActivityè¿™ä¸ªå‡½æ•°éå¸¸ç†Ÿæ‚‰äº†ï¼Œä½†æ˜¯startActivityæ˜¯å¦‚ä½•æ‰“å¼€ä¸€ä¸ªåº”ç”¨çš„å‘¢ï¼Œå¾ˆå¤šäººä¸ä¼šæ·±å…¥äº†è§£ï¼Œæœ‰äº†å‰æ–‡ä¸­çš„ä¸€ç³»åˆ—åŸºç¡€é“ºå«ï¼Œè¿™æ—¶ä½ å·²ç»èƒ½å°è¯•è¿½è¸ªè°ƒç”¨é“¾äº†ã€‚ç°åœ¨ï¼Œç»§ç»­æ·±å…¥æŒ–æ˜startActivityçš„åŸç†ã€‚ â€‹ æŸ¥çœ‹ä»£ç frameworks/base/core/java/android/app/Activity.javaã€‚ 1234567891011public void startActivity(Intent intent, @Nullable Bundle options) { ... if (options != null) { startActivityForResult(intent, -1, options); } else { // Note we want to go through this call for compatibility with // applications that may have overridden the method. startActivityForResult(intent, -1); } } â€‹ ç»§ç»­è¿½è¸ªstartActivityForResultçš„å®ç°ã€‚ 123456789101112131415161718192021// ç»§ç»­è¿½è¸ªstartActivityForResultpublic void startActivityForResult( String who, Intent intent, int requestCode, @Nullable Bundle options) { Uri referrer = onProvideReferrer(); if (referrer != null) { intent.putExtra(Intent.EXTRA_REFERRER, referrer); } options = transferSpringboardActivityOptions(options); // è¿è¡ŒActivity Instrumentation.ActivityResult ar = mInstrumentation.execStartActivity( this, mMainThread.getApplicationThread(), mToken, who, intent, requestCode, options); if (ar != null) { mMainThread.sendActivityResult( mToken, who, requestCode, ar.getResultCode(), ar.getResultData()); } cancelInputsAndStartExitTransition(options); } â€‹ æ¥ä¸‹æ¥çš„å…³é”®å‡½æ•°æ˜¯execStartActivityï¼Œç»§ç»­æ·±å…¥ 123456789101112131415161718192021// ç»§ç»­è¿½è¸ªexecStartActivitypublic ActivityResult execStartActivity( Context who, IBinder contextThread, IBinder token, Activity target, Intent intent, int requestCode, Bundle options) { ... try { intent.migrateExtraStreamToClipData(who); intent.prepareToLeaveProcess(who); // å¯åŠ¨Activity int result = ActivityTaskManager.getService().startActivity(whoThread, who.getOpPackageName(), who.getAttributionTag(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != null ? target.mEmbeddedID : null, requestCode, 0, null, options); checkStartActivityResult(result, intent); } catch (RemoteException e) { throw new RuntimeException(&quot;Failure from system&quot;, e); } return null; } â€‹ ActivityTaskManagerä¸‹çš„serviceè°ƒç”¨çš„startActivityã€‚ â€‹ æŸ¥çœ‹ä»£ç frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java 1234567891011121314151617181920212223242526272829303132public final int startActivity(IApplicationThread caller, String callingPackage, String callingFeatureId, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle bOptions) { return startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType, resultTo, resultWho, requestCode, startFlags, profilerInfo, bOptions, UserHandle.getCallingUserId());}private int startActivityAsUser(IApplicationThread caller, String callingPackage, @Nullable String callingFeatureId, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle bOptions, int userId, boolean validateIncomingUser) { ... return getActivityStartController().obtainStarter(intent, &quot;startActivityAsUser&quot;) .setCaller(caller) .setCallingPackage(callingPackage) .setCallingFeatureId(callingFeatureId) .setResolvedType(resolvedType) .setResultTo(resultTo) .setResultWho(resultWho) .setRequestCode(requestCode) .setStartFlags(startFlags) .setProfilerInfo(profilerInfo) .setActivityOptions(bOptions) .setUserId(userId) .execute(); } â€‹ å…ˆçœ‹çœ‹obtainStarterè¿”å›çš„å¯¹è±¡ç±»å‹ã€‚ 123ActivityStarter obtainStarter(Intent intent, String reason) { return mFactory.obtain().setIntent(intent).setReason(reason); } â€‹ çœ‹åˆ°è¿”å›çš„æ˜¯ActivityStarterç±»å‹ï¼Œæ¥ç€æ‰¾åˆ°å¯¹åº”çš„excuteçš„å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103// å¤„ç† Activity å¯åŠ¨è¯·æ±‚çš„æ¥å£int execute() { ... res = executeRequest(mRequest); ... }// å„ç§æƒé™æ£€æŸ¥ï¼Œåˆæ³•çš„è¯·æ±‚åˆ™ç»§ç»­private int executeRequest(Request request) { ... mLastStartActivityResult = startActivityUnchecked(r, sourceRecord, voiceSession, request.voiceInteractor, startFlags, true /* doResume */, checkedOptions, inTask, restrictedBgActivity, intentGrants); ... }private int startActivityUnchecked(final ActivityRecord r, ActivityRecord sourceRecord, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, int startFlags, boolean doResume, ActivityOptions options, Task inTask, boolean restrictedBgActivity, NeededUriGrants intentGrants) { ... Trace.traceBegin(Trace.TRACE_TAG_WINDOW_MANAGER, &quot;startActivityInner&quot;); result = startActivityInner(r, sourceRecord, voiceSession, voiceInteractor, startFlags, doResume, options, inTask, restrictedBgActivity, intentGrants); ... }int startActivityInner(final ActivityRecord r, ActivityRecord sourceRecord, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, int startFlags, boolean doResume, ActivityOptions options, Task inTask, boolean restrictedBgActivity, NeededUriGrants intentGrants) { ... // åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸º Activity åˆ›å»ºæ–°çš„ Task mTargetRootTask.startActivityLocked(mStartActivity, topRootTask != null ? topRootTask.getTopNonFinishingActivity() : null, newTask, mKeepCurTransition, mOptions, sourceRecord); // å¦‚æœéœ€è¦æ¢å¤ Activity if (mDoResume) { final ActivityRecord topTaskActivity = mStartActivity.getTask().topRunningActivityLocked(); // åˆ¤æ–­å½“å‰ Activity æ˜¯å¦å¯è§ä»¥åŠæ˜¯å¦éœ€è¦æš‚åœåå° Activity if (!mTargetRootTask.isTopActivityFocusable() || (topTaskActivity != null &amp;&amp; topTaskActivity.isTaskOverlay() &amp;&amp; mStartActivity != topTaskActivity)) { ... } else { // å¦‚æœå½“å‰ Activity å¯è§ï¼Œåˆ™å°†å…¶ç§»åŠ¨åˆ°å‰å° if (mTargetRootTask.isTopActivityFocusable() &amp;&amp; !mRootWindowContainer.isTopDisplayFocusedRootTask(mTargetRootTask)) { mTargetRootTask.moveToFront(&quot;startActivityInner&quot;); } // æ¢å¤å¤„äºç„¦ç‚¹çŠ¶æ€çš„ Activity çš„é¡¶éƒ¨ Activity mRootWindowContainer.resumeFocusedTasksTopActivities( mTargetRootTask, mStartActivity, mOptions, mTransientLaunch); } } ... }// æ¢å¤å¤„äºç„¦ç‚¹çŠ¶æ€çš„ Activity çš„é¡¶éƒ¨ Activityã€‚boolean resumeFocusedTasksTopActivities( Task targetRootTask, ActivityRecord target, ActivityOptions targetOptions, boolean deferPause) { ... // éå†æ‰€æœ‰æ˜¾ç¤ºå™¨ for (int displayNdx = getChildCount() - 1; displayNdx &gt;= 0; --displayNdx) { final DisplayContent display = getChildAt(displayNdx); ... // è·å–å½“å‰ç„¦ç‚¹æ‰€åœ¨çš„ä»»åŠ¡æ ¹èŠ‚ç‚¹ final Task focusedRoot = display.getFocusedRootTask(); // å¦‚æœæœ‰ä»»åŠ¡æ ¹èŠ‚ç‚¹ï¼Œåˆ™æ¢å¤ä»»åŠ¡æ ¹èŠ‚ç‚¹ä¸­é¡¶éƒ¨çš„ Activity if (focusedRoot != null) { result |= focusedRoot.resumeTopActivityUncheckedLocked(target, targetOptions); } else if (targetRootTask == null) { // å¦‚æœæ²¡æœ‰ç„¦ç‚¹ä»»åŠ¡æ ¹èŠ‚ç‚¹ï¼Œå¹¶ä¸”ç›®æ ‡ä»»åŠ¡æ ¹èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™æ¢å¤ Home Activity result |= resumeHomeActivity(null /* prev */, &quot;no-focusable-task&quot;, display.getDefaultTaskDisplayArea()); } } return result; }// æ¢å¤ä½äºä»»åŠ¡æ ¹èŠ‚ç‚¹é¡¶éƒ¨çš„ Activityboolean resumeTopActivityUncheckedLocked(ActivityRecord prev, ActivityOptions options, boolean deferPause) { ... someActivityResumed = resumeTopActivityInnerLocked(prev, options, deferPause); ... }// æ¢å¤ä½äºä»»åŠ¡æ ¹èŠ‚ç‚¹é¡¶éƒ¨çš„ Activityã€‚private boolean resumeTopActivityInnerLocked(ActivityRecord prev, ActivityOptions options, boolean deferPause) { ... mTaskSupervisor.startSpecificActivity(next, true, true); ... return true; } â€‹ startSpecificActivityå°†å¯åŠ¨æŒ‡å®šçš„Activityã€‚ 1234567891011121314151617181920212223242526void startSpecificActivity(ActivityRecord r, boolean andResume, boolean checkConfig) { // æ˜¯å¦å·²ç»æœ‰è¿›ç¨‹åœ¨è¿è¡Œè¿™ä¸ªåº”ç”¨ç¨‹åº? final WindowProcessController wpc = mService.getProcessController(r.processName, r.info.applicationInfo.uid); boolean knownToBeDead = false; // å¦‚æœåº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œåˆ™ç›´æ¥å¯åŠ¨ Activity if (wpc != null &amp;&amp; wpc.hasThread()) { try { realStartActivityLocked(r, wpc, andResume, checkConfig); return; } catch (RemoteException e) { Slog.w(TAG, &quot;Exception when starting activity &quot; + r.intent.getComponent().flattenToShortString(), e); } // If a dead object exception was thrown -- fall through to // restart the application. knownToBeDead = true; } // é€šçŸ¥ Keyguard æ­£åœ¨å¯åŠ¨ä¸€ä¸ªä¸ç¡®å®šçš„ Activityï¼ˆä»…åœ¨ Keyguard è½¬æ¢æœŸé—´ä½¿ç”¨ï¼‰ r.notifyUnknownVisibilityLaunchedForKeyguardTransition(); // å¦‚æœåº”ç”¨ç¨‹åºæœªè¿è¡Œï¼Œåˆ™å¼‚æ­¥å¯åŠ¨æ–°è¿›ç¨‹ final boolean isTop = andResume &amp;&amp; r.isTopRunningActivity(); mService.startProcessAsync(r, knownToBeDead, isTop, isTop ? &quot;top-activity&quot; : &quot;activity&quot;); } â€‹ ä¸»è¦å…³æ³¨å¼€å¯ä¸€ä¸ªæ–°åº”ç”¨çš„æµç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œåªè¿½è¸ªstartProcessAsyncè°ƒç”¨å³å¯ã€‚ 1234567891011121314151617void startProcessAsync(ActivityRecord activity, boolean knownToBeDead, boolean isTop, String hostingType) { try { if (Trace.isTagEnabled(TRACE_TAG_WINDOW_MANAGER)) { Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, &quot;dispatchingStartProcess:&quot; + activity.processName); } // Post message to start process to avoid possible deadlock of calling into AMS with the // ATMS lock held. final Message m = PooledLambda.obtainMessage(ActivityManagerInternal::startProcess, mAmInternal, activity.processName, activity.info.applicationInfo, knownToBeDead, isTop, hostingType, activity.intent.getComponent()); mH.sendMessage(m); } finally { Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER); } } â€‹ ä¸Šé¢å¼€å¯æ–°è¿›ç¨‹çš„ä»£ç æ˜¯å¼‚æ­¥å‘é€æ¶ˆæ¯ç»™äº†ActivityManagerServiceã€‚æ‰¾åˆ°AMSä¸­å¯¹åº”çš„startProcessã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114@Overridepublic void startProcess(String processName, ApplicationInfo info, boolean knownToBeDead, boolean isTop, String hostingType, ComponentName hostingName) { try { if (Trace.isTagEnabled(Trace.TRACE_TAG_ACTIVITY_MANAGER)) { Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;startProcess:&quot; + processName); } synchronized (ActivityManagerService.this) { // If the process is known as top app, set a hint so when the process is // started, the top priority can be applied immediately to avoid cpu being // preempted by other processes before attaching the process of top app. startProcessLocked(processName, info, knownToBeDead, 0 /* intentFlags */, new HostingRecord(hostingType, hostingName, isTop), ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE, false /* allowWhileBooting */, false /* isolated */); } } finally { Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); }}// ç»§ç»­è¿½è¸ªstartProcessLockedfinal ProcessRecord startProcessLocked(String processName, ApplicationInfo info, boolean knownToBeDead, int intentFlags, HostingRecord hostingRecord, int zygotePolicyFlags, boolean allowWhileBooting, boolean isolated) { return mProcessList.startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingRecord, zygotePolicyFlags, allowWhileBooting, isolated, 0 /* isolatedUid */, null /* ABI override */, null /* entryPoint */, null /* entryPointArgs */, null /* crashHandler */);}// åœ¨è¿™é‡Œåˆå§‹åŒ–äº†ä¸€å †è¿›ç¨‹ä¿¡æ¯ï¼Œç„¶åè°ƒç”¨äº†å¦ä¸€ä¸ªé‡è½½// å¹¶ä¸”æ³¨æ„entryPointèµ‹å€¼android.app.ActivityThreadboolean startProcessLocked(ProcessRecord app, HostingRecord hostingRecord, int zygotePolicyFlags, boolean disableHiddenApiChecks, boolean disableTestApiChecks, String abiOverride) { ... // the PID of the new process, or else throw a RuntimeException. final String entryPoint = &quot;android.app.ActivityThread&quot;; return startProcessLocked(hostingRecord, entryPoint, app, uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi, instructionSet, invokeWith, startTime);}//boolean startProcessLocked(HostingRecord hostingRecord, String entryPoint, ProcessRecord app, int uid, int[] gids, int runtimeFlags, int zygotePolicyFlags, int mountExternal, String seInfo, String requiredAbi, String instructionSet, String invokeWith, long startTime) { ... final Process.ProcessStartResult startResult = startProcess(hostingRecord, entryPoint, app, uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi, instructionSet, invokeWith, startTime); handleProcessStartedLocked(app, startResult.pid, startResult.usingWrapper, startSeq, false); ... return app.getPid() &gt; 0;}// ç»§ç»­æŸ¥çœ‹startProcessprivate Process.ProcessStartResult startProcess(HostingRecord hostingRecord, String entryPoint, ProcessRecord app, int uid, int[] gids, int runtimeFlags, int zygotePolicyFlags, int mountExternal, String seInfo, String requiredAbi, String instructionSet, String invokeWith, long startTime) { ... final Process.ProcessStartResult startResult; boolean regularZygote = false; // è¿™é‡Œæ ¹æ®åº”ç”¨æƒ…å†µä½¿ç”¨ä¸åŒç±»å‹çš„zygoteæ¥å¯åŠ¨è¿›ç¨‹ if (hostingRecord.usesWebviewZygote()) { startResult = startWebView(entryPoint, app.processName, uid, uid, gids, runtimeFlags, mountExternal, app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet, app.info.dataDir, null, app.info.packageName, app.getDisabledCompatChanges(), new String[]{PROC_START_SEQ_IDENT + app.getStartSeq()}); } else if (hostingRecord.usesAppZygote()) { final AppZygote appZygote = createAppZygoteForProcessIfNeeded(app); // We can't isolate app data and storage data as parent zygote already did that. startResult = appZygote.getProcess().start(entryPoint, app.processName, uid, uid, gids, runtimeFlags, mountExternal, app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet, app.info.dataDir, null, app.info.packageName, /*zygotePolicyFlags=*/ ZYGOTE_POLICY_FLAG_EMPTY, isTopApp, app.getDisabledCompatChanges(), pkgDataInfoMap, allowlistedAppDataInfoMap, false, false, new String[]{PROC_START_SEQ_IDENT + app.getStartSeq()}); } else { regularZygote = true; startResult = Process.start(entryPoint, app.processName, uid, uid, gids, runtimeFlags, mountExternal, app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet, app.info.dataDir, invokeWith, app.info.packageName, zygotePolicyFlags, isTopApp, app.getDisabledCompatChanges(), pkgDataInfoMap, allowlistedAppDataInfoMap, bindMountAppsData, bindMountAppStorageDirs, new String[]{PROC_START_SEQ_IDENT + app.getStartSeq()}); } if (!regularZygote) { // webview and app zygote don't have the permission to create the nodes if (Process.createProcessGroup(uid, startResult.pid) &lt; 0) { Slog.e(ActivityManagerService.TAG, &quot;Unable to create process group for &quot; + app.processName + &quot; (&quot; + startResult.pid + &quot;)&quot;); } } ... return startResult;} â€‹ è¿™é‡Œï¼Œçœ‹åˆ°äº†zygoteæœ‰ä¸‰ç§ç±»å‹ï¼Œæ ¹æ®å¯åŠ¨çš„åº”ç”¨ä¿¡æ¯ä½¿ç”¨ä¸åŒç±»å‹çš„zygoteæ¥å¯åŠ¨ã€‚ regularZygoteå¸¸è§„è¿›ç¨‹ï¼Œzygote32/zygote64è¿›ç¨‹ï¼Œæ˜¯æ‰€æœ‰Android Javaåº”ç”¨çš„çˆ¶è¿›ç¨‹ appZygoteåº”ç”¨è¿›ç¨‹ï¼Œæ¯”å¸¸è§„è¿›ç¨‹å¤šä¸€äº›é™åˆ¶ã€‚ webviewZygoteè¾…åŠ©zygoteè¿›ç¨‹ï¼Œæ¸²æŸ“ä¸å¯ä¿¡çš„webå†…å®¹ï¼Œæœ€ä¸¥æ ¼çš„å®‰å…¨é™åˆ¶ â€‹ ä¸‰ç§zygoteç±»å‹çš„å¯åŠ¨æµç¨‹å·®ä¸å¤šçš„ï¼Œçœ‹å¸¸è§„è¿›ç¨‹å¯åŠ¨å³å¯ã€‚é¦–å…ˆçœ‹getProcessè¿”å›çš„æ˜¯ä»€ä¹ˆç±»å‹ 12345678public ChildZygoteProcess getProcess() { synchronized (mLock) { if (mZygote != null) return mZygote; connectToZygoteIfNeededLocked(); return mZygote; } } â€‹ åº”è¯¥æ‰¾ChildZygoteProcessçš„startå‡½æ•°ï¼Œç„¶åæ‰¾åˆ°ç±»å®šä¹‰åï¼Œå‘ç°æ²¡æœ‰startï¼Œé‚£ä¹ˆåº”è¯¥å°±æ˜¯çˆ¶ç±»ä¸­çš„å®ç°ã€‚ 12345678910111213public class ChildZygoteProcess extends ZygoteProcess { private final int mPid; ChildZygoteProcess(LocalSocketAddress socketAddress, int pid) { super(socketAddress, null); mPid = pid; } public int getPid() { return mPid; }} â€‹ ç»§ç»­æ‰¾åˆ°çˆ¶ç±»ZygoteProcessçš„startå‡½æ•°ï¼Œå‚æ•°å¤ªé•¿ï¼Œè¿™é‡Œçœç•¥æ‰å‚æ•°çš„æè¿° 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586public final Process.ProcessStartResult start(...) { ... return startViaZygote(processClass, niceName, uid, gid, gids, runtimeFlags, mountExternal, targetSdkVersion, seInfo, abi, instructionSet, appDataDir, invokeWith, /*startChildZygote=*/ false, packageName, zygotePolicyFlags, isTopApp, disabledCompatChanges, pkgDataInfoMap, allowlistedDataInfoList, bindMountAppsData, bindMountAppStorageDirs, zygoteArgs); ... }private Process.ProcessStartResult startViaZygote(...) throws ZygoteStartFailedEx { ArrayList&lt;String&gt; argsForZygote = new ArrayList&lt;&gt;(); // å‰é¢æ˜¯å°†å‰é¢å‡†å¤‡çš„å‚æ•°å¡«å……å¥½ // --runtime-args, --setuid=, --setgid=, // and --setgroups= must go first argsForZygote.add(&quot;--runtime-args&quot;); argsForZygote.add(&quot;--setuid=&quot; + uid); argsForZygote.add(&quot;--setgid=&quot; + gid); argsForZygote.add(&quot;--runtime-flags=&quot; + runtimeFlags); if (mountExternal == Zygote.MOUNT_EXTERNAL_DEFAULT) { argsForZygote.add(&quot;--mount-external-default&quot;); } else if (mountExternal == Zygote.MOUNT_EXTERNAL_INSTALLER) { argsForZygote.add(&quot;--mount-external-installer&quot;); } else if (mountExternal == Zygote.MOUNT_EXTERNAL_PASS_THROUGH) { argsForZygote.add(&quot;--mount-external-pass-through&quot;); } else if (mountExternal == Zygote.MOUNT_EXTERNAL_ANDROID_WRITABLE) { argsForZygote.add(&quot;--mount-external-android-writable&quot;); } ... synchronized(mLock) { // The USAP pool can not be used if the application will not use the systems graphics // driver. If that driver is requested use the Zygote application start path. return zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), zygotePolicyFlags, argsForZygote); } }private Process.ProcessStartResult zygoteSendArgsAndGetResult( ZygoteState zygoteState, int zygotePolicyFlags, @NonNull ArrayList&lt;String&gt; args) throws ZygoteStartFailedEx { ... //æ˜¯å¦ç”¨éç‰¹å®šçš„åº”ç”¨ç¨‹åºè¿›ç¨‹æ± è¿›è¡Œå¤„ç†ï¼Œé»˜è®¤ä¸ä½¿ç”¨ if (shouldAttemptUsapLaunch(zygotePolicyFlags, args)) { try { return attemptUsapSendArgsAndGetResult(zygoteState, msgStr); } catch (IOException ex) { // If there was an IOException using the USAP pool we will log the error and // attempt to start the process through the Zygote. Log.e(LOG_TAG, &quot;IO Exception while communicating with USAP pool - &quot; + ex.getMessage()); } } return attemptZygoteSendArgsAndGetResult(zygoteState, msgStr); }private Process.ProcessStartResult attemptZygoteSendArgsAndGetResult( ZygoteState zygoteState, String msgStr) throws ZygoteStartFailedEx { try { final BufferedWriter zygoteWriter = zygoteState.mZygoteOutputWriter; final DataInputStream zygoteInputStream = zygoteState.mZygoteInputStream; // è¿™é‡Œå®é™…å°±æ˜¯è¿æ¥SocketServeräº†ï¼Œå‘é€ä¸€ä¸ªæ¶ˆæ¯ç»™zygoteå­µåŒ–å‡ºæ¥çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ zygoteWriter.write(msgStr); zygoteWriter.flush(); Process.ProcessStartResult result = new Process.ProcessStartResult(); result.pid = zygoteInputStream.readInt(); result.usingWrapper = zygoteInputStream.readBoolean(); // ZygoteServeråˆ›å»ºå¥½è¿›ç¨‹åï¼Œè¿”å›pid if (result.pid &lt; 0) { throw new ZygoteStartFailedEx(&quot;fork() failed&quot;); } return result; } catch (IOException ex) { zygoteState.close(); Log.e(LOG_TAG, &quot;IO Exception while communicating with Zygote - &quot; + ex.toString()); throw new ZygoteStartFailedEx(ex); } } â€‹ åˆ°è¿™é‡Œï¼Œå›é¦–çœ‹çœ‹å‰æ–‡ä¸­ä»‹ç»ZygoteServerå¯åŠ¨è¿›ç¨‹çš„æµç¨‹ï¼Œå½“æ—¶çœ‹åˆ°æ‰§è¡Œåˆ°æœ€åæ˜¯findStaticMainå‡½æ•°ï¼Œæ˜¯è·å–ä¸€ä¸ªç±»åä¸‹çš„mainå‡½æ•°ï¼Œå¹¶è¿”å›åè¿›è¡Œè°ƒç”¨ã€‚ç°åœ¨å¯åŠ¨è¿›ç¨‹æ—¶ï¼Œåœ¨startProcessLockedå‡½æ•°ä¸­èƒ½çœ‹åˆ°ç±»åèµ‹å€¼æ˜¯android.app.ActivityThreadï¼Œæ‰€ä»¥è¿™é‡Œå’ŒZygoteServerè¿›è¡Œé€šä¿¡åˆ›å»ºçº¿ç¨‹ï¼Œæœ€åè°ƒç”¨çš„å‡½æ•°å°±æ˜¯android.app.ActivityThreadä¸­çš„mainå‡½æ•°ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¯åŠ¨æµç¨‹å°±è¿›å…¥çš„åº”ç”¨çš„ä¸»çº¿ç¨‹ã€‚ â€‹ ActivityThreadæ˜¯Androidåº”ç”¨ç¨‹åºè¿è¡Œçš„UIä¸»çº¿ç¨‹ï¼Œè´Ÿè´£å¤„ç†åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œæ¥æ”¶ç³»ç»Ÿæ¶ˆæ¯å¹¶å¤„ç†å®ƒä»¬ï¼Œmainå‡½æ•°å°±æ˜¯å®‰å“åº”ç”¨çš„å…¥å£å‡½æ•°ã€‚prepareMainLooperå‡½æ•°å°†å®ä¾‹åŒ–ä¸€ä¸ªLooperå¯¹è±¡ï¼Œç„¶åç”±Looperå¯¹è±¡åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå½“loopå‡½æ•°è°ƒç”¨æ—¶ï¼ŒUIçº¿ç¨‹å°±ä¼šè¿›å…¥æ¶ˆæ¯å¾ªç¯ï¼Œä¸æ–­ä»æ¶ˆæ¯é˜Ÿåˆ—è·å–åˆ°æ¶ˆæ¯å»è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ 12345678910111213141516171819202122232425262728public static void main(String[] args) { ... Looper.prepareMainLooper(); ... ActivityThread thread = new ActivityThread(); thread.attach(false, startSeq); // ä¸»çº¿ç¨‹æ¶ˆæ¯å¾ªç¯å¤„ç†çš„handler if (sMainThreadHandler == null) { sMainThreadHandler = thread.getHandler(); } ... Looper.loop();}// åœ¨loopå‡½æ•°ä¸­æ˜¯ä¸€ä¸ªæ­»å¾ªç¯è¿›è¡Œ`loopOnce`è°ƒç”¨public static void loop() { ... for (;;) { if (!loopOnce(me, ident, thresholdOverride)) { return; } }}private void attach(boolean system, long startSeq) { ... mgr.attachApplication(mAppThread, startSeq); ...} â€‹ ç»§ç»­çœ‹loopOnceçš„å®ç°ï¼Œçœ‹åˆ°äº†ä»é˜Ÿåˆ—ä¸­è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¹¶ä¸”å°†æ¶ˆæ¯æ´¾å‘ç»™å¯¹åº”çš„Handleræ¥æ‰§è¡Œã€‚ 123456789101112private static boolean loopOnce(final Looper me, final long ident, final int thresholdOverride) { Message msg = me.mQueue.next(); // might block if (msg == null) { // No message indicates that the message queue is quitting. return false; } ... msg.target.dispatchMessage(msg); ... return true; } â€‹ å¯¹åº”çš„æ¶ˆæ¯å¤„ç†çš„Handlerå°±æ˜¯å‰é¢åœ¨å…¥å£å‡½æ•°mainä¸­çœ‹åˆ°çš„sMainThreadHandlerå¯¹è±¡ï¼Œæ˜¯é€šè¿‡getHandlerå‡½æ•°è·å–çš„ï¼Œè·Ÿè¿›å»å¯»æ‰¾å…·ä½“çš„å¯¹è±¡ã€‚ 12345public Handler getHandler() { return mH; }final H mH = new H(); â€‹ æ‰¾åˆ°çš„è¿™ä¸ªHç±»å‹å°±æ˜¯å¯¹åº”çš„ä¸»çº¿ç¨‹æ¶ˆæ¯å¤„ç†Handleräº†ã€‚çœ‹çœ‹ç›¸å…³å®ç°ã€‚ 1234567891011121314151617181920212223242526272829303132333435class H extends Handler { public static final int BIND_APPLICATION = 110; @UnsupportedAppUsage public static final int EXIT_APPLICATION = 111; ... String codeToString(int code) { if (DEBUG_MESSAGES) { switch (code) { case BIND_APPLICATION: return &quot;BIND_APPLICATION&quot;; case EXIT_APPLICATION: return &quot;EXIT_APPLICATION&quot;; ... } } return Integer.toString(code); } public void handleMessage(Message msg) { if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&gt;&gt;&gt; handling: &quot; + codeToString(msg.what)); switch (msg.what) { case BIND_APPLICATION: Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;bindApplication&quot;); AppBindData data = (AppBindData)msg.obj; handleBindApplication(data); Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); break; case EXIT_APPLICATION: if (mInitialApplication != null) { mInitialApplication.onTerminate(); } Looper.myLooper().quit(); break; ... } ... } } â€‹ å†å›å¤´çœ‹çœ‹thread.attachä¸­çš„å¤„ç†ï¼Œmgrå°±æ˜¯AMSï¼Œæ‰€ä»¥æ¥åˆ°ActivityManagerServiceæŸ¥çœ‹attachApplicationï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859// åœ¨mainä¸­è°ƒç”¨çš„thread.attachå‡½æ•°private void attach(boolean system, long startSeq) { ... mgr.attachApplication(mAppThread, startSeq); ...}// å°†åº”ç”¨ç¨‹åºçº¿ç¨‹ä¸ ActivityThread ç»‘å®špublic final void attachApplication(IApplicationThread thread, long startSeq) { if (thread == null) { throw new SecurityException(&quot;Invalid application interface&quot;); } synchronized (this) { int callingPid = Binder.getCallingPid(); final int callingUid = Binder.getCallingUid(); final long origId = Binder.clearCallingIdentity(); attachApplicationLocked(thread, callingPid, callingUid, startSeq); Binder.restoreCallingIdentity(origId); }}// ç»§ç»­è¿½è¸ªattachApplicationLockedprivate boolean attachApplicationLocked(@NonNull IApplicationThread thread, int pid, int callingUid, long startSeq) { ... if (app.getIsolatedEntryPoint() != null) { // This is an isolated process which should just call an entry point instead of // being bound to an application. thread.runIsolatedEntryPoint( app.getIsolatedEntryPoint(), app.getIsolatedEntryPointArgs()); } else if (instr2 != null) { // å¦‚æœè¯¥åº”ç”¨ç¨‹åºæœªè¿è¡Œåœ¨éš”ç¦»è¿›ç¨‹ä¸­ï¼Œä¸”æœ‰ Instrumentation thread.bindApplication(processName, appInfo, providerList, instr2.mClass, profilerInfo, instr2.mArguments, instr2.mWatcher, instr2.mUiAutomationConnection, testMode, mBinderTransactionTrackingEnabled, enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.isPersistent(), new Configuration(app.getWindowProcessController().getConfiguration()), app.getCompat(), getCommonServicesLocked(app.isolated), mCoreSettingsObserver.getCoreSettingsLocked(), buildSerial, autofillOptions, contentCaptureOptions, app.getDisabledCompatChanges(), serializedSystemFontMap); } else { // å¦‚æœæ²¡æœ‰ Instrumentation thread.bindApplication(processName, appInfo, providerList, null, profilerInfo, null, null, null, testMode, mBinderTransactionTrackingEnabled, enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.isPersistent(), new Configuration(app.getWindowProcessController().getConfiguration()), app.getCompat(), getCommonServicesLocked(app.isolated), mCoreSettingsObserver.getCoreSettingsLocked(), buildSerial, autofillOptions, contentCaptureOptions, app.getDisabledCompatChanges(), serializedSystemFontMap); } ... } â€‹ æœ€åè°ƒç”¨å›ActivityThreadçš„bindApplicationï¼Œç»§ç»­è·Ÿè¿›å»æŸ¥çœ‹ 123456789101112131415161718192021222324252627public final void bindApplication(...) { ... //å°†åº”ç”¨ç¨‹åºå’Œåº”ç”¨ç¨‹åºçº¿ç¨‹ç»‘å®šæ‰€éœ€çš„ä¿¡æ¯å­˜å‚¨åˆ°AppBindDataçš„å„ä¸ªå­—æ®µä¸­ã€‚ AppBindData data = new AppBindData(); data.processName = processName; data.appInfo = appInfo; data.providers = providerList.getList(); data.instrumentationName = instrumentationName; data.instrumentationArgs = instrumentationArgs; data.instrumentationWatcher = instrumentationWatcher; data.instrumentationUiAutomationConnection = instrumentationUiConnection; data.debugMode = debugMode; data.enableBinderTracking = enableBinderTracking; data.trackAllocation = trackAllocation; data.restrictedBackupMode = isRestrictedBackupMode; data.persistent = persistent; data.config = config; data.compatInfo = compatInfo; data.initProfilerInfo = profilerInfo; data.buildSerial = buildSerial; data.autofillOptions = autofillOptions; data.contentCaptureOptions = contentCaptureOptions; data.disabledCompatChanges = disabledCompatChanges; data.mSerializedSystemFontMap = serializedSystemFontMap; // å‘é€æ¶ˆæ¯ç»™åº”ç”¨ç¨‹åºçº¿ç¨‹ï¼Œè°ƒç”¨ bindApplication æ–¹æ³• sendMessage(H.BIND_APPLICATION, data);} â€‹ AppBindDataæ•°æ®ç»‘å®šå®Œæˆåï¼Œæœ€åå‘é€æ¶ˆæ¯BIND_APPLICATIONé€šçŸ¥å‡†å¤‡å°±ç»ªï¼Œå¹¶å°†å‡†å¤‡å¥½çš„æ•°æ®å‘é€è¿‡å»ã€‚æŸ¥çœ‹æ¶ˆæ¯å¾ªç¯çš„å¤„ç†éƒ¨åˆ†handleMessageå‡½æ•°ï¼Œçœ‹è¿™ä¸ªæ•°æ®ä¼ ç»™å“ªä¸ªå‡½æ•°å¤„ç†äº†ã€‚ 1234567891011public void handleMessage(Message msg) { if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&gt;&gt;&gt; handling: &quot; + codeToString(msg.what)); switch (msg.what) { case BIND_APPLICATION: Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;bindApplication&quot;); AppBindData data = (AppBindData)msg.obj; handleBindApplication(data); Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); break; ...} â€‹ å‘ç°è°ƒç”¨åˆ°äº†handleBindApplicationï¼Œç»§ç»­è·Ÿè¿›æŸ¥çœ‹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152private void handleBindApplication(AppBindData data) { ... //å‰é¢å‡†å¤‡å¥½çš„dataæ•°æ®èµ‹å€¼ç»™äº†mBoundApplication mBoundApplication = data; ... // åˆ›å»ºå‡ºäº†Context final ContextImpl appContext = ContextImpl.createAppContext(this, data.info); ... Application app; final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites(); final StrictMode.ThreadPolicy writesAllowedPolicy = StrictMode.getThreadPolicy(); try { // åˆ›å»ºå‡ºäº†Application app = data.info.makeApplication(data.restrictedBackupMode, null); ... // Applicationèµ‹å€¼ç»™äº†mInitialApplication mInitialApplication = app; ... try { mInstrumentation.callApplicationOnCreate(app); } catch (Exception e) { ... } } finally { ... } ...}// çœ‹çœ‹æ˜¯å¦‚ä½•åˆ›å»ºå‡ºApplicationçš„public Application makeApplication(boolean forceDefaultAppClass, Instrumentation instrumentation) { if (mApplication != null) { return mApplication; } ... app = mActivityThread.mInstrumentation.newApplication( cl, appClass, appContext); ... return app;}// ç»§ç»­çœ‹newApplicationçš„å®ç°static public Application newApplication(Class&lt;?&gt; clazz, Context context) throws InstantiationException, IllegalAccessException,ClassNotFoundException { Application app = (Application)clazz.newInstance(); // æœ€åå‘ç°è°ƒç”¨äº†attach app.attach(context); return app;} â€‹ åœ¨ä¸Šé¢çœ‹åˆ°äº†Contextçš„åˆ›å»ºå’ŒApplicationçš„åˆ›å»ºï¼Œç»§ç»­çœ‹çœ‹æ€ä¹ˆè°ƒç”¨åˆ°è‡ªå·±å¼€å‘çš„appä¸­çš„onCreateçš„ï¼Œè¿½è¸ªcallApplicationOnCreateçš„å®ç° 1234public void callApplicationOnCreate(Application app) { ... app.onCreate();} â€‹ åˆ°è¿™é‡Œï¼ŒæˆåŠŸè·Ÿè¸ªåˆ°æœ€åè°ƒç”¨appåº”ç”¨çš„onCreateå‡½æ•°ï¼Œä¸ºä»€ä¹ˆå¾ˆå¤šäººå–œæ¬¢hook attachå‡½æ•°ï¼Œå› ä¸ºåœ¨Applicationåˆ›å»ºå‡ºæ¥æœ€æ—©å…ˆè°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªè¾ƒæ—©hookæ—¶æœºã€‚ 3.8 äº†è§£Serviceâ€‹ Serviceæ˜¯ä¸€ç§è¿è¡Œåœ¨åå°çš„ç»„ä»¶ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºæœåŠ¡ï¼Œå®ƒä¸åƒActivityé‚£æ ·æœ‰å‰å°æ˜¾ç¤ºç”¨æˆ·ç•Œé¢çš„èƒ½åŠ›ï¼Œè€Œæ˜¯ä¸€ç§æ›´åŠ æŠ½è±¡çš„ç»„ä»¶ï¼Œå®ƒå¯ä»¥æä¾›åå°æœåŠ¡ï¼Œåœ¨åå°å®šæ—¶æ‰§è¡ŒæŸäº›ä»»åŠ¡ã€‚Serviceå¯ä»¥è¢«åº”ç”¨ç¨‹åºç»‘å®šï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œå®ƒå¯ä»¥æ¥æ”¶å¤–éƒ¨çš„å‘½ä»¤ï¼Œæ‰§è¡Œè€—æ—¶çš„ä»»åŠ¡ã€‚ â€‹ åœ¨Androidå¯åŠ¨æµç¨‹ä¸­ï¼Œå°±å·²ç»çœ‹åˆ°äº†å¾ˆå¤šServiceçš„å¯åŠ¨ï¼Œå‰æ–‡ä»£ç çœ‹åˆ°å½“ç³»ç»Ÿå¯åŠ¨åé€šè¿‡forkSystemServeræ‰§è¡Œåˆ°SystemServeræ¥å¯åŠ¨ä¸€ç³»åˆ—çš„Serviceã€‚è¿™äº›Serviceæœ‰ç€å„è‡ªè´Ÿè´£çš„åŠŸèƒ½ï¼Œå…¶ä¸­æœ€å…³é”®çš„æ˜¯ActivityManagerServiceï¼Œå¸¸å¸¸è¢«ç®€ç§°ä¸ºAMSã€‚è€Œå¯åŠ¨äº†AMSçš„SystemServerä¹Ÿæ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡è´Ÿè´£åœ¨Androidå®Œæˆå¯åŠ¨åï¼ŒåŠ è½½å’Œå¯åŠ¨æ‰€æœ‰çš„ç³»ç»ŸæœåŠ¡ï¼Œç®¡ç†ç³»ç»Ÿçº§åˆ«çš„èµ„æºã€‚ â€‹ AMSæ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ ¸å¿ƒæœåŠ¡ï¼Œè´Ÿè´£Androidç³»ç»Ÿä¸­çš„æ‰€æœ‰æ´»åŠ¨ç®¡ç†ï¼ŒåŒ…æ‹¬åº”ç”¨ç¨‹åºçš„å¯åŠ¨ï¼Œæš‚åœï¼Œæ¢å¤ï¼Œç»ˆæ­¢ï¼Œä»¥åŠå¯¹ç³»ç»Ÿèµ„æºçš„ç®¡ç†å’Œåˆ†é…ã€‚è´Ÿè´£Androidç³»ç»Ÿä¸­æ‰€æœ‰æ´»åŠ¨çš„ç®¡ç†ã€‚å®ƒè´Ÿè´£ç®¡ç†ä»»åŠ¡æ ˆï¼Œå¹¶å…è®¸ä»»åŠ¡æ ˆä¸­çš„ä»»åŠ¡æ¥å›åˆ‡æ¢ï¼Œä»¥ä¾¿åœ¨ä»»åŠ¡ä¹‹é—´æ”¹å˜ç„¦ç‚¹ã€‚å®ƒè¿˜è´Ÿè´£ç®¡ç†è¿›ç¨‹ï¼Œå¹¶å°†è¿›ç¨‹å¯åŠ¨ï¼Œæš‚åœï¼Œæ¢å¤ï¼Œç»ˆæ­¢ï¼Œä»¥åŠåˆ†é…ç³»ç»Ÿèµ„æºã€‚åœ¨å¯åŠ¨æµç¨‹ä¸­èƒ½çœ‹åˆ°ï¼Œæ‰€æœ‰Serviceéƒ½æ˜¯ç”±å®ƒæ¥å¯åŠ¨çš„. â€‹ é™¤äº†AMSå¤–ï¼Œè¿˜æœ‰å…¶ä»–é‡è¦çš„Serviceä¸ºAndroidåº”ç”¨æä¾›åŸºç¡€çš„åŠŸèƒ½ï¼Œä¸‹é¢ç®€å•ä»‹ç»è¿™äº›å¸¸è§çš„Serviceã€‚ â€‹ WindowManagerServiceï¼Œå®ƒæ˜¯è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸Šæ‰€æœ‰çª—å£çš„æ˜¾ç¤ºå’Œæ“ä½œï¼ŒåŒ…æ‹¬ç®¡ç†å…¨å±çª—å£ã€å°çª—å£ã€å¼¹çª—ã€èœå•å’Œå…¶ä»–åº”ç”¨ç¨‹åºçš„çª—å£ï¼Œä½¿çª—å£åœ¨æ‰‹æœºå±å¹•ä¸Šæ­£ç¡®çš„æ˜¾ç¤ºã€‚ â€‹ PackageManagerServiceï¼ŒAndroidç³»ç»Ÿä¸­æä¾›ç»™åº”ç”¨ç¨‹åºè®¿é—®Androidè½¯ä»¶åŒ…çš„ä¸»è¦æœåŠ¡ã€‚è´Ÿè´£ç®¡ç†Androidè½¯ä»¶åŒ…çš„å®‰è£…ã€åˆ é™¤å’Œæ›´æ–°ï¼Œä»¥åŠè½¯ä»¶åŒ…çš„æŸ¥è¯¢å’Œé…ç½®ã€‚å®ƒæœ‰ä¸€ä¸ªåä¸ºPackages.xmlçš„XMLæ–‡æ¡£ï¼Œè¯¥æ–‡æ¡£æ˜¯Androidç³»ç»Ÿä¸­æ‰€æœ‰è½¯ä»¶åŒ…çš„åˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«äº†æ¯ä¸ªè½¯ä»¶åŒ…çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚åº”ç”¨ç¨‹åºçš„ç‰ˆæœ¬ï¼Œå®‰è£…æ—¶é—´ï¼Œæ–‡ä»¶å¤§å°ç­‰ã€‚ â€‹ PowerManagerServiceï¼Œç®¡ç†è®¾å¤‡ç”µæºçŠ¶æ€çš„æœåŠ¡ï¼Œå¯ä»¥æœ‰æ•ˆåœ°ç®¡ç†è®¾å¤‡çš„ç”µæºï¼Œä»è€Œå¤§å¤§æå‡è®¾å¤‡çš„ç”µæ± ç»­èˆªèƒ½åŠ›ï¼Œä¹Ÿå¯ä»¥é™ä½è®¾å¤‡è¿è¡Œæ—¶çš„åŠŸè€—ã€‚å®ƒè´Ÿè´£å¤„ç†è®¾å¤‡ä¸Šçš„æ‰€æœ‰ç”µæºç›¸å…³æ“ä½œï¼Œä¾‹å¦‚å±å¹•äº®åº¦ã€å±å¹•è¶…æ—¶æ—¶é—´ã€ç”µæ± å’Œå……ç”µæ—¶çš„è¿è¡Œæ¨¡å¼ã€è®¾å¤‡é”ä»¥åŠè®¾å¤‡å”¤é†’åŠŸèƒ½ã€‚ â€‹ InputMethodManagerServiceï¼Œè¾“å…¥æ³•æœåŠ¡ï¼Œå®ƒè´Ÿè´£å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œç®¡ç†è¾“å…¥æ³•çŠ¶æ€ï¼Œä»¥åŠå‘åº”ç”¨ç¨‹åºæä¾›è¾“å…¥æœåŠ¡ï¼Œä¾‹å¦‚å¯ä»¥å®‰è£…ã€å¸è½½å’Œæ›´æ–°è¾“å…¥æ³•ï¼Œè¿˜å¯ä»¥ç®¡ç†ç³»ç»Ÿçš„è¾“å…¥æ³•å¼€å…³ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡å®ƒæ¥è®¿é—®è¾“å…¥æ³•çš„å½“å‰çŠ¶æ€å’Œå†…å®¹ï¼Œä»¥åŠå®æ—¶è¾“å…¥çš„æ–‡æœ¬å†…å®¹ï¼Œå¯ä»¥æ¥æ”¶å¹¶å¤„ç†ç”¨æˆ·çš„è¾“å…¥äº‹ä»¶ï¼ŒåŒ…æ‹¬æŒ‰é”®ã€è§¦æ‘¸å±ã€è¯­éŸ³è¾“å…¥ç­‰ã€‚ â€‹ NotificationManagerServiceï¼Œé€šçŸ¥æœåŠ¡ã€‚å®ƒä¸»è¦æ˜¯ç”¨æ¥ç®¡ç†ç³»ç»Ÿçš„é€šçŸ¥ï¼ŒåŒ…æ‹¬æ¶ˆæ¯ã€æé†’ã€æ›´æ–°ç­‰ï¼Œå®ƒå®ç°äº†é€šçŸ¥çš„ç®¡ç†ï¼Œæ”¶é›†ã€ç»„ç»‡ã€è¿‡æ»¤é€šçŸ¥ï¼Œå¹¶å°†å®ƒä»¬å‘é€ç»™ç”¨æˆ·ã€‚å®ƒèƒ½å¤Ÿç®¡ç†æ‰€æœ‰åº”ç”¨ç¨‹åºå‘å‡ºçš„é€šçŸ¥ï¼ŒåŒ…æ‹¬ç³»ç»Ÿé€šçŸ¥ã€åº”ç”¨ç¨‹åºå‘å‡ºçš„é€šçŸ¥ï¼Œå¹¶å¯ä»¥æ ¹æ®ç”¨æˆ·çš„åå¥½ï¼Œæ˜¾ç¤ºå“ªäº›é€šçŸ¥ã€‚ â€‹ LocationManagerServiceï¼Œä½ç½®ç®¡ç†æœåŠ¡ã€‚å¯ä»¥æ ¹æ®åº”ç”¨ç¨‹åºçš„è¦æ±‚è°ƒç”¨GPSã€ç½‘ç»œå’Œå…¶ä»–ä½ç½®æŠ€æœ¯æ¥è·å–å½“å‰è®¾å¤‡çš„å®šä½ä¿¡æ¯ã€‚æ ¹æ®è®¾å¤‡çš„ä½ç½®ä¿¡æ¯ï¼Œæ§åˆ¶åº”ç”¨ç¨‹åºçš„å®šä½åŠŸèƒ½ï¼Œä»¥åŠè®¾å¤‡çš„ä½ç½®æŠ¥è­¦åŠŸèƒ½ã€‚ â€‹ InputManagerServiceï¼Œè´Ÿè´£è¾“å…¥è®¾å¤‡çš„ç®¡ç†å’Œæ§åˆ¶ï¼Œä»¥åŠç³»ç»Ÿä¸­æ‰€æœ‰è¾“å…¥äº‹ä»¶çš„å¤„ç†ã€‚ä¾‹å¦‚è§¦æ‘¸å±ã€è™šæ‹ŸæŒ‰é”®ã€é”®ç›˜ã€è½¨è¿¹çƒç­‰ã€‚ä¼šå°†è¾“å…¥äº‹ä»¶ä¼ é€’ç»™åº”ç”¨ç¨‹åºï¼Œä»¥ä¾¿å¤„ç†å’Œå“åº”ã€‚ â€‹ AlarmManagerServiceè´Ÿè´£å¤„ç†æ‰€æœ‰ç³»ç»Ÿå®šæ—¶ä»»åŠ¡ï¼Œå¦‚é—¹é’Ÿï¼Œå®šæ—¶å™¨ç­‰ã€‚å®ƒå¯ä»¥å®‰æ’å¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½¿å®ƒä»¬åœ¨æŒ‡å®šçš„æ—¶åˆ»å¼€å§‹æ‰§è¡Œã€‚ç›‘æ§ç³»ç»Ÿä¸­çš„å„ç§æ—¶é—´äº‹ä»¶ï¼Œä»¥æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡ã€‚å¯ä»¥å‘é€å”¤é†’å¹¿æ’­ï¼Œä»¥å¯åŠ¨æŒ‡å®šçš„æœåŠ¡æˆ–åº”ç”¨ç¨‹åºã€‚å¯ä»¥ç”¨äºå¤„ç†è®¾å¤‡ç¡çœ ã€å”¤é†’ç­‰ç³»ç»ŸçŠ¶æ€åˆ‡æ¢ã€‚ â€‹ NetworkManagementServiceï¼Œç½‘ç»œç®¡ç†æœåŠ¡ã€‚ç”¨äºæ§åˆ¶å’Œç®¡ç†Androidç³»ç»Ÿä¸­çš„ç½‘ç»œè¿æ¥ï¼Œèƒ½å¤Ÿåœ¨ä¸åŒçš„ç½‘ç»œä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œæ£€æŸ¥å’Œç®¡ç†æ‰‹æœºçš„ç½‘ç»œçŠ¶æ€ï¼Œç›‘æ§ç½‘ç»œè®¾å¤‡çš„è¿æ¥çŠ¶æ€ï¼Œå¦‚WiFiã€è“ç‰™ã€ç§»åŠ¨æ•°æ®ç­‰ã€‚ â€‹ BluetoothServiceï¼Œè“ç‰™æœåŠ¡ï¼Œå®ƒå¯ä»¥å®ç°è“ç‰™è®¾å¤‡ä¹‹é—´çš„æ— çº¿é€šä¿¡ã€‚å®ƒæä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥å»ºç«‹å’Œç®¡ç†è“ç‰™è¿æ¥ï¼Œä½¿è“ç‰™è®¾å¤‡ä¹‹é—´èƒ½å¤Ÿè¿›è¡Œæ–‡ä»¶ä¼ è¾“ã€è¿œç¨‹æ‰“å°ã€è“ç‰™é”®ç›˜è¿æ¥ç­‰æ´»åŠ¨ã€‚ â€‹ è¿˜æœ‰æ›´å¤šçš„ç³»ç»ŸæœåŠ¡ä¸ºAndroidçš„è¿è¡Œæä¾›ç€å„æ¨¡å—çš„åŸºç¡€åŠŸèƒ½ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è¯¦ç»†å™è¿°äº†ï¼Œå½“å¯¹æŸä¸€ä¸ªæœåŠ¡çš„åŠŸèƒ½å®ç°æ„Ÿå…´è¶£æ—¶ï¼Œå¯ä»¥é¡ºç€å¯åŠ¨æœåŠ¡çš„åœ°æ–¹å¼€å§‹è·Ÿè¸ªä»£ç ï¼Œåˆ†æå®ç°çš„é€»è¾‘ã€‚ä¹Ÿå¯ä»¥ç›´æ¥å‚è€ƒç³»ç»ŸæœåŠ¡çš„å®šä¹‰æ–¹å¼æ¥è‡ªå®šä¹‰ç³»ç»ŸæœåŠ¡æ¥æä¾›ç‰¹æ®Šéœ€æ±‚çš„åŠŸèƒ½ã€‚ 3.9 äº†è§£Frameworkâ€‹ FrameworkæŒ‡çš„æ˜¯è½¯ä»¶å¼€å‘æ¡†æ¶ï¼Œç”±äºç³»ç»Ÿå¤„äºå†…æ ¸ä¸­ï¼Œæ— æ³•ç›´æ¥å¯¹ç³»ç»Ÿçš„åŠŸèƒ½è¿›è¡Œè¯·æ±‚ï¼Œè€Œæ˜¯ç”±æ¡†æ¶å±‚ä¸ºå¼€å‘çš„é¡¶å±‚åº”ç”¨æä¾›æ¥å£è°ƒç”¨ï¼Œä»è€Œä¸å¿…çƒ¦æ¼å¦‚ä½•ä¸åº•å±‚äº¤äº’ï¼Œå¼€å‘æ¡†æ¶ä¸ºå¼€å‘äººå‘˜æä¾›å„ç§åŠŸèƒ½ï¼Œä»¥åŠAndroidåº”ç”¨å·¥å…·çš„æ”¯æŒæ¥ä¾¿äºåˆ›å»ºå’Œç®¡ç†Androidåº”ç”¨ç¨‹åºï¼Œæœ€ç»ˆè¾¾åˆ°è®©ç”¨æˆ·èƒ½é«˜æ•ˆå¼€å‘Androidåº”ç”¨çš„ç›®çš„ï¼Œä»¥ç”Ÿæ´»ä¸­çš„äº‹åŠ¡ä¸ºä¾‹ï¼ŒFrameworkå°±åƒæ˜¯ä¸€ä¸ªé…å¥—å®Œå–„çš„å°åŒºï¼Œæœ‰é«˜æ•ˆçš„ç‰©ä¸šï¼Œå‘¨è¾¹é…å¥—æœ‰å­¦æ ¡ã€åŒ»é™¢ã€å•†åœºï¼Œå„ç±»è®¾æ–½éå¸¸é½å…¨ï¼Œè€Œç”¨æˆ·å°±åƒæ˜¯å°åŒºå†…çš„ä¸šä¸»ã€‚ â€‹ çœ‹ä¸€å¼ ç»å…¸çš„Androidæ¶æ„å›¾ã€‚ â€‹ ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°Framewokçš„ç»„æˆéƒ¨åˆ†ï¼Œå®ƒä»¬çš„åŠŸèƒ½åˆ†åˆ«æ˜¯ï¼š Activity Managerï¼šç”¨äºç®¡ç†å’Œåè°ƒæ‰€æœ‰Androidåº”ç”¨ç¨‹åºçš„æ´»åŠ¨å’Œä»»åŠ¡ã€‚ Content Providersï¼šå…è®¸Androidåº”ç”¨ç¨‹åºä¹‹é—´å…±äº«æ•°æ®ã€‚ Package Managerï¼šç”¨äºå®‰è£…ï¼Œå‡çº§å’Œç®¡ç†åº”ç”¨ç¨‹åºï¼Œä»¥åŠå¤„ç†åº”ç”¨ç¨‹åºçš„æƒé™ã€‚ Resource Managerï¼šç®¡ç†åº”ç”¨ç¨‹åºä½¿ç”¨çš„èµ„æºï¼Œä¾‹å¦‚å›¾åƒï¼Œå­—ç¬¦ä¸²ï¼Œå¸ƒå±€ã€‚ Notification Managerï¼šå¤„ç†Androidç³»ç»Ÿçš„é€šçŸ¥æœºåˆ¶ã€‚ Telephony Managerï¼šæä¾›ç”µè¯åŠŸèƒ½ï¼Œä¾‹å¦‚æ‹¨æ‰“ç”µè¯ï¼Œæ¥å¬ç”µè¯ç­‰ã€‚ Location Managerï¼šç”¨äºè·å–è®¾å¤‡çš„ä½ç½®ä¿¡æ¯ã€‚ View Systemï¼šæä¾›ç”¨æˆ·ç•Œé¢çš„åŸºæœ¬ç»„ä»¶æˆ–éƒ¨ä»¶ï¼Œä¾‹å¦‚æŒ‰é’®ï¼Œæ–‡æœ¬æ¡†ç­‰ã€‚ Window Managerï¼šå¤„ç†å±å¹•ä¸Šçš„çª—å£ï¼Œä¾‹å¦‚åœ¨å±å¹•ä¸Šç»˜åˆ¶UIå…ƒç´ å’Œç®¡ç†çª—å£ç„¦ç‚¹ã€‚ Package Installerï¼šç”¨äºåœ¨è®¾å¤‡ä¸Šå®‰è£…åº”ç”¨ç¨‹åºçš„æ§åˆ¶é¢æ¿ã€‚ Resource Managerï¼šç®¡ç†æ‰€æœ‰å…è®¸åº”ç”¨ç¨‹åºè®¿é—®çš„å…¬å…±èµ„æºï¼Œä¾‹å¦‚é“ƒå£°ï¼Œç…§ç‰‡å’Œè”ç³»äººä¿¡æ¯ã€‚ Activityå’ŒFragmentï¼šæä¾›åº”ç”¨ç¨‹åºçš„ç”¨æˆ·ç•Œé¢å’Œæ§åˆ¶å™¨ã€‚ â€‹ å¯ä»¥çœ‹åˆ°å‰æ–‡ä¸­çš„å„ç§ç³»ç»ŸæœåŠ¡å°±æ˜¯å±äºFrameworkä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ç”¨æˆ·å±‚å¹¶ä¸èƒ½ç›´æ¥è®¿é—®ç³»ç»ŸæœåŠ¡æä¾›çš„åŠŸèƒ½ï¼Œè€Œæ˜¯é€šè¿‡å„æœåŠ¡å¯¹åº”çš„ç®¡ç†å™¨æ¥å¯¹ç³»ç»ŸæœåŠ¡è¿›è¡Œè°ƒç”¨ã€‚æ¥ä¸‹æ¥å¼€å§‹è·Ÿè¸ªï¼Œåœ¨å¼€å‘åº”ç”¨ä¸­ï¼Œå½“è°ƒç”¨ä¸€ä¸ªç³»ç»ŸæœåŠ¡åŠŸèƒ½æ—¶å‘ç”Ÿäº†å“ªäº›è°ƒç”¨ï¼Œä½¿ç”¨Android Studioåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ã€‚ 12345678910111213protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); TelephonyManager tm = (TelephonyManager) this.getSystemService(TELEPHONY_SERVICE); /* * ç”µè¯çŠ¶æ€ï¼š * 1.tm.CALL_STATE_IDLE=0 æ— æ´»åŠ¨ * 2.tm.CALL_STATE_RINGING=1 å“é“ƒ * 3.tm.CALL_STATE_OFFHOOK=2 æ‘˜æœº */ int state= tm.getCallState();//int Log.i(&quot;MainActivity&quot;,&quot;phone state &quot;+state);} â€‹ é€šè¿‡getSystemServiceå‡½æ•°æä¾›äº†ä¸€ä¸ªç³»ç»ŸæœåŠ¡çš„åç§°ï¼Œè·å–åˆ°äº†å¯¹åº”ç³»ç»ŸæœåŠ¡å¯¹åº”ç®¡ç†å™¨ï¼Œé€šè¿‡è°ƒç”¨ç®¡ç†å™¨çš„å‡½æ•°æ¥è§¦å‘å¯¹åº”ç³»ç»ŸæœåŠ¡çš„åŠŸèƒ½ï¼Œçœ‹çœ‹å…·ä½“æ˜¯å¦‚ä½•è·å–åˆ°ç³»ç»ŸæœåŠ¡çš„ã€‚æ‰¾åˆ°Androidæºç ä¸­Activity.javaæ–‡ä»¶ã€‚ 1234567891011121314public Object getSystemService(@ServiceName @NonNull String name) { if (getBaseContext() == null) { throw new IllegalStateException( &quot;System services not available to Activities before onCreate()&quot;); } if (WINDOW_SERVICE.equals(name)) { return mWindowManager; } else if (SEARCH_SERVICE.equals(name)) { ensureSearchManager(); return mSearchManager; } return super.getSystemService(name);} â€‹ å¦‚æœæ˜¯WINDOW_SERVICEæˆ–è€…SEARCH_SERVICEå°±å¿«é€Ÿçš„è¿”å›å¯¹åº”çš„ç®¡ç†å™¨äº†ï¼Œå…¶ä»–ç³»ç»ŸæœåŠ¡åˆ™ç»§ç»­è°ƒç”¨çˆ¶ç±»çš„å‡½æ•°ã€‚Activityç»§æ‰¿è‡ªContextThemeWrapperï¼Œæ‰¾åˆ°å¯¹åº”å®ç°ä»£ç å¦‚ä¸‹ã€‚ 123456789public Object getSystemService(String name) { if (LAYOUT_INFLATER_SERVICE.equals(name)) { if (mInflater == null) { mInflater = LayoutInflater.from(getBaseContext()).cloneInContext(this); } return mInflater; } return getBaseContext().getSystemService(name);} â€‹ æ‰¾åˆ°ContextImplä¸­çš„å¯¹åº”å®ç° 1234public Object getSystemService(String name) { ... return SystemServiceRegistry.getSystemService(this, name);} â€‹ ç»§ç»­æŸ¥çœ‹SystemServiceRegistryä¸­çš„å®ç° 123456789101112131415public static Object getSystemService(ContextImpl ctx, String name) { if (name == null) { return null; } final ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name); if (fetcher == null) { if (sEnableServiceNotFoundWtf) { Slog.wtf(TAG, &quot;Unknown manager requested: &quot; + name); } return null; } final Object ret = fetcher.getService(ctx); ... return ret;} â€‹ å‘ç°æœåŠ¡æ˜¯ä»SYSTEM_SERVICE_FETCHERSä¸­è·å–å‡ºæ¥ï¼Œç„¶åè¿”å›çš„ã€‚çœ‹çœ‹è¿™ä¸ªå¯¹è±¡çš„å€¼æ˜¯å¦‚ä½•æ’è¿›å»çš„ã€‚æœç´¢è¯¥å¯¹è±¡çš„putå‡½æ•°è°ƒç”¨å¤„æ‰¾åˆ°ç›¸å…³å‡½æ•°å¦‚ä¸‹ã€‚ 123456private static &lt;T&gt; void registerService(@NonNull String serviceName, @NonNull Class&lt;T&gt; serviceClass, @NonNull ServiceFetcher&lt;T&gt; serviceFetcher) { SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName); SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher); SYSTEM_SERVICE_CLASS_NAMES.put(serviceName, serviceClass.getSimpleName());} â€‹ ä»åå­—å°±èƒ½çœ‹çš„å‡ºæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªæ³¨å†Œç³»ç»ŸæœåŠ¡çš„å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­å¯¹å¤§å¤šæ•°ç³»ç»ŸæœåŠ¡è¿›è¡Œæ³¨å†Œï¼Œæƒ³è¦æŸ¥æ‰¾åˆ°ä¸€ä¸ªç³»ç»ŸæœåŠ¡ï¼Œå¯ä»¥é¡ºç€registerServiceæ³¨å†Œå‡½æ•°è¿›è¡Œè·Ÿè¸ªï¼Œå¦‚æœæ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„ç³»ç»ŸæœåŠ¡ï¼ŒåŒæ ·ä¹Ÿæ˜¯éœ€è¦åœ¨è¿™é‡Œè¿›è¡Œç³»ç»ŸæœåŠ¡çš„æ³¨å†Œã€‚ â€‹ ä¸‹é¢ç»§ç»­è§‚å¯ŸTelephonyManagerä¸­getCallStateå‡½æ•°çš„å®ç°ã€‚ 123456789public @CallState int getCallState() { if (mContext != null) { TelecomManager telecomManager = mContext.getSystemService(TelecomManager.class); if (telecomManager != null) { return telecomManager.getCallState(); } } return CALL_STATE_IDLE;} â€‹ è¿™é‡Œåˆé€šè¿‡å¦ä¸€ä¸ªç®¡ç†å™¨è¿›è¡Œçš„å‡½æ•°è°ƒç”¨ï¼Œç»§ç»­è·Ÿè¿›å» 123456789101112public @CallState int getCallState() { ITelecomService service = getTelecomService(); if (service != null) { try { return service.getCallStateUsingPackage(mContext.getPackageName(), mContext.getAttributionTag()); } catch (RemoteException e) { Log.d(TAG, &quot;RemoteException calling getCallState().&quot;, e); } } return TelephonyManager.CALL_STATE_IDLE;} â€‹ ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒTelephonyManagerç®¡ç†å™¨ä¸è´Ÿè´£ä¸šåŠ¡ç›¸å…³çš„å¤„ç†ï¼Œä¸»è¦æ˜¯è°ƒç”¨å¯¹åº”çš„ç³»ç»ŸæœåŠ¡æ¥è·å–ç»“æœã€‚ç»§ç»­æŸ¥çœ‹getCallStateUsingPackageå‡½æ•°å®ç° 1234567891011121314151617181920public int getCallStateUsingPackage(String callingPackage, String callingFeatureId) { try { Log.startSession(&quot;TSI.getCallStateUsingPackage&quot;); if (CompatChanges.isChangeEnabled( TelecomManager.ENABLE_GET_CALL_STATE_PERMISSION_PROTECTION, callingPackage, Binder.getCallingUserHandle())) { // Bypass canReadPhoneState check if this is being called from SHELL UID if (Binder.getCallingUid() != Process.SHELL_UID &amp;&amp; !canReadPhoneState( callingPackage, callingFeatureId, &quot;getCallState&quot;)) { throw new SecurityException(&quot;getCallState API requires READ_PHONE_STATE&quot; + &quot; for API version 31+&quot;); } } synchronized (mLock) { return mCallsManager.getCallState(); } } finally { Log.endSession(); }} â€‹ åœ¨ç³»ç»ŸæœåŠ¡ä¸­å°±çœ‹åˆ°äº†ç®¡ç†çŠ¶æ€ç›¸å…³çš„å…·ä½“ä¸šåŠ¡ä»£ç äº†ï¼Œç»§ç»­è§‚å¯ŸmCallsManager.getCallStaeçš„å®ç° 123int getCallState() { return mPhoneStateBroadcaster.getCallState();} â€‹ æœ€åæ˜¯ç”±PhoneStateBroadcasterå¯¹è±¡ç»´æŠ¤ç€ç”µè¯çš„çŠ¶æ€ä¿¡æ¯äº†ï¼ŒPhoneStateBroadcasteræ˜¯Androidä¸­çš„ä¸€ä¸ªç³»ç»Ÿå¹¿æ’­æœºåˆ¶ï¼Œå®ƒç”¨äºåœ¨ç”µè¯çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å‘å‡ºé€šçŸ¥ï¼Œä»¥ä¾¿å…¶ä»–ç»„ä»¶å’Œåº”ç”¨ç¨‹åºèƒ½å¤Ÿæ¥æ”¶å’Œå¤„ç†è¿™äº›å˜åŒ–ã€‚å®ƒå¯ä»¥å‘å‡ºåŒ…æ‹¬æ–°æ¥ç”µï¼ŒæŒ‚æ–­ç”µè¯ï¼Œæ‹¨å·ç­‰çŠ¶æ€å˜åŒ–çš„é€šçŸ¥ï¼Œä»¥ä½¿ç³»ç»Ÿä¸­çš„å…¶ä»–ç»„ä»¶èƒ½å¤Ÿæ›´æ–°å’Œå¤„ç†è¿™äº›å˜åŒ–ã€‚PhoneStateBroadcasterè¿˜æä¾›äº†ä¸€äº›å…¶ä»–çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ç”µè¯çŠ¶æ€ç›‘æ§ï¼Œç”¨äºæ£€æµ‹ç”µè¯çŠ¶æ€çš„å˜åŒ–ï¼Œä»¥ä¾¿èƒ½å¤ŸåŠæ—¶å“åº”ã€‚ç®€å•çš„è´´ä¸€ä¸‹ç›¸å…³çš„ä»£ç å¦‚ä¸‹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061final class PhoneStateBroadcaster extends CallsManagerListenerBase { ... @Override public void onCallStateChanged(Call call, int oldState, int newState) { if (call.isExternalCall()) { return; } updateStates(call); } @Override public void onCallAdded(Call call) { if (call.isExternalCall()) { return; } updateStates(call); if (call.isEmergencyCall() &amp;&amp; !call.isIncoming()) { sendOutgoingEmergencyCallEvent(call); } } @Override public void onCallRemoved(Call call) { if (call.isExternalCall()) { return; } updateStates(call); } @Override public void onExternalCallChanged(Call call, boolean isExternalCall) { updateStates(call); } private void updateStates(Call call) { int callState = TelephonyManager.CALL_STATE_IDLE; if (mCallsManager.hasRingingOrSimulatedRingingCall()) { callState = TelephonyManager.CALL_STATE_RINGING; } else if (mCallsManager.getFirstCallWithState(CallState.DIALING, CallState.PULLING, CallState.ACTIVE, CallState.ON_HOLD) != null) { callState = TelephonyManager.CALL_STATE_OFFHOOK; } sendPhoneStateChangedBroadcast(call, callState); } int getCallState() { return mCurrentState; } private void sendPhoneStateChangedBroadcast(Call call, int phoneState) { if (phoneState == mCurrentState) { return; } mCurrentState = phoneState; ... } ...} 3.10 äº†è§£libcoreâ€‹ libcoreæ˜¯Androidå¹³å°ä¸‹çš„Javaæ ¸å¿ƒåº“ï¼Œä¸»è¦æä¾›ä¸Javaè¯­è¨€æ ¸å¿ƒç›¸å…³çš„ç±»ï¼Œå¦‚Objectç±»ã€Stringç±»ï¼ŒJavaé›†åˆç±»ä»¥åŠè¾“å…¥/è¾“å‡ºæµç­‰ã€‚åŒæ—¶ï¼Œlibcoreè¿˜åŒ…æ‹¬äº†å¹³å°æ”¯æŒåº“ï¼Œæä¾›äº†ä¸€äº›ç”¨äºAndroidå¹³å°ç‰¹å®šåŠŸèƒ½çš„å®ç°ï¼Œå¦‚Socketã€SSLã€Fileã€URIç­‰ç±»çš„å¹³å°ç‰¹å®šå®ç°ã€‚åœ¨Androidåº”ç”¨ç¨‹åºå¼€å‘ä¸­ï¼Œlibcoreåº“æ˜¯å¿…ä¸å¯å°‘çš„ä¸€éƒ¨åˆ†ï¼Œå…¶æä¾›çš„ç±»å’Œå®ç°å¯¹äºå¼€å‘å’Œè°ƒè¯•åº”ç”¨ç¨‹åºéƒ½å…·æœ‰éå¸¸é‡è¦çš„ä½œç”¨ã€‚ â€‹ åœ¨libcoreåº“ä¸­ï¼Œluniæ˜¯å…¶ä¸­çš„ä¸€ä¸ªå­åº“ï¼Œæ˜¯æŒ‡Javaçš„åŸºç¡€ç±»åº“ï¼ˆLUNI = LANG + UTIL + NET + IOï¼‰ï¼Œè€Œojluniæ˜¯OpenJDKçš„ä»£ç åœ¨Androidä¸­çš„å®ç°ï¼Œå…¶ç›®å½•ç»“æ„ä¸luniå­åº“ç±»ä¼¼ï¼ŒåŒ…å«äº†Javaè¯­è¨€æ ¸å¿ƒç±»ã€Javaé›†åˆç±»å’ŒI/Oç±»ç­‰ã€‚ojluniæ˜¯åœ¨Javaæ ‡å‡†åº“çš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¸€äº›å®šåˆ¶åŒ–çš„ä¿®æ”¹ï¼Œä»¥ä¾¿æ›´å¥½åœ°é€‚é…Androidç³»ç»Ÿã€‚ä¸‹é¢çœ‹çœ‹ojluniçš„ç›®å½•ç»“æ„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113tree ./libcore/ojluni/src/main/java/ -dâ”œâ”€â”€ comâ”‚ â””â”€â”€ sunâ”‚ â”œâ”€â”€ netâ”‚ â”‚ â””â”€â”€ sslâ”‚ â”‚ â””â”€â”€ internalâ”‚ â”‚ â””â”€â”€ sslâ”‚ â”œâ”€â”€ nioâ”‚ â”‚ â””â”€â”€ fileâ”‚ â””â”€â”€ securityâ”‚ â””â”€â”€ certâ”‚ â””â”€â”€ internalâ”‚ â””â”€â”€ x509â”œâ”€â”€ javaâ”‚ â”œâ”€â”€ awtâ”‚ â”‚ â””â”€â”€ fontâ”‚ â”œâ”€â”€ beansâ”‚ â”œâ”€â”€ ioâ”‚ â”œâ”€â”€ langâ”‚ â”‚ â”œâ”€â”€ annotationâ”‚ â”‚ â”œâ”€â”€ invokeâ”‚ â”‚ â”œâ”€â”€ refâ”‚ â”‚ â””â”€â”€ reflectâ”‚ â”œâ”€â”€ mathâ”‚ â”œâ”€â”€ netâ”‚ â”œâ”€â”€ nioâ”‚ â”‚ â”œâ”€â”€ channelsâ”‚ â”‚ â”‚ â””â”€â”€ spiâ”‚ â”‚ â”œâ”€â”€ charsetâ”‚ â”‚ â”‚ â””â”€â”€ spiâ”‚ â”‚ â””â”€â”€ fileâ”‚ â”‚ â”œâ”€â”€ attributeâ”‚ â”‚ â””â”€â”€ spiâ”‚ â”œâ”€â”€ securityâ”‚ â”‚ â”œâ”€â”€ aclâ”‚ â”‚ â”œâ”€â”€ certâ”‚ â”‚ â”œâ”€â”€ interfacesâ”‚ â”‚ â””â”€â”€ specâ”‚ â”œâ”€â”€ sqlâ”‚ â”œâ”€â”€ textâ”‚ â”œâ”€â”€ timeâ”‚ â”‚ â”œâ”€â”€ chronoâ”‚ â”‚ â”œâ”€â”€ formatâ”‚ â”‚ â”œâ”€â”€ temporalâ”‚ â”‚ â””â”€â”€ zoneâ”‚ â””â”€â”€ utilâ”‚ â”œâ”€â”€ concurrentâ”‚ â”‚ â”œâ”€â”€ atomicâ”‚ â”‚ â””â”€â”€ locksâ”‚ â”œâ”€â”€ functionâ”‚ â”œâ”€â”€ jarâ”‚ â”œâ”€â”€ loggingâ”‚ â”œâ”€â”€ prefsâ”‚ â”œâ”€â”€ regexâ”‚ â”œâ”€â”€ streamâ”‚ â””â”€â”€ zipâ”œâ”€â”€ javaxâ”‚ â”œâ”€â”€ cryptoâ”‚ â”‚ â”œâ”€â”€ interfacesâ”‚ â”‚ â””â”€â”€ specâ”‚ â”œâ”€â”€ netâ”‚ â”‚ â””â”€â”€ sslâ”‚ â”œâ”€â”€ securityâ”‚ â”‚ â”œâ”€â”€ authâ”‚ â”‚ â”‚ â”œâ”€â”€ callbackâ”‚ â”‚ â”‚ â”œâ”€â”€ loginâ”‚ â”‚ â”‚ â””â”€â”€ x500â”‚ â”‚ â””â”€â”€ certâ”‚ â””â”€â”€ sqlâ”‚ â””â”€â”€ rowsetâ”œâ”€â”€ jdkâ”‚ â”œâ”€â”€ internalâ”‚ â”‚ â”œâ”€â”€ utilâ”‚ â”‚ â””â”€â”€ vmâ”‚ â”‚ â””â”€â”€ annotationâ”‚ â””â”€â”€ netâ””â”€â”€ sun â”œâ”€â”€ invoke â”‚ â””â”€â”€ util â”œâ”€â”€ misc â”œâ”€â”€ net â”‚ â”œâ”€â”€ ftp â”‚ â”‚ â””â”€â”€ impl â”‚ â”œâ”€â”€ spi â”‚ â”‚ â””â”€â”€ nameservice â”‚ â”œâ”€â”€ util â”‚ â””â”€â”€ www â”‚ â””â”€â”€ protocol â”‚ â”œâ”€â”€ file â”‚ â”œâ”€â”€ ftp â”‚ â””â”€â”€ jar â”œâ”€â”€ nio â”‚ â”œâ”€â”€ ch â”‚ â”œâ”€â”€ cs â”‚ â””â”€â”€ fs â”œâ”€â”€ reflect â”‚ â””â”€â”€ misc â”œâ”€â”€ security â”‚ â”œâ”€â”€ action â”‚ â”œâ”€â”€ jca â”‚ â”œâ”€â”€ pkcs â”‚ â”œâ”€â”€ provider â”‚ â”‚ â””â”€â”€ certpath â”‚ â”œâ”€â”€ timestamp â”‚ â”œâ”€â”€ util â”‚ â””â”€â”€ x509 â””â”€â”€ util â”œâ”€â”€ calendar â”œâ”€â”€ locale â”‚ â””â”€â”€ provider â”œâ”€â”€ logging â””â”€â”€ resources 3.11 äº†è§£sepolicyâ€‹ sepolicyä¸»è¦ç”¨æ¥å­˜æ”¾SELinuxç­–ç•¥çš„ç›®å½•ï¼ŒSELinuxæ˜¯ä¸€ç§å¼ºåˆ¶è®¿é—®æ§åˆ¶æœºåˆ¶ï¼ŒAndroidç³»ç»Ÿä¸­å®ç°è®¿é—®æ§åˆ¶çš„ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œå®ƒåœ¨Linuxå†…æ ¸çš„åŸºç¡€ä¸Šå®ç°ï¼Œç”¨äºä¿è¯æ‰‹æœºå®‰å…¨ã€‚ â€‹ SELinuxä¸»è¦ç”¨äºé™åˆ¶åº”ç”¨ç¨‹åºçš„æƒé™ï¼Œä½¿å…¶åªèƒ½è®¿é—®å…¶æ‰€éœ€çš„èµ„æºï¼Œå¹¶åœ¨éœ€è¦æ—¶å‘ç”¨æˆ·è¯·æ±‚æƒé™ã€‚é€šè¿‡é™åˆ¶åº”ç”¨ç¨‹åºçš„æƒé™ï¼Œå¯ä»¥é˜²æ­¢æ¶æ„è½¯ä»¶å’Œæ”»å‡»è€…æ”»å‡»ç³»ç»Ÿã€‚å…·ä½“è€Œè¨€ï¼Œsepolicyå¯ä»¥åšåˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š é™åˆ¶åº”ç”¨ç¨‹åºè®¿é—®ç³»ç»Ÿçš„èµ„æºï¼Œä¾‹å¦‚ç³»ç»Ÿè®¾ç½®ã€ç½‘ç»œæ¥å£ç­‰ã€‚ é™åˆ¶åº”ç”¨ç¨‹åºçš„ä½¿ç”¨æƒé™ï¼Œä¾‹å¦‚è¯»å–è”ç³»äººã€è®¿é—®å­˜å‚¨ç©ºé—´ç­‰ã€‚ ä¿æŠ¤ç³»ç»Ÿæ–‡ä»¶å’Œç›®å½•ï¼Œé˜²æ­¢åº”ç”¨ç¨‹åºå’Œæ”»å‡»è€…ä¿®æ”¹å’Œåˆ é™¤ç³»ç»Ÿå…³é”®æ–‡ä»¶ã€‚ â€‹ Type Enforcementæ˜¯SELinuxä¸­çš„ä¸€ä¸ªå®‰å…¨ç­–ç•¥æœºåˆ¶ï¼Œç”¨äºå¯¹ç³»ç»Ÿä¸­æ¯ä¸ªå¯¹è±¡å’Œä¸»ä½“çš„è®¿é—®è¿›è¡Œå¼ºåˆ¶è®¿é—®æ§åˆ¶ã€‚åœ¨Type Enforcementçš„æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡å’Œä¸»ä½“éƒ½è¢«èµ‹äºˆäº†ä¸€ä¸ªå®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆSecurity Contextï¼‰ï¼Œè¯¥ä¸Šä¸‹æ–‡ç”±å¤šä¸ªæ ‡ç­¾ç»„æˆã€‚ â€‹ Role-Based Access Controlï¼ˆRBACï¼‰ä¹Ÿæ˜¯ SELinux ä¸­çš„ä¸€ç§è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œç”¨äºå¯¹ç³»ç»Ÿä¸­å¤šä¸ªç”¨æˆ·ã€è§’è‰²å’Œå¯¹è±¡çš„è®¿é—®è¿›è¡Œæˆæƒå’Œé™åˆ¶ã€‚åœ¨RBACæ¨¡å‹ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½è¢«åˆ†é…äº†ä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²ï¼Œæ¯ä¸ªè§’è‰²éƒ½æœ‰ä¸€ç»„ç‰¹å®šçš„æƒé™å’Œè®¿é—®æ§åˆ¶è§„åˆ™ã€‚ä¸ä¼ ç»Ÿçš„è®¿é—®æ§åˆ¶æ–¹å¼ä¸åŒï¼ŒRBACå¯ä»¥æ ¹æ®ç”¨æˆ·çš„èŒè´£å’Œè§’è‰²æ¥æˆæƒå’Œé™åˆ¶å…¶è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ·»åŠ æˆ–åˆ é™¤è§’è‰²ç­‰æ–¹å¼å¯¹è®¿é—®æ§åˆ¶è¿›è¡ŒåŠ¨æ€ç®¡ç†ã€‚è¿™ç§æœºåˆ¶å¯ä»¥ç¡®ä¿ç³»ç»Ÿä¸­ä¸åŒç”¨æˆ·ä¹‹é—´çš„éš”ç¦»å’Œèµ„æºä¿æŠ¤ï¼Œå¹¶æé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚ â€‹ åœ¨SELinuxä¸­ï¼Œæ ‡ç­¾åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼šç”¨æˆ·æ ‡ç­¾ï¼ˆUser IDï¼‰ã€è§’è‰²æ ‡ç­¾ï¼ˆRoleï¼‰å’Œç±»å‹æ ‡ç­¾ï¼ˆTypeï¼‰ã€‚æ¯ä¸ªå®‰å…¨ä¸Šä¸‹æ–‡éƒ½åŒ…å«äº†è¿™ä¸‰ç§æ ‡ç­¾çš„ç»„åˆï¼Œå¦‚â€œu:r:system_app:s0â€è¡¨ç¤ºè¯¥ä¸Šä¸‹æ–‡å¯¹åº”ä¸€ä¸ªç”¨æˆ·æ ‡ç­¾ä¸ºâ€œsystem_appâ€çš„è¿›ç¨‹ï¼Œå…¶è§’è‰²æ ‡ç­¾å’Œç±»å‹æ ‡ç­¾åˆ†åˆ«ä¸ºâ€œrâ€å’Œâ€œs0â€ã€‚ â€‹ é€šè¿‡å®‰å…¨ä¸Šä¸‹æ–‡ï¼ŒSELinuxå¯ä»¥å¯¹ç³»ç»Ÿä¸­çš„å¯¹è±¡å’Œä¸»ä½“è¿›è¡Œç»†ç²’åº¦æ§åˆ¶ï¼Œå¹¶é™åˆ¶å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡æˆ–ä¸»ä½“çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸åŒ¹é…ï¼Œåˆ™å®ƒä»¬ä¸èƒ½ç›¸äº’é€šä¿¡æˆ–å…±äº«èµ„æºã€‚è¿™ç§æœºåˆ¶å¯ä»¥æœ‰æ•ˆåœ°é˜²æ­¢æ¶æ„åº”ç”¨ç¨‹åºæˆ–è€…æ”»å‡»è€…å¯¹ç³»ç»Ÿè¿›è¡Œæ”»å‡»æˆ–æ»¥ç”¨ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹ sepolicy ç›®å½•ä¸‹çš„æ–‡ä»¶æ¥è°ƒæ•´å®‰å…¨ç­–ç•¥ï¼Œä»è€Œé€‚åº”ä¸åŒçš„åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿéœ€æ±‚ã€‚ â€‹ åœ¨ROMå®šåˆ¶æ—¶ï¼Œå¸¸ä¼šæ·»åŠ æŸäº›åŠŸèƒ½æ—¶ç”±äºæƒé™é—®é¢˜å¯¼è‡´ç³»ç»Ÿè¾“å‡ºè­¦å‘Šä¿¡æ¯æç¤ºé”™è¯¯ï¼Œè¿™ç§æƒ…å†µéœ€è¦è°ƒæ•´å®‰å…¨ç­–ç•¥ã€‚è°ƒæ•´ç­–ç•¥çš„ä½ç½®åœ¨Androidæºä»£ç çš„ ./system/sepolicy/ ç›®å½•ä¸­ï¼Œpublicã€privateç›®å½•ä¸‹ã€‚ publicï¼šè¯¥ç›®å½•åŒ…å«Androidç³»ç»Ÿä¸å‡½æ•°åº“ç­‰å…¬å…±çš„sepolicyè§„åˆ™ã€‚è¿™äº›è§„åˆ™æ˜¯å¼€å‘äººå‘˜å’Œå‚å•†å¯ä»¥è‡ªç”±ä½¿ç”¨å’Œä¿®æ”¹çš„ï¼Œå› ä¸ºè¿™äº›è§„åˆ™æ¶‰åŠåˆ°çš„æ˜¯å…¬å…±åŒºåŸŸçš„è®¿é—®æ§åˆ¶ã€‚ privateï¼šè¯¥ç›®å½•åŒ…å«ç¡¬ç¼–ç åˆ°Androidç³»ç»Ÿä¸­çš„ç‰¹å®šè§„åˆ™ã€‚è¿™äº›è§„åˆ™ç”¨äºæ§åˆ¶æ—¢å®šçš„Androidç³»ç»ŸåŠŸèƒ½å’Œåº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚æ‹¨å·åº”ç”¨ç¨‹åºã€ç”µæºç®¡ç†ç­‰ï¼Œå› æ­¤è¿™äº›è§„åˆ™ä¸èƒ½è¢«ä¿®æ”¹æˆ–è¦†ç›–ã€‚ â€‹ å½“ä¿®æ”¹Androidç³»ç»Ÿçš„SELinuxç­–ç•¥æ—¶ï¼Œç³»ç»Ÿä¼šä½¿ç”¨prebuiltsç›®å½•ä¸­çš„ç­–ç•¥è¿›è¡Œå¯¹æ¯”ï¼Œè¿™æ˜¯å› ä¸ºprebuiltsä¸­åŒ…å«äº†åœ¨ Androidè®¾å¤‡ä¸Šé¢„ç½®çš„SELinuxç­–ç•¥å’Œè§„åˆ™ã€‚ â€‹ å¯¹å®‰å…¨ç­–ç•¥æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£åï¼Œå…ˆçœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ‰¾åˆ°æ–‡ä»¶./system/sepolicy/public/adbd.te 12345# å®šä¹‰ç±»å‹type adbd, domain;# å…è®¸adbdç±»å‹çš„è¿›ç¨‹ï¼Œåœ¨ç±»å‹shell_test_data_fileä¸­çš„ç›®å½•å†…åˆ›å»ºå­ç›®å½•allow adbd shell_test_data_file:dir create_dir_perms; â€‹ è¿™é‡Œä½¿ç”¨äº†ä¸‰ä¸ªç±»å‹ï¼š adbdï¼šæŒ‡å®šè¿›ç¨‹çš„ç±»å‹ï¼› domainï¼šæŒ‡å®šåŸŸçš„ç±»å‹ï¼› shell_test_data_fileï¼šæŒ‡å®šç›®å½•çš„ç±»å‹ã€‚ â€‹ è§„åˆ™ä½¿ç”¨äº†allowå…³é”®å­—ï¼Œè¡¨ç¤ºå…è®¸æŸäº›æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œä¸Šè¿°è§„åˆ™å…è®¸adbdç±»å‹çš„è¿›ç¨‹åœ¨shell_test_data_fileç±»å‹çš„ç›®å½•ä¸‹åˆ›å»ºç›®å½•ï¼Œå¹¶ä¸”è¯¥ç›®å½•å°†è¢«èµ‹äºˆå…è®¸åˆ›å»ºå­ç›®å½•çš„æƒé™ï¼ˆç”±create_dir_permså®šä¹‰ï¼‰ã€‚ â€‹ è¿™ä¸ªè§„åˆ™çš„å®é™…æ„ä¹‰æ˜¯ï¼Œå½“adbdè¿›ç¨‹éœ€è¦åœ¨shell_test_data_fileç›®å½•ä¸‹åˆ›å»ºå­ç›®å½•æ—¶ï¼Œå…è®¸è¯¥æ“ä½œï¼Œå¹¶ä¸ºæ–°åˆ›å»ºçš„ç›®å½•è®¾ç½®é€‚å½“çš„æƒé™ã€‚æ³¨æ„ï¼Œè¿™ä¸ªè§„åˆ™åªå¯¹è¯¥ç›®å½•æœ‰æ•ˆï¼Œä¸èƒ½ç”¨äºå…¶ä»–ç›®å½•ã€‚ â€‹ é€šå¸¸æƒ…å†µä¸‹é‡‡ç”¨æŒ‰éœ€ä¿®æ”¹çš„æ–¹å¼è°ƒæ•´å®‰å…¨ç­–ç•¥ï¼Œå½“æ·»åŠ çš„åŠŸèƒ½è¢«å®‰å…¨ç­–ç•¥æ‹¦ä½æ—¶ï¼Œä¼šè¾“å‡ºè­¦å‘Šæç¤ºã€‚ä¾‹å¦‚åœ¨æ–‡ä»¶com_android_internal_os_Zygote.cppçš„SpecializeCommonå‡½æ•°ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œè®¿é—®dataç›®å½•ã€‚ 12std::string filepath=&quot;/data/app/demo&quot;;ReadFileToString(filepath,&amp;file_contents) â€‹ ç„¶åå°±ä¼šè¢«SELinuxæ‹¦æˆªå¹¶æç¤ºè­¦å‘Šä¿¡æ¯å¦‚ä¸‹ 1avc: denied { search } for name=&quot;app&quot; dev=&quot;dm-8&quot; ino=100 scontext=u:r:zygote:s0 tcontext=u:object_r:apk_data_file:s0 tclass=dir permissive=0 â€‹ åœ¨SELinuxä¸­ï¼Œavc: deniedæ˜¯å‡ºç°æœ€é¢‘ç¹çš„æç¤ºä¹‹ä¸€ï¼Œæ ¹æ®æç¤ºå¯ä»¥çŸ¥é“ï¼Œè¿›ç¨‹zygoteå¯¹å®‰å…¨ä¸Šä¸‹æ–‡ä¸ºu:object_r:apk_data_file:s0çš„ç›®å½•è¿›è¡Œsearchæ“ä½œï¼Œè¯¥è¡Œä¸ºè¢«æ‹’ç»äº†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–æ‹’ç»è®¿é—®çš„æç¤ºæ¶ˆæ¯å¦‚ä¸‹ã€‚ avc: denied {open} - è¡¨ç¤ºè¿›ç¨‹è¢«ç¦æ­¢æ‰“å¼€æ–‡ä»¶æˆ–è®¾å¤‡ã€‚ avc: denied {read} - è¡¨ç¤ºè¿›ç¨‹è¢«ç¦æ­¢è¯»å–ä¸€ä¸ªæ–‡ä»¶ã€è®¾å¤‡æˆ–ç›®å½•ã€‚ avc: denied {write} - è¡¨ç¤ºè¿›ç¨‹è¢«ç¦æ­¢å†™å…¥ä¸€ä¸ªæ–‡ä»¶ã€è®¾å¤‡æˆ–ç›®å½•ã€‚ avc: denied {getattr} - è¡¨ç¤ºè¿›ç¨‹è¢«ç¦æ­¢è¯»å–ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„å…ƒæ•°æ®ï¼ˆä¾‹å¦‚ï¼Œæ‰€æœ‰æƒã€ç»„ã€æƒé™ç­‰ï¼‰ã€‚ avc: denied {execute} - è¡¨ç¤ºè¿›ç¨‹è¢«ç¦æ­¢æ‰§è¡Œä¸€ä¸ªæ–‡ä»¶æˆ–è¿›ç¨‹ã€‚ avc: denied {create} - è¡¨ç¤ºè¿›ç¨‹è¢«ç¦æ­¢åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ã€‚ avc: denied {search} - è¡¨ç¤ºæ­¤è¿›ç¨‹è¢«ç¦æ­¢åœ¨æŸç›®å½•ä¸­æœç´¢æ–‡ä»¶çš„æ“ä½œ â€‹ é™¤äº† avc: deniedä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›å¯èƒ½å‡ºç°çš„æç¤ºä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§æç¤ºä¿¡æ¯ä»¥åŠå®ƒä»¬çš„å«ä¹‰ï¼š avc: granted - æ“ä½œè¢«å…è®¸ã€‚ avc: audit - æ­£åœ¨ç›‘è§†æ‰§è¡Œä¸Šä¸‹æ–‡ä¹‹é—´çš„äº¤äº’ï¼Œå¹¶å°†ç›¸å…³ä¿¡æ¯è®°å½•åˆ°å®¡è®¡æ—¥å¿—ä¸­ã€‚ avc: no audit - æ²¡æœ‰è®°å½•æ­¤æ“ä½œçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿™é€šå¸¸æ˜¯å› ä¸ºæ²¡æœ‰å¯ç”¨SELinuxçš„å®¡è®¡åŠŸèƒ½ã€‚ avc: invalid - æ“ä½œè¯·æ±‚çš„æƒé™éæ³•æˆ–æ— æ•ˆã€‚ avc: timeout - SELinuxè§„åˆ™åˆ†æå™¨è¶…æ—¶æ— æ³•ç¡®å®šæ“ä½œæ˜¯å¦åº”è¯¥å…è®¸ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ“ä½œé€šå¸¸ä¼šè¢«æ‹’ç»ã€‚ avc: failed - SELinuxè§„åˆ™åˆ†æå™¨æ— æ³•ç¡®å®šæ“ä½œæ˜¯å¦åº”è¯¥è¢«å…è®¸æˆ–æ‹’ç»ã€‚ â€‹ åœ¨SELinuxä¸­ï¼Œscontextä»£è¡¨ç³»ç»Ÿä¸­çš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œtcontextä»£è¡¨å¯¹è±¡çš„å®‰å…¨ä¸Šä¸‹æ–‡ã€‚æ¯ä¸ªå…·æœ‰æƒé™è¦æ±‚çš„è¿›ç¨‹å’Œå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå®‰å…¨ä¸Šä¸‹æ–‡ã€‚SELinuxä½¿ç”¨è¿™äº›å®‰å…¨ä¸Šä¸‹æ–‡æ¥è¿›è¡Œè®¿é—®æ§åˆ¶å†³ç­–ã€‚ scontextå’Œtcontextä¸­çš„â€œuâ€ï¼Œâ€œrâ€å’Œâ€œs0â€æ˜¯å®‰å…¨ä¸Šä¸‹æ–‡æ ‡è®°çš„ä¸åŒéƒ¨åˆ†ã€‚å«ä¹‰å¦‚ä¸‹ï¼š u - ä»£è¡¨selinuxä¸­å®šä¹‰çš„ç”¨æˆ·ï¼Œtcontextä¸­çš„uä»£è¡¨å¯¹è±¡æ‰€å±ç”¨æˆ·ã€‚ r - ä»£è¡¨è¿›ç¨‹çš„è§’è‰²ï¼ˆroleï¼‰ï¼Œtcontextä¸­çš„rä»£è¡¨å¯¹è±¡çš„è§’è‰²ã€‚ s0 - ä»£è¡¨è¿›ç¨‹çš„å®‰å…¨ç­–ç•¥èŒƒå›´ï¼ˆsecurity levelï¼‰ï¼Œtcontextä¸­çš„s0ä»£è¡¨å¯¹è±¡çš„å®‰å…¨ç­–ç•¥èŒƒå›´ã€‚s0é€šå¸¸è¡¨ç¤ºä¸ºé»˜è®¤å€¼ã€‚ â€‹ å¯ä»¥é€šè¿‡å‘½ä»¤ps -eZæ¥æŸ¥çœ‹è¿›ç¨‹çš„scontextã€‚ 1234567ps -eZu:r:servicemanager:s0 system 672 1 10860740 3784 SyS_epoll+ 0 S servicemanageru:r:hwservicemanager:s0 system 673 1 10880928 4648 SyS_epoll+ 0 S hwservicemanageru:r:kernel:s0 root 674 2 0 0 worker_th+ 0 S [kworker/7:1H]u:r:vndservicemanager:s0 system 675 1 10813436 2884 SyS_epoll+ 0 S vndservicemanageru:r:kernel:s0 root 676 2 0 0 kthread_w+ 0 S [psimon] â€‹ å¯ä»¥é€šè¿‡å‘½ä»¤ls -Zæ¥æŸ¥çœ‹æ–‡ä»¶çš„scontext 12345cd /data/appls -Z -alldrwxrwxr-x 3 system system u:object_r:apk_data_file:s0 3488 2023-02-26 21:50:57.968696920 +0800 ~~QZ-rYHaywe6nr2ryYn3UoQ==drwxrwxr-x 3 system system u:object_r:apk_data_file:s0 3488 2023-03-02 22:12:29.802016689 +0800 ~~W9dmzmphiDsjJm79RiBwdg== â€‹ é‡æ–°å¯¹ä¸‹é¢çš„è¿™ä¸ªæç¤ºè¿›è¡Œä¸€æ¬¡è§£è¯»ã€‚selinuxæ‹’ç»æœç´¢ä¸€ä¸ªç›®å½•ï¼Œç›®å½•åç§°ä¸ºappï¼Œæ‰€åœ¨è®¾å¤‡ä¸ºdm-8ï¼Œè¢«æ‹’ç»çš„è¿›ç¨‹ä¸Šä¸‹æ–‡ç‰¹å¾æ˜¯u:r:zygote:s0ï¼Œè§’è‰²æ˜¯zygoteï¼Œç›®æ ‡æ–‡ä»¶ä¸Šä¸‹æ–‡ç‰¹å¾æ˜¯u:object_r:apk_data_file:s0ï¼Œç”¨æˆ·çº§åˆ«ä¸ºobject_rï¼Œæ–‡ä»¶çš„æ‰€å±ç±»å‹æ˜¯apk_data_fileï¼Œè¡¨ç¤ºåº”ç”¨ç¨‹åºçš„æ•°æ®æ–‡ä»¶ã€‚tclassè¡¨ç¤ºè¯·æ±‚å¯¹è±¡çš„ç±»å‹ï¼Œdirä¸ºç›®å½•ï¼Œfileè¡¨ç¤ºæ–‡ä»¶ 1avc: denied { search } for name=&quot;app&quot; dev=&quot;dm-8&quot; ino=100 scontext=u:r:zygote:s0 tcontext=u:object_r:apk_data_file:s0 tclass=dir permissive=0 â€‹ è§£è¯»å®Œæˆåï¼Œå¯ä»¥å¼€å§‹è°ƒæ•´å®‰å…¨ç­–ç•¥äº†ï¼Œæ‰¾åˆ°æ–‡ä»¶system/sepolicy/private/zygote.teï¼Œç„¶åæ·»åŠ ç­–ç•¥å¦‚ä¸‹ 1allow zygote apk_data_file:dir search; â€‹ ä¿®æ”¹å®Œæˆåç¼–è¯‘æ—¶ï¼Œä¼šæŠ¥é”™ï¼Œæç¤ºdiffå¯¹æ¯”æ–‡ä»¶æ—¶å‘ç°å†…å®¹ä¸ä¸€è‡´ã€‚æœ€åå†å°†æ–‡ä»¶system/sepolicy/prebuilts/api/31.0/private/zygote.teä¸‹æ·»åŠ ç›¸åŒçš„ç­–ç•¥å³å¯æˆåŠŸç¼–è¯‘ã€‚ â€‹ neverallowæ˜¯SELinuxç­–ç•¥è¯­è¨€ä¸­çš„ä¸€ä¸ªè§„åˆ™ï¼Œå®ƒç”¨äºæŒ‡å®šæŸä¸ªæ“ä½œæ°¸è¿œä¸å…è®¸æ‰§è¡Œã€‚neverallowè§„åˆ™ç”¨äºè®¾ç½®ä¸€äº›å¼ºåˆ¶è®¿é—®æ§åˆ¶è§„åˆ™ï¼Œä»¥åœ¨å®‰å…¨ç­–ç•¥ä¸­æ˜ç¡®ç¦æ­¢æŸäº›è¡Œä¸ºï¼Œä»è€Œæé«˜å…¶å®‰å…¨æ€§ã€‚neverallowè§„åˆ™ä¸allowè§„åˆ™åœ¨è¯­æ³•ä¸Šéå¸¸ç›¸ä¼¼ï¼Œä½†åœ¨ä½œç”¨ä¸Šæˆªç„¶ä¸åŒã€‚ â€‹ æœ‰æ—¶æŒ‰ç…§è­¦å‘Šä¿¡æ¯æç¤ºï¼Œæ·»åŠ äº†å¯¹åº”ç­–ç•¥åæ— æ³•ç¼–è¯‘é€šè¿‡æç¤ºè¿åäº†neverallowã€‚è¿™ç§æƒ…å†µå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„neverallowï¼Œè¿›è¡Œä¿®æ”¹æ·»åŠ ä¸€ä¸ªç™½åå•æ¥æ”¾è¿‡æ·»åŠ çš„è§„åˆ™ã€‚ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ 1234567neverallow { coredomain -fsck -init -ueventd -zygote} device:{ blk_file file } no_rw_file_perms; â€‹ è¿™ä¸ªè§„åˆ™ç¦æ­¢ä¸Šè¿°è¿›ç¨‹ä»¥å¯è¯»å¯å†™æƒé™è¯»å†™ device ç±»å‹çš„æ–‡ä»¶ï¼Œå…¶ä¸­-zygoteï¼Œè¿™ç§å‰é¢å¸¦æœ‰-è¡¨ç¤ºæ’é™¤æ‰è¿™ç§è¿›ç¨‹ï¼Œå¦‚æœè¢«è®¾ç½®äº†æ°¸ä¸å…è®¸ï¼Œåªè¦æ‰¾åˆ°å¯¹åº”çš„è®¾ç½®å¤„ï¼Œæ·»åŠ ä¸Šæ’é™¤å¯¹åº”è¿›ç¨‹å³å¯æˆåŠŸç¼–è¯‘äº†ã€‚ 3.12 äº†è§£Linkerâ€‹ Linkeræ˜¯å®‰å“ä¸­çš„ä¸€ä¸ªç³»ç»Ÿç»„ä»¶ï¼Œè´Ÿè´£åŠ è½½å’Œé“¾æ¥ç³»ç»ŸåŠ¨æ€åº“æ–‡ä»¶ã€‚ â€‹ åœ¨Androidæºä»£ç ä¸­ï¼ŒLinkeræºç çš„ä¸»è¦ç›®å½•æ˜¯bionic/linkerã€‚è¯¥ç›®å½•åŒ…å«Linkerçš„æ ¸å¿ƒå®ç°ï¼Œå¦‚åŠ¨æ€åŠ è½½ã€ç¬¦å·è¡¨ç®¡ç†ã€é‡å®šä½ã€ç¬¦å·è§£æã€SOæ–‡ä»¶æœç´¢ç­‰ã€‚å…¶ä¸­ï¼Œlinker.cæ˜¯Linkerçš„ä¸»è¦å…¥å£ç‚¹ï¼Œè¯¥æ–‡ä»¶ä¸­åŒ…å«äº†å¤§é‡çš„å®ç°ç»†èŠ‚ã€‚linker_phdr.cæ˜¯è´Ÿè´£åŠ è½½å’Œå¤„ç†ELFæ ¼å¼åº“æ–‡ä»¶çš„ä»£ç ï¼Œlinker_namespaces.cppè´Ÿè´£ç®¡ç†å‘½åç©ºé—´çš„ä»£ç ï¼Œlinker_relocs.cppè´Ÿè´£å¤„ç†é‡å®šä½çš„ä»£ç ï¼Œlinker_sleb128.cppå’Œlinker_uleb128.cppè´Ÿè´£å‹ç¼©å’Œè§£å‹ç¼©æ•°æ®çš„å®ç°ç­‰ã€‚é™¤äº†bionic/linkerç›®å½•å¤–ï¼ŒLinkerç›¸å…³çš„ä»£ç è¿˜åˆ†æ•£åœ¨å…¶ä»–ç³»ç»Ÿç»„ä»¶ä¸­ï¼Œä¾‹å¦‚ç³»ç»ŸæœåŠ¡å’Œåº”ç”¨ç¨‹åºæ¡†æ¶ã€‚ â€‹ linkeræä¾›çš„ä¸€äº›å‡½æ•°æ¥æ“ä½œåŠ¨æ€åº“ï¼Œç›¸å…³å‡½æ•°å¦‚ä¸‹ã€‚ â€‹ 1. dlopenï¼šæ‰“å¼€ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“å¹¶è¿”å›å¥æŸ„ã€‚ â€‹ 2. dlsymï¼šæŸ¥æ‰¾åŠ¨æ€é“¾æ¥åº“ä¸­ç¬¦å·çš„åœ°å€ã€‚ â€‹ 3. dlcloseï¼šå…³é—­å…ˆå‰æ‰“å¼€çš„åŠ¨æ€é“¾æ¥åº“ã€‚ â€‹ 4. dlerrorï¼šè¿”å›æœ€è¿‘çš„åŠ¨æ€é“¾æ¥åº“é”™è¯¯ã€‚ â€‹ 5. dladdrï¼šæ ¹æ®ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œè¿”å›æ˜ å°„åˆ°è¯¥åœ°å€çš„å‡½æ•°æˆ–å˜é‡çš„ä¿¡æ¯ã€‚ â€‹ 6. dl_iterate_phdrï¼šéå†è¿›ç¨‹çš„åŠ¨æ€é“¾æ¥åº“æ¨¡å—ï¼Œå¯ä»¥è·å–æ¨¡å—åœ°å€ã€åŒåæ¨¡å—åˆ—è¡¨ç­‰ä¿¡æ¯ã€‚ â€‹ åœ¨å¼€å§‹äº†è§£Linkerå¦‚ä½•åŠ è½½åŠ¨æ€åº“soæ–‡ä»¶å‰ï¼Œéœ€è¦å…ˆå¯¹soæ–‡ä»¶æœ‰ä¸€ä¸ªç®€å•çš„äº†è§£ã€‚ 3.12.1 ELFæ–‡ä»¶æ ¼å¼â€‹ åœ¨Androidä¸­ï¼Œsoï¼ˆShared Objectï¼‰åŠ¨æ€åº“æ˜¯ä¸€ç§æ˜¯ä¸€ç§åŸºäºELFæ ¼å¼ï¼ˆExecutable and Linkable Formatï¼‰çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒåŒ…å«å·²ç¼–è¯‘çš„å‡½æ•°å’Œæ•°æ®ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶è¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶è¢«å¤šä¸ªåº”ç”¨ç¨‹åºæˆ–å…±äº«åº“ä½¿ç”¨ã€‚ â€‹ ä¸é™æ€åº“ä¸åŒï¼ŒåŠ¨æ€åº“ä¸­çš„ä»£ç åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­å¹¶ä¸å­˜åœ¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸€äº›åŠ¨æ€é“¾æ¥å™¨ï¼ˆLinkerï¼‰ç¼–è¯‘æ—¶ä¸çŸ¥é“çš„å¤–éƒ¨å¼•ç”¨ç¬¦å·ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒLinkerä¼šæ ¹æ®åŠ¨æ€åº“ä¸­çš„ç¬¦å·è¡¨æ¥è§£æè¿™äº›å¼•ç”¨ï¼Œå¹¶å°†åŠ¨æ€åº“ä¸­çš„å‡½æ•°å’Œæ•°æ®é“¾æ¥åˆ°å¯æ‰§è¡Œç¨‹åºä¸­ã€‚ â€‹ è¿›ç¨‹é—´å…±äº«åŠ¨æ€åº“å¯ä»¥å¤§å¤§å‡å°‘å†…å­˜ä½¿ç”¨ï¼Œæé«˜ä»£ç é‡ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¤šä¸ªåº”ç”¨ç¨‹åºéƒ½éœ€è¦ä½¿ç”¨åŒä¸€ç»„ä»¶åº“ï¼Œå¯ä»¥å°†å…¶å®ç°ä½œä¸ºå…±äº«åº“æä¾›ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½å¯ä»¥ä½¿ç”¨åŒä¸€ä»½åº“ï¼Œè€Œä¸å¿…å°†ä»£ç é‡å¤æ·»åŠ åˆ°æ¯ä¸ªåº”ç”¨ç¨‹åºä¸­ã€‚ â€‹ åœ¨ELFæ–‡ä»¶ç»“æ„ä¸­ï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼š ELF Headerï¼ŒELFæ–‡ä»¶å¤´ï¼ŒåŒ…å«äº†æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¾‹å¦‚æ–‡ä»¶ç±»å‹ã€ç¨‹åºå…¥å£åœ°å€ã€èŠ‚è¡¨çš„ä½ç½®å’Œå¤§å°ç­‰ã€‚ Section Headerï¼ŒèŠ‚å¤´éƒ¨åˆ†ï¼Œæè¿°äº†æ–‡ä»¶ä¸­å„ä¸ªèŠ‚çš„å¤§å°ã€ç±»å‹å’Œä½ç½®ç­‰ä¿¡æ¯ã€‚ELFæ–‡ä»¶ä¸­çš„æ¯ä¸ªèŠ‚éƒ½åŒ…å«æŸç§ç±»å‹çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ä»£ç ã€æ•°æ®ã€ç¬¦å·è¡¨ã€é‡å®šä½è¡¨ä»¥åŠå…¶ä»–è°ƒè¯•ä¿¡æ¯ç­‰ã€‚ Program Headerï¼Œæ®µå¤´éƒ¨åˆ†ï¼Œæè¿°äº†å¯æ‰§è¡Œæ–‡ä»¶åœ¨å†…å­˜ä¸­çš„å¸ƒå±€ã€‚ç”±äºELFæ–‡ä»¶çš„èŠ‚å¯ä»¥ä»¥ä»»æ„é¡ºåºæ’åˆ—ï¼Œå› æ­¤Linkeråœ¨åŠ è½½å‰éœ€è¦ä½¿ç”¨Program Headeræ¥é‡Šæ”¾å¹¶æ˜ å°„è™šæ‹Ÿå†…å­˜ï¼Œåˆ›å»ºè¿›ç¨‹è™šæ‹Ÿå†…å­˜æ®µå¸ƒå±€ã€‚Program Headerä¹ŸåŒ…å«äº†åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚åŠ¨æ€åº“çš„ä½ç½®ã€ä¾èµ–å…³ç³»å’Œç¬¦å·è¡¨ä½ç½®ç­‰ã€‚ â€‹ ä½¿ç”¨Android Studioåˆ›å»ºä¸€ä¸ªNative C++çš„é¡¹ç›®ï¼ŒæˆåŠŸç¼–è¯‘åæ¥åˆ°outputç›®å½•ä¸­ï¼Œè§£å‹app-debug.apkæ–‡ä»¶ï¼Œç„¶åè¿›å…¥app-debug\\lib\\arm64-v8a\\ç›®å½•ï¼Œæ‰¾åˆ°soæ–‡ä»¶å°†å…¶æ‹–å…¥010 Editorç¼–è¾‘å™¨å·¥å…·ä¸­ã€‚ â€‹ æ¥ç€ç»™010 Editorç¼–è¾‘å™¨å®‰è£…ä¸€ä¸ªELFæ ¼å¼è§£æçš„æ¨¡æ¿ï¼Œåœ¨å·¥å…·æ æ‰¾åˆ°æ¨¡æ¿-&gt;æ¨¡æ¿å­˜å‚¨åº“ã€‚æœç´¢ELFï¼Œç‚¹å‡»å®‰è£…ï¼Œæ“ä½œè§ä¸‹å›¾ã€‚ â€‹ æ¨¡æ¿å®‰è£…åï¼Œå…³é—­æ–‡ä»¶ï¼Œé‡æ–°ä½¿ç”¨010 Editoræ‰“å¼€åï¼Œå°†ç¼–è¾‘æ–¹å¼åˆ‡æ¢ä¸ºæ¨¡æ¿åï¼Œå°±èƒ½æˆåŠŸçœ‹åˆ°ä½¿ç”¨ELFæ ¼å¼è§£æsoæ–‡ä»¶çš„ç»“æœäº†ï¼Œå¦‚ä¸‹å›¾ã€‚ â€‹ ELFå¤´éƒ¨å®šä¹‰äº†ELFæ–‡ä»¶çš„åŸºæœ¬å±æ€§å’Œç»“æ„ï¼Œä¹Ÿä¸ºåç»­çš„æ®µè¡¨å’ŒèŠ‚è¡¨ç­‰ä¿¡æ¯æä¾›äº†é‡è¦çš„æŒ‡å¯¼ä½œç”¨ã€‚åŠ è½½ELFæ–‡ä»¶çš„ç¬¬ä¸€æ­¥å°±æ˜¯è§£æELFå¤´éƒ¨åï¼Œå†æ ¹æ®å¤´éƒ¨ä¿¡æ¯å»è§£æå…¶ä»–éƒ¨åˆ†çš„æ•°æ®ï¼ŒELFå¤´éƒ¨ï¼ˆelf_headerï¼‰ç»“æ„åŒ…å«ä»¥ä¸‹æˆå‘˜ï¼š e_identï¼šé•¿åº¦ä¸º 16 å­—èŠ‚çš„æ•°ç»„ï¼Œç”¨äºæ ‡è¯†æ–‡ä»¶ç±»å‹å’Œæ–‡ä»¶ç‰ˆæœ¬ç­‰ä¿¡æ¯ã€‚ e_typeï¼šELFæ–‡ä»¶ç±»å‹ï¼Œå¦‚å¯æ‰§è¡Œæ–‡ä»¶ã€å…±äº«åº“ã€ç›®æ ‡æ–‡ä»¶ç­‰ç­‰ã€‚ e_machineï¼šç›®æ ‡ç¡¬ä»¶æ¶æ„ã€‚ e_versionï¼šELFæ–‡ä»¶çš„ç‰ˆæœ¬ï¼Œå…¶ä¸€èˆ¬ä¸ºEV_CURRENTã€‚ e_entryï¼šç¨‹åºå…¥å£ç‚¹çš„è™šæ‹Ÿåœ°å€ã€‚ e_phoffï¼šç¨‹åºå¤´è¡¨ï¼ˆprogram header tableï¼‰çš„åç§»é‡ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ e_shoffï¼šèŠ‚å¤´è¡¨ï¼ˆsection header tableï¼‰çš„åç§»é‡ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ e_flagsï¼šè¡¨ç¤ºä¸€äº›æ ‡å¿—ï¼Œæ¯”å¦‚é’ˆå¯¹ç¡¬ä»¶è¿›è¡Œå¾®è°ƒçš„æ ‡å¿—ã€‚ e_ehsizeï¼šELFå¤´éƒ¨çš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ e_phentsizeï¼šç¨‹åºå¤´è¡¨ä¸­ä¸€ä¸ªå…¥å£çš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ e_phnumï¼šç¨‹åºå¤´è¡¨ä¸­å…¥å£çš„æ•°é‡ã€‚ e_shentsizeï¼šèŠ‚å¤´è¡¨ä¸­ä¸€ä¸ªå…¥å£çš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ e_shnumï¼šèŠ‚å¤´è¡¨ä¸­å…¥å£çš„æ•°é‡ã€‚ e_shstrndxï¼šèŠ‚å¤´è¡¨ä¸­èŠ‚åç§°å­—ç¬¦ä¸²è¡¨çš„ç´¢å¼•ã€‚ â€‹ ä¸‹å›¾æ˜¯010 Edtiorè§£æå±•ç¤ºçš„ç»“æœå›¾ã€‚ â€‹ program header tableæ˜¯ä¸€ç§ç”¨äºæè¿°å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«åº“çš„å„ä¸ªæ®µï¼ˆsectionï¼‰åœ¨è¿›ç¨‹å†…å­˜ä¸­çš„æ˜ å°„å…³ç³»çš„ç»“æ„ï¼Œä¹Ÿç§°ä¸ºæ®µè¡¨ã€‚æ¯ä¸ªç¨‹åºå¤´è¡¨å…¥å£è¡¨ç¤ºä¸€ä¸ªæ®µã€‚åœ¨Linuxç³»ç»Ÿä¸­ï¼Œå®ƒæ˜¯è¢«æ“ä½œç³»ç»Ÿç”¨äºå°†ELFæ–‡ä»¶åŠ è½½åˆ°è¿›ç¨‹åœ°å€ç©ºé—´çš„é‡è¦æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚æ¯ä¸ªprogram header tableå…·æœ‰ç›¸åŒçš„å›ºå®šç»“æ„ï¼Œç›¸å…³å­—æ®µå¦‚ä¸‹ï¼š p_typeï¼šæŒ‡å®šè¯¥æ®µçš„ç±»å‹ï¼Œå¦‚å¯æ‰§è¡Œä»£ç ã€åªè¯»æ•°æ®ã€å¯è¯»å†™æ•°æ®ã€åŠ¨æ€é“¾æ¥è¡¨ã€æ³¨é‡Šç­‰ç­‰ã€‚ p_offsetï¼šè¯¥æ®µåœ¨ELFæ–‡ä»¶ä¸­çš„åç§»é‡ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ p_vaddrï¼šè¯¥æ®µåœ¨è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„èµ·å§‹åœ°å€ã€‚ p_paddrï¼šè¯¥é¡¹é€šå¸¸ä¸p_vaddrç›¸ç­‰ã€‚ç”¨äºæ“ä½œç³»ç»Ÿåœ¨å°†ELFæ–‡ä»¶çš„ä¸€ä¸ªæ®µæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´å‰ï¼Œè¿›è¡Œè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„è½¬æ¢ç­‰æ“ä½œã€‚ p_fileszï¼šè¯¥æ®µåœ¨æ–‡ä»¶ä¸­çš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ p_memszï¼šè¯¥æ®µåœ¨åŠ åˆ°è¿›ç¨‹åœ°å€ç©ºé—´åçš„é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ p_flagsï¼šç”¨äºæè¿°è¯¥æ®µçš„æ ‡å¿—ï¼Œå¦‚å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œã€ä¸å¯ç¼“å­˜ç­‰ç­‰ã€‚ p_alignï¼šå¯¹äºæŸäº›ç±»å‹çš„æ®µï¼Œè¯¥å­—æ®µç”¨äºæŒ‡å®šæ®µåœ¨åœ°å€ç©ºé—´ä¸­çš„å¯¹é½æ–¹å¼ã€‚ â€‹ ä¸‹å›¾æ˜¯ç¼–è¾‘å™¨ä¸­è§£æsoçœ‹åˆ°çš„å€¼ â€‹ section header tableï¼ˆèŠ‚å¤´è¡¨ï¼‰æ˜¯ç”¨äºæè¿°ELFæ–‡ä»¶ä¸­æ‰€æœ‰èŠ‚ï¼ˆsectionï¼‰çš„å…ƒä¿¡æ¯åˆ—è¡¨ï¼Œä¹Ÿç§°ä¸ºèŠ‚è¡¨ã€‚å®ƒåŒ…å«äº†æ¯ä¸ªèŠ‚åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®ã€å¤§å°ã€ç±»å‹ã€å±æ€§ç­‰ä¿¡æ¯ã€‚èŠ‚å¤´è¡¨çš„ä¸­ç›¸å…³å­—æ®µå¦‚ä¸‹ï¼š sh_name: èŠ‚çš„åå­—åœ¨.shstrtabèŠ‚ä¸­çš„å‘åç§»é‡ã€‚è¿™ä¸ªåç§»é‡å¯ä»¥ç”¨äºè·å–è¯¥èŠ‚çš„åå­—ã€‚ sh_typeï¼šèŠ‚çš„ç±»å‹ï¼ˆtypeï¼‰ï¼Œå¦‚ä»£ç æ®µã€æ•°æ®æ®µã€ç¬¦å·è¡¨ç­‰ã€‚ sh_flagsï¼šèŠ‚çš„å±æ€§æ ‡å¿—ï¼Œå¦‚æ˜¯å¦å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œç­‰ã€‚ sh_addrï¼šèŠ‚çš„å†…å­˜åœ°å€ï¼ˆvirtual addressï¼‰ï¼Œå½“è¿™ä¸ªåœ°å€ä¸ºé›¶æ—¶ï¼Œè¡¨ç¤ºè¿™ä¸ªèŠ‚æ²¡æœ‰è¢«åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ sh_offsetï¼šèŠ‚åœ¨ELFæ–‡ä»¶ä¸­çš„åç§»é‡ï¼ˆoffsetï¼‰ã€‚ sh_sizeï¼šèŠ‚çš„é•¿åº¦ï¼ˆsizeï¼‰å±æ€§ã€‚ sh_linkï¼šèŠ‚çš„è¿æ¥èŠ‚ï¼ˆlinking sectionï¼‰ï¼Œå¯ä»¥å¸®åŠ©å®šä½ä¸€äº›èŠ‚ï¼Œå¦‚ç¬¦å·è¡¨ã€‚ sh_infoï¼šä¸sh_linkä¸€èµ·ä½¿ç”¨ï¼Œå…·ä½“å«ä¹‰ä¸sh_linkçš„å€¼æœ‰å…³ã€‚ sh_addralignï¼šèŠ‚çš„å¯¹é½æ–¹å¼ï¼ˆalignmentï¼‰ã€‚ sh_entsizeï¼šèŠ‚çš„entryçš„å¤§å°ã€‚ â€‹ é€šè¿‡è¿™äº›ä¿¡æ¯ï¼Œsection header tableå¯ä»¥ä¸ºæ‰§è¡Œé“¾æ¥å’ŒåŠ¨æ€åŠ è½½æä¾›å¿…è¦çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚æ ·ä¾‹æ•°æ®çœ‹ä¸‹å›¾ â€‹ ELFæ–‡ä»¶ä¸­æœ‰å„ç§èŠ‚ç”¨äºå­˜æ”¾å¯¹åº”çš„ä¿¡æ¯ï¼Œå‡ ä¸ªå¸¸è§çš„èŠ‚ç‚¹å­˜æ”¾æ•°æ®çš„æè¿°å¦‚ä¸‹ã€‚ .dynsym èŠ‚ï¼šè¯¥èŠ‚åŒ…å«åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨ï¼ˆdynamic symbol tableï¼‰ï¼Œç”¨äºæè¿°.soæ–‡ä»¶æ‰€åŒ…å«çš„åŠ¨æ€é“¾æ¥åº“ä¸­çš„ç¬¦å·ã€‚ç¬¦å·æ˜¯ç¨‹åºä¸­ä¸€äº›å‘½åå®ä½“çš„åç§°ï¼Œä¾‹å¦‚å‡½æ•°ã€å˜é‡ã€å¸¸é‡ç­‰ç­‰ï¼Œæè¿°äº†è¿™äº›å®ä½“åœ¨ç¨‹åºä¸­çš„åœ°å€å’Œå¤§å°ç­‰ä¿¡æ¯ã€‚.dynsym èŠ‚å¯ä»¥ååŠ©åŠ¨æ€åŠ è½½å™¨ï¼ˆDynamic Linkerï¼‰åœ¨ç¨‹åºè¿è¡Œæ—¶é€ä¸ªæŸ¥æ‰¾ç¬¦å·ã€‚ .dynstr èŠ‚ï¼šç”¨äºå­˜æ”¾ç¬¦å·è¡¨ä¸­çš„å­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬å‡½æ•°åã€å˜é‡åã€åº“åç­‰ç­‰ã€‚ .plt èŠ‚ï¼šä¿å­˜äº†è¿œç¨‹å‡½æ•°è°ƒç”¨å®ç°çš„è·³è½¬ä»£ç ã€‚ .rodata èŠ‚ï¼šåŒ…å«ç¨‹åºä¸­åªè¯»æ•°æ®çš„ä»£ç æ®µï¼Œå¦‚å­—ç¬¦ä¸²å¸¸é‡ã€å…¨å±€å¸¸é‡ç­‰ç­‰ã€‚ .text èŠ‚ï¼šç¨‹åºçš„ä¸»è¦ä»£ç å­˜æ”¾åœ¨è¯¥èŠ‚ä¸­ã€‚è¯¥èŠ‚åŒ…å«å¯æ‰§è¡Œä»£ç çš„æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼Œä¾‹å¦‚å‡½æ•°ä»£ç ã€æ¡ä»¶è¯­å¥ã€å¾ªç¯è¯­å¥ç­‰ç­‰ã€‚ .bss èŠ‚ç‚¹ï¼ˆBlock Started by Symbolï¼‰å­˜å‚¨æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œå…¶å¤§å°åœ¨ç¼–è¯‘æ—¶æ— æ³•ç¡®å®šã€‚å› æ­¤ï¼Œ.bssèŠ‚ç‚¹åœ¨ELFæ–‡ä»¶ä¸­åªå æ®ä¸€äº›ç©ºé—´ï¼Œè¯¥ç©ºé—´ç§°ä¸ºbssæ®µã€‚è€Œåœ¨è¿è¡Œæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†é…å®é™…çš„å†…å­˜ç©ºé—´ç»™è¿™äº›å˜é‡ã€‚.bssèŠ‚ç‚¹çš„å¤§å°åœ¨ ELFæ–‡ä»¶å¤´çš„e_shsizeå­—æ®µä¸­ç»™å‡ºã€‚ .shstrtab èŠ‚ç‚¹ï¼ˆSection Header String Tableï¼‰å­˜å‚¨èŠ‚åç§°å­—ç¬¦ä¸²ï¼Œå³æ¯ä¸ªèŠ‚çš„åç§°å’ŒèŠ‚å¤´è¡¨ä¸­çš„èŠ‚åç§°åç§»é‡ã€‚å®ƒåŒ…å«äº†ELFæ–‡ä»¶ä¸­æ¯ä¸ªèŠ‚çš„å­—ç¬¦ä¸²åç§°ï¼Œæ–¹ä¾¿è¯»å–ç¨‹åºåœ¨åŠ è½½æ—¶å¿«é€Ÿè®¿é—®ã€‚åœ¨Androidä¸­ï¼Œ.shstrtabèŠ‚ç‚¹æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„èŠ‚ï¼Œå®ƒä½äºèŠ‚å¤´è¡¨çš„æœ«å°¾ï¼Œå¯ä»¥é€šè¿‡ELFæ–‡ä»¶å¤´çš„e_shstrndxå­—æ®µæ‰¾åˆ°ã€‚ 3.12.2 åŠ¨æ€åº“åŠ è½½æµç¨‹â€‹ LinkeråŠ¨æ€åº“åŠ è½½æ˜¯æŠŠä»£ç ï¼ˆå‡½æ•°ã€å˜é‡ã€æ•°æ®ç»“æ„ç­‰ï¼‰ä»åŠ¨æ€é“¾æ¥åº“ï¼ˆsoæ–‡ä»¶ï¼‰ä¸­åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶å»ºç«‹èµ·ä»£ç ä¹‹é—´çš„ç›¸äº’å¼•ç”¨å…³ç³»çš„è¿‡ç¨‹ã€‚åœ¨Androidç­‰æ“ä½œç³»ç»Ÿä¸­ï¼ŒLinkeråŠ¨æ€åŠ è½½ä¸»è¦ç”¨äºæ¨¡å—åŒ–å¼€å‘ï¼Œå°†ç¨‹åºåˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œä»¥ä¾¿äºä»£ç çš„ç®¡ç†å’Œç»´æŠ¤ã€‚ä¸‹é¢æ˜¯LinkeråŠ¨æ€åŠ è½½çš„ä¸»è¦æ­¥éª¤ï¼š æ ¹æ®ç³»ç»Ÿçš„è¿è¡Œæ—¶éœ€æ±‚ï¼Œå°†éœ€è¦çš„åº“æ–‡ä»¶åŠ è½½è¿›å†…å­˜ä¸­ï¼Œå®ç°ä»£ç é‡ç”¨å’Œå…±äº«ã€‚æ­¤æ—¶ï¼ŒLinkerä¼šæ‰§è¡Œä¸€äº›ç‰¹å®šçš„é€»è¾‘ï¼Œå¦‚ä¾èµ–ä¼˜åŒ–ã€soæ–‡ä»¶ç‰ˆæœ¬æ£€æŸ¥ç­‰ã€‚ åœ¨è¿›è¡ŒåŠ¨æ€é“¾æ¥çš„è¿‡ç¨‹ä¸­ï¼ŒLinkerä¼šä¸ºæ¯ä¸ªåº“å’Œæ¯ä¸ªå‡½æ•°ç”Ÿæˆå…¨å±€å”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œä»¥ç¡®å®šä»£ç æ‰€åœ¨çš„åœ°å€ã€‚è¿™ä¸ªæ ‡è¯†ç¬¦ä¼šåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­åµŒå…¥åˆ°åº“æ–‡ä»¶çš„å¤´éƒ¨ï¼Œå¹¶ä¸”ä¿å­˜åˆ°åŠ¨æ€é“¾æ¥åº“çš„ç¬¦å·è¡¨ä¸­ã€‚ è§£æç¬¦å·è¡¨ã€‚Linkerä¼šè¯»å–åº“æ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œå¹¶æŠŠç¬¦å·åå’Œç¬¦å·åœ°å€é…å¯¹èµ·æ¥ï¼Œä»¥ä¾¿äºåœ¨ç¨‹åºè¿è¡ŒæœŸé—´åœ¨å†…å­˜ä¸­åŠ¨æ€åœ°è¿æ¥ä»–ä»¬ã€‚ æ£€æŸ¥ç¬¦å·è¡¨ä¸­çš„å‡½æ•°çš„å…¶ä»–åº“ä¾èµ–é¡¹ã€‚å¦‚æœå½“å‰åº“ä¾èµ–äºå…¶ä»–åº“ï¼ŒLinkerå°±ä¼šé€’å½’åœ°å¯¹è¿™äº›ä¾èµ–åº“è¿›è¡ŒåŠ è½½ã€è§£æå’Œé“¾æ¥ã€‚ è°ƒæ•´ç¬¦å·åœ°å€ã€‚Linkerä¼šä¿®æ”¹ç¬¦å·è¡¨ä¸­çš„å‡½æ•°åœ°å€ï¼Œå°†å‡½æ•°é‡å®šå‘åˆ°åŠ¨æ€åº“ä¸­æ­£ç¡®çš„ä½ç½®ï¼Œä»¥ç¡®ä¿å‡½æ•°è°ƒç”¨èƒ½å¤Ÿæ­£ç¡®åœ°ä¼ é€’å’Œæ¥æ”¶æ•°æ®ã€‚ æ‰§è¡Œåˆå§‹åŒ–å’Œæ¸…ç†ä»£ç ã€‚åœ¨æ‰€æœ‰åº“å’Œå‡½æ•°éƒ½è¢«è§£æã€é“¾æ¥å’Œè£…è½½ä¹‹åï¼ŒLinkerä¼šæ‰§è¡Œå…¨å±€æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–ä»£ç ï¼Œä»¥åŠæ‰§è¡Œå…¨å±€ææ„å‡½æ•°æ¥æ¸…ç†ä»£ç ã€‚ LinkeråŠ¨æ€åŠ è½½è¿‡ç¨‹ä¸­è¿˜ä¼šæ¶‰åŠåˆ°å¦‚åŠ¨æ€è¿½åŠ ã€å¸è½½ç­‰æ“ä½œã€‚ â€‹ ä»¥ä¸Šæ˜¯LinkeråŠ¨æ€åŠ è½½çš„ä¸»è¦æ­¥éª¤åŠæ¶‰åŠåˆ°çš„ä¸»è¦é€»è¾‘ã€‚æ¥ç€ä»æºç å±‚é¢è·Ÿè¸ªåŠ¨æ€åŠ è½½çš„å…·ä½“è¿‡ç¨‹ã€‚æ‰“å¼€å‰é¢åˆ›å»ºçš„æ ·ä¾‹appã€‚ 12345678public class MainActivity extends AppCompatActivity { // Used to load the 'linkertest' library on application startup. static { System.loadLibrary(&quot;linkertest&quot;); } ... public native String stringFromJNI();} â€‹ åœ¨åº”ç”¨å±‚ç›´æ¥é€šè¿‡è°ƒç”¨loadLibraryå°±å¯ä»¥å®Œæˆä¸€ç³»åˆ—çš„åŠ è½½åŠ¨æ€åº“çš„æ“ä½œäº†ï¼Œçœ‹çœ‹å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ã€‚é¦–å…ˆæ˜¯Systemä¸‹çš„loadLibraryå‡½æ•°ï¼Œå‰æ–‡æœ‰ä»‹ç»è¿‡libcoreä¸­å­˜æ”¾ç€openjdkçš„æ ¸å¿ƒåº“çš„å®ç°ï¼Œè€Œjava.lang.Systemå°±æ˜¯å…¶ä¸­ï¼Œæ‰¾åˆ°æ–‡ä»¶libcore/ojluni/src/main/java/java/lang/System.javaæŸ¥çœ‹å‡½æ•°å®ç°å¦‚ä¸‹ã€‚ 123public static void loadLibrary(String libname) { Runtime.getRuntime().loadLibrary0(Reflection.getCallerClass(), libname);} â€‹ ç»§ç»­åœ¨ojluniçš„ç›®å½•ä¸­æœç´¢loadLibrary0çš„å‡½æ•°å®ç° 12345678910111213141516171819202122232425262728293031323334353637383940void loadLibrary0(Class&lt;?&gt; fromClass, String libname) { ClassLoader classLoader = ClassLoader.getClassLoader(fromClass); loadLibrary0(classLoader, fromClass, libname);}private synchronized void loadLibrary0(ClassLoader loader, Class&lt;?&gt; callerClass, String libname) { ... String libraryName = libname; // å¦‚æœclassloaderä¸æ˜¯BootClassLoader if (loader != null &amp;&amp; !(loader instanceof BootClassLoader)) { String filename = loader.findLibrary(libraryName); if (filename == null &amp;&amp; (loader.getClass() == PathClassLoader.class || loader.getClass() == DelegateLastClassLoader.class)) { filename = System.mapLibraryName(libraryName); } ... String error = nativeLoad(filename, loader); if (error != null) { throw new UnsatisfiedLinkError(error); } return; } getLibPaths(); String filename = System.mapLibraryName(libraryName); String error = nativeLoad(filename, loader, callerClass); if (error != null) { throw new UnsatisfiedLinkError(error); }}// çœ‹åˆ°ä¸ç®¡æ˜¯å“ªä¸ªClassloaderéƒ½æ˜¯è°ƒç”¨çš„nativeLoadï¼Œåªæ˜¯é‡è½½ä¸ä¸€æ ·ã€‚ä½†æ˜¯ä¸¤ä¸ªå‚æ•°çš„å®é™…ä¹Ÿæ˜¯è°ƒç”¨äº†ä¸‰ä¸ªå‚æ•°é‡è½½çš„å®ç°ã€‚private static String nativeLoad(String filename, ClassLoader loader) { return nativeLoad(filename, loader, null);}// ä¸‰ä¸ªå‚æ•°é‡è½½çš„æ˜¯ä¸€ä¸ªnativeå‡½æ•°private static native String nativeLoad(String filename, ClassLoader loader, Class&lt;?&gt; caller); â€‹ ç»§ç»­æœç´¢nativeLoadçš„ç›¸å…³å®ç°å¦‚ä¸‹ 1234567// è°ƒç”¨äº†JVM_NativeLoadJNIEXPORT jstring JNICALLRuntime_nativeLoad(JNIEnv* env, jclass ignored, jstring javaFilename, jobject javaLoader, jclass caller){ return JVM_NativeLoad(env, javaFilename, javaLoader, caller);} â€‹ JVM_NativeLoadçš„ä»£ç åœ¨artç›®å½•ä¸­ï¼Œç»§ç»­æŸ¥çœ‹ç›¸å…³å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104JNIEXPORT jstring JVM_NativeLoad(JNIEnv* env, jstring javaFilename, jobject javaLoader, jclass caller) { ScopedUtfChars filename(env, javaFilename); if (filename.c_str() == nullptr) { return nullptr; } std::string error_msg; { art::JavaVMExt* vm = art::Runtime::Current()-&gt;GetJavaVM(); bool success = vm-&gt;LoadNativeLibrary(env, filename.c_str(), javaLoader, caller, &amp;error_msg); if (success) { return nullptr; } } ...}// ç»§ç»­æ‰¾åˆ°ç›¸å…³å®ç°bool JavaVMExt::LoadNativeLibrary(JNIEnv* env, const std::string&amp; path, jobject class_loader, jclass caller_class, std::string* error_msg) { error_msg-&gt;clear(); SharedLibrary* library; Thread* self = Thread::Current(); { MutexLock mu(self, *Locks::jni_libraries_lock_); library = libraries_-&gt;Get(path); } ... // å·²ç»åŠ è½½è¿‡çš„ï¼Œå­˜åœ¨åˆ™è¿”å›trueäº†ã€‚ if (library != nullptr) { ... return true; } ScopedLocalRef&lt;jstring&gt; library_path(env, GetLibrarySearchPath(env, class_loader)); Locks::mutator_lock_-&gt;AssertNotHeld(self); const char* path_str = path.empty() ? nullptr : path.c_str(); bool needs_native_bridge = false; char* nativeloader_error_msg = nullptr; // åŠ è½½åŠ¨æ€é“¾æ¥åº“ void* handle = android::OpenNativeLibrary( env, runtime_-&gt;GetTargetSdkVersion(), path_str, class_loader, (caller_location.empty() ? nullptr : caller_location.c_str()), library_path.get(), &amp;needs_native_bridge, &amp;nativeloader_error_msg); VLOG(jni) &lt;&lt; &quot;[Call to dlopen(\\&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\\&quot;, RTLD_NOW) returned &quot; &lt;&lt; handle &lt;&lt; &quot;]&quot;; ... bool created_library = false; { std::unique_ptr&lt;SharedLibrary&gt; new_library( new SharedLibrary(env, self, path, handle, needs_native_bridge, class_loader, class_loader_allocator)); MutexLock mu(self, *Locks::jni_libraries_lock_); library = libraries_-&gt;Get(path); // å°†åˆšåˆšåŠ è½½å¥½çš„é“¾æ¥åº“ä¿å­˜èµ·æ¥ if (library == nullptr) { // We won race to get libraries_lock. library = new_library.release(); libraries_-&gt;Put(path, library); created_library = true; } } ... bool was_successful = false; // æŸ¥æ‰¾ç¬¦å·JNI_OnLoad void* sym = library-&gt;FindSymbol(&quot;JNI_OnLoad&quot;, nullptr); if (sym == nullptr) { ... } else { ScopedLocalRef&lt;jobject&gt; old_class_loader(env, env-&gt;NewLocalRef(self-&gt;GetClassLoaderOverride())); self-&gt;SetClassLoaderOverride(class_loader); VLOG(jni) &lt;&lt; &quot;[Calling JNI_OnLoad in \\&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\\&quot;]&quot;; using JNI_OnLoadFn = int(*)(JavaVM*, void*); JNI_OnLoadFn jni_on_load = reinterpret_cast&lt;JNI_OnLoadFn&gt;(sym); // è°ƒç”¨JNI_OnLoad int version = (*jni_on_load)(this, nullptr); ... } library-&gt;SetResult(was_successful); return was_successful;} â€‹ åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œçœ‹åˆ°ä½¿ç”¨OpenNativeLibraryæ¥åŠ è½½ä¸€ä¸ªåŠ¨æ€åº“ï¼Œç„¶åå°†åŠ è½½åŠ¨æ€åº“çš„ä¿¡æ¯åŒ…è£…æˆSharedLibraryå¯¹è±¡ï¼Œå­˜å…¥libraries_ä¸­ï¼Œä¸‹æ¬¡å†åŠ è½½æ—¶ï¼Œä¼šåœ¨libraries_æŸ¥çœ‹æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚æ¥ç€åˆé€šè¿‡å‡½æ•°FindSymbolæŸ¥æ‰¾JNI_OnLoadçš„ç¬¦å·åœ°å€ï¼Œç„¶åè¿›è¡Œè°ƒç”¨ã€‚ç»§ç»­è·Ÿè¸ªåŠ è½½åŠ¨æ€åº“çš„å…·ä½“å®ç°ï¼Œæœ€åå†å›å¤´çœ‹æŸ¥æ‰¾ç¬¦å·çš„å®ç°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455void* OpenNativeLibrary(JNIEnv* env, int32_t target_sdk_version, const char* path, jobject class_loader, const char* caller_location, jstring library_path, bool* needs_native_bridge, char** error_msg) {#if defined(ART_TARGET_ANDROID) UNUSED(target_sdk_version); if (class_loader == nullptr) { ... void* handle = android_dlopen_ext(path, RTLD_NOW, &amp;dlextinfo); if (handle == nullptr) { *error_msg = strdup(dlerror()); } return handle; ... { Result&lt;void*&gt; handle = TryLoadNativeloaderExtraLib(path); if (!handle.ok()) { *error_msg = strdup(handle.error().message().c_str()); return nullptr; } if (handle.value() != nullptr) { return handle.value(); } } ... void* handle = OpenSystemLibrary(path, RTLD_NOW); if (handle == nullptr) { *error_msg = strdup(dlerror()); } return handle; } ...#else for (const std::string&amp; lib_path : library_paths) { ... void* handle = dlopen(path_arg, RTLD_NOW); if (handle != nullptr) { return handle; } if (NativeBridgeIsSupported(path_arg)) { *needs_native_bridge = true; handle = NativeBridgeLoadLibrary(path_arg, RTLD_NOW); if (handle != nullptr) { return handle; } *error_msg = strdup(NativeBridgeGetError()); } else { *error_msg = strdup(dlerror()); } } return nullptr;#endif} â€‹ åœ¨è¿™é‡Œå‡½æ•°çœ‹åˆ°ï¼Œä½¿ç”¨å¤šç§æ–¹å¼å°è¯•è¿›è¡ŒåŠ¨æ€åŠ è½½ï¼Œåˆ†åˆ«æ˜¯android_dlopen_extã€TryLoadNativeloaderExtraLibã€OpenSystemLibraryã€‚å®ƒä»¬éƒ½æ˜¯åœ¨Androidå¹³å°ä¸Šç”¨æ¥åŠ è½½åŠ¨æ€åº“çš„æ–¹æ³•ï¼Œä½†æ˜¯å®ƒä»¬å„è‡ªçš„ä½¿ç”¨åœºæ™¯ç•¥æœ‰ä¸åŒï¼š android_dlopen_extï¼šæ˜¯ä¸€ä¸ªä¾›å¼€å‘è€…ä½¿ç”¨çš„å…¬å¼€å‡½æ•°ï¼Œå®ƒæ”¯æŒæŒ‡å®šåº“çš„ç»å¯¹è·¯å¾„å’Œä¸åŒçš„æ ‡å¿—ï¼ˆå¦‚RTLD_NOWã€RTLD_LAZYç­‰ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘å·²åŠ è½½åº“çš„æŒ‡é’ˆï¼Œä¾›åç»­è°ƒç”¨å‡½æ•°çš„æ—¶å€™ä½¿ç”¨ã€‚ TryLoadNativeloaderExtraLibï¼šæ˜¯Androidç³»ç»Ÿä¸­çš„å†…éƒ¨æ–¹æ³•ï¼Œç”¨äºåŠ è½½é¢å¤–çš„æœ¬åœ°åº“ã€‚å®ƒè¢«ç”¨äºæ”¯æŒåŠ¨æ€åŠ è½½å…±äº«åº“çš„åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚ä½¿ç”¨åå°„å®ç°çš„åŠ¨æ€åº“åŠ è½½æ–¹å¼ã€‚ç³»ç»Ÿåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è°ƒç”¨å®ƒï¼Œç”¨äºåŠ è½½åº”ç”¨ç¨‹åºæ‰€éœ€çš„é¢å¤–æœ¬åœ°åº“ã€‚ä½¿ç”¨è¯¥æ–¹æ³•å¯ä»¥åŠ è½½ç‰¹å®šçš„æœ¬åœ°åº“ï¼Œå¹¶æ”¯æŒè·¨æ¶æ„çš„æ‰§è¡Œã€‚ OpenSystemLibraryï¼šä¹Ÿæ˜¯Androidç³»ç»Ÿä¸­çš„å†…éƒ¨æ–¹æ³•ï¼Œç”¨äºåŠ è½½Androidç³»ç»Ÿçš„æœ¬åœ°åº“ã€‚å®ƒä¸éœ€è¦æŒ‡å®šåº“çš„è·¯å¾„ï¼Œè€Œæ˜¯ä½¿ç”¨ç³»ç»Ÿåº“è·¯å¾„ä¸­çš„è·¯å¾„åæ¥åŠ è½½ç›¸åº”çš„åº“æ–‡ä»¶ã€‚è¯¥æ–¹æ³•ä¸»è¦ç”¨äºåŠ è½½Androidæ“ä½œç³»ç»Ÿæ ¸å¿ƒä¸­çš„ä¸€äº›å›ºå®šçš„ç³»ç»Ÿåº“ï¼Œä¾‹å¦‚ libz.soã€liblog.soç­‰ã€‚ â€‹ æ€»çš„æ¥è¯´ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯ç”¨äºåŠ è½½åŠ¨æ€åº“çš„æ–¹æ³•ï¼Œä¸åŒçš„æ˜¯å®ƒä»¬çš„ä½¿ç”¨åœºæ™¯ç•¥æœ‰ä¸åŒã€‚é€‰ä¸€æ¡è·¯çº¿åˆ†æå³å¯ï¼Œè¿™é‡Œç»§ç»­ä»android_dlopen_extæ·±å…¥åˆ†æï¼Œè¯¥å‡½æ•°çš„ç›¸å…³ä»£ç åœ¨libdl.cppä¸­å®ç°ã€‚ 1234void* android_dlopen_ext(const char* filename, int flag, const android_dlextinfo* extinfo) { const void* caller_addr = __builtin_return_address(0); return __loader_android_dlopen_ext(filename, flag, extinfo, caller_addr);} â€‹ ç»§ç»­è·Ÿè¸ªæ–‡ä»¶dlfcn.cppä¸­çš„å®ç° 123456789101112131415161718192021void* __loader_android_dlopen_ext(const char* filename, int flags, const android_dlextinfo* extinfo, const void* caller_addr) { return dlopen_ext(filename, flags, extinfo, caller_addr);}static void* dlopen_ext(const char* filename, int flags, const android_dlextinfo* extinfo, const void* caller_addr) { ScopedPthreadMutexLocker locker(&amp;g_dl_mutex); g_linker_logger.ResetState(); void* result = do_dlopen(filename, flags, extinfo, caller_addr); if (result == nullptr) { __bionic_format_dlerror(&quot;dlopen failed&quot;, linker_get_error_buffer()); return nullptr; } return result;} â€‹ åˆ°è¿™é‡Œdo_dlopenåˆ™æ‰§è¡Œåˆ°äº†Linkeréƒ¨åˆ†çš„å®ç°äº†ï¼Œæ‰¾åˆ°linker.cppæ–‡ä»¶æŸ¥çœ‹ 12345678910111213141516171819202122void* do_dlopen(const char* name, int flags, const android_dlextinfo* extinfo, const void* caller_addr) { ... soinfo* si = find_library(ns, translated_name, flags, extinfo, caller); loading_trace.End(); if (si != nullptr) { void* handle = si-&gt;to_handle(); LD_LOG(kLogDlopen, &quot;... dlopen calling constructors: realpath=\\&quot;%s\\&quot;, soname=\\&quot;%s\\&quot;, handle=%p&quot;, si-&gt;get_realpath(), si-&gt;get_soname(), handle); si-&gt;call_constructors(); failure_guard.Disable(); LD_LOG(kLogDlopen, &quot;... dlopen successful: realpath=\\&quot;%s\\&quot;, soname=\\&quot;%s\\&quot;, handle=%p&quot;, si-&gt;get_realpath(), si-&gt;get_soname(), handle); return handle; } return nullptr;} â€‹ è¿™é‡Œçœ‹åˆ°é€šè¿‡find_libraryè¿›è¡ŒæŸ¥æ‰¾çš„ï¼Œæ‰¾åˆ°ååˆè°ƒç”¨äº†call_constructorså‡½æ•°ã€‚å…ˆçœ‹çœ‹call_constructorså‡½æ•°çš„å¤„ç†ã€‚ 12345678910void soinfo::call_constructors() { if (constructors_called || g_is_ldd) { return; } ... call_function(&quot;DT_INIT&quot;, init_func_, get_realpath()); call_array(&quot;DT_INIT_ARRAY&quot;, init_array_, init_array_count_, false, get_realpath()); ...} â€‹ æ ¹æ®ä¸Šé¢ä»£ç å‘ç°è¿™é‡Œå°±æ˜¯.initå’Œ.initarrayæ‰§è¡Œçš„åœ°æ–¹ï¼Œç»§ç»­çœ‹åŠ è½½çš„æµç¨‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134static soinfo* find_library(android_namespace_t* ns, const char* name, int rtld_flags, const android_dlextinfo* extinfo, soinfo* needed_by) { soinfo* si = nullptr; if (name == nullptr) { si = solist_get_somain(); } else if (!find_libraries(ns, needed_by, &amp;name, 1, &amp;si, nullptr, 0, rtld_flags, extinfo, false /* add_as_children */)) { if (si != nullptr) { soinfo_unload(si); } return nullptr; } si-&gt;increment_ref_count(); return si;}// ç»§ç»­å‘ä¸‹è·Ÿè¸ªbool find_libraries(...) { ... ZipArchiveCache zip_archive_cache; soinfo_list_t new_global_group_members; for (size_t i = 0; i&lt;load_tasks.size(); ++i) { ã€‚ã€‚ã€‚ if (!find_library_internal(const_cast&lt;android_namespace_t*&gt;(task-&gt;get_start_from()), task, &amp;zip_archive_cache, &amp;load_tasks, rtld_flags)) { return false; } soinfo* si = task-&gt;get_soinfo(); } ... return true;}//è¿½è¸ªfind_library_internalstatic bool find_library_internal(android_namespace_t* ns, LoadTask* task, ZipArchiveCache* zip_archive_cache, LoadTaskList* load_tasks, int rtld_flags) { soinfo* candidate; ... if (load_library(ns, task, zip_archive_cache, load_tasks, rtld_flags, true /* search_linked_namespaces */)) { return true; } ... return false;}static bool load_library(android_namespace_t* ns, LoadTask* task, ZipArchiveCache* zip_archive_cache, LoadTaskList* load_tasks, int rtld_flags, bool search_linked_namespaces) { const char* name = task-&gt;get_name(); soinfo* needed_by = task-&gt;get_needed_by(); ... LD_LOG(kLogDlopen, &quot;load_library(ns=%s, task=%s, flags=0x%x, search_linked_namespaces=%d): calling &quot; &quot;open_library&quot;, ns-&gt;get_name(), name, rtld_flags, search_linked_namespaces); // Open the file. off64_t file_offset; std::string realpath; int fd = open_library(ns, zip_archive_cache, name, needed_by, &amp;file_offset, &amp;realpath); ... return load_library(ns, task, load_tasks, rtld_flags, realpath, search_linked_namespaces);}// open_libraryæ‰“å¼€åŠ¨æ€åº“æ–‡ä»¶å°†æŒ‡å®šçš„å…±äº«åº“æ–‡ä»¶åŠ è½½åˆ°å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„åŠ¨æ€é“¾æ¥å¯¹è±¡ï¼Œå¹¶è¿”å›å…¶çš„å¥æŸ„ã€‚static int open_library(android_namespace_t* ns, ZipArchiveCache* zip_archive_cache, const char* name, soinfo *needed_by, off64_t* file_offset, std::string* realpath) { TRACE(&quot;[ opening %s from namespace %s ]&quot;, name, ns-&gt;get_name()); // If the name contains a slash, we should attempt to open it directly and not search the paths. if (strchr(name, '/') != nullptr) { return open_library_at_path(zip_archive_cache, name, file_offset, realpath); } ... return fd;}// load_libraryåŠ è½½è§£æELFæ ¼å¼å¹¶å°†å…¶é“¾æ¥åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ï¼Œå°†åŠ¨æ€é“¾æ¥å¯¹è±¡ä¸­çš„ç¬¦å·è§£æä¸ºå½“å‰è¿›ç¨‹ä¸­çš„ç¬¦å·ï¼Œä»è€Œåˆ›å»ºåŠ¨æ€é“¾æ¥çš„å…³ç³»ã€‚static bool load_library(android_namespace_t* ns, LoadTask* task, LoadTaskList* load_tasks, int rtld_flags, const std::string&amp; realpath, bool search_linked_namespaces) { ... soinfo* si = soinfo_alloc(ns, realpath.c_str(), &amp;file_stat, file_offset, rtld_flags); task-&gt;set_soinfo(si); // è¯»å–elf header if (!task-&gt;read(realpath.c_str(), file_stat.st_size)) { task-&gt;remove_cached_elf_reader(); task-&gt;set_soinfo(nullptr); soinfo_free(si); return false; } ... return true;}// æœ€åçœ‹çœ‹readå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£ä»elfæ–‡ä»¶æ ¼å¼çš„æ•°æ®ä¸­è¯»å–å†…å®¹bool read(const char* realpath, off64_t file_size) { ElfReader&amp; elf_reader = get_elf_reader(); return elf_reader.Read(realpath, fd_, file_offset_, file_size); } â€‹ ElfReaderæ˜¯Androidæºæ–‡ä»¶ä¸­çš„å·¥å…·ï¼Œä½äºç³»ç»Ÿæ ¸å¿ƒåº“libcoreä¸­ï¼Œä»£ç ä¸»è¦ç”±C++ç¼–å†™ã€‚å®ƒå¯ä»¥è¯»å–ELFæ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶å°†å…¶è§£æä¸ºæŒ‡å®šæ ¼å¼ã€‚ ElfReaderå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š è¯»å–ELFæ–‡ä»¶çš„å¤´ä¿¡æ¯ï¼ŒåŒ…æ‹¬ELFç‰ˆæœ¬ã€ç›®æ ‡ä½“ç³»ç»“æ„ã€ç¨‹åºå…¥å£åœ°å€ã€èŠ‚è¡¨åç§»é‡ç­‰ã€‚ è¯»å–ELFæ–‡ä»¶çš„èŠ‚è¡¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬èŠ‚è¡¨åç§°ã€å¤§å°ã€åç§»é‡ã€å±æ€§ç­‰ã€‚ é€šè¿‡èŠ‚è¡¨ä¿¡æ¯å¯ä»¥è·å–ç¬¦å·è¡¨ã€é‡å®šä½è¡¨ã€åŠ¨æ€é“¾æ¥è¡¨ç­‰å…³é”®ä¿¡æ¯ï¼Œå¦‚å‡½æ•°ã€å˜é‡ã€é“¾æ¥åº“ã€å¯¼å‡ºå‡½æ•°ç­‰ã€‚ æ”¯æŒé€šè¿‡æŒ‡å®šèŠ‚è¡¨åç§°è·å–æŸä¸ªèŠ‚è¡¨çš„ä¿¡æ¯ï¼Œå¦‚æ ¹æ®â€.rodataâ€œè·å–åªè¯»æ•°æ®èŠ‚è¡¨çš„ä¿¡æ¯ç­‰ã€‚ å°ç»“ç³»ç»Ÿå®šåˆ¶æ— è®ºåšæ€æ ·çš„ä¿®æ”¹ï¼Œéƒ½è¦æ˜ç™½å…¶åŸç†ï¼Œæœ¬ç« å†…å®¹ä½œä¸ºç³»ç»Ÿå¼€å‘çš„å†…åŠŸå¿ƒæ³•ï¼Œéœ€è¦è¯»è€…èŠ±è´¹ä¸€äº›æ—¶é—´æ¥å¸æ”¶ï¼Œåœ¨åé¢çš„å†…å®¹çš„å±•å¼€è¿‡ç¨‹ä¸­ï¼Œä¹Ÿå¯ä»¥éšæ—¶é‡æ¸©æœ¬ç« å†…å®¹ï¼ŒåŠ æ·±å°è±¡ã€‚ ä»è®¾å¤‡å¼€æœºåˆ°ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼Œæ•´ä¸ªå¯åŠ¨é“¾ä¸Šæ¶‰åŠåˆ°çš„æ ¸å¿ƒç»„ä»¶éƒ½åœ¨æœ¬èŠ‚ä¸­è¿›è¡Œäº†ä»‹ç»ã€‚æœ¬èŠ‚ä¸­ä»‹ç»çš„ç³»ç»Ÿç»„ä»¶ï¼Œéƒ½æ˜¯å®šåˆ¶ç³»ç»Ÿå¯èƒ½éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ã€‚å…¶ä¸­ï¼ŒServiceä¸Frameworkçš„ä¿®æ”¹æ˜¯æœ€å¸¸è§çš„ï¼Œç¾åŒ–ä¸å®‰å…¨å®šåˆ¶éƒ½ç¦»ä¸å¼€å®ƒï¼Œè¯»è€…æœ‹å‹ä»¬å¯ä»¥é‡ç‚¹é˜…è¯»å®ƒä»¬çš„ä»£ç æ¥æ·±å…¥ç ”ç©¶ã€‚","link":"/2025/04/07/chapter-03/"},{"title":"Hello World","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot; More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","link":"/2020/12/08/hello-world/"},{"title":"OkHttpæºç åˆ†æ","text":"OkHttpè¯·æ±‚æµç¨‹ é«˜å¹¶å‘è¯·æ±‚åˆ†å‘å™¨ä¸çº¿ç¨‹æ±  è´£ä»»é“¾æ¨¡å¼è¯·æ±‚ä¸å“åº”æ‹¦æˆª ç›®å½• OkHttpä»‹ç» ç®€å•ä½¿ç”¨ï¼š ä½¿ç”¨æµç¨‹ï¼š è°ƒç”¨æµç¨‹ï¼š åˆ†å‘å™¨ï¼š å¼‚æ­¥è¯·æ±‚å·¥ä½œæµç¨‹ï¼š OkHttpçº¿ç¨‹æ± çš„ç‰¹ç‚¹ï¼š AsyncCall åŒæ­¥è¯·æ±‚ æ‹¦æˆªå™¨ï¼š è·å–å“åº”ï¼š è´£ä»»é“¾æ¨¡å¼ï¼š æ‹¦æˆªå™¨è´£ä»»é“¾ï¼š äº”å¤§æ‹¦æˆªå™¨åŠŸèƒ½ï¼š æ‹¦æˆªå™¨è¯¦æƒ…ï¼š ä¸€ã€é‡è¯•åŠé‡å®šå‘æ‹¦æˆªå™¨ é‡è¯• é‡å®šå‘ æ€»ç»“ äºŒã€æ¡¥æ¥æ‹¦æˆªå™¨ æ€»ç»“ ä¸‰ã€ç¼“å­˜æ‹¦æˆªå™¨ ç¼“å­˜ç­–ç•¥ æµç¨‹ï¼š è¯¦ç»†æµç¨‹ï¼š PSï¼šè¯·æ±‚å¤´ä¸å“åº”å¤´ å››ã€è¿æ¥æ‹¦æˆªå™¨ è¿æ¥æµç¨‹ï¼š è¿æ¥æ± æ¸…ç†ï¼š ä»£ç†è¿æ¥ï¼š äº”ã€è¯·æ±‚æœåŠ¡å™¨æ‹¦æˆªå™¨ Expect: 100-continue æ€»ç»“ è‡ªå®šä¹‰æ‹¦æˆªå™¨ OkHttpæ€»ç»“ è¡¥å……: ä»£ç† OkHttpä»‹ç»ç”±Squareå…¬å¸è´¡çŒ®çš„ä¸€ä¸ªå¤„ç†ç½‘ç»œè¯·æ±‚çš„å¼€æºé¡¹ç›®ï¼Œæ˜¯ç›®å‰Androidä½¿ç”¨æœ€å¹¿æ³›çš„ç½‘ç»œæ¡†æ¶ï¼Œä»Android4ã€‚4å¼€å§‹HttpURLConnectionçš„åº•å±‚å®ç°é‡‡ç”¨çš„æ˜¯OkHttpã€‚ æ”¯æŒHTTP/2å¹¶å…è®¸å¯¹åŒä¸€ä¸»æœºçš„æ‰€æœ‰è¯·æ±‚å…±äº«ä¸€ä¸ªå¥—æ¥å­— é€šè¿‡è¿æ¥æ± ï¼Œå‡å°‘äº†è¯·æ±‚å»¶è¿Ÿ é»˜è®¤é€šè¿‡GZipå‹ç¼©æ•°æ® å“åº”ç¼“å­˜ï¼Œä»¥å…äº†é‡å¤è¯·æ±‚çš„ç½‘ç»œ è¯·æ±‚å¤±è´¥è‡ªåŠ¨é‡è¯•ä¸»æœºçš„å…¶ä»–ipï¼Œè‡ªåŠ¨é‡å®šå‘ â€¦â€¦ ç®€å•ä½¿ç”¨ï¼š123456789101112131415161718192021OkHttpClient okHttpClient = new OkHttpClient();Request request = new Request.Builder().url(&quot;http://www.baidu.com&quot;).build();Call call = okHttpClient.newCall(request);try { //åŒæ­¥è¯·æ±‚ Response execute = call.execute();} catch (IOException e) { e.printStackTrace();}//å¼‚æ­¥è¯·æ±‚call.enqueue(new Callback() { @Override public void onFailure(Call call, IOException e) { } @Override public void onResponse(Call call, Response response) throws IOException { }}); ä½¿ç”¨æµç¨‹ï¼š è°ƒç”¨æµç¨‹ï¼šOkHttpè¯·æ±‚è¿‡ç¨‹ä¸­æœ€å°‘éœ€è¦æ¥è§¦OkHttpClientã€Requestã€Callã€Responseï¼Œä½†æ˜¯æ¡†æ¶å†…éƒ¨è¿›è¡Œå¤§é‡çš„é€»è¾‘å¤„ç†ã€‚ æ‰€æœ‰çš„é€»è¾‘å¤§éƒ¨åˆ†é›†ä¸­åœ¨æ‹¦æˆªå™¨ä¸­ï¼Œä½†æ˜¯åœ¨è¿›å…¥æ‹¦æˆªå™¨ä¹‹å‰è¿˜éœ€è¦ä¾é åˆ†å‘å™¨æ¥è°ƒé…è¯·æ±‚ä»»åŠ¡ã€‚ åˆ†å‘å™¨ï¼šå†…éƒ¨ç»´æŠ¤é˜Ÿåˆ—ä¸çº¿ç¨‹æ± ï¼Œå®Œæˆè¯·æ±‚è°ƒé…ï¼›Dispatcher æ‹¦æˆªå™¨ï¼šäº”å¤§é»˜è®¤æ‹¦æˆªå™¨å®Œæˆæ•´ä¸ªè¯·æ±‚è¿‡ç¨‹ï¼› Interceptors åˆ†å‘å™¨ï¼šå¼‚æ­¥è¯·æ±‚å·¥ä½œæµç¨‹ï¼š Qï¼šå¦‚ä½•å†³å®šå°†è¯·æ±‚æ”¾å…¥readyè¿˜æ˜¯running? Qï¼šä»runningç§»åŠ¨åˆ°readyçš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ Qï¼šåˆ†å‘å™¨çº¿ç¨‹æ± çš„å·¥ä½œè¡Œä¸ºï¼Ÿ Dispatcherä¸­ A: client.dispatcher().enqueue(new AsyncCall(responseCallback)); 1234567891011121314synchronized void enqueue(AsyncCall call) { //1.runningé˜Ÿåˆ—æ•°å°äºæœ€å¤§è¯·æ±‚æ•°64ï¼ˆæ­£åœ¨è¯·æ±‚çš„çš„æ•°é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œè‡ªå·±é…ç½®åˆ†å‘å™¨æ—¶å¯ä»¥ä¿®æ”¹ï¼‰ //2.åŒä¸€åŸŸåæ­£åœ¨è¯·æ±‚çš„ä¸ªæ•°ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„å°äº5 //PS:æœ€å¤§åŒæ—¶è¯·æ±‚æ•°64ï¼Œä¸åŒä¸€å°æœåŠ¡å™¨è¯·æ±‚æ•°5 if (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) { //æ·»åŠ åˆ°runningé˜Ÿåˆ— runningAsyncCalls.add(call); //å°†runnableï¼ˆcallï¼‰æäº¤åˆ°çº¿ç¨‹æ± å½“ä¸­ executorService().execute(call); } else { //ä¸ç¬¦åˆä¸Šé¢è¯·æ±‚å°±åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ— readyAsyncCalls.add(call); }} A:client.dispatcher().finished(this);-&gt; promoteCalls()ç§»åŠ¨é˜Ÿåˆ—ï¼ˆå¼‚æ­¥æ—¶æ‰æœ‰ç§»åŠ¨é˜Ÿåˆ—ï¼‰ 123456789101112131415161718192021private void promoteCalls() { //æ­£åœ¨æ‰§è¡Œé˜Ÿåˆ—æ•° if (runningAsyncCalls.size() &gt;= maxRequests) return; // Already running max capacity. //ç­‰å¾…é˜Ÿåˆ—æ•°å¾—ä¸ä¸ºç©º if (readyAsyncCalls.isEmpty()) return; // No ready calls to promote. for (Iterator&lt;AsyncCall&gt; i = readyAsyncCalls.iterator(); i.hasNext(); ) { AsyncCall call = i.next(); //å¦‚æœæ‹¿åˆ°çš„ç­‰å¾…è¯·æ±‚hostï¼Œåœ¨è¯·æ±‚çš„åˆ—è¡¨ä¸­å·²ç»å­˜åœ¨5ä¸ª if (runningCallsForHost(call) &lt; maxRequestsPerHost) { //ç­‰å¾…ç§»é™¤ i.remove(); //åŠ å…¥running runningAsyncCalls.add(call); //åŠ å…¥çº¿ç¨‹æ±  executorService().execute(call); } //åˆ¤æ–­æ­£åœ¨æ‰§è¡Œé˜Ÿåˆ—æ•° if (runningAsyncCalls.size() &gt;= maxRequests) return; // Reached max capacity. }} A:ThreadPoolExecutor å½“ä¸€ä¸ªä»»åŠ¡é€šè¿‡execute(Runnable)æ–¹æ³•æ·»åŠ åˆ°çº¿ç¨‹æ± æ—¶ï¼š çº¿ç¨‹æ•°é‡å°äºcorePoolSizeï¼Œæ–°å»ºçº¿ç¨‹(æ ¸å¿ƒ)æ¥å¤„ç†è¢«æ·»åŠ çš„ä»»åŠ¡ï¼› çº¿ç¨‹æ•°é‡å¤§äºç­‰äº corePoolSizeï¼Œå­˜åœ¨ç©ºé—²çº¿ç¨‹ï¼Œä½¿ç”¨ç©ºé—²çº¿ç¨‹æ‰§è¡Œæ–°ä»»åŠ¡ï¼›- çº¿ç¨‹æ•°é‡å¤§äºç­‰äº corePoolSizeï¼Œä¸å­˜åœ¨ç©ºé—²çº¿ç¨‹ï¼Œæ–°ä»»åŠ¡è¢«æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œæ·»åŠ æˆåŠŸåˆ™ç­‰å¾…ç©ºé—²çº¿ç¨‹ï¼Œæ·»åŠ å¤±è´¥ï¼š çº¿ç¨‹æ•°é‡å°äºmaximumPoolSizeï¼Œæ–°å»ºçº¿ç¨‹æ‰§è¡Œæ–°ä»»åŠ¡ï¼› çº¿ç¨‹æ•°é‡ç­‰äºmaximumPoolSizeï¼Œæ‹’ç»æ­¤ä»»åŠ¡ã€‚ 1234567891011121314public synchronized ExecutorService executorService() { if (executorService == null) { //corePoolSize:æ ¸å¿ƒçº¿ç¨‹æ•° 0 ä¸ç¼“å­˜çº¿ç¨‹ï¼Œï¼ˆ0å’Œ1çš„è¡¨ç°æ˜¯ä¸€æ ·çš„ï¼‰ä¸ç”¨æ—¶å°±ä¸å ç”¨çº¿ç¨‹ï¼Œé—²ç½®60å°±ä¼šå›æ”¶æ‰ //maximumPoolSizeæœ€å¤§çº¿ç¨‹æ•°ï¼ˆåŒ…æ‹¬æ ¸å¿ƒï¼‰ //keepAliveTime ç¼“å­˜60ç§’ //workQueue é˜Ÿåˆ— //threadFactory åˆ›å»ºä¸€ä¸ªthread //PS:å’ŒExecutors.newCachedThreadPool();åˆ›å»ºçš„çº¿ç¨‹æ± ä¸€æ · executorService = new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(&quot;OkHttp Dispatcher&quot;, false)); } return executorService;} SynchronousQueue implements BlockingQueue æ˜¯ä¸ªé˜»å¡é˜Ÿåˆ— PS:ä¸‰ç§é˜»å¡é˜Ÿåˆ— ArrayBlockingQueueï¼šåŸºäºæ•°ç»„çš„é˜»å¡é˜Ÿåˆ—ï¼Œåˆå§‹åŒ–éœ€è¦æŒ‡å®šå›ºå®šå¤§å°ã€‚ LinkedBlockingQueueï¼šåŸºäºé“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ï¼Œåˆå§‹åŒ–å¯ä»¥æŒ‡å®šå¤§å°ï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šã€‚ SynchronousQueue : æ— å®¹é‡çš„é˜Ÿåˆ—ã€‚ å¾€é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ ä¸€å®šæ˜¯å¤±è´¥çš„ã€‚ OkHttpçº¿ç¨‹æ± çš„ç‰¹ç‚¹ï¼šOkHttpæäº¤è¯·æ±‚ï¼Œä¸€å®šæ˜¯å¾€é˜Ÿåˆ—é‡Œæäº¤ï¼Œå¾€é˜Ÿåˆ—ä¸­æ·»åŠ æ˜¯ä¸€å®šæ˜¯å¤±è´¥çš„ï¼Œé©¬ä¸Šæ–°å»ºçº¿ç¨‹ï¼ˆæ²¡æœ‰åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼‰ï¼Œ ä¸éœ€è¦ç­‰å¾…ã€‚è·å¾—æœ€å¤§çš„å¹¶å‘é‡ AsyncCallç»§æ‰¿NamedRunnableç±»å®ç°Runnableæ¥å£ 12345678910111213141516171819202122public abstract class NamedRunnable implements Runnable { protected final String name; public NamedRunnable(String format, Object... args) { this.name = Util.format(format, args); } /** * runæ–¹æ³•å…¶å®è°ƒç”¨çš„AsyncCallçš„execute() */ @Override public final void run() { String oldName = Thread.currentThread().getName(); Thread.currentThread().setName(name); try { execute(); } finally { Thread.currentThread().setName(oldName); } } protected abstract void execute();} åŒæ­¥è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œæ‰§è¡Œå®Œç§»é™¤é˜Ÿåˆ— 1234synchronized void executed(RealCall call) { //åŒæ­¥ç›´æ¥åŠ å…¥runningé˜Ÿåˆ—ï¼Œè¿™é‡Œçš„runningæ˜¯åŒæ­¥é˜Ÿåˆ—ä¸æ˜¯å¼‚æ­¥çš„ runningSyncCalls.add(call);} æ‹¦æˆªå™¨ï¼šé»˜è®¤äº”å¤§æ‹¦æˆªå™¨ï¼šï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰é‡å®šå‘ä¸é‡è¯•ï¼ŒHeaderã€Bodyå¤„ç†ï¼Œç¼“å­˜å¤„ç†ï¼Œè¿æ¥å¤„ç†ï¼ŒæœåŠ¡å™¨é€šè®¯ è¯·æ±‚æ˜¯é¡ºåºçš„ï¼Œå“åº”æ˜¯é€†åºçš„ è·å–å“åº”ï¼šæ— è®ºåŒæ­¥è¿˜æ˜¯å¼‚å¸¸éƒ½æ˜¯é€šè¿‡getResponseWithInterceptorChain è·å¾—è¯·æ±‚ç»“æœï¼šResponse 123456789101112131415161718192021222324Response getResponseWithInterceptorChain() throws IOException { // æ‹¦æˆªå™¨é›†åˆ List&lt;Interceptor&gt; interceptors = new ArrayList&lt;&gt;(); interceptors.addAll(client.interceptors()); //é‡å®šå‘ä¸é‡è¯• interceptors.add(retryAndFollowUpInterceptor); //Header,Bodyå¤„ç† interceptors.add(new BridgeInterceptor(client.cookieJar())); //ç¼“å­˜å¤„ç† interceptors.add(new CacheInterceptor(client.internalCache())); //è¿æ¥å¤„ç† interceptors.add(new ConnectInterceptor(client)); if (!forWebSocket) { interceptors.addAll(client.networkInterceptors()); } //æœåŠ¡å™¨é€šè®¯ interceptors.add(new CallServerInterceptor(forWebSocket)); Interceptor.Chain chain = new RealInterceptorChain(interceptors, null, null, null, 0, originalRequest, this, eventListener, client.connectTimeoutMillis(), client.readTimeoutMillis(), client.writeTimeoutMillis()); return chain.proceed(originalRequest);} è´£ä»»é“¾æ¨¡å¼ï¼šï¼ˆä¸€æ’ï¼Œæœ€åä¸€ä½å¾€å‰ä¸€ä¸ªä¸ªä¼ çº¸æ¡[è¯·æ±‚]ï¼Œä¼ åˆ°ç¬¬ä¸€ä¸ªåˆä¸€ä¸ªä¸ªå¾€åä¼ [å“åº”]ï¼‰ ä¸ºè¯·æ±‚åˆ›å»ºäº†ä¸€ä¸ªæ¥æ”¶è€…å¯¹è±¡çš„é“¾ï¼Œåœ¨å¤„ç†è¯·æ±‚çš„æ—¶å€™æ‰§è¡Œè¿‡æ»¤(å„å¸å…¶èŒ)ã€‚ è´£ä»»é“¾ä¸Šçš„å¤„ç†è€…è´Ÿè´£å¤„ç†è¯·æ±‚ï¼Œå®¢æˆ·åªéœ€è¦å°†è¯·æ±‚å‘é€åˆ°è´£ä»»é“¾å³å¯ï¼Œæ— é¡»å…³å¿ƒè¯·æ±‚çš„å¤„ç†ç»†èŠ‚å’Œè¯·æ±‚çš„ä¼ é€’ï¼Œæ‰€ä»¥èŒè´£é“¾å°†è¯·æ±‚çš„å‘é€è€…å’Œè¯·æ±‚çš„å¤„ç†è€…è§£è€¦äº†ã€‚ æ‹¦æˆªå™¨è´£ä»»é“¾ï¼š äº”å¤§æ‹¦æˆªå™¨åŠŸèƒ½ï¼š é‡è¯•æ‹¦æˆªå™¨åœ¨äº¤å‡º(äº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨)ä¹‹å‰ï¼Œè´Ÿè´£åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å–æ¶ˆäº†è¯·æ±‚ï¼›åœ¨è·å¾—äº†ç»“æœä¹‹åï¼Œä¼šæ ¹æ®å“åº”ç åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šå‘ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶é‚£ä¹ˆå°±ä¼šé‡å¯æ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨ã€‚ æ¡¥æ¥æ‹¦æˆªå™¨åœ¨äº¤å‡ºä¹‹å‰ï¼Œè´Ÿè´£å°†HTTPåè®®å¿…å¤‡çš„è¯·æ±‚å¤´åŠ å…¥å…¶ä¸­(å¦‚ï¼šHost)å¹¶æ·»åŠ ä¸€äº›é»˜è®¤çš„è¡Œä¸º(å¦‚ï¼šGZIPå‹ç¼©)ï¼›åœ¨è·å¾—äº†ç»“æœåï¼Œè°ƒç”¨ä¿å­˜cookieæ¥å£å¹¶è§£æGZIPæ•°æ®ã€‚ ç¼“å­˜æ‹¦æˆªå™¨é¡¾åæ€ä¹‰ï¼Œäº¤å‡ºä¹‹å‰è¯»å–å¹¶åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ç¼“å­˜ï¼›è·å¾—ç»“æœååˆ¤æ–­æ˜¯å¦ç¼“å­˜ã€‚ è¿æ¥æ‹¦æˆªå™¨åœ¨äº¤å‡ºä¹‹å‰ï¼Œè´Ÿè´£æ‰¾åˆ°æˆ–è€…æ–°å»ºä¸€ä¸ªè¿æ¥ï¼Œå¹¶è·å¾—å¯¹åº”çš„socketæµï¼›åœ¨è·å¾—ç»“æœåä¸è¿›è¡Œé¢å¤–çš„å¤„ç†ã€‚ è¯·æ±‚æœåŠ¡å™¨æ‹¦æˆªå™¨è¿›è¡ŒçœŸæ­£çš„ä¸æœåŠ¡å™¨çš„é€šä¿¡ï¼Œå‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè§£æè¯»å–çš„å“åº”æ•°æ®ã€‚ æ‹¦æˆªå™¨è¯¦æƒ…ï¼šä¸€ã€é‡è¯•åŠé‡å®šå‘æ‹¦æˆªå™¨ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨:RetryAndFollowUpInterceptorï¼Œä¸»è¦å°±æ˜¯å®Œæˆä¸¤ä»¶äº‹æƒ…ï¼šé‡è¯•ä¸é‡å®šå‘ã€‚ é‡è¯•åœºæ™¯ï¼šè¯·æ±‚è¶…æ—¶ï¼›åŸŸåè§£æåå¤šä¸ªIPï¼Œå¦‚æœä¸€ä¸ªIPå¤±è´¥äº†ï¼Œé‡è¯•å…¶ä»–IP è®¾ç½®æ˜¯å¦å…è®¸é‡è¯• 12//è®¾ç½®æ˜¯å¦å…è®¸é‡è¯• é»˜è®¤æ˜¯å…è®¸new OkHttpClient().newBuilder().retryOnConnectionFailure(true); åœ¨RetryAndFollowUpInterceptorä¸­å¤±è´¥æ—¶ï¼Œè¿›å…¥recoveræ–¹æ³• 12345678910111213141516171819202122try { //todo è¯·æ±‚å‡ºç°äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆreleaseConnectionä¾æ—§ä¸ºtrueã€‚ response = realChain.proceed(request, streamAllocation, null, null); releaseConnection = false;} catch (RouteException e) { //todo è·¯ç”±å¼‚å¸¸ï¼Œè¿æ¥æœªæˆåŠŸï¼Œè¯·æ±‚è¿˜æ²¡å‘å‡ºå» //The attempt to connect via a route failed. The request will not have been sent. if (!recover(e.getLastConnectException(), streamAllocation, false, request)) { throw e.getLastConnectException(); } releaseConnection = false; //é‡è¯• continue;} catch (IOException e) { //todo è¯·æ±‚å‘å‡ºå»äº†ï¼Œä½†æ˜¯å’ŒæœåŠ¡å™¨é€šä¿¡å¤±è´¥äº†ã€‚(socketæµæ­£åœ¨è¯»å†™æ•°æ®çš„æ—¶å€™æ–­å¼€è¿æ¥) // ConnectionShutdownExceptionåªå¯¹HTTP2å­˜åœ¨ã€‚å‡å®šå®ƒå°±æ˜¯false //An attempt to communicate with a server failed. The request may have been sent. boolean requestSendStarted = !(e instanceof ConnectionShutdownException); if (!recover(e, streamAllocation, requestSendStarted, request)) throw e; releaseConnection = false; continue;} åœ¨recoverä¸­ è·å–æ˜¯å¦å…è®¸é‡è¯•ï¼Œå¦‚æœä¸å…è®¸å°±æŠ›å¼‚å¸¸ï¼Œç»“æŸã€‚ 123456789101112131415161718192021222324private boolean recover(IOException e, StreamAllocation streamAllocation, boolean requestSendStarted, Request userRequest) { streamAllocation.streamFailed(e); //todo 1ã€åœ¨é…ç½®OkhttpClientæ˜¯è®¾ç½®äº†ä¸å…è®¸é‡è¯•ï¼ˆé»˜è®¤å…è®¸ï¼‰ï¼Œåˆ™ä¸€æ—¦å‘ç”Ÿè¯·æ±‚å¤±è´¥å°±ä¸å†é‡è¯• //The application layer has forbidden retries. if (!client.retryOnConnectionFailure()) return false; //todo 2ã€ç”±äºrequestSendStartedåªåœ¨http2çš„ioå¼‚å¸¸ä¸­ä¸ºtrueï¼Œå…ˆä¸ç®¡http2 //We can't send the request body again. if (requestSendStarted &amp;&amp; userRequest.body() instanceof UnrepeatableRequestBody) return false; //todo 3ã€åˆ¤æ–­æ˜¯ä¸æ˜¯å±äºé‡è¯•çš„å¼‚å¸¸ //This exception is fatal. if (!isRecoverable(e, requestSendStarted)) return false; //todo 4ã€æ˜¯ä¸æ˜¯å­˜åœ¨æ›´å¤šçš„è·¯çº¿ ï¼ˆå¤šä¸ªipï¼Œå¤šä¸ªä»£ç†ï¼‰ //No more routes to attempt. if (!streamAllocation.hasMoreRoutes()) return false; // For failure recovery, use the same route selector with a new connection. return true; } é‡è¯•çš„å¼‚å¸¸åŒ…æ‹¬å“ªäº›ï¼š åœ¨ todo 3çš„isRecoverableæ–¹æ³•ä¸­ 12345678910111213141516171819202122232425262728private boolean isRecoverable(IOException e, boolean requestSendStarted) { // 1.æ˜¯ä¸æ˜¯åè®®å¼‚å¸¸ï¼ˆcodeä¸º204,205ä»£è¡¨æ²¡æœ‰å“åº”ä½“ï¼ŒåŒæ—¶å“åº”æ•°æ®é•¿åº¦è¿˜å¤§äº0ä¸¤éƒ½å†²çªï¼Œå‚ç…§CallServerInterceptorä¸­ // if ((code == 204 || code == 205) &amp;&amp; response.body().contentLength() &gt; 0)ï¼‰ //ï¼šä¸é‡è¯• if (e instanceof ProtocolException) { return false; } //2.socketè¶…æ—¶å¼‚å¸¸ è¿”å›true:é‡è¯• if (e instanceof InterruptedIOException) { return e instanceof SocketTimeoutException &amp;&amp; !requestSendStarted; } //3.//SSLè¯ä¹¦ä¸æ­£ç¡® å¯èƒ½è¯ä¹¦æ ¼å¼æŸå æœ‰é—®é¢˜ï¼šä¸é‡è¯• if (e instanceof SSLHandshakeException) { // If the problem was a CertificateException from the X509TrustManager, // do not retry. if (e.getCause() instanceof CertificateException) { return false; } } //4.SSLè¯ä¹¦æ ¡éªŒ ï¼šä¸é‡è¯• if (e instanceof SSLPeerUnverifiedException) { return false; } return true;} æ‰€ä»¥åœ¨socketè¶…æ—¶å¼‚å¸¸æ—¶ä¼šè¿›è¡Œé‡è¯•ï¼Œå…¶ä»–å¼‚å¸¸ä¸å†è¿›è¡Œé‡è¯• é‡å®šå‘åœºæ™¯ï¼š30Xï¼Œèµ„æºæ”¹å˜ æœ€å¤§é‡å®šå‘æ¬¡æ•°ä¸ºï¼š20 12345678//todo å¤„ç†3å’Œ4xxçš„ä¸€äº›çŠ¶æ€ç ï¼Œå¦‚301 302é‡å®šå‘Request followUp = followUpRequest(response, streamAllocation.route());if (followUp == null) { if (!forWebSocket) { streamAllocation.release(); } return response;} 1Request followUpRequest(Response userResponse, Route route) åœ¨followUpRequestä¸­å“åº”ç  407: 1234567891011//407 èº«ä»½æ ¡éªŒcase HTTP_PROXY_AUTH: Proxy selectedProxy = route != null ? route.proxy() : client.proxy(); if (selectedProxy.type() != Proxy.Type.HTTP) { throw new ProtocolException(&quot;Received HTTP_PROXY_AUTH (407) code while not &quot; + &quot;using proxy&quot;); } //ç”¨æˆ·æ²¡æœ‰è®¾ç½®å°±è¿”å›null,é‡å®šå‘å°±ç»“æŸäº† return client.proxyAuthenticator().authenticate(route, userResponse); ç”¨æˆ·è®¾ç½®èº«ä»½æ ¡éªŒ 123456789101112131415//è®¾ç½®èº«ä»½æ ¡éªŒçš„ä»£ç†new OkHttpClient.Builder().proxy(new Proxy(Proxy.Type.HTTP, new InetSocketAddress( &quot;localhost&quot;, 8080)))//è®¾ç½®èº«ä»½æ ¡éªŒ(é»˜è®¤ä¸è®¾ç½®è¿™ä¸ªï¼‰.proxyAuthenticator(new Authenticator() { @Nullable @Override public Request authenticate(Route route, Response response) throws IOException { //å‚ç…§Authenticatoræ¥å£æ³¨é‡Š return response.request().newBuilder() .header(&quot;Proxy-Authorization&quot;, Credentials.basic(&quot;ç”¨æˆ·å&quot;,&quot;å¯†ç &quot;)) .build(); }}).build(); 401: 1234// 401 éœ€è¦èº«ä»½éªŒè¯ æœ‰äº›æœåŠ¡å™¨æ¥å£éœ€è¦éªŒè¯ä½¿ç”¨è€…èº«ä»½ åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  â€œAuthorizationâ€case HTTP_UNAUTHORIZED: //ç±»ä¼¼407èº«ä»½éªŒè¯ï¼Œè®¾ç½®authenticator() return client.authenticator().authenticate(route, userResponse); é‡å®šå‘ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556// 308 æ°¸ä¹…é‡å®šå‘// 307 ä¸´æ—¶é‡å®šå‘case HTTP_PERM_REDIRECT:case HTTP_TEMP_REDIRECT: // å¦‚æœè¯·æ±‚æ–¹å¼ä¸æ˜¯GETæˆ–è€…HEADï¼Œæ¡†æ¶ä¸ä¼šè‡ªåŠ¨é‡å®šå‘è¯·æ±‚ if (!method.equals(&quot;GET&quot;) &amp;&amp; !method.equals(&quot;HEAD&quot;)) { return null; } // 300 301 302 303case HTTP_MULT_CHOICE:case HTTP_MOVED_PERM:case HTTP_MOVED_TEMP:case HTTP_SEE_OTHER: // å¦‚æœç”¨æˆ·ä¸å…è®¸é‡å®šå‘ï¼Œé‚£å°±è¿”å›null if (!client.followRedirects()) return null; // ä»å“åº”å¤´å–å‡ºlocation String location = userResponse.header(&quot;Location&quot;); if (location == null) return null; // æ ¹æ®location é…ç½®æ–°çš„è¯·æ±‚ url HttpUrl url = userResponse.request().url().resolve(location); // å¦‚æœä¸ºnullï¼Œè¯´æ˜åè®®æœ‰é—®é¢˜ï¼Œå–ä¸å‡ºæ¥HttpUrlï¼Œé‚£å°±è¿”å›nullï¼Œä¸è¿›è¡Œé‡å®šå‘ if (url == null) return null; // å¦‚æœé‡å®šå‘åœ¨httpåˆ°httpsä¹‹é—´åˆ‡æ¢ï¼Œéœ€è¦æ£€æŸ¥ç”¨æˆ·æ˜¯ä¸æ˜¯å…è®¸(é»˜è®¤å…è®¸) boolean sameScheme = url.scheme().equals(userResponse.request().url().scheme()); if (!sameScheme &amp;&amp; !client.followSslRedirects()) return null; Request.Builder requestBuilder = userResponse.request().newBuilder(); /** * é‡å®šå‘è¯·æ±‚ä¸­ åªè¦ä¸æ˜¯ PROPFIND è¯·æ±‚ï¼Œæ— è®ºæ˜¯POSTè¿˜æ˜¯å…¶ä»–çš„æ–¹æ³•éƒ½è¦æ”¹ä¸ºGETè¯·æ±‚æ–¹å¼ï¼Œ * å³åªæœ‰ PROPFIND è¯·æ±‚æ‰èƒ½æœ‰è¯·æ±‚ä½“ */ //è¯·æ±‚ä¸æ˜¯getä¸head if (HttpMethod.permitsRequestBody(method)) { final boolean maintainBody = HttpMethod.redirectsWithBody(method); // é™¤äº† PROPFIND è¯·æ±‚ä¹‹å¤–éƒ½æ”¹æˆGETè¯·æ±‚ if (HttpMethod.redirectsToGet(method)) { requestBuilder.method(&quot;GET&quot;, null); } else { RequestBody requestBody = maintainBody ? userResponse.request().body() : null; requestBuilder.method(method, requestBody); } // ä¸æ˜¯ PROPFIND çš„è¯·æ±‚ï¼ŒæŠŠè¯·æ±‚å¤´ä¸­å…³äºè¯·æ±‚ä½“çš„æ•°æ®åˆ æ‰ if (!maintainBody) { requestBuilder.removeHeader(&quot;Transfer-Encoding&quot;); requestBuilder.removeHeader(&quot;Content-Length&quot;); requestBuilder.removeHeader(&quot;Content-Type&quot;); } } // åœ¨è·¨ä¸»æœºé‡å®šå‘æ—¶ï¼Œåˆ é™¤èº«ä»½éªŒè¯è¯·æ±‚å¤´ if (!sameConnection(userResponse, url)) { requestBuilder.removeHeader(&quot;Authorization&quot;); } return requestBuilder.url(url).build(); 408è¯·æ±‚è¶…æ—¶ï¼š 123456789101112131415161718192021// 408 å®¢æˆ·ç«¯è¯·æ±‚è¶…æ—¶ case HTTP_CLIENT_TIMEOUT: // 408 ç®—æ˜¯è¿æ¥å¤±è´¥äº†ï¼Œæ‰€ä»¥åˆ¤æ–­ç”¨æˆ·æ˜¯ä¸æ˜¯å…è®¸é‡è¯• if (!client.retryOnConnectionFailure()) { return null; } // UnrepeatableRequestBodyå®é™…å¹¶æ²¡å‘ç°æœ‰å…¶ä»–åœ°æ–¹ç”¨åˆ° if (userResponse.request().body() instanceof UnrepeatableRequestBody) { return null; } // å¦‚æœæ˜¯æœ¬èº«è¿™æ¬¡çš„å“åº”å°±æ˜¯é‡æ–°è¯·æ±‚çš„äº§ç‰©åŒæ—¶ä¸Šä¸€æ¬¡ä¹‹æ‰€ä»¥é‡è¯·æ±‚è¿˜æ˜¯å› ä¸º408ï¼Œé‚£æˆ‘ä»¬è¿™æ¬¡ä¸å†é‡è¯·æ±‚äº† if (userResponse.priorResponse() != null &amp;&amp; userResponse.priorResponse().code() == HTTP_CLIENT_TIMEOUT) { return null; } // å¦‚æœæœåŠ¡å™¨å‘Šè¯‰æˆ‘ä»¬äº† Retry-After å¤šä¹…åé‡è¯•ï¼Œé‚£æ¡†æ¶ä¸ç®¡äº†ã€‚ if (retryAfter(userResponse, 0) &gt; 0) { return null; } return userResponse.request(); 503: // 503 æœåŠ¡ä¸å¯ç”¨ å’Œ408å·®ä¸å¤šï¼Œä½†æ˜¯åªåœ¨æœåŠ¡å™¨å‘Šè¯‰ä½  Retry-Afterï¼š0ï¼ˆæ„æ€å°±æ˜¯ç«‹å³é‡è¯•ï¼‰ æ‰é‡è¯·æ±‚ 12345678910case HTTP_UNAVAILABLE: if (userResponse.priorResponse() != null &amp;&amp; userResponse.priorResponse().code() == HTTP_UNAVAILABLE) { return null; }if (retryAfter(userResponse, Integer.MAX_VALUE) == 0) { return userResponse.request();}return null; é‡å®šå‘æ€»ç»“ï¼šæœåŠ¡å™¨è¿”å›300 301 302 303éœ€è¦é‡å®šå‘ï¼Œä¼šè·å–è¿”å›å¤´çš„Locationä¸­çš„æ–°åœ°å€ã€‚ å¦‚æœæ­¤æ–¹æ³•followUpRequestè¿”å›ç©ºï¼Œé‚£å°±è¡¨ç¤ºä¸éœ€è¦å†é‡å®šå‘äº†ï¼Œç›´æ¥è¿”å›å“åº”ï¼›ä½†æ˜¯å¦‚æœè¿”å›éç©ºï¼Œé‚£å°±è¦é‡æ–°è¯·æ±‚è¿”å›çš„Requestï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„followupåœ¨æ‹¦æˆªå™¨ä¸­å®šä¹‰çš„æœ€å¤§æ¬¡æ•°ä¸º20æ¬¡ã€‚ æ€»ç»“æœ¬æ‹¦æˆªå™¨æ˜¯æ•´ä¸ªè´£ä»»é“¾ä¸­çš„ç¬¬ä¸€ä¸ªï¼Œè¿™æ„å‘³ç€å®ƒä¼šæ˜¯é¦–æ¬¡æ¥è§¦åˆ°Requestä¸æœ€åæ¥æ”¶åˆ°Responseçš„è§’è‰²ï¼Œåœ¨è¿™ä¸ªæ‹¦æˆªå™¨ä¸­ä¸»è¦åŠŸèƒ½å°±æ˜¯åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•ä¸é‡å®šå‘ã€‚ é‡è¯•çš„å‰ææ˜¯å‡ºç°äº†RouteExceptionæˆ–è€…IOExceptionã€‚ä¸€ä½†åœ¨åç»­çš„æ‹¦æˆªå™¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°è¿™ä¸¤ä¸ªå¼‚å¸¸ï¼Œå°±ä¼šé€šè¿‡recoveræ–¹æ³•è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¿›è¡Œè¿æ¥é‡è¯•ã€‚ é‡å®šå‘å‘ç”Ÿåœ¨é‡è¯•çš„åˆ¤å®šä¹‹åï¼Œå¦‚æœä¸æ»¡è¶³é‡è¯•çš„æ¡ä»¶ï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥è°ƒç”¨followUpRequestæ ¹æ®Response çš„å“åº”ç (å½“ç„¶ï¼Œå¦‚æœç›´æ¥è¯·æ±‚å¤±è´¥ï¼ŒResponseéƒ½ä¸å­˜åœ¨å°±ä¼šæŠ›å‡ºå¼‚å¸¸)ã€‚followupæœ€å¤§å‘ç”Ÿ20æ¬¡ã€‚ äºŒã€æ¡¥æ¥æ‹¦æˆªå™¨ä¸¤å¤§ä½œç”¨ï¼šè¡¥å…¨è¯·æ±‚å¤´ï¼Œå¤„ç†å“åº”ï¼ˆä¿å­˜cookieï¼ŒGzipSourceï¼‰ è¡¥å…¨è¯·æ±‚ä¸å“åº”åå¤„ç† è¯·æ±‚å¤´ è¯´æ˜ Content-Type è¯·æ±‚ä½“ç±»å‹,å¦‚ï¼šapplication/x-www-form-urlencoded Content-Length/Transfer-Encoding è¯·æ±‚ä½“è§£ææ–¹å¼ Host è¯·æ±‚çš„ä¸»æœºç«™ç‚¹ Connection: Keep-Alive ä¿æŒé•¿è¿æ¥ Accept-Encoding: gzip æ¥å—å“åº”æ”¯æŒgzipå‹ç¼© Cookie cookieèº«ä»½è¾¨åˆ« User-Agent è¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚:æ“ä½œç³»ç»Ÿã€æµè§ˆå™¨ç­‰ å¾—åˆ°å“åº”ï¼š 1ã€è¯»å–Set-Cookieå“åº”å¤´å¹¶è°ƒç”¨æ¥å£å‘ŠçŸ¥ç”¨æˆ·ï¼Œåœ¨ä¸‹æ¬¡è¯·æ±‚åˆ™ä¼šè¯»å–å¯¹åº”çš„æ•°æ®è®¾ç½®è¿›å…¥è¯·æ±‚å¤´ï¼Œé»˜è®¤CookieJaræ— å®ç°ï¼› â€‹ 2ã€å“åº”å¤´Content-Encodingä¸ºgzipï¼Œä½¿ç”¨GzipSourceåŒ…è£…ä¾¿äºè§£æã€‚ æ€»ç»“æ¡¥æ¥æ‹¦æˆªå™¨çš„æ‰§è¡Œé€»è¾‘ä¸»è¦å°±æ˜¯ä»¥ä¸‹å‡ ç‚¹ å¯¹ç”¨æˆ·æ„å»ºçš„Requestè¿›è¡Œæ·»åŠ æˆ–è€…åˆ é™¤ç›¸å…³å¤´éƒ¨ä¿¡æ¯ï¼Œä»¥è½¬åŒ–æˆèƒ½å¤ŸçœŸæ­£è¿›è¡Œç½‘ç»œè¯·æ±‚çš„Requestå°†ç¬¦åˆç½‘ç»œè¯·æ±‚è§„èŒƒçš„Requestäº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨å¤„ç†ï¼Œå¹¶è·å–Responseå¦‚æœå“åº”ä½“ç»è¿‡äº†GZIPå‹ç¼©ï¼Œé‚£å°±éœ€è¦è§£å‹ï¼Œå†æ„å»ºæˆç”¨æˆ·å¯ç”¨çš„Responseå¹¶è¿”å› ä¸‰ã€ç¼“å­˜æ‹¦æˆªå™¨CacheInterceptorï¼Œåœ¨å‘å‡ºè¯·æ±‚å‰ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­ç¼“å­˜ã€‚å¦‚æœå‘½ä¸­åˆ™å¯ä»¥ä¸è¯·æ±‚ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜çš„å“åº”ã€‚ (åªä¼šå­˜åœ¨Getè¯·æ±‚çš„ç¼“å­˜) æ­¥éª¤ä¸º: 1ã€ä»ç¼“å­˜ä¸­è·å¾—å¯¹åº”è¯·æ±‚çš„å“åº”ç¼“å­˜ 2ã€åˆ›å»ºCacheStrategy ,åˆ›å»ºæ—¶ä¼šåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿä½¿ç”¨ç¼“å­˜ï¼Œåœ¨CacheStrategy ä¸­å­˜åœ¨ä¸¤ä¸ªæˆå‘˜:networkRequestä¸cacheResponseã€‚ä»–ä»¬çš„ç»„åˆå¦‚ä¸‹: networkRequest cacheResponse è¯´æ˜ Null Not Null ç›´æ¥ä½¿ç”¨ç¼“å­˜ Not Null Null å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚ Null Null ç›´æ¥ggï¼Œokhttpç›´æ¥è¿”å›504 Not Null Not Null å‘èµ·è¯·æ±‚ï¼Œè‹¥å¾—åˆ°å“åº”ä¸º304(æ— ä¿®æ”¹)ï¼Œåˆ™æ›´æ–°ç¼“å­˜å“åº”å¹¶è¿”å› å³ï¼šnetworkRequestå­˜åœ¨åˆ™ä¼˜å…ˆå‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œå¦åˆ™ä½¿ç”¨cacheResponseç¼“å­˜ï¼Œè‹¥éƒ½ä¸å­˜åœ¨åˆ™è¯·æ±‚å¤±è´¥ï¼ 3ã€äº¤ç»™ä¸‹ä¸€ä¸ªè´£ä»»é“¾ç»§ç»­å¤„ç† 4ã€åç»­å·¥ä½œï¼Œè¿”å›304åˆ™ç”¨ç¼“å­˜çš„å“åº”ï¼›å¦åˆ™ä½¿ç”¨ç½‘ç»œå“åº”å¹¶ç¼“å­˜æœ¬æ¬¡å“åº”ï¼ˆåªç¼“å­˜Getè¯·æ±‚çš„å“åº”ï¼‰ ç¼“å­˜æ‹¦æˆªå™¨çš„å·¥ä½œè¯´èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°ï¼Œéœ€è¦å¤„ç†çš„å†…å®¹å¾ˆå¤šã€‚åœ¨ç¼“å­˜æ‹¦æˆªå™¨ä¸­åˆ¤æ–­æ˜¯å¦å¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼Œæˆ–æ˜¯è¯·æ±‚æœåŠ¡å™¨éƒ½æ˜¯é€šè¿‡CacheStrategyåˆ¤æ–­ã€‚ ç¼“å­˜ç­–ç•¥123//todo ç¼“å­˜ç­–ç•¥:æ ¹æ®å„ç§æ¡ä»¶(è¯·æ±‚å¤´)ç»„æˆ è¯·æ±‚ä¸ç¼“å­˜CacheStrategy strategy = new CacheStrategy.Factory(now, chain.request(), cacheCandidate).get(); 12345678910public CacheStrategy get() { CacheStrategy candidate = getCandidate(); //todo å¦‚æœå¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼Œé‚£networkRequestå¿…å®šä¸ºnullï¼›æŒ‡å®šäº†åªä½¿ç”¨ç¼“å­˜ä½†æ˜¯networkRequeståˆä¸ä¸ºnullï¼Œå†²çªã€‚é‚£å°±gg(æ‹¦æˆªå™¨è¿”å›504) if (candidate.networkRequest != null &amp;&amp; request.cacheControl().onlyIfCached()) { // We're forbidden from using the network and the cache is insufficient. return new CacheStrategy(null, null); } return candidate;} æµç¨‹ï¼š æ²¡æœ‰ç¼“å­˜ï¼Œå°±è¿›è¡Œç½‘ç»œè¯·æ±‚ å¦‚æœæ˜¯Httpsè¯·æ±‚ï¼Œç¼“å­˜ä¸­æ²¡æœ‰ä¿å­˜æ¡æ‰‹ä¿¡æ¯ï¼Œå‘èµ·ç½‘ç»œè¯·æ±‚ é€šè¿‡å“åº”ç ä»¥åŠå¤´éƒ¨ç¼“å­˜æ§åˆ¶å­—æ®µåˆ¤æ–­å“åº”èƒ½ä¸èƒ½ç¼“å­˜ï¼Œä¸èƒ½ç¼“å­˜é‚£å°±è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼ˆisCacheableæ–¹æ³•ï¼‰ï¼šä¸å…è®¸ç”¨ å¦‚æœè¯·æ±‚åŒ…å«ï¼šCacheControl:no-cache éœ€è¦ä¸æœåŠ¡å™¨éªŒè¯ç¼“å­˜æœ‰æ•ˆæ€§ï¼ˆç”¨æˆ·é…ç½®ä¸è¿›è¡Œç¼“å­˜ï¼‰ï¼šä¸æƒ³ç”¨ å¦‚æœç¼“å­˜å“åº”ä¸­å­˜åœ¨ Cache-Control:immutable å“åº”å†…å®¹å°†ä¸€ç›´ä¸ä¼šæ”¹å˜,å¯ä»¥ä½¿ç”¨ç¼“å­˜ å“åº”çš„ç¼“å­˜æœ‰æ•ˆæœŸ è¿™ä¸€æ­¥ä¸ºè¿›ä¸€æ­¥æ ¹æ®ç¼“å­˜å“åº”ä¸­çš„ä¸€äº›ä¿¡æ¯åˆ¤å®šç¼“å­˜æ˜¯å¦å¤„äºæœ‰æ•ˆæœŸå†…ã€‚å¦‚æœæ»¡è¶³ï¼š ç¼“å­˜å­˜æ´»æ—¶é—´ &lt; ç¼“å­˜æ–°é²œåº¦ - ç¼“å­˜æœ€å°æ–°é²œåº¦ + è¿‡æœŸåç»§ç»­ä½¿ç”¨æ—¶é•¿ ä»£è¡¨å¯ä»¥ä½¿ç”¨ç¼“å­˜ã€‚å…¶ä¸­æ–°é²œåº¦å¯ä»¥ç†è§£ä¸ºæœ‰æ•ˆæ—¶é—´ï¼Œè€Œè¿™é‡Œçš„ â€œç¼“å­˜æ–°é²œåº¦-ç¼“å­˜æœ€å°æ–°é²œåº¦â€ å°±ä»£è¡¨äº†ç¼“å­˜çœŸæ­£æœ‰æ•ˆçš„æ—¶é—´ã€‚ ç¼“å­˜è¿‡æœŸå¤„ç† å¦‚æœç»§ç»­æ‰§è¡Œï¼Œè¡¨ç¤ºç¼“å­˜å·²ç»è¿‡æœŸæ— æ³•ä½¿ç”¨ã€‚æ­¤æ—¶æˆ‘ä»¬åˆ¤å®šç¼“å­˜çš„å“åº”ä¸­å¦‚æœå­˜åœ¨Etagï¼Œåˆ™ä½¿ç”¨If-None-Matchäº¤ç»™æœåŠ¡å™¨è¿›è¡ŒéªŒè¯ï¼›å¦‚æœå­˜åœ¨Last-Modifiedæˆ–è€…Dataï¼Œåˆ™ä½¿ç”¨If-Modified-Sinceäº¤ç»™æœåŠ¡å™¨éªŒè¯ã€‚æœåŠ¡å™¨å¦‚æœæ— ä¿®æ”¹åˆ™ä¼šè¿”å›304ï¼Œè¿™æ—¶å€™æ³¨æ„ï¼š ç”±äºæ˜¯ç¼“å­˜è¿‡æœŸè€Œå‘èµ·çš„è¯·æ±‚(ä¸ç¬¬4ä¸ªåˆ¤æ–­ç”¨æˆ·çš„ä¸»åŠ¨è®¾ç½®ä¸åŒ)ï¼Œå¦‚æœæœåŠ¡å™¨è¿”å›304ï¼Œé‚£æ¡†æ¶ä¼šè‡ªåŠ¨æ›´æ–°ç¼“å­˜ï¼Œæ‰€ä»¥æ­¤æ—¶CacheStrategyæ—¢åŒ…å«networkRequestä¹ŸåŒ…å«cacheResponse è¯¦ç»†æµç¨‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109private CacheStrategy getCandidate() { // No cached response. //todo 1ã€æ²¡æœ‰ç¼“å­˜,è¿›è¡Œç½‘ç»œè¯·æ±‚ if (cacheResponse == null) { return new CacheStrategy(request, null); } //todo 2ã€httpsè¯·æ±‚ï¼Œä½†æ˜¯æ²¡æœ‰æ¡æ‰‹ä¿¡æ¯,è¿›è¡Œç½‘ç»œè¯·æ±‚ // OkHttpä¼šä¿å­˜sslæ¡æ‰‹ä¿¡æ¯ handshake,å¦‚æœè¿™æ¬¡å‘èµ·äº†httpsè¯·æ±‚ï¼Œ // ä½†æ˜¯ç¼“å­˜çš„å“åº”ä¿¡æ¯ä¸­æ²¡æœ‰æ¡æ‰‹ä¿¡æ¯ï¼Œå‘èµ·ç½‘ç»œè¯·æ±‚ //Drop the cached response if it's missing a required handshake. if (request.isHttps() &amp;&amp; cacheResponse.handshake() == null) { return new CacheStrategy(request, null); } //todo 3ã€ä¸»è¦æ˜¯é€šè¿‡å“åº”ç ä»¥åŠå¤´éƒ¨ç¼“å­˜æ§åˆ¶å­—æ®µåˆ¤æ–­å“åº”èƒ½ä¸èƒ½ç¼“å­˜ï¼Œä¸èƒ½ç¼“å­˜é‚£å°±è¿›è¡Œç½‘ç»œè¯·æ±‚ //If this response shouldn't have been stored, it should never be used //as a response source. This check should be redundant as long as the //persistence store is well-behaved and the rules are constant. if (!isCacheable(cacheResponse, request)) { return new CacheStrategy(request, null); } CacheControl requestCaching = request.cacheControl(); //todo 4ã€å¦‚æœ è¯·æ±‚åŒ…å«ï¼šCacheControl:no-cache éœ€è¦ä¸æœåŠ¡å™¨éªŒè¯ç¼“å­˜æœ‰æ•ˆæ€§ // æˆ–è€…è¯·æ±‚å¤´åŒ…å« If-Modified-Sinceï¼šæ—¶é—´ å€¼ä¸ºlastModifiedæˆ–è€…data å¦‚æœæœåŠ¡å™¨æ²¡æœ‰åœ¨è¯¥å¤´éƒ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åä¿®æ”¹äº†è¯·æ±‚çš„æ•°æ®ï¼ŒæœåŠ¡å™¨è¿”å›304(æ— ä¿®æ”¹) // æˆ–è€…è¯·æ±‚å¤´åŒ…å« If-None-Matchï¼šå€¼å°±æ˜¯Etagï¼ˆèµ„æºæ ‡è®°ï¼‰æœåŠ¡å™¨å°†å…¶ä¸å­˜åœ¨æœåŠ¡ç«¯çš„Etagå€¼è¿›è¡Œæ¯”è¾ƒï¼›å¦‚æœåŒ¹é…ï¼Œè¿”å›304 // è¯·æ±‚å¤´ä¸­åªè¦å­˜åœ¨ä¸‰è€…ä¸­ä»»æ„ä¸€ä¸ªï¼Œè¿›è¡Œç½‘ç»œè¯·æ±‚ if (requestCaching.noCache() || hasConditions(request)) { return new CacheStrategy(request, null); } //todo 5ã€å¦‚æœç¼“å­˜å“åº”ä¸­å­˜åœ¨ Cache-Control:immutable å“åº”å†…å®¹å°†ä¸€ç›´ä¸ä¼šæ”¹å˜,å¯ä»¥ä½¿ç”¨ç¼“å­˜ CacheControl responseCaching = cacheResponse.cacheControl(); if (responseCaching.immutable()) { return new CacheStrategy(null, cacheResponse); } //todo 6ã€æ ¹æ® ç¼“å­˜å“åº”çš„ æ§åˆ¶ç¼“å­˜çš„å“åº”å¤´ åˆ¤æ–­æ˜¯å¦å…è®¸ä½¿ç”¨ç¼“å­˜ // 6.1ã€è·å¾—ç¼“å­˜çš„å“åº”ä»åˆ›å»ºåˆ°ç°åœ¨çš„æ—¶é—´ long ageMillis = cacheResponseAge(); //todo // 6.2ã€è·å–è¿™ä¸ªå“åº”æœ‰æ•ˆç¼“å­˜çš„æ—¶é•¿ long freshMillis = computeFreshnessLifetime(); if (requestCaching.maxAgeSeconds() != -1) { //todo å¦‚æœè¯·æ±‚ä¸­æŒ‡å®šäº† max-age è¡¨ç¤ºæŒ‡å®šäº†èƒ½æ‹¿çš„ç¼“å­˜æœ‰æ•ˆæ—¶é•¿ï¼Œå°±éœ€è¦ç»¼åˆå“åº”æœ‰æ•ˆç¼“å­˜æ—¶é•¿ä¸è¯·æ±‚èƒ½æ‹¿ç¼“å­˜çš„æ—¶é•¿ï¼Œè·å¾—æœ€å°çš„èƒ½å¤Ÿä½¿ç”¨å“åº”ç¼“å­˜çš„æ—¶é•¿ freshMillis = Math.min(freshMillis, SECONDS.toMillis(requestCaching.maxAgeSeconds())); } //todo // 6.3 è¯·æ±‚åŒ…å« Cache-Control:min-fresh=[ç§’] èƒ½å¤Ÿä½¿ç”¨è¿˜æœªè¿‡æŒ‡å®šæ—¶é—´çš„ç¼“å­˜ ï¼ˆè¯·æ±‚è®¤ä¸ºçš„ç¼“å­˜æœ‰æ•ˆæ—¶é—´ï¼‰ long minFreshMillis = 0; if (requestCaching.minFreshSeconds() != -1) { minFreshMillis = SECONDS.toMillis(requestCaching.minFreshSeconds()); } //todo // 6.4 // 6.4.1ã€Cache-Control:must-revalidate å¯ç¼“å­˜ä½†å¿…é¡»å†å‘æºæœåŠ¡å™¨è¿›è¡Œç¡®è®¤ // 6.4.2ã€Cache-Control:max-stale=[ç§’] ç¼“å­˜è¿‡æœŸåè¿˜èƒ½ä½¿ç”¨æŒ‡å®šçš„æ—¶é•¿ å¦‚æœæœªæŒ‡å®šå¤šå°‘ç§’ï¼Œåˆ™è¡¨ç¤ºæ— è®ºè¿‡æœŸå¤šé•¿æ—¶é—´éƒ½å¯ä»¥ï¼›å¦‚æœæŒ‡å®šäº†ï¼Œåˆ™åªè¦æ˜¯æŒ‡å®šæ—¶é—´å†…å°±èƒ½ä½¿ç”¨ç¼“å­˜ // å‰è€…ä¼šå¿½ç•¥åè€…ï¼Œæ‰€ä»¥åˆ¤æ–­äº†ä¸å¿…é¡»å‘æœåŠ¡å™¨ç¡®è®¤ï¼Œå†è·å¾—è¯·æ±‚å¤´ä¸­çš„max-stale long maxStaleMillis = 0; if (!responseCaching.mustRevalidate() &amp;&amp; requestCaching.maxStaleSeconds() != -1) { maxStaleMillis = SECONDS.toMillis(requestCaching.maxStaleSeconds()); } //todo // 6.5 ä¸éœ€è¦ä¸æœåŠ¡å™¨éªŒè¯æœ‰æ•ˆæ€§ &amp;&amp; å“åº”å­˜åœ¨çš„æ—¶é—´+è¯·æ±‚è®¤ä¸ºçš„ç¼“å­˜æœ‰æ•ˆæ—¶é—´ å°äº ç¼“å­˜æœ‰æ•ˆæ—¶é•¿+è¿‡æœŸåè¿˜å¯ä»¥ä½¿ç”¨çš„æ—¶é—´ // å…è®¸ä½¿ç”¨ç¼“å­˜ if (!responseCaching.noCache() &amp;&amp; ageMillis + minFreshMillis &lt; freshMillis + maxStaleMillis) { Response.Builder builder = cacheResponse.newBuilder(); //todo å¦‚æœå·²è¿‡æœŸï¼Œä½†æœªè¶…è¿‡ è¿‡æœŸåç»§ç»­ä½¿ç”¨æ—¶é•¿ï¼Œé‚£è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œåªç”¨æ·»åŠ ç›¸åº”çš„å¤´éƒ¨å­—æ®µ if (ageMillis + minFreshMillis &gt;= freshMillis) { builder.addHeader(&quot;Warning&quot;, &quot;110 HttpURLConnection \\&quot;Response is stale\\&quot;&quot;); } //todo å¦‚æœç¼“å­˜å·²è¶…è¿‡ä¸€å¤©å¹¶ä¸”å“åº”ä¸­æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ä¹Ÿéœ€è¦æ·»åŠ è­¦å‘Š long oneDayMillis = 24 * 60 * 60 * 1000L; if (ageMillis &gt; oneDayMillis &amp;&amp; isFreshnessLifetimeHeuristic()) { builder.addHeader(&quot;Warning&quot;, &quot;113 HttpURLConnection \\&quot;Heuristic expiration\\&quot;&quot;); } return new CacheStrategy(null, builder.build()); } // Find a condition to add to the request. If the condition is satisfied, the // response body // will not be transmitted. //todo 7ã€ç¼“å­˜è¿‡æœŸäº† String conditionName; String conditionValue; if (etag != null) { conditionName = &quot;If-None-Match&quot;; conditionValue = etag; } else if (lastModified != null) { conditionName = &quot;If-Modified-Since&quot;; conditionValue = lastModifiedString; } else if (servedDate != null) { conditionName = &quot;If-Modified-Since&quot;; conditionValue = servedDateString; } else { return new CacheStrategy(request, null); // No condition! Make a regular request. } //todo å¦‚æœè®¾ç½®äº† If-None-Match/If-Modified-Since æœåŠ¡å™¨æ˜¯å¯èƒ½è¿”å›304(æ— ä¿®æ”¹)çš„,ä½¿ç”¨ç¼“å­˜çš„å“åº”ä½“ Headers.Builder conditionalRequestHeaders = request.headers().newBuilder(); Internal.instance.addLenient(conditionalRequestHeaders, conditionName, conditionValue); Request conditionalRequest = request.newBuilder() .headers(conditionalRequestHeaders.build()) .build(); return new CacheStrategy(conditionalRequest, cacheResponse);} PSï¼šè¯·æ±‚å¤´ä¸å“åº”å¤´ å“åº”å¤´ è¯´æ˜ ä¾‹å­ Date æ¶ˆæ¯å‘é€çš„æ—¶é—´ Date: Sat, 18 Nov 2028 06:17:41 GMT Expires èµ„æºè¿‡æœŸçš„æ—¶é—´ Expires: Sat, 18 Nov 2028 06:17:41 GMT Last-Modified èµ„æºæœ€åä¿®æ”¹æ—¶é—´ Last-Modified: Fri, 22 Jul 2016 02:57:17 GMT ETag èµ„æºåœ¨æœåŠ¡å™¨çš„å”¯ä¸€æ ‡è¯† ETag: â€œ16df0-5383097a03d40â€ Age æœåŠ¡å™¨ç”¨ç¼“å­˜å“åº”è¯·æ±‚ï¼Œè¯¥ç¼“å­˜ä»äº§ç”Ÿåˆ°ç°åœ¨ç»è¿‡å¤šé•¿æ—¶é—´(ç§’) Age: 3825683 Cache-Control - - è¯·æ±‚å¤´ è¯´æ˜ ä¾‹å­ If-Modified-Since æœåŠ¡å™¨æ²¡æœ‰åœ¨æŒ‡å®šçš„æ—¶é—´åä¿®æ”¹è¯·æ±‚å¯¹åº”èµ„æº,è¿”å›304(æ— ä¿®æ”¹) If-Modified-Since: Fri, 22 Jul 2016 02:57:17 GMT If-None-Match æœåŠ¡å™¨å°†å…¶ä¸è¯·æ±‚å¯¹åº”èµ„æºçš„Etagå€¼è¿›è¡Œæ¯”è¾ƒï¼ŒåŒ¹é…è¿”å›304 If-None-Match: â€œ16df0-5383097a03d40â€ Cache-Control - - å…¶ä¸­Cache-Controlå¯ä»¥åœ¨è¯·æ±‚å¤´å­˜åœ¨ï¼Œä¹Ÿèƒ½åœ¨å“åº”å¤´å­˜åœ¨ï¼Œå¯¹åº”çš„valueå¯ä»¥è®¾ç½®å¤šç§ç»„åˆï¼š max-age=[ç§’] ï¼šèµ„æºæœ€å¤§æœ‰æ•ˆæ—¶é—´; public ï¼šè¡¨æ˜è¯¥èµ„æºå¯ä»¥è¢«ä»»ä½•ç”¨æˆ·ç¼“å­˜ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯ï¼Œä»£ç†æœåŠ¡å™¨ç­‰éƒ½å¯ä»¥ç¼“å­˜èµ„æº; privateï¼šè¡¨æ˜è¯¥èµ„æºåªèƒ½è¢«å•ä¸ªç”¨æˆ·ç¼“å­˜ï¼Œé»˜è®¤æ˜¯privateã€‚ no-storeï¼šèµ„æºä¸å…è®¸è¢«ç¼“å­˜ no-cacheï¼š(è¯·æ±‚)ä¸ä½¿ç”¨ç¼“å­˜ immutableï¼š(å“åº”)èµ„æºä¸ä¼šæ”¹å˜ min-fresh=[ç§’]ï¼š(è¯·æ±‚)ç¼“å­˜æœ€å°æ–°é²œåº¦(ç”¨æˆ·è®¤ä¸ºè¿™ä¸ªç¼“å­˜æœ‰æ•ˆçš„æ—¶é•¿) must-revalidateï¼š(å“åº”)ä¸å…è®¸ä½¿ç”¨è¿‡æœŸç¼“å­˜ max-stale=[ç§’]ï¼š(è¯·æ±‚)ç¼“å­˜è¿‡æœŸåå¤šä¹…å†…ä»ç„¶æœ‰æ•ˆ å‡è®¾å­˜åœ¨max-age=100ï¼Œmin-fresh=20ã€‚è¿™ä»£è¡¨äº†ç”¨æˆ·è®¤ä¸ºè¿™ä¸ªç¼“å­˜çš„å“åº”ï¼Œä»æœåŠ¡å™¨åˆ›å»ºå“åº” åˆ° èƒ½å¤Ÿç¼“å­˜ä½¿ç”¨çš„æ—¶é—´ä¸º100-20=80sã€‚ä½†æ˜¯å¦‚æœmax-stale=100ã€‚è¿™ä»£è¡¨äº†ç¼“å­˜æœ‰æ•ˆæ—¶é—´80sè¿‡åï¼Œä»ç„¶å…è®¸ä½¿ç”¨100sï¼Œå¯ä»¥çœ‹æˆç¼“å­˜æœ‰æ•ˆæ—¶é•¿ä¸º180sã€‚ å››ã€è¿æ¥æ‹¦æˆªå™¨è¿æ¥æµç¨‹ï¼š ConnectInterceptorï¼Œæ‰“å¼€ä¸ç›®æ ‡æœåŠ¡å™¨çš„è¿æ¥ï¼Œå¹¶æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ã€‚å®ƒç®€çŸ­çš„å¯ä»¥ç›´æ¥å®Œæ•´è´´åœ¨è¿™é‡Œï¼š 1234567891011121314151617181920public final class ConnectInterceptor implements Interceptor { public final OkHttpClient client; public ConnectInterceptor(OkHttpClient client) { this.client = client; } @Override public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain) chain; Request request = realChain.request(); StreamAllocation streamAllocation = realChain.streamAllocation(); // We need the network to satisfy this request. Possibly for validating a conditional GET. boolean doExtensiveHealthChecks = !request.method().equals(&quot;GET&quot;); HttpCodec httpCodec = streamAllocation.newStream(client, chain, doExtensiveHealthChecks); RealConnection connection = streamAllocation.connection(); return realChain.proceed(request, streamAllocation, httpCodec, connection); }} é¦–å…ˆæˆ‘ä»¬çœ‹åˆ°çš„StreamAllocationè¿™ä¸ªå¯¹è±¡æ˜¯åœ¨ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ï¼šé‡å®šå‘æ‹¦æˆªå™¨åˆ›å»ºçš„ï¼Œä½†æ˜¯çœŸæ­£ä½¿ç”¨çš„åœ°æ–¹å´åœ¨è¿™é‡Œã€‚ *â€å½“ä¸€ä¸ªè¯·æ±‚å‘å‡ºï¼Œéœ€è¦å»ºç«‹è¿æ¥ï¼Œè¿æ¥å»ºç«‹åéœ€è¦ä½¿ç”¨æµç”¨æ¥è¯»å†™æ•°æ®â€*ï¼›è€Œè¿™ä¸ªStreamAllocationå°±æ˜¯åè°ƒè¯·æ±‚ã€è¿æ¥ä¸æ•°æ®æµä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼Œå®ƒè´Ÿè´£ä¸ºä¸€æ¬¡è¯·æ±‚å¯»æ‰¾è¿æ¥ï¼Œç„¶åè·å¾—æµæ¥å®ç°ç½‘ç»œé€šä¿¡ã€‚ è¿™é‡Œä½¿ç”¨çš„newStreamæ–¹æ³•å®é™…ä¸Šå°±æ˜¯å»æŸ¥æ‰¾æˆ–è€…å»ºç«‹ä¸€ä¸ªä¸è¯·æ±‚ä¸»æœºæœ‰æ•ˆçš„è¿æ¥ï¼Œè¿”å›çš„HttpCodecä¸­åŒ…å«äº†è¾“å…¥è¾“å‡ºæµï¼Œå¹¶ä¸”å°è£…äº†å¯¹HTTPè¯·æ±‚æŠ¥æ–‡çš„ç¼–ç ä¸è§£ç ï¼Œç›´æ¥ä½¿ç”¨å®ƒå°±èƒ½å¤Ÿä¸è¯·æ±‚ä¸»æœºå®ŒæˆHTTPé€šä¿¡ã€‚ 123456789101112131415161718192021222324public HttpCodec newStream( OkHttpClient client, Interceptor.Chain chain, boolean doExtensiveHealthChecks) { int connectTimeout = chain.connectTimeoutMillis(); int readTimeout = chain.readTimeoutMillis(); int writeTimeout = chain.writeTimeoutMillis(); int pingIntervalMillis = client.pingIntervalMillis(); boolean connectionRetryEnabled = client.retryOnConnectionFailure(); try { //todo æ‰¾åˆ°ä¸€ä¸ªå¥åº·çš„è¿æ¥ RealConnection resultConnection = findHealthyConnection(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis, connectionRetryEnabled, doExtensiveHealthChecks); //todo åˆ©ç”¨è¿æ¥å®ä¾‹åŒ–æµHttpCodecå¯¹è±¡ï¼Œå¦‚æœæ˜¯HTTP/2è¿”å›Http2Codecï¼Œå¦åˆ™è¿”å›Http1Codec HttpCodec resultCodec = resultConnection.newCodec(client, chain, this); synchronized (connectionPool) { codec = resultCodec; return resultCodec; } } catch (IOException e) { throw new RouteException(e); }} StreamAllocationä¸­ç®€å•æ¥è¯´å°±æ˜¯ç»´æŠ¤è¿æ¥ï¼šRealConnectionâ€”â€”å°è£…äº†Socketä¸ä¸€ä¸ªSocketè¿æ¥æ± ã€‚å¯å¤ç”¨çš„RealConnection findHealthyConnectionæ–¹æ³•ä¸­ 12345678910111213141516171819202122232425262728293031private RealConnection findHealthyConnection(int connectTimeout, int readTimeout, int writeTimeout, int pingIntervalMillis, boolean connectionRetryEnabled, boolean doExtensiveHealthChecks) throws IOException { while (true) { //todo æ‰¾åˆ°ä¸€ä¸ªè¿æ¥ RealConnection candidate = findConnection(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis, connectionRetryEnabled); //todo å¦‚æœè¿™ä¸ªè¿æ¥æ˜¯æ–°å»ºç«‹çš„ï¼Œé‚£è‚¯å®šæ˜¯å¥åº·çš„ï¼Œç›´æ¥è¿”å› //If this is a brand new connection, we can skip the extensive health checks. synchronized (connectionPool) { if (candidate.successCount == 0) { return candidate; } } //todo å¦‚æœä¸æ˜¯æ–°åˆ›å»ºçš„ï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦å¥åº· //Do a (potentially slow) check to confirm that the pooled connection is still good. // If it // isn't, take it out of the pool and start again. if (!candidate.isHealthy(doExtensiveHealthChecks)) { //todo ä¸å¥åº· å…³é—­è¿æ¥ï¼Œé‡Šæ”¾Socket,ä»è¿æ¥æ± ç§»é™¤ // ç»§ç»­ä¸‹æ¬¡å¯»æ‰¾è¿æ¥æ“ä½œ noNewStreams(); continue; } return candidate; }} findConnectionæ–¹æ³•ä¸­çš„ å°è¯•ä»è¿æ¥æ± è·å–è¿æ¥ï¼Œå¦‚æœæœ‰å¯å¤ç”¨çš„è¿æ¥,ä¼šç»™ç¬¬ä¸‰ä¸ªå‚æ•° thisçš„connectionèµ‹å€¼ 1Internal.instance.get(connectionPool, address, this, null); è°ƒåˆ°äº†ï¼ˆConnectionPoolï¼‰connectionPool.getæ–¹æ³• 12345678910@Nullable RealConnection get(Address address, StreamAllocation streamAllocation, Route route) { assert (Thread.holdsLock(this)); for (RealConnection connection : connections) { if (connection.isEligible(address, route)) { streamAllocation.acquire(connection, true); return connection; } } return null;} isEligibleåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤ç”¨ ä½¿ç”¨http1.1å°±ä¸èƒ½ç”¨ å¦‚æœåœ°å€ä¸åŒå°±ä¸èƒ½å¤ç”¨ï¼ˆAddress.equalsNonHostï¼‰DNSã€ä»£ç†ã€SSLè¯ä¹¦ã€æœåŠ¡å™¨åŸŸåã€ç«¯å£ éƒ½ç›¸åŒé‚£å°±å¯ä»¥å¤ç”¨ 123456789101112131415161718192021222324252627282930313233343536373839404142434445public boolean isEligible(Address address, @Nullable Route route) { // If this connection is not accepting new streams, we're done. // TODO: å®é™…ä¸Šå°±æ˜¯åœ¨ä½¿ç”¨http1.1å°±ä¸èƒ½ç”¨ if (allocations.size() &gt;= allocationLimit || noNewStreams) return false; // If the non-host fields of the address don't overlap, we're done. // TODO: å¦‚æœåœ°å€ä¸åŒå°±ä¸èƒ½å¤ç”¨ï¼ˆAddress.equalsNonHostï¼‰DNSã€ä»£ç†ã€SSLè¯ä¹¦ã€æœåŠ¡å™¨åŸŸåã€ç«¯å£ï¼ˆåŸŸåæ²¡æœ‰åˆ¤æ–­ï¼Œæ‰€ä»¥ä¸‹é¢é©¬ä¸Šåˆ¤æ–­ï¼‰ if (!Internal.instance.equalsNonHost(this.route.address(), address)) return false; // If the host exactly matches, we're done: this connection can carry the address. //todo: éƒ½ç›¸åŒé‚£å°±å¯ä»¥å¤ç”¨äº† if (address.url().host().equals(this.route().address().url().host())) { return true; // This connection is a perfect match. } // At this point we don't have a hostname match. But we still be able to carry the // request if // our connection coalescing requirements are met. See also: // https://hpbn.co/optimizing-application-delivery/#eliminate-domain-sharding // https://daniel.haxx.se/blog/2016/08/18/http2-connection-coalescing/ // 1. This connection must be HTTP/2. if (http2Connection == null) return false; // 2. The routes must share an IP address. This requires us to have a DNS address for both // hosts, which only happens after route planning. We can't coalesce connections that use a // proxy, since proxies don't tell us the origin server's IP address. if (route == null) return false; if (route.proxy().type() != Proxy.Type.DIRECT) return false; if (this.route.proxy().type() != Proxy.Type.DIRECT) return false; if (!this.route.socketAddress().equals(route.socketAddress())) return false; // 3. This connection's server certificate's must cover the new host. if (route.address().hostnameVerifier() != OkHostnameVerifier.INSTANCE) return false; if (!supportsUrl(address.url())) return false; // 4. Certificate pinning must match the host. try { address.certificatePinner().check(address.url().host(), handshake().peerCertificates()); } catch (SSLPeerUnverifiedException e) { return false; } return true; // The caller's address can be carried by this connection.} æ²¡æ‰¾åˆ°ï¼Œå¿…é¡»æ–°å»ºä¸€ä¸ªè¿æ¥äº† 1234567891011121314 if (!foundPooledConnection) { if (selectedRoute == null) { selectedRoute = routeSelection.next(); } // Create a connection and assign it to this allocation immediately. This makes // it possible // for an asynchronous cancel() to interrupt the handshake we're about to do. route = selectedRoute; refusedStreamCount = 0; result = new RealConnection(connectionPool, selectedRoute); acquire(result, false); }} è¿æ¥æ± æ¸…ç†ï¼š findConnectionæ–¹æ³•ä¸­ï¼š 12//todo å°†æ–°åˆ›å»ºçš„è¿æ¥æ”¾åˆ°è¿æ¥æ± ä¸­Internal.instance.put(connectionPool, result); è°ƒçš„æ˜¯ConnectionPool.putæ–¹æ³• 123456789void put(RealConnection connection) { assert (Thread.holdsLock(this)); if (!cleanupRunning) { cleanupRunning = true; //å¯åŠ¨æ¸…ç† executor.execute(cleanupRunnable); } connections.add(connection);} 123456789101112131415161718192021private final Runnable cleanupRunnable = new Runnable() { @Override public void run() { while (true) { //todo:æœ€å¿«å¤šä¹…åéœ€è¦æ¸…ç† long waitNanos = cleanup(System.nanoTime()); if (waitNanos == -1) return; if (waitNanos &gt; 0) { //todo:å› ä¸ºç­‰å¾…æ˜¯çº³ç§’çº§ï¼Œwaitæ–¹æ³•å¯ä»¥æ¥æ”¶çº³ç§’çº§æ§åˆ¶ï¼Œä½†æ˜¯æŠŠæ¯«ç§’ä¸çº³ç§’åˆ†å¼€ long waitMillis = waitNanos / 1000000L; waitNanos -= (waitMillis * 1000000L); synchronized (ConnectionPool.this) { try { //todo:å‚æ•°å¤šä¸€ä¸ªçº³ç§’ï¼Œæ§åˆ¶æ›´åŠ ç²¾ç¡® ConnectionPool.this.wait(waitMillis, (int) waitNanos); } catch (InterruptedException ignored) { } } } } }}; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647long cleanup(long now) { int inUseConnectionCount = 0; int idleConnectionCount = 0; RealConnection longestIdleConnection = null; long longestIdleDurationNs = Long.MIN_VALUE; // Find either a connection to evict, or the time that the next eviction is due. synchronized (this) { for (Iterator&lt;RealConnection&gt; i = connections.iterator(); i.hasNext(); ) { RealConnection connection = i.next(); // If the connection is in use, keep searching. if (pruneAndGetAllocationCount(connection, now) &gt; 0) { inUseConnectionCount++; continue; } idleConnectionCount++; // TODO: è·å¾—è¿™ä¸ªè¿æ¥é—²ç½®å¤šä¹… // If the connection is ready to be evicted, we're done. long idleDurationNs = now - connection.idleAtNanos; if (idleDurationNs &gt; longestIdleDurationNs) { longestIdleDurationNs = idleDurationNs; longestIdleConnection = connection; } } //è¶…è¿‡ä¿æ´»æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰æˆ–è€…æ± å†…æ•°é‡è¶…è¿‡äº†5ä¸ªï¼Œé©¬ä¸Šç§»é™¤ï¼Œç„¶åè¿”å›0ï¼Œè¡¨ç¤ºä¸ç­‰å¾…ï¼Œé©¬ä¸Šå†æ¬¡æ£€æŸ¥ if (longestIdleDurationNs &gt;= this.keepAliveDurationNs || idleConnectionCount &gt; this.maxIdleConnections) { // We've found a connection to evict. Remove it from the list, then close it below (outside // of the synchronized block). connections.remove(longestIdleConnection); } else if (idleConnectionCount &gt; 0) { // A connection will be ready to evict soon. // TODO: æ± å†…å­˜åœ¨é—²ç½®è¿æ¥ï¼Œå°±ç­‰å¾…ï¼Œä¿æ´»æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰-æœ€é•¿é—²ç½®æ—¶é—´=è¿˜èƒ½é—²ç½®å¤šä¹… å†æ£€æŸ¥ return keepAliveDurationNs - longestIdleDurationNs; } else if (inUseConnectionCount &gt; 0) { // All connections are in use. It'll be at least the keep alive duration 'til we run again. // TODO: æœ‰ä½¿ç”¨ä¸­çš„è¿æ¥å°±ç­‰å¾…5åˆ†é’Ÿï¼Œå†æ£€æŸ¥ return keepAliveDurationNs; } else { // No connections, idle or in use. // TODO: éƒ½ä¸æ»¡è¶³ï¼Œå¯èƒ½æ± å†…æ²¡ä»»ä½•è¿æ¥ï¼Œç›´æ¥åœæ­¢æ¸…ç†ï¼ˆputåå†æ¬¡å¯ç”¨ï¼‰ cleanupRunning = false; return -1; } } ä»£ç†è¿æ¥ï¼š findConnectionä¸­ 123//todo å®é™…ä¸Šå°±æ˜¯åˆ›å»ºsocketè¿æ¥ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯å¦‚æœå­˜åœ¨httpä»£ç†çš„æƒ…å†µresult.connect(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis, connectionRetryEnabled, call, eventListener); RealConnection.connect 123456789101112if (route.requiresTunnel()) { //todo httpéš§é“ä»£ç† connectTunnel(connectTimeout, readTimeout, writeTimeout, call, eventListener); if (rawSocket == null) { // We were unable to connect the tunnel but properly closed down our // resources. break; }} else { //todo åˆ›å»ºsocketè¿æ¥ connectSocket(connectTimeout, readTimeout, call, eventListener);} æœ‰httpä»£ç†å…ˆè®¾ç½®ä»£ç†å¤´ï¼Œæœ€ç»ˆéƒ½ç”¨è°ƒç”¨connectSocketæ–¹æ³• 1234567891011121314151617181920private void connectTunnel(int connectTimeout, int readTimeout, int writeTimeout, Call call, EventListener eventListener) throws IOException { Request tunnelRequest = createTunnelRequest(); HttpUrl url = tunnelRequest.url(); for (int i = 0; i &lt; MAX_TUNNEL_ATTEMPTS; i++) { connectSocket(connectTimeout, readTimeout, call, eventListener); tunnelRequest = createTunnel(readTimeout, writeTimeout, tunnelRequest, url); if (tunnelRequest == null) break; // Tunnel successfully created. // The proxy decided to close the connection after an auth challenge. We need to // create a new // connection, but this time with the auth credentials. closeQuietly(rawSocket); rawSocket = null; sink = null; source = null; eventListener.connectEnd(call, route.socketAddress(), route.proxy(), null); }} 12345678private Request createTunnelRequest() { return new Request.Builder() .url(route.address().url()) .header(&quot;Host&quot;, Util.hostHeader(route.address().url(), true)) .header(&quot;Proxy-Connection&quot;, &quot;Keep-Alive&quot;) // For HTTP/1.0 proxies like Squid. .header(&quot;User-Agent&quot;, Version.userAgent()) .build();} 1234567891011121314151617181920212223242526272829303132333435363738/** * todo:åˆ›å»ºsocketè¿æ¥ * Does all the work necessary to build a full HTTP or HTTPS connection on a raw socket. */private void connectSocket(int connectTimeout, int readTimeout, Call call, EventListener eventListener) throws IOException { Proxy proxy = route.proxy(); Address address = route.address(); //todo:æ²¡æœ‰ä»£ç†ç›´æ¥newä¸€ä¸ªSocketï¼ˆï¼‰ï¼Œæœ‰ä»£ç†å°±åˆ›å»ºä¸€ä¸ªå¸¦ä»£ç†å‚æ•°çš„socket rawSocket = proxy.type() == Proxy.Type.DIRECT || proxy.type() == Proxy.Type.HTTP ? address.socketFactory().createSocket() : new Socket(proxy); eventListener.connectStart(call, route.socketAddress(), proxy); rawSocket.setSoTimeout(readTimeout); try { // TODO: socket.connect Platform.get().connectSocket(rawSocket, route.socketAddress(), connectTimeout); } catch (ConnectException e) { ConnectException ce = new ConnectException(&quot;Failed to connect to &quot; + route.socketAddress()); ce.initCause(e); throw ce; } // The following try/catch block is a pseudo hacky way to get around a crash on Android 7.0 // More details: // https://github.com/square/okhttp/issues/3245 // https://android-review.googlesource.com/#/c/271775/ try { source = Okio.buffer(Okio.source(rawSocket)); sink = Okio.buffer(Okio.sink(rawSocket)); } catch (NullPointerException npe) { if (NPE_THROW_WITH_NULL.equals(npe.getMessage())) { throw new IOException(npe); } }} äº”ã€è¯·æ±‚æœåŠ¡å™¨æ‹¦æˆªå™¨Expect: 100-continueä¸€èˆ¬å‡ºç°äºä¸Šä¼ å¤§å®¹é‡è¯·æ±‚ä½“æˆ–è€…éœ€è¦éªŒè¯ã€‚ä»£è¡¨äº†å…ˆè¯¢é—®æœåŠ¡å™¨æ˜¯å¦åŸå› æ¥æ”¶å‘é€è¯·æ±‚ä½“æ•°æ®ã€‚ï¼ˆå…ˆåªå‘é€è¯·æ±‚å¤´ï¼‰ OkHttpçš„åšæ³•ï¼šå¦‚æœæœåŠ¡å™¨å…è®¸åˆ™è¿”å›100ï¼Œå®¢æˆ·ç«¯ç»§ç»­å‘é€è¯·æ±‚ä½“ï¼›å¦‚æœæœåŠ¡å™¨ä¸å…è®¸åˆ™ç›´æ¥è¿”å›ç»™ç”¨æˆ·ã€‚ åŒæ—¶æœåŠ¡å™¨ä¹Ÿå¯èƒ½ä¼šå¿½ç•¥æ­¤è¯·æ±‚å¤´ï¼Œä¸€ç›´æ— æ³•è¯»å–åº”ç­”ï¼Œæ­¤æ—¶æŠ›å‡ºè¶…æ—¶å¼‚å¸¸ã€‚ CallServerInterceptorï¼Œåˆ©ç”¨HttpCodecå‘å‡ºè¯·æ±‚åˆ°æœåŠ¡å™¨å¹¶ä¸”è§£æç”ŸæˆResponseã€‚ é¦–å…ˆè°ƒç”¨httpCodec.writeRequestHeaders(request); å°†è¯·æ±‚å¤´å†™å…¥åˆ°ç¼“å­˜ä¸­(ç›´åˆ°è°ƒç”¨flushRequest()æ‰çœŸæ­£å‘é€ç»™æœåŠ¡å™¨)ã€‚ç„¶åé©¬ä¸Šè¿›è¡Œç¬¬ä¸€ä¸ªé€»è¾‘åˆ¤æ–­ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131public final class CallServerInterceptor implements Interceptor { private final boolean forWebSocket; public CallServerInterceptor(boolean forWebSocket) { this.forWebSocket = forWebSocket; } @Override public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain) chain; HttpCodec httpCodec = realChain.httpStream(); StreamAllocation streamAllocation = realChain.streamAllocation(); RealConnection connection = (RealConnection) realChain.connection(); Request request = realChain.request(); long sentRequestMillis = System.currentTimeMillis(); realChain.eventListener().requestHeadersStart(realChain.call()); //todo:æ‹¼æ¥è¯·æ±‚çš„æ•°æ® httpCodec.writeRequestHeaders(request); realChain.eventListener().requestHeadersEnd(realChain.call(), request); Response.Builder responseBuilder = null; //todo:å¦‚æœæ²¡æœ‰è¯·æ±‚ä½“æˆ–è€…ä¸æ˜¯postè·³è¿‡ if (HttpMethod.permitsRequestBody(request.method()) &amp;&amp; request.body() != null) { // If there's a &quot;Expect: 100-continue&quot; header on the request, wait for a &quot;HTTP/1.1 100 // Continue&quot; response before transmitting the request body. If we don't get that, return // what we did get (such as a 4xx response) without ever transmitting the request body. // todo: å¦‚æœæ˜¯postè¯·æ±‚ï¼Œå¹¶åŒ…å«äº†100-continue,ä¸å‘è¯·æ±‚ä½“ï¼Œè¯»æœåŠ¡å™¨çš„å“åº” if (&quot;100-continue&quot;.equalsIgnoreCase(request.header(&quot;Expect&quot;))) { // todo: å‘é€è¯·æ±‚å¤´ httpCodec.flushRequest(); realChain.eventListener().responseHeadersStart(realChain.call()); responseBuilder = httpCodec.readResponseHeaders(true); } //æœåŠ¡è¿”å›100ï¼ŒresponseBuilderä¼šç½®ä¸ºnull if (responseBuilder == null) { // Write the request body if the &quot;Expect: 100-continue&quot; expectation was met. realChain.eventListener().requestBodyStart(realChain.call()); long contentLength = request.body().contentLength(); CountingSink requestBodyOut = new CountingSink(httpCodec.createRequestBody(request, contentLength)); BufferedSink bufferedRequestBody = Okio.buffer(requestBodyOut); //todoï¼šå†™å…¥è¯·æ±‚ä½“ request.body().writeTo(bufferedRequestBody); bufferedRequestBody.close(); realChain.eventListener() .requestBodyEnd(realChain.call(), requestBodyOut.successfulCount); } else if (!connection.isMultiplexed()) { // If the &quot;Expect: 100-continue&quot; expectation wasn't met, prevent the HTTP/1 // connection // from being reused. Otherwise we're still obligated to transmit the request // body to // leave the connection in a consistent state. streamAllocation.noNewStreams(); } } httpCodec.finishRequest(); // TODO: è¯»å–æœåŠ¡å™¨å“åº” if (responseBuilder == null) { realChain.eventListener().responseHeadersStart(realChain.call()); responseBuilder = httpCodec.readResponseHeaders(false); } Response response = responseBuilder .request(request) .handshake(streamAllocation.connection().handshake()) .sentRequestAtMillis(sentRequestMillis) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); int code = response.code(); // todo: æœåŠ¡å™¨å…è®¸ç»§ç»­å‘é€å“åº”ä½“ if (code == 100) { // server sent a 100-continue even though we did not request one. // try again to read the actual response responseBuilder = httpCodec.readResponseHeaders(false); response = responseBuilder .request(request) .handshake(streamAllocation.connection().handshake()) .sentRequestAtMillis(sentRequestMillis) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); code = response.code(); } realChain.eventListener() .responseHeadersEnd(realChain.call(), response); if (forWebSocket &amp;&amp; code == 101) { // Connection is upgrading, but we need to ensure interceptors see a non-null // response body. response = response.newBuilder() .body(Util.EMPTY_RESPONSE) .build(); } else { response = response.newBuilder() .body(httpCodec.openResponseBody(response)) .build(); } if (&quot;close&quot;.equalsIgnoreCase(response.request().header(&quot;Connection&quot;)) || &quot;close&quot;.equalsIgnoreCase(response.header(&quot;Connection&quot;))) { streamAllocation.noNewStreams(); } if ((code == 204 || code == 205) &amp;&amp; response.body().contentLength() &gt; 0) { throw new ProtocolException( &quot;HTTP &quot; + code + &quot; had non-zero Content-Length: &quot; + response.body().contentLength()); } return response; } static final class CountingSink extends ForwardingSink { long successfulCount; CountingSink(Sink delegate) { super(delegate); } @Override public void write(Buffer source, long byteCount) throws IOException { super.write(source, byteCount); successfulCount += byteCount; } }} æ•´ä¸ªiféƒ½å’Œä¸€ä¸ªè¯·æ±‚å¤´æœ‰å…³ï¼š Expect: 100-continueã€‚è¿™ä¸ªè¯·æ±‚å¤´ä»£è¡¨äº†åœ¨å‘é€è¯·æ±‚ä½“ä¹‹å‰éœ€è¦å’ŒæœåŠ¡å™¨ç¡®å®šæ˜¯å¦æ„¿æ„æ¥å—å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä½“ã€‚æ‰€ä»¥permitsRequestBodyåˆ¤æ–­ä¸ºæ˜¯å¦ä¼šæºå¸¦è¯·æ±‚ä½“çš„æ–¹å¼(POST)ï¼Œå¦‚æœå‘½ä¸­ifï¼Œåˆ™ä¼šå…ˆç»™æœåŠ¡å™¨å‘èµ·ä¸€æ¬¡æŸ¥è¯¢æ˜¯å¦æ„¿æ„æ¥æ”¶è¯·æ±‚ä½“ï¼Œè¿™æ—¶å€™å¦‚æœæœåŠ¡å™¨æ„¿æ„ä¼šå“åº”100(æ²¡æœ‰å“åº”ä½“ï¼ŒresponseBuilder å³ä¸ºnul)ã€‚è¿™æ—¶å€™æ‰èƒ½å¤Ÿç»§ç»­å‘é€å‰©ä½™è¯·æ±‚æ•°æ®ã€‚ ä½†æ˜¯å¦‚æœæœåŠ¡å™¨ä¸åŒæ„æ¥å—è¯·æ±‚ä½“ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ ‡è®°è¯¥è¿æ¥ä¸èƒ½å†è¢«å¤ç”¨ï¼Œè°ƒç”¨noNewStreams()å…³é—­ç›¸å…³çš„Socketã€‚ 123456789101112// TODO: è¯»å–æœåŠ¡å™¨å“åº”if (responseBuilder == null) { realChain.eventListener().responseHeadersStart(realChain.call()); responseBuilder = httpCodec.readResponseHeaders(false);}Response response = responseBuilder .request(request) .handshake(streamAllocation.connection().handshake()) .sentRequestAtMillis(sentRequestMillis) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); è¿™æ—¶responseBuilderçš„æƒ…å†µå³ä¸ºï¼š 1ã€POSTæ–¹å¼è¯·æ±‚ï¼Œè¯·æ±‚å¤´ä¸­åŒ…å«Expectï¼ŒæœåŠ¡å™¨å…è®¸æ¥å—è¯·æ±‚ä½“ï¼Œå¹¶ä¸”å·²ç»å‘å‡ºäº†è¯·æ±‚ä½“ï¼ŒresponseBuilderä¸ºnull; 2ã€POSTæ–¹å¼è¯·æ±‚ï¼Œè¯·æ±‚å¤´ä¸­åŒ…å«Expectï¼ŒæœåŠ¡å™¨ä¸å…è®¸æ¥å—è¯·æ±‚ä½“ï¼ŒresponseBuilderä¸ä¸ºnull 3ã€POSTæ–¹å¼è¯·æ±‚ï¼ŒæœªåŒ…å«Expectï¼Œç›´æ¥å‘å‡ºè¯·æ±‚ä½“ï¼ŒresponseBuilderä¸ºnull; 4ã€POSTæ–¹å¼è¯·æ±‚ï¼Œæ²¡æœ‰è¯·æ±‚ä½“ï¼ŒresponseBuilderä¸ºnull; 5ã€GETæ–¹å¼è¯·æ±‚ï¼ŒresponseBuilderä¸ºnull; å¯¹åº”ä¸Šé¢çš„5ç§æƒ…å†µï¼Œè¯»å–å“åº”å¤´å¹¶ä¸”ç»„æˆå“åº”Responseï¼Œæ³¨æ„ï¼šæ­¤Responseæ²¡æœ‰å“åº”ä½“ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæœåŠ¡å™¨æ¥å— Expect: 100-continueè¿™æ˜¯ä¸æ˜¯æ„å‘³ç€æˆ‘ä»¬å‘èµ·äº†ä¸¤æ¬¡Requestï¼Ÿé‚£æ­¤æ—¶çš„å“åº”å¤´æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è¯¢æœåŠ¡å™¨æ˜¯å¦æ”¯æŒæ¥å—è¯·æ±‚ä½“çš„ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„è¯·æ±‚å¯¹åº”çš„ç»“æœå“åº”ã€‚ æ‰€ä»¥ å¦‚æœå“åº”æ˜¯100ï¼Œè¿™ä»£è¡¨äº†æ˜¯è¯·æ±‚Expect: 100-continueæˆåŠŸçš„å“åº”ï¼Œéœ€è¦é©¬ä¸Šå†æ¬¡è¯»å–ä¸€ä»½å“åº”å¤´ï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„è¯·æ±‚å¯¹åº”ç»“æœå“åº”å¤´ã€‚ æœ€åï¼š forWebSocketä»£è¡¨websocketçš„è¯·æ±‚ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥elseï¼Œè¿™é‡Œå°±æ˜¯è¯»å–å“åº”ä½“æ•°æ®ã€‚ç„¶ååˆ¤æ–­è¯·æ±‚å’ŒæœåŠ¡å™¨æ˜¯ä¸æ˜¯éƒ½å¸Œæœ›é•¿è¿æ¥ï¼Œä¸€æ—¦æœ‰ä¸€æ–¹æŒ‡æ˜closeï¼Œé‚£ä¹ˆå°±éœ€è¦å…³é—­socketã€‚è€Œå¦‚æœæœåŠ¡å™¨è¿”å›204/205ï¼Œä¸€èˆ¬æƒ…å†µè€Œè¨€ä¸ä¼šå­˜åœ¨è¿™äº›è¿”å›ç ï¼Œä½†æ˜¯ä¸€æ—¦å‡ºç°è¿™æ„å‘³ç€æ²¡æœ‰å“åº”ä½“ï¼Œä½†æ˜¯è§£æåˆ°çš„å“åº”å¤´ä¸­åŒ…å«Content-Lenghtä¸”ä¸ä¸º0ï¼Œè¿™è¡¨å“åº”ä½“çš„æ•°æ®å­—èŠ‚é•¿åº¦ã€‚æ­¤æ—¶å‡ºç°äº†å†²çªï¼Œç›´æ¥æŠ›å‡ºåè®®å¼‚å¸¸ï¼ æ€»ç»“åœ¨è¿™ä¸ªæ‹¦æˆªå™¨ä¸­å°±æ˜¯å®ŒæˆHTTPåè®®æŠ¥æ–‡çš„å°è£…ä¸è§£æã€‚ è‡ªå®šä¹‰æ‹¦æˆªå™¨123456789new OkHttpClient().newBuilder().addInterceptor(new Interceptor() { @Override public Response intercept(Chain chain) throws IOException { // todo: ....... final Response response = chain.proceed(chain.request()); // todo: ....... return response; }}); ä¸€å®šè¦è°ƒç”¨chain.proceed,å¹¶å°†responseè¿”å›ã€‚ ä¸è°ƒç”¨çš„è¯ï¼Œä¼šä½¿è´£ä»»é“¾ä¸­æ–­ï¼Œåé¢å…¶ä»–å°±æ²¡æ³•æ‰§è¡Œäº†ã€‚ OkHttpæ€»ç»“æ•´ä¸ªOkHttpåŠŸèƒ½çš„å®ç°å°±åœ¨è¿™äº”ä¸ªé»˜è®¤çš„æ‹¦æˆªå™¨ä¸­ï¼Œæ‰€ä»¥å…ˆç†è§£æ‹¦æˆªå™¨æ¨¡å¼çš„å·¥ä½œæœºåˆ¶æ˜¯å…ˆå†³æ¡ä»¶ã€‚è¿™äº”ä¸ªæ‹¦æˆªå™¨åˆ†åˆ«ä¸º: é‡è¯•æ‹¦æˆªå™¨ã€æ¡¥æ¥æ‹¦æˆªå™¨ã€ç¼“å­˜æ‹¦æˆªå™¨ã€è¿æ¥æ‹¦æˆªå™¨ã€è¯·æ±‚æœåŠ¡æ‹¦æˆªå™¨ã€‚æ¯ä¸€ä¸ªæ‹¦æˆªå™¨è´Ÿè´£çš„å·¥ä½œä¸ä¸€æ ·ï¼Œå°±å¥½åƒå·¥å‚æµæ°´çº¿ï¼Œæœ€ç»ˆç»è¿‡è¿™äº”é“å·¥åºï¼Œå°±å®Œæˆäº†æœ€ç»ˆçš„äº§å“ã€‚ ä½†æ˜¯ä¸æµæ°´çº¿ä¸åŒçš„æ˜¯ï¼ŒOkHttpä¸­çš„æ‹¦æˆªå™¨æ¯æ¬¡å‘èµ·è¯·æ±‚éƒ½ä¼šåœ¨äº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ä¹‹å‰å¹²ä¸€äº›äº‹æƒ…ï¼Œåœ¨è·å¾—äº†ç»“æœä¹‹ååˆå¹²ä¸€äº›äº‹æƒ…ã€‚æ•´ä¸ªè¿‡ç¨‹åœ¨è¯·æ±‚å‘æ˜¯é¡ºåºçš„ï¼Œè€Œå“åº”å‘åˆ™æ˜¯é€†åºã€‚ å½“ç”¨æˆ·å‘èµ·ä¸€ä¸ªè¯·æ±‚åï¼Œä¼šç”±ä»»åŠ¡åˆ†å‘èµ·Dispatcherå°†è¯·æ±‚åŒ…è£…å¹¶äº¤ç»™é‡è¯•æ‹¦æˆªå™¨å¤„ç†ã€‚ 1ã€é‡è¯•æ‹¦æˆªå™¨åœ¨äº¤å‡º(äº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨)ä¹‹å‰ï¼Œè´Ÿè´£åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å–æ¶ˆäº†è¯·æ±‚ï¼›åœ¨è·å¾—äº†ç»“æœä¹‹åï¼Œä¼šæ ¹æ®å“åº”ç åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šå‘ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶é‚£ä¹ˆå°±ä¼šé‡å¯æ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨ã€‚ 2ã€æ¡¥æ¥æ‹¦æˆªå™¨åœ¨äº¤å‡ºä¹‹å‰ï¼Œè´Ÿè´£å°†HTTPåè®®å¿…å¤‡çš„è¯·æ±‚å¤´åŠ å…¥å…¶ä¸­(å¦‚ï¼šHost)å¹¶æ·»åŠ ä¸€äº›é»˜è®¤çš„è¡Œä¸º(å¦‚ï¼šGZIPå‹ç¼©)ï¼›åœ¨è·å¾—äº†ç»“æœåï¼Œè°ƒç”¨ä¿å­˜cookieæ¥å£å¹¶è§£æGZIPæ•°æ®ã€‚ 3ã€ç¼“å­˜æ‹¦æˆªå™¨é¡¾åæ€ä¹‰ï¼Œäº¤å‡ºä¹‹å‰è¯»å–å¹¶åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ç¼“å­˜ï¼›è·å¾—ç»“æœååˆ¤æ–­æ˜¯å¦ç¼“å­˜ã€‚ 4ã€è¿æ¥æ‹¦æˆªå™¨åœ¨äº¤å‡ºä¹‹å‰ï¼Œè´Ÿè´£æ‰¾åˆ°æˆ–è€…æ–°å»ºä¸€ä¸ªè¿æ¥ï¼Œå¹¶è·å¾—å¯¹åº”çš„socketæµï¼›åœ¨è·å¾—ç»“æœåä¸è¿›è¡Œé¢å¤–çš„å¤„ç†ã€‚ 5ã€è¯·æ±‚æœåŠ¡å™¨æ‹¦æˆªå™¨è¿›è¡ŒçœŸæ­£çš„ä¸æœåŠ¡å™¨çš„é€šä¿¡ï¼Œå‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè§£æè¯»å–çš„å“åº”æ•°æ®ã€‚ åœ¨ç»è¿‡äº†è¿™ä¸€ç³»åˆ—çš„æµç¨‹åï¼Œå°±å®Œæˆäº†ä¸€æ¬¡HTTPè¯·æ±‚ï¼ è¡¥å……: ä»£ç†åœ¨ä½¿ç”¨OkHttpæ—¶ï¼Œå¦‚æœç”¨æˆ·åœ¨åˆ›å»ºOkHttpClientæ—¶ï¼Œé…ç½®äº†proxyæˆ–è€…proxySelectorï¼Œåˆ™ä¼šä½¿ç”¨é…ç½®çš„ä»£ç†ï¼Œå¹¶ä¸”proxyä¼˜å…ˆçº§é«˜äºproxySelectorã€‚è€Œå¦‚æœæœªé…ç½®ï¼Œåˆ™ä¼šè·å–æœºå™¨é…ç½®çš„ä»£ç†å¹¶ä½¿ç”¨ã€‚ 123456789//JDK : ProxySelectortry { URI uri = new URI(&quot;http://restapi.amap.com&quot;); List&lt;Proxy&gt; proxyList = ProxySelector.getDefault().select(uri); System.out.println(proxyList.get(0).address()); System.out.println(proxyList.get(0).type());} catch (URISyntaxException e) { e.printStackTrace();} å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä¸éœ€è¦è‡ªå·±çš„Appä¸­çš„è¯·æ±‚èµ°ä»£ç†ï¼Œåˆ™å¯ä»¥é…ç½®ä¸€ä¸ªproxy(Proxy.NO_PROXY)ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥é¿å…è¢«æŠ“åŒ…ã€‚NO_PROXYçš„å®šä¹‰å¦‚ä¸‹ï¼š 12345public static final Proxy NO_PROXY = new Proxy();private Proxy() { this.type = Proxy.Type.DIRECT; this.sa = null;} ä»£ç†åœ¨Javaä¸­å¯¹åº”çš„æŠ½è±¡ç±»æœ‰ä¸‰ç§ç±»å‹: 1234567public static enum Type { DIRECT, HTTP, SOCKS; private Type() { }} DIRECTï¼šæ— ä»£ç†ï¼ŒHTTPï¼šhttpä»£ç†ï¼ŒSOCKSï¼šsocksä»£ç†ã€‚ç¬¬ä¸€ç§è‡ªç„¶ä¸ç”¨å¤šè¯´ï¼Œè€ŒHttpä»£ç†ä¸Socksä»£ç†æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ å¯¹äºSocksä»£ç†ï¼Œåœ¨HTTPçš„åœºæ™¯ä¸‹ï¼Œä»£ç†æœåŠ¡å™¨å®ŒæˆTCPæ•°æ®åŒ…çš„è½¬å‘å·¥ä½œ;è€ŒHttpä»£ç†æœåŠ¡å™¨ï¼Œåœ¨è½¬å‘æ•°æ®ä¹‹å¤–ï¼Œè¿˜ä¼šè§£æHTTPçš„è¯·æ±‚åŠå“åº”ï¼Œå¹¶æ ¹æ®è¯·æ±‚åŠå“åº”çš„å†…å®¹åšä¸€äº›å¤„ç†ã€‚ RealConnectionçš„connectSocketæ–¹æ³•: 123456//å¦‚æœæ˜¯Socksä»£ç†åˆ™ new Socket(proxy); å¦åˆ™ç›¸å½“äºç›´æ¥:new Socket()rawSocket = proxy.type() == Proxy.Type.DIRECT || proxy.type() == Proxy.Type.HTTP ? address.socketFactory().createSocket() : new Socket(proxy);//connectæ–¹æ³•socket.connect(address); è®¾ç½®äº†SOCKSä»£ç†çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºSocketæ—¶ï¼Œä¸ºå…¶ä¼ å…¥proxyï¼Œè¿æ¥æ—¶è¿˜æ˜¯ä»¥HTTPæœåŠ¡å™¨ä¸ºç›®æ ‡åœ°å€ï¼›ä½†æ˜¯å¦‚æœè®¾ç½®çš„æ˜¯Httpä»£ç†ï¼Œåˆ›å»ºSocketæ˜¯ä¸Httpä»£ç†æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚ åœ¨connectæ–¹æ³•æ—¶ä¼ é€’çš„addressæ¥è‡ªäºä¸‹é¢çš„é›†åˆinetSocketAddressesRouteSelectorçš„resetNextInetSocketAddressæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233private void resetNextInetSocketAddress(Proxy proxy) throws IOException { // ...... if (proxy.type() == Proxy.Type.DIRECT || proxy.type() == Proxy.Type.SOCKS) { //æ— ä»£ç†å’Œsocksä»£ç†ï¼Œä½¿ç”¨httpæœåŠ¡å™¨åŸŸåä¸ç«¯å£ socketHost = address.url().host(); socketPort = address.url().port(); } else { SocketAddress proxyAddress = proxy.address(); if (!(proxyAddress instanceof InetSocketAddress)) { throw new IllegalArgumentException( &quot;Proxy.address() is not an &quot; + &quot;InetSocketAddress: &quot; + proxyAddress.getClass()); } InetSocketAddress proxySocketAddress = (InetSocketAddress) proxyAddress; socketHost = getHostString(proxySocketAddress); socketPort = proxySocketAddress.getPort(); } // ...... if (proxy.type() == Proxy.Type.SOCKS) { //socksä»£ç† connect httpæœåŠ¡å™¨ ï¼ˆDNSæ²¡ç”¨ï¼Œç”±ä»£ç†æœåŠ¡å™¨è§£æåŸŸåï¼‰ inetSocketAddresses.add(InetSocketAddress.createUnresolved(socketHost, socketPort)); } else { //æ— ä»£ç†ï¼Œdnsè§£æhttpæœåŠ¡å™¨ //httpä»£ç†,dnsè§£æhttpä»£ç†æœåŠ¡å™¨ List&lt;InetAddress&gt; addresses = address.dns().lookup(socketHost); //...... for (int i = 0, size = addresses.size(); i &lt; size; i++) { InetAddress inetAddress = addresses.get(i); inetSocketAddresses.add(new InetSocketAddress(inetAddress, socketPort)); } }} è®¾ç½®ä»£ç†æ—¶ï¼ŒHttpæœåŠ¡å™¨çš„åŸŸåè§£æä¼šè¢«äº¤ç»™ä»£ç†æœåŠ¡å™¨æ‰§è¡Œã€‚ä½†æ˜¯å¦‚æœæ˜¯è®¾ç½®äº†Httpä»£ç†ï¼Œä¼šå¯¹Httpä»£ç†æœåŠ¡å™¨çš„åŸŸåä½¿ç”¨OkhttpClienté…ç½®çš„dnsè§£æä»£ç†æœåŠ¡å™¨ï¼ŒHttpæœåŠ¡å™¨çš„åŸŸåè§£æè¢«äº¤ç»™ä»£ç†æœåŠ¡å™¨è§£æã€‚ ä¸Šè¿°ä»£ç å°±æ˜¯ä»£ç†ä¸DNSåœ¨OkHttpä¸­çš„ä½¿ç”¨ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼ŒHttpä»£ç†ä¹Ÿåˆ†æˆä¸¤ç§ç±»å‹ï¼šæ™®é€šä»£ç†ä¸éš§é“ä»£ç†ã€‚ å…¶ä¸­æ™®é€šä»£ç†ä¸éœ€è¦é¢å¤–çš„æ“ä½œï¼Œæ‰®æ¼”ã€Œä¸­é—´äººã€çš„è§’è‰²ï¼Œåœ¨ä¸¤ç«¯ä¹‹é—´æ¥å›ä¼ é€’æŠ¥æ–‡ã€‚è¿™ä¸ªâ€œä¸­é—´äººâ€åœ¨æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚æŠ¥æ–‡æ—¶ï¼Œéœ€è¦æ­£ç¡®çš„å¤„ç†è¯·æ±‚å’Œè¿æ¥çŠ¶æ€ï¼ŒåŒæ—¶å‘æœåŠ¡å™¨å‘é€æ–°çš„è¯·æ±‚ï¼Œåœ¨æ”¶åˆ°å“åº”åï¼Œå°†å“åº”ç»“æœåŒ…è£…æˆä¸€ä¸ªå“åº”ä½“è¿”å›ç»™å®¢æˆ·ç«¯ã€‚åœ¨æ™®é€šä»£ç†çš„æµç¨‹ä¸­ï¼Œä»£ç†ä¸¤ç«¯éƒ½æ˜¯æœ‰å¯èƒ½å¯Ÿè§‰ä¸åˆ°â€ä¸­é—´äººâ€œçš„å­˜åœ¨ã€‚ ä½†æ˜¯éš§é“ä»£ç†ä¸å†ä½œä¸ºä¸­é—´äººï¼Œæ— æ³•æ”¹å†™å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè€Œä»…ä»…æ˜¯åœ¨å»ºç«‹è¿æ¥åï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œé€šè¿‡å»ºç«‹å¥½çš„éš§é“ï¼Œæ— è„‘çš„è½¬å‘ç»™ç»ˆç«¯æœåŠ¡å™¨ã€‚éš§é“ä»£ç†éœ€è¦å‘èµ·Http CONNECTè¯·æ±‚ï¼Œè¿™ç§è¯·æ±‚æ–¹å¼æ²¡æœ‰è¯·æ±‚ä½“ï¼Œä»…ä¾›ä»£ç†æœåŠ¡å™¨ä½¿ç”¨ï¼Œå¹¶ä¸ä¼šä¼ é€’ç»™ç»ˆç«¯æœåŠ¡å™¨ã€‚è¯·æ±‚å¤´ éƒ¨åˆ†ä¸€æ—¦ç»“æŸï¼Œåé¢çš„æ‰€æœ‰æ•°æ®ï¼Œéƒ½è¢«è§†ä¸ºåº”è¯¥è½¬å‘ç»™ç»ˆç«¯æœåŠ¡å™¨çš„æ•°æ®ï¼Œä»£ç†éœ€è¦æŠŠä»–ä»¬æ— è„‘çš„ç›´æ¥è½¬å‘ï¼Œç›´åˆ°ä»å®¢æˆ·ç«¯çš„ TCP è¯»é€šé“å…³é—­ã€‚CONNECT çš„å“åº”æŠ¥æ–‡ï¼Œåœ¨ä»£ç†æœåŠ¡å™¨å’Œç»ˆç«¯æœåŠ¡å™¨å»ºç«‹è¿æ¥åï¼Œå¯ä»¥å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª 200 Connect established çš„çŠ¶æ€ç ï¼Œä»¥æ­¤è¡¨ç¤ºå’Œç»ˆç«¯æœåŠ¡å™¨çš„è¿æ¥ï¼Œå»ºç«‹æˆåŠŸã€‚ RealConnectionçš„connectæ–¹æ³• 1234567891011if (route.requiresTunnel()) { connectTunnel(connectTimeout, readTimeout, writeTimeout, call, eventListener); if (rawSocket == null) { // We were unable to connect the tunnel but properly closed down our // resources. break; }} else { connectSocket(connectTimeout, readTimeout, call, eventListener);} requiresTunnelæ–¹æ³•çš„åˆ¤å®šä¸ºï¼šå½“å‰è¯·æ±‚ä¸ºhttpså¹¶ä¸”å­˜åœ¨httpä»£ç†ï¼Œè¿™æ—¶å€™connectTunnelä¸­ä¼šå‘èµ·: 1234CONNECT xxxx HTTP/1.1Host: xxxxProxy-Connection: Keep-AliveUser-Agent: okhttp/${version} çš„è¯·æ±‚ï¼Œè¿æ¥æˆåŠŸä»£ç†æœåŠ¡å™¨ä¼šè¿”å›200ï¼›å¦‚æœè¿”å›407è¡¨ç¤ºä»£ç†æœåŠ¡å™¨éœ€è¦é‰´æƒ(å¦‚ï¼šä»˜è´¹ä»£ç†)ï¼Œè¿™æ—¶éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŠ å…¥Proxy-Authorizationï¼š 123456789101112131415 Authenticator authenticator = new Authenticator() { @Nullable @Override public Request authenticate(Route route, Response response) throws IOException { if(response.code == 407){ //ä»£ç†é‰´æƒ String credential = Credentials.basic(&quot;ä»£ç†æœåŠ¡ç”¨æˆ·å&quot;, &quot;ä»£ç†æœåŠ¡å¯†ç &quot;); return response.request().newBuilder() .header(&quot;Proxy-Authorization&quot;, credential) .build(); } return null; } };new OkHttpClient.Builder().proxyAuthenticator(authenticator);","link":"/2020/12/10/okhttp/"},{"title":"ViewåŸºç¡€","text":"Androidè‡ªå®šä¹‰Viewæ¦‚è¿° Androidå¼€å‘è¿›é˜¶çš„å¿…ç»ä¹‹è·¯ ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰View è‡ªå®šä¹‰Viewçš„åŸºæœ¬æ–¹æ³• è‡ªå®šä¹‰æ§ä»¶åˆ†ç±» è‡ªå®šä¹‰ViewåŸºç¡€ Viewçš„åˆ†ç±» Viewç±»ç®€ä»‹ AttributeSetä¸è‡ªå®šä¹‰å±æ€§ Viewè§†å›¾ç»“æ„ Androidåæ ‡ç³» Viewä½ç½®ï¼ˆåæ ‡ï¼‰æè¿° ä½ç½®è·å–æ–¹å¼ Androidä¸­é¢œè‰²ç›¸å…³å†…å®¹ Viewæ ‘çš„ç»˜åˆ¶æµç¨‹ Viewæ ‘çš„ç»˜åˆ¶æµç¨‹æ˜¯è°è´Ÿè´£çš„ï¼Ÿ viewçš„æ·»åŠ  viewçš„ç»˜åˆ¶æµç¨‹ measure layout draw LayoutParams MarginLayoutParams LayoutParamsä¸Viewå¦‚ä½•å»ºç«‹è”ç³» addView è‡ªå®šä¹‰LayoutParams LayoutParamså¸¸è§çš„å­ç±» MeasureSpec å®šä¹‰ MeasureSpecs çš„æ„ä¹‰ MeasureSpecå€¼çš„ç¡®å®š Androidå¼€å‘è¿›é˜¶çš„å¿…ç»ä¹‹è·¯ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰Viewè‡ªå®šä¹‰Viewçš„åŸºæœ¬æ–¹æ³•è‡ªå®šä¹‰Viewçš„æœ€åŸºæœ¬çš„ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯ï¼š onMeasure()ã€onLayout()ã€onDraw();Viewåœ¨Activityä¸­æ˜¾ç¤ºå‡ºæ¥ï¼Œè¦ç»å†æµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶ä¸‰ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«å¯¹åº”ä¸‰ä¸ªåŠ¨ä½œï¼šmeasureã€layoutå’Œdrawã€‚ æµ‹é‡ï¼šonMeasure()å†³å®šViewçš„å¤§å°ï¼› å¸ƒå±€ï¼šonLayout()å†³å®šViewåœ¨ViewGroupä¸­çš„ä½ç½®ï¼› ç»˜åˆ¶ï¼šonDraw()å†³å®šç»˜åˆ¶è¿™ä¸ªViewã€‚ è‡ªå®šä¹‰æ§ä»¶åˆ†ç±» è‡ªå®šä¹‰View: åªéœ€è¦é‡å†™onMeasure()å’ŒonDraw() è‡ªå®šä¹‰ViewGroup: åˆ™åªéœ€è¦é‡å†™onMeasure()å’ŒonLayout() è‡ªå®šä¹‰ViewåŸºç¡€Viewçš„åˆ†ç±»è§†å›¾Viewä¸»è¦åˆ†ä¸ºä¸¤ç±»| ç±»åˆ« | è§£é‡Š | ç‰¹ç‚¹ || â€”â€”â€“ | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“ | â€”â€”â€”â€” || å•ä¸€è§†å›¾ | å³ä¸€ä¸ªViewï¼Œå¦‚TextView | ä¸åŒ…å«å­View || è§†å›¾ç»„ | å³å¤šä¸ªViewç»„æˆçš„ViewGroupï¼Œå¦‚LinearLayout | åŒ…å«å­View | Viewç±»ç®€ä»‹ Viewç±»æ˜¯Androidä¸­å„ç§ç»„ä»¶çš„åŸºç±»ï¼Œå¦‚Viewæ˜¯ViewGroupåŸºç±» Viewè¡¨ç°ä¸ºæ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å„ç§è§†å›¾ Androidä¸­çš„UIç»„ä»¶éƒ½ç”±Viewã€ViewGroupç»„æˆã€‚ Viewçš„æ„é€ å‡½æ•°ï¼šå…±æœ‰4ä¸ª 12345678910111213141516171819202122232425// å¦‚æœViewæ˜¯åœ¨Javaä»£ç é‡Œé¢newçš„ï¼Œåˆ™è°ƒç”¨ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•° public CarsonView(Context context) { super(context); }// å¦‚æœViewæ˜¯åœ¨.xmlé‡Œå£°æ˜çš„ï¼Œåˆ™è°ƒç”¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•°// è‡ªå®šä¹‰å±æ€§æ˜¯ä»AttributeSetå‚æ•°ä¼ è¿›æ¥çš„ public CarsonView(Context context, AttributeSet attrs) { super(context, attrs); }// ä¸ä¼šè‡ªåŠ¨è°ƒç”¨// ä¸€èˆ¬æ˜¯åœ¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•°é‡Œä¸»åŠ¨è°ƒç”¨// å¦‚Viewæœ‰styleå±æ€§æ—¶ public CarsonView(Context context, AttributeSet attrs, int defStyleAttr) { super(context, attrs, defStyleAttr); } //API21ä¹‹åæ‰ä½¿ç”¨ // ä¸ä¼šè‡ªåŠ¨è°ƒç”¨ // ä¸€èˆ¬æ˜¯åœ¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•°é‡Œä¸»åŠ¨è°ƒç”¨ // å¦‚Viewæœ‰styleå±æ€§æ—¶ public CarsonView(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) { super(context, attrs, defStyleAttr, defStyleRes); } AttributeSetä¸è‡ªå®šä¹‰å±æ€§ ç³»ç»Ÿè‡ªå¸¦çš„Viewå¯ä»¥åœ¨xmlä¸­é…ç½®å±æ€§ï¼Œå¯¹äºå†™çš„å¥½çš„è‡ªå®šä¹‰ViewåŒæ ·å¯ä»¥åœ¨xmlä¸­é…ç½®å±æ€§ï¼Œä¸ºäº†ä½¿è‡ªå®šä¹‰çš„Viewçš„å±æ€§å¯ä»¥åœ¨xmlä¸­é…ç½®ï¼Œéœ€è¦ä»¥ä¸‹4ä¸ªæ­¥éª¤ï¼š é€šè¿‡&lt;declare-styleable&gt;ä¸ºè‡ªå®šä¹‰Viewæ·»åŠ å±æ€§ åœ¨xmlä¸­ä¸ºç›¸åº”çš„å±æ€§å£°æ˜å±æ€§å€¼ åœ¨è¿è¡Œæ—¶ï¼ˆä¸€èˆ¬ä¸ºæ„é€ å‡½æ•°ï¼‰è·å–å±æ€§å€¼ å°†è·å–åˆ°çš„å±æ€§å€¼åº”ç”¨åˆ°View Viewè§†å›¾ç»“æ„ PhoneWindowæ˜¯Androidç³»ç»Ÿä¸­æœ€åŸºæœ¬çš„çª—å£ç³»ç»Ÿï¼Œç»§æ‰¿è‡ªWindowsç±»ï¼Œè´Ÿè´£ç®¡ç†ç•Œé¢æ˜¾ç¤ºä»¥åŠäº‹ä»¶å“åº”ã€‚å®ƒæ˜¯Activityä¸Viewç³»ç»Ÿäº¤äº’çš„æ¥å£ DecorViewæ˜¯PhoneWindowä¸­çš„èµ·å§‹èŠ‚ç‚¹Viewï¼Œç»§æ‰¿äºViewç±»ï¼Œä½œä¸ºæ•´ä¸ªè§†å›¾å®¹å™¨æ¥ä½¿ç”¨ã€‚ç”¨äºè®¾ç½®çª—å£å±æ€§ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªFrameLayout ViewRootåœ¨Activtiyå¯åŠ¨æ—¶åˆ›å»ºï¼Œè´Ÿè´£ç®¡ç†ã€å¸ƒå±€ã€æ¸²æŸ“çª—å£UIç­‰ç­‰ å¯¹äºå¤šViewçš„è§†å›¾ï¼Œç»“æ„æ˜¯æ ‘å½¢ç»“æ„ï¼šæœ€é¡¶å±‚æ˜¯ViewGroupï¼ŒViewGroupä¸‹å¯èƒ½æœ‰å¤šä¸ªViewGroupæˆ–Viewï¼Œå¦‚ä¸‹å›¾ï¼š ä¸€å®šè¦è®°ä½ï¼šæ— è®ºæ˜¯measureè¿‡ç¨‹ã€layoutè¿‡ç¨‹è¿˜æ˜¯drawè¿‡ç¨‹ï¼Œæ°¸è¿œéƒ½æ˜¯ä»Viewæ ‘çš„æ ¹èŠ‚ç‚¹å¼€å§‹æµ‹é‡æˆ–è®¡ç®—ï¼ˆå³ä»æ ‘çš„é¡¶ç«¯å¼€å§‹ï¼‰ï¼Œä¸€å±‚ä¸€å±‚ã€ä¸€ä¸ªåˆ†æ”¯ä¸€ä¸ªåˆ†æ”¯åœ°è¿›è¡Œï¼ˆå³æ ‘å½¢é€’å½’ï¼‰ï¼Œæœ€ç»ˆè®¡ç®—æ•´ä¸ªViewæ ‘ä¸­å„ä¸ªViewï¼Œæœ€ç»ˆç¡®å®šæ•´ä¸ªViewæ ‘çš„ç›¸å…³å±æ€§ã€‚ Androidåæ ‡ç³»Androidçš„åæ ‡ç³»å®šä¹‰ä¸ºï¼š å±å¹•çš„å·¦ä¸Šè§’ä¸ºåæ ‡åŸç‚¹ å‘å³ä¸ºxè½´å¢å¤§æ–¹å‘ å‘ä¸‹ä¸ºyè½´å¢å¤§æ–¹å‘ åŒºåˆ«äºä¸€èˆ¬çš„æ•°å­¦åæ ‡ç³» Viewä½ç½®ï¼ˆåæ ‡ï¼‰æè¿°Viewçš„ä½ç½®ç”±4ä¸ªé¡¶ç‚¹å†³å®šçš„4ä¸ªé¡¶ç‚¹çš„ä½ç½®æè¿°åˆ†åˆ«ç”±4ä¸ªå€¼å†³å®šï¼š è¯·è®°ä½ï¼šViewçš„ä½ç½®æ˜¯ç›¸å¯¹äºçˆ¶æ§ä»¶è€Œè¨€çš„ï¼‰ Topï¼šå­Viewä¸Šè¾¹ç•Œåˆ°çˆ¶viewä¸Šè¾¹ç•Œçš„è·ç¦» Leftï¼šå­Viewå·¦è¾¹ç•Œåˆ°çˆ¶viewå·¦è¾¹ç•Œçš„è·ç¦» Bottomï¼šå­Viewä¸‹è¾¹è·åˆ°çˆ¶Viewä¸Šè¾¹ç•Œçš„è·ç¦» Rightï¼šå­Viewå³è¾¹ç•Œåˆ°çˆ¶viewå·¦è¾¹ç•Œçš„è·ç¦» ä½ç½®è·å–æ–¹å¼Viewçš„ä½ç½®æ˜¯é€šè¿‡view.getxxx()å‡½æ•°è¿›è¡Œè·å–ï¼šï¼ˆä»¥Topä¸ºä¾‹ï¼‰ 123456789// è·å–Topä½ç½®public final int getTop() { return mTop; } // å…¶ä½™å¦‚ä¸‹ï¼š getLeft(); //è·å–å­Viewå·¦ä¸Šè§’è·çˆ¶Viewå·¦ä¾§çš„è·ç¦» getBottom(); //è·å–å­Viewå³ä¸‹è§’è·çˆ¶Viewé¡¶éƒ¨çš„è·ç¦» getRight(); //è·å–å­Viewå³ä¸‹è§’è·çˆ¶Viewå·¦ä¾§çš„è·ç¦» ä¸MotionEventä¸­ get()å’ŒgetRaw()çš„åŒºåˆ« 1234567//get() ï¼šè§¦æ‘¸ç‚¹ç›¸å¯¹äºå…¶æ‰€åœ¨ç»„ä»¶åæ ‡ç³»çš„åæ ‡ event.getX(); event.getY();//getRaw() ï¼šè§¦æ‘¸ç‚¹ç›¸å¯¹äºå±å¹•é»˜è®¤åæ ‡ç³»çš„åæ ‡ event.getRawX(); event.getRawY(); Androidä¸­é¢œè‰²ç›¸å…³å†…å®¹Androidæ”¯æŒçš„é¢œè‰²æ¨¡å¼ï¼šä»¥ARGB8888ä¸ºä¾‹ä»‹ç»é¢œè‰²å®šä¹‰: Viewæ ‘çš„ç»˜åˆ¶æµç¨‹Viewæ ‘çš„ç»˜åˆ¶æµç¨‹æ˜¯è°è´Ÿè´£çš„ï¼Ÿviewæ ‘çš„ç»˜åˆ¶æµç¨‹æ˜¯é€šè¿‡ViewRootå»è´Ÿè´£ç»˜åˆ¶çš„ï¼ŒViewRootè¿™ä¸ªç±»çš„å‘½åæœ‰ç‚¹å‘ï¼Œæœ€åˆçœ‹åˆ°è¿™ä¸ªåå­—ï¼Œç¿»è¯‘è¿‡æ¥æ˜¯viewçš„æ ¹èŠ‚ç‚¹ï¼Œä½†æ˜¯äº‹å®å®Œå…¨ä¸æ˜¯è¿™æ ·ï¼ŒViewRootå…¶å®ä¸æ˜¯Viewçš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒè¿viewèŠ‚ç‚¹éƒ½ç®—ä¸ä¸Šï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯Viewæ ‘çš„ç®¡ç†è€…ï¼Œè´Ÿè´£å°†DecorViewå’ŒPhoneWindowâ€œç»„åˆâ€èµ·æ¥ï¼Œè€ŒViewæ ‘çš„æ ¹èŠ‚ç‚¹ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´åªæœ‰DecorViewï¼›æ¯ä¸ªDecorViewéƒ½æœ‰ä¸€ä¸ªViewRootä¸ä¹‹å…³è”ï¼Œè¿™ç§å…³è”å…³ç³»æ˜¯ç”±WindowManagerå»è¿›è¡Œç®¡ç†çš„ï¼› viewçš„æ·»åŠ  viewçš„ç»˜åˆ¶æµç¨‹ measure ç³»ç»Ÿä¸ºä»€ä¹ˆè¦æœ‰measureè¿‡ç¨‹ï¼Ÿ measureè¿‡ç¨‹éƒ½å¹²äº†ç‚¹ä»€ä¹ˆäº‹ï¼Ÿ å¯¹äºè‡ªé€‚åº”çš„å°ºå¯¸æœºåˆ¶ï¼Œå¦‚ä½•åˆç†çš„æµ‹é‡ä¸€é¢—Viewæ ‘ï¼Ÿ é‚£ä¹ˆViewGroupæ˜¯å¦‚ä½•å‘å­Viewä¼ é€’é™åˆ¶ä¿¡æ¯çš„ï¼Ÿ ScrollViewåµŒå¥—ListViewé—®é¢˜ï¼Ÿ layout ç³»ç»Ÿä¸ºä»€ä¹ˆè¦æœ‰layoutè¿‡ç¨‹ï¼Ÿ layoutè¿‡ç¨‹éƒ½å¹²äº†ç‚¹ä»€ä¹ˆäº‹ï¼Ÿ draw ç³»ç»Ÿä¸ºä»€ä¹ˆè¦æœ‰drawè¿‡ç¨‹ï¼Ÿ drawè¿‡ç¨‹éƒ½å¹²äº†ç‚¹ä»€ä¹ˆäº‹ï¼Ÿ LayoutParamsLayoutParamsç¿»è¯‘è¿‡æ¥å°±æ˜¯å¸ƒå±€å‚æ•°ï¼Œå­Viewé€šè¿‡LayoutParamså‘Šè¯‰çˆ¶å®¹å™¨ï¼ˆViewGroupï¼‰åº”è¯¥å¦‚ä½•æ”¾ç½®è‡ªå·±ã€‚ä»è¿™ä¸ªå®šä¹‰ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥LayoutParamsä¸ViewGroupæ˜¯æ¯æ¯ç›¸å…³çš„ï¼Œå› æ­¤è„±ç¦»ViewGroupè°ˆLayoutParamsæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚ äº‹å®ä¸Šï¼Œæ¯ä¸ªViewGroupçš„å­ç±»éƒ½æœ‰è‡ªå·±å¯¹åº”çš„LayoutParamsç±»ï¼Œå…¸å‹çš„å¦‚LinearLayout.LayoutParamså’ŒFrameLayout.LayoutParamsç­‰ï¼Œå¯ä»¥çœ‹å‡ºæ¥LayoutParamséƒ½æ˜¯å¯¹åº”ViewGroupå­ç±»çš„å†…éƒ¨ç±» MarginLayoutParamsMarginLayoutParamsæ˜¯å’Œå¤–é—´è·æœ‰å…³çš„ã€‚äº‹å®ä¹Ÿç¡®å®å¦‚æ­¤ï¼Œå’ŒLayoutParamsç›¸æ¯”ï¼ŒMarginLayoutParamsåªæ˜¯å¢åŠ äº†å¯¹ä¸Šä¸‹å·¦å³å¤–é—´è·çš„æ”¯æŒã€‚å®é™…ä¸Šå¤§éƒ¨åˆ†LayoutParamsçš„å®ç°ç±»éƒ½æ˜¯ç»§æ‰¿è‡ªMarginLayoutParamsï¼Œå› ä¸ºåŸºæœ¬æ‰€æœ‰çš„çˆ¶å®¹å™¨éƒ½æ˜¯æ”¯æŒå­Viewè®¾ç½®å¤–é—´è·çš„ å±æ€§ä¼˜å…ˆçº§é—®é¢˜MarginLayoutParamsä¸»è¦å°±æ˜¯å¢åŠ äº†ä¸Šä¸‹å·¦å³4ç§å¤–é—´è·ã€‚åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯è·å–äº†marginå±æ€§ï¼›å¦‚æœè¯¥å€¼ä¸åˆæ³•ï¼Œå°±è·å–horizontalMarginï¼›å¦‚æœè¯¥å€¼ä¸åˆæ³•ï¼Œå†å»è·å–leftMarginå’ŒrightMarginå±æ€§ï¼ˆverticalMarginã€topMarginå’ŒbottomMarginåŒç†ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥æ®æ­¤æ€»ç»“å‡ºè¿™å‡ ç§å±æ€§çš„ä¼˜å…ˆçº§ margin &gt; horizontalMarginå’ŒverticalMargin &gt; leftMarginå’ŒRightMarginã€topMarginå’ŒbottomMargin å±æ€§è¦†ç›–é—®é¢˜ä¼˜å…ˆçº§æ›´é«˜çš„å±æ€§ä¼šè¦†ç›–æ‰ä¼˜å…ˆçº§è¾ƒä½çš„å±æ€§ã€‚æ­¤å¤–ï¼Œè¿˜è¦æ³¨æ„ä¸€ä¸‹è¿™å‡ ç§å±æ€§ä¸Šçš„æ³¨é‡Š Call {@link ViewGroup#setLayoutParams(LayoutParams)} after reassigning a new value LayoutParamsä¸Viewå¦‚ä½•å»ºç«‹è”ç³» åœ¨XMLä¸­å®šä¹‰View åœ¨Javaä»£ç ä¸­ç›´æ¥ç”ŸæˆViewå¯¹åº”çš„å®ä¾‹å¯¹è±¡ addView12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394/** * é‡è½½æ–¹æ³•1ï¼šæ·»åŠ ä¸€ä¸ªå­View * å¦‚æœè¿™ä¸ªå­Viewè¿˜æ²¡æœ‰LayoutParamsï¼Œå°±ä¸ºå­Viewè®¾ç½®å½“å‰ViewGroupé»˜è®¤çš„LayoutParams */public void addView(View child) { addView(child, -1);}/** * é‡è½½æ–¹æ³•2ï¼šåœ¨æŒ‡å®šä½ç½®æ·»åŠ ä¸€ä¸ªå­View * å¦‚æœè¿™ä¸ªå­Viewè¿˜æ²¡æœ‰LayoutParamsï¼Œå°±ä¸ºå­Viewè®¾ç½®å½“å‰ViewGroupé»˜è®¤çš„LayoutParams * @param index Viewå°†åœ¨ViewGroupä¸­è¢«æ·»åŠ çš„ä½ç½®ï¼ˆ-1ä»£è¡¨æ·»åŠ åˆ°æœ«å°¾ï¼‰ */public void addView(View child, int index) { if (child == null) { throw new IllegalArgumentException(&quot;Cannot add a null child view to a ViewGroup&quot;); } LayoutParams params = child.getLayoutParams(); if (params == null) { params = generateDefaultLayoutParams();// ç”Ÿæˆå½“å‰ViewGroupé»˜è®¤çš„LayoutParams if (params == null) { throw new IllegalArgumentException(&quot;generateDefaultLayoutParams() cannot return null&quot;); } } addView(child, index, params);}/** * é‡è½½æ–¹æ³•3ï¼šæ·»åŠ ä¸€ä¸ªå­View * ä½¿ç”¨å½“å‰ViewGroupé»˜è®¤çš„LayoutParamsï¼Œå¹¶ä»¥ä¼ å…¥å‚æ•°ä½œä¸ºLayoutParamsçš„widthå’Œheight */public void addView(View child, int width, int height) { final LayoutParams params = generateDefaultLayoutParams(); // ç”Ÿæˆå½“å‰ViewGroupé»˜è®¤çš„LayoutParams params.width = width; params.height = height; addView(child, -1, params);}/** * é‡è½½æ–¹æ³•4ï¼šæ·»åŠ ä¸€ä¸ªå­Viewï¼Œå¹¶ä½¿ç”¨ä¼ å…¥çš„LayoutParams */@Overridepublic void addView(View child, LayoutParams params) { addView(child, -1, params);}/** * é‡è½½æ–¹æ³•4ï¼šåœ¨æŒ‡å®šä½ç½®æ·»åŠ ä¸€ä¸ªå­Viewï¼Œå¹¶ä½¿ç”¨ä¼ å…¥çš„LayoutParams */public void addView(View child, int index, LayoutParams params) { if (child == null) { throw new IllegalArgumentException(&quot;Cannot add a null child view to a ViewGroup&quot;); } // addViewInner() will call child.requestLayout() when setting the new LayoutParams // therefore, we call requestLayout() on ourselves before, so that the child's request // will be blocked at our level requestLayout(); invalidate(true); addViewInner(child, index, params, false);}private void addViewInner(View child, int index, LayoutParams params, boolean preventRequestLayout) { ..... if (mTransition != null) { mTransition.addChild(this, child); } if (!checkLayoutParams(params)) { // â‘  æ£€æŸ¥ä¼ å…¥çš„LayoutParamsæ˜¯å¦åˆæ³• params = generateLayoutParams(params); // å¦‚æœä¼ å…¥çš„LayoutParamsä¸åˆæ³•ï¼Œå°†è¿›è¡Œè½¬åŒ–æ“ä½œ } if (preventRequestLayout) { // â‘¡ æ˜¯å¦éœ€è¦é˜»æ­¢é‡æ–°æ‰§è¡Œå¸ƒå±€æµç¨‹ child.mLayoutParams = params; // è¿™ä¸ä¼šå¼•èµ·å­Viewé‡æ–°å¸ƒå±€ï¼ˆonMeasure-&gt;onLayout-&gt;onDrawï¼‰ } else { child.setLayoutParams(params); // è¿™ä¼šå¼•èµ·å­Viewé‡æ–°å¸ƒå±€ï¼ˆonMeasure-&gt;onLayout-&gt;onDrawï¼‰ } if (index &lt; 0) { index = mChildrenCount; } addInArray(child, index); // tell our children if (preventRequestLayout) { child.assignParent(this); } else { child.mParent = this; } .....} è‡ªå®šä¹‰LayoutParams åˆ›å»ºè‡ªå®šä¹‰å±æ€§ 12345678&lt;resources&gt; &lt;declare-styleable name=&quot;xxxViewGroup_Layout&quot;&gt; &lt;!-- è‡ªå®šä¹‰çš„å±æ€§ --&gt; &lt;attr name=&quot;layout_simple_attr&quot; format=&quot;integer&quot;/&gt; &lt;!-- ä½¿ç”¨ç³»ç»Ÿé¢„ç½®çš„å±æ€§ --&gt; &lt;attr name=&quot;android:layout_gravity&quot;/&gt; &lt;/declare-styleable&gt;&lt;/resources&gt; ç»§æ‰¿MarginLayout 1234567891011121314151617181920212223242526public static class LayoutParams extends ViewGroup.MarginLayoutParams { public int simpleAttr; public int gravity; public LayoutParams(Context c, AttributeSet attrs) { super(c, attrs); // è§£æå¸ƒå±€å±æ€§ TypedArray typedArray = c.obtainStyledAttributes(attrs, R.styleable.SimpleViewGroup_Layout); simpleAttr = typedArray.getInteger(R.styleable.SimpleViewGroup_Layout_layout_simple_attr, 0); gravity=typedArray.getInteger(R.styleable.SimpleViewGroup_Layout_android_layout_gravity, -1); typedArray.recycle();//é‡Šæ”¾èµ„æº } public LayoutParams(int width, int height) { super(width, height); } public LayoutParams(MarginLayoutParams source) { super(source); } public LayoutParams(ViewGroup.LayoutParams source) { super(source); }} é‡å†™ViewGroupä¸­å‡ ä¸ªä¸LayoutParamsç›¸å…³çš„æ–¹æ³• 1234567891011121314151617181920212223// æ£€æŸ¥LayoutParamsæ˜¯å¦åˆæ³•@Overrideprotected boolean checkLayoutParams(ViewGroup.LayoutParams p) { return p instanceof SimpleViewGroup.LayoutParams;}// ç”Ÿæˆé»˜è®¤çš„LayoutParams@Overrideprotected ViewGroup.LayoutParams generateDefaultLayoutParams() { return new SimpleViewGroup.LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.WRAP_CONTENT);}// å¯¹ä¼ å…¥çš„LayoutParamsè¿›è¡Œè½¬åŒ–@Overrideprotected ViewGroup.LayoutParams generateLayoutParams(ViewGroup.LayoutParams p) { return new SimpleViewGroup.LayoutParams(p);}// å¯¹ä¼ å…¥çš„LayoutParamsè¿›è¡Œè½¬åŒ–@Overridepublic ViewGroup.LayoutParams generateLayoutParams(AttributeSet attrs) { return new SimpleViewGroup.LayoutParams(getContext(), attrs);} LayoutParamså¸¸è§çš„å­ç±»åœ¨ä¸ºViewè®¾ç½®LayoutParamsçš„æ—¶å€™éœ€è¦æ ¹æ®å®ƒçš„çˆ¶å®¹å™¨é€‰æ‹©å¯¹åº”çš„LayoutParamsï¼Œå¦åˆ™ç»“æœå¯èƒ½ä¸é¢„æœŸä¸ä¸€è‡´ï¼Œè¿™é‡Œç®€å•ç½—åˆ—ä¸€äº›å¸¸è§çš„LayoutParamså­ç±»ï¼š ViewGroup.MarginLayoutParams FrameLayout.LayoutParams LinearLayout.LayoutParams RelativeLayout.LayoutParams RecyclerView.LayoutParams GridLayoutManager.LayoutParams StaggeredGridLayoutManager.LayoutParams ViewPager.LayoutParams WindowManager.LayoutParams MeasureSpecå®šä¹‰æµ‹é‡è§„æ ¼,å°è£…äº†çˆ¶å®¹å™¨å¯¹ view çš„å¸ƒå±€ä¸Šçš„é™åˆ¶ï¼Œå†…éƒ¨æä¾›äº†å®½é«˜çš„ä¿¡æ¯ï¼ˆ SpecMode ã€ SpecSize ï¼‰ï¼ŒSpecSizeæ˜¯æŒ‡åœ¨æŸç§SpecModeä¸‹çš„å‚è€ƒå°ºå¯¸ï¼Œå…¶ä¸­SpecMode æœ‰å¦‚ä¸‹ä¸‰ç§ï¼š UNSPECIFIEDçˆ¶æ§ä»¶ä¸å¯¹ä½ æœ‰ä»»ä½•é™åˆ¶ï¼Œä½ æƒ³è¦å¤šå¤§ç»™ä½ å¤šå¤§ï¼Œæƒ³ä¸Šå¤©å°±ä¸Šå¤©ã€‚è¿™ç§æƒ…å†µä¸€èˆ¬ç”¨äºç³»ç»Ÿå†…éƒ¨ï¼Œè¡¨ç¤ºä¸€ç§æµ‹é‡çŠ¶æ€ã€‚ï¼ˆè¿™ä¸ªæ¨¡å¼ä¸»è¦ç”¨äºç³»ç»Ÿå†…éƒ¨å¤šæ¬¡Measureçš„æƒ…å½¢ï¼Œå¹¶ä¸æ˜¯çœŸçš„è¯´ä½ æƒ³è¦å¤šå¤§æœ€åå°±çœŸæœ‰å¤šå¤§ï¼‰ EXACTLYçˆ¶æ§ä»¶å·²ç»çŸ¥é“ä½ æ‰€éœ€çš„ç²¾ç¡®å¤§å°ï¼Œä½ çš„æœ€ç»ˆå¤§å°åº”è¯¥å°±æ˜¯è¿™ä¹ˆå¤§ã€‚ AT_MOSTä½ çš„å¤§å°ä¸èƒ½å¤§äºçˆ¶æ§ä»¶ç»™ä½ æŒ‡å®šçš„sizeï¼Œä½†å…·ä½“æ˜¯å¤šå°‘ï¼Œå¾—çœ‹ä½ è‡ªå·±çš„å®ç°ã€‚ MeasureSpecs çš„æ„ä¹‰é€šè¿‡å°† SpecMode å’Œ SpecSize æ‰“åŒ…æˆä¸€ä¸ª int å€¼å¯ä»¥é¿å…è¿‡å¤šçš„å¯¹è±¡å†…å­˜åˆ†é…ï¼Œä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œå…¶æä¾›äº†æ‰“åŒ… / è§£åŒ…æ–¹æ³• MeasureSpecå€¼çš„ç¡®å®šMeasureSpecå€¼åˆ°åº•æ˜¯å¦‚ä½•è®¡ç®—å¾—æ¥çš„å‘¢?å­Viewçš„MeasureSpecå€¼æ˜¯æ ¹æ®å­Viewçš„å¸ƒå±€å‚æ•°ï¼ˆLayoutParamsï¼‰å’Œçˆ¶å®¹å™¨çš„MeasureSpecå€¼è®¡ç®—å¾—æ¥çš„ï¼Œå…·ä½“è®¡ç®—é€»è¾‘å°è£…åœ¨getChildMeasureSpec()é‡Œ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586/** * * ç›®æ ‡æ˜¯å°†çˆ¶æ§ä»¶çš„æµ‹é‡è§„æ ¼å’Œchild viewçš„å¸ƒå±€å‚æ•°LayoutParamsç›¸ç»“åˆï¼Œå¾—åˆ°ä¸€ä¸ª * æœ€å¯èƒ½ç¬¦åˆæ¡ä»¶çš„child viewçš„æµ‹é‡è§„æ ¼ã€‚ * @param spec çˆ¶æ§ä»¶çš„æµ‹é‡è§„æ ¼ * @param padding çˆ¶æ§ä»¶é‡Œå·²ç»å ç”¨çš„å¤§å° * @param childDimension child viewå¸ƒå±€LayoutParamsé‡Œçš„å°ºå¯¸ * @return child view çš„æµ‹é‡è§„æ ¼ */ public static int getChildMeasureSpec(int spec, int padding, int childDimension) { int specMode = MeasureSpec.getMode(spec); //çˆ¶æ§ä»¶çš„æµ‹é‡æ¨¡å¼ int specSize = MeasureSpec.getSize(spec); //çˆ¶æ§ä»¶çš„æµ‹é‡å¤§å° int size = Math.max(0, specSize - padding); int resultSize = 0; int resultMode = 0; switch (specMode) { // å½“çˆ¶æ§ä»¶çš„æµ‹é‡æ¨¡å¼ æ˜¯ ç²¾ç¡®æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æœ‰ç²¾ç¡®çš„å°ºå¯¸äº† case MeasureSpec.EXACTLY: //å¦‚æœchildçš„å¸ƒå±€å‚æ•°æœ‰å›ºå®šå€¼ï¼Œæ¯”å¦‚&quot;layout_width&quot; = &quot;100dp&quot; //é‚£ä¹ˆæ˜¾ç„¶childçš„æµ‹é‡è§„æ ¼ä¹Ÿå¯ä»¥ç¡®å®šä¸‹æ¥äº†ï¼Œæµ‹é‡å¤§å°å°±æ˜¯100dpï¼Œæµ‹é‡æ¨¡å¼ä¹Ÿæ˜¯EXACTLY if (childDimension &gt;= 0) { resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } //å¦‚æœchildçš„å¸ƒå±€å‚æ•°æ˜¯&quot;match_parent&quot;ï¼Œä¹Ÿå°±æ˜¯æƒ³è¦å æ»¡çˆ¶æ§ä»¶ //è€Œæ­¤æ—¶çˆ¶æ§ä»¶æ˜¯ç²¾ç¡®æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯èƒ½ç¡®å®šè‡ªå·±çš„å°ºå¯¸äº†ï¼Œé‚£childä¹Ÿèƒ½ç¡®å®šè‡ªå·±å¤§å°äº† else if (childDimension == LayoutParams.MATCH_PARENT) { resultSize = size; resultMode = MeasureSpec.EXACTLY; } //å¦‚æœchildçš„å¸ƒå±€å‚æ•°æ˜¯&quot;wrap_content&quot;ï¼Œä¹Ÿå°±æ˜¯æƒ³è¦æ ¹æ®è‡ªå·±çš„é€»è¾‘å†³å®šè‡ªå·±å¤§å°ï¼Œ //æ¯”å¦‚TextViewæ ¹æ®è®¾ç½®çš„å­—ç¬¦ä¸²å¤§å°æ¥å†³å®šè‡ªå·±çš„å¤§å° //é‚£å°±è‡ªå·±å†³å®šå‘—ï¼Œä¸è¿‡ä½ çš„å¤§å°è‚¯å®šä¸èƒ½å¤§äºçˆ¶æ§ä»¶çš„å¤§å°å˜› //æ‰€ä»¥æµ‹é‡æ¨¡å¼å°±æ˜¯AT_MOSTï¼Œæµ‹é‡å¤§å°å°±æ˜¯çˆ¶æ§ä»¶çš„size else if (childDimension == LayoutParams.WRAP_CONTENT) { resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // å½“çˆ¶æ§ä»¶çš„æµ‹é‡æ¨¡å¼ æ˜¯ æœ€å¤§æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è¯´çˆ¶æ§ä»¶è‡ªå·±è¿˜ä¸çŸ¥é“è‡ªå·±çš„å°ºå¯¸ï¼Œä½†æ˜¯å¤§å°ä¸èƒ½è¶…è¿‡size case MeasureSpec.AT_MOST: //åŒæ ·çš„ï¼Œæ—¢ç„¶childèƒ½ç¡®å®šè‡ªå·±å¤§å°ï¼Œå°½ç®¡çˆ¶æ§ä»¶è‡ªå·±è¿˜ä¸çŸ¥é“è‡ªå·±å¤§å°ï¼Œä¹Ÿä¼˜å…ˆæ»¡è¶³å­©å­çš„éœ€æ±‚ if (childDimension &gt;= 0) { resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } //childæƒ³è¦å’Œçˆ¶æ§ä»¶ä¸€æ ·å¤§ï¼Œä½†çˆ¶æ§ä»¶è‡ªå·±ä¹Ÿä¸ç¡®å®šè‡ªå·±å¤§å°ï¼Œæ‰€ä»¥childä¹Ÿæ— æ³•ç¡®å®šè‡ªå·±å¤§å° //ä½†åŒæ ·çš„ï¼Œchildçš„å°ºå¯¸ä¸Šé™ä¹Ÿæ˜¯çˆ¶æ§ä»¶çš„å°ºå¯¸ä¸Šé™size else if (childDimension == LayoutParams.MATCH_PARENT) { resultSize = size; resultMode = MeasureSpec.AT_MOST; } //childæƒ³è¦æ ¹æ®è‡ªå·±é€»è¾‘å†³å®šå¤§å°ï¼Œé‚£å°±è‡ªå·±å†³å®šå‘— else if (childDimension == LayoutParams.WRAP_CONTENT) { resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // Parent asked to see how big we want to be case MeasureSpec.UNSPECIFIED: if (childDimension &gt;= 0) { // Child wants a specific size... let him have it resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // Child wants to be our size... find out how big it should // be resultSize = 0; resultMode = MeasureSpec.UNSPECIFIED; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // Child wants to determine its own size.... find out how // big it should be resultSize = 0; resultMode = MeasureSpec.UNSPECIFIED; } break; } return MeasureSpec.makeMeasureSpec(resultSize, resultMode); } é’ˆå¯¹ä¸Šè¡¨ï¼Œè¿™é‡Œå†åšä¸€ä¸‹å…·ä½“çš„è¯´æ˜ å¯¹äºåº”ç”¨å±‚ View ï¼Œå…¶ MeasureSpec ç”±çˆ¶å®¹å™¨çš„ MeasureSpec å’Œè‡ªèº«çš„ LayoutParams æ¥å…±åŒå†³å®š å¯¹äºä¸åŒçš„çˆ¶å®¹å™¨å’Œviewæœ¬èº«ä¸åŒçš„LayoutParamsï¼Œviewå°±å¯ä»¥æœ‰å¤šç§MeasureSpecã€‚1. å½“viewé‡‡ç”¨å›ºå®šå®½é«˜çš„æ—¶å€™ï¼Œä¸ç®¡çˆ¶å®¹å™¨çš„MeasureSpecæ˜¯ä»€ä¹ˆï¼Œviewçš„MeasureSpecéƒ½æ˜¯ç²¾ç¡®æ¨¡å¼å¹¶ä¸”å…¶å¤§å°éµå¾ªLayoutparamsä¸­çš„å¤§å°ï¼› 2. å½“viewçš„å®½é«˜æ˜¯match_parentæ—¶ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœçˆ¶å®¹å™¨çš„æ¨¡å¼æ˜¯ç²¾å‡†æ¨¡å¼ï¼Œé‚£ä¹ˆviewä¹Ÿæ˜¯ç²¾å‡†æ¨¡å¼å¹¶ä¸”å…¶å¤§å°æ˜¯çˆ¶å®¹å™¨çš„å‰©ä½™ç©ºé—´ï¼Œå¦‚æœçˆ¶å®¹å™¨æ˜¯æœ€å¤§æ¨¡å¼ï¼Œé‚£ä¹ˆviewä¹Ÿæ˜¯æœ€å¤§æ¨¡å¼å¹¶ä¸”å…¶å¤§å°ä¸ä¼šè¶…è¿‡çˆ¶å®¹å™¨çš„å‰©ä½™ç©ºé—´ï¼› 3. å½“viewçš„å®½é«˜æ˜¯wrap_contentæ—¶ï¼Œä¸ç®¡çˆ¶å®¹å™¨çš„æ¨¡å¼æ˜¯ç²¾å‡†è¿˜æ˜¯æœ€å¤§åŒ–ï¼Œviewçš„æ¨¡å¼æ€»æ˜¯æœ€å¤§åŒ–å¹¶ä¸”å¤§å°ä¸èƒ½è¶…è¿‡çˆ¶å®¹å™¨çš„å‰©ä½™ç©ºé—´ã€‚ 4. Unspecifiedæ¨¡å¼ï¼Œè¿™ä¸ªæ¨¡å¼ä¸»è¦ç”¨äºç³»ç»Ÿå†…éƒ¨å¤šæ¬¡measureçš„æƒ…å†µä¸‹ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³æ³¨æ­¤æ¨¡å¼(è¿™é‡Œæ³¨æ„è‡ªå®šä¹‰Viewæ”¾åˆ°ScrollViewçš„æƒ…å†µ éœ€è¦å¤„ç†)ã€‚","link":"/2021/06/15/view/"},{"title":"æ³›å‹","text":"é—®é¢˜ 123456781ã€ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æ³›å‹ï¼Ÿ2ã€æ³›å‹ç±»ã€æ³›å‹æ¥å£å’Œæ³›å‹æ–¹æ³•3ã€å¦‚ä½•é™å®šç±»å‹å˜é‡ï¼Ÿ4ã€æ³›å‹ä½¿ç”¨ä¸­çš„çº¦æŸå’Œå±€é™æ€§5ã€æ³›å‹ç±»å‹èƒ½ç»§æ‰¿å—ï¼Ÿ6ã€æ³›å‹ä¸­é€šé…ç¬¦ç±»å‹7ã€è™šæ‹Ÿæœºæ˜¯å¦‚ä½•å®ç°æ³›å‹çš„ï¼Ÿ8ã€åå°„è·å–æ³›å‹çš„çœŸå®ç±»å‹ 1ã€ä¸ºä»€ä¹ˆéœ€è¦æ³›å‹ï¼Ÿ å¤šç§æ•°æ®ç±»å‹æ‰§è¡Œç›¸åŒçš„ä»£ç ï¼ˆå¢åŠ ä»£ç å¤ç”¨æ€§ï¼‰ åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ›´å¼ºçš„ç±»å‹æ£€æŸ¥ã€‚ ä½¿ç”¨æ³›å‹ä¸éœ€è¦å¼ºåˆ¶è½¬æ¢ç±»å‹ 2ã€æ³›å‹ç±»ã€æ³›å‹æ¥å£å’Œæ³›å‹æ–¹æ³•123456789101112131415161718192021222324252627282930313233--æ³›å‹ç±»public class Genericity&lt;T&gt; { private T data; public void setData(T data) { this.data = data; } public T getData() { return data; } --æ³›å‹æ–¹æ³• public &lt;T&gt; T getInput(T input){ return input; } --æ³›å‹æ–¹æ³•2 public &lt;E&gt; E getInput2(E input){ return input; } public static void main(String[] args) { //æ³›å‹ç±» Genericity&lt;String&gt; genericity=new Genericity&lt;&gt;(); genericity.setData(&quot;æ³›å‹&quot;); Genericity&lt;Integer&gt; genericityInteger=new Genericity&lt;&gt;(); genericityInteger.setData(1); //æ³›å‹æ–¹æ³• Genericity genericityMethod=new Genericity(); genericityMethod.getInput(&quot;11&quot;); genericityMethod.getInput(11); genericityMethod.getInput(1f); }} 123456789101112131415161718--æ³›å‹æ¥å£public interface Genertor&lt;T&gt; { public T next();}--å®ç°1ã€ä¸ä¼ å…¥å…·ä½“ç±»å‹ï¼Œè¿”å›å€¼ä¸ºTpublic class GenertorImpl&lt;T&gt; implements Genertor&lt;T&gt; { @Override public T next() { return null; }}--å®ç°2ã€ä¼ å…¥å…·ä½“ç±»å‹Stringï¼Œè¿”å›å€¼ä¸ºStringpublic class GenertorImpl2 implements Genertor&lt;String&gt; { @Override public String next() { return null; }} æ³›å‹ç±»åªå½±å“å®ƒçš„æ™®é€šæ–¹æ³• æ³›å‹ç±»çš„Tå’Œæ³›å‹æ–¹æ³•çš„Tæ¯«æ— å…³ç³»ï¼Œæ¢æˆå…¶ä»–ä¹Ÿä¸€æ ·ï¼Œä¾‹å¦‚Eï¼Œä½†æ˜¯æ–¹æ³•åä¸èƒ½ä¸€æ ·ï¼Œå› ä¸ºæ³›å‹åœ¨Javaç¼–è¯‘æ—¶æ˜¯Object æ³›å‹æ¥å£å®ç°æ—¶ï¼Œä¸ä¼ å…¥å…·ä½“ç±»å‹ä¼ å…¥Tæ—¶ï¼Œæ¥å£çš„æ–¹æ³•è¿”å›çš„ä¹Ÿæ˜¯Tã€‚å½“ä¼ å…¥å…·ä½“ç±»å‹æ—¶ï¼Œæ¥å£çš„æ–¹æ³•è¿”å›çš„ä¹Ÿæ˜¯å…·ä½“çš„ç±»å‹ã€‚ æ³›å‹æ–¹æ³•åªæœ‰æ–¹æ³•å‰é¢æœ‰çš„æ‰æ˜¯æ³›å‹æ–¹æ³• 3ã€å¦‚ä½•é™å®šç±»å‹å˜é‡ï¼Ÿ é™å®šç±»å‹æ˜¯å†™åœ¨ç±»ä¸Šçš„ 12345678public class GenertorClass&lt;T extends Comparable&gt; { public static void main(String[] args) { GenertorClass&lt;String&gt; genertorClass = new GenertorClass&lt;&gt;(); GenertorClass&lt;Object&gt; genertorClass2 = new GenertorClass&lt;&gt;(); //ä¼ å…¥Stringæ˜¯æ­£å¸¸çš„ï¼Œä¼ å…¥Objectæ—¶æŠ¥é”™ï¼š //Type parameter 'java.lang.Object' is not within its bound; should implement 'java.lang.Comparable' }} ä¸Šé¢ä»£ç ä¼ å…¥Stringæ—¶æ˜¯æ­£å¸¸çš„ï¼Œä¼ å…¥Objectæ—¶æŠ¥é”™ï¼šType parameter 'java.lang.Object' is not within its bound; should implement 'java.lang.Comparable' å› ä¸ºStringç»§æ‰¿äº† Comparableæ¥å£ï¼Œè€ŒObjectæ²¡æœ‰ç»§æ‰¿è¯¥æ¥å£ é™å®šç±»å‹å†™åœ¨æ–¹æ³•ä¸Š 12345678910public class GenertorClass&lt;T extends Comparable&gt; { public static &lt;T extends Comparable&gt; T min(T a, T b) { if (a.compareTo(b) &gt; 0) return a;else return b; } public static void main(String[] args) { GenertorClass.min(&quot;1&quot;,&quot;2&quot;); GenertorClass.min(&quot;1&quot;,new Object());//æŠ¥reason: no instance(s) of type variable(s) exist so that Object conforms to Comparable }} GenertorClass.min(â€œ1â€,â€2â€);æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºStringç»§æ‰¿äº†Comparableæ¥å£ï¼Œè€ŒObjectæ²¡æœ‰ç»§æ‰¿è¯¥æ¥å£ã€‚ å¤šä¸ªé™å®šç±»å‹ 12345678910111213--ç±»1public class Fruit {}--ç±»2public class Apple extends Fruit implements Serializable {}--ç±»3public class GenertorClass&lt;T extends Fruit &amp; Serializable&gt; { public static void main(String[] args) { GenertorClass&lt;Apple&gt; genertorClass = new GenertorClass&lt;&gt;(); GenertorClass&lt;Fruit&gt; genertorClass2 = new GenertorClass&lt;&gt;(); }} GenertorClassæ˜¯æ­£å¸¸çš„ï¼ŒGenertorClassæŠ¥é”™ï¼šType parameter 'Fruit' is not within its bound; should implement 'java.io.Serializable'ã€‚ å› ä¸ºä¸¤ä¸ªé™å®šç±»å‹éƒ½è¦å®ç°æ‰è¡Œï¼Œè€Œä¸”ç±»3ä¸­Fruit&amp;Serializableä¸¤ä¸ªä½ç½®ä¸èƒ½è°ƒæ¢ã€‚ T extends B Bå¯ä»¥æ˜¯ç±»ä¹Ÿå¯ä»¥æ˜¯æ¥å£ã€‚ æ³›å‹ç±»å’Œæ³›å‹æ–¹æ³•éƒ½å¯ä»¥ä½¿ç”¨å¤šä¸ªé™å®šç±»å‹ Bå¯ä»¥æ˜¯å¤šä¸ªå¯¹è±¡ï¼šT extends Comparable&amp;Serializableã€‚å¤šä¸ªå¯¹è±¡æ—¶ï¼Œä¼ å…¥çš„å¯¹è±¡å¿…éœ€è¦åŒæ—¶å®ç°å¤šä¸ªé™å®šç±»å‹Comparableå’ŒSerializable Bä¸ºç±»å’Œæ¥å£æ··åˆæ—¶ï¼Œç±»åªèƒ½æœ‰ä¸€ä¸ªï¼ˆjavaé‡Œå•ç»§æ‰¿ï¼Œå¤šå®ç°ï¼‰ï¼Œå¹¶ä¸”å¿…éœ€æ”¾åœ¨æœ€å‰é¢ ,å¦åˆ™ä¼šæŠ¥é”™ã€‚ 4ã€æ³›å‹ä½¿ç”¨ä¸­çš„çº¦æŸå’Œå±€é™æ€§ ä¸èƒ½å®ä¾‹åŒ–ç±»å‹å˜é‡ã€‚ 1T data = new T()//ä¸å…è®¸ é™æ€åŸŸæˆ–è€…é™æ€æ–¹æ³•é‡Œä¸èƒ½å¼•ç”¨ç±»å‹å˜é‡ã€‚ 1private static T instance;//ä¸å…è®¸ ï¼ˆå› ä¸ºåœ¨newå¯¹è±¡æ—¶ï¼Œæ‰çŸ¥é“çœŸå®çš„ç±»å‹ï¼Œè™šæ‹Ÿæœºè¿è¡Œæ—¶ï¼Œå…ˆæ‰§è¡Œstaticå¯¹è±¡ã€æ–¹æ³•ï¼Œå†æ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥é™æ€ä¸­ä½¿ç”¨æ³›å‹ï¼Œè™šæ‹Ÿæœºæ˜¯ä¸çŸ¥é“æ³›å‹ç±»å‹çš„ï¼‰ é™æ€æ–¹æ³•æœ¬èº«æ˜¯æ³›å‹æ–¹æ³•æ˜¯å¯è¡Œçš„ã€‚ 1priavte static &lt;T&gt; T getInstance(){}//å…è®¸ åŸºæœ¬ç±»å‹æ˜¯ä¸è¡Œçš„ã€‚ 1&lt;int&gt;,&lt;double&gt;//ä¸å…è®¸ int,double(ä¸æ˜¯å¯¹è±¡)ï¼Œåªå…è®¸å…¶åŒ…è£…ç±»Integerï¼ŒDouble ä¸èƒ½ä½¿ç”¨instanceofå…³é”®å­—åˆ¤æ–­å˜é‡ç±»å‹ã€‚ 12Test&lt;Double&gt; test=new Test&lt;&gt;();if(test instanceof Test&lt;Double&gt;){}//ä¸å…è®¸ ç¼–è¯‘æ—¶çš„ç±»å‹æ“¦é™¤ æ³›å‹èƒ½å®šä¹‰æ•°æ®ï¼Œä½†ä¸èƒ½åˆ›å»ºæ•°ç»„ï¼ˆnew å¯¹è±¡ï¼‰ 12private T[] list;//å…è®¸private T[] list2=new T[2];//ä¸å…è®¸ æ³›å‹ç±»è·å–çš„ä¸€å®šæ˜¯ç±»çš„åŸç”Ÿç±»å‹ 123456789Test&lt;Integer&gt; test1 = new Test&lt;&gt;();Test&lt;String&gt; test2 = new Test&lt;&gt;();System.out.println(test1.getClass()==test2.getClass());System.out.println(test1.getClass().getName());System.out.println(test2.getClass().getName());out:========================================truecom.example.annotation.Testcom.example.annotation.Test è¿™é‡Œçš„åŸç”Ÿç±»å‹æ˜¯Testï¼Œå’Œä¼ çš„å‚æ•°æ— å…³ æ³›å‹ç±»ä¸èƒ½ç»§æ‰¿Exception 12class Problem&lt;T&gt; extends Exception{}//ä¸å…è®¸//æŠ¥é”™ï¼šGeneric class may not extend 'java.lang.Throwable' ä¸èƒ½æ•è·æ³›å‹ç±»å¯¹è±¡ 12345678public &lt;T extends Throwable&gt; void doWork(T t) throws T { try { // do... } catch (T e) { //æŠ¥é”™ //do something throw t; }} ä¸èƒ½æ•è·ï¼Œä½†æ˜¯å¯ä»¥æŠ›å‡º 1234567public &lt;T extends Throwable&gt; void doWork2(T x) throws T { try { //do... } catch (Throwable e) { throw x; //å…è®¸çš„ }} 5ã€æ³›å‹ç±»å‹èƒ½ç»§æ‰¿å—ï¼Ÿ 12345678//ç±» Worker extents Employeeç±»public class Employee {}public class Worker extends Employee {}//æ³›å‹ç±»Pairpublic class Pair&lt;T&gt; {} Pairå’ŒPair æ²¡æœ‰ä»»ä½•ç»§æ‰¿å…³ç³» 1Pair&lt;Employee&gt; employeePair= new Pair&lt;Worker&gt;();//ä¸å…è®¸ï¼Œé”™è¯¯çš„ 1234567891011121314public class Pair&lt;T&gt; { private T data; public T getData() { return data; } public void setData(T data) { this.data = data; } }public class ExtendPair&lt;T&gt; extends Pair&lt;T&gt;{} æ³›å‹ç±»å¯ä»¥ç»§æ‰¿æˆ–è€…æ‰©å±•å…¶ä»–æ³›å‹ç±» //æ¯”å¦‚Listå’ŒArrayList 1Pair&lt;Employee&gt; employee = new ExtendPair&lt;&gt;; //å…è®¸çš„ 6ã€æ³›å‹ä¸­é€šé…ç¬¦ç±»å‹ï¼ˆ?åªèƒ½ç”¨åœ¨æ–¹æ³•ä¸Šï¼‰é€šé…ç¬¦ä¸»è¦ç”¨äºå®‰å…¨çš„è®¿é—®æ•°æ® 12345678910public class Food {}public class Fruit extends Food{}public class Apple extends Fruit{}public class Orange extends Fruit{}public class HongFuShi extends Apple{} è¡¨ç¤ºPairä¼ è¿›å»çš„ç±»å‹å‚æ•°æ˜¯Fruitçš„å­ç±»åŒ…æ‹¬Fruitæœ¬èº«ï¼ˆFruit,Apple,Orange,HongFuShiï¼‰ extendså†³å®šäº†ç±»å‹å‚æ•°çš„ä¸Šç•Œï¼šå‘ä¸‹çš„èŒƒå›´ï¼Œå³æ³›å‹å¯¹è±¡å¿…éœ€ç»§æ‰¿Fruitæˆ–Fruitæœ¬èº«â€“Foodä¸å¯ä»¥ã€‚ 1234567891011//é™å®šç±»å‹Fruitpublic static void printClassName(Pair&lt;? extends Fruit&gt; data) { System.out.println(data.getClass().getSimpleName());}Pair&lt;Fruit&gt; fruitPair = new Pair&lt;&gt;();Pair&lt;Apple&gt; applePair = new Pair&lt;&gt;();Pair&lt;Food&gt; foodPair = new Pair&lt;&gt;();Pair.printClassName(fruitPair);//å…è®¸Pair.printClassName(applePair);//å…è®¸Pair.printClassName(foodPair);//ä¸å…è®¸//é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: Pair&lt;Food&gt;æ— æ³•è½¬æ¢ä¸ºPair&lt;? extends Fruit&gt; 1234567//é™å®šç±»å‹å˜é‡èµ‹å€¼æ—¶ï¼Œä¹Ÿæ˜¯åªèƒ½ä½¿ç”¨ä¼ å…¥Fruitå­ç±»æˆ–è€…æœ¬èº«çš„å¯¹è±¡Pair&lt;Fruit&gt; fruitPair = new Pair&lt;&gt;();Pair&lt;Apple&gt; applePair = new Pair&lt;&gt;();Pair&lt;Food&gt; foodPair = new Pair&lt;&gt;();Pair&lt;? extends Fruit&gt; f = fruitPair;//å…è®¸Pair&lt;? extends Fruit&gt; f2 = applePair;//å…è®¸Pair&lt;? extends Fruit&gt; f3 = foodPair;//ä¸å…è®¸ ä½¿ç”¨&lt;? extends Fruit&gt;ç»™å¯¹è±¡setï¼Œgetå€¼æ—¶ï¼šsetæ˜¯ä¸å…è®¸çš„ï¼Œgetåªèƒ½getåˆ°Fruitå¯¹è±¡ï¼Œå³extendsçš„ä¸Šç•Œç±»å‹ã€‚ 123456789101112131415Pair&lt;Fruit&gt; fruitPair = new Pair&lt;&gt;();Pair&lt;Apple&gt; applePair = new Pair&lt;&gt;();Pair&lt;? extends Fruit&gt; data = fruitPair;æˆ–Pair&lt;? extends Fruit&gt; data = applePair;data.setData(new Apple());//ä¸å…è®¸data.setData(new Fruit());//ä¸å…è®¸//é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: Fruitæ— æ³•è½¬æ¢ä¸ºCAP#1// data.setData(new Fruit());// ^// å…¶ä¸­, CAP#1æ˜¯æ–°ç±»å‹å˜é‡:// CAP#1ä»? extends Fruitçš„æ•è·æ‰©å±•FruitFruit fruit = data.getData();//å…è®¸ï¼Œè·å–åˆ°Fruitå¯¹è±¡Apple apple = (Apple) data.getData();//éœ€è¦è½¬å‹ï¼Œå¦‚æœç±»å‹ä¸æ­£ç¡®ä¼šæŠ¥ClassCastExceptionå¼ºè½¬å¼‚å¸¸ getæ–¹æ³•ï¼šä¸ç®¡æˆ‘ä»¬ä¼ çš„æ˜¯Fruitè¿˜æ˜¯å®ƒçš„å­ç±»ï¼Œå¯¹äºç¼–è¯‘å™¨æ¥è¯´æˆ‘ä»¬ä¼ çš„ä¸€å®šæ˜¯ä¸ªFruitï¼Œæ‰€ä»¥è·å–åˆ°çš„å¯¹è±¡ä¸€å®šæ˜¯ä¸ªFruitï¼ˆå­ç±»ç»§æ‰¿Fruitï¼‰ã€‚ setæ–¹æ³•ï¼šå¯¹äºç¼–è¯‘å™¨æ¥è¯´ä½ ä¼ çš„æ˜¯ä¸ªFruit,ä½†æ˜¯æ˜¯å…·ä½“çš„å“ªä¸€ä¸ªå­ç±»ï¼Œç¼–è¯‘å™¨æ˜¯ä¸çŸ¥é“çš„ã€‚ &lt;? extends Fruit&gt;ä¸»è¦ç”¨äºå®‰å…¨çš„è®¿é—®æ•°æ®â€“è¯»æ•°æ® è¡¨ç¤ºPairä¼ è¿›å»çš„ç±»å‹å‚æ•°æ˜¯Appleçš„çˆ¶ç±»åŒ…æ‹¬Appleæœ¬èº«ã€‚(Apple,Fruit,Food) super å†³å®šäº†ç±»å‹å‚æ•°çš„ä¸‹ç•Œï¼šå‘ä¸Šçš„èŒƒå›´ï¼Œå³æ³›å‹å¯¹è±¡æ˜¯Appleçš„è¶…ç±»æˆ–Appleæœ¬èº«â€“HongFuShiä¸å¯ä»¥ã€‚ 12345678910111213141516171819202122232425262728293031323334public static void printSuper(Pair&lt;? super Apple&gt; data){ System.out.println(data.getClass().getSimpleName());}Pair&lt;Fruit&gt; fruitPair = new Pair&lt;&gt;();Pair&lt;Apple&gt; applePair = new Pair&lt;&gt;();Pair&lt;Orange&gt; orangePair = new Pair&lt;&gt;();Pair&lt;HongFuShi&gt; hongFuShiPair = new Pair&lt;&gt;();printSuper(fruitPair);//å…è®¸printSuper(applePair);//å…è®¸printSuper(orangePair);//ä¸å…è®¸ï¼Œå¹³çº§ç±»printSuper(hongFuShiPair);//ä¸å…è®¸//é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: Pair&lt;HongFuShi&gt;æ— æ³•è½¬æ¢ä¸ºPair&lt;? super Apple&gt;// printSuper(hongFuShiPair);Pair&lt;? super Apple&gt; data = fruitPair; //å…è®¸Pair&lt;? super Apple&gt; data = applePair; //å…è®¸Pair&lt;? super Apple&gt; data = hongFuShiPair; //ä¸å…è®¸//é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: Pair&lt;HongFuShi&gt;æ— æ³•è½¬æ¢ä¸ºPair&lt;? super Apple&gt;// Pair&lt;? super Apple&gt; data = hongFuShiPair;// ^ä½†æ˜¯åœ¨è®¾å€¼çš„æ—¶å€™åªèƒ½è®¾ç½®Appleçš„å­ç±»å’Œå®ƒæœ¬èº«data.setData(new Apple()); //å…è®¸data.setData(new HongFuShi()); //å…è®¸data.setData(new Fruit()); //ä¸å…è®¸//é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: Fruitæ— æ³•è½¬æ¢ä¸ºCAP#1// data.setData(new Fruit());// ^// å…¶ä¸­, CAP#1æ˜¯æ–°ç±»å‹å˜é‡:// CAP#1ä»? super Appleçš„æ•è·æ‰©å±•Object è¶… Appleè·å–æ•°æ®æ—¶è·å–åˆ°çš„æ˜¯Objectå¯¹è±¡Object object = data.getData(); setæ–¹æ³•ï¼šåªèƒ½ä¼ Appleå’Œå…¶å­ç±»ï¼Œï¼ˆå› ä¸ºå­ç±»åŒ…å«äº†Appleæˆ–è€…HongFuShiï¼Œå­ç±»å¯ä»¥å®‰å…¨çš„è½¬æ¢ä¸º super Appleï¼‰ getæ–¹æ³•ï¼šè·å–çš„å¯¹è±¡ä¸€å®šæ˜¯Appleçš„è¶…ç±»ï¼ŒJavaä¸­Objectä¸€å®šæ˜¯Appleçš„è¶…ç±»ã€‚æ‰€ä»¥è¿”å›çš„æ˜¯Object &lt;? super Apple&gt;ä¸»è¦ç”¨äºå®‰å…¨çš„å†™å…¥æ•°æ®ï¼Œåªèƒ½æ˜¯å…¶æœ¬èº«Appleå’Œå…¶å­ç±» 7ã€è™šæ‹Ÿæœºæ˜¯å¦‚ä½•å®ç°æ³›å‹çš„ï¼Ÿæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„æ³›å‹ç±» 1234567891011public class GenertorASM&lt;E&gt; { private E data; public E getData() { return data; } public void setData(E data) { this.data = data; }} é€šè¿‡å­—èŠ‚ç æŸ¥çœ‹å·¥å…·æŸ¥çœ‹è¯¥ç±»çš„å­—èŠ‚ç  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465// class version 52.0 (52)// access flags 0x21// signature &lt;E:Ljava/lang/Object;&gt;Ljava/lang/Object;// declaration: GenertorASM&lt;E&gt;public class GenertorASM { // compiled from: GenertorASM.java // access flags 0x2 // signature TE; // declaration: data extends E private Ljava/lang/Object; data // access flags 0x1 public &lt;init&gt;()V L0 LINENUMBER 8 L0 ALOAD 0 INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V RETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature ()TE; // declaration: E getData() public getData()Ljava/lang/Object; L0 LINENUMBER 12 L0 ALOAD 0 GETFIELD GenertorASM.data : Ljava/lang/Object; ARETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature (TE;)V // declaration: void setData(E) public setData(Ljava/lang/Object;)V L0 LINENUMBER 16 L0 ALOAD 0 ALOAD 1 PUTFIELD GenertorASM.data : Ljava/lang/Object; L1 LINENUMBER 17 L1 RETURN L2 LOCALVARIABLE this LGenertorASM; L0 L2 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; LOCALVARIABLE data Ljava/lang/Object; L0 L2 1 // signature TE; // declaration: data extends E MAXSTACK = 2 MAXLOCALS = 2} æˆ–è€…ä½¿ç”¨javapå‘½ä»¤åç¼–è¯‘.classæ–‡ä»¶ 123456789101112131415161718192021222324252627282930313233343536373839javap -c -l GenertorASM.class // -cå¯¹ä»£ç è¿›è¡Œåæ±‡ç¼–,-lè¾“å‡ºè¡Œå·å’Œæœ¬åœ°å˜é‡è¡¨ public class GenertorASM&lt;E&gt; { public GenertorASM(); Code: 0: aload_0 1: invokespecial #1 // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V 4: return LineNumberTable: line 8: 0 LocalVariableTable: Start Length Slot Name Signature 0 5 0 this LGenertorASM; public E getData(); Code: 0: aload_0 1: getfield #2 // Field data:Ljava/lang/Object; 4: areturn LineNumberTable: line 12: 0 LocalVariableTable: Start Length Slot Name Signature 0 5 0 this LGenertorASM; public void setData(E); Code: 0: aload_0 1: aload_1 2: putfield #2 // Field data:Ljava/lang/Object; 5: return LineNumberTable: line 16: 0 line 17: 5 LocalVariableTable: Start Length Slot Name Signature 0 6 0 this LGenertorASM; 0 6 1 data Ljava/lang/Object;} é€šè¿‡åç¼–è¯‘åï¼Œå¯ä»¥çœ‹åˆ°æ³›å‹è¢«æ“¦é™¤äº†ï¼Œå¯¹åº”çš„æ˜¯Objectå¯¹è±¡ï¼Œä½†åœ¨çš„signatureä¸­è®°å½•äº†æ³›å‹ã€‚ æ³›å‹æ“¦é™¤çš„åŸå› ï¼š åœ¨Java1.5ä¹‹å‰ä¸å­˜åœ¨æ³›å‹çš„ï¼Œ1.5ä¹‹åæ‰æ·»åŠ çš„æ³›å‹ï¼Œä¸ºäº†å‘ä¸‹å…¼å®¹ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨äº†æ³›å‹æ“¦é™¤ç”¨Objectä»£æ›¿ã€‚ ä½¿ç”¨æ³›å‹é™å®šç¬¦æ—¶,javaç¼–è¯‘æ—¶ä¼šå°†æ³›å‹è½¬æˆé™å®šç¬¦çš„ç±» 123456789public class GenertorASM&lt;E extends Fruit&gt; { private E data; public E getData() { return data; } public void setData(E data) { this.data = data; }} å­—èŠ‚ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465// class version 52.0 (52)// access flags 0x21// signature &lt;E:LFruit;&gt;Ljava/lang/Object;// declaration: GenertorASM&lt;E extends Fruit&gt;public class GenertorASM { // compiled from: GenertorASM.java // access flags 0x2 // signature TE; // declaration: data extends E private LFruit; data // access flags 0x1 public &lt;init&gt;()V L0 LINENUMBER 8 L0 ALOAD 0 INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V RETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature ()TE; // declaration: E getData() public getData()LFruit; L0 LINENUMBER 11 L0 ALOAD 0 GETFIELD GenertorASM.data : LFruit; ARETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature (TE;)V // declaration: void setData(E) public setData(LFruit;)V L0 LINENUMBER 14 L0 ALOAD 0 ALOAD 1 PUTFIELD GenertorASM.data : LFruit; L1 LINENUMBER 15 L1 RETURN L2 LOCALVARIABLE this LGenertorASM; L0 L2 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; LOCALVARIABLE data LFruit; L0 L2 1 // signature TE; // declaration: data extends E MAXSTACK = 2 MAXLOCALS = 2} å¦‚æœé™å®šç¬¦æœ‰å¤šä¸ªæ—¶ï¼Œå­—èŠ‚ç ä¸­æ³›å‹ä½¿ç”¨ç¬¬ä¸€ä¸ªé™å®šçš„ç±»å‹ï¼Œåœ¨ä½¿ç”¨å…¶ä»–çš„ç±»å‹æ—¶ï¼Œä¼šä½¿ç”¨å¼ºè½¬æˆå¯¹åº”çš„ç±»å‹ï¼ˆæ‰€ä»¥å¤šä¸ªé™å®šç¬¦æ—¶è¦æ³¨æ„å¼ºè½¬å¼‚å¸¸ï¼‰ 123456789101112131415public class GenertorASM&lt;E extends Fruit &amp; Comparable&gt; { private E data; public E getData() { return data; } public void setData(E data) { this.data = data; } public E compare(E data1, E data2) { return data1.compareTo(data2) &gt; 0 ? data1 : data2; }} å­—èŠ‚ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798// class version 52.0 (52)// access flags 0x21// signature &lt;E:LFruit;:Ljava/lang/Comparable;&gt;Ljava/lang/Object;// declaration: GenertorASM&lt;E extends Fruit extends java.lang.Comparable&gt;public class GenertorASM { // compiled from: GenertorASM.java // access flags 0x2 // signature TE; // declaration: data extends E private LFruit; data // access flags 0x1 public &lt;init&gt;()V L0 LINENUMBER 8 L0 ALOAD 0 INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V RETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature ()TE; // declaration: E getData() public getData()LFruit; L0 LINENUMBER 12 L0 ALOAD 0 GETFIELD GenertorASM.data : LFruit; ARETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature (TE;)V // declaration: void setData(E) public setData(LFruit;)V L0 LINENUMBER 16 L0 ALOAD 0 ALOAD 1 PUTFIELD GenertorASM.data : LFruit; L1 LINENUMBER 17 L1 RETURN L2 LOCALVARIABLE this LGenertorASM; L0 L2 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; LOCALVARIABLE data LFruit; L0 L2 1 // signature TE; // declaration: data extends E MAXSTACK = 2 MAXLOCALS = 2 // access flags 0x1 // signature (TE;TE;)TE; // declaration: E compare(E, E) public compare(LFruit;LFruit;)LFruit; L0 LINENUMBER 20 L0 ALOAD 1 CHECKCAST java/lang/Comparable ALOAD 2 INVOKEINTERFACE java/lang/Comparable.compareTo (Ljava/lang/Object;)I (itf) IFLE L1 ALOAD 1 GOTO L2 L1 FRAME SAME ALOAD 2 L2 FRAME SAME1 Fruit ARETURN L3 LOCALVARIABLE this LGenertorASM; L0 L3 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; LOCALVARIABLE data1 LFruit; L0 L3 1 // signature TE; // declaration: data1 extends E LOCALVARIABLE data2 LFruit; L0 L3 2 // signature TE; // declaration: data2 extends E MAXSTACK = 2 MAXLOCALS = 3} åœ¨å­—èŠ‚ç ä¸­CHECKCAST java/lang/Comparable å°†å¯¹è±¡å¼ºè½¬æˆComparableç±»å‹ ç›¸åŒæ–¹æ³•ä½¿ç”¨æ³›å‹ï¼Œç±»å‹ä¸åŒæ—¶æŠ¥é”™-å› ä¸ºåœ¨ç¼–è¯‘æ—¶ç±»å‹æ“¦é™¤åçš„å¯¹è±¡éƒ½æ˜¯Objects 1234567 public static void method (List&lt;String&gt; list){ }//æŠ¥é”™ï¼š'method(List&lt;String&gt;)' clashes with 'method(List&lt;Integer&gt;)'; both methods have same erasure public static void method (List&lt;Integer&gt; list){ } å¦å¤–åœ¨jdkä¸­å¦‚æœè¿”å›å€¼ä¸åŒï¼ˆä¸€ä¸ªè¿”å›Stringï¼Œä¸€ä¸ªè¿”å›Integerï¼‰ï¼Œç¼–è¯‘æ˜¯ä¸ä¼šæŠ¥é”™çš„ï¼Œä½†æ˜¯å¼€å‘å·¥å…·ä¸­æ˜¯æŠ¥ä¸Šé¢é”™çš„ï¼ˆideaè¿™ç§åªæ¯”è¾ƒæ–¹æ³•åå’Œå‚æ•°æ²¡æœ‰æ¯”è¾ƒè¿”å›å€¼ï¼‰ 8ã€åå°„è·å–æ³›å‹çš„çœŸå®ç±»å‹å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªæ³›å‹ç±»è¿›è¡Œåå°„æ—¶ï¼Œéœ€è¦å¾—åˆ°æ³›å‹ä¸­çš„çœŸå®æ•°æ®ç±»å‹ï¼Œä¸šå®Œæˆå¦‚jsonååºåˆ—åŒ–çš„æ“ä½œã€‚æ­¤æ—¶éœ€è¦é€šè¿‡Typeä½“ç³»æ¥å®Œæˆã€‚Typeæ¥å£åŒ…å«äº†ä¸€ä¸ªå®ç°ç±»(Class)å’Œå››ä¸ªå®ç°æ¥å£ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯ï¼š TypeVariable æ³›å‹ç±»å‹å˜é‡ã€‚å¯ä»¥è·å¾—æ³›å‹ä¸Šä¸‹é™ç­‰ä¿¡æ¯ã€‚ ParameterizedType å…·ä½“çš„æ³›å‹ç±»å‹ï¼Œå¯ä»¥è·å¾—å…ƒæ•°æ®ä¸­æ³›å‹ç­¾åç±»å‹ï¼ˆæ³›å‹çœŸå®ç±»å‹ï¼‰ã€‚ GenericArrayType å½“éœ€è¦æè¿°çš„ç±»å‹æ˜¯æ³›å‹ç±»çš„æ•°ç»„æ—¶ï¼Œæ¯”å¦‚List[],Map[]ï¼Œæ­¤æ¥å£ä¼šä½œä¸ºTypeçš„å®ç°ã€‚ WildcardType é€šé…ç¬¦æ³›å‹ï¼Œè·å¾—ä¸Šä¸‹é™ä¿¡æ¯ã€‚ Typeæ˜¯ä¸ªæ¥å£,å®ƒçš„ç›´æ¥å®ç°ç±»å°±æ˜¯Class 123456789package java.lang.reflect;/** * @since 1.5 */public interface Type { default String getTypeName() { return toString(); }} 123public final class Class&lt;T&gt; implements Type{ } æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªResponseæ³›å‹ç±» 1234567891011121314151617181920212223242526272829public class Response&lt;T&gt; { T data; int code; String message; public Response(T data, int code, String message) { this.data = data; this.code = code; this.message = message; } static class Data { String result; public Data(String result) { this.result = result; } } public static void main(String[] args) { Response&lt;Data&gt; response = new Response&lt;&gt;(new Data(&quot;æ•°æ®&quot;), 0, &quot;æˆåŠŸ&quot;); Gson gson = new Gson(); String json = gson.toJson(response); System.out.println(json); Response&lt;Data&gt; result = gson.fromJson(json,Response.class); System.out.println(result.data.getClass()); }} æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªresponseå¯¹è±¡ä¼ å…¥Dataæ•°æ®ç±»å‹ï¼Œæ‰“å°åºåˆ—åŒ–åçš„æ•°æ® {&quot;data&quot;:{&quot;result&quot;:&quot;æ•°æ®&quot;},&quot;code&quot;:0,&quot;message&quot;:&quot;æˆåŠŸ&quot;} ç„¶åæˆ‘ä»¬é€šè¿‡gsonååºåˆ—åŒ–æ‰“å°dataç±»å‹ 12//Exception in thread &quot;main&quot; java.lang.ClassCastException: com.google.gson.internal.LinkedTreeMap cannot be cast to com.lis.wanjob.jol.Response$Data// at com.lis.wanjob.jol.Response.main(Response.java:35) gsonè§£ææ—¶ä¼šæŠŠDataè®¤ä¸ºæ˜¯LinkedTreeMapç±»å‹ï¼Œæ‰€ä»¥åœ¨æ‰“å°æ—¶å¼ºåˆ¶è½¬æ¢æ—¶æŠ¥é”™äº†ã€‚ æ­£ç¡®çš„è§£ææ˜¯é€šè¿‡Type 12345678Type type = new TypeToken&lt;Response&lt;Data&gt;&gt;() { }.getType();System.out.println(type);Response&lt;Data&gt; result = gson.fromJson(json, type);System.out.println(result.data.getClass());--æ‰“å°ç»“æœä¸ºï¼šcom.lis.wanjob.jol.Response&lt;com.lis.wanjob.jol.Response$Data&gt;class com.lis.wanjob.jol.Response$Data æˆ‘ä»¬çœ‹ä¸€ä¸‹TypeTokençš„æºç ï¼š 1234567891011121314151617 protected TypeToken() { this.type = getSuperclassTypeParameter(this.getClass()); this.rawType = Types.getRawType(this.type); this.hashCode = this.type.hashCode(); } static Type getSuperclassTypeParameter(Class&lt;?&gt; subclass) { Type superclass = subclass.getGenericSuperclass(); if (superclass instanceof Class) { throw new RuntimeException(&quot;Missing type parameter.&quot;); } else { ParameterizedType parameterized = (ParameterizedType)superclass; return Types.canonicalize(parameterized.getActualTypeArguments()[0]); } }public final Type getType() { return this.type; } è¿™é‡Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯TypeToken å—ä¿æŠ¤çš„æ„é€ å‡½æ•°ï¼ŒgetType()å°±æ˜¯è¿”å›çš„type. getSuperclassTypeParameter()æ–¹æ³•ä¸­ï¼Œå¦‚æœTypeTokenç±»çš„ç±»å‹typeæ˜¯æ³›å‹ç±»å‹çš„è¯ï¼Œä¼šè¢«è£…è½½ä¸ºTypeçš„å­æ¥å£ParameterizedTypeï¼Œå¯ä»¥è®©æˆ‘ä»¬å¾—åˆ°å…·ä½“çš„æ³›å‹ç±»å‹ã€‚ åœ¨å®ä¾‹åŒ–TypeTokenæ—¶ä½¿ç”¨{}ï¼Œå®é™…ä¸Šæ˜¯åŒ¿åå†…éƒ¨ç±»ã€‚ æˆ‘ä»¬è‡ªå·±åˆ›å»ºä¸ªç±»æ¥è§£ææ³›å‹çš„çœŸå®ç±»å‹ 123456789101112131415static class TypeReference&lt;T&gt; { Type actualTyep; Type getType() { return actualTyep; } public TypeReference() { Type superclass = getClass().getGenericSuperclass(); ParameterizedType type = (ParameterizedType) superclass; //è¿™é‡Œæ˜¯æ•°ç»„ï¼Œå› ä¸ºæ³›å‹å¯ä»¥æœ‰å¤šä¸ª&lt;T,E&gt; Type[] actualTypeArguments = type.getActualTypeArguments(); actualTyep = actualTypeArguments[0]; }} ä¸åŠ {}12345//ä¸åŠ {}æ—¶ï¼Œnew TypeReference&lt;Response&lt;Data&gt;&gt;()ä»£è¡¨ä¸€ä¸ªå¯¹è±¡Type type2 = new TypeReference&lt;Response&lt;Data&gt;&gt;().getType();System.out.println(type2);Response&lt;Data&gt; result = gson.fromJson(json, type2);System.out.println(result.data.getClass()); æˆ‘ä»¬åœ¨è¾“å‡ºæ—¶ï¼Œä¸åŠ {}æ—¶æŠ¥é”™ 123Exception in thread &quot;main&quot; java.lang.ClassCastException: java.lang.Class cannot be cast to java.lang.reflect.ParameterizedType at com.lis.wanjob.jol.Response$TypeReference.&lt;init&gt;(Response.java:41) at com.lis.wanjob.jol.Response.main(Response.java:62) åŠ {}12345//åŠ {}æ—¶ï¼Œnew TypeReference&lt;Response&lt;Data&gt;&gt;(){}ä»£è¡¨ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»Type type2 = new TypeReference&lt;Response&lt;Data&gt;&gt;(){}.getType();System.out.println(type2);Response&lt;Data&gt; result = gson.fromJson(json, type2);System.out.println(result.data.getClass()); æˆ‘ä»¬è¾“å‡ºæ—¶ï¼šèƒ½æ­£å¸¸çš„æ‰“å°æ³›å‹çš„çœŸå®ç±»å‹ 12com.lis.wanjob.jol.Response&lt;com.lis.wanjob.jol.Response$Data&gt;class com.lis.wanjob.jol.Response$Data å› ä¸ºä¸åŠ {}æ—¶ï¼Œnew TypeReference&lt;Response&gt;()åªæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨TypeReferenceæ²¡æœ‰è®°å½•æ³›å‹çœŸå®ç±»å‹çš„åœ°æ–¹ï¼Œæ­¤æ—¶çš„Typeå°±æ˜¯Class,æ‰€ä»¥å¼ºè½¬ParameterizedTypeæ—¶ä¼šæŠ¥é”™ã€‚ç¼–è¯‘æ–‡ä»¶Response$TypeReference.classï¼Œasä¸­æŸ¥çœ‹ï¼š 1234567891011121314class Response$TypeReference&lt;T&gt; { Type actualTyep; Type getType() { return this.actualTyep; } public Response$TypeReference() { Type superclass = this.getClass().getGenericSuperclass(); ParameterizedType type = (ParameterizedType)superclass; Type[] actualTypeArguments = type.getActualTypeArguments(); this.actualTyep = actualTypeArguments[0]; }} åŠ äº†{}æ—¶ï¼Œnew TypeReference&lt;Response&gt;(){}æ˜¯åŒ¿åå†…éƒ¨ç±»ï¼Œç¼–è¯‘æ—¶ï¼Œä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆå¯¹åº”çš„å†…éƒ¨ç±»çš„æ–‡ä»¶Response$1.classï¼Œæˆ‘ä»¬åœ¨asä¸­æ‰“å¼€çœ‹åˆ°å¦‚ä¸‹ä»£ç  1234final class Response$1 extends TypeReference&lt;Response&lt;Data&gt;&gt; { Response$1() { }} å†…éƒ¨ç±»ä¸­è®°å½•äº†æ³›å‹çš„çœŸå®ç±»å‹ã€‚åœ¨getType()è·å–ç±»å‹æ—¶ï¼Œå…¶å®æ˜¯è·å–çš„å†…éƒ¨ç±»çš„ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—åˆ°æ³›å‹çš„çœŸå®ç±»å‹ã€‚ PSï¼šæˆ‘ä»¬å¯ä»¥å°†è§£ææ³›å‹çš„çœŸå®ç±»å‹çš„ç±»å®šä¹‰ä¸ºæŠ½è±¡æˆ–å°†æ„é€ æ–¹æ³•æ”¹ä¸ºå—ä¿æŠ¤çš„ï¼ˆå¿…éœ€ä¸åŒåŒ…ä¸‹ï¼‰ï¼Œè¿™æ ·åœ¨åˆ›å»ºè§£æç±»æ—¶å¿…éœ€åŠ {}æˆä¸ºåŒ¿åå†…éƒ¨ç±»ï¼Œæ¥è·å–æ³›å‹çš„çœŸå®ç±»å‹ã€‚ 123456static abstract class TypeReference&lt;T&gt;{}æˆ–static class TypeReference&lt;T&gt; { protected TypeReference() { }}","link":"/2021/11/28/%E6%B3%9B%E5%9E%8B/"},{"title":"æ³¨è§£ä¸åå°„ï¼ˆä¸Šï¼‰","text":"æ³¨è§£ä¸€èˆ¬æ˜¯é…åˆåå°„æ¥ä¸€èµ·ç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠè¿™ä¸¤ä¸ªåˆåœ¨ä¸€èµ·æ¥åˆ†æã€‚ æ³¨è§£ æ³¨è§£å£°æ˜ å£°æ˜ä¸€ä¸ªæ³¨è§£ å…ƒæ³¨è§£ æ³¨è§£ç±»å‹å…ƒç´  æ³¨è§£åº”ç”¨åœºæ™¯ SOURCE IDEè¯­æ³•æ£€æŸ¥ APTæ³¨è§£å¤„ç†å™¨ æ³¨è§£å¤„ç†å™¨çš„å®ç° APT æ ¸å¿ƒåŸç† APT çš„ä¼˜ç¼ºç‚¹ APT åº”ç”¨åœºæ™¯ APT å·¥ä½œæµç¨‹å›¾ CLASS RUNTIME Java æ³¨è§£ï¼ˆAnnotationï¼‰åˆç§° Java æ ‡æ³¨ï¼Œæ˜¯ JDK1.5 å¼•å…¥çš„ä¸€ç§æ³¨é‡Šæœºåˆ¶ã€‚ æ³¨è§£æ˜¯å…ƒæ•°æ®çš„ä¸€ç§å½¢å¼ï¼Œæä¾›æœ‰å…³äºç¨‹åºä½†ä¸å±äºç¨‹åºæœ¬èº«çš„æ•°æ®ã€‚æ³¨è§£å¯¹å®ƒä»¬æ³¨è§£çš„ä»£ç çš„æ“ä½œæ²¡æœ‰ç›´æ¥å½±å“ã€‚ æ³¨è§£å£°æ˜å£°æ˜ä¸€ä¸ªæ³¨è§£Javaä¸­æ‰€æœ‰çš„æ³¨è§£ï¼Œé»˜è®¤å®ç° Annotationæ¥å£ï¼š 1234567891011package java.lang.annotation;public interface Annotation { boolean equals(Object obj); int hashCode(); String toString(); Class&lt;? extends Annotation&gt; annotationType();} æ³¨è§£çš„å£°æ˜ä½¿ç”¨ @interface å…³é”®å­—ã€‚ä¸€ä¸ªæ³¨è§£çš„å£°æ˜å¦‚ä¸‹ï¼š 12public @interface Test{} å…ƒæ³¨è§£åœ¨å®šä¹‰æ³¨è§£æ—¶ï¼Œæ³¨è§£ç±»ä¹Ÿèƒ½å¤Ÿä½¿ç”¨å…¶ä»–çš„æ³¨è§£å£°æ˜ã€‚å¯¹æ³¨è§£ç±»å‹è¿›è¡Œæ³¨è§£çš„æ³¨è§£ç±»ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º meta-annotationï¼ˆå…ƒæ³¨è§£ï¼‰ã€‚ä¸€èˆ¬çš„ï¼Œæˆ‘ä»¬åœ¨å®šä¹‰è‡ªå®šä¹‰æ³¨è§£æ—¶ï¼Œéœ€è¦æŒ‡å®šçš„å…ƒæ³¨è§£æœ‰ä¸¤ä¸ª ï¼š å¦å¤–è¿˜æœ‰@Documented ä¸ @Inherited å…ƒæ³¨è§£ï¼Œå‰è€…ç”¨äºè¢«javadocå·¥å…·æå–æˆæ–‡æ¡£ï¼Œåè€…è¡¨ç¤ºå…è®¸å­ç±»ç»§æ‰¿çˆ¶ç±»ä¸­å®šä¹‰çš„æ³¨è§£ã€‚ @Targetæ³¨è§£æ ‡è®°å¦ä¸€ä¸ªæ³¨è§£ï¼Œä»¥é™åˆ¶å¯ä»¥åº”ç”¨æ³¨è§£çš„ Java å…ƒç´ ç±»å‹ã€‚ç›®æ ‡æ³¨è§£æŒ‡å®šä»¥ä¸‹å…ƒç´ ç±»å‹ä¹‹ä¸€ä½œä¸ºå…¶å€¼ï¼š ElementType.ANNOTATION_TYPE å¯ä»¥åº”ç”¨äºæ³¨è§£ç±»å‹ã€‚ ElementType.CONSTRUCTOR å¯ä»¥åº”ç”¨äºæ„é€ å‡½æ•°ã€‚ ElementType.FIELD å¯ä»¥åº”ç”¨äºå­—æ®µæˆ–å±æ€§ã€‚ ElementType.LOCAL_VARIABLE å¯ä»¥åº”ç”¨äºå±€éƒ¨å˜é‡ã€‚ ElementType.METHOD å¯ä»¥åº”ç”¨äºæ–¹æ³•çº§æ³¨è§£ã€‚ ElementType.PACKAGE å¯ä»¥åº”ç”¨äºåŒ…å£°æ˜ã€‚ ElementType.PARAMETER å¯ä»¥åº”ç”¨äºæ–¹æ³•çš„å‚æ•°ã€‚ ElementType.TYPE å¯ä»¥åº”ç”¨äºç±»çš„ä»»ä½•å…ƒç´ ã€‚ @Retentionæ³¨è§£æŒ‡å®šæ ‡è®°æ³¨è§£çš„å­˜å‚¨æ–¹å¼ï¼š RetentionPolicy.SOURCE - æ ‡è®°çš„æ³¨è§£ä»…ä¿ç•™åœ¨æºçº§åˆ«ä¸­ï¼Œå¹¶è¢«ç¼–è¯‘å™¨å¿½ç•¥ã€‚ RetentionPolicy.CLASS - æ ‡è®°çš„æ³¨è§£åœ¨ç¼–è¯‘æ—¶ç”±ç¼–è¯‘å™¨ä¿ç•™ï¼Œä½† Java è™šæ‹Ÿæœº(JVM)ä¼šå¿½ç•¥ã€‚ RetentionPolicy.RUNTIME - æ ‡è®°çš„æ³¨è§£ç”± JVM ä¿ç•™ï¼Œå› æ­¤è¿è¡Œæ—¶ç¯å¢ƒå¯ä»¥ä½¿ç”¨å®ƒã€‚ @Retention ä¸‰ä¸ªå€¼ä¸­ SOURCE &lt; CLASS &lt; RUNTIMEï¼Œå³CLASSåŒ…å«äº†SOURCEï¼ŒRUNTIMEåŒ…å«SOURCEã€CLASSã€‚ä¸‹æ–‡ä¼šä»‹ç»ä»–ä»¬ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚ ä¸‹é¢æ¥çœ‹ä¾‹å­ï¼š 12345@Target({ElementType.TYPE,ElementType.FIELD}) // å…è®¸åœ¨ç±»ä¸ç±»å±æ€§ä¸Šæ ‡è®°è¯¥æ³¨è§£ **ä½œç”¨ç›®æ ‡**@Retention(RetentionPolicy.SOURCE) //æ³¨è§£ä¿ç•™åœ¨æºç ä¸­ **ä¿ç•™æ—¶**public @interface Test { } æ³¨è§£ç±»å‹å…ƒç´ åœ¨ä¸Šæ–‡å…ƒæ³¨è§£ä¸­ï¼Œå…è®¸åœ¨ä½¿ç”¨æ³¨è§£æ—¶ä¼ é€’å‚æ•°ã€‚æˆ‘ä»¬ä¹Ÿèƒ½è®©è‡ªå®šä¹‰æ³¨è§£çš„ä¸»ä½“åŒ…å« annotation type element (æ³¨è§£ç±»å‹å…ƒç´ ) å£°æ˜ï¼Œå®ƒä»¬çœ‹èµ·æ¥å¾ˆåƒæ–¹æ³•ï¼Œå¯ä»¥å®šä¹‰å¯é€‰çš„é»˜è®¤å€¼ã€‚ 123456@Target({ElementType.TYPE,ElementType.FIELD})@Retention(RetentionPolicy.SOURCE)public @interface Test { String value(); //æ— é»˜è®¤å€¼ int age() default 1; //æœ‰é»˜è®¤å€¼} æ³¨æ„ï¼šåœ¨ä½¿ç”¨æ³¨è§£æ—¶ï¼Œå¦‚æœå®šä¹‰çš„æ³¨è§£ä¸­çš„ç±»å‹å…ƒç´ æ— é»˜è®¤å€¼ï¼Œåˆ™å¿…é¡»è¿›è¡Œä¼ å€¼ã€‚ 123@Test(&quot;å¸…&quot;) //å¦‚æœåªå­˜åœ¨valueå…ƒç´ éœ€è¦ä¼ å€¼çš„æƒ…å†µï¼Œåˆ™å¯ä»¥çœç•¥:å…ƒç´ å=@Test(value=&quot;å¸…&quot;,age = 2)int i; æ³¨è§£åº”ç”¨åœºæ™¯æŒ‰ç…§@Retention å…ƒæ³¨è§£å®šä¹‰çš„æ³¨è§£å­˜å‚¨æ–¹å¼ï¼Œæ³¨è§£å¯ä»¥è¢«åœ¨ä¸‰ç§åœºæ™¯ä¸‹ä½¿ç”¨ï¼š SOURCERetentionPolicy.SOURCE ï¼Œä½œç”¨äºæºç çº§åˆ«çš„æ³¨è§£ï¼Œå¯æä¾›ç»™IDEè¯­æ³•æ£€æŸ¥ã€APTç­‰åœºæ™¯ä½¿ç”¨ã€‚ åœ¨ç±»ä¸­ä½¿ç”¨ SOURCE çº§åˆ«çš„æ³¨è§£ï¼Œå…¶ç¼–è¯‘ä¹‹åçš„classä¸­ä¼šè¢«ä¸¢å¼ƒã€‚ 12345--AnnotationTest.java@Testpublic class AnnotationTest{} 12345--AnnotationTest.class// è¿™é‡Œçš„æ³¨è§£è¢«ä¸¢å¼ƒäº†public class AnnotationTest{} IDEè¯­æ³•æ£€æŸ¥åœ¨Androidå¼€å‘ä¸­ï¼Œ support-annotations ä¸ androidx.annotationä¸­å‡æœ‰æä¾› @IntDef æ³¨è§£ï¼Œæ­¤æ³¨è§£çš„å®šä¹‰å¦‚ä¸‹ï¼š 12345678910package androidx.annotation;@Retention(SOURCE) //æºç çº§åˆ«çš„æ³¨è§£@Target({ANNOTATION_TYPE})public @interface IntDef { int[] value() default {}; boolean flag() default false; boolean open() default false;} Javaä¸­Enum(æšä¸¾)çš„å®è´¨æ˜¯ç‰¹æ®Šå•ä¾‹çš„é™æ€æˆå‘˜å˜é‡ï¼Œåœ¨è¿è¡ŒæœŸæ‰€æœ‰æšä¸¾ç±»ä½œä¸ºå•ä¾‹ï¼Œå…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚æ¯”å¸¸é‡å¤š5åˆ°10å€çš„å†…å­˜å ç”¨ã€‚ è€Œç°åœ¨ä¸ºäº†è¿›è¡Œå†…å­˜ä¼˜åŒ–ï¼Œæˆ‘ä»¬ç°åœ¨ä¸å†ä½¿ç”¨æšä¸¾ï¼Œåˆ™æ–¹æ³•å®šä¹‰ä¸ºï¼š 12345678910public static final int SUNDAY = 1;public static final int MONDAY = 2;public static void setCurrentDay(int currentDay) {}public void test() { setCurrentDay(1);} ç„¶è€Œæ­¤æ—¶ï¼Œè°ƒç”¨ setCurrentDayæ–¹æ³•ç”±äºé‡‡ç”¨åŸºæœ¬æ•°æ®ç±»å‹intï¼Œå°†æ— æ³•è¿›è¡Œç±»å‹é™å®šã€‚æ­¤æ—¶ä½¿ç”¨@IntDefå¢åŠ è‡ªå®šä¹‰æ³¨è§£ï¼š 123456789@IntDef({IntDefTest.MONDAY,IntDefTest.SUNDAY}) //é™å®šä¸º MONDAYï¼ŒSUNDAY@Target(ElementType.PARAMETER) //ä½œç”¨äºå‚æ•°çš„æ³¨è§£@Retention(RetentionPolicy.SOURCE) //æºç çº§åˆ«æ³¨è§£public @interface WeekDayAnn {}public static void setCurrentDay(@WeekDayAnn int currentDay) {} æ­¤æ—¶ï¼Œæˆ‘ä»¬å†å»è°ƒç”¨ setCurrentDayæ–¹æ³•ï¼Œå¦‚æœä¼ é€’çš„å‚æ•°ä¸æ˜¯ MONDAYæˆ–è€… SUNDAYåˆ™ä¼šæ˜¾ç¤º Inspection è­¦å‘Š(ç¼–è¯‘ä¸ä¼šæŠ¥é”™)ã€‚ ä»¥ä¸Šæ³¨è§£å‡ä¸º SOURCE çº§åˆ«ï¼Œæœ¬èº«IDEA/AS å°±æ˜¯ç”±Javaå¼€å‘çš„ï¼Œå·¥å…·å®ç°äº†å¯¹Javaè¯­æ³•çš„æ£€æŸ¥ï¼Œå€ŸåŠ©æ³¨è§£èƒ½å¯¹è¢«æ³¨è§£çš„ç‰¹å®šè¯­æ³•è¿›è¡Œé¢å¤–æ£€æŸ¥ã€‚ APTæ³¨è§£å¤„ç†å™¨APTå…¨ç§°ä¸ºï¼šâ€Anotation Processor Toolsâ€ï¼Œæ„ä¸ºæ³¨è§£å¤„ç†å™¨ã€‚é¡¾åæ€ä¹‰ï¼Œå…¶ç”¨äºå¤„ç†æ³¨è§£ã€‚ç¼–å†™å¥½çš„Javaæºæ–‡ä»¶ï¼Œéœ€è¦ç»è¿‡ javac çš„ç¼–è¯‘ï¼Œç¿»è¯‘ä¸ºè™šæ‹Ÿæœºèƒ½å¤ŸåŠ è½½è§£æçš„å­—èŠ‚ç Classæ–‡ä»¶ã€‚æ³¨è§£å¤„ç†å™¨æ˜¯ javac è‡ªå¸¦çš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨æ¥åœ¨ç¼–è¯‘æ—¶æœŸæ‰«æå¤„ç†æ³¨è§£ä¿¡æ¯ã€‚ä½ å¯ä»¥ä¸ºæŸäº›æ³¨è§£æ³¨å†Œè‡ªå·±çš„æ³¨è§£å¤„ç†å™¨ã€‚ æ³¨å†Œçš„æ³¨è§£å¤„ç†å™¨ç”± javacè°ƒèµ·ï¼Œå¹¶å°†æ³¨è§£ä¿¡æ¯ä¼ é€’ç»™æ³¨è§£å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚ æ³¨è§£å¤„ç†å™¨æ˜¯å¯¹æ³¨è§£åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„åœºæ™¯ã€‚åœ¨Glideã€EventBus3ã€Butterkniferã€Tinkerã€ARouterç­‰ç­‰å¸¸ç”¨æ¡†æ¶ä¸­éƒ½æœ‰æ³¨è§£å¤„ç†å™¨çš„èº«å½±ã€‚ä½†æ˜¯ä½ å¯èƒ½ä¼šå‘ç°ï¼Œè¿™äº›æ¡†æ¶ä¸­å¯¹æ³¨è§£çš„å®šä¹‰å¹¶ä¸æ˜¯ SOURCE çº§åˆ«ï¼Œæ›´å¤šçš„æ˜¯ CLASS çº§åˆ«ï¼Œåˆ«å¿˜äº†ï¼šCLASSåŒ…å«äº†SOURCEï¼ŒRUNTIMEåŒ…å«SOURCEã€CLASSã€‚ æ³¨è§£å¤„ç†å™¨çš„å®ç°é¦–å…ˆåœ¨ç¨‹åºä¸­æ·»åŠ ä¸€ä¸ªJava Module annotation ç”¨äºä¸“é—¨å†™æ³¨è§£,åˆ›å»ºä¸€ä¸ªæ³¨è§£MyClass 1234@Retention(RetentionPolicy.SOURCE)@Target(ElementType.TYPE)public @interface MyClass {} å•ç‹¬åˆ›å»ºannotationæ¨¡å—ï¼Œèƒ½å¤Ÿç»™å…¶ä»–å­æ¨¡å—è¿›è¡Œä¾èµ– ç„¶åå†æ·»åŠ ä¸€ä¸ªJava Module compiler ç”¨äºæ³¨è§£å¤„ç†å™¨çš„ç¼–å†™ åœ¨appå’Œcompilerä¸­build.gradleä¸­æ·»åŠ annotationçš„ä¾èµ– 123dependencies{ implementation project(':annotation')} åœ¨compilerä¸­æ·»åŠ æ³¨è§£å¤„ç†å™¨ç»§æ‰¿AbstractProcessor 123456789package com.lis.compiler;public class Processor extends AbstractProcessor { @Override public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv) { return false; }} æ³¨å†Œæ³¨è§£å¤„ç†å™¨ åœ¨compiler mainç›®å½•ä¸‹åˆ›å»ºä»¥ä¸‹ç›®å½•åŠæ–‡ä»¶resources\\META-INF\\services\\javax.annotation.processing.Processor è¿™æ­¤æ–‡ä»¶é‡Œæ·»åŠ æ³¨è§£å¤„ç†å™¨çš„å®ç°ç±»com.lis.compiler.Processor ï¼ˆæ¯ä¸ªæ³¨è§£å¤„ç†å™¨å ä¸€è¡Œï¼‰ å¦å¤–ä¸€ç§æ˜¯ä½¿ç”¨AutoServiceè‡ªåŠ¨å®Œæˆæ³¨å†Œ @AutoService(Processor.class) //å›ºå®šå†™æ³• compileOnly â€˜com.google.auto.service:auto-service:1.0â€™annotationProcessor â€˜com.google.auto.service:auto-service:1.0â€™ @AutoService(Processor.class) //å›ºå®šå†™æ³•@SupportedAnnotationTypes({â€œcom.lis.annotation.MyClassâ€})public class Processor extends AbstractProcessor { } è®¾ç½®å¤„ç†å™¨è¦å¤„ç†çš„æ³¨è§£ æœ‰ä¸¤ç§æ–¹å¼ 1.é‡å†™getSupportedAnnotationTypesæ–¹æ³• 12345678/** * å…è®¸æ­¤æ³¨è§£å¤„ç†å™¨å¤„ç†çš„æ³¨è§£ * @return */@Overridepublic Set&lt;String&gt; getSupportedAnnotationTypes() { return Collections.singleton(&quot;com.lis.annotation.MyClass&quot;);} 2.åœ¨classä¸Šæ·»åŠ æ³¨è§£SupportedAnnotationTypes 12345678910111213141516@SupportedAnnotationTypes({&quot;com.lis.annotation.MyClass&quot;})public class Processor extends AbstractProcessor { @Override public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv) { return false; } /** * å…è®¸æ­¤æ³¨è§£å¤„ç†å™¨å¤„ç†çš„æ³¨è§£ * @return */// @Override// public Set&lt;String&gt; getSupportedAnnotationTypes() {// return Collections.singleton(&quot;com.lis.annotation.MyClass&quot;);// }} åœ¨appä¸­ä½¿ç”¨æ­¤æ³¨è§£å¤„ç†å™¨ï¼ˆbuildæ–‡ä»¶ä¸­å¼•ç”¨æ­¤æ³¨è§£å¤„ç†å™¨ï¼‰ 12implementation project(':annotation')annotationProcessor project(':compiler') //kotlinä½¿ç”¨kapt ä½¿ç”¨kotlinæ—¶ 12345plugins { id 'kotlin-kapt' //å¼•å…¥kaptæ’ä»¶}kapt project(':compiler') //ä½¿ç”¨kaptå¼•å…¥æ³¨è§£å¤„ç†å™¨ åœ¨appä¸­ä½¿ç”¨æ³¨è§£ 1234@MyClassclass MainActivity : AppCompatActivity(){ } apt: ä¸ä¼šæ‰“åŒ…è¿›APKï¼Œåªä¼šåœ¨ç¼–è¯‘æ—¶å‚ä¸ç¼–è¯‘ åœ¨æ³¨è§£å¤„ç†å™¨ä¸­è¾“å‡ºä¸€ä¸ªæ—¥å¿—=======================&gt;,ç„¶åç¼–è¯‘é¡¹ç›®å¯ä»¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—è¾“å‡º 1234&gt; Task :app:kaptDebugKotlinè­¦å‘Š: No SupportedSourceVersion annotation found on com.lis.compiler.Processor, returning RELEASE_6.è­¦å‘Š: æ¥è‡ªæ³¨é‡Šå¤„ç†ç¨‹åº 'org.jetbrains.kotlin.kapt3.base.ProcessorWrapper' çš„å—æ”¯æŒ source ç‰ˆæœ¬ 'RELEASE_6' ä½äº -source '1.8'æ³¨: =======================&gt;æ³¨: =======================&gt; é—®é¢˜ï¼šæ³¨è§£å¤„ç†å™¨ä¸ºä»€ä¹ˆä¼šæ‰§è¡Œå¤šæ¬¡ï¼Ÿ å› ä¸ºjavaç¼–è¯‘è¿‡ç¨‹ï¼šè¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€å¡«å……ç¬¦å·è¡¨ã€æ³¨è§£å¤„ç†å™¨å¤„ç†æ³¨è§£ã€è¯­ä¹‰åˆ†æã€è§£è¯­æ³•ç³–ã€ç”Ÿæˆå­—èŠ‚ç ã€‚ æ³¨è§£å¤„ç†å™¨å¯ä»¥å¢åˆ æ”¹æŠ½è±¡è¯­æ³•æ ‘çš„ä»»æ„å…ƒç´ ã€‚æ‰§è¡Œåˆ°æ³¨è§£å¤„ç†å™¨ï¼Œéƒ½ä¼šé‡æ–°æ‰§è¡Œ è¯­æ³•åˆ†æã€å¡«å……ç¬¦å·è¡¨ æ­¥ï¼Œç›´åˆ°æ³¨è§£å¤„ç†å™¨ä¸å†å¯¹è¯­æ³•æ ‘è¿›è¡Œä¿®æ”¹ä¸ºæ­¢ï¼Œç¬¬ä¸€æ¬¡çš„å¾ªç¯è¿‡ç¨‹éƒ½ç§°ä¸ºä¸€æ¬¡Roudã€‚ processç¬¬ä¸€ä¸ªå‚æ•°seté›†åˆæ˜¯è¦å¤„ç†çš„æ³¨è§£é›†åˆï¼Œå¦‚æœè¿™ä¸ªé›†åˆä¸ºnulläº†ï¼Œå°±ä¸éœ€è¦å¤„ç†äº†ã€‚ 123if(!annotations.isEmpty()){ //todo} APT æ ¸å¿ƒåŸç† ç¼–è¯‘æ—¶è§¦å‘ï¼š å½“ Java ç¼–è¯‘å™¨ï¼ˆjavacï¼‰å¼€å§‹å·¥ä½œæ—¶ï¼ŒAPT è‡ªåŠ¨å¯åŠ¨ã€‚ æ‰«ææ³¨è§£ï¼š éå†æ‰€æœ‰æºç å’Œ Class æ–‡ä»¶ï¼Œæ‰¾åˆ°è¢«ç›®æ ‡æ³¨è§£æ ‡è®°çš„å…ƒç´ ï¼ˆå¦‚å­—æ®µã€æ–¹æ³•ï¼‰ã€‚ ç”Ÿæˆä»£ç ï¼š æ ¹æ®æ³¨è§£ä¿¡æ¯ï¼Œç”¨ JavaPoet ç­‰å·¥å…·ç”Ÿæˆæ–°çš„ Java æ–‡ä»¶ã€‚ å¤šè½®å¤„ç†ï¼š ç”Ÿæˆçš„ä»£ç å¯èƒ½åŒ…å«æ–°æ³¨è§£ï¼ŒAPT ä¼šå¤šæ¬¡å¾ªç¯å¤„ç†ï¼Œç›´åˆ°æ— æ–°ä»£ç ç”Ÿæˆã€‚ APT çš„ä¼˜ç¼ºç‚¹ ä¼˜ç‚¹ ç¼ºç‚¹ ç¼–è¯‘æ—¶å¤„ç†ï¼Œä¸æ‹–æ…¢è¿è¡Œé€Ÿåº¦ å­¦ä¹ æˆæœ¬é«˜ï¼Œéœ€è¦ç†è§£æ³¨è§£å¤„ç†å™¨API å‡å°‘æ‰‹å†™é‡å¤ä»£ç ï¼ˆå¦‚ findViewByIdï¼‰ ç”Ÿæˆçš„ä»£ç è°ƒè¯•å›°éš¾ ä»£ç æ›´å¹²å‡€ï¼Œç»´æŠ¤æ–¹ä¾¿ é…ç½®ç¨ç¹çï¼ˆæ³¨å†Œå¤„ç†å™¨ï¼‰ APT åº”ç”¨åœºæ™¯ View ç»‘å®šï¼š å¦‚ ButterKnifeï¼Œè‡ªåŠ¨ç”Ÿæˆ findViewById ä»£ç ã€‚ ä¾èµ–æ³¨å…¥ï¼š å¦‚ Dagger2ï¼Œç”Ÿæˆä¾èµ–æ³¨å…¥é€»è¾‘ã€‚ è·¯ç”±æ¡†æ¶ï¼š å¦‚ ARouterï¼Œç”Ÿæˆ Activity è·¯ç”±è¡¨ã€‚ åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼š å¦‚ Gson TypeAdapter è‡ªåŠ¨ç”Ÿæˆã€‚ APT å·¥ä½œæµç¨‹å›¾å†™æ³¨è§£ â†’ ç¼–è¯‘ â†’ APT æ‰«æ â†’ ç”Ÿæˆä»£ç  â†’ äºŒæ¬¡ç¼–è¯‘ â†’ æœ€ç»ˆ APK CLASSå®šä¹‰ä¸º CLASS çš„æ³¨è§£ï¼Œä¼šä¿ç•™åœ¨classæ–‡ä»¶ä¸­ï¼Œä½†æ˜¯ä¼šè¢«è™šæ‹Ÿæœºå¿½ç•¥(å³æ— æ³•åœ¨è¿è¡ŒæœŸåå°„è·å–æ³¨è§£)ã€‚æ­¤æ—¶å®Œå…¨ç¬¦åˆæ­¤ç§æ³¨è§£çš„åº”ç”¨åœºæ™¯ä¸ºå­—èŠ‚ç æ“ä½œã€‚å¦‚ï¼šAspectJã€çƒ­ä¿®å¤Roubustä¸­åº”ç”¨æ­¤åœºæ™¯ã€‚æ‰€è°“å­—èŠ‚ç æ“ä½œå³ä¸ºï¼Œç›´æ¥ä¿®æ”¹å­—èŠ‚ç Classæ–‡ä»¶ä»¥è¾¾åˆ°ä¿®æ”¹ä»£ç æ‰§è¡Œé€»è¾‘çš„ç›®çš„ã€‚åœ¨ç¨‹åºä¸­æœ‰å¤šå¤„éœ€è¦è¿›è¡Œæ˜¯å¦ç™»å½•çš„åˆ¤æ–­ã€‚ å¦‚æœæˆ‘ä»¬ä½¿ç”¨æ™®é€šçš„ç¼–ç¨‹æ–¹å¼ï¼Œéœ€è¦åœ¨ä»£ç ä¸­è¿›è¡Œ if-else çš„åˆ¤æ–­ï¼Œä¹Ÿè®¸å­˜åœ¨åä¸ªåˆ¤æ–­ç‚¹ï¼Œåˆ™éœ€è¦åœ¨æ¯ä¸ªåˆ¤æ–­ç‚¹åŠ å…¥æ­¤é¡¹åˆ¤æ–­ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©AOP(é¢å‘åˆ‡é¢)ç¼–ç¨‹æ€æƒ³ï¼Œå°†ç¨‹åºä¸­æ‰€æœ‰åŠŸèƒ½ç‚¹åˆ’åˆ†ä¸ºï¼š éœ€è¦ç™»å½• ä¸ æ— éœ€ç™»å½•ä¸¤ç§ç±»å‹ï¼Œå³ä¸¤ä¸ªåˆ‡é¢ã€‚å¯¹äºåˆ‡é¢çš„åŒºåˆ†å³å¯é‡‡ç”¨æ³¨è§£ã€‚ 12345678910111213//Javaæºç @Target(ElementType.METHOD)@Retention(RetentionPolicy.CLASS)public @interface Login {}@Loginpublic void jumpA(){ startActivity(new Intent(this,AActivity.class));}public void jumpB(){ startActivity(new Intent(this,BActivity.class));} åœ¨ä¸Šè¯‰ä»£ç ä¸­ï¼Œ jumpA æ–¹æ³•éœ€è¦å…·å¤‡ç™»å½•èº«ä»½ã€‚è€Œ Login æ³¨è§£çš„å®šä¹‰è¢«è®¾ç½®ä¸º CLASS ã€‚å› æ­¤æˆ‘ä»¬èƒ½å¤Ÿåœ¨è¯¥ç±»æ‰€ç¼–è¯‘çš„å­—èŠ‚ç ä¸­è·å¾—åˆ°æ–¹æ³•æ³¨è§£ Login ã€‚åœ¨æ“ä½œå­—èŠ‚ç æ—¶ï¼Œå°±èƒ½å¤Ÿæ ¹æ®æ–¹æ³•æ˜¯å¦å…·å¤‡è¯¥æ³¨è§£æ¥ä¿®æ”¹classä¸­è¯¥æ–¹æ³•çš„å†…å®¹åŠ å…¥ if-else çš„ä»£ç æ®µï¼š 12345678910111213//Classå­—èŠ‚ç @Loginpublic void jumpA() { if (this.isLogin) { this.startActivity(new Intent(this, LoginActivity.class)); } else { this.startActivity(new Intent(this, AActivity.class)); }}public void jumpB() { startActivity(new Intent(this,BActivity.class));} æ³¨è§£èƒ½å¤Ÿè®¾ç½®ç±»å‹å…ƒç´ (å‚æ•°)ï¼Œç»“åˆå‚æ•°èƒ½å®ç°æ›´ä¸ºä¸°å¯Œçš„åœºæ™¯ï¼Œå¦‚ï¼šè¿è¡ŒæœŸæƒé™åˆ¤å®šç­‰ RUNTIMEæ³¨è§£ä¿ç•™è‡³è¿è¡ŒæœŸï¼Œæ„å‘³ç€æˆ‘ä»¬èƒ½å¤Ÿåœ¨è¿è¡ŒæœŸé—´ç»“åˆåå°„æŠ€æœ¯è·å–æ³¨è§£ä¸­çš„æ‰€æœ‰ä¿¡æ¯ã€‚","link":"/2025/05/15/%E6%B3%A8%E8%A7%A3%E4%B8%8E%E5%8F%8D%E5%B0%84/"}],"tags":[{"name":"activity","slug":"activity","link":"/tags/activity/"},{"name":"Androidæºç ","slug":"Androidæºç ","link":"/tags/Android%E6%BA%90%E7%A0%81/"},{"name":"dispatch","slug":"dispatch","link":"/tags/dispatch/"},{"name":"OkHttp","slug":"OkHttp","link":"/tags/OkHttp/"},{"name":"Java","slug":"Java","link":"/tags/Java/"},{"name":"æ³›å‹","slug":"æ³›å‹","link":"/tags/%E6%B3%9B%E5%9E%8B/"},{"name":"æ³¨è§£","slug":"æ³¨è§£","link":"/tags/%E6%B3%A8%E8%A7%A3/"},{"name":"åå°„","slug":"åå°„","link":"/tags/%E5%8F%8D%E5%B0%84/"},{"name":"åŠ¨æ€ä»£ç†","slug":"åŠ¨æ€ä»£ç†","link":"/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"}],"categories":[{"name":"Androidæºç ","slug":"Androidæºç ","link":"/categories/Android%E6%BA%90%E7%A0%81/"},{"name":"Androidä¸‰æ–¹åº“æºç åˆ†æ","slug":"Androidä¸‰æ–¹åº“æºç åˆ†æ","link":"/categories/Android%E4%B8%89%E6%96%B9%E5%BA%93%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"name":"JavaåŸºç¡€ä¸è¿›é˜¶","slug":"JavaåŸºç¡€ä¸è¿›é˜¶","link":"/categories/Java%E5%9F%BA%E7%A1%80%E4%B8%8E%E8%BF%9B%E9%98%B6/"}]}