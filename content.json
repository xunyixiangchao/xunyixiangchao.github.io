{"pages":[{"title":"","text":"ä¸ªäººç®€ä»‹ åˆ†äº«å¾ˆå–œæ¬¢çš„è€ç½—çš„ä¸€æ®µè¯ï¼š â€œæ¯ä¸€ä¸ªç”Ÿå‘½æ¥åˆ°ä¸–é—´éƒ½æ³¨å®šæ”¹å˜ä¸–ç•Œï¼Œåˆ«æ— é€‰æ‹©ã€‚è¦ä¹ˆå˜å¾—å¥½ä¸€ç‚¹ï¼Œè¦ä¹ˆå˜å¾—åä¸€ç‚¹ã€‚ä½ å¦‚æœèµ°è¿›ç¤¾ä¼šä¸ºäº†ç”Ÿå­˜ä¸ºäº†ä»€ä¹ˆä¸è¦è„¸çš„ç†ç”±ï¼Œå˜æˆäº†ä¸€ä¸ªæ¶å¿ƒçš„æˆå¹´äººç¤¾ä¼šä¸­çš„ä¸€å‘˜ï¼Œé‚£ä½ å°±æŠŠè¿™ä¸ªä¸–ç•Œå˜å¾—æ¶å¿ƒäº†ä¸€ç‚¹ç‚¹ã€‚å¦‚æœä½ ä¸€ç”Ÿåˆšæ­£ä¸é˜¿ï¼Œå¦‚æœä½ ä¸€ç”Ÿè€¿ç›´ï¼Œæ²¡æœ‰åšä»»ä½•æ¶å¿ƒçš„äº‹æƒ…ï¼Œæ²¡åšå¯¹åˆ«äººæœ‰å®³çš„äº‹æƒ…ï¼Œä¸€è¾ˆå­æ‹¼äº†è€å‘½å‹‰å¼ºæŠŠè‡ªå·±èº«è¾¹çš„å‡ ä¸ªäººç…§é¡¾å¥½äº†ï¼Œæ²¡æœ‰æˆåæ²¡æœ‰å‘è´¢ï¼Œæ²¡æœ‰æˆå°±ä¼Ÿå¤§çš„äº‹ä¸šï¼Œç„¶åè€¿ç€è„–å­ä¸€ç”Ÿæ­£ç›´ï¼Œåˆ°äº†ä¸ƒå…«åå²è€¿ç€è„–å­å»ä¸–äº†ã€‚ä½ è¿™ä¸€ç”Ÿæ˜¯ä¸æ˜¯æ²¡æœ‰æ”¹å˜ä¸–ç•Œï¼Ÿä½ è¿˜æ˜¯æ”¹å˜ä¸–ç•Œäº†ï¼Œä½ æŠŠè¿™ä¸ªä¸–ç•Œå˜å¾—ç¾å¥½äº†ä¸€ç‚¹ç‚¹ã€‚å› ä¸ºä¸–ç•Œä¸Šåˆå¤šäº†ä¸€ä¸ªå¥½äººã€‚â€œ å–„æ¶ç»ˆæœ‰æŠ¥,å¤©é“å¥½è½®å›ã€‚ä¸ä¿¡æŠ¬å¤´çœ‹,è‹å¤©é¥¶è¿‡è°ã€‚æ— è®ºä½•æ—¶ä½•åœ°ï¼Œæˆ‘ä»¬éƒ½è¦ä¿æŒä¸€é¢—ç§¯æä¹è§‚ã€å–„è‰¯æ„Ÿæ©çš„å¿ƒã€‚ä½†è¡Œå¥½äº‹è«é—®å‰ç¨‹ï¼Œæ°¸è¿œå¹´è½»ï¼Œæ°¸è¿œçƒ­å†…ç›ˆçœ¶ï¼Œæ°¸è¿œä¿æŒæ­£èƒ½é‡ã€‚ğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ªå†²é¸­ï¼ï¼ï¼ï¼ -&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;ä¸ªäººä¿¡æ¯ï¼šè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ä¸“ä¸šä»äº‹JAVAåç«¯å¼€å‘ç ç•œä¸€æšåšä¿¡ä»£ç æ”¹å˜ä¸–ç•Œ åšå®¢ä¿¡æ¯ ç½‘ç«™é‡‡ç”¨çš„Icarusä¸»é¢˜ è¿½æ±‚å°½å¯èƒ½çš„ç®€æ´ï¼Œæ¸…æ™°ï¼Œæ˜“ç”¨ã€‚ åœ¨Icarusä¸»é¢˜ä¹‹ä¸Šè¿›è¡Œäº†éƒ¨åˆ†ä¿®æ”¹ã€‚ æ›´æ–°æ—¥å¿—ï¼šâ€“2020.09.20ï¼šicarus4.0é€‚é…â€“2020.01.18ï¼šicarus3.0é€‚é…â€“2019.11.17ï¼šå¢åŠ æ·±è‰²ä¸»é¢˜å¼€å…³â€“2019.10.30ï¼šå»å›¾ï¼Œç²¾ç®€å¡ç‰‡â€“2019.10.22ï¼šæ”¹ç‰ˆéƒ¨åˆ†æ˜¾ç¤ºï¼Œä¼˜åŒ–é€Ÿåº¦â€“2019.10.16ï¼šæ–‡ç« åˆ—è¡¨åŠ ä¸Šè¯„è®ºæ•°æ˜¾ç¤ºâ€“2019.10.13ï¼šæ”¹ç‰ˆè¯„è®ºâ€“2019.09.25ï¼šå›¾ç‰‡ã€èµ„æºæ¥å…¥CDNå…è´¹jsDelivrã€æ–‡ç« åŠ å…¥ç½®é¡¶â€“2019.09.19ï¼šå¼€æºåšå®¢ä»£ç â€“2019.09.19ï¼šä¿®æ”¹å¸ƒå±€ï¼Œæ‹‰ä¼¸å¸ƒå±€ï¼Œæ›´å®½çš„å±•ç¤ºâ€“2019.09.18ï¼šä¿®æ”¹å‹é“¾uiä¸ºä¸€è¡Œä¸‰ä¸ªï¼Œå¹¶é€‚é…ç§»åŠ¨ç«¯ï¼Œæš—é»‘æ¨¡å¼æ–‡ç« å¢åŠ è¯„è®ºé“¾æ¥ï¼Œå¢åŠ ç•™è¨€é“¾æ¥â€“2019.09.14ï¼šå¢åŠ ç²¾ç®€nextä¸»é¢˜â€“2019.09.14ï¼šåˆ©ç”¨ä¸­ç§‹èŠ‚æ”¾å‡ï¼Œé‡åšäº†é¦–é¡µçš„çƒ­é—¨æ¨èã€åŠ ä¸ªwidgetæœ€æ–°è¯„è®ºæ¡†ã€å½’æ¡£é¡µåŠ å…¥æ–‡ç« è´¡çŒ®æ¦‚è§ˆé¢æ¿ æœ¬ç«™æ¨èç´¢å¼• åšå®¢ä¸»é¢˜ç›¸å…³ github Issue ä½œä¸ºåšå®¢å¾®å‹æ•°æ®åº“çš„åº”ç”¨ github pageç½‘ç«™cdnä¼˜åŒ–åŠ é€Ÿ åšå®¢æºç åˆ†äº« åšå®¢æ¢è‚¤çš„ä¸€ç§å®ç°æ–¹å¼æ€è·¯ åšå®¢ä¸­gitalkæœ€æ–°è¯„è®ºçš„è·å– åšå®¢å›¾ç‰‡ä¸Šä¼ picgoå·¥å…·githubå›¾ä¼ ä½¿ç”¨ å®‰è£…ã€éƒ¨åˆ†é…ç½®icarusä¸»é¢˜ä¸­æ–‡ç‰ˆ æŠ€æœ¯çŸ¥è¯†ç‚¹ Javaå¹¶å‘çŸ¥è¯†ç‚¹ æ³•å¾‹æ³•è§„ æ³•å¾‹æ³•è§„æ•°æ®åº“ ä¸­åäººæ°‘å…±å’Œå›½å›½æ——æ³• ä¸­åäººæ°‘å…±å’Œå›½å®ªæ³• ä¸­åäººæ°‘å…±å’Œå›½æ¶ˆè´¹è€…æƒç›Šä¿æŠ¤æ³• ä¸­åäººæ°‘å…±å’Œå›½åˆ‘äº‹è¯‰è®¼æ³• ä¸­åäººæ°‘å…±å’Œå›½å©šå§»æ³• ä¸­åäººåå…±å’Œå›½ç½‘ç»œå®‰å…¨æ³• ä¸­åäººæ°‘å…±å’Œå›½åŠ³åŠ¨æ³• å…¶ä»– ç½‘æ˜“äº‘éŸ³ä¹æ­Œå•åˆ†äº« è®¡åˆ’2020è®¡åˆ’ 2019.12.31 2020-GOALS è·‘ä¸¤ä¸‰åœºé©¬æ‹‰æ¾ 2019è®¡åˆ’ 2018.12.31/21:59:00-&gt;æ›´æ–°äº2019.12.31 2019-GOALS è´­ä¹°çš„ä¸“ä¸šä¹¦ç±è‡³å°‘çœ‹å®Œä¸€éï¼ˆå¹¶å‘ã€é‡æ„ã€è®¾è®¡æ¨¡å¼â€¦ï¼‰-&gt; 95% é¢å¤–ï¼š è¿½äº†å¾ˆå¤šå‰§ æ€»ç»“ï¼š æœ‰ä¼˜ç‚¹æœ‰ç¼ºç‚¹ï¼Œæ²¡åšæŒä¸‹æ¥çš„è¿˜æ˜¯å¤ªå¤šï¼Œè¿½äº†å¤ªå¤šå‰§ã€‚ä»¥åå¤šå­¦ä¹ ï¼Œå¤šæ€è€ƒï¼ æ—¶é—´è½´è®°å½•","link":"/about/index.html"},{"title":"","text":"ğŸˆğŸˆå¾®ç¬‘å¢™ğŸˆğŸˆ å½­å°è‹’ å”è‰ºæ˜• æä¸€æ¡ gakki å›¾ç‰‡æœé›†äºäº’è”ç½‘ï¼Œä¾µæƒè¯·ç•™è¨€ï¼Œé©¬ä¸Šå¤„ç†ğŸ˜Šã€‚","link":"/album/index.html"},{"title":"","text":"ç”³è¯·å‹é“¾é¡»çŸ¥ åŸåˆ™ä¸Šåªå’ŒæŠ€æœ¯ç±»åšå®¢äº¤æ¢ï¼Œä½†ä¸åŒ…æ‹¬å«æœ‰å’Œè‰²æƒ…ã€æš´åŠ›ã€æ”¿æ²»æ•æ„Ÿçš„ç½‘ç«™ã€‚ ä¸å’Œå‰½çªƒã€ä¾µæƒã€æ— è¯šä¿¡çš„ç½‘ç«™äº¤æ¢ï¼Œä¼˜å…ˆå’Œå…·æœ‰åŸåˆ›ä½œå“çš„ç½‘ç«™äº¤æ¢ã€‚ ç”³è¯·è¯·æä¾›ï¼šç«™ç‚¹åç§°ã€ç«™ç‚¹é“¾æ¥ã€ç«™ç‚¹æè¿°ã€logoæˆ–å¤´åƒï¼ˆä¸è¦è®¾ç½®é˜²ç›—é“¾ï¼‰ã€‚ æ’åä¸åˆ†å…ˆåï¼Œåˆ·æ–°åé‡æ’ï¼Œæ›´æ–°ä¿¡æ¯åè¯·ç•™è¨€å‘ŠçŸ¥ã€‚ ä¼šå®šæœŸæ¸…ç†å¾ˆä¹…å¾ˆä¹…ä¸æ›´æ–°çš„ã€ä¸ç¬¦åˆè¦æ±‚çš„å‹é“¾ï¼Œä¸å†å¦è¡Œé€šçŸ¥ã€‚ æœ¬ç«™ä¸å­˜å‚¨å‹é“¾å›¾ç‰‡ï¼Œå¦‚æœå‹é“¾å›¾ç‰‡æ¢äº†æ— æ³•æ›´æ–°ã€‚å›¾ç‰‡è£‚äº†çš„ä¼šæ›¿æ¢æˆé»˜è®¤å›¾ï¼Œéœ€è¦æ›´æ¢çš„è¯·ç•™è¨€å‘ŠçŸ¥ã€‚ æœ¬ç«™å‹é“¾ä¿¡æ¯å¦‚ä¸‹ï¼Œç”³è¯·å‹é“¾å‰è¯·å…ˆæ·»åŠ æœ¬ç«™ä¿¡æ¯ï¼š ç½‘ç«™å›¾æ ‡ï¼šhttps://removeif.github.io/images/avatar.jpg ç½‘ç«™åç§°ï¼šè¾£æ¤’ã®é…± ç½‘ç«™åœ°å€ï¼šhttps://removeif.github.io ç½‘ç«™ç®€ä»‹ï¼šåç«¯å¼€å‘ï¼ŒæŠ€æœ¯åˆ†äº« åŠ è½½ä¸­ï¼Œç¨ç­‰å‡ ç§’...","link":"/friend/index.html"},{"title":"","text":"æ¥è€Œä¸å¾€éç¤¼ä¹Ÿç•…æ‰€æ¬²è¨€ï¼Œæœ‰ç•™å¿…åº”","link":"/message/index.html"},{"title":"","text":"ç¢ç¢å¿µ tipsï¼šgithubç™»å½•åæŒ‰æ—¶é—´æ­£åºæŸ¥çœ‹ã€å¯ç‚¹èµåŠ â¤ï¸ã€æœ¬æ’ä»¶åœ°å€..ã€Œ+99æ¬¡æŸ¥çœ‹ã€ ç¢ç¢å¿µåŠ è½½ä¸­ï¼Œè¯·ç¨ç­‰... $.getScript(\"/js/gitalk_self.min.js\", function () { var gitalk = new Gitalk({ clientID: '46a9f3481b46ea0129d8', clientSecret: '79c7c9cb847e141757d7864453bcbf89f0655b24', id: '666666', repo: 'issue_database', owner: 'removeif', admin: \"removeif\", createIssueManually: true, distractionFreeMode: false }); gitalk.render('comment-container1'); });","link":"/self-talking/index.html"},{"title":"","text":"&nbsp;&nbsp;å¬å¬éŸ³ä¹ éŸ³ä¹æ’­æ”¾å™¨ç”±mePlayeræä¾›ï¼Œå¸ƒå±€å‚ç…§ç½‘å‹åšå®¢æ‰€ä½œï¼Œæ„Ÿè°¢ä½œè€…çš„è¾›å‹¤ä»˜å‡ºã€‚æ›´å¤šéŸ³ä¹åˆ†äº«è¯·æŸ¥çœ‹æ­Œå•ã€‚ &nbsp;&nbsp;çœ‹çœ‹è§†é¢‘ ->ç‚¹å‡»ä»¥ä¸‹æ¡ç›®å¼€å§‹æ’­æ”¾è§†é¢‘,å‘ä¸‹æ»‘åŠ¨æŸ¥çœ‹æ›´å¤š","link":"/media/index.html"},{"title":"éŸ³ä¹æ­Œå•æ”¶è—","text":"æ¸©é¦¨æç¤ºï¼šé€‰æ‹©å–œæ¬¢çš„éŸ³ä¹åŒå‡»æ’­æ”¾ï¼Œç”±äºç‰ˆæƒåŸå› éƒ¨åˆ†ä¸èƒ½æ’­æ”¾ã€‚å¦‚æœå–œæ¬¢æ­Œå•æ”¶è—ä¸€ä¸‹ï¼Œå»ç½‘æ˜“äº‘éƒ½èƒ½æ’­æ”¾å“Ÿï¼","link":"/music/index.html"}],"posts":[{"title":"Activityå¯åŠ¨æ¨¡å¼","text":"ä»å››ä¸ªè§†è§’ç†è§£Android Activityå¯åŠ¨æ¨¡å¼ç³»ç»Ÿè§†è§’ï¼š 1. Androidçš„è½¯ä»¶ä½“ç³»ç»“æ„ 1.2 Task Activityä»£ç å±äºApplicationï¼Œä½†æ˜¯Taskå±äºAndroidæ“ä½œç³»ç»Ÿ Taskæ˜¯å¯ä»¥è·¨åº”ç”¨çš„ æ‰‹æœºæŸ¥çœ‹Taskï¼šï¼ˆç”¨æˆ·è§’åº¦ï¼‰æ‰‹æœºä¸­æŒ‰homeé”®æ—è¾¹é‚£ä¸ªæ–¹å½¢é”®ï¼ˆrecent-appsï¼‰æ—¶ï¼Œå±å¹•ä¸Šå±•ç¤ºçš„å°±æ˜¯ä¸€ä¸ªä¸ªtaskã€‚ ä»£ç ä¸­æŸ¥çœ‹Taskï¼šï¼ˆç¨‹åºè§’åº¦ï¼‰adb shell dumpsys activity activities | sed -En -e â€˜/Stack #/pâ€™ -e â€˜/Running activities/,/Run #0/pâ€™ sedå·¥å…·ä¸ç”¨å•ç‹¬ä¸‹è½½ï¼ŒD:\\soft\\Git\\usr\\bin\\sed.exe Gitå®‰è£…ç›®å½•ä¸‹åŒ…å«ï¼Œé…ç½®ä¸‹ç¯å¢ƒå˜é‡å°±å¯ä»¥ã€‚ ç”¨æˆ·è§†è§’ï¼š 2.1 Taskå¯åŠ¨æ–¹å¼(launcherå¯åŠ¨)Launcherå¯åŠ¨ 1ã€Taskä¸å­˜åœ¨ 2ã€Taskå­˜åœ¨ 2.2 Taskå¯åŠ¨æ–¹å¼ï¼ˆæ–°å»ºï¼‰1234Intent intent = new Intent(this, SecondActivity.class);intent.putExtra(&quot;message&quot;, &quot;message&quot;);intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK);startActivity(intent); é€šçŸ¥ï¼š 1.ç³»ç»Ÿé€šçŸ¥2.è‡ªå·± å…¶ä»–ç¬¬ä¸‰æ–¹åº”ç”¨ï¼š 1ã€Schemeåè®®2ã€ç¬¬ä¸‰æ–¹åº”ç”¨start launcher,æ–°å»º éƒ½æ˜¯é€šè¿‡startActivityæ¥åˆ›å»ºçš„ã€‚ 2.3 Taskå¯åŠ¨æ–¹å¼ï¼ˆæ¢å¤ï¼‰æ¢å¤ è¿™å±äºActivityç”Ÿå‘½å‘¨æœŸç”±ä¸å¯è§åˆ°è·å¾—ç„¦ç‚¹çš„èŒƒç•´ ç¨‹åºè§†è§’ï¼š 3.1 Activityå’ŒFragmentFragmentæ˜¯Android3.0åå¼•å…¥çš„ä¸€ä¸ªæ–°çš„APIï¼Œä»–å‡ºç°çš„åˆè¡·æ˜¯ä¸ºäº†é€‚åº”å¤§å±å¹•çš„å¹³æ¿ç”µè„‘ï¼Œ å½“ç„¶ç°åœ¨ä»–ä»ç„¶æ˜¯å¹³æ¿APP UIè®¾è®¡çš„å® å„¿ï¼Œè€Œä¸”æˆ‘ä»¬æ™®é€šæ‰‹æœºå¼€å‘ä¹Ÿä¼šåŠ å…¥è¿™ä¸ªFragmentï¼Œ æˆ‘ä»¬å¯ä»¥æŠŠä»–çœ‹æˆä¸€ä¸ªå°å‹çš„Activityï¼Œåˆç§°Activityç‰‡æ®µï¼ 3.2 Activityçš„ç”Ÿå‘½å‘¨æœŸ Activityæ˜¯å¦å¯è§ï¼š PS:Fragmentç”Ÿå‘½å‘¨æœŸ Activityä¸Fragmentç”Ÿå‘½å‘¨æœŸ 3.3 ç›¸é‚»çŠ¶æ€ä¹‹é—´çš„åŒºåˆ« Aå¯åŠ¨B å’Œ Bè¿”å›A 1.onCreateå’ŒonStartä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ï¼ˆ1ï¼‰å¯è§ä¸ä¸å¯è§çš„åŒºåˆ«ã€‚å‰è€…ä¸å¯è§ï¼Œåè€…å¯è§ã€‚ï¼ˆ2ï¼‰æ‰§è¡Œæ¬¡æ•°çš„åŒºåˆ«ã€‚onCreateæ–¹æ³•åªåœ¨Activityåˆ›å»ºæ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œè€ŒonStartæ–¹æ³•åœ¨Activityçš„åˆ‡æ¢ä»¥åŠæŒ‰Homeé”®è¿”å›æ¡Œé¢å†åˆ‡å›åº”ç”¨çš„è¿‡ç¨‹ä¸­è¢«å¤šæ¬¡è°ƒç”¨ã€‚å› æ­¤Bundleæ•°æ®çš„æ¢å¤åœ¨onStartä¸­è¿›è¡Œæ¯”onCreateä¸­æ‰§è¡Œæ›´åˆé€‚ã€‚ ï¼ˆ3ï¼‰onCreateèƒ½åšçš„äº‹onStartå…¶å®éƒ½èƒ½åšï¼Œä½†æ˜¯onstartèƒ½åšçš„äº‹onCreateå´æœªå¿…é€‚åˆåšã€‚å¦‚å‰æ–‡æ‰€è¯´çš„ï¼ŒsetContentViewå’Œèµ„æºåˆå§‹åŒ–åœ¨ä¸¤è€…éƒ½èƒ½åšï¼Œç„¶è€Œæƒ³åŠ¨ç”»çš„åˆå§‹åŒ–åœ¨onStartä¸­åšæ¯”è¾ƒå¥½ã€‚ 2.onStartæ–¹æ³•å’ŒonResumeæ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ï¼ˆ1ï¼‰æ˜¯å¦åœ¨å‰å°ã€‚onStartæ–¹æ³•ä¸­Activityå¯è§ä½†ä¸åœ¨å‰å°ï¼Œä¸å¯äº¤äº’ï¼Œè€Œåœ¨onResumeä¸­åœ¨å‰å°ã€‚ï¼ˆ2ï¼‰èŒè´£ä¸åŒï¼ŒonStartæ–¹æ³•ä¸­ä¸»è¦è¿˜æ˜¯è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œè€ŒonResumeæ–¹æ³•ï¼Œæ ¹æ®å®˜æ–¹çš„å»ºè®®ï¼Œå¯ä»¥åšå¼€å¯åŠ¨ç”»å’Œç‹¬å è®¾å¤‡çš„æ“ä½œã€‚ 3.onPauseæ–¹æ³•å’ŒonStopæ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ ï¼ˆ1ï¼‰æ˜¯å¦å¯è§ã€‚onPauseæ—¶Activityå¯è§ï¼ŒonStopæ—¶Activityä¸å¯è§ï¼Œä½†Activityå¯¹è±¡è¿˜åœ¨å†…å­˜ä¸­ã€‚ï¼ˆ2ï¼‰åœ¨ç³»ç»Ÿå†…å­˜ä¸è¶³çš„æ—¶å€™å¯èƒ½ä¸ä¼šæ‰§è¡ŒonStopæ–¹æ³•ï¼Œå› æ­¤ç¨‹åºçŠ¶æ€çš„ä¿å­˜ã€ç‹¬å è®¾å¤‡å’ŒåŠ¨ç”»çš„å…³é—­ã€ä»¥åŠä¸€äº›æ•°æ®çš„ä¿å­˜æœ€å¥½åœ¨onPauseä¸­è¿›è¡Œï¼Œä½†è¦æ³¨æ„ä¸èƒ½å¤ªè€—æ—¶ã€‚ 4.onStopæ–¹æ³•å’ŒonDestroyæ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ onStopé˜¶æ®µActivityè¿˜æ²¡æœ‰è¢«é”€æ¯ï¼Œå¯¹è±¡è¿˜åœ¨å†…å­˜ä¸­ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡åˆ‡æ¢Activityå†æ¬¡å›åˆ°è¯¥Activityï¼Œè€ŒonDestroyé˜¶æ®µAcivityè¢«é”€æ¯ **PS:**é—ªå±é¡µï¼šåœ¨onStop()æ–¹æ³•ä¸­è¿›è¡Œfinish(); 3.4 onNewIntentçš„ç”Ÿå‘½å‘¨æœŸ 1ã€åªå¯¹singleTopï¼ŒsingleTaskï¼ŒsingleInstanceæœ‰æ•ˆï¼Œå› ä¸ºstandardæ¯æ¬¡éƒ½æ˜¯æ–°å»º(ä¸æ˜¯ç»å¯¹ï¼Œä½¿ç”¨äº†Intent.FLAG_ACTIVITY_NEW_TASK,è¦å¯åŠ¨çš„Activityå·²ç»æœ‰Taskåœ¨è¿è¡Œäº†ï¼Œæ–°çš„activityä¸ä¼šå†åˆ›å»ºï¼Œè€Œæ˜¯æŠŠå½“å‰å †æ ˆçš„activityå¸¦åˆ°å‰å°)ï¼Œæ‰€ä»¥ä¸å­˜åœ¨onNewIntentï¼› 2ã€åªå¯¹startActivityæœ‰æ•ˆï¼Œå¯¹äºä»Navigationåˆ‡æ¢å›æ¥çš„æ¢å¤æ— æ•ˆï¼› 4.1 Activityå¯åŠ¨æ¨¡å¼ 4.2 standardå¯åŠ¨æ¨¡å¼1ã€standard é»˜è®¤æ¨¡å¼ ç³»ç»Ÿåœ¨å¯åŠ¨ Activity çš„ä»»åŠ¡ä¸­åˆ›å»º Activity çš„æ–°å®ä¾‹å¹¶å‘å…¶ä¼ é€ Intentã€‚Activity å¯ä»¥å¤šæ¬¡å®ä¾‹åŒ–ï¼Œä¸ç®¡è¿™ä¸ªå®ä¾‹æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œè€Œæ¯ä¸ªå®ä¾‹å‡å¯å±äºä¸åŒçš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¸€ä¸ªä»»åŠ¡å¯ä»¥æ‹¥æœ‰å¤šä¸ªå®ä¾‹ã€‚è¿™ç§æ¨¡å¼çš„ Activity è¢«åˆ›å»ºæ—¶å®ƒçš„ onCreateã€onStart éƒ½ä¼šè¢«è°ƒç”¨ã€‚è¿™æ˜¯ä¸€ç§å…¸å‹çš„å¤šå®ä¾‹å®ç°ï¼Œä¸€ä¸ªä»»åŠ¡æ ˆä¸­å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹ä¹Ÿå¯ä»¥å±äºä¸åŒçš„ä»»åŠ¡æ ˆã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œè°å¯åŠ¨äº†è¿™ä¸ª Activityï¼Œé‚£ä¹ˆè¿™ä¸ª Activity å°±è¿è¡Œåœ¨å¯åŠ¨å®ƒçš„é‚£ä¸ª Activity æ‰€åœ¨çš„æ ˆä¸­ã€‚ aã€å½“ä»éActivityçš„contextå¯åŠ¨activityæ—¶ï¼Œéœ€è¦å¸¦new_taskçš„flagï¼› bã€å½“å¯åŠ¨ä¸€ä¸ªå¸¦æœ‰affinityçš„activityï¼Œå¦‚æœè¿™ä¸ªactivityå·²ç»æœ‰å®ä¾‹å­˜åœ¨è¯¥taskï¼Œåˆ™ä¸ä¼šé‡æ–°åˆ›å»ºï¼› cã€å¦‚æœä»åº”ç”¨å†…å¯åŠ¨çš„standard activityçš„Affinityå°±æ˜¯Appé»˜è®¤çš„Affinityï¼Œåˆ™ä¼šæ¯æ¬¡æ–°å»ºä¸€ä¸ªå®ä¾‹ï¼› 4.3 singleTopå¯åŠ¨æ¨¡å¼ä¸€ä¸ªsingleTop Activity çš„å®ä¾‹å¯ä»¥æ— é™å¤šï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯å¦‚æœåœ¨æ ˆé¡¶å·²ç»æœ‰ä¸€ä¸ªç›¸åŒç±»å‹çš„Activityå®ä¾‹ï¼ŒIntentä¸ä¼šå†åˆ›å»ºä¸€ä¸ªActivityï¼Œè€Œæ˜¯é€šè¿‡onNewIntent()è¢«å‘é€åˆ°ç°æœ‰çš„Activityã€‚ 4.4 singleTaskæ¨¡å¼è¿™æ˜¯ä¸€ç§å•å®ä¾‹æ¨¡å¼ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œåªè¦ Activity åœ¨ä¸€ä¸ªæ ˆä¸­å­˜åœ¨ï¼Œé‚£ä¹ˆå¤šæ¬¡å¯åŠ¨æ­¤ Activity éƒ½ä¸ä¼šé‡æ–°åˆ›å»ºå®ä¾‹ï¼Œå’Œ singleTopä¸€æ ·ï¼Œç³»ç»Ÿä¹Ÿä¼šå›è°ƒå…¶ onNewIntentã€‚å½“ä¸€ä¸ªå…·æœ‰ singleTask æ¨¡å¼çš„Activityè¯·æ±‚å¯åŠ¨åï¼Œæ¯”å¦‚ Activity Aï¼Œç³»ç»Ÿé¦–å…ˆä¼šå¯»æ‰¾æ˜¯å¦å­˜åœ¨ A æƒ³è¦çš„ä»»åŠ¡æ ˆï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±é‡æ–°åˆ›å»ºä¸€ä¸ªä»»åŠ¡æ ˆï¼Œç„¶ååˆ›å»º A çš„å®ä¾‹åæŠŠ A æ”¾åˆ°æ ˆä¸­ã€‚å¦‚æœå­˜åœ¨ A æ‰€éœ€çš„ä»»åŠ¡æ ˆï¼Œè¿™æ—¶è¦çœ‹ A æ˜¯å¦åœ¨æ ˆä¸­æœ‰å®ä¾‹å­˜åœ¨ï¼Œå¦‚æœæœ‰å®ä¾‹å­˜åœ¨ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¼šæŠŠ A è°ƒåˆ°æ ˆé¡¶å¹¶è°ƒç”¨å®ƒçš„ onNewIntent æ–¹æ³•ï¼Œå¦‚æœå®ä¾‹ä¸å­˜åœ¨ï¼Œå°±åˆ›å»º A çš„å®ä¾‹å¹¶æŠŠ A å‹å…¥æ ˆä¸­ ã€‚ ä¸éœ€è¦å…³æ³¨NEW_TASK 4.5 singleInstanceæ¨¡å¼ä¸ singleTask ç›¸åŒï¼Œåªæ˜¯ç³»ç»Ÿä¸ä¼šå°†ä»»ä½•å…¶ä»– Activity å¯åŠ¨åˆ°åŒ…å«å®ä¾‹çš„ä»»åŠ¡ä¸­ã€‚è¯¥ Activity å§‹ç»ˆæ˜¯å…¶ä»»åŠ¡å”¯ä¸€ä»…æœ‰çš„æˆå‘˜ï¼›ç”±æ­¤ Activity å¯åŠ¨çš„ä»»ä½• Activity å‡åœ¨å•ç‹¬çš„ä»»åŠ¡ä¸­æ‰“å¼€ã€‚ä¹Ÿå°±æ˜¯æœ‰æ­¤ç§æ¨¡å¼çš„ Activity åªèƒ½å•ç‹¬åœ°ä½äºä¸€ä¸ªä»»åŠ¡æ ˆä¸­ PSï¼š4ç§æ¨¡å¼åªèƒ½åœ¨AndroidManifest.xmlä¸­å®šä¹‰ï¼ˆå®šä¹‰å±‚å®šä¹‰çš„ï¼‰ 4.6 Intent Activity Flagå¯åŠ¨å±‚å®šä¹‰ 5.1 å¯åŠ¨æ¨¡å¼çš„åº”ç”¨åœºæ™¯ launchMode ä½¿ç”¨åœºæ™¯ singleTop é€‚åˆå¯åŠ¨åŒç±»å‹çš„ Activityï¼Œä¾‹å¦‚ï¼š â€¢æ¥æ”¶é€šçŸ¥å¯åŠ¨çš„å†…å®¹æ˜¾ç¤ºé¡µé¢ â€¢è€—æ—¶æ“ä½œè¿”å›é¡µé¢ â€¢ç™»å½•é¡µé¢ singleTask é€‚åˆä½œä¸ºç¨‹åºå…¥å£ï¼Œä¾‹å¦‚ï¼š â€¢WebViewé¡µé¢ â€¢æ‰«ä¸€æ‰«é¡µé¢ â€¢ç¡®è®¤è®¢å•ç•Œé¢ â€¢ä»˜æ¬¾ç•Œé¢ singleInstance é€‚åˆéœ€è¦ä¸ç¨‹åºåˆ†ç¦»å¼€çš„é¡µé¢ï¼Œä¾‹å¦‚ï¼š â€¢é—¹é“ƒçš„å“é“ƒç•Œé¢ â€¢æ¥ç”µé¡µé¢ â€¢é”å±é¡µ","link":"/2020/12/11/activity/"},{"title":"AndroidStudioå¼€å‘Gradleæ’ä»¶","text":"é¡¹ç›®ç»“æ„ï¼šgradlePlugin app src build.gradle buildSrc src main java com.lis.buildsrc MyPlugin.java build.gradle build.gradle ç®€å•çš„Gradleæ’ä»¶BuildSrcå¦‚æœå¼€å‘çš„æ’ä»¶ä»…ç”¨äºå½“å‰é¡¹ç›®ï¼Œä¸éœ€è¦å‘å¸ƒçš„è¯ï¼Œåªéœ€è¦æ³¨æ„ä¸¤ç‚¹: æ’ä»¶çš„Moduleåç§°å¿…é¡»æ˜¯buildSrc(å¼€å¤´ä¸€å®šè¦å°å†™) æ— é¡»resourcesç›®å½• build.gradleçš„é…ç½®ï¼š 123456789101112131415apply plugin:'java' apply plugin:'groovy' repositories { google() jcenter() } dependencies { implementation gradleApi() //gradle sdk implementation localGroovy() //groovy sdk implementation 'com.android.tools.build:gradle:3.6.3' } sourceCompatibility = &quot;1.7&quot; targetCompatibility = &quot;1.7&quot; è¿™é‡Œå¼•å…¥groovy sdkå’Œgradle sdk,å› ä¸ºå¼€å‘Androidæ’ä»¶ï¼Œè¿˜éœ€è¦Androidä¸“ç”¨çš„gradleï¼ˆè¿™é‡Œéœ€è¦ä½¿ç”¨åˆ°googleä»“åº“ï¼‰ ç„¶åæˆ‘ä»¬ç¼–å†™æ’ä»¶ï¼ŒMyPlugin: 12345678910111213import org.gradle.api.Plugin;import org.gradle.api.Project;import org.gradle.api.logging.Logger;public class MyPlugin implements Plugin&lt;Project&gt; { @Override public void apply(Project project) { Logger logger = project.getLogger(); logger.error(&quot;=====================&quot;); logger.error(&quot;æœ€ç®€å•çš„Gradleæ’ä»¶&quot;); logger.error(&quot;=====================&quot;); }} åœ¨appçš„build.gradleä¸­æ·»åŠ ä½ çš„æ’ä»¶ æ³¨æ„ï¼šè¿™é‡Œä¸åŠ â€™ â€˜å•å¼•å· 1apply plugin: com.lis.buildsrc.MyPlugin æ‰§è¡Œï¼š**Build-make Module â€˜appâ€™**ç”Ÿæˆè¡¥ä¸ã€‚ åœ¨åº•éƒ¨çš„ Buid-Build Outputä¸­ä¾¿å¯ä»¥çœ‹åˆ°æ‰“å°æ—¥å¿—ï¼š =====================ç®€å•çš„Gradleæ’ä»¶ ===================== æ’ä»¶çš„å‘å¸ƒå¦‚æœæƒ³å¤ç”¨ä½ çš„gradleæ’ä»¶ï¼Œå°±éœ€è¦æŠŠå®ƒå‘å¸ƒå‡ºå»ã€‚ å‘å¸ƒåˆ°æœ¬åœ°ä»“åº“ å‘å¸ƒåˆ°è¿œç¨‹ä»“åº“ æœ¬åœ°ä»“åº“é¡¹ç›®ç»“æ„ï¼š gradlePlugin app src build.gradle buildSrc src main java com.lis.buildsrc MyPlugin.java resources META-INF.gradle-plugins com.lis.myplugin.properties build.gradle build.gradle åœ¨buildSrcçš„mainæ–‡ä»¶å¤¹ä¸‹æ·»åŠ resourcesæ–‡ä»¶å¤¹ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ·»åŠ *META-INF**ï¼ŒMETA-INF*æ–‡ä»¶å¤¹ä¸‹æ·»åŠ **gradle-plugins åœ¨**gradle-plugins**ä¸­æ·»åŠ com.lis.myplugin.properties è¿™é‡Œå‘½åä¸º com.lis.myplugin.properties ï¼Œä¸€å®šè¦æ³¨æ„åç¼€åç§°ï¼Œé‚£ä¹ˆä½¿ç”¨æ’ä»¶æ—¶çš„åç§°å°±æ˜¯com.lis.mypluginï¼Œæ–‡ä»¶é‡Œé¢çš„å†…å®¹å¡«å†™å¦‚ä¸‹ï¼š 1implementation-class=com.lis.buildsrc.MyPlugin è¿™é‡ŒæŒ‡å®šçš„è·¯å¾„ä¸ºMyPluginçš„ç±»åï¼Œå³æ’ä»¶çš„å…¥å£ç±» buidSrcä¸­çš„build.gradleï¼Œæ·»åŠ mavenæ’ä»¶åŠå‘å¸ƒç”¨åˆ°çš„é…ç½® 123456789101112131415161718192021222324apply plugin:'java'apply plugin:'groovy'apply plugin: 'maven'repositories { google() jcenter()}tasks.withType(JavaCompile) { options.encoding = &quot;UTF-8&quot; } //ç¼–ç æ ¼å¼dependencies { implementation gradleApi() //gradle sdk implementation localGroovy() //groovy sdk implementation 'com.android.tools.build:gradle:3.6.3'}uploadArchives { repositories.mavenDeployer { repository(url: uri('../repo')) //ä»“åº“çš„è·¯å¾„ï¼Œæ­¤å¤„æ˜¯é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ repo çš„æ–‡ä»¶å¤¹ pom.groupId = 'com.lis.gradleplugin' //groupId ï¼Œè‡ªè¡Œå®šä¹‰ï¼Œä¸€èˆ¬æ˜¯åŒ…å pom.artifactId = 'myplugin' //artifactId ï¼Œè‡ªè¡Œå®šä¹‰ pom.version = '1.0.0' //version ç‰ˆæœ¬å· }}sourceCompatibility = &quot;1.7&quot;targetCompatibility = &quot;1.7&quot; åŒæ­¥ååœ¨gradleæ¨¡å—å†…ï¼Œä¼šå‡ºç°å‘å¸ƒæŒ‰é’® åŒå‡»uploadArchives ,æ’ä»¶å°±å‘å¸ƒåˆ°äº†æœ¬åœ°çš„mavenä»“åº“ï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¯åœ¨é¡¹ç›®çš„æ ¹ç›®å½•é‡Œï¼Œæ‰€ä»¥ä¼šåœ¨GradlePluginä¸‹ç”Ÿæˆrepoæ–‡ä»¶å¤¹åŠæ–‡ä»¶ ä½¿ç”¨æ’ä»¶: åœ¨GradlePluginæ ¹ç›®å½•çš„build.gradleä¸­æ·»åŠ æœ¬åœ°ä»“åº“åŠæ’ä»¶å¼•ç”¨ 123456789101112131415161718192021222324252627282930313233buildscript { repositories { google() jcenter() //é¦–å…ˆéœ€è¦é…ç½®æœ¬åœ°çš„ maven ä»“åº“åœ°å€ï¼Œè¿™é‡Œå¡«å†™çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¨è·¯å¾„ maven { url uri('./repo') } } dependencies { classpath 'com.android.tools.build:gradle:3.6.3' //ç„¶åï¼Œæ·»åŠ ä¾èµ–çš„æ’ä»¶ï¼Œå½¢å¼æ˜¯ groupIdï¼šartifactIdï¼šversion //è¿™äº›éƒ½æ˜¯æ’ä»¶å‘å¸ƒæ—¶ï¼Œå®šä¹‰çš„åç§° classpath 'com.lis.gradleplugin:myplugin:1.0.0' }}allprojects { repositories { google() jcenter() maven { url uri('./repo') } }}task clean(type: Delete) { delete rootProject.buildDir} æœ€åï¼Œåœ¨appçš„build.gradleé‡Œï¼Œæ·»åŠ æ’ä»¶ 123456789101112131415161718192021222324252627282930313233apply plugin: 'com.android.application'apply plugin: 'com.lis.myplugin'//è¿™é‡Œå°±å¡«å†™ .properties æ–‡ä»¶çš„åç§°android { compileSdkVersion 29 buildToolsVersion &quot;29.0.3&quot; defaultConfig { applicationId &quot;com.lis.gradleplugin&quot; minSdkVersion 21 targetSdkVersion 29 versionCode 1 versionName &quot;1.0&quot; testInstrumentationRunner &quot;androidx.test.runner.AndroidJUnitRunner&quot; } buildTypes { release { minifyEnabled false proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro' } }}dependencies { implementation fileTree(dir: 'libs', include: ['*.jar']) implementation 'androidx.appcompat:appcompat:1.1.0' implementation 'androidx.constraintlayout:constraintlayout:1.1.3' testImplementation 'junit:junit:4.12' androidTestImplementation 'androidx.test.ext:junit:1.1.1' androidTestImplementation 'androidx.test.espresso:espresso-core:3.2.0'} apply plugin: 'com.lis.myplugin'è¿™é‡Œçš„com.lis.mypluginå³æˆ‘ä»¬ä¸Šé¢com.lis.myplugin.propertiesæ–‡ä»¶çš„åç§° è¿™å°±å®Œæˆäº†æœ¬åœ°ä»“åº“çš„æ’ä»¶ä½¿ç”¨ï¼","link":"/2020/12/08/gradle/"},{"title":"Hello World","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot; More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","link":"/2020/12/08/hello-world/"},{"title":"Viewäº‹ä»¶åˆ†å‘","text":"ç›®å½• MotionEvent äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸æ¶ˆè´¹ æ€»æµç¨‹ onTouchå’ŒonClick æºç åˆ†æï¼š View.dispatchTouchEvent æ€»ç»“ï¼š äº‹ä»¶åˆ†å‘æºç è§£æï¼š äº‹ä»¶ï¼šACTION_DOWN 1.å‡è®¾onInterceptTouchEventæ²¡æœ‰æ‹¦æˆªï¼Œè¿™é‡Œinterceptedä¸ºfalse; 2.å‡è®¾onInterceptTouchEventç›´æ¥æ‹¦æˆªï¼Œè¿™é‡Œinterceptedä¸ºtrue; æ€»ç»“ï¼š äº‹ä»¶ï¼šACTION_MOVE 1.å‡è®¾onInterceptTouchEventæ²¡æœ‰æ‹¦æˆª æ€»ç»“ï¼š äº‹ä»¶å†²çª ViewGroup#onInterceptTouchEvent å†²çªè§£å†³ï¼š å†…éƒ¨æ‹¦æˆªæ³•ï¼ˆåœ¨å­Viewä¸­è§£å†³ï¼‰ å†…éƒ¨æ‹¦æˆªæ³•æ€»ç»“ï¼š å¤–éƒ¨æ‹¦æˆªæ³•ï¼ˆåœ¨çˆ¶Viewä¸­è§£å†³ï¼‰ MotionEvent äº‹ä»¶åˆ†å‘ã€æ‹¦æˆªä¸æ¶ˆè´¹ äº‹ä»¶åˆ†å‘ï¼šActivityï¼ŒViewGroupï¼Œ View äº‹ä»¶æ‹¦æˆªï¼š ViewGroup äº‹ä»¶æ¶ˆè´¹ï¼šActivityï¼Œ View æ€»æµç¨‹ onTouchå’ŒonClick12345678910111213textView.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { Log.e(&quot;Text&quot;, &quot;onClick&quot;); }});textView.setOnTouchListener(new View.OnTouchListener() { @Override public boolean onTouch(View v, MotionEvent event) { Log.e(&quot;Text&quot;, &quot;onTouch&quot;+event.getAction()); return false; }}); æºç åˆ†æï¼šView.dispatchTouchEvent12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455public boolean dispatchTouchEvent(MotionEvent event) { // If the event should be handled by accessibility focus first. if (event.isTargetAccessibilityFocus()) { // We don't have focus or no virtual descendant has it, do not handle the event. if (!isAccessibilityFocusedViewOrHost()) { return false; } // We have focus and got the event, then use normal event dispatch. event.setTargetAccessibilityFocus(false); } boolean result = false; if (mInputEventConsistencyVerifier != null) { mInputEventConsistencyVerifier.onTouchEvent(event, 0); } final int actionMasked = event.getActionMasked(); if (actionMasked == MotionEvent.ACTION_DOWN) { // Defensive cleanup for new gesture stopNestedScroll(); } if (onFilterTouchEventForSecurity(event)) { if ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) { result = true; } //noinspection SimplifiableIfStatement ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnTouchListener != null &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; li.mOnTouchListener.onTouch(this, event)) { result = true; } if (!result &amp;&amp; onTouchEvent(event)) { result = true; } } if (!result &amp;&amp; mInputEventConsistencyVerifier != null) { mInputEventConsistencyVerifier.onUnhandledEvent(event, 0); } // Clean up after nested scrolls if this is the end of a gesture; // also cancel it if we tried an ACTION_DOWN but we didn't want the rest // of the gesture. if (actionMasked == MotionEvent.ACTION_UP || actionMasked == MotionEvent.ACTION_CANCEL || (actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) { stopNestedScroll(); } return result;} 123456ListenerInfo li = mListenerInfo;if (li != null &amp;&amp; li.mOnTouchListener != null &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; li.mOnTouchListener.onTouch(this, event)) { result = true;} è¿™é‡Œliä¸ç­‰äºç©º åœ¨view.setOnTouchListeneræˆ–setOnClickListenerè°ƒç”¨æ—¶ éƒ½ä¼šè°ƒç”¨getListenerInfo()æ–¹æ³• 123public void setOnTouchListener(OnTouchListener l) { getListenerInfo().mOnTouchListener = l;} 1234567ListenerInfo getListenerInfo() { if (mListenerInfo != null) { return mListenerInfo; } mListenerInfo = new ListenerInfo(); return mListenerInfo;} æ‰€ä»¥è¿™é‡Œliè‚¯å®šä¸ä¸ºç©º (mViewFlags &amp; ENABLED_MASK) == ENABLEDè¿™é‡Œä»£è¡¨å¯viewå¯ç”¨çŠ¶æ€ æ‰€ä»¥li.mOnTouchListener.onTouch(this, event)è¿™é‡Œå¦‚æœè¿”å›ä¸º ä¸ºtrueæ—¶ result=true 123if (!result &amp;&amp; onTouchEvent(event)) { result = true;} æ‰€ä»¥è¿™é‡Œçš„onTouchEvent(event)æ–¹æ³•å°±ä¸ä¼šå†èµ°ã€‚ onTouchEventä¸­ 1234567891011public boolean onTouchEvent(MotionEvent event) { final float x = event.getX(); final float y = event.getY(); final int viewFlags = mViewFlags; final int action = event.getAction(); ... case MotionEvent.ACTION_UP: if (!post(mPerformClick)) { performClickInternal(); }} performClickInternalâ€“&gt;performClick 123456789101112131415161718192021public boolean performClick() { // We still need to call this method to handle the cases where performClick() was called // externally, instead of through performClickInternal() notifyAutofillManagerOnClick(); final boolean result; final ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnClickListener != null) { playSoundEffect(SoundEffectConstants.CLICK); li.mOnClickListener.onClick(this); result = true; } else { result = false; } sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED); notifyEnterOrExitForAutoFillIfNeeded(true); return result;} è¿™é‡Œ li.mOnClickListener.onClick(this);è°ƒç”¨äº†onClickæ–¹æ³•ï¼Œå¹¶è¿”å›true æ€»ç»“ï¼šonTouchè¿”å›fasleæ—¶ï¼Œè°ƒç”¨onTouchEvent,å†åˆ°onClick onTouchè¿”å›trueæ—¶ï¼Œä¸è°ƒç”¨onTouchEventå’ŒonClick onTouch=falseâ€”-&gt;onTouchEventâ€”-&gt;onClick onTouch=true ç»“æŸ äº‹ä»¶åˆ†å‘æºç è§£æï¼šActivity#dispatchTouchEvent 123456789public boolean dispatchTouchEvent(MotionEvent ev) { if (ev.getAction() == MotionEvent.ACTION_DOWN) { onUserInteraction(); } if (getWindow().superDispatchTouchEvent(ev)) { return true; } return onTouchEvent(ev);} getWindow().superDispatchTouchEvent(ev)â€“&gt;PhoneWindow#superDispatchTouchEvent 123public boolean superDispatchTouchEvent(MotionEvent event) { return mDecor.superDispatchTouchEvent(event);} mDecor.superDispatchTouchEvent(event)â€“&gt;DecorView#superDispatchTouchEvent 123public boolean superDispatchTouchEvent(MotionEvent event) { return super.dispatchTouchEvent(event);} è¿™é‡Œçš„dispatchTouchEventâ€“&gt;ViewGroup#dispatchTouchEvent äº‹ä»¶ï¼šACTION_DOWNä¸€è¿›å…¥downå°±ä¼šæ¸…é™¤äº‹ä»¶å’ŒçŠ¶æ€ 1234567if (actionMasked == MotionEvent.ACTION_DOWN) { // Throw away all previous state when starting a new touch gesture. // The framework may have dropped the up or cancel event for the previous gesture // due to an app switch, ANR, or some other state change. cancelAndClearTouchTargets(ev); resetTouchState();} æ˜¯å¦æ‹¦æˆªçš„æ ‡è¯† 1final boolean intercepted; 1.å‡è®¾onInterceptTouchEventæ²¡æœ‰æ‹¦æˆªï¼Œè¿™é‡Œinterceptedä¸ºfalse;1234@Overridepublic boolean onInterceptTouchEvent(MotionEvent ev) { return false;} 1234567891011121314if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // restore action in case it was changed } else { intercepted = false; }} else { // There are no touch targets and this action is not an initial down // so this view group continues to intercept touches. intercepted = true;} 12final boolean canceled = resetCancelNextUpFlag(this) || actionMasked == MotionEvent.ACTION_CANCEL; å‡è®¾è¿™é‡Œçš„canceledä¹Ÿä¸ºfalse(æ²¡æœ‰å–æ¶ˆ) æ‰€ä»¥è¿›å…¥äº†è¿™é‡Œ 123456789101112131415161718192021TouchTarget newTouchTarget = null;boolean alreadyDispatchedToNewTouchTarget = false;if (!canceled &amp;&amp; !intercepted) { View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus() ? findChildWithAccessibilityFocus() : null; if (actionMasked == MotionEvent.ACTION_DOWN || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN) || actionMasked == MotionEvent.ACTION_HOVER_MOVE) { final int actionIndex = ev.getActionIndex(); // always 0 for down final int idBitsToAssign = split ? 1 &lt;&lt; ev.getPointerId(actionIndex) : TouchTarget.ALL_POINTER_IDS; // Clean up earlier touch targets for this pointer id in case they // have become out of sync. removePointersFromTouchTargets(idBitsToAssign); final int childrenCount = mChildrenCount; if (newTouchTarget == null &amp;&amp; childrenCount != 0) { } } è¿™é‡ŒnewTouchTargetä¸ºnull,å¹¶ä¸”childrenCountä¹Ÿä¸å¯èƒ½ä¸º0 if (newTouchTarget == null &amp;&amp; childrenCount != 0)ä¸­ 1final ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList(); buildTouchDispatchChildList()æ–¹æ³•å¯¹å­Viewè¿›è¡Œæ’åº 12345678910111213for (int i = 0; i &lt; childrenCount; i++) { // add next child (in child order) to end of list final int childIndex = getAndVerifyPreorderedIndex(childrenCount, i, customOrder); final View nextChild = mChildren[childIndex]; final float currentZ = nextChild.getZ(); // insert ahead of any Views with greater Z int insertIndex = i; while (insertIndex &gt; 0 &amp;&amp; mPreSortedChildren.get(insertIndex - 1).getZ() &gt; currentZ) { insertIndex--; } mPreSortedChildren.add(insertIndex, nextChild);} è¿™é‡ŒZè½´è¶Šå¤§è¶Šåœ¨æ•°ç»„åé¢ï¼Œè¶Šå°è¶Šåœ¨æ•°ç»„å‰é¢ï¼ˆé¡µé¢ä¸ŠViewè¶Šåœ¨ä¸Šå±‚è¶Šåœ¨æ•°ç»„åé¢ï¼Œè¶Šåº•å±‚è¶Šåœ¨æ•°ç»„å‰é¢ï¼‰ â€‹ è¿™é‡Œä»æ’å¥½åºçš„preorderedListä¸­ï¼Œä»æœ€åå¾€å‰å–å€¼ï¼ˆå³å…ˆå–zè½´æœ€ä¸Šå±‚çš„viewï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758for (int i = childrenCount - 1; i &gt;= 0; i--) { final int childIndex = getAndVerifyPreorderedIndex( childrenCount, i, customOrder); final View child = getAndVerifyPreorderedView( preorderedList, children, childIndex); // If there is a view that has accessibility focus we want it // to get the event first and if not handled we will perform a // normal dispatch. We may do a double iteration but this is // safer given the timeframe. if (childWithAccessibilityFocus != null) { if (childWithAccessibilityFocus != child) { continue; } childWithAccessibilityFocus = null; i = childrenCount - 1; } if (!child.canReceivePointerEvents() || !isTransformedTouchPointInView(x, y, child, null)) { ev.setTargetAccessibilityFocus(false); continue; } newTouchTarget = getTouchTarget(child); if (newTouchTarget != null) { // Child is already receiving touch within its bounds. // Give it the new pointer in addition to the ones it is handling. newTouchTarget.pointerIdBits |= idBitsToAssign; break; } resetCancelNextUpFlag(child); if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) { // Child wants to receive touch within its bounds. mLastTouchDownTime = ev.getDownTime(); if (preorderedList != null) { // childIndex points into presorted list, find original index for (int j = 0; j &lt; childrenCount; j++) { if (children[childIndex] == mChildren[j]) { mLastTouchDownIndex = j; break; } } } else { mLastTouchDownIndex = childIndex; } mLastTouchDownX = ev.getX(); mLastTouchDownY = ev.getY(); newTouchTarget = addTouchTarget(child, idBitsToAssign); alreadyDispatchedToNewTouchTarget = true; break; } // The accessibility focus didn't handle the event, so clear // the flag and do a normal dispatch to all children. ev.setTargetAccessibilityFocus(false);} è¿™é‡Œåˆ¤æ–­å–åˆ°çš„Viewæ˜¯ä¸æ˜¯ç‚¹å‡»åˆ°çš„Viewï¼ˆåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿæ¥æ”¶æ‰‹æŒ‡äº‹ä»¶å’Œç‚¹å‡»åŒºåŸŸæ˜¯ä¸æ˜¯åœ¨Viewä¸Šï¼‰ ä¸æ˜¯çš„è¯ç»§ç»­å¾ªç¯æ‹¿å– 12345if (!child.canReceivePointerEvents() || !isTransformedTouchPointInView(x, y, child, null)) { ev.setTargetAccessibilityFocus(false); continue;} View.java 123protected boolean canReceivePointerEvents() { return (mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || getAnimation() != null;} 12345678910111213protected boolean isTransformedTouchPointInView(float x, float y, View child, PointF outLocalPoint) { final float[] point = getTempPoint(); point[0] = x; point[1] = y; transformPointToViewLocal(point, child); // pointInViewï¼šx &gt;= 0 &amp;&amp; localY &gt;= 0 &amp;&amp; y &lt; ((mRight - mLeft) + 0) &amp;&amp;y &lt; ((mBottom - mTop) + 0) åˆ¤æ–­è§¦ç‚¹æ˜¯å¦åœ¨Viewä¸Š final boolean isInView = child.pointInView(point[0], point[1]); if (isInView &amp;&amp; outLocalPoint != null) { outLocalPoint.set(point[0], point[1]); } return isInView;} 1234public boolean pointInView(float localX, float localY, float slop) { return localX &gt;= -slop &amp;&amp; localY &gt;= -slop &amp;&amp; localX &lt; ((mRight - mLeft) + slop) &amp;&amp; localY &lt; ((mBottom - mTop) + slop);} è¿™é‡Œè·å–TouchTargetï¼Œè¿™é‡Œè¿”å›çš„è¿˜æ˜¯ç©ºï¼Œå› ä¸ºmFirstTouchTargetåˆå§‹ä¸ºç©º 1newTouchTarget = getTouchTarget(child); 12345678private TouchTarget getTouchTarget(@NonNull View child) { for (TouchTarget target = mFirstTouchTarget; target != null; target = target.next) { if (target.child == child) { return target; } } return null;} dispatchTransformedTouchEvent â€“åˆ†å‘ç»™è°å¤„ç†äº‹ä»¶ 1dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign) 1234567891011121314151617181920212223private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel, View child, int desiredPointerIdBits) { final boolean handled; ... if (child == null) { handled = super.dispatchTouchEvent(transformedEvent); } else { final float offsetX = mScrollX - child.mLeft; final float offsetY = mScrollY - child.mTop; transformedEvent.offsetLocation(offsetX, offsetY); if (! child.hasIdentityMatrix()) { transformedEvent.transform(child.getInverseMatrix()); } handled = child.dispatchTouchEvent(transformedEvent); } // Done. transformedEvent.recycle(); return handled;} è¿™é‡Œchildä¸ä¸ºç©ºï¼Œæ‰€ä»¥å°±ä¼šè°ƒç”¨child.dispatchTouchEvent(transformedEvent)â€“&gt;å°±åˆ°äº†ä¸Šæ–‡onTouchå’ŒonClickçš„æºç åˆ†æView.dispatchTouchEvent View.dispatchTouchEventå¤„ç†äº‹ä»¶åï¼Œè¿”å›resultä¸ºtrue 123if (!result &amp;&amp; onTouchEvent(event)) { result = true;} å°±è¿›å…¥ifï¼Œç„¶åbreak;ç»“æŸæ•´ä¸ªforå¾ªç¯ï¼Œå…¶ä»–viewå°±å¤„ç†ä¸äº†äº‹ä»¶äº†ã€‚ 1234567891011121314151617181920if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) { mLastTouchDownTime = ev.getDownTime(); if (preorderedList != null) { // childIndex points into presorted list, find original index for (int j = 0; j &lt; childrenCount; j++) { if (children[childIndex] == mChildren[j]) { mLastTouchDownIndex = j; break; } } } else { mLastTouchDownIndex = childIndex; } mLastTouchDownX = ev.getX(); mLastTouchDownY = ev.getY(); newTouchTarget = addTouchTarget(child, idBitsToAssign); alreadyDispatchedToNewTouchTarget = true; break;} è¿™é‡Œä¼šè°ƒç”¨addTouchTarget(),è¿›è¡ŒnewTouchTargetèµ‹å€¼ã€‚ 123456private TouchTarget addTouchTarget(@NonNull View child, int pointerIdBits) { final TouchTarget target = TouchTarget.obtain(child, pointerIdBits); target.next = mFirstTouchTarget; mFirstTouchTarget = target; return target;} mFirstTouchTarget==newTouchTargetå¹¶ä¸”alreadyDispatchedToNewTouchTarget=true; å¦‚æœæ²¡æœ‰å¤„ç†ï¼Œå½“å‰å¾ªç¯å°±ç»“æŸäº†ï¼Œ è¿›è¡Œä¸‹ä¸€æ¬¡çš„forå¾ªç¯ã€‚ ç»§ç»­å¾€ä¸‹èµ°ï¼šè¿›å…¥elseäº† 12345678910111213141516171819202122232425262728293031323334if (mFirstTouchTarget == null) { handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS);} else { TouchTarget predecessor = null; TouchTarget target = mFirstTouchTarget; while (target != null) { final TouchTarget next = target.next; if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } else { final boolean cancelChild = resetCancelNextUpFlag(target.child) || intercepted; if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) { handled = true; } if (cancelChild) { if (predecessor == null) { mFirstTouchTarget = next; } else { predecessor.next = next; } target.recycle(); target = next; continue; } } predecessor = target; target = next; }} 1final TouchTarget next = target.next; è¿™é‡Œçš„nextä¸ºnullï¼Œæœ€åtarget = next; æ‰€ä»¥è¿™é‡Œçš„whileå¾ªç¯åªä¼šè¿›å…¥ä¸€æ¬¡ã€‚ï¼ˆè¿™é‡Œwhileæ˜¯ä¸ºå¤šæŒ‡è§¦æ‘¸å‡†å¤‡çš„ï¼Œå‡ ä¸ªæ‰‹æŒ‡å°±ä¼šå¾ªç¯å‡ æ¬¡ï¼‰ 123if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } è¿™é‡Œéƒ½æ»¡è¶³æ‰€ä»¥handledä¸ºtrue æœ€åè¿”å› handledã€‚æ•´ä¸ªDownäº‹ä»¶å°±ç»“æŸäº†ã€‚ 2.å‡è®¾onInterceptTouchEventç›´æ¥æ‹¦æˆªï¼Œè¿™é‡Œinterceptedä¸ºtrue;1234@Overridepublic boolean onInterceptTouchEvent(MotionEvent ev) { return true;} 1234567891011121314if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // restore action in case it was changed } else { intercepted = false; }} else { // There are no touch targets and this action is not an initial down // so this view group continues to intercept touches. intercepted = true;} 123if (!canceled &amp;&amp; !intercepted) { ...} è¿™é‡Œæ•´ä¸ªifè¯­å¥éƒ½ ä¸ä¼šè¿›å…¥ è€Œä¸”è¿™é‡Œæ‹¦æˆªäº†ä»¥åï¼ŒViewGroupçš„å­Viewå°±ä¸å†å¾€ä¸‹åˆ†å‘äº‹ä»¶ï¼ˆåˆ†å‘æ˜¯åœ¨è¿™ä¸ªifä¸­forå¾ªç¯ä¸­åˆ†å‘çš„ï¼‰ è¿™é‡ŒmFirstTouchTargetä¸ºnullï¼Œ 12345if (mFirstTouchTarget == null) { // No touch targets so treat this as an ordinary view. handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS);} è¿™é‡Œçš„childä¸ºnullä¼ å…¥ 1234567891011121314151617private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel, View child, int desiredPointerIdBits) { final boolean handled;... // Perform any necessary transformations and dispatch. if (child == null) { handled = super.dispatchTouchEvent(transformedEvent); } else { final float offsetX = mScrollX - child.mLeft; final float offsetY = mScrollY - child.mTop; transformedEvent.offsetLocation(offsetX, offsetY); if (! child.hasIdentityMatrix()) { transformedEvent.transform(child.getInverseMatrix()); } handled = child.dispatchTouchEvent(transformedEvent); } æ‰€ä»¥ä¼šè°ƒç”¨super.dispatchTouchEvent(transformedEvent); å³è°ƒç”¨ViewGroupè‡ªå·±çš„dispatchTouchEventæ–¹æ³•æ¥å¤„ç† æ€»ç»“ï¼šå½“ViewGroup#onInterceptTouchEventä¸ºfalseæ—¶ï¼Œå°±ä¼šè°ƒç”¨å­Viewçš„dispatchTouchEvent å½“ViewGroup#onInterceptTouchEventä¸ºtrueæ—¶ï¼Œå°±ä¼šè°ƒç”¨è‡ªèº«çš„dispatchTouchEvent äº‹ä»¶ï¼šACTION_MOVE1.å‡è®¾onInterceptTouchEventæ²¡æœ‰æ‹¦æˆªè¿™é‡ŒmFirstTouchTargetç»è¿‡Downäº‹ä»¶åä¸ä¸ºnull,æ‰€ä»¥interceptedä¸ºfalse 1234567891011121314if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // restore action in case it was changed } else { intercepted = false; }} else { // There are no touch targets and this action is not an initial down // so this view group continues to intercept touches. intercepted = true;} è¿›å…¥ä¸‹é¢ifä¹‹å‰boolean alreadyDispatchedToNewTouchTarget = false; if (!canceled &amp;&amp; !intercepted) ä¸­ç›´æ¥è¿›å…¥ä¸‹é¢ elseä¸­ 123456789101112131415161718192021222324252627282930313233if (mFirstTouchTarget == null) { handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS);} else { TouchTarget predecessor = null; TouchTarget target = mFirstTouchTarget; while (target != null) { final TouchTarget next = target.next; if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } else { final boolean cancelChild = resetCancelNextUpFlag(target.child) || intercepted; if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) { handled = true; } if (cancelChild) { if (predecessor == null) { mFirstTouchTarget = next; } else { predecessor.next = next; } target.recycle(); target = next; continue; } } predecessor = target; target = next; }} æ‰€ä»¥è¿™é‡Œwhileèµ°äº†else 12345678910111213141516171819202122232425while (target != null) { final TouchTarget next = target.next; if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } else { final boolean cancelChild = resetCancelNextUpFlag(target.child) || intercepted; if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) { handled = true; } if (cancelChild) { if (predecessor == null) { mFirstTouchTarget = next; } else { predecessor.next = next; } target.recycle(); target = next; continue; } } predecessor = target; target = next;} dispatchTransformedTouchEventæ–¹æ³• ä¸­èµ°äº†handled = child.dispatchTouchEvent(transformedEvent); æ€»ç»“ï¼šå½“ViewGroup#onInterceptTouchEventä¸ºfalseæ—¶ï¼Œå°±ä¼šè°ƒç”¨å­Viewçš„dispatchTouchEvent äº‹ä»¶å†²çªViewGroup#onInterceptTouchEventViewpager+Listview å†²çªè§£å†³ï¼šå†…éƒ¨æ‹¦æˆªæ³•ï¼ˆåœ¨å­Viewä¸­è§£å†³ï¼‰1234567891011121314151617181920212223int mLastX;int mLastY;@Overridepublic boolean dispatchTouchEvent(MotionEvent ev) { int x = (int) ev.getX(); int y = (int) ev.getY(); switch (ev.getAction()) { case MotionEvent.ACTION_DOWN: getParent().requestDisallowInterceptTouchEvent(true);//è¯·æ±‚ä¸å…è®¸ä¸­æ–­ break; case MotionEvent.ACTION_MOVE: int deltaX = x - mLastX; int deltaY = y - mLastY; if(Math.abs(deltaX)&gt; Math.abs(deltaY)){ //å·¦å³æ»‘ getParent().requestDisallowInterceptTouchEvent(false);//å…è®¸ä¸­æ–­ } break; } mLastX = x; mLastY = y; return super.dispatchTouchEvent(ev);} 12345678910111213141516171819@Overridepublic void requestDisallowInterceptTouchEvent(boolean disallowIntercept) { if (disallowIntercept == ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0)) { // We're already in this state, assume our ancestors are too return; } if (disallowIntercept) { mGroupFlags |= FLAG_DISALLOW_INTERCEPT; } else { mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT; } // Pass it up to our parent if (mParent != null) { mParent.requestDisallowInterceptTouchEvent(disallowIntercept); }} è¿™é‡Œè®¾ç½®äº† getParent().requestDisallowInterceptTouchEvent(true)åï¼ŒdisallowInterceptå°±ä¸ºtrueï¼Œå°±ä¸ä¼šèµ°çˆ¶Viewçš„onInterceptTouchEventæ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œå®ç°å­Viewæ¥æ”¶äº‹ä»¶ã€‚ 12345678910if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // restore action in case it was changed } else { intercepted = false; }} ä½†æ˜¯ï¼Œä¸èƒ½åœ¨MotionEvent.ACTION_DOWNæ–¹æ³•ä¸­è®¾ç½®ã€‚ åœ¨è¿›å…¥ä¸Šé¢äº‹ä»¶åˆ¤æ–­å‰ä¼šè¿›è¡ŒçŠ¶æ€çš„åˆå§‹åŒ–ã€‚æ‰€ä»¥åœ¨ACTION_DOWNäº‹ä»¶ä¸­onInterceptTouchEventè‚¯å®šä¼šæ‰§è¡Œã€‚ 1234if (actionMasked == MotionEvent.ACTION_DOWN) { cancelAndClearTouchTargets(ev); resetTouchState();} è§£å†³æ–¹æ³•ï¼šåœ¨çˆ¶Viewä¸­ä¸ºACTION_DOWNè¿”å›false 12345678@Overridepublic boolean onInterceptTouchEvent(MotionEvent ev) { if (ev.getAction() == MotionEvent.ACTION_DOWN) { super.onInterceptTouchEvent(ev); return false; } return true;} å†…éƒ¨æ‹¦æˆªæ³•æ€»ç»“ï¼šMotionEvent.ACTION_DOWNæ—¶ï¼Œçˆ¶Viewä¸­onInterceptTouchEventè®¾ä¸ºfalseï¼Œå­Viewè°ƒç”¨getParent().requestDisallowInterceptTouchEvent(true);æ–¹æ³• MotionEvent.ACTION_MOVEæ—¶ï¼Œçˆ¶Viewä¸­onInterceptTouchEventè®¾ä¸ºtrueï¼Œéå­Viewäº‹ä»¶æ—¶getParent().requestDisallowInterceptTouchEvent(false);æ–¹æ³• å¤–éƒ¨æ‹¦æˆªæ³•ï¼ˆåœ¨çˆ¶Viewä¸­è§£å†³ï¼‰åœ¨çˆ¶Viewå½“ä¸­è¿›è¡Œå¤„ç† 1234567891011121314151617181920212223int mLastX;int mLastY;@Overridepublic boolean onInterceptTouchEvent(MotionEvent ev) { int x = (int) ev.getX(); int y = (int) ev.getY(); switch (ev.getAction()) { case MotionEvent.ACTION_DOWN: mLastX= (int) ev.getX(); mLastY= (int) ev.getY(); break; case MotionEvent.ACTION_MOVE: int deltaX = x - mLastX; int deltaY = y - mLastY; if (Math.abs(deltaX) &gt; Math.abs(deltaY)) { //å·¦å³æ»‘ return true; } break; } return super.onInterceptTouchEvent(ev);}","link":"/2020/12/09/dispatch/"},{"title":"ViewåŸºç¡€","text":"Androidè‡ªå®šä¹‰Viewæ¦‚è¿° Androidå¼€å‘è¿›é˜¶çš„å¿…ç»ä¹‹è·¯ ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰View è‡ªå®šä¹‰Viewçš„åŸºæœ¬æ–¹æ³• è‡ªå®šä¹‰æ§ä»¶åˆ†ç±» è‡ªå®šä¹‰ViewåŸºç¡€ Viewçš„åˆ†ç±» Viewç±»ç®€ä»‹ AttributeSetä¸è‡ªå®šä¹‰å±æ€§ Viewè§†å›¾ç»“æ„ Androidåæ ‡ç³» Viewä½ç½®ï¼ˆåæ ‡ï¼‰æè¿° ä½ç½®è·å–æ–¹å¼ Androidä¸­é¢œè‰²ç›¸å…³å†…å®¹ Viewæ ‘çš„ç»˜åˆ¶æµç¨‹ Viewæ ‘çš„ç»˜åˆ¶æµç¨‹æ˜¯è°è´Ÿè´£çš„ï¼Ÿ viewçš„æ·»åŠ  viewçš„ç»˜åˆ¶æµç¨‹ measure layout draw LayoutParams MarginLayoutParams LayoutParamsä¸Viewå¦‚ä½•å»ºç«‹è”ç³» addView è‡ªå®šä¹‰LayoutParams LayoutParamså¸¸è§çš„å­ç±» MeasureSpec å®šä¹‰ MeasureSpecs çš„æ„ä¹‰ MeasureSpecå€¼çš„ç¡®å®š Androidå¼€å‘è¿›é˜¶çš„å¿…ç»ä¹‹è·¯ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰Viewè‡ªå®šä¹‰Viewçš„åŸºæœ¬æ–¹æ³•è‡ªå®šä¹‰Viewçš„æœ€åŸºæœ¬çš„ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯ï¼š onMeasure()ã€onLayout()ã€onDraw();Viewåœ¨Activityä¸­æ˜¾ç¤ºå‡ºæ¥ï¼Œè¦ç»å†æµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶ä¸‰ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«å¯¹åº”ä¸‰ä¸ªåŠ¨ä½œï¼šmeasureã€layoutå’Œdrawã€‚ æµ‹é‡ï¼šonMeasure()å†³å®šViewçš„å¤§å°ï¼› å¸ƒå±€ï¼šonLayout()å†³å®šViewåœ¨ViewGroupä¸­çš„ä½ç½®ï¼› ç»˜åˆ¶ï¼šonDraw()å†³å®šç»˜åˆ¶è¿™ä¸ªViewã€‚ è‡ªå®šä¹‰æ§ä»¶åˆ†ç±» è‡ªå®šä¹‰View: åªéœ€è¦é‡å†™onMeasure()å’ŒonDraw() è‡ªå®šä¹‰ViewGroup: åˆ™åªéœ€è¦é‡å†™onMeasure()å’ŒonLayout() è‡ªå®šä¹‰ViewåŸºç¡€Viewçš„åˆ†ç±»è§†å›¾Viewä¸»è¦åˆ†ä¸ºä¸¤ç±»| ç±»åˆ« | è§£é‡Š | ç‰¹ç‚¹ || â€”â€”â€“ | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“ | â€”â€”â€”â€” || å•ä¸€è§†å›¾ | å³ä¸€ä¸ªViewï¼Œå¦‚TextView | ä¸åŒ…å«å­View || è§†å›¾ç»„ | å³å¤šä¸ªViewç»„æˆçš„ViewGroupï¼Œå¦‚LinearLayout | åŒ…å«å­View | Viewç±»ç®€ä»‹ Viewç±»æ˜¯Androidä¸­å„ç§ç»„ä»¶çš„åŸºç±»ï¼Œå¦‚Viewæ˜¯ViewGroupåŸºç±» Viewè¡¨ç°ä¸ºæ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å„ç§è§†å›¾ Androidä¸­çš„UIç»„ä»¶éƒ½ç”±Viewã€ViewGroupç»„æˆã€‚ Viewçš„æ„é€ å‡½æ•°ï¼šå…±æœ‰4ä¸ª 12345678910111213141516171819202122232425// å¦‚æœViewæ˜¯åœ¨Javaä»£ç é‡Œé¢newçš„ï¼Œåˆ™è°ƒç”¨ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•° public CarsonView(Context context) { super(context); }// å¦‚æœViewæ˜¯åœ¨.xmlé‡Œå£°æ˜çš„ï¼Œåˆ™è°ƒç”¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•°// è‡ªå®šä¹‰å±æ€§æ˜¯ä»AttributeSetå‚æ•°ä¼ è¿›æ¥çš„ public CarsonView(Context context, AttributeSet attrs) { super(context, attrs); }// ä¸ä¼šè‡ªåŠ¨è°ƒç”¨// ä¸€èˆ¬æ˜¯åœ¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•°é‡Œä¸»åŠ¨è°ƒç”¨// å¦‚Viewæœ‰styleå±æ€§æ—¶ public CarsonView(Context context, AttributeSet attrs, int defStyleAttr) { super(context, attrs, defStyleAttr); } //API21ä¹‹åæ‰ä½¿ç”¨ // ä¸ä¼šè‡ªåŠ¨è°ƒç”¨ // ä¸€èˆ¬æ˜¯åœ¨ç¬¬äºŒä¸ªæ„é€ å‡½æ•°é‡Œä¸»åŠ¨è°ƒç”¨ // å¦‚Viewæœ‰styleå±æ€§æ—¶ public CarsonView(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) { super(context, attrs, defStyleAttr, defStyleRes); } AttributeSetä¸è‡ªå®šä¹‰å±æ€§ ç³»ç»Ÿè‡ªå¸¦çš„Viewå¯ä»¥åœ¨xmlä¸­é…ç½®å±æ€§ï¼Œå¯¹äºå†™çš„å¥½çš„è‡ªå®šä¹‰ViewåŒæ ·å¯ä»¥åœ¨xmlä¸­é…ç½®å±æ€§ï¼Œä¸ºäº†ä½¿è‡ªå®šä¹‰çš„Viewçš„å±æ€§å¯ä»¥åœ¨xmlä¸­é…ç½®ï¼Œéœ€è¦ä»¥ä¸‹4ä¸ªæ­¥éª¤ï¼š é€šè¿‡&lt;declare-styleable&gt;ä¸ºè‡ªå®šä¹‰Viewæ·»åŠ å±æ€§ åœ¨xmlä¸­ä¸ºç›¸åº”çš„å±æ€§å£°æ˜å±æ€§å€¼ åœ¨è¿è¡Œæ—¶ï¼ˆä¸€èˆ¬ä¸ºæ„é€ å‡½æ•°ï¼‰è·å–å±æ€§å€¼ å°†è·å–åˆ°çš„å±æ€§å€¼åº”ç”¨åˆ°View Viewè§†å›¾ç»“æ„ PhoneWindowæ˜¯Androidç³»ç»Ÿä¸­æœ€åŸºæœ¬çš„çª—å£ç³»ç»Ÿï¼Œç»§æ‰¿è‡ªWindowsç±»ï¼Œè´Ÿè´£ç®¡ç†ç•Œé¢æ˜¾ç¤ºä»¥åŠäº‹ä»¶å“åº”ã€‚å®ƒæ˜¯Activityä¸Viewç³»ç»Ÿäº¤äº’çš„æ¥å£ DecorViewæ˜¯PhoneWindowä¸­çš„èµ·å§‹èŠ‚ç‚¹Viewï¼Œç»§æ‰¿äºViewç±»ï¼Œä½œä¸ºæ•´ä¸ªè§†å›¾å®¹å™¨æ¥ä½¿ç”¨ã€‚ç”¨äºè®¾ç½®çª—å£å±æ€§ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªFrameLayout ViewRootåœ¨Activtiyå¯åŠ¨æ—¶åˆ›å»ºï¼Œè´Ÿè´£ç®¡ç†ã€å¸ƒå±€ã€æ¸²æŸ“çª—å£UIç­‰ç­‰ å¯¹äºå¤šViewçš„è§†å›¾ï¼Œç»“æ„æ˜¯æ ‘å½¢ç»“æ„ï¼šæœ€é¡¶å±‚æ˜¯ViewGroupï¼ŒViewGroupä¸‹å¯èƒ½æœ‰å¤šä¸ªViewGroupæˆ–Viewï¼Œå¦‚ä¸‹å›¾ï¼š ä¸€å®šè¦è®°ä½ï¼šæ— è®ºæ˜¯measureè¿‡ç¨‹ã€layoutè¿‡ç¨‹è¿˜æ˜¯drawè¿‡ç¨‹ï¼Œæ°¸è¿œéƒ½æ˜¯ä»Viewæ ‘çš„æ ¹èŠ‚ç‚¹å¼€å§‹æµ‹é‡æˆ–è®¡ç®—ï¼ˆå³ä»æ ‘çš„é¡¶ç«¯å¼€å§‹ï¼‰ï¼Œä¸€å±‚ä¸€å±‚ã€ä¸€ä¸ªåˆ†æ”¯ä¸€ä¸ªåˆ†æ”¯åœ°è¿›è¡Œï¼ˆå³æ ‘å½¢é€’å½’ï¼‰ï¼Œæœ€ç»ˆè®¡ç®—æ•´ä¸ªViewæ ‘ä¸­å„ä¸ªViewï¼Œæœ€ç»ˆç¡®å®šæ•´ä¸ªViewæ ‘çš„ç›¸å…³å±æ€§ã€‚ Androidåæ ‡ç³»Androidçš„åæ ‡ç³»å®šä¹‰ä¸ºï¼š å±å¹•çš„å·¦ä¸Šè§’ä¸ºåæ ‡åŸç‚¹ å‘å³ä¸ºxè½´å¢å¤§æ–¹å‘ å‘ä¸‹ä¸ºyè½´å¢å¤§æ–¹å‘ åŒºåˆ«äºä¸€èˆ¬çš„æ•°å­¦åæ ‡ç³» Viewä½ç½®ï¼ˆåæ ‡ï¼‰æè¿°Viewçš„ä½ç½®ç”±4ä¸ªé¡¶ç‚¹å†³å®šçš„4ä¸ªé¡¶ç‚¹çš„ä½ç½®æè¿°åˆ†åˆ«ç”±4ä¸ªå€¼å†³å®šï¼š è¯·è®°ä½ï¼šViewçš„ä½ç½®æ˜¯ç›¸å¯¹äºçˆ¶æ§ä»¶è€Œè¨€çš„ï¼‰ Topï¼šå­Viewä¸Šè¾¹ç•Œåˆ°çˆ¶viewä¸Šè¾¹ç•Œçš„è·ç¦» Leftï¼šå­Viewå·¦è¾¹ç•Œåˆ°çˆ¶viewå·¦è¾¹ç•Œçš„è·ç¦» Bottomï¼šå­Viewä¸‹è¾¹è·åˆ°çˆ¶Viewä¸Šè¾¹ç•Œçš„è·ç¦» Rightï¼šå­Viewå³è¾¹ç•Œåˆ°çˆ¶viewå·¦è¾¹ç•Œçš„è·ç¦» ä½ç½®è·å–æ–¹å¼Viewçš„ä½ç½®æ˜¯é€šè¿‡view.getxxx()å‡½æ•°è¿›è¡Œè·å–ï¼šï¼ˆä»¥Topä¸ºä¾‹ï¼‰ 123456789// è·å–Topä½ç½®public final int getTop() { return mTop; } // å…¶ä½™å¦‚ä¸‹ï¼š getLeft(); //è·å–å­Viewå·¦ä¸Šè§’è·çˆ¶Viewå·¦ä¾§çš„è·ç¦» getBottom(); //è·å–å­Viewå³ä¸‹è§’è·çˆ¶Viewé¡¶éƒ¨çš„è·ç¦» getRight(); //è·å–å­Viewå³ä¸‹è§’è·çˆ¶Viewå·¦ä¾§çš„è·ç¦» ä¸MotionEventä¸­ get()å’ŒgetRaw()çš„åŒºåˆ« 1234567//get() ï¼šè§¦æ‘¸ç‚¹ç›¸å¯¹äºå…¶æ‰€åœ¨ç»„ä»¶åæ ‡ç³»çš„åæ ‡ event.getX(); event.getY();//getRaw() ï¼šè§¦æ‘¸ç‚¹ç›¸å¯¹äºå±å¹•é»˜è®¤åæ ‡ç³»çš„åæ ‡ event.getRawX(); event.getRawY(); Androidä¸­é¢œè‰²ç›¸å…³å†…å®¹Androidæ”¯æŒçš„é¢œè‰²æ¨¡å¼ï¼šä»¥ARGB8888ä¸ºä¾‹ä»‹ç»é¢œè‰²å®šä¹‰: Viewæ ‘çš„ç»˜åˆ¶æµç¨‹Viewæ ‘çš„ç»˜åˆ¶æµç¨‹æ˜¯è°è´Ÿè´£çš„ï¼Ÿviewæ ‘çš„ç»˜åˆ¶æµç¨‹æ˜¯é€šè¿‡ViewRootå»è´Ÿè´£ç»˜åˆ¶çš„ï¼ŒViewRootè¿™ä¸ªç±»çš„å‘½åæœ‰ç‚¹å‘ï¼Œæœ€åˆçœ‹åˆ°è¿™ä¸ªåå­—ï¼Œç¿»è¯‘è¿‡æ¥æ˜¯viewçš„æ ¹èŠ‚ç‚¹ï¼Œä½†æ˜¯äº‹å®å®Œå…¨ä¸æ˜¯è¿™æ ·ï¼ŒViewRootå…¶å®ä¸æ˜¯Viewçš„æ ¹èŠ‚ç‚¹ï¼Œå®ƒè¿viewèŠ‚ç‚¹éƒ½ç®—ä¸ä¸Šï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯Viewæ ‘çš„ç®¡ç†è€…ï¼Œè´Ÿè´£å°†DecorViewå’ŒPhoneWindowâ€œç»„åˆâ€èµ·æ¥ï¼Œè€ŒViewæ ‘çš„æ ¹èŠ‚ç‚¹ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´åªæœ‰DecorViewï¼›æ¯ä¸ªDecorViewéƒ½æœ‰ä¸€ä¸ªViewRootä¸ä¹‹å…³è”ï¼Œè¿™ç§å…³è”å…³ç³»æ˜¯ç”±WindowManagerå»è¿›è¡Œç®¡ç†çš„ï¼› viewçš„æ·»åŠ  viewçš„ç»˜åˆ¶æµç¨‹ measure ç³»ç»Ÿä¸ºä»€ä¹ˆè¦æœ‰measureè¿‡ç¨‹ï¼Ÿ measureè¿‡ç¨‹éƒ½å¹²äº†ç‚¹ä»€ä¹ˆäº‹ï¼Ÿ å¯¹äºè‡ªé€‚åº”çš„å°ºå¯¸æœºåˆ¶ï¼Œå¦‚ä½•åˆç†çš„æµ‹é‡ä¸€é¢—Viewæ ‘ï¼Ÿ é‚£ä¹ˆViewGroupæ˜¯å¦‚ä½•å‘å­Viewä¼ é€’é™åˆ¶ä¿¡æ¯çš„ï¼Ÿ ScrollViewåµŒå¥—ListViewé—®é¢˜ï¼Ÿ layout ç³»ç»Ÿä¸ºä»€ä¹ˆè¦æœ‰layoutè¿‡ç¨‹ï¼Ÿ layoutè¿‡ç¨‹éƒ½å¹²äº†ç‚¹ä»€ä¹ˆäº‹ï¼Ÿ draw ç³»ç»Ÿä¸ºä»€ä¹ˆè¦æœ‰drawè¿‡ç¨‹ï¼Ÿ drawè¿‡ç¨‹éƒ½å¹²äº†ç‚¹ä»€ä¹ˆäº‹ï¼Ÿ LayoutParamsLayoutParamsç¿»è¯‘è¿‡æ¥å°±æ˜¯å¸ƒå±€å‚æ•°ï¼Œå­Viewé€šè¿‡LayoutParamså‘Šè¯‰çˆ¶å®¹å™¨ï¼ˆViewGroupï¼‰åº”è¯¥å¦‚ä½•æ”¾ç½®è‡ªå·±ã€‚ä»è¿™ä¸ªå®šä¹‰ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥LayoutParamsä¸ViewGroupæ˜¯æ¯æ¯ç›¸å…³çš„ï¼Œå› æ­¤è„±ç¦»ViewGroupè°ˆLayoutParamsæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚ äº‹å®ä¸Šï¼Œæ¯ä¸ªViewGroupçš„å­ç±»éƒ½æœ‰è‡ªå·±å¯¹åº”çš„LayoutParamsç±»ï¼Œå…¸å‹çš„å¦‚LinearLayout.LayoutParamså’ŒFrameLayout.LayoutParamsç­‰ï¼Œå¯ä»¥çœ‹å‡ºæ¥LayoutParamséƒ½æ˜¯å¯¹åº”ViewGroupå­ç±»çš„å†…éƒ¨ç±» MarginLayoutParamsMarginLayoutParamsæ˜¯å’Œå¤–é—´è·æœ‰å…³çš„ã€‚äº‹å®ä¹Ÿç¡®å®å¦‚æ­¤ï¼Œå’ŒLayoutParamsç›¸æ¯”ï¼ŒMarginLayoutParamsåªæ˜¯å¢åŠ äº†å¯¹ä¸Šä¸‹å·¦å³å¤–é—´è·çš„æ”¯æŒã€‚å®é™…ä¸Šå¤§éƒ¨åˆ†LayoutParamsçš„å®ç°ç±»éƒ½æ˜¯ç»§æ‰¿è‡ªMarginLayoutParamsï¼Œå› ä¸ºåŸºæœ¬æ‰€æœ‰çš„çˆ¶å®¹å™¨éƒ½æ˜¯æ”¯æŒå­Viewè®¾ç½®å¤–é—´è·çš„ å±æ€§ä¼˜å…ˆçº§é—®é¢˜MarginLayoutParamsä¸»è¦å°±æ˜¯å¢åŠ äº†ä¸Šä¸‹å·¦å³4ç§å¤–é—´è·ã€‚åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯è·å–äº†marginå±æ€§ï¼›å¦‚æœè¯¥å€¼ä¸åˆæ³•ï¼Œå°±è·å–horizontalMarginï¼›å¦‚æœè¯¥å€¼ä¸åˆæ³•ï¼Œå†å»è·å–leftMarginå’ŒrightMarginå±æ€§ï¼ˆverticalMarginã€topMarginå’ŒbottomMarginåŒç†ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥æ®æ­¤æ€»ç»“å‡ºè¿™å‡ ç§å±æ€§çš„ä¼˜å…ˆçº§ margin &gt; horizontalMarginå’ŒverticalMargin &gt; leftMarginå’ŒRightMarginã€topMarginå’ŒbottomMargin å±æ€§è¦†ç›–é—®é¢˜ä¼˜å…ˆçº§æ›´é«˜çš„å±æ€§ä¼šè¦†ç›–æ‰ä¼˜å…ˆçº§è¾ƒä½çš„å±æ€§ã€‚æ­¤å¤–ï¼Œè¿˜è¦æ³¨æ„ä¸€ä¸‹è¿™å‡ ç§å±æ€§ä¸Šçš„æ³¨é‡Š Call {@link ViewGroup#setLayoutParams(LayoutParams)} after reassigning a new value LayoutParamsä¸Viewå¦‚ä½•å»ºç«‹è”ç³» åœ¨XMLä¸­å®šä¹‰View åœ¨Javaä»£ç ä¸­ç›´æ¥ç”ŸæˆViewå¯¹åº”çš„å®ä¾‹å¯¹è±¡ addView12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394/** * é‡è½½æ–¹æ³•1ï¼šæ·»åŠ ä¸€ä¸ªå­View * å¦‚æœè¿™ä¸ªå­Viewè¿˜æ²¡æœ‰LayoutParamsï¼Œå°±ä¸ºå­Viewè®¾ç½®å½“å‰ViewGroupé»˜è®¤çš„LayoutParams */public void addView(View child) { addView(child, -1);}/** * é‡è½½æ–¹æ³•2ï¼šåœ¨æŒ‡å®šä½ç½®æ·»åŠ ä¸€ä¸ªå­View * å¦‚æœè¿™ä¸ªå­Viewè¿˜æ²¡æœ‰LayoutParamsï¼Œå°±ä¸ºå­Viewè®¾ç½®å½“å‰ViewGroupé»˜è®¤çš„LayoutParams * @param index Viewå°†åœ¨ViewGroupä¸­è¢«æ·»åŠ çš„ä½ç½®ï¼ˆ-1ä»£è¡¨æ·»åŠ åˆ°æœ«å°¾ï¼‰ */public void addView(View child, int index) { if (child == null) { throw new IllegalArgumentException(&quot;Cannot add a null child view to a ViewGroup&quot;); } LayoutParams params = child.getLayoutParams(); if (params == null) { params = generateDefaultLayoutParams();// ç”Ÿæˆå½“å‰ViewGroupé»˜è®¤çš„LayoutParams if (params == null) { throw new IllegalArgumentException(&quot;generateDefaultLayoutParams() cannot return null&quot;); } } addView(child, index, params);}/** * é‡è½½æ–¹æ³•3ï¼šæ·»åŠ ä¸€ä¸ªå­View * ä½¿ç”¨å½“å‰ViewGroupé»˜è®¤çš„LayoutParamsï¼Œå¹¶ä»¥ä¼ å…¥å‚æ•°ä½œä¸ºLayoutParamsçš„widthå’Œheight */public void addView(View child, int width, int height) { final LayoutParams params = generateDefaultLayoutParams(); // ç”Ÿæˆå½“å‰ViewGroupé»˜è®¤çš„LayoutParams params.width = width; params.height = height; addView(child, -1, params);}/** * é‡è½½æ–¹æ³•4ï¼šæ·»åŠ ä¸€ä¸ªå­Viewï¼Œå¹¶ä½¿ç”¨ä¼ å…¥çš„LayoutParams */@Overridepublic void addView(View child, LayoutParams params) { addView(child, -1, params);}/** * é‡è½½æ–¹æ³•4ï¼šåœ¨æŒ‡å®šä½ç½®æ·»åŠ ä¸€ä¸ªå­Viewï¼Œå¹¶ä½¿ç”¨ä¼ å…¥çš„LayoutParams */public void addView(View child, int index, LayoutParams params) { if (child == null) { throw new IllegalArgumentException(&quot;Cannot add a null child view to a ViewGroup&quot;); } // addViewInner() will call child.requestLayout() when setting the new LayoutParams // therefore, we call requestLayout() on ourselves before, so that the child's request // will be blocked at our level requestLayout(); invalidate(true); addViewInner(child, index, params, false);}private void addViewInner(View child, int index, LayoutParams params, boolean preventRequestLayout) { ..... if (mTransition != null) { mTransition.addChild(this, child); } if (!checkLayoutParams(params)) { // â‘  æ£€æŸ¥ä¼ å…¥çš„LayoutParamsæ˜¯å¦åˆæ³• params = generateLayoutParams(params); // å¦‚æœä¼ å…¥çš„LayoutParamsä¸åˆæ³•ï¼Œå°†è¿›è¡Œè½¬åŒ–æ“ä½œ } if (preventRequestLayout) { // â‘¡ æ˜¯å¦éœ€è¦é˜»æ­¢é‡æ–°æ‰§è¡Œå¸ƒå±€æµç¨‹ child.mLayoutParams = params; // è¿™ä¸ä¼šå¼•èµ·å­Viewé‡æ–°å¸ƒå±€ï¼ˆonMeasure-&gt;onLayout-&gt;onDrawï¼‰ } else { child.setLayoutParams(params); // è¿™ä¼šå¼•èµ·å­Viewé‡æ–°å¸ƒå±€ï¼ˆonMeasure-&gt;onLayout-&gt;onDrawï¼‰ } if (index &lt; 0) { index = mChildrenCount; } addInArray(child, index); // tell our children if (preventRequestLayout) { child.assignParent(this); } else { child.mParent = this; } .....} è‡ªå®šä¹‰LayoutParams åˆ›å»ºè‡ªå®šä¹‰å±æ€§ 12345678&lt;resources&gt; &lt;declare-styleable name=&quot;xxxViewGroup_Layout&quot;&gt; &lt;!-- è‡ªå®šä¹‰çš„å±æ€§ --&gt; &lt;attr name=&quot;layout_simple_attr&quot; format=&quot;integer&quot;/&gt; &lt;!-- ä½¿ç”¨ç³»ç»Ÿé¢„ç½®çš„å±æ€§ --&gt; &lt;attr name=&quot;android:layout_gravity&quot;/&gt; &lt;/declare-styleable&gt;&lt;/resources&gt; ç»§æ‰¿MarginLayout 1234567891011121314151617181920212223242526public static class LayoutParams extends ViewGroup.MarginLayoutParams { public int simpleAttr; public int gravity; public LayoutParams(Context c, AttributeSet attrs) { super(c, attrs); // è§£æå¸ƒå±€å±æ€§ TypedArray typedArray = c.obtainStyledAttributes(attrs, R.styleable.SimpleViewGroup_Layout); simpleAttr = typedArray.getInteger(R.styleable.SimpleViewGroup_Layout_layout_simple_attr, 0); gravity=typedArray.getInteger(R.styleable.SimpleViewGroup_Layout_android_layout_gravity, -1); typedArray.recycle();//é‡Šæ”¾èµ„æº } public LayoutParams(int width, int height) { super(width, height); } public LayoutParams(MarginLayoutParams source) { super(source); } public LayoutParams(ViewGroup.LayoutParams source) { super(source); }} é‡å†™ViewGroupä¸­å‡ ä¸ªä¸LayoutParamsç›¸å…³çš„æ–¹æ³• 1234567891011121314151617181920212223// æ£€æŸ¥LayoutParamsæ˜¯å¦åˆæ³•@Overrideprotected boolean checkLayoutParams(ViewGroup.LayoutParams p) { return p instanceof SimpleViewGroup.LayoutParams;}// ç”Ÿæˆé»˜è®¤çš„LayoutParams@Overrideprotected ViewGroup.LayoutParams generateDefaultLayoutParams() { return new SimpleViewGroup.LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.WRAP_CONTENT);}// å¯¹ä¼ å…¥çš„LayoutParamsè¿›è¡Œè½¬åŒ–@Overrideprotected ViewGroup.LayoutParams generateLayoutParams(ViewGroup.LayoutParams p) { return new SimpleViewGroup.LayoutParams(p);}// å¯¹ä¼ å…¥çš„LayoutParamsè¿›è¡Œè½¬åŒ–@Overridepublic ViewGroup.LayoutParams generateLayoutParams(AttributeSet attrs) { return new SimpleViewGroup.LayoutParams(getContext(), attrs);} LayoutParamså¸¸è§çš„å­ç±»åœ¨ä¸ºViewè®¾ç½®LayoutParamsçš„æ—¶å€™éœ€è¦æ ¹æ®å®ƒçš„çˆ¶å®¹å™¨é€‰æ‹©å¯¹åº”çš„LayoutParamsï¼Œå¦åˆ™ç»“æœå¯èƒ½ä¸é¢„æœŸä¸ä¸€è‡´ï¼Œè¿™é‡Œç®€å•ç½—åˆ—ä¸€äº›å¸¸è§çš„LayoutParamså­ç±»ï¼š ViewGroup.MarginLayoutParams FrameLayout.LayoutParams LinearLayout.LayoutParams RelativeLayout.LayoutParams RecyclerView.LayoutParams GridLayoutManager.LayoutParams StaggeredGridLayoutManager.LayoutParams ViewPager.LayoutParams WindowManager.LayoutParams MeasureSpecå®šä¹‰æµ‹é‡è§„æ ¼,å°è£…äº†çˆ¶å®¹å™¨å¯¹ view çš„å¸ƒå±€ä¸Šçš„é™åˆ¶ï¼Œå†…éƒ¨æä¾›äº†å®½é«˜çš„ä¿¡æ¯ï¼ˆ SpecMode ã€ SpecSize ï¼‰ï¼ŒSpecSizeæ˜¯æŒ‡åœ¨æŸç§SpecModeä¸‹çš„å‚è€ƒå°ºå¯¸ï¼Œå…¶ä¸­SpecMode æœ‰å¦‚ä¸‹ä¸‰ç§ï¼š UNSPECIFIEDçˆ¶æ§ä»¶ä¸å¯¹ä½ æœ‰ä»»ä½•é™åˆ¶ï¼Œä½ æƒ³è¦å¤šå¤§ç»™ä½ å¤šå¤§ï¼Œæƒ³ä¸Šå¤©å°±ä¸Šå¤©ã€‚è¿™ç§æƒ…å†µä¸€èˆ¬ç”¨äºç³»ç»Ÿå†…éƒ¨ï¼Œè¡¨ç¤ºä¸€ç§æµ‹é‡çŠ¶æ€ã€‚ï¼ˆè¿™ä¸ªæ¨¡å¼ä¸»è¦ç”¨äºç³»ç»Ÿå†…éƒ¨å¤šæ¬¡Measureçš„æƒ…å½¢ï¼Œå¹¶ä¸æ˜¯çœŸçš„è¯´ä½ æƒ³è¦å¤šå¤§æœ€åå°±çœŸæœ‰å¤šå¤§ï¼‰ EXACTLYçˆ¶æ§ä»¶å·²ç»çŸ¥é“ä½ æ‰€éœ€çš„ç²¾ç¡®å¤§å°ï¼Œä½ çš„æœ€ç»ˆå¤§å°åº”è¯¥å°±æ˜¯è¿™ä¹ˆå¤§ã€‚ AT_MOSTä½ çš„å¤§å°ä¸èƒ½å¤§äºçˆ¶æ§ä»¶ç»™ä½ æŒ‡å®šçš„sizeï¼Œä½†å…·ä½“æ˜¯å¤šå°‘ï¼Œå¾—çœ‹ä½ è‡ªå·±çš„å®ç°ã€‚ MeasureSpecs çš„æ„ä¹‰é€šè¿‡å°† SpecMode å’Œ SpecSize æ‰“åŒ…æˆä¸€ä¸ª int å€¼å¯ä»¥é¿å…è¿‡å¤šçš„å¯¹è±¡å†…å­˜åˆ†é…ï¼Œä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œå…¶æä¾›äº†æ‰“åŒ… / è§£åŒ…æ–¹æ³• MeasureSpecå€¼çš„ç¡®å®šMeasureSpecå€¼åˆ°åº•æ˜¯å¦‚ä½•è®¡ç®—å¾—æ¥çš„å‘¢?å­Viewçš„MeasureSpecå€¼æ˜¯æ ¹æ®å­Viewçš„å¸ƒå±€å‚æ•°ï¼ˆLayoutParamsï¼‰å’Œçˆ¶å®¹å™¨çš„MeasureSpecå€¼è®¡ç®—å¾—æ¥çš„ï¼Œå…·ä½“è®¡ç®—é€»è¾‘å°è£…åœ¨getChildMeasureSpec()é‡Œ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586/** * * ç›®æ ‡æ˜¯å°†çˆ¶æ§ä»¶çš„æµ‹é‡è§„æ ¼å’Œchild viewçš„å¸ƒå±€å‚æ•°LayoutParamsç›¸ç»“åˆï¼Œå¾—åˆ°ä¸€ä¸ª * æœ€å¯èƒ½ç¬¦åˆæ¡ä»¶çš„child viewçš„æµ‹é‡è§„æ ¼ã€‚ * @param spec çˆ¶æ§ä»¶çš„æµ‹é‡è§„æ ¼ * @param padding çˆ¶æ§ä»¶é‡Œå·²ç»å ç”¨çš„å¤§å° * @param childDimension child viewå¸ƒå±€LayoutParamsé‡Œçš„å°ºå¯¸ * @return child view çš„æµ‹é‡è§„æ ¼ */ public static int getChildMeasureSpec(int spec, int padding, int childDimension) { int specMode = MeasureSpec.getMode(spec); //çˆ¶æ§ä»¶çš„æµ‹é‡æ¨¡å¼ int specSize = MeasureSpec.getSize(spec); //çˆ¶æ§ä»¶çš„æµ‹é‡å¤§å° int size = Math.max(0, specSize - padding); int resultSize = 0; int resultMode = 0; switch (specMode) { // å½“çˆ¶æ§ä»¶çš„æµ‹é‡æ¨¡å¼ æ˜¯ ç²¾ç¡®æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æœ‰ç²¾ç¡®çš„å°ºå¯¸äº† case MeasureSpec.EXACTLY: //å¦‚æœchildçš„å¸ƒå±€å‚æ•°æœ‰å›ºå®šå€¼ï¼Œæ¯”å¦‚&quot;layout_width&quot; = &quot;100dp&quot; //é‚£ä¹ˆæ˜¾ç„¶childçš„æµ‹é‡è§„æ ¼ä¹Ÿå¯ä»¥ç¡®å®šä¸‹æ¥äº†ï¼Œæµ‹é‡å¤§å°å°±æ˜¯100dpï¼Œæµ‹é‡æ¨¡å¼ä¹Ÿæ˜¯EXACTLY if (childDimension &gt;= 0) { resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } //å¦‚æœchildçš„å¸ƒå±€å‚æ•°æ˜¯&quot;match_parent&quot;ï¼Œä¹Ÿå°±æ˜¯æƒ³è¦å æ»¡çˆ¶æ§ä»¶ //è€Œæ­¤æ—¶çˆ¶æ§ä»¶æ˜¯ç²¾ç¡®æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯èƒ½ç¡®å®šè‡ªå·±çš„å°ºå¯¸äº†ï¼Œé‚£childä¹Ÿèƒ½ç¡®å®šè‡ªå·±å¤§å°äº† else if (childDimension == LayoutParams.MATCH_PARENT) { resultSize = size; resultMode = MeasureSpec.EXACTLY; } //å¦‚æœchildçš„å¸ƒå±€å‚æ•°æ˜¯&quot;wrap_content&quot;ï¼Œä¹Ÿå°±æ˜¯æƒ³è¦æ ¹æ®è‡ªå·±çš„é€»è¾‘å†³å®šè‡ªå·±å¤§å°ï¼Œ //æ¯”å¦‚TextViewæ ¹æ®è®¾ç½®çš„å­—ç¬¦ä¸²å¤§å°æ¥å†³å®šè‡ªå·±çš„å¤§å° //é‚£å°±è‡ªå·±å†³å®šå‘—ï¼Œä¸è¿‡ä½ çš„å¤§å°è‚¯å®šä¸èƒ½å¤§äºçˆ¶æ§ä»¶çš„å¤§å°å˜› //æ‰€ä»¥æµ‹é‡æ¨¡å¼å°±æ˜¯AT_MOSTï¼Œæµ‹é‡å¤§å°å°±æ˜¯çˆ¶æ§ä»¶çš„size else if (childDimension == LayoutParams.WRAP_CONTENT) { resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // å½“çˆ¶æ§ä»¶çš„æµ‹é‡æ¨¡å¼ æ˜¯ æœ€å¤§æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è¯´çˆ¶æ§ä»¶è‡ªå·±è¿˜ä¸çŸ¥é“è‡ªå·±çš„å°ºå¯¸ï¼Œä½†æ˜¯å¤§å°ä¸èƒ½è¶…è¿‡size case MeasureSpec.AT_MOST: //åŒæ ·çš„ï¼Œæ—¢ç„¶childèƒ½ç¡®å®šè‡ªå·±å¤§å°ï¼Œå°½ç®¡çˆ¶æ§ä»¶è‡ªå·±è¿˜ä¸çŸ¥é“è‡ªå·±å¤§å°ï¼Œä¹Ÿä¼˜å…ˆæ»¡è¶³å­©å­çš„éœ€æ±‚ if (childDimension &gt;= 0) { resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } //childæƒ³è¦å’Œçˆ¶æ§ä»¶ä¸€æ ·å¤§ï¼Œä½†çˆ¶æ§ä»¶è‡ªå·±ä¹Ÿä¸ç¡®å®šè‡ªå·±å¤§å°ï¼Œæ‰€ä»¥childä¹Ÿæ— æ³•ç¡®å®šè‡ªå·±å¤§å° //ä½†åŒæ ·çš„ï¼Œchildçš„å°ºå¯¸ä¸Šé™ä¹Ÿæ˜¯çˆ¶æ§ä»¶çš„å°ºå¯¸ä¸Šé™size else if (childDimension == LayoutParams.MATCH_PARENT) { resultSize = size; resultMode = MeasureSpec.AT_MOST; } //childæƒ³è¦æ ¹æ®è‡ªå·±é€»è¾‘å†³å®šå¤§å°ï¼Œé‚£å°±è‡ªå·±å†³å®šå‘— else if (childDimension == LayoutParams.WRAP_CONTENT) { resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // Parent asked to see how big we want to be case MeasureSpec.UNSPECIFIED: if (childDimension &gt;= 0) { // Child wants a specific size... let him have it resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // Child wants to be our size... find out how big it should // be resultSize = 0; resultMode = MeasureSpec.UNSPECIFIED; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // Child wants to determine its own size.... find out how // big it should be resultSize = 0; resultMode = MeasureSpec.UNSPECIFIED; } break; } return MeasureSpec.makeMeasureSpec(resultSize, resultMode); } é’ˆå¯¹ä¸Šè¡¨ï¼Œè¿™é‡Œå†åšä¸€ä¸‹å…·ä½“çš„è¯´æ˜ å¯¹äºåº”ç”¨å±‚ View ï¼Œå…¶ MeasureSpec ç”±çˆ¶å®¹å™¨çš„ MeasureSpec å’Œè‡ªèº«çš„ LayoutParams æ¥å…±åŒå†³å®š å¯¹äºä¸åŒçš„çˆ¶å®¹å™¨å’Œviewæœ¬èº«ä¸åŒçš„LayoutParamsï¼Œviewå°±å¯ä»¥æœ‰å¤šç§MeasureSpecã€‚1. å½“viewé‡‡ç”¨å›ºå®šå®½é«˜çš„æ—¶å€™ï¼Œä¸ç®¡çˆ¶å®¹å™¨çš„MeasureSpecæ˜¯ä»€ä¹ˆï¼Œviewçš„MeasureSpecéƒ½æ˜¯ç²¾ç¡®æ¨¡å¼å¹¶ä¸”å…¶å¤§å°éµå¾ªLayoutparamsä¸­çš„å¤§å°ï¼› 2. å½“viewçš„å®½é«˜æ˜¯match_parentæ—¶ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœçˆ¶å®¹å™¨çš„æ¨¡å¼æ˜¯ç²¾å‡†æ¨¡å¼ï¼Œé‚£ä¹ˆviewä¹Ÿæ˜¯ç²¾å‡†æ¨¡å¼å¹¶ä¸”å…¶å¤§å°æ˜¯çˆ¶å®¹å™¨çš„å‰©ä½™ç©ºé—´ï¼Œå¦‚æœçˆ¶å®¹å™¨æ˜¯æœ€å¤§æ¨¡å¼ï¼Œé‚£ä¹ˆviewä¹Ÿæ˜¯æœ€å¤§æ¨¡å¼å¹¶ä¸”å…¶å¤§å°ä¸ä¼šè¶…è¿‡çˆ¶å®¹å™¨çš„å‰©ä½™ç©ºé—´ï¼› 3. å½“viewçš„å®½é«˜æ˜¯wrap_contentæ—¶ï¼Œä¸ç®¡çˆ¶å®¹å™¨çš„æ¨¡å¼æ˜¯ç²¾å‡†è¿˜æ˜¯æœ€å¤§åŒ–ï¼Œviewçš„æ¨¡å¼æ€»æ˜¯æœ€å¤§åŒ–å¹¶ä¸”å¤§å°ä¸èƒ½è¶…è¿‡çˆ¶å®¹å™¨çš„å‰©ä½™ç©ºé—´ã€‚ 4. Unspecifiedæ¨¡å¼ï¼Œè¿™ä¸ªæ¨¡å¼ä¸»è¦ç”¨äºç³»ç»Ÿå†…éƒ¨å¤šæ¬¡measureçš„æƒ…å†µä¸‹ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³æ³¨æ­¤æ¨¡å¼(è¿™é‡Œæ³¨æ„è‡ªå®šä¹‰Viewæ”¾åˆ°ScrollViewçš„æƒ…å†µ éœ€è¦å¤„ç†)ã€‚","link":"/2021/06/15/view/"},{"title":"OkHttpæºç åˆ†æ","text":"OkHttpè¯·æ±‚æµç¨‹ é«˜å¹¶å‘è¯·æ±‚åˆ†å‘å™¨ä¸çº¿ç¨‹æ±  è´£ä»»é“¾æ¨¡å¼è¯·æ±‚ä¸å“åº”æ‹¦æˆª ç›®å½• OkHttpä»‹ç» ç®€å•ä½¿ç”¨ï¼š ä½¿ç”¨æµç¨‹ï¼š è°ƒç”¨æµç¨‹ï¼š åˆ†å‘å™¨ï¼š å¼‚æ­¥è¯·æ±‚å·¥ä½œæµç¨‹ï¼š OkHttpçº¿ç¨‹æ± çš„ç‰¹ç‚¹ï¼š AsyncCall åŒæ­¥è¯·æ±‚ æ‹¦æˆªå™¨ï¼š è·å–å“åº”ï¼š è´£ä»»é“¾æ¨¡å¼ï¼š æ‹¦æˆªå™¨è´£ä»»é“¾ï¼š äº”å¤§æ‹¦æˆªå™¨åŠŸèƒ½ï¼š æ‹¦æˆªå™¨è¯¦æƒ…ï¼š ä¸€ã€é‡è¯•åŠé‡å®šå‘æ‹¦æˆªå™¨ é‡è¯• é‡å®šå‘ æ€»ç»“ äºŒã€æ¡¥æ¥æ‹¦æˆªå™¨ æ€»ç»“ ä¸‰ã€ç¼“å­˜æ‹¦æˆªå™¨ ç¼“å­˜ç­–ç•¥ æµç¨‹ï¼š è¯¦ç»†æµç¨‹ï¼š PSï¼šè¯·æ±‚å¤´ä¸å“åº”å¤´ å››ã€è¿æ¥æ‹¦æˆªå™¨ è¿æ¥æµç¨‹ï¼š è¿æ¥æ± æ¸…ç†ï¼š ä»£ç†è¿æ¥ï¼š äº”ã€è¯·æ±‚æœåŠ¡å™¨æ‹¦æˆªå™¨ Expect: 100-continue æ€»ç»“ è‡ªå®šä¹‰æ‹¦æˆªå™¨ OkHttpæ€»ç»“ è¡¥å……: ä»£ç† OkHttpä»‹ç»ç”±Squareå…¬å¸è´¡çŒ®çš„ä¸€ä¸ªå¤„ç†ç½‘ç»œè¯·æ±‚çš„å¼€æºé¡¹ç›®ï¼Œæ˜¯ç›®å‰Androidä½¿ç”¨æœ€å¹¿æ³›çš„ç½‘ç»œæ¡†æ¶ï¼Œä»Android4ã€‚4å¼€å§‹HttpURLConnectionçš„åº•å±‚å®ç°é‡‡ç”¨çš„æ˜¯OkHttpã€‚ æ”¯æŒHTTP/2å¹¶å…è®¸å¯¹åŒä¸€ä¸»æœºçš„æ‰€æœ‰è¯·æ±‚å…±äº«ä¸€ä¸ªå¥—æ¥å­— é€šè¿‡è¿æ¥æ± ï¼Œå‡å°‘äº†è¯·æ±‚å»¶è¿Ÿ é»˜è®¤é€šè¿‡GZipå‹ç¼©æ•°æ® å“åº”ç¼“å­˜ï¼Œä»¥å…äº†é‡å¤è¯·æ±‚çš„ç½‘ç»œ è¯·æ±‚å¤±è´¥è‡ªåŠ¨é‡è¯•ä¸»æœºçš„å…¶ä»–ipï¼Œè‡ªåŠ¨é‡å®šå‘ â€¦â€¦ ç®€å•ä½¿ç”¨ï¼š123456789101112131415161718192021OkHttpClient okHttpClient = new OkHttpClient();Request request = new Request.Builder().url(&quot;http://www.baidu.com&quot;).build();Call call = okHttpClient.newCall(request);try { //åŒæ­¥è¯·æ±‚ Response execute = call.execute();} catch (IOException e) { e.printStackTrace();}//å¼‚æ­¥è¯·æ±‚call.enqueue(new Callback() { @Override public void onFailure(Call call, IOException e) { } @Override public void onResponse(Call call, Response response) throws IOException { }}); ä½¿ç”¨æµç¨‹ï¼š è°ƒç”¨æµç¨‹ï¼šOkHttpè¯·æ±‚è¿‡ç¨‹ä¸­æœ€å°‘éœ€è¦æ¥è§¦OkHttpClientã€Requestã€Callã€Responseï¼Œä½†æ˜¯æ¡†æ¶å†…éƒ¨è¿›è¡Œå¤§é‡çš„é€»è¾‘å¤„ç†ã€‚ æ‰€æœ‰çš„é€»è¾‘å¤§éƒ¨åˆ†é›†ä¸­åœ¨æ‹¦æˆªå™¨ä¸­ï¼Œä½†æ˜¯åœ¨è¿›å…¥æ‹¦æˆªå™¨ä¹‹å‰è¿˜éœ€è¦ä¾é åˆ†å‘å™¨æ¥è°ƒé…è¯·æ±‚ä»»åŠ¡ã€‚ åˆ†å‘å™¨ï¼šå†…éƒ¨ç»´æŠ¤é˜Ÿåˆ—ä¸çº¿ç¨‹æ± ï¼Œå®Œæˆè¯·æ±‚è°ƒé…ï¼›Dispatcher æ‹¦æˆªå™¨ï¼šäº”å¤§é»˜è®¤æ‹¦æˆªå™¨å®Œæˆæ•´ä¸ªè¯·æ±‚è¿‡ç¨‹ï¼› Interceptors åˆ†å‘å™¨ï¼šå¼‚æ­¥è¯·æ±‚å·¥ä½œæµç¨‹ï¼š Qï¼šå¦‚ä½•å†³å®šå°†è¯·æ±‚æ”¾å…¥readyè¿˜æ˜¯running? Qï¼šä»runningç§»åŠ¨åˆ°readyçš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ Qï¼šåˆ†å‘å™¨çº¿ç¨‹æ± çš„å·¥ä½œè¡Œä¸ºï¼Ÿ Dispatcherä¸­ A: client.dispatcher().enqueue(new AsyncCall(responseCallback)); 1234567891011121314synchronized void enqueue(AsyncCall call) { //1.runningé˜Ÿåˆ—æ•°å°äºæœ€å¤§è¯·æ±‚æ•°64ï¼ˆæ­£åœ¨è¯·æ±‚çš„çš„æ•°é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œè‡ªå·±é…ç½®åˆ†å‘å™¨æ—¶å¯ä»¥ä¿®æ”¹ï¼‰ //2.åŒä¸€åŸŸåæ­£åœ¨è¯·æ±‚çš„ä¸ªæ•°ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„å°äº5 //PS:æœ€å¤§åŒæ—¶è¯·æ±‚æ•°64ï¼Œä¸åŒä¸€å°æœåŠ¡å™¨è¯·æ±‚æ•°5 if (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) { //æ·»åŠ åˆ°runningé˜Ÿåˆ— runningAsyncCalls.add(call); //å°†runnableï¼ˆcallï¼‰æäº¤åˆ°çº¿ç¨‹æ± å½“ä¸­ executorService().execute(call); } else { //ä¸ç¬¦åˆä¸Šé¢è¯·æ±‚å°±åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ— readyAsyncCalls.add(call); }} A:client.dispatcher().finished(this);-&gt; promoteCalls()ç§»åŠ¨é˜Ÿåˆ—ï¼ˆå¼‚æ­¥æ—¶æ‰æœ‰ç§»åŠ¨é˜Ÿåˆ—ï¼‰ 123456789101112131415161718192021private void promoteCalls() { //æ­£åœ¨æ‰§è¡Œé˜Ÿåˆ—æ•° if (runningAsyncCalls.size() &gt;= maxRequests) return; // Already running max capacity. //ç­‰å¾…é˜Ÿåˆ—æ•°å¾—ä¸ä¸ºç©º if (readyAsyncCalls.isEmpty()) return; // No ready calls to promote. for (Iterator&lt;AsyncCall&gt; i = readyAsyncCalls.iterator(); i.hasNext(); ) { AsyncCall call = i.next(); //å¦‚æœæ‹¿åˆ°çš„ç­‰å¾…è¯·æ±‚hostï¼Œåœ¨è¯·æ±‚çš„åˆ—è¡¨ä¸­å·²ç»å­˜åœ¨5ä¸ª if (runningCallsForHost(call) &lt; maxRequestsPerHost) { //ç­‰å¾…ç§»é™¤ i.remove(); //åŠ å…¥running runningAsyncCalls.add(call); //åŠ å…¥çº¿ç¨‹æ±  executorService().execute(call); } //åˆ¤æ–­æ­£åœ¨æ‰§è¡Œé˜Ÿåˆ—æ•° if (runningAsyncCalls.size() &gt;= maxRequests) return; // Reached max capacity. }} A:ThreadPoolExecutor å½“ä¸€ä¸ªä»»åŠ¡é€šè¿‡execute(Runnable)æ–¹æ³•æ·»åŠ åˆ°çº¿ç¨‹æ± æ—¶ï¼š çº¿ç¨‹æ•°é‡å°äºcorePoolSizeï¼Œæ–°å»ºçº¿ç¨‹(æ ¸å¿ƒ)æ¥å¤„ç†è¢«æ·»åŠ çš„ä»»åŠ¡ï¼› çº¿ç¨‹æ•°é‡å¤§äºç­‰äº corePoolSizeï¼Œå­˜åœ¨ç©ºé—²çº¿ç¨‹ï¼Œä½¿ç”¨ç©ºé—²çº¿ç¨‹æ‰§è¡Œæ–°ä»»åŠ¡ï¼›- çº¿ç¨‹æ•°é‡å¤§äºç­‰äº corePoolSizeï¼Œä¸å­˜åœ¨ç©ºé—²çº¿ç¨‹ï¼Œæ–°ä»»åŠ¡è¢«æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œæ·»åŠ æˆåŠŸåˆ™ç­‰å¾…ç©ºé—²çº¿ç¨‹ï¼Œæ·»åŠ å¤±è´¥ï¼š çº¿ç¨‹æ•°é‡å°äºmaximumPoolSizeï¼Œæ–°å»ºçº¿ç¨‹æ‰§è¡Œæ–°ä»»åŠ¡ï¼› çº¿ç¨‹æ•°é‡ç­‰äºmaximumPoolSizeï¼Œæ‹’ç»æ­¤ä»»åŠ¡ã€‚ 1234567891011121314public synchronized ExecutorService executorService() { if (executorService == null) { //corePoolSize:æ ¸å¿ƒçº¿ç¨‹æ•° 0 ä¸ç¼“å­˜çº¿ç¨‹ï¼Œï¼ˆ0å’Œ1çš„è¡¨ç°æ˜¯ä¸€æ ·çš„ï¼‰ä¸ç”¨æ—¶å°±ä¸å ç”¨çº¿ç¨‹ï¼Œé—²ç½®60å°±ä¼šå›æ”¶æ‰ //maximumPoolSizeæœ€å¤§çº¿ç¨‹æ•°ï¼ˆåŒ…æ‹¬æ ¸å¿ƒï¼‰ //keepAliveTime ç¼“å­˜60ç§’ //workQueue é˜Ÿåˆ— //threadFactory åˆ›å»ºä¸€ä¸ªthread //PS:å’ŒExecutors.newCachedThreadPool();åˆ›å»ºçš„çº¿ç¨‹æ± ä¸€æ · executorService = new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(&quot;OkHttp Dispatcher&quot;, false)); } return executorService;} SynchronousQueue implements BlockingQueue æ˜¯ä¸ªé˜»å¡é˜Ÿåˆ— PS:ä¸‰ç§é˜»å¡é˜Ÿåˆ— ArrayBlockingQueueï¼šåŸºäºæ•°ç»„çš„é˜»å¡é˜Ÿåˆ—ï¼Œåˆå§‹åŒ–éœ€è¦æŒ‡å®šå›ºå®šå¤§å°ã€‚ LinkedBlockingQueueï¼šåŸºäºé“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ï¼Œåˆå§‹åŒ–å¯ä»¥æŒ‡å®šå¤§å°ï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šã€‚ SynchronousQueue : æ— å®¹é‡çš„é˜Ÿåˆ—ã€‚ å¾€é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ ä¸€å®šæ˜¯å¤±è´¥çš„ã€‚ OkHttpçº¿ç¨‹æ± çš„ç‰¹ç‚¹ï¼šOkHttpæäº¤è¯·æ±‚ï¼Œä¸€å®šæ˜¯å¾€é˜Ÿåˆ—é‡Œæäº¤ï¼Œå¾€é˜Ÿåˆ—ä¸­æ·»åŠ æ˜¯ä¸€å®šæ˜¯å¤±è´¥çš„ï¼Œé©¬ä¸Šæ–°å»ºçº¿ç¨‹ï¼ˆæ²¡æœ‰åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼‰ï¼Œ ä¸éœ€è¦ç­‰å¾…ã€‚è·å¾—æœ€å¤§çš„å¹¶å‘é‡ AsyncCallç»§æ‰¿NamedRunnableç±»å®ç°Runnableæ¥å£ 12345678910111213141516171819202122public abstract class NamedRunnable implements Runnable { protected final String name; public NamedRunnable(String format, Object... args) { this.name = Util.format(format, args); } /** * runæ–¹æ³•å…¶å®è°ƒç”¨çš„AsyncCallçš„execute() */ @Override public final void run() { String oldName = Thread.currentThread().getName(); Thread.currentThread().setName(name); try { execute(); } finally { Thread.currentThread().setName(oldName); } } protected abstract void execute();} åŒæ­¥è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œæ‰§è¡Œå®Œç§»é™¤é˜Ÿåˆ— 1234synchronized void executed(RealCall call) { //åŒæ­¥ç›´æ¥åŠ å…¥runningé˜Ÿåˆ—ï¼Œè¿™é‡Œçš„runningæ˜¯åŒæ­¥é˜Ÿåˆ—ä¸æ˜¯å¼‚æ­¥çš„ runningSyncCalls.add(call);} æ‹¦æˆªå™¨ï¼šé»˜è®¤äº”å¤§æ‹¦æˆªå™¨ï¼šï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰é‡å®šå‘ä¸é‡è¯•ï¼ŒHeaderã€Bodyå¤„ç†ï¼Œç¼“å­˜å¤„ç†ï¼Œè¿æ¥å¤„ç†ï¼ŒæœåŠ¡å™¨é€šè®¯ è¯·æ±‚æ˜¯é¡ºåºçš„ï¼Œå“åº”æ˜¯é€†åºçš„ è·å–å“åº”ï¼šæ— è®ºåŒæ­¥è¿˜æ˜¯å¼‚å¸¸éƒ½æ˜¯é€šè¿‡getResponseWithInterceptorChain è·å¾—è¯·æ±‚ç»“æœï¼šResponse 123456789101112131415161718192021222324Response getResponseWithInterceptorChain() throws IOException { // æ‹¦æˆªå™¨é›†åˆ List&lt;Interceptor&gt; interceptors = new ArrayList&lt;&gt;(); interceptors.addAll(client.interceptors()); //é‡å®šå‘ä¸é‡è¯• interceptors.add(retryAndFollowUpInterceptor); //Header,Bodyå¤„ç† interceptors.add(new BridgeInterceptor(client.cookieJar())); //ç¼“å­˜å¤„ç† interceptors.add(new CacheInterceptor(client.internalCache())); //è¿æ¥å¤„ç† interceptors.add(new ConnectInterceptor(client)); if (!forWebSocket) { interceptors.addAll(client.networkInterceptors()); } //æœåŠ¡å™¨é€šè®¯ interceptors.add(new CallServerInterceptor(forWebSocket)); Interceptor.Chain chain = new RealInterceptorChain(interceptors, null, null, null, 0, originalRequest, this, eventListener, client.connectTimeoutMillis(), client.readTimeoutMillis(), client.writeTimeoutMillis()); return chain.proceed(originalRequest);} è´£ä»»é“¾æ¨¡å¼ï¼šï¼ˆä¸€æ’ï¼Œæœ€åä¸€ä½å¾€å‰ä¸€ä¸ªä¸ªä¼ çº¸æ¡[è¯·æ±‚]ï¼Œä¼ åˆ°ç¬¬ä¸€ä¸ªåˆä¸€ä¸ªä¸ªå¾€åä¼ [å“åº”]ï¼‰ ä¸ºè¯·æ±‚åˆ›å»ºäº†ä¸€ä¸ªæ¥æ”¶è€…å¯¹è±¡çš„é“¾ï¼Œåœ¨å¤„ç†è¯·æ±‚çš„æ—¶å€™æ‰§è¡Œè¿‡æ»¤(å„å¸å…¶èŒ)ã€‚ è´£ä»»é“¾ä¸Šçš„å¤„ç†è€…è´Ÿè´£å¤„ç†è¯·æ±‚ï¼Œå®¢æˆ·åªéœ€è¦å°†è¯·æ±‚å‘é€åˆ°è´£ä»»é“¾å³å¯ï¼Œæ— é¡»å…³å¿ƒè¯·æ±‚çš„å¤„ç†ç»†èŠ‚å’Œè¯·æ±‚çš„ä¼ é€’ï¼Œæ‰€ä»¥èŒè´£é“¾å°†è¯·æ±‚çš„å‘é€è€…å’Œè¯·æ±‚çš„å¤„ç†è€…è§£è€¦äº†ã€‚ æ‹¦æˆªå™¨è´£ä»»é“¾ï¼š äº”å¤§æ‹¦æˆªå™¨åŠŸèƒ½ï¼š é‡è¯•æ‹¦æˆªå™¨åœ¨äº¤å‡º(äº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨)ä¹‹å‰ï¼Œè´Ÿè´£åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å–æ¶ˆäº†è¯·æ±‚ï¼›åœ¨è·å¾—äº†ç»“æœä¹‹åï¼Œä¼šæ ¹æ®å“åº”ç åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šå‘ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶é‚£ä¹ˆå°±ä¼šé‡å¯æ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨ã€‚ æ¡¥æ¥æ‹¦æˆªå™¨åœ¨äº¤å‡ºä¹‹å‰ï¼Œè´Ÿè´£å°†HTTPåè®®å¿…å¤‡çš„è¯·æ±‚å¤´åŠ å…¥å…¶ä¸­(å¦‚ï¼šHost)å¹¶æ·»åŠ ä¸€äº›é»˜è®¤çš„è¡Œä¸º(å¦‚ï¼šGZIPå‹ç¼©)ï¼›åœ¨è·å¾—äº†ç»“æœåï¼Œè°ƒç”¨ä¿å­˜cookieæ¥å£å¹¶è§£æGZIPæ•°æ®ã€‚ ç¼“å­˜æ‹¦æˆªå™¨é¡¾åæ€ä¹‰ï¼Œäº¤å‡ºä¹‹å‰è¯»å–å¹¶åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ç¼“å­˜ï¼›è·å¾—ç»“æœååˆ¤æ–­æ˜¯å¦ç¼“å­˜ã€‚ è¿æ¥æ‹¦æˆªå™¨åœ¨äº¤å‡ºä¹‹å‰ï¼Œè´Ÿè´£æ‰¾åˆ°æˆ–è€…æ–°å»ºä¸€ä¸ªè¿æ¥ï¼Œå¹¶è·å¾—å¯¹åº”çš„socketæµï¼›åœ¨è·å¾—ç»“æœåä¸è¿›è¡Œé¢å¤–çš„å¤„ç†ã€‚ è¯·æ±‚æœåŠ¡å™¨æ‹¦æˆªå™¨è¿›è¡ŒçœŸæ­£çš„ä¸æœåŠ¡å™¨çš„é€šä¿¡ï¼Œå‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè§£æè¯»å–çš„å“åº”æ•°æ®ã€‚ æ‹¦æˆªå™¨è¯¦æƒ…ï¼šä¸€ã€é‡è¯•åŠé‡å®šå‘æ‹¦æˆªå™¨ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨:RetryAndFollowUpInterceptorï¼Œä¸»è¦å°±æ˜¯å®Œæˆä¸¤ä»¶äº‹æƒ…ï¼šé‡è¯•ä¸é‡å®šå‘ã€‚ é‡è¯•åœºæ™¯ï¼šè¯·æ±‚è¶…æ—¶ï¼›åŸŸåè§£æåå¤šä¸ªIPï¼Œå¦‚æœä¸€ä¸ªIPå¤±è´¥äº†ï¼Œé‡è¯•å…¶ä»–IP è®¾ç½®æ˜¯å¦å…è®¸é‡è¯• 12//è®¾ç½®æ˜¯å¦å…è®¸é‡è¯• é»˜è®¤æ˜¯å…è®¸new OkHttpClient().newBuilder().retryOnConnectionFailure(true); åœ¨RetryAndFollowUpInterceptorä¸­å¤±è´¥æ—¶ï¼Œè¿›å…¥recoveræ–¹æ³• 12345678910111213141516171819202122try { //todo è¯·æ±‚å‡ºç°äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆreleaseConnectionä¾æ—§ä¸ºtrueã€‚ response = realChain.proceed(request, streamAllocation, null, null); releaseConnection = false;} catch (RouteException e) { //todo è·¯ç”±å¼‚å¸¸ï¼Œè¿æ¥æœªæˆåŠŸï¼Œè¯·æ±‚è¿˜æ²¡å‘å‡ºå» //The attempt to connect via a route failed. The request will not have been sent. if (!recover(e.getLastConnectException(), streamAllocation, false, request)) { throw e.getLastConnectException(); } releaseConnection = false; //é‡è¯• continue;} catch (IOException e) { //todo è¯·æ±‚å‘å‡ºå»äº†ï¼Œä½†æ˜¯å’ŒæœåŠ¡å™¨é€šä¿¡å¤±è´¥äº†ã€‚(socketæµæ­£åœ¨è¯»å†™æ•°æ®çš„æ—¶å€™æ–­å¼€è¿æ¥) // ConnectionShutdownExceptionåªå¯¹HTTP2å­˜åœ¨ã€‚å‡å®šå®ƒå°±æ˜¯false //An attempt to communicate with a server failed. The request may have been sent. boolean requestSendStarted = !(e instanceof ConnectionShutdownException); if (!recover(e, streamAllocation, requestSendStarted, request)) throw e; releaseConnection = false; continue;} åœ¨recoverä¸­ è·å–æ˜¯å¦å…è®¸é‡è¯•ï¼Œå¦‚æœä¸å…è®¸å°±æŠ›å¼‚å¸¸ï¼Œç»“æŸã€‚ 123456789101112131415161718192021222324private boolean recover(IOException e, StreamAllocation streamAllocation, boolean requestSendStarted, Request userRequest) { streamAllocation.streamFailed(e); //todo 1ã€åœ¨é…ç½®OkhttpClientæ˜¯è®¾ç½®äº†ä¸å…è®¸é‡è¯•ï¼ˆé»˜è®¤å…è®¸ï¼‰ï¼Œåˆ™ä¸€æ—¦å‘ç”Ÿè¯·æ±‚å¤±è´¥å°±ä¸å†é‡è¯• //The application layer has forbidden retries. if (!client.retryOnConnectionFailure()) return false; //todo 2ã€ç”±äºrequestSendStartedåªåœ¨http2çš„ioå¼‚å¸¸ä¸­ä¸ºtrueï¼Œå…ˆä¸ç®¡http2 //We can't send the request body again. if (requestSendStarted &amp;&amp; userRequest.body() instanceof UnrepeatableRequestBody) return false; //todo 3ã€åˆ¤æ–­æ˜¯ä¸æ˜¯å±äºé‡è¯•çš„å¼‚å¸¸ //This exception is fatal. if (!isRecoverable(e, requestSendStarted)) return false; //todo 4ã€æ˜¯ä¸æ˜¯å­˜åœ¨æ›´å¤šçš„è·¯çº¿ ï¼ˆå¤šä¸ªipï¼Œå¤šä¸ªä»£ç†ï¼‰ //No more routes to attempt. if (!streamAllocation.hasMoreRoutes()) return false; // For failure recovery, use the same route selector with a new connection. return true; } é‡è¯•çš„å¼‚å¸¸åŒ…æ‹¬å“ªäº›ï¼š åœ¨ todo 3çš„isRecoverableæ–¹æ³•ä¸­ 12345678910111213141516171819202122232425262728private boolean isRecoverable(IOException e, boolean requestSendStarted) { // 1.æ˜¯ä¸æ˜¯åè®®å¼‚å¸¸ï¼ˆcodeä¸º204,205ä»£è¡¨æ²¡æœ‰å“åº”ä½“ï¼ŒåŒæ—¶å“åº”æ•°æ®é•¿åº¦è¿˜å¤§äº0ä¸¤éƒ½å†²çªï¼Œå‚ç…§CallServerInterceptorä¸­ // if ((code == 204 || code == 205) &amp;&amp; response.body().contentLength() &gt; 0)ï¼‰ //ï¼šä¸é‡è¯• if (e instanceof ProtocolException) { return false; } //2.socketè¶…æ—¶å¼‚å¸¸ è¿”å›true:é‡è¯• if (e instanceof InterruptedIOException) { return e instanceof SocketTimeoutException &amp;&amp; !requestSendStarted; } //3.//SSLè¯ä¹¦ä¸æ­£ç¡® å¯èƒ½è¯ä¹¦æ ¼å¼æŸå æœ‰é—®é¢˜ï¼šä¸é‡è¯• if (e instanceof SSLHandshakeException) { // If the problem was a CertificateException from the X509TrustManager, // do not retry. if (e.getCause() instanceof CertificateException) { return false; } } //4.SSLè¯ä¹¦æ ¡éªŒ ï¼šä¸é‡è¯• if (e instanceof SSLPeerUnverifiedException) { return false; } return true;} æ‰€ä»¥åœ¨socketè¶…æ—¶å¼‚å¸¸æ—¶ä¼šè¿›è¡Œé‡è¯•ï¼Œå…¶ä»–å¼‚å¸¸ä¸å†è¿›è¡Œé‡è¯• é‡å®šå‘åœºæ™¯ï¼š30Xï¼Œèµ„æºæ”¹å˜ æœ€å¤§é‡å®šå‘æ¬¡æ•°ä¸ºï¼š20 12345678//todo å¤„ç†3å’Œ4xxçš„ä¸€äº›çŠ¶æ€ç ï¼Œå¦‚301 302é‡å®šå‘Request followUp = followUpRequest(response, streamAllocation.route());if (followUp == null) { if (!forWebSocket) { streamAllocation.release(); } return response;} 1Request followUpRequest(Response userResponse, Route route) åœ¨followUpRequestä¸­å“åº”ç  407: 1234567891011//407 èº«ä»½æ ¡éªŒcase HTTP_PROXY_AUTH: Proxy selectedProxy = route != null ? route.proxy() : client.proxy(); if (selectedProxy.type() != Proxy.Type.HTTP) { throw new ProtocolException(&quot;Received HTTP_PROXY_AUTH (407) code while not &quot; + &quot;using proxy&quot;); } //ç”¨æˆ·æ²¡æœ‰è®¾ç½®å°±è¿”å›null,é‡å®šå‘å°±ç»“æŸäº† return client.proxyAuthenticator().authenticate(route, userResponse); ç”¨æˆ·è®¾ç½®èº«ä»½æ ¡éªŒ 123456789101112131415//è®¾ç½®èº«ä»½æ ¡éªŒçš„ä»£ç†new OkHttpClient.Builder().proxy(new Proxy(Proxy.Type.HTTP, new InetSocketAddress( &quot;localhost&quot;, 8080)))//è®¾ç½®èº«ä»½æ ¡éªŒ(é»˜è®¤ä¸è®¾ç½®è¿™ä¸ªï¼‰.proxyAuthenticator(new Authenticator() { @Nullable @Override public Request authenticate(Route route, Response response) throws IOException { //å‚ç…§Authenticatoræ¥å£æ³¨é‡Š return response.request().newBuilder() .header(&quot;Proxy-Authorization&quot;, Credentials.basic(&quot;ç”¨æˆ·å&quot;,&quot;å¯†ç &quot;)) .build(); }}).build(); 401: 1234// 401 éœ€è¦èº«ä»½éªŒè¯ æœ‰äº›æœåŠ¡å™¨æ¥å£éœ€è¦éªŒè¯ä½¿ç”¨è€…èº«ä»½ åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  â€œAuthorizationâ€case HTTP_UNAUTHORIZED: //ç±»ä¼¼407èº«ä»½éªŒè¯ï¼Œè®¾ç½®authenticator() return client.authenticator().authenticate(route, userResponse); é‡å®šå‘ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556// 308 æ°¸ä¹…é‡å®šå‘// 307 ä¸´æ—¶é‡å®šå‘case HTTP_PERM_REDIRECT:case HTTP_TEMP_REDIRECT: // å¦‚æœè¯·æ±‚æ–¹å¼ä¸æ˜¯GETæˆ–è€…HEADï¼Œæ¡†æ¶ä¸ä¼šè‡ªåŠ¨é‡å®šå‘è¯·æ±‚ if (!method.equals(&quot;GET&quot;) &amp;&amp; !method.equals(&quot;HEAD&quot;)) { return null; } // 300 301 302 303case HTTP_MULT_CHOICE:case HTTP_MOVED_PERM:case HTTP_MOVED_TEMP:case HTTP_SEE_OTHER: // å¦‚æœç”¨æˆ·ä¸å…è®¸é‡å®šå‘ï¼Œé‚£å°±è¿”å›null if (!client.followRedirects()) return null; // ä»å“åº”å¤´å–å‡ºlocation String location = userResponse.header(&quot;Location&quot;); if (location == null) return null; // æ ¹æ®location é…ç½®æ–°çš„è¯·æ±‚ url HttpUrl url = userResponse.request().url().resolve(location); // å¦‚æœä¸ºnullï¼Œè¯´æ˜åè®®æœ‰é—®é¢˜ï¼Œå–ä¸å‡ºæ¥HttpUrlï¼Œé‚£å°±è¿”å›nullï¼Œä¸è¿›è¡Œé‡å®šå‘ if (url == null) return null; // å¦‚æœé‡å®šå‘åœ¨httpåˆ°httpsä¹‹é—´åˆ‡æ¢ï¼Œéœ€è¦æ£€æŸ¥ç”¨æˆ·æ˜¯ä¸æ˜¯å…è®¸(é»˜è®¤å…è®¸) boolean sameScheme = url.scheme().equals(userResponse.request().url().scheme()); if (!sameScheme &amp;&amp; !client.followSslRedirects()) return null; Request.Builder requestBuilder = userResponse.request().newBuilder(); /** * é‡å®šå‘è¯·æ±‚ä¸­ åªè¦ä¸æ˜¯ PROPFIND è¯·æ±‚ï¼Œæ— è®ºæ˜¯POSTè¿˜æ˜¯å…¶ä»–çš„æ–¹æ³•éƒ½è¦æ”¹ä¸ºGETè¯·æ±‚æ–¹å¼ï¼Œ * å³åªæœ‰ PROPFIND è¯·æ±‚æ‰èƒ½æœ‰è¯·æ±‚ä½“ */ //è¯·æ±‚ä¸æ˜¯getä¸head if (HttpMethod.permitsRequestBody(method)) { final boolean maintainBody = HttpMethod.redirectsWithBody(method); // é™¤äº† PROPFIND è¯·æ±‚ä¹‹å¤–éƒ½æ”¹æˆGETè¯·æ±‚ if (HttpMethod.redirectsToGet(method)) { requestBuilder.method(&quot;GET&quot;, null); } else { RequestBody requestBody = maintainBody ? userResponse.request().body() : null; requestBuilder.method(method, requestBody); } // ä¸æ˜¯ PROPFIND çš„è¯·æ±‚ï¼ŒæŠŠè¯·æ±‚å¤´ä¸­å…³äºè¯·æ±‚ä½“çš„æ•°æ®åˆ æ‰ if (!maintainBody) { requestBuilder.removeHeader(&quot;Transfer-Encoding&quot;); requestBuilder.removeHeader(&quot;Content-Length&quot;); requestBuilder.removeHeader(&quot;Content-Type&quot;); } } // åœ¨è·¨ä¸»æœºé‡å®šå‘æ—¶ï¼Œåˆ é™¤èº«ä»½éªŒè¯è¯·æ±‚å¤´ if (!sameConnection(userResponse, url)) { requestBuilder.removeHeader(&quot;Authorization&quot;); } return requestBuilder.url(url).build(); 408è¯·æ±‚è¶…æ—¶ï¼š 123456789101112131415161718192021// 408 å®¢æˆ·ç«¯è¯·æ±‚è¶…æ—¶ case HTTP_CLIENT_TIMEOUT: // 408 ç®—æ˜¯è¿æ¥å¤±è´¥äº†ï¼Œæ‰€ä»¥åˆ¤æ–­ç”¨æˆ·æ˜¯ä¸æ˜¯å…è®¸é‡è¯• if (!client.retryOnConnectionFailure()) { return null; } // UnrepeatableRequestBodyå®é™…å¹¶æ²¡å‘ç°æœ‰å…¶ä»–åœ°æ–¹ç”¨åˆ° if (userResponse.request().body() instanceof UnrepeatableRequestBody) { return null; } // å¦‚æœæ˜¯æœ¬èº«è¿™æ¬¡çš„å“åº”å°±æ˜¯é‡æ–°è¯·æ±‚çš„äº§ç‰©åŒæ—¶ä¸Šä¸€æ¬¡ä¹‹æ‰€ä»¥é‡è¯·æ±‚è¿˜æ˜¯å› ä¸º408ï¼Œé‚£æˆ‘ä»¬è¿™æ¬¡ä¸å†é‡è¯·æ±‚äº† if (userResponse.priorResponse() != null &amp;&amp; userResponse.priorResponse().code() == HTTP_CLIENT_TIMEOUT) { return null; } // å¦‚æœæœåŠ¡å™¨å‘Šè¯‰æˆ‘ä»¬äº† Retry-After å¤šä¹…åé‡è¯•ï¼Œé‚£æ¡†æ¶ä¸ç®¡äº†ã€‚ if (retryAfter(userResponse, 0) &gt; 0) { return null; } return userResponse.request(); 503: // 503 æœåŠ¡ä¸å¯ç”¨ å’Œ408å·®ä¸å¤šï¼Œä½†æ˜¯åªåœ¨æœåŠ¡å™¨å‘Šè¯‰ä½  Retry-Afterï¼š0ï¼ˆæ„æ€å°±æ˜¯ç«‹å³é‡è¯•ï¼‰ æ‰é‡è¯·æ±‚ 12345678910case HTTP_UNAVAILABLE: if (userResponse.priorResponse() != null &amp;&amp; userResponse.priorResponse().code() == HTTP_UNAVAILABLE) { return null; }if (retryAfter(userResponse, Integer.MAX_VALUE) == 0) { return userResponse.request();}return null; é‡å®šå‘æ€»ç»“ï¼šæœåŠ¡å™¨è¿”å›300 301 302 303éœ€è¦é‡å®šå‘ï¼Œä¼šè·å–è¿”å›å¤´çš„Locationä¸­çš„æ–°åœ°å€ã€‚ å¦‚æœæ­¤æ–¹æ³•followUpRequestè¿”å›ç©ºï¼Œé‚£å°±è¡¨ç¤ºä¸éœ€è¦å†é‡å®šå‘äº†ï¼Œç›´æ¥è¿”å›å“åº”ï¼›ä½†æ˜¯å¦‚æœè¿”å›éç©ºï¼Œé‚£å°±è¦é‡æ–°è¯·æ±‚è¿”å›çš„Requestï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„followupåœ¨æ‹¦æˆªå™¨ä¸­å®šä¹‰çš„æœ€å¤§æ¬¡æ•°ä¸º20æ¬¡ã€‚ æ€»ç»“æœ¬æ‹¦æˆªå™¨æ˜¯æ•´ä¸ªè´£ä»»é“¾ä¸­çš„ç¬¬ä¸€ä¸ªï¼Œè¿™æ„å‘³ç€å®ƒä¼šæ˜¯é¦–æ¬¡æ¥è§¦åˆ°Requestä¸æœ€åæ¥æ”¶åˆ°Responseçš„è§’è‰²ï¼Œåœ¨è¿™ä¸ªæ‹¦æˆªå™¨ä¸­ä¸»è¦åŠŸèƒ½å°±æ˜¯åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•ä¸é‡å®šå‘ã€‚ é‡è¯•çš„å‰ææ˜¯å‡ºç°äº†RouteExceptionæˆ–è€…IOExceptionã€‚ä¸€ä½†åœ¨åç»­çš„æ‹¦æˆªå™¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°è¿™ä¸¤ä¸ªå¼‚å¸¸ï¼Œå°±ä¼šé€šè¿‡recoveræ–¹æ³•è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¿›è¡Œè¿æ¥é‡è¯•ã€‚ é‡å®šå‘å‘ç”Ÿåœ¨é‡è¯•çš„åˆ¤å®šä¹‹åï¼Œå¦‚æœä¸æ»¡è¶³é‡è¯•çš„æ¡ä»¶ï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥è°ƒç”¨followUpRequestæ ¹æ®Response çš„å“åº”ç (å½“ç„¶ï¼Œå¦‚æœç›´æ¥è¯·æ±‚å¤±è´¥ï¼ŒResponseéƒ½ä¸å­˜åœ¨å°±ä¼šæŠ›å‡ºå¼‚å¸¸)ã€‚followupæœ€å¤§å‘ç”Ÿ20æ¬¡ã€‚ äºŒã€æ¡¥æ¥æ‹¦æˆªå™¨ä¸¤å¤§ä½œç”¨ï¼šè¡¥å…¨è¯·æ±‚å¤´ï¼Œå¤„ç†å“åº”ï¼ˆä¿å­˜cookieï¼ŒGzipSourceï¼‰ è¡¥å…¨è¯·æ±‚ä¸å“åº”åå¤„ç† è¯·æ±‚å¤´ è¯´æ˜ Content-Type è¯·æ±‚ä½“ç±»å‹,å¦‚ï¼šapplication/x-www-form-urlencoded Content-Length/Transfer-Encoding è¯·æ±‚ä½“è§£ææ–¹å¼ Host è¯·æ±‚çš„ä¸»æœºç«™ç‚¹ Connection: Keep-Alive ä¿æŒé•¿è¿æ¥ Accept-Encoding: gzip æ¥å—å“åº”æ”¯æŒgzipå‹ç¼© Cookie cookieèº«ä»½è¾¨åˆ« User-Agent è¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚:æ“ä½œç³»ç»Ÿã€æµè§ˆå™¨ç­‰ å¾—åˆ°å“åº”ï¼š 1ã€è¯»å–Set-Cookieå“åº”å¤´å¹¶è°ƒç”¨æ¥å£å‘ŠçŸ¥ç”¨æˆ·ï¼Œåœ¨ä¸‹æ¬¡è¯·æ±‚åˆ™ä¼šè¯»å–å¯¹åº”çš„æ•°æ®è®¾ç½®è¿›å…¥è¯·æ±‚å¤´ï¼Œé»˜è®¤CookieJaræ— å®ç°ï¼› â€‹ 2ã€å“åº”å¤´Content-Encodingä¸ºgzipï¼Œä½¿ç”¨GzipSourceåŒ…è£…ä¾¿äºè§£æã€‚ æ€»ç»“æ¡¥æ¥æ‹¦æˆªå™¨çš„æ‰§è¡Œé€»è¾‘ä¸»è¦å°±æ˜¯ä»¥ä¸‹å‡ ç‚¹ å¯¹ç”¨æˆ·æ„å»ºçš„Requestè¿›è¡Œæ·»åŠ æˆ–è€…åˆ é™¤ç›¸å…³å¤´éƒ¨ä¿¡æ¯ï¼Œä»¥è½¬åŒ–æˆèƒ½å¤ŸçœŸæ­£è¿›è¡Œç½‘ç»œè¯·æ±‚çš„Requestå°†ç¬¦åˆç½‘ç»œè¯·æ±‚è§„èŒƒçš„Requestäº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨å¤„ç†ï¼Œå¹¶è·å–Responseå¦‚æœå“åº”ä½“ç»è¿‡äº†GZIPå‹ç¼©ï¼Œé‚£å°±éœ€è¦è§£å‹ï¼Œå†æ„å»ºæˆç”¨æˆ·å¯ç”¨çš„Responseå¹¶è¿”å› ä¸‰ã€ç¼“å­˜æ‹¦æˆªå™¨CacheInterceptorï¼Œåœ¨å‘å‡ºè¯·æ±‚å‰ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­ç¼“å­˜ã€‚å¦‚æœå‘½ä¸­åˆ™å¯ä»¥ä¸è¯·æ±‚ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜çš„å“åº”ã€‚ (åªä¼šå­˜åœ¨Getè¯·æ±‚çš„ç¼“å­˜) æ­¥éª¤ä¸º: 1ã€ä»ç¼“å­˜ä¸­è·å¾—å¯¹åº”è¯·æ±‚çš„å“åº”ç¼“å­˜ 2ã€åˆ›å»ºCacheStrategy ,åˆ›å»ºæ—¶ä¼šåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿä½¿ç”¨ç¼“å­˜ï¼Œåœ¨CacheStrategy ä¸­å­˜åœ¨ä¸¤ä¸ªæˆå‘˜:networkRequestä¸cacheResponseã€‚ä»–ä»¬çš„ç»„åˆå¦‚ä¸‹: networkRequest cacheResponse è¯´æ˜ Null Not Null ç›´æ¥ä½¿ç”¨ç¼“å­˜ Not Null Null å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚ Null Null ç›´æ¥ggï¼Œokhttpç›´æ¥è¿”å›504 Not Null Not Null å‘èµ·è¯·æ±‚ï¼Œè‹¥å¾—åˆ°å“åº”ä¸º304(æ— ä¿®æ”¹)ï¼Œåˆ™æ›´æ–°ç¼“å­˜å“åº”å¹¶è¿”å› å³ï¼šnetworkRequestå­˜åœ¨åˆ™ä¼˜å…ˆå‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œå¦åˆ™ä½¿ç”¨cacheResponseç¼“å­˜ï¼Œè‹¥éƒ½ä¸å­˜åœ¨åˆ™è¯·æ±‚å¤±è´¥ï¼ 3ã€äº¤ç»™ä¸‹ä¸€ä¸ªè´£ä»»é“¾ç»§ç»­å¤„ç† 4ã€åç»­å·¥ä½œï¼Œè¿”å›304åˆ™ç”¨ç¼“å­˜çš„å“åº”ï¼›å¦åˆ™ä½¿ç”¨ç½‘ç»œå“åº”å¹¶ç¼“å­˜æœ¬æ¬¡å“åº”ï¼ˆåªç¼“å­˜Getè¯·æ±‚çš„å“åº”ï¼‰ ç¼“å­˜æ‹¦æˆªå™¨çš„å·¥ä½œè¯´èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°ï¼Œéœ€è¦å¤„ç†çš„å†…å®¹å¾ˆå¤šã€‚åœ¨ç¼“å­˜æ‹¦æˆªå™¨ä¸­åˆ¤æ–­æ˜¯å¦å¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼Œæˆ–æ˜¯è¯·æ±‚æœåŠ¡å™¨éƒ½æ˜¯é€šè¿‡CacheStrategyåˆ¤æ–­ã€‚ ç¼“å­˜ç­–ç•¥123//todo ç¼“å­˜ç­–ç•¥:æ ¹æ®å„ç§æ¡ä»¶(è¯·æ±‚å¤´)ç»„æˆ è¯·æ±‚ä¸ç¼“å­˜CacheStrategy strategy = new CacheStrategy.Factory(now, chain.request(), cacheCandidate).get(); 12345678910public CacheStrategy get() { CacheStrategy candidate = getCandidate(); //todo å¦‚æœå¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼Œé‚£networkRequestå¿…å®šä¸ºnullï¼›æŒ‡å®šäº†åªä½¿ç”¨ç¼“å­˜ä½†æ˜¯networkRequeståˆä¸ä¸ºnullï¼Œå†²çªã€‚é‚£å°±gg(æ‹¦æˆªå™¨è¿”å›504) if (candidate.networkRequest != null &amp;&amp; request.cacheControl().onlyIfCached()) { // We're forbidden from using the network and the cache is insufficient. return new CacheStrategy(null, null); } return candidate;} æµç¨‹ï¼š æ²¡æœ‰ç¼“å­˜ï¼Œå°±è¿›è¡Œç½‘ç»œè¯·æ±‚ å¦‚æœæ˜¯Httpsè¯·æ±‚ï¼Œç¼“å­˜ä¸­æ²¡æœ‰ä¿å­˜æ¡æ‰‹ä¿¡æ¯ï¼Œå‘èµ·ç½‘ç»œè¯·æ±‚ é€šè¿‡å“åº”ç ä»¥åŠå¤´éƒ¨ç¼“å­˜æ§åˆ¶å­—æ®µåˆ¤æ–­å“åº”èƒ½ä¸èƒ½ç¼“å­˜ï¼Œä¸èƒ½ç¼“å­˜é‚£å°±è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼ˆisCacheableæ–¹æ³•ï¼‰ï¼šä¸å…è®¸ç”¨ å¦‚æœè¯·æ±‚åŒ…å«ï¼šCacheControl:no-cache éœ€è¦ä¸æœåŠ¡å™¨éªŒè¯ç¼“å­˜æœ‰æ•ˆæ€§ï¼ˆç”¨æˆ·é…ç½®ä¸è¿›è¡Œç¼“å­˜ï¼‰ï¼šä¸æƒ³ç”¨ å¦‚æœç¼“å­˜å“åº”ä¸­å­˜åœ¨ Cache-Control:immutable å“åº”å†…å®¹å°†ä¸€ç›´ä¸ä¼šæ”¹å˜,å¯ä»¥ä½¿ç”¨ç¼“å­˜ å“åº”çš„ç¼“å­˜æœ‰æ•ˆæœŸ è¿™ä¸€æ­¥ä¸ºè¿›ä¸€æ­¥æ ¹æ®ç¼“å­˜å“åº”ä¸­çš„ä¸€äº›ä¿¡æ¯åˆ¤å®šç¼“å­˜æ˜¯å¦å¤„äºæœ‰æ•ˆæœŸå†…ã€‚å¦‚æœæ»¡è¶³ï¼š ç¼“å­˜å­˜æ´»æ—¶é—´ &lt; ç¼“å­˜æ–°é²œåº¦ - ç¼“å­˜æœ€å°æ–°é²œåº¦ + è¿‡æœŸåç»§ç»­ä½¿ç”¨æ—¶é•¿ ä»£è¡¨å¯ä»¥ä½¿ç”¨ç¼“å­˜ã€‚å…¶ä¸­æ–°é²œåº¦å¯ä»¥ç†è§£ä¸ºæœ‰æ•ˆæ—¶é—´ï¼Œè€Œè¿™é‡Œçš„ â€œç¼“å­˜æ–°é²œåº¦-ç¼“å­˜æœ€å°æ–°é²œåº¦â€ å°±ä»£è¡¨äº†ç¼“å­˜çœŸæ­£æœ‰æ•ˆçš„æ—¶é—´ã€‚ ç¼“å­˜è¿‡æœŸå¤„ç† å¦‚æœç»§ç»­æ‰§è¡Œï¼Œè¡¨ç¤ºç¼“å­˜å·²ç»è¿‡æœŸæ— æ³•ä½¿ç”¨ã€‚æ­¤æ—¶æˆ‘ä»¬åˆ¤å®šç¼“å­˜çš„å“åº”ä¸­å¦‚æœå­˜åœ¨Etagï¼Œåˆ™ä½¿ç”¨If-None-Matchäº¤ç»™æœåŠ¡å™¨è¿›è¡ŒéªŒè¯ï¼›å¦‚æœå­˜åœ¨Last-Modifiedæˆ–è€…Dataï¼Œåˆ™ä½¿ç”¨If-Modified-Sinceäº¤ç»™æœåŠ¡å™¨éªŒè¯ã€‚æœåŠ¡å™¨å¦‚æœæ— ä¿®æ”¹åˆ™ä¼šè¿”å›304ï¼Œè¿™æ—¶å€™æ³¨æ„ï¼š ç”±äºæ˜¯ç¼“å­˜è¿‡æœŸè€Œå‘èµ·çš„è¯·æ±‚(ä¸ç¬¬4ä¸ªåˆ¤æ–­ç”¨æˆ·çš„ä¸»åŠ¨è®¾ç½®ä¸åŒ)ï¼Œå¦‚æœæœåŠ¡å™¨è¿”å›304ï¼Œé‚£æ¡†æ¶ä¼šè‡ªåŠ¨æ›´æ–°ç¼“å­˜ï¼Œæ‰€ä»¥æ­¤æ—¶CacheStrategyæ—¢åŒ…å«networkRequestä¹ŸåŒ…å«cacheResponse è¯¦ç»†æµç¨‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109private CacheStrategy getCandidate() { // No cached response. //todo 1ã€æ²¡æœ‰ç¼“å­˜,è¿›è¡Œç½‘ç»œè¯·æ±‚ if (cacheResponse == null) { return new CacheStrategy(request, null); } //todo 2ã€httpsè¯·æ±‚ï¼Œä½†æ˜¯æ²¡æœ‰æ¡æ‰‹ä¿¡æ¯,è¿›è¡Œç½‘ç»œè¯·æ±‚ // OkHttpä¼šä¿å­˜sslæ¡æ‰‹ä¿¡æ¯ handshake,å¦‚æœè¿™æ¬¡å‘èµ·äº†httpsè¯·æ±‚ï¼Œ // ä½†æ˜¯ç¼“å­˜çš„å“åº”ä¿¡æ¯ä¸­æ²¡æœ‰æ¡æ‰‹ä¿¡æ¯ï¼Œå‘èµ·ç½‘ç»œè¯·æ±‚ //Drop the cached response if it's missing a required handshake. if (request.isHttps() &amp;&amp; cacheResponse.handshake() == null) { return new CacheStrategy(request, null); } //todo 3ã€ä¸»è¦æ˜¯é€šè¿‡å“åº”ç ä»¥åŠå¤´éƒ¨ç¼“å­˜æ§åˆ¶å­—æ®µåˆ¤æ–­å“åº”èƒ½ä¸èƒ½ç¼“å­˜ï¼Œä¸èƒ½ç¼“å­˜é‚£å°±è¿›è¡Œç½‘ç»œè¯·æ±‚ //If this response shouldn't have been stored, it should never be used //as a response source. This check should be redundant as long as the //persistence store is well-behaved and the rules are constant. if (!isCacheable(cacheResponse, request)) { return new CacheStrategy(request, null); } CacheControl requestCaching = request.cacheControl(); //todo 4ã€å¦‚æœ è¯·æ±‚åŒ…å«ï¼šCacheControl:no-cache éœ€è¦ä¸æœåŠ¡å™¨éªŒè¯ç¼“å­˜æœ‰æ•ˆæ€§ // æˆ–è€…è¯·æ±‚å¤´åŒ…å« If-Modified-Sinceï¼šæ—¶é—´ å€¼ä¸ºlastModifiedæˆ–è€…data å¦‚æœæœåŠ¡å™¨æ²¡æœ‰åœ¨è¯¥å¤´éƒ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åä¿®æ”¹äº†è¯·æ±‚çš„æ•°æ®ï¼ŒæœåŠ¡å™¨è¿”å›304(æ— ä¿®æ”¹) // æˆ–è€…è¯·æ±‚å¤´åŒ…å« If-None-Matchï¼šå€¼å°±æ˜¯Etagï¼ˆèµ„æºæ ‡è®°ï¼‰æœåŠ¡å™¨å°†å…¶ä¸å­˜åœ¨æœåŠ¡ç«¯çš„Etagå€¼è¿›è¡Œæ¯”è¾ƒï¼›å¦‚æœåŒ¹é…ï¼Œè¿”å›304 // è¯·æ±‚å¤´ä¸­åªè¦å­˜åœ¨ä¸‰è€…ä¸­ä»»æ„ä¸€ä¸ªï¼Œè¿›è¡Œç½‘ç»œè¯·æ±‚ if (requestCaching.noCache() || hasConditions(request)) { return new CacheStrategy(request, null); } //todo 5ã€å¦‚æœç¼“å­˜å“åº”ä¸­å­˜åœ¨ Cache-Control:immutable å“åº”å†…å®¹å°†ä¸€ç›´ä¸ä¼šæ”¹å˜,å¯ä»¥ä½¿ç”¨ç¼“å­˜ CacheControl responseCaching = cacheResponse.cacheControl(); if (responseCaching.immutable()) { return new CacheStrategy(null, cacheResponse); } //todo 6ã€æ ¹æ® ç¼“å­˜å“åº”çš„ æ§åˆ¶ç¼“å­˜çš„å“åº”å¤´ åˆ¤æ–­æ˜¯å¦å…è®¸ä½¿ç”¨ç¼“å­˜ // 6.1ã€è·å¾—ç¼“å­˜çš„å“åº”ä»åˆ›å»ºåˆ°ç°åœ¨çš„æ—¶é—´ long ageMillis = cacheResponseAge(); //todo // 6.2ã€è·å–è¿™ä¸ªå“åº”æœ‰æ•ˆç¼“å­˜çš„æ—¶é•¿ long freshMillis = computeFreshnessLifetime(); if (requestCaching.maxAgeSeconds() != -1) { //todo å¦‚æœè¯·æ±‚ä¸­æŒ‡å®šäº† max-age è¡¨ç¤ºæŒ‡å®šäº†èƒ½æ‹¿çš„ç¼“å­˜æœ‰æ•ˆæ—¶é•¿ï¼Œå°±éœ€è¦ç»¼åˆå“åº”æœ‰æ•ˆç¼“å­˜æ—¶é•¿ä¸è¯·æ±‚èƒ½æ‹¿ç¼“å­˜çš„æ—¶é•¿ï¼Œè·å¾—æœ€å°çš„èƒ½å¤Ÿä½¿ç”¨å“åº”ç¼“å­˜çš„æ—¶é•¿ freshMillis = Math.min(freshMillis, SECONDS.toMillis(requestCaching.maxAgeSeconds())); } //todo // 6.3 è¯·æ±‚åŒ…å« Cache-Control:min-fresh=[ç§’] èƒ½å¤Ÿä½¿ç”¨è¿˜æœªè¿‡æŒ‡å®šæ—¶é—´çš„ç¼“å­˜ ï¼ˆè¯·æ±‚è®¤ä¸ºçš„ç¼“å­˜æœ‰æ•ˆæ—¶é—´ï¼‰ long minFreshMillis = 0; if (requestCaching.minFreshSeconds() != -1) { minFreshMillis = SECONDS.toMillis(requestCaching.minFreshSeconds()); } //todo // 6.4 // 6.4.1ã€Cache-Control:must-revalidate å¯ç¼“å­˜ä½†å¿…é¡»å†å‘æºæœåŠ¡å™¨è¿›è¡Œç¡®è®¤ // 6.4.2ã€Cache-Control:max-stale=[ç§’] ç¼“å­˜è¿‡æœŸåè¿˜èƒ½ä½¿ç”¨æŒ‡å®šçš„æ—¶é•¿ å¦‚æœæœªæŒ‡å®šå¤šå°‘ç§’ï¼Œåˆ™è¡¨ç¤ºæ— è®ºè¿‡æœŸå¤šé•¿æ—¶é—´éƒ½å¯ä»¥ï¼›å¦‚æœæŒ‡å®šäº†ï¼Œåˆ™åªè¦æ˜¯æŒ‡å®šæ—¶é—´å†…å°±èƒ½ä½¿ç”¨ç¼“å­˜ // å‰è€…ä¼šå¿½ç•¥åè€…ï¼Œæ‰€ä»¥åˆ¤æ–­äº†ä¸å¿…é¡»å‘æœåŠ¡å™¨ç¡®è®¤ï¼Œå†è·å¾—è¯·æ±‚å¤´ä¸­çš„max-stale long maxStaleMillis = 0; if (!responseCaching.mustRevalidate() &amp;&amp; requestCaching.maxStaleSeconds() != -1) { maxStaleMillis = SECONDS.toMillis(requestCaching.maxStaleSeconds()); } //todo // 6.5 ä¸éœ€è¦ä¸æœåŠ¡å™¨éªŒè¯æœ‰æ•ˆæ€§ &amp;&amp; å“åº”å­˜åœ¨çš„æ—¶é—´+è¯·æ±‚è®¤ä¸ºçš„ç¼“å­˜æœ‰æ•ˆæ—¶é—´ å°äº ç¼“å­˜æœ‰æ•ˆæ—¶é•¿+è¿‡æœŸåè¿˜å¯ä»¥ä½¿ç”¨çš„æ—¶é—´ // å…è®¸ä½¿ç”¨ç¼“å­˜ if (!responseCaching.noCache() &amp;&amp; ageMillis + minFreshMillis &lt; freshMillis + maxStaleMillis) { Response.Builder builder = cacheResponse.newBuilder(); //todo å¦‚æœå·²è¿‡æœŸï¼Œä½†æœªè¶…è¿‡ è¿‡æœŸåç»§ç»­ä½¿ç”¨æ—¶é•¿ï¼Œé‚£è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œåªç”¨æ·»åŠ ç›¸åº”çš„å¤´éƒ¨å­—æ®µ if (ageMillis + minFreshMillis &gt;= freshMillis) { builder.addHeader(&quot;Warning&quot;, &quot;110 HttpURLConnection \\&quot;Response is stale\\&quot;&quot;); } //todo å¦‚æœç¼“å­˜å·²è¶…è¿‡ä¸€å¤©å¹¶ä¸”å“åº”ä¸­æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ä¹Ÿéœ€è¦æ·»åŠ è­¦å‘Š long oneDayMillis = 24 * 60 * 60 * 1000L; if (ageMillis &gt; oneDayMillis &amp;&amp; isFreshnessLifetimeHeuristic()) { builder.addHeader(&quot;Warning&quot;, &quot;113 HttpURLConnection \\&quot;Heuristic expiration\\&quot;&quot;); } return new CacheStrategy(null, builder.build()); } // Find a condition to add to the request. If the condition is satisfied, the // response body // will not be transmitted. //todo 7ã€ç¼“å­˜è¿‡æœŸäº† String conditionName; String conditionValue; if (etag != null) { conditionName = &quot;If-None-Match&quot;; conditionValue = etag; } else if (lastModified != null) { conditionName = &quot;If-Modified-Since&quot;; conditionValue = lastModifiedString; } else if (servedDate != null) { conditionName = &quot;If-Modified-Since&quot;; conditionValue = servedDateString; } else { return new CacheStrategy(request, null); // No condition! Make a regular request. } //todo å¦‚æœè®¾ç½®äº† If-None-Match/If-Modified-Since æœåŠ¡å™¨æ˜¯å¯èƒ½è¿”å›304(æ— ä¿®æ”¹)çš„,ä½¿ç”¨ç¼“å­˜çš„å“åº”ä½“ Headers.Builder conditionalRequestHeaders = request.headers().newBuilder(); Internal.instance.addLenient(conditionalRequestHeaders, conditionName, conditionValue); Request conditionalRequest = request.newBuilder() .headers(conditionalRequestHeaders.build()) .build(); return new CacheStrategy(conditionalRequest, cacheResponse);} PSï¼šè¯·æ±‚å¤´ä¸å“åº”å¤´ å“åº”å¤´ è¯´æ˜ ä¾‹å­ Date æ¶ˆæ¯å‘é€çš„æ—¶é—´ Date: Sat, 18 Nov 2028 06:17:41 GMT Expires èµ„æºè¿‡æœŸçš„æ—¶é—´ Expires: Sat, 18 Nov 2028 06:17:41 GMT Last-Modified èµ„æºæœ€åä¿®æ”¹æ—¶é—´ Last-Modified: Fri, 22 Jul 2016 02:57:17 GMT ETag èµ„æºåœ¨æœåŠ¡å™¨çš„å”¯ä¸€æ ‡è¯† ETag: â€œ16df0-5383097a03d40â€ Age æœåŠ¡å™¨ç”¨ç¼“å­˜å“åº”è¯·æ±‚ï¼Œè¯¥ç¼“å­˜ä»äº§ç”Ÿåˆ°ç°åœ¨ç»è¿‡å¤šé•¿æ—¶é—´(ç§’) Age: 3825683 Cache-Control - - è¯·æ±‚å¤´ è¯´æ˜ ä¾‹å­ If-Modified-Since æœåŠ¡å™¨æ²¡æœ‰åœ¨æŒ‡å®šçš„æ—¶é—´åä¿®æ”¹è¯·æ±‚å¯¹åº”èµ„æº,è¿”å›304(æ— ä¿®æ”¹) If-Modified-Since: Fri, 22 Jul 2016 02:57:17 GMT If-None-Match æœåŠ¡å™¨å°†å…¶ä¸è¯·æ±‚å¯¹åº”èµ„æºçš„Etagå€¼è¿›è¡Œæ¯”è¾ƒï¼ŒåŒ¹é…è¿”å›304 If-None-Match: â€œ16df0-5383097a03d40â€ Cache-Control - - å…¶ä¸­Cache-Controlå¯ä»¥åœ¨è¯·æ±‚å¤´å­˜åœ¨ï¼Œä¹Ÿèƒ½åœ¨å“åº”å¤´å­˜åœ¨ï¼Œå¯¹åº”çš„valueå¯ä»¥è®¾ç½®å¤šç§ç»„åˆï¼š max-age=[ç§’] ï¼šèµ„æºæœ€å¤§æœ‰æ•ˆæ—¶é—´; public ï¼šè¡¨æ˜è¯¥èµ„æºå¯ä»¥è¢«ä»»ä½•ç”¨æˆ·ç¼“å­˜ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯ï¼Œä»£ç†æœåŠ¡å™¨ç­‰éƒ½å¯ä»¥ç¼“å­˜èµ„æº; privateï¼šè¡¨æ˜è¯¥èµ„æºåªèƒ½è¢«å•ä¸ªç”¨æˆ·ç¼“å­˜ï¼Œé»˜è®¤æ˜¯privateã€‚ no-storeï¼šèµ„æºä¸å…è®¸è¢«ç¼“å­˜ no-cacheï¼š(è¯·æ±‚)ä¸ä½¿ç”¨ç¼“å­˜ immutableï¼š(å“åº”)èµ„æºä¸ä¼šæ”¹å˜ min-fresh=[ç§’]ï¼š(è¯·æ±‚)ç¼“å­˜æœ€å°æ–°é²œåº¦(ç”¨æˆ·è®¤ä¸ºè¿™ä¸ªç¼“å­˜æœ‰æ•ˆçš„æ—¶é•¿) must-revalidateï¼š(å“åº”)ä¸å…è®¸ä½¿ç”¨è¿‡æœŸç¼“å­˜ max-stale=[ç§’]ï¼š(è¯·æ±‚)ç¼“å­˜è¿‡æœŸåå¤šä¹…å†…ä»ç„¶æœ‰æ•ˆ å‡è®¾å­˜åœ¨max-age=100ï¼Œmin-fresh=20ã€‚è¿™ä»£è¡¨äº†ç”¨æˆ·è®¤ä¸ºè¿™ä¸ªç¼“å­˜çš„å“åº”ï¼Œä»æœåŠ¡å™¨åˆ›å»ºå“åº” åˆ° èƒ½å¤Ÿç¼“å­˜ä½¿ç”¨çš„æ—¶é—´ä¸º100-20=80sã€‚ä½†æ˜¯å¦‚æœmax-stale=100ã€‚è¿™ä»£è¡¨äº†ç¼“å­˜æœ‰æ•ˆæ—¶é—´80sè¿‡åï¼Œä»ç„¶å…è®¸ä½¿ç”¨100sï¼Œå¯ä»¥çœ‹æˆç¼“å­˜æœ‰æ•ˆæ—¶é•¿ä¸º180sã€‚ å››ã€è¿æ¥æ‹¦æˆªå™¨è¿æ¥æµç¨‹ï¼š ConnectInterceptorï¼Œæ‰“å¼€ä¸ç›®æ ‡æœåŠ¡å™¨çš„è¿æ¥ï¼Œå¹¶æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ã€‚å®ƒç®€çŸ­çš„å¯ä»¥ç›´æ¥å®Œæ•´è´´åœ¨è¿™é‡Œï¼š 1234567891011121314151617181920public final class ConnectInterceptor implements Interceptor { public final OkHttpClient client; public ConnectInterceptor(OkHttpClient client) { this.client = client; } @Override public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain) chain; Request request = realChain.request(); StreamAllocation streamAllocation = realChain.streamAllocation(); // We need the network to satisfy this request. Possibly for validating a conditional GET. boolean doExtensiveHealthChecks = !request.method().equals(&quot;GET&quot;); HttpCodec httpCodec = streamAllocation.newStream(client, chain, doExtensiveHealthChecks); RealConnection connection = streamAllocation.connection(); return realChain.proceed(request, streamAllocation, httpCodec, connection); }} é¦–å…ˆæˆ‘ä»¬çœ‹åˆ°çš„StreamAllocationè¿™ä¸ªå¯¹è±¡æ˜¯åœ¨ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ï¼šé‡å®šå‘æ‹¦æˆªå™¨åˆ›å»ºçš„ï¼Œä½†æ˜¯çœŸæ­£ä½¿ç”¨çš„åœ°æ–¹å´åœ¨è¿™é‡Œã€‚ *â€å½“ä¸€ä¸ªè¯·æ±‚å‘å‡ºï¼Œéœ€è¦å»ºç«‹è¿æ¥ï¼Œè¿æ¥å»ºç«‹åéœ€è¦ä½¿ç”¨æµç”¨æ¥è¯»å†™æ•°æ®â€*ï¼›è€Œè¿™ä¸ªStreamAllocationå°±æ˜¯åè°ƒè¯·æ±‚ã€è¿æ¥ä¸æ•°æ®æµä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼Œå®ƒè´Ÿè´£ä¸ºä¸€æ¬¡è¯·æ±‚å¯»æ‰¾è¿æ¥ï¼Œç„¶åè·å¾—æµæ¥å®ç°ç½‘ç»œé€šä¿¡ã€‚ è¿™é‡Œä½¿ç”¨çš„newStreamæ–¹æ³•å®é™…ä¸Šå°±æ˜¯å»æŸ¥æ‰¾æˆ–è€…å»ºç«‹ä¸€ä¸ªä¸è¯·æ±‚ä¸»æœºæœ‰æ•ˆçš„è¿æ¥ï¼Œè¿”å›çš„HttpCodecä¸­åŒ…å«äº†è¾“å…¥è¾“å‡ºæµï¼Œå¹¶ä¸”å°è£…äº†å¯¹HTTPè¯·æ±‚æŠ¥æ–‡çš„ç¼–ç ä¸è§£ç ï¼Œç›´æ¥ä½¿ç”¨å®ƒå°±èƒ½å¤Ÿä¸è¯·æ±‚ä¸»æœºå®ŒæˆHTTPé€šä¿¡ã€‚ 123456789101112131415161718192021222324public HttpCodec newStream( OkHttpClient client, Interceptor.Chain chain, boolean doExtensiveHealthChecks) { int connectTimeout = chain.connectTimeoutMillis(); int readTimeout = chain.readTimeoutMillis(); int writeTimeout = chain.writeTimeoutMillis(); int pingIntervalMillis = client.pingIntervalMillis(); boolean connectionRetryEnabled = client.retryOnConnectionFailure(); try { //todo æ‰¾åˆ°ä¸€ä¸ªå¥åº·çš„è¿æ¥ RealConnection resultConnection = findHealthyConnection(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis, connectionRetryEnabled, doExtensiveHealthChecks); //todo åˆ©ç”¨è¿æ¥å®ä¾‹åŒ–æµHttpCodecå¯¹è±¡ï¼Œå¦‚æœæ˜¯HTTP/2è¿”å›Http2Codecï¼Œå¦åˆ™è¿”å›Http1Codec HttpCodec resultCodec = resultConnection.newCodec(client, chain, this); synchronized (connectionPool) { codec = resultCodec; return resultCodec; } } catch (IOException e) { throw new RouteException(e); }} StreamAllocationä¸­ç®€å•æ¥è¯´å°±æ˜¯ç»´æŠ¤è¿æ¥ï¼šRealConnectionâ€”â€”å°è£…äº†Socketä¸ä¸€ä¸ªSocketè¿æ¥æ± ã€‚å¯å¤ç”¨çš„RealConnection findHealthyConnectionæ–¹æ³•ä¸­ 12345678910111213141516171819202122232425262728293031private RealConnection findHealthyConnection(int connectTimeout, int readTimeout, int writeTimeout, int pingIntervalMillis, boolean connectionRetryEnabled, boolean doExtensiveHealthChecks) throws IOException { while (true) { //todo æ‰¾åˆ°ä¸€ä¸ªè¿æ¥ RealConnection candidate = findConnection(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis, connectionRetryEnabled); //todo å¦‚æœè¿™ä¸ªè¿æ¥æ˜¯æ–°å»ºç«‹çš„ï¼Œé‚£è‚¯å®šæ˜¯å¥åº·çš„ï¼Œç›´æ¥è¿”å› //If this is a brand new connection, we can skip the extensive health checks. synchronized (connectionPool) { if (candidate.successCount == 0) { return candidate; } } //todo å¦‚æœä¸æ˜¯æ–°åˆ›å»ºçš„ï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦å¥åº· //Do a (potentially slow) check to confirm that the pooled connection is still good. // If it // isn't, take it out of the pool and start again. if (!candidate.isHealthy(doExtensiveHealthChecks)) { //todo ä¸å¥åº· å…³é—­è¿æ¥ï¼Œé‡Šæ”¾Socket,ä»è¿æ¥æ± ç§»é™¤ // ç»§ç»­ä¸‹æ¬¡å¯»æ‰¾è¿æ¥æ“ä½œ noNewStreams(); continue; } return candidate; }} findConnectionæ–¹æ³•ä¸­çš„ å°è¯•ä»è¿æ¥æ± è·å–è¿æ¥ï¼Œå¦‚æœæœ‰å¯å¤ç”¨çš„è¿æ¥,ä¼šç»™ç¬¬ä¸‰ä¸ªå‚æ•° thisçš„connectionèµ‹å€¼ 1Internal.instance.get(connectionPool, address, this, null); è°ƒåˆ°äº†ï¼ˆConnectionPoolï¼‰connectionPool.getæ–¹æ³• 12345678910@Nullable RealConnection get(Address address, StreamAllocation streamAllocation, Route route) { assert (Thread.holdsLock(this)); for (RealConnection connection : connections) { if (connection.isEligible(address, route)) { streamAllocation.acquire(connection, true); return connection; } } return null;} isEligibleåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿå¤ç”¨ ä½¿ç”¨http1.1å°±ä¸èƒ½ç”¨ å¦‚æœåœ°å€ä¸åŒå°±ä¸èƒ½å¤ç”¨ï¼ˆAddress.equalsNonHostï¼‰DNSã€ä»£ç†ã€SSLè¯ä¹¦ã€æœåŠ¡å™¨åŸŸåã€ç«¯å£ éƒ½ç›¸åŒé‚£å°±å¯ä»¥å¤ç”¨ 123456789101112131415161718192021222324252627282930313233343536373839404142434445public boolean isEligible(Address address, @Nullable Route route) { // If this connection is not accepting new streams, we're done. // TODO: å®é™…ä¸Šå°±æ˜¯åœ¨ä½¿ç”¨http1.1å°±ä¸èƒ½ç”¨ if (allocations.size() &gt;= allocationLimit || noNewStreams) return false; // If the non-host fields of the address don't overlap, we're done. // TODO: å¦‚æœåœ°å€ä¸åŒå°±ä¸èƒ½å¤ç”¨ï¼ˆAddress.equalsNonHostï¼‰DNSã€ä»£ç†ã€SSLè¯ä¹¦ã€æœåŠ¡å™¨åŸŸåã€ç«¯å£ï¼ˆåŸŸåæ²¡æœ‰åˆ¤æ–­ï¼Œæ‰€ä»¥ä¸‹é¢é©¬ä¸Šåˆ¤æ–­ï¼‰ if (!Internal.instance.equalsNonHost(this.route.address(), address)) return false; // If the host exactly matches, we're done: this connection can carry the address. //todo: éƒ½ç›¸åŒé‚£å°±å¯ä»¥å¤ç”¨äº† if (address.url().host().equals(this.route().address().url().host())) { return true; // This connection is a perfect match. } // At this point we don't have a hostname match. But we still be able to carry the // request if // our connection coalescing requirements are met. See also: // https://hpbn.co/optimizing-application-delivery/#eliminate-domain-sharding // https://daniel.haxx.se/blog/2016/08/18/http2-connection-coalescing/ // 1. This connection must be HTTP/2. if (http2Connection == null) return false; // 2. The routes must share an IP address. This requires us to have a DNS address for both // hosts, which only happens after route planning. We can't coalesce connections that use a // proxy, since proxies don't tell us the origin server's IP address. if (route == null) return false; if (route.proxy().type() != Proxy.Type.DIRECT) return false; if (this.route.proxy().type() != Proxy.Type.DIRECT) return false; if (!this.route.socketAddress().equals(route.socketAddress())) return false; // 3. This connection's server certificate's must cover the new host. if (route.address().hostnameVerifier() != OkHostnameVerifier.INSTANCE) return false; if (!supportsUrl(address.url())) return false; // 4. Certificate pinning must match the host. try { address.certificatePinner().check(address.url().host(), handshake().peerCertificates()); } catch (SSLPeerUnverifiedException e) { return false; } return true; // The caller's address can be carried by this connection.} æ²¡æ‰¾åˆ°ï¼Œå¿…é¡»æ–°å»ºä¸€ä¸ªè¿æ¥äº† 1234567891011121314 if (!foundPooledConnection) { if (selectedRoute == null) { selectedRoute = routeSelection.next(); } // Create a connection and assign it to this allocation immediately. This makes // it possible // for an asynchronous cancel() to interrupt the handshake we're about to do. route = selectedRoute; refusedStreamCount = 0; result = new RealConnection(connectionPool, selectedRoute); acquire(result, false); }} è¿æ¥æ± æ¸…ç†ï¼š findConnectionæ–¹æ³•ä¸­ï¼š 12//todo å°†æ–°åˆ›å»ºçš„è¿æ¥æ”¾åˆ°è¿æ¥æ± ä¸­Internal.instance.put(connectionPool, result); è°ƒçš„æ˜¯ConnectionPool.putæ–¹æ³• 123456789void put(RealConnection connection) { assert (Thread.holdsLock(this)); if (!cleanupRunning) { cleanupRunning = true; //å¯åŠ¨æ¸…ç† executor.execute(cleanupRunnable); } connections.add(connection);} 123456789101112131415161718192021private final Runnable cleanupRunnable = new Runnable() { @Override public void run() { while (true) { //todo:æœ€å¿«å¤šä¹…åéœ€è¦æ¸…ç† long waitNanos = cleanup(System.nanoTime()); if (waitNanos == -1) return; if (waitNanos &gt; 0) { //todo:å› ä¸ºç­‰å¾…æ˜¯çº³ç§’çº§ï¼Œwaitæ–¹æ³•å¯ä»¥æ¥æ”¶çº³ç§’çº§æ§åˆ¶ï¼Œä½†æ˜¯æŠŠæ¯«ç§’ä¸çº³ç§’åˆ†å¼€ long waitMillis = waitNanos / 1000000L; waitNanos -= (waitMillis * 1000000L); synchronized (ConnectionPool.this) { try { //todo:å‚æ•°å¤šä¸€ä¸ªçº³ç§’ï¼Œæ§åˆ¶æ›´åŠ ç²¾ç¡® ConnectionPool.this.wait(waitMillis, (int) waitNanos); } catch (InterruptedException ignored) { } } } } }}; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647long cleanup(long now) { int inUseConnectionCount = 0; int idleConnectionCount = 0; RealConnection longestIdleConnection = null; long longestIdleDurationNs = Long.MIN_VALUE; // Find either a connection to evict, or the time that the next eviction is due. synchronized (this) { for (Iterator&lt;RealConnection&gt; i = connections.iterator(); i.hasNext(); ) { RealConnection connection = i.next(); // If the connection is in use, keep searching. if (pruneAndGetAllocationCount(connection, now) &gt; 0) { inUseConnectionCount++; continue; } idleConnectionCount++; // TODO: è·å¾—è¿™ä¸ªè¿æ¥é—²ç½®å¤šä¹… // If the connection is ready to be evicted, we're done. long idleDurationNs = now - connection.idleAtNanos; if (idleDurationNs &gt; longestIdleDurationNs) { longestIdleDurationNs = idleDurationNs; longestIdleConnection = connection; } } //è¶…è¿‡ä¿æ´»æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰æˆ–è€…æ± å†…æ•°é‡è¶…è¿‡äº†5ä¸ªï¼Œé©¬ä¸Šç§»é™¤ï¼Œç„¶åè¿”å›0ï¼Œè¡¨ç¤ºä¸ç­‰å¾…ï¼Œé©¬ä¸Šå†æ¬¡æ£€æŸ¥ if (longestIdleDurationNs &gt;= this.keepAliveDurationNs || idleConnectionCount &gt; this.maxIdleConnections) { // We've found a connection to evict. Remove it from the list, then close it below (outside // of the synchronized block). connections.remove(longestIdleConnection); } else if (idleConnectionCount &gt; 0) { // A connection will be ready to evict soon. // TODO: æ± å†…å­˜åœ¨é—²ç½®è¿æ¥ï¼Œå°±ç­‰å¾…ï¼Œä¿æ´»æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰-æœ€é•¿é—²ç½®æ—¶é—´=è¿˜èƒ½é—²ç½®å¤šä¹… å†æ£€æŸ¥ return keepAliveDurationNs - longestIdleDurationNs; } else if (inUseConnectionCount &gt; 0) { // All connections are in use. It'll be at least the keep alive duration 'til we run again. // TODO: æœ‰ä½¿ç”¨ä¸­çš„è¿æ¥å°±ç­‰å¾…5åˆ†é’Ÿï¼Œå†æ£€æŸ¥ return keepAliveDurationNs; } else { // No connections, idle or in use. // TODO: éƒ½ä¸æ»¡è¶³ï¼Œå¯èƒ½æ± å†…æ²¡ä»»ä½•è¿æ¥ï¼Œç›´æ¥åœæ­¢æ¸…ç†ï¼ˆputåå†æ¬¡å¯ç”¨ï¼‰ cleanupRunning = false; return -1; } } ä»£ç†è¿æ¥ï¼š findConnectionä¸­ 123//todo å®é™…ä¸Šå°±æ˜¯åˆ›å»ºsocketè¿æ¥ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯å¦‚æœå­˜åœ¨httpä»£ç†çš„æƒ…å†µresult.connect(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis, connectionRetryEnabled, call, eventListener); RealConnection.connect 123456789101112if (route.requiresTunnel()) { //todo httpéš§é“ä»£ç† connectTunnel(connectTimeout, readTimeout, writeTimeout, call, eventListener); if (rawSocket == null) { // We were unable to connect the tunnel but properly closed down our // resources. break; }} else { //todo åˆ›å»ºsocketè¿æ¥ connectSocket(connectTimeout, readTimeout, call, eventListener);} æœ‰httpä»£ç†å…ˆè®¾ç½®ä»£ç†å¤´ï¼Œæœ€ç»ˆéƒ½ç”¨è°ƒç”¨connectSocketæ–¹æ³• 1234567891011121314151617181920private void connectTunnel(int connectTimeout, int readTimeout, int writeTimeout, Call call, EventListener eventListener) throws IOException { Request tunnelRequest = createTunnelRequest(); HttpUrl url = tunnelRequest.url(); for (int i = 0; i &lt; MAX_TUNNEL_ATTEMPTS; i++) { connectSocket(connectTimeout, readTimeout, call, eventListener); tunnelRequest = createTunnel(readTimeout, writeTimeout, tunnelRequest, url); if (tunnelRequest == null) break; // Tunnel successfully created. // The proxy decided to close the connection after an auth challenge. We need to // create a new // connection, but this time with the auth credentials. closeQuietly(rawSocket); rawSocket = null; sink = null; source = null; eventListener.connectEnd(call, route.socketAddress(), route.proxy(), null); }} 12345678private Request createTunnelRequest() { return new Request.Builder() .url(route.address().url()) .header(&quot;Host&quot;, Util.hostHeader(route.address().url(), true)) .header(&quot;Proxy-Connection&quot;, &quot;Keep-Alive&quot;) // For HTTP/1.0 proxies like Squid. .header(&quot;User-Agent&quot;, Version.userAgent()) .build();} 1234567891011121314151617181920212223242526272829303132333435363738/** * todo:åˆ›å»ºsocketè¿æ¥ * Does all the work necessary to build a full HTTP or HTTPS connection on a raw socket. */private void connectSocket(int connectTimeout, int readTimeout, Call call, EventListener eventListener) throws IOException { Proxy proxy = route.proxy(); Address address = route.address(); //todo:æ²¡æœ‰ä»£ç†ç›´æ¥newä¸€ä¸ªSocketï¼ˆï¼‰ï¼Œæœ‰ä»£ç†å°±åˆ›å»ºä¸€ä¸ªå¸¦ä»£ç†å‚æ•°çš„socket rawSocket = proxy.type() == Proxy.Type.DIRECT || proxy.type() == Proxy.Type.HTTP ? address.socketFactory().createSocket() : new Socket(proxy); eventListener.connectStart(call, route.socketAddress(), proxy); rawSocket.setSoTimeout(readTimeout); try { // TODO: socket.connect Platform.get().connectSocket(rawSocket, route.socketAddress(), connectTimeout); } catch (ConnectException e) { ConnectException ce = new ConnectException(&quot;Failed to connect to &quot; + route.socketAddress()); ce.initCause(e); throw ce; } // The following try/catch block is a pseudo hacky way to get around a crash on Android 7.0 // More details: // https://github.com/square/okhttp/issues/3245 // https://android-review.googlesource.com/#/c/271775/ try { source = Okio.buffer(Okio.source(rawSocket)); sink = Okio.buffer(Okio.sink(rawSocket)); } catch (NullPointerException npe) { if (NPE_THROW_WITH_NULL.equals(npe.getMessage())) { throw new IOException(npe); } }} äº”ã€è¯·æ±‚æœåŠ¡å™¨æ‹¦æˆªå™¨Expect: 100-continueä¸€èˆ¬å‡ºç°äºä¸Šä¼ å¤§å®¹é‡è¯·æ±‚ä½“æˆ–è€…éœ€è¦éªŒè¯ã€‚ä»£è¡¨äº†å…ˆè¯¢é—®æœåŠ¡å™¨æ˜¯å¦åŸå› æ¥æ”¶å‘é€è¯·æ±‚ä½“æ•°æ®ã€‚ï¼ˆå…ˆåªå‘é€è¯·æ±‚å¤´ï¼‰ OkHttpçš„åšæ³•ï¼šå¦‚æœæœåŠ¡å™¨å…è®¸åˆ™è¿”å›100ï¼Œå®¢æˆ·ç«¯ç»§ç»­å‘é€è¯·æ±‚ä½“ï¼›å¦‚æœæœåŠ¡å™¨ä¸å…è®¸åˆ™ç›´æ¥è¿”å›ç»™ç”¨æˆ·ã€‚ åŒæ—¶æœåŠ¡å™¨ä¹Ÿå¯èƒ½ä¼šå¿½ç•¥æ­¤è¯·æ±‚å¤´ï¼Œä¸€ç›´æ— æ³•è¯»å–åº”ç­”ï¼Œæ­¤æ—¶æŠ›å‡ºè¶…æ—¶å¼‚å¸¸ã€‚ CallServerInterceptorï¼Œåˆ©ç”¨HttpCodecå‘å‡ºè¯·æ±‚åˆ°æœåŠ¡å™¨å¹¶ä¸”è§£æç”ŸæˆResponseã€‚ é¦–å…ˆè°ƒç”¨httpCodec.writeRequestHeaders(request); å°†è¯·æ±‚å¤´å†™å…¥åˆ°ç¼“å­˜ä¸­(ç›´åˆ°è°ƒç”¨flushRequest()æ‰çœŸæ­£å‘é€ç»™æœåŠ¡å™¨)ã€‚ç„¶åé©¬ä¸Šè¿›è¡Œç¬¬ä¸€ä¸ªé€»è¾‘åˆ¤æ–­ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131public final class CallServerInterceptor implements Interceptor { private final boolean forWebSocket; public CallServerInterceptor(boolean forWebSocket) { this.forWebSocket = forWebSocket; } @Override public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain) chain; HttpCodec httpCodec = realChain.httpStream(); StreamAllocation streamAllocation = realChain.streamAllocation(); RealConnection connection = (RealConnection) realChain.connection(); Request request = realChain.request(); long sentRequestMillis = System.currentTimeMillis(); realChain.eventListener().requestHeadersStart(realChain.call()); //todo:æ‹¼æ¥è¯·æ±‚çš„æ•°æ® httpCodec.writeRequestHeaders(request); realChain.eventListener().requestHeadersEnd(realChain.call(), request); Response.Builder responseBuilder = null; //todo:å¦‚æœæ²¡æœ‰è¯·æ±‚ä½“æˆ–è€…ä¸æ˜¯postè·³è¿‡ if (HttpMethod.permitsRequestBody(request.method()) &amp;&amp; request.body() != null) { // If there's a &quot;Expect: 100-continue&quot; header on the request, wait for a &quot;HTTP/1.1 100 // Continue&quot; response before transmitting the request body. If we don't get that, return // what we did get (such as a 4xx response) without ever transmitting the request body. // todo: å¦‚æœæ˜¯postè¯·æ±‚ï¼Œå¹¶åŒ…å«äº†100-continue,ä¸å‘è¯·æ±‚ä½“ï¼Œè¯»æœåŠ¡å™¨çš„å“åº” if (&quot;100-continue&quot;.equalsIgnoreCase(request.header(&quot;Expect&quot;))) { // todo: å‘é€è¯·æ±‚å¤´ httpCodec.flushRequest(); realChain.eventListener().responseHeadersStart(realChain.call()); responseBuilder = httpCodec.readResponseHeaders(true); } //æœåŠ¡è¿”å›100ï¼ŒresponseBuilderä¼šç½®ä¸ºnull if (responseBuilder == null) { // Write the request body if the &quot;Expect: 100-continue&quot; expectation was met. realChain.eventListener().requestBodyStart(realChain.call()); long contentLength = request.body().contentLength(); CountingSink requestBodyOut = new CountingSink(httpCodec.createRequestBody(request, contentLength)); BufferedSink bufferedRequestBody = Okio.buffer(requestBodyOut); //todoï¼šå†™å…¥è¯·æ±‚ä½“ request.body().writeTo(bufferedRequestBody); bufferedRequestBody.close(); realChain.eventListener() .requestBodyEnd(realChain.call(), requestBodyOut.successfulCount); } else if (!connection.isMultiplexed()) { // If the &quot;Expect: 100-continue&quot; expectation wasn't met, prevent the HTTP/1 // connection // from being reused. Otherwise we're still obligated to transmit the request // body to // leave the connection in a consistent state. streamAllocation.noNewStreams(); } } httpCodec.finishRequest(); // TODO: è¯»å–æœåŠ¡å™¨å“åº” if (responseBuilder == null) { realChain.eventListener().responseHeadersStart(realChain.call()); responseBuilder = httpCodec.readResponseHeaders(false); } Response response = responseBuilder .request(request) .handshake(streamAllocation.connection().handshake()) .sentRequestAtMillis(sentRequestMillis) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); int code = response.code(); // todo: æœåŠ¡å™¨å…è®¸ç»§ç»­å‘é€å“åº”ä½“ if (code == 100) { // server sent a 100-continue even though we did not request one. // try again to read the actual response responseBuilder = httpCodec.readResponseHeaders(false); response = responseBuilder .request(request) .handshake(streamAllocation.connection().handshake()) .sentRequestAtMillis(sentRequestMillis) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); code = response.code(); } realChain.eventListener() .responseHeadersEnd(realChain.call(), response); if (forWebSocket &amp;&amp; code == 101) { // Connection is upgrading, but we need to ensure interceptors see a non-null // response body. response = response.newBuilder() .body(Util.EMPTY_RESPONSE) .build(); } else { response = response.newBuilder() .body(httpCodec.openResponseBody(response)) .build(); } if (&quot;close&quot;.equalsIgnoreCase(response.request().header(&quot;Connection&quot;)) || &quot;close&quot;.equalsIgnoreCase(response.header(&quot;Connection&quot;))) { streamAllocation.noNewStreams(); } if ((code == 204 || code == 205) &amp;&amp; response.body().contentLength() &gt; 0) { throw new ProtocolException( &quot;HTTP &quot; + code + &quot; had non-zero Content-Length: &quot; + response.body().contentLength()); } return response; } static final class CountingSink extends ForwardingSink { long successfulCount; CountingSink(Sink delegate) { super(delegate); } @Override public void write(Buffer source, long byteCount) throws IOException { super.write(source, byteCount); successfulCount += byteCount; } }} æ•´ä¸ªiféƒ½å’Œä¸€ä¸ªè¯·æ±‚å¤´æœ‰å…³ï¼š Expect: 100-continueã€‚è¿™ä¸ªè¯·æ±‚å¤´ä»£è¡¨äº†åœ¨å‘é€è¯·æ±‚ä½“ä¹‹å‰éœ€è¦å’ŒæœåŠ¡å™¨ç¡®å®šæ˜¯å¦æ„¿æ„æ¥å—å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä½“ã€‚æ‰€ä»¥permitsRequestBodyåˆ¤æ–­ä¸ºæ˜¯å¦ä¼šæºå¸¦è¯·æ±‚ä½“çš„æ–¹å¼(POST)ï¼Œå¦‚æœå‘½ä¸­ifï¼Œåˆ™ä¼šå…ˆç»™æœåŠ¡å™¨å‘èµ·ä¸€æ¬¡æŸ¥è¯¢æ˜¯å¦æ„¿æ„æ¥æ”¶è¯·æ±‚ä½“ï¼Œè¿™æ—¶å€™å¦‚æœæœåŠ¡å™¨æ„¿æ„ä¼šå“åº”100(æ²¡æœ‰å“åº”ä½“ï¼ŒresponseBuilder å³ä¸ºnul)ã€‚è¿™æ—¶å€™æ‰èƒ½å¤Ÿç»§ç»­å‘é€å‰©ä½™è¯·æ±‚æ•°æ®ã€‚ ä½†æ˜¯å¦‚æœæœåŠ¡å™¨ä¸åŒæ„æ¥å—è¯·æ±‚ä½“ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ ‡è®°è¯¥è¿æ¥ä¸èƒ½å†è¢«å¤ç”¨ï¼Œè°ƒç”¨noNewStreams()å…³é—­ç›¸å…³çš„Socketã€‚ 123456789101112// TODO: è¯»å–æœåŠ¡å™¨å“åº”if (responseBuilder == null) { realChain.eventListener().responseHeadersStart(realChain.call()); responseBuilder = httpCodec.readResponseHeaders(false);}Response response = responseBuilder .request(request) .handshake(streamAllocation.connection().handshake()) .sentRequestAtMillis(sentRequestMillis) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); è¿™æ—¶responseBuilderçš„æƒ…å†µå³ä¸ºï¼š 1ã€POSTæ–¹å¼è¯·æ±‚ï¼Œè¯·æ±‚å¤´ä¸­åŒ…å«Expectï¼ŒæœåŠ¡å™¨å…è®¸æ¥å—è¯·æ±‚ä½“ï¼Œå¹¶ä¸”å·²ç»å‘å‡ºäº†è¯·æ±‚ä½“ï¼ŒresponseBuilderä¸ºnull; 2ã€POSTæ–¹å¼è¯·æ±‚ï¼Œè¯·æ±‚å¤´ä¸­åŒ…å«Expectï¼ŒæœåŠ¡å™¨ä¸å…è®¸æ¥å—è¯·æ±‚ä½“ï¼ŒresponseBuilderä¸ä¸ºnull 3ã€POSTæ–¹å¼è¯·æ±‚ï¼ŒæœªåŒ…å«Expectï¼Œç›´æ¥å‘å‡ºè¯·æ±‚ä½“ï¼ŒresponseBuilderä¸ºnull; 4ã€POSTæ–¹å¼è¯·æ±‚ï¼Œæ²¡æœ‰è¯·æ±‚ä½“ï¼ŒresponseBuilderä¸ºnull; 5ã€GETæ–¹å¼è¯·æ±‚ï¼ŒresponseBuilderä¸ºnull; å¯¹åº”ä¸Šé¢çš„5ç§æƒ…å†µï¼Œè¯»å–å“åº”å¤´å¹¶ä¸”ç»„æˆå“åº”Responseï¼Œæ³¨æ„ï¼šæ­¤Responseæ²¡æœ‰å“åº”ä½“ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæœåŠ¡å™¨æ¥å— Expect: 100-continueè¿™æ˜¯ä¸æ˜¯æ„å‘³ç€æˆ‘ä»¬å‘èµ·äº†ä¸¤æ¬¡Requestï¼Ÿé‚£æ­¤æ—¶çš„å“åº”å¤´æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è¯¢æœåŠ¡å™¨æ˜¯å¦æ”¯æŒæ¥å—è¯·æ±‚ä½“çš„ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„è¯·æ±‚å¯¹åº”çš„ç»“æœå“åº”ã€‚ æ‰€ä»¥ å¦‚æœå“åº”æ˜¯100ï¼Œè¿™ä»£è¡¨äº†æ˜¯è¯·æ±‚Expect: 100-continueæˆåŠŸçš„å“åº”ï¼Œéœ€è¦é©¬ä¸Šå†æ¬¡è¯»å–ä¸€ä»½å“åº”å¤´ï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„è¯·æ±‚å¯¹åº”ç»“æœå“åº”å¤´ã€‚ æœ€åï¼š forWebSocketä»£è¡¨websocketçš„è¯·æ±‚ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥elseï¼Œè¿™é‡Œå°±æ˜¯è¯»å–å“åº”ä½“æ•°æ®ã€‚ç„¶ååˆ¤æ–­è¯·æ±‚å’ŒæœåŠ¡å™¨æ˜¯ä¸æ˜¯éƒ½å¸Œæœ›é•¿è¿æ¥ï¼Œä¸€æ—¦æœ‰ä¸€æ–¹æŒ‡æ˜closeï¼Œé‚£ä¹ˆå°±éœ€è¦å…³é—­socketã€‚è€Œå¦‚æœæœåŠ¡å™¨è¿”å›204/205ï¼Œä¸€èˆ¬æƒ…å†µè€Œè¨€ä¸ä¼šå­˜åœ¨è¿™äº›è¿”å›ç ï¼Œä½†æ˜¯ä¸€æ—¦å‡ºç°è¿™æ„å‘³ç€æ²¡æœ‰å“åº”ä½“ï¼Œä½†æ˜¯è§£æåˆ°çš„å“åº”å¤´ä¸­åŒ…å«Content-Lenghtä¸”ä¸ä¸º0ï¼Œè¿™è¡¨å“åº”ä½“çš„æ•°æ®å­—èŠ‚é•¿åº¦ã€‚æ­¤æ—¶å‡ºç°äº†å†²çªï¼Œç›´æ¥æŠ›å‡ºåè®®å¼‚å¸¸ï¼ æ€»ç»“åœ¨è¿™ä¸ªæ‹¦æˆªå™¨ä¸­å°±æ˜¯å®ŒæˆHTTPåè®®æŠ¥æ–‡çš„å°è£…ä¸è§£æã€‚ è‡ªå®šä¹‰æ‹¦æˆªå™¨123456789new OkHttpClient().newBuilder().addInterceptor(new Interceptor() { @Override public Response intercept(Chain chain) throws IOException { // todo: ....... final Response response = chain.proceed(chain.request()); // todo: ....... return response; }}); ä¸€å®šè¦è°ƒç”¨chain.proceed,å¹¶å°†responseè¿”å›ã€‚ ä¸è°ƒç”¨çš„è¯ï¼Œä¼šä½¿è´£ä»»é“¾ä¸­æ–­ï¼Œåé¢å…¶ä»–å°±æ²¡æ³•æ‰§è¡Œäº†ã€‚ OkHttpæ€»ç»“æ•´ä¸ªOkHttpåŠŸèƒ½çš„å®ç°å°±åœ¨è¿™äº”ä¸ªé»˜è®¤çš„æ‹¦æˆªå™¨ä¸­ï¼Œæ‰€ä»¥å…ˆç†è§£æ‹¦æˆªå™¨æ¨¡å¼çš„å·¥ä½œæœºåˆ¶æ˜¯å…ˆå†³æ¡ä»¶ã€‚è¿™äº”ä¸ªæ‹¦æˆªå™¨åˆ†åˆ«ä¸º: é‡è¯•æ‹¦æˆªå™¨ã€æ¡¥æ¥æ‹¦æˆªå™¨ã€ç¼“å­˜æ‹¦æˆªå™¨ã€è¿æ¥æ‹¦æˆªå™¨ã€è¯·æ±‚æœåŠ¡æ‹¦æˆªå™¨ã€‚æ¯ä¸€ä¸ªæ‹¦æˆªå™¨è´Ÿè´£çš„å·¥ä½œä¸ä¸€æ ·ï¼Œå°±å¥½åƒå·¥å‚æµæ°´çº¿ï¼Œæœ€ç»ˆç»è¿‡è¿™äº”é“å·¥åºï¼Œå°±å®Œæˆäº†æœ€ç»ˆçš„äº§å“ã€‚ ä½†æ˜¯ä¸æµæ°´çº¿ä¸åŒçš„æ˜¯ï¼ŒOkHttpä¸­çš„æ‹¦æˆªå™¨æ¯æ¬¡å‘èµ·è¯·æ±‚éƒ½ä¼šåœ¨äº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ä¹‹å‰å¹²ä¸€äº›äº‹æƒ…ï¼Œåœ¨è·å¾—äº†ç»“æœä¹‹ååˆå¹²ä¸€äº›äº‹æƒ…ã€‚æ•´ä¸ªè¿‡ç¨‹åœ¨è¯·æ±‚å‘æ˜¯é¡ºåºçš„ï¼Œè€Œå“åº”å‘åˆ™æ˜¯é€†åºã€‚ å½“ç”¨æˆ·å‘èµ·ä¸€ä¸ªè¯·æ±‚åï¼Œä¼šç”±ä»»åŠ¡åˆ†å‘èµ·Dispatcherå°†è¯·æ±‚åŒ…è£…å¹¶äº¤ç»™é‡è¯•æ‹¦æˆªå™¨å¤„ç†ã€‚ 1ã€é‡è¯•æ‹¦æˆªå™¨åœ¨äº¤å‡º(äº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨)ä¹‹å‰ï¼Œè´Ÿè´£åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å–æ¶ˆäº†è¯·æ±‚ï¼›åœ¨è·å¾—äº†ç»“æœä¹‹åï¼Œä¼šæ ¹æ®å“åº”ç åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šå‘ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶é‚£ä¹ˆå°±ä¼šé‡å¯æ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨ã€‚ 2ã€æ¡¥æ¥æ‹¦æˆªå™¨åœ¨äº¤å‡ºä¹‹å‰ï¼Œè´Ÿè´£å°†HTTPåè®®å¿…å¤‡çš„è¯·æ±‚å¤´åŠ å…¥å…¶ä¸­(å¦‚ï¼šHost)å¹¶æ·»åŠ ä¸€äº›é»˜è®¤çš„è¡Œä¸º(å¦‚ï¼šGZIPå‹ç¼©)ï¼›åœ¨è·å¾—äº†ç»“æœåï¼Œè°ƒç”¨ä¿å­˜cookieæ¥å£å¹¶è§£æGZIPæ•°æ®ã€‚ 3ã€ç¼“å­˜æ‹¦æˆªå™¨é¡¾åæ€ä¹‰ï¼Œäº¤å‡ºä¹‹å‰è¯»å–å¹¶åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ç¼“å­˜ï¼›è·å¾—ç»“æœååˆ¤æ–­æ˜¯å¦ç¼“å­˜ã€‚ 4ã€è¿æ¥æ‹¦æˆªå™¨åœ¨äº¤å‡ºä¹‹å‰ï¼Œè´Ÿè´£æ‰¾åˆ°æˆ–è€…æ–°å»ºä¸€ä¸ªè¿æ¥ï¼Œå¹¶è·å¾—å¯¹åº”çš„socketæµï¼›åœ¨è·å¾—ç»“æœåä¸è¿›è¡Œé¢å¤–çš„å¤„ç†ã€‚ 5ã€è¯·æ±‚æœåŠ¡å™¨æ‹¦æˆªå™¨è¿›è¡ŒçœŸæ­£çš„ä¸æœåŠ¡å™¨çš„é€šä¿¡ï¼Œå‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè§£æè¯»å–çš„å“åº”æ•°æ®ã€‚ åœ¨ç»è¿‡äº†è¿™ä¸€ç³»åˆ—çš„æµç¨‹åï¼Œå°±å®Œæˆäº†ä¸€æ¬¡HTTPè¯·æ±‚ï¼ è¡¥å……: ä»£ç†åœ¨ä½¿ç”¨OkHttpæ—¶ï¼Œå¦‚æœç”¨æˆ·åœ¨åˆ›å»ºOkHttpClientæ—¶ï¼Œé…ç½®äº†proxyæˆ–è€…proxySelectorï¼Œåˆ™ä¼šä½¿ç”¨é…ç½®çš„ä»£ç†ï¼Œå¹¶ä¸”proxyä¼˜å…ˆçº§é«˜äºproxySelectorã€‚è€Œå¦‚æœæœªé…ç½®ï¼Œåˆ™ä¼šè·å–æœºå™¨é…ç½®çš„ä»£ç†å¹¶ä½¿ç”¨ã€‚ 123456789//JDK : ProxySelectortry { URI uri = new URI(&quot;http://restapi.amap.com&quot;); List&lt;Proxy&gt; proxyList = ProxySelector.getDefault().select(uri); System.out.println(proxyList.get(0).address()); System.out.println(proxyList.get(0).type());} catch (URISyntaxException e) { e.printStackTrace();} å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä¸éœ€è¦è‡ªå·±çš„Appä¸­çš„è¯·æ±‚èµ°ä»£ç†ï¼Œåˆ™å¯ä»¥é…ç½®ä¸€ä¸ªproxy(Proxy.NO_PROXY)ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥é¿å…è¢«æŠ“åŒ…ã€‚NO_PROXYçš„å®šä¹‰å¦‚ä¸‹ï¼š 12345public static final Proxy NO_PROXY = new Proxy();private Proxy() { this.type = Proxy.Type.DIRECT; this.sa = null;} ä»£ç†åœ¨Javaä¸­å¯¹åº”çš„æŠ½è±¡ç±»æœ‰ä¸‰ç§ç±»å‹: 1234567public static enum Type { DIRECT, HTTP, SOCKS; private Type() { }} DIRECTï¼šæ— ä»£ç†ï¼ŒHTTPï¼šhttpä»£ç†ï¼ŒSOCKSï¼šsocksä»£ç†ã€‚ç¬¬ä¸€ç§è‡ªç„¶ä¸ç”¨å¤šè¯´ï¼Œè€ŒHttpä»£ç†ä¸Socksä»£ç†æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ å¯¹äºSocksä»£ç†ï¼Œåœ¨HTTPçš„åœºæ™¯ä¸‹ï¼Œä»£ç†æœåŠ¡å™¨å®ŒæˆTCPæ•°æ®åŒ…çš„è½¬å‘å·¥ä½œ;è€ŒHttpä»£ç†æœåŠ¡å™¨ï¼Œåœ¨è½¬å‘æ•°æ®ä¹‹å¤–ï¼Œè¿˜ä¼šè§£æHTTPçš„è¯·æ±‚åŠå“åº”ï¼Œå¹¶æ ¹æ®è¯·æ±‚åŠå“åº”çš„å†…å®¹åšä¸€äº›å¤„ç†ã€‚ RealConnectionçš„connectSocketæ–¹æ³•: 123456//å¦‚æœæ˜¯Socksä»£ç†åˆ™ new Socket(proxy); å¦åˆ™ç›¸å½“äºç›´æ¥:new Socket()rawSocket = proxy.type() == Proxy.Type.DIRECT || proxy.type() == Proxy.Type.HTTP ? address.socketFactory().createSocket() : new Socket(proxy);//connectæ–¹æ³•socket.connect(address); è®¾ç½®äº†SOCKSä»£ç†çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºSocketæ—¶ï¼Œä¸ºå…¶ä¼ å…¥proxyï¼Œè¿æ¥æ—¶è¿˜æ˜¯ä»¥HTTPæœåŠ¡å™¨ä¸ºç›®æ ‡åœ°å€ï¼›ä½†æ˜¯å¦‚æœè®¾ç½®çš„æ˜¯Httpä»£ç†ï¼Œåˆ›å»ºSocketæ˜¯ä¸Httpä»£ç†æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚ åœ¨connectæ–¹æ³•æ—¶ä¼ é€’çš„addressæ¥è‡ªäºä¸‹é¢çš„é›†åˆinetSocketAddressesRouteSelectorçš„resetNextInetSocketAddressæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233private void resetNextInetSocketAddress(Proxy proxy) throws IOException { // ...... if (proxy.type() == Proxy.Type.DIRECT || proxy.type() == Proxy.Type.SOCKS) { //æ— ä»£ç†å’Œsocksä»£ç†ï¼Œä½¿ç”¨httpæœåŠ¡å™¨åŸŸåä¸ç«¯å£ socketHost = address.url().host(); socketPort = address.url().port(); } else { SocketAddress proxyAddress = proxy.address(); if (!(proxyAddress instanceof InetSocketAddress)) { throw new IllegalArgumentException( &quot;Proxy.address() is not an &quot; + &quot;InetSocketAddress: &quot; + proxyAddress.getClass()); } InetSocketAddress proxySocketAddress = (InetSocketAddress) proxyAddress; socketHost = getHostString(proxySocketAddress); socketPort = proxySocketAddress.getPort(); } // ...... if (proxy.type() == Proxy.Type.SOCKS) { //socksä»£ç† connect httpæœåŠ¡å™¨ ï¼ˆDNSæ²¡ç”¨ï¼Œç”±ä»£ç†æœåŠ¡å™¨è§£æåŸŸåï¼‰ inetSocketAddresses.add(InetSocketAddress.createUnresolved(socketHost, socketPort)); } else { //æ— ä»£ç†ï¼Œdnsè§£æhttpæœåŠ¡å™¨ //httpä»£ç†,dnsè§£æhttpä»£ç†æœåŠ¡å™¨ List&lt;InetAddress&gt; addresses = address.dns().lookup(socketHost); //...... for (int i = 0, size = addresses.size(); i &lt; size; i++) { InetAddress inetAddress = addresses.get(i); inetSocketAddresses.add(new InetSocketAddress(inetAddress, socketPort)); } }} è®¾ç½®ä»£ç†æ—¶ï¼ŒHttpæœåŠ¡å™¨çš„åŸŸåè§£æä¼šè¢«äº¤ç»™ä»£ç†æœåŠ¡å™¨æ‰§è¡Œã€‚ä½†æ˜¯å¦‚æœæ˜¯è®¾ç½®äº†Httpä»£ç†ï¼Œä¼šå¯¹Httpä»£ç†æœåŠ¡å™¨çš„åŸŸåä½¿ç”¨OkhttpClienté…ç½®çš„dnsè§£æä»£ç†æœåŠ¡å™¨ï¼ŒHttpæœåŠ¡å™¨çš„åŸŸåè§£æè¢«äº¤ç»™ä»£ç†æœåŠ¡å™¨è§£æã€‚ ä¸Šè¿°ä»£ç å°±æ˜¯ä»£ç†ä¸DNSåœ¨OkHttpä¸­çš„ä½¿ç”¨ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼ŒHttpä»£ç†ä¹Ÿåˆ†æˆä¸¤ç§ç±»å‹ï¼šæ™®é€šä»£ç†ä¸éš§é“ä»£ç†ã€‚ å…¶ä¸­æ™®é€šä»£ç†ä¸éœ€è¦é¢å¤–çš„æ“ä½œï¼Œæ‰®æ¼”ã€Œä¸­é—´äººã€çš„è§’è‰²ï¼Œåœ¨ä¸¤ç«¯ä¹‹é—´æ¥å›ä¼ é€’æŠ¥æ–‡ã€‚è¿™ä¸ªâ€œä¸­é—´äººâ€åœ¨æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚æŠ¥æ–‡æ—¶ï¼Œéœ€è¦æ­£ç¡®çš„å¤„ç†è¯·æ±‚å’Œè¿æ¥çŠ¶æ€ï¼ŒåŒæ—¶å‘æœåŠ¡å™¨å‘é€æ–°çš„è¯·æ±‚ï¼Œåœ¨æ”¶åˆ°å“åº”åï¼Œå°†å“åº”ç»“æœåŒ…è£…æˆä¸€ä¸ªå“åº”ä½“è¿”å›ç»™å®¢æˆ·ç«¯ã€‚åœ¨æ™®é€šä»£ç†çš„æµç¨‹ä¸­ï¼Œä»£ç†ä¸¤ç«¯éƒ½æ˜¯æœ‰å¯èƒ½å¯Ÿè§‰ä¸åˆ°â€ä¸­é—´äººâ€œçš„å­˜åœ¨ã€‚ ä½†æ˜¯éš§é“ä»£ç†ä¸å†ä½œä¸ºä¸­é—´äººï¼Œæ— æ³•æ”¹å†™å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè€Œä»…ä»…æ˜¯åœ¨å»ºç«‹è¿æ¥åï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œé€šè¿‡å»ºç«‹å¥½çš„éš§é“ï¼Œæ— è„‘çš„è½¬å‘ç»™ç»ˆç«¯æœåŠ¡å™¨ã€‚éš§é“ä»£ç†éœ€è¦å‘èµ·Http CONNECTè¯·æ±‚ï¼Œè¿™ç§è¯·æ±‚æ–¹å¼æ²¡æœ‰è¯·æ±‚ä½“ï¼Œä»…ä¾›ä»£ç†æœåŠ¡å™¨ä½¿ç”¨ï¼Œå¹¶ä¸ä¼šä¼ é€’ç»™ç»ˆç«¯æœåŠ¡å™¨ã€‚è¯·æ±‚å¤´ éƒ¨åˆ†ä¸€æ—¦ç»“æŸï¼Œåé¢çš„æ‰€æœ‰æ•°æ®ï¼Œéƒ½è¢«è§†ä¸ºåº”è¯¥è½¬å‘ç»™ç»ˆç«¯æœåŠ¡å™¨çš„æ•°æ®ï¼Œä»£ç†éœ€è¦æŠŠä»–ä»¬æ— è„‘çš„ç›´æ¥è½¬å‘ï¼Œç›´åˆ°ä»å®¢æˆ·ç«¯çš„ TCP è¯»é€šé“å…³é—­ã€‚CONNECT çš„å“åº”æŠ¥æ–‡ï¼Œåœ¨ä»£ç†æœåŠ¡å™¨å’Œç»ˆç«¯æœåŠ¡å™¨å»ºç«‹è¿æ¥åï¼Œå¯ä»¥å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª 200 Connect established çš„çŠ¶æ€ç ï¼Œä»¥æ­¤è¡¨ç¤ºå’Œç»ˆç«¯æœåŠ¡å™¨çš„è¿æ¥ï¼Œå»ºç«‹æˆåŠŸã€‚ RealConnectionçš„connectæ–¹æ³• 1234567891011if (route.requiresTunnel()) { connectTunnel(connectTimeout, readTimeout, writeTimeout, call, eventListener); if (rawSocket == null) { // We were unable to connect the tunnel but properly closed down our // resources. break; }} else { connectSocket(connectTimeout, readTimeout, call, eventListener);} requiresTunnelæ–¹æ³•çš„åˆ¤å®šä¸ºï¼šå½“å‰è¯·æ±‚ä¸ºhttpså¹¶ä¸”å­˜åœ¨httpä»£ç†ï¼Œè¿™æ—¶å€™connectTunnelä¸­ä¼šå‘èµ·: 1234CONNECT xxxx HTTP/1.1Host: xxxxProxy-Connection: Keep-AliveUser-Agent: okhttp/${version} çš„è¯·æ±‚ï¼Œè¿æ¥æˆåŠŸä»£ç†æœåŠ¡å™¨ä¼šè¿”å›200ï¼›å¦‚æœè¿”å›407è¡¨ç¤ºä»£ç†æœåŠ¡å™¨éœ€è¦é‰´æƒ(å¦‚ï¼šä»˜è´¹ä»£ç†)ï¼Œè¿™æ—¶éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŠ å…¥Proxy-Authorizationï¼š 123456789101112131415 Authenticator authenticator = new Authenticator() { @Nullable @Override public Request authenticate(Route route, Response response) throws IOException { if(response.code == 407){ //ä»£ç†é‰´æƒ String credential = Credentials.basic(&quot;ä»£ç†æœåŠ¡ç”¨æˆ·å&quot;, &quot;ä»£ç†æœåŠ¡å¯†ç &quot;); return response.request().newBuilder() .header(&quot;Proxy-Authorization&quot;, credential) .build(); } return null; } };new OkHttpClient.Builder().proxyAuthenticator(authenticator);","link":"/2020/12/10/okhttp/"},{"title":"æ³›å‹","text":"é—®é¢˜ 123456781ã€ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æ³›å‹ï¼Ÿ2ã€æ³›å‹ç±»ã€æ³›å‹æ¥å£å’Œæ³›å‹æ–¹æ³•3ã€å¦‚ä½•é™å®šç±»å‹å˜é‡ï¼Ÿ4ã€æ³›å‹ä½¿ç”¨ä¸­çš„çº¦æŸå’Œå±€é™æ€§5ã€æ³›å‹ç±»å‹èƒ½ç»§æ‰¿å—ï¼Ÿ6ã€æ³›å‹ä¸­é€šé…ç¬¦ç±»å‹7ã€è™šæ‹Ÿæœºæ˜¯å¦‚ä½•å®ç°æ³›å‹çš„ï¼Ÿ8ã€åå°„è·å–æ³›å‹çš„çœŸå®ç±»å‹ 1ã€ä¸ºä»€ä¹ˆéœ€è¦æ³›å‹ï¼Ÿ å¤šç§æ•°æ®ç±»å‹æ‰§è¡Œç›¸åŒçš„ä»£ç ï¼ˆå¢åŠ ä»£ç å¤ç”¨æ€§ï¼‰ åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ›´å¼ºçš„ç±»å‹æ£€æŸ¥ã€‚ ä½¿ç”¨æ³›å‹ä¸éœ€è¦å¼ºåˆ¶è½¬æ¢ç±»å‹ 2ã€æ³›å‹ç±»ã€æ³›å‹æ¥å£å’Œæ³›å‹æ–¹æ³•123456789101112131415161718192021222324252627282930313233--æ³›å‹ç±»public class Genericity&lt;T&gt; { private T data; public void setData(T data) { this.data = data; } public T getData() { return data; } --æ³›å‹æ–¹æ³• public &lt;T&gt; T getInput(T input){ return input; } --æ³›å‹æ–¹æ³•2 public &lt;E&gt; E getInput2(E input){ return input; } public static void main(String[] args) { //æ³›å‹ç±» Genericity&lt;String&gt; genericity=new Genericity&lt;&gt;(); genericity.setData(&quot;æ³›å‹&quot;); Genericity&lt;Integer&gt; genericityInteger=new Genericity&lt;&gt;(); genericityInteger.setData(1); //æ³›å‹æ–¹æ³• Genericity genericityMethod=new Genericity(); genericityMethod.getInput(&quot;11&quot;); genericityMethod.getInput(11); genericityMethod.getInput(1f); }} 123456789101112131415161718--æ³›å‹æ¥å£public interface Genertor&lt;T&gt; { public T next();}--å®ç°1ã€ä¸ä¼ å…¥å…·ä½“ç±»å‹public class GenertorImpl&lt;T&gt; implements Genertor&lt;T&gt; { @Override public T next() { return null; }}--å®ç°2ã€ä¼ å…¥å…·ä½“ç±»å‹Stringpublic class GenertorImpl2 implements Genertor&lt;String&gt; { @Override public String next() { return null; }} æ³›å‹ç±»åªå½±å“å®ƒçš„æ™®é€šæ–¹æ³• æ³›å‹ç±»çš„Tå’Œæ³›å‹æ–¹æ³•çš„Tæ¯«æ— å…³ç³»ï¼Œæ¢æˆå…¶ä»–ä¹Ÿä¸€æ ·ï¼Œä¾‹å¦‚Eï¼Œä½†æ˜¯æ–¹æ³•åä¸èƒ½ä¸€æ ·ï¼Œå› ä¸ºæ³›å‹åœ¨Javaç¼–è¯‘æ—¶æ˜¯Object æ³›å‹æ¥å£å®ç°æ—¶ï¼Œä¸ä¼ å…¥å…·ä½“ç±»å‹ä¼ å…¥Tæ—¶ï¼Œæ¥å£çš„æ–¹æ³•è¿”å›çš„ä¹Ÿæ˜¯Tã€‚å½“ä¼ å…¥å…·ä½“ç±»å‹æ—¶ï¼Œæ¥å£çš„æ–¹æ³•è¿”å›çš„ä¹Ÿæ˜¯å…·ä½“çš„ç±»å‹ã€‚ æ³›å‹æ–¹æ³•åªæœ‰æ–¹æ³•å‰é¢æœ‰çš„æ‰æ˜¯æ³›å‹æ–¹æ³• 3ã€å¦‚ä½•é™å®šç±»å‹å˜é‡ï¼Ÿ é™å®šç±»å‹æ˜¯å†™åœ¨ç±»ä¸Šçš„ 12345678public class GenertorClass&lt;T extends Comparable&gt; { public static void main(String[] args) { GenertorClass&lt;String&gt; genertorClass = new GenertorClass&lt;&gt;(); GenertorClass&lt;Object&gt; genertorClass2 = new GenertorClass&lt;&gt;(); //ä¼ å…¥Stringæ˜¯æ­£å¸¸çš„ï¼Œä¼ å…¥Objectæ—¶æŠ¥é”™ï¼š //Type parameter 'java.lang.Object' is not within its bound; should implement 'java.lang.Comparable' }} ä¸Šé¢ä»£ç ä¼ å…¥Stringæ—¶æ˜¯æ­£å¸¸çš„ï¼Œä¼ å…¥Objectæ—¶æŠ¥é”™ï¼šType parameter 'java.lang.Object' is not within its bound; should implement 'java.lang.Comparable' å› ä¸ºStringç»§æ‰¿äº† Comparableæ¥å£ï¼Œè€ŒObjectæ²¡æœ‰ç»§æ‰¿è¯¥æ¥å£ é™å®šç±»å‹å†™åœ¨æ–¹æ³•ä¸Š 12345678910public class GenertorClass&lt;T extends Comparable&gt; { public static &lt;T extends Comparable&gt; T min(T a, T b) { if (a.compareTo(b) &gt; 0) return a;else return b; } public static void main(String[] args) { GenertorClass.min(&quot;1&quot;,&quot;2&quot;); GenertorClass.min(&quot;1&quot;,new Object());//æŠ¥reason: no instance(s) of type variable(s) exist so that Object conforms to Comparable }} GenertorClass.min(â€œ1â€,â€2â€);æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºStringç»§æ‰¿äº†Comparableæ¥å£ï¼Œè€ŒObjectæ²¡æœ‰ç»§æ‰¿è¯¥æ¥å£ã€‚ å¤šä¸ªé™å®šç±»å‹ 12345678910111213--ç±»1public class Fruit {}--ç±»2public class Apple extends Fruit implements Serializable {}--ç±»3public class GenertorClass&lt;T extends Fruit &amp; Serializable&gt; { public static void main(String[] args) { GenertorClass&lt;Apple&gt; genertorClass = new GenertorClass&lt;&gt;(); GenertorClass&lt;Fruit&gt; genertorClass2 = new GenertorClass&lt;&gt;(); }} GenertorClassæ˜¯æ­£å¸¸çš„ï¼ŒGenertorClassæŠ¥é”™ï¼šType parameter 'Fruit' is not within its bound; should implement 'java.io.Serializable'ã€‚ å› ä¸ºä¸¤ä¸ªé™å®šç±»å‹éƒ½è¦å®ç°æ‰è¡Œï¼Œè€Œä¸”ç±»3ä¸­Fruit&amp;Serializableä¸¤ä¸ªä½ç½®ä¸èƒ½è°ƒæ¢ã€‚ T extends B Bå¯ä»¥æ˜¯ç±»ä¹Ÿå¯ä»¥æ˜¯æ¥å£ã€‚ æ³›å‹ç±»å’Œæ³›å‹æ–¹æ³•éƒ½å¯ä»¥ä½¿ç”¨å¤šä¸ªé™å®šç±»å‹ Bå¯ä»¥æ˜¯å¤šä¸ªå¯¹è±¡ï¼šT extends Comparable&amp;Serializableã€‚å¤šä¸ªå¯¹è±¡æ—¶ï¼Œä¼ å…¥çš„å¯¹è±¡å¿…éœ€è¦åŒæ—¶å®ç°å¤šä¸ªé™å®šç±»å‹Comparableå’ŒSerializable Bä¸ºç±»å’Œæ¥å£æ··åˆæ—¶ï¼Œç±»åªèƒ½æœ‰ä¸€ä¸ªï¼ˆjavaé‡Œå•ç»§æ‰¿ï¼Œå¤šå®ç°ï¼‰ï¼Œå¹¶ä¸”å¿…éœ€æ”¾åœ¨æœ€å‰é¢ ,å¦åˆ™ä¼šæŠ¥é”™ã€‚ 4ã€æ³›å‹ä½¿ç”¨ä¸­çš„çº¦æŸå’Œå±€é™æ€§ ä¸èƒ½å®ä¾‹åŒ–ç±»å‹å˜é‡ã€‚ 1T data = new T()//ä¸å…è®¸ é™æ€åŸŸæˆ–è€…é™æ€æ–¹æ³•é‡Œä¸èƒ½å¼•ç”¨ç±»å‹å˜é‡ã€‚ 1private static T instance;//ä¸å…è®¸ ï¼ˆå› ä¸ºåœ¨newå¯¹è±¡æ—¶ï¼Œæ‰çŸ¥é“æµ·å¤©çš„ç±»å‹ï¼Œè™šæ‹Ÿæœºè¿è¡Œæ—¶ï¼Œå…ˆæ‰§è¡Œstaticå¯¹è±¡ã€æ–¹æ³•ï¼Œå†æ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥é™æ€ä¸­ä½¿ç”¨æ³›å‹ï¼Œè™šæ‹Ÿæœºæ˜¯ä¸çŸ¥é“æ³›å‹ç±»å‹çš„ï¼‰ é™æ€æ–¹æ³•æœ¬èº«æ˜¯æ³›å‹æ–¹æ³•æ˜¯å¯è¡Œçš„ã€‚ 1priavte static &lt;T&gt; T getInstance(){}//å…è®¸ åŸºæœ¬ç±»å‹æ˜¯ä¸è¡Œçš„ã€‚ 1&lt;int&gt;,&lt;double&gt;//ä¸å…è®¸ int,double(ä¸æ˜¯å¯¹è±¡)ï¼Œåªå…è®¸å…¶åŒ…è£…ç±»Integerï¼ŒDouble ä¸èƒ½ä½¿ç”¨instanceofå…³é”®å­—åˆ¤æ–­å˜é‡ç±»å‹ã€‚ 12Test&lt;Double&gt; test=new Test&lt;&gt;();if(test instanceof Test&lt;Double&gt;){}//ä¸å…è®¸ æ³›å‹èƒ½å®šä¹‰æ•°æ®ï¼Œä½†ä¸èƒ½åˆ›å»ºæ•°ç»„ï¼ˆnew å¯¹è±¡ï¼‰ 12private T[] list;//å…è®¸private T[] list2=new T[2];//ä¸å…è®¸ æ³›å‹ç±»è·å–çš„ä¸€å®šæ˜¯ç±»çš„åŸç”Ÿç±»å‹ 123456789Test&lt;Integer&gt; test1 = new Test&lt;&gt;();Test&lt;String&gt; test2 = new Test&lt;&gt;();System.out.println(test1.getClass()==test2.getClass());System.out.println(test1.getClass().getName());System.out.println(test2.getClass().getName());out:========================================truecom.example.annotation.Testcom.example.annotation.Test è¿™é‡Œçš„åŸç”Ÿç±»å‹æ˜¯Testï¼Œå’Œä¼ çš„å‚æ•°æ— å…³ç´§è¦ æ³›å‹ç±»ä¸èƒ½ç»§æ‰¿Exception 12class Problem&lt;T&gt; extends Exception{}//ä¸å…è®¸//æŠ¥é”™ï¼šGeneric class may not extend 'java.lang.Throwable' ä¸èƒ½æ•è·æ³›å‹ç±»å¯¹è±¡ 12345678public &lt;T extends Throwable&gt; void doWork(T t) throws T { try { // do... } catch (T e) { //æŠ¥é”™ //do something throw t; }} ä¸èƒ½æ•è·ï¼Œä½†æ˜¯å¯ä»¥æŠ›å‡º 1234567public &lt;T extends Throwable&gt; void doWork2(T x) throws T { try { //do... } catch (Throwable e) { throw x; //å…è®¸çš„ }} 5ã€æ³›å‹ç±»å‹èƒ½ç»§æ‰¿å—ï¼Ÿ 12345678//ç±» Worker extents Employeeç±»public class Employee {}public class Worker extends Employee {}//æ³›å‹ç±»Pairpublic class Pair&lt;T&gt; {} Pairå’ŒPair æ²¡æœ‰ä»»ä½•ç»§æ‰¿å…³ç³» 1Pair&lt;Employee&gt; employeePair= new Pair&lt;Worker&gt;();//ä¸å…è®¸ï¼Œé”™è¯¯çš„ 1234567891011121314public class Pair&lt;T&gt; { private T data; public T getData() { return data; } public void setData(T data) { this.data = data; } }public class ExtendPair&lt;T&gt; extends Pair&lt;T&gt;{} æ³›å‹ç±»å¯ä»¥ç»§æ‰¿æˆ–è€…æ‰©å±•å…¶ä»–æ³›å‹ç±» //æ¯”å¦‚Listå’ŒArrayList 1Pair&lt;Employee&gt; employee = new ExtendPair&lt;&gt;; //å…è®¸çš„ 6ã€æ³›å‹ä¸­é€šé…ç¬¦ç±»å‹ï¼ˆ?åªç”¨åœ¨æ–¹æ³•ä¸Šï¼‰é€šé…ç¬¦ä¸»è¦ç”¨äºå®‰å…¨çš„è®¿é—®æ•°æ® 12345678910public class Food {}public class Fruit extends Food{}public class Apple extends Fruit{}public class Orange extends Fruit{}public class HongFuShi extends Apple{} è¡¨ç¤ºPairä¼ è¿›å»çš„ç±»å‹å‚æ•°æ˜¯Fruitçš„å­ç±»åŒ…æ‹¬Fruitæœ¬èº«ï¼ˆFruit,Apple,Orange,HongFuShiï¼‰ extendså†³å®šäº†ç±»å‹å‚æ•°çš„ä¸Šç•Œï¼šå‘ä¸‹çš„èŒƒå›´ï¼Œå³æ³›å‹å¯¹è±¡å¿…éœ€ç»§æ‰¿Fruitæˆ–Fruitæœ¬èº«â€“Foodä¸å¯ä»¥ã€‚ 1234567891011//é™å®šç±»å‹Fruitpublic static void printClassName(Pair&lt;? extends Fruit&gt; data) { System.out.println(data.getClass().getSimpleName());}Pair&lt;Fruit&gt; fruitPair = new Pair&lt;&gt;();Pair&lt;Apple&gt; applePair = new Pair&lt;&gt;();Pair&lt;Food&gt; foodPair = new Pair&lt;&gt;();Pair.printClassName(fruitPair);//å…è®¸Pair.printClassName(applePair);//å…è®¸Pair.printClassName(foodPair);//ä¸å…è®¸//é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: Pair&lt;Food&gt;æ— æ³•è½¬æ¢ä¸ºPair&lt;? extends Fruit&gt; 1234567//é™å®šç±»å‹å˜é‡èµ‹å€¼æ—¶ï¼Œä¹Ÿæ˜¯åªèƒ½ä½¿ç”¨ä¼ å…¥Fruitå­ç±»æˆ–è€…æœ¬èº«çš„å¯¹è±¡Pair&lt;Fruit&gt; fruitPair = new Pair&lt;&gt;();Pair&lt;Apple&gt; applePair = new Pair&lt;&gt;();Pair&lt;Food&gt; foodPair = new Pair&lt;&gt;();Pair&lt;? extends Fruit&gt; f = fruitPair;//å…è®¸Pair&lt;? extends Fruit&gt; f2 = applePair;//å…è®¸Pair&lt;? extends Fruit&gt; f3 = foodPair;//ä¸å…è®¸ ä½¿ç”¨&lt;? extends Fruit&gt;ç»™å¯¹è±¡setï¼Œgetå€¼æ—¶ï¼šsetæ˜¯ä¸å…è®¸çš„ï¼Œgetåªèƒ½getåˆ°Fruitå¯¹è±¡ï¼Œå³extendsçš„ä¸Šç•Œç±»å‹ã€‚ 123456789101112131415Pair&lt;Fruit&gt; fruitPair = new Pair&lt;&gt;();Pair&lt;Apple&gt; applePair = new Pair&lt;&gt;();Pair&lt;? extends Fruit&gt; data = fruitPair;æˆ–Pair&lt;? extends Fruit&gt; data = applePair;data.setData(new Apple());//ä¸å…è®¸data.setData(new Fruit());//ä¸å…è®¸//é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: Fruitæ— æ³•è½¬æ¢ä¸ºCAP#1// data.setData(new Fruit());// ^// å…¶ä¸­, CAP#1æ˜¯æ–°ç±»å‹å˜é‡:// CAP#1ä»? extends Fruitçš„æ•è·æ‰©å±•FruitFruit fruit = data.getData();//å…è®¸ï¼Œè·å–åˆ°Fruitå¯¹è±¡Apple apple = (Apple) data.getData();//éœ€è¦è½¬å‹ï¼Œå¦‚æœç±»å‹ä¸æ­£ç¡®ä¼šæŠ¥ClassCastExceptionå¼ºè½¬å¼‚å¸¸ getæ–¹æ³•ï¼šä¸ç®¡æˆ‘ä»¬ä¼ çš„æ˜¯Fruitè¿˜æ˜¯å®ƒçš„å­ç±»ï¼Œå¯¹äºç¼–è¯‘å™¨æ¥è¯´æˆ‘ä»¬ä¼ çš„ä¸€å®šæ˜¯ä¸ªFruitï¼Œæ‰€ä»¥è·å–åˆ°çš„å¯¹è±¡ä¸€å®šæ˜¯ä¸ªFruitï¼ˆå­ç±»ç»§æ‰¿Fruitï¼‰ã€‚ setæ–¹æ³•ï¼šå¯¹äºç¼–è¯‘å™¨æ¥è¯´ä½ ä¼ çš„æ˜¯ä¸ªFruit,ä½†æ˜¯æ˜¯å…·ä½“çš„å“ªä¸€ä¸ªå­ç±»ï¼Œç¼–è¯‘å™¨æ˜¯ä¸çŸ¥é“çš„ã€‚ &lt;? extends Fruit&gt;ä¸»è¦ç”¨äºå®‰å…¨çš„è®¿é—®æ•°æ®â€“è¯»æ•°æ® è¡¨ç¤ºPairä¼ è¿›å»çš„ç±»å‹å‚æ•°æ˜¯Appleçš„çˆ¶ç±»åŒ…æ‹¬Appleæœ¬èº«ã€‚(Apple,Fruit,Food) super å†³å®šäº†ç±»å‹å‚æ•°çš„ä¸‹ç•Œï¼šå‘ä¸Šçš„èŒƒå›´ï¼Œå³æ³›å‹å¯¹è±¡æ˜¯Appleçš„è¶…ç±»æˆ–Appleæœ¬èº«â€“HongFuShiä¸å¯ä»¥ã€‚ 12345678910111213141516171819202122232425262728293031323334public static void printSuper(Pair&lt;? super Apple&gt; data){ System.out.println(data.getClass().getSimpleName());}Pair&lt;Fruit&gt; fruitPair = new Pair&lt;&gt;();Pair&lt;Apple&gt; applePair = new Pair&lt;&gt;();Pair&lt;Orange&gt; orangePair = new Pair&lt;&gt;();Pair&lt;HongFuShi&gt; hongFuShiPair = new Pair&lt;&gt;();printSuper(fruitPair);//å…è®¸printSuper(applePair);//å…è®¸printSuper(orangePair);//ä¸å…è®¸ï¼Œå¹³çº§ç±»printSuper(hongFuShiPair);//ä¸å…è®¸//é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: Pair&lt;HongFuShi&gt;æ— æ³•è½¬æ¢ä¸ºPair&lt;? super Apple&gt;// printSuper(hongFuShiPair);Pair&lt;? super Apple&gt; data = fruitPair; //å…è®¸Pair&lt;? super Apple&gt; data = applePair; //å…è®¸Pair&lt;? super Apple&gt; data = hongFuShiPair; //ä¸å…è®¸//é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: Pair&lt;HongFuShi&gt;æ— æ³•è½¬æ¢ä¸ºPair&lt;? super Apple&gt;// Pair&lt;? super Apple&gt; data = hongFuShiPair;// ^ä½†æ˜¯åœ¨è®¾å€¼çš„æ—¶å€™åªèƒ½è®¾ç½®Appleçš„å­ç±»å’Œå®ƒæœ¬èº«data.setData(new Apple()); //å…è®¸data.setData(new HongFuShi()); //å…è®¸data.setData(new Fruit()); //ä¸å…è®¸//é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: Fruitæ— æ³•è½¬æ¢ä¸ºCAP#1// data.setData(new Fruit());// ^// å…¶ä¸­, CAP#1æ˜¯æ–°ç±»å‹å˜é‡:// CAP#1ä»? super Appleçš„æ•è·æ‰©å±•Object è¶… Appleè·å–æ•°æ®æ—¶è·å–åˆ°çš„æ˜¯Objectå¯¹è±¡Object object = data.getData(); setæ–¹æ³•ï¼šåªèƒ½ä¼ Appleå’Œå…¶å­ç±»ï¼Œï¼ˆå› ä¸ºå­ç±»åŒ…å«äº†Appleæˆ–è€…HongFuShiï¼Œå­ç±»å¯ä»¥å®‰å…¨çš„è½¬æ¢ä¸º super Appleï¼‰ getæ–¹æ³•ï¼šè·å–çš„å¯¹è±¡ä¸€å®šæ˜¯Appleçš„è¶…ç±»ï¼ŒJavaä¸­Objectä¸€å®šæ˜¯Appleçš„è¶…ç±»ã€‚æ‰€ä»¥è¿”å›çš„æ˜¯Object &lt;? super Apple&gt;ä¸»è¦ç”¨äºå®‰å…¨çš„å†™å…¥æ•°æ®ï¼Œåªèƒ½æ˜¯å…¶æœ¬èº«Appleå’Œå…¶å­ç±» 7ã€è™šæ‹Ÿæœºæ˜¯å¦‚ä½•å®ç°æ³›å‹çš„ï¼Ÿæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„æ³›å‹ç±» 1234567891011public class GenertorASM&lt;E&gt; { private E data; public E getData() { return data; } public void setData(E data) { this.data = data; }} é€šè¿‡å­—èŠ‚ç æŸ¥çœ‹å·¥å…·æŸ¥çœ‹è¯¥ç±»çš„å­—èŠ‚ç  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465// class version 52.0 (52)// access flags 0x21// signature &lt;E:Ljava/lang/Object;&gt;Ljava/lang/Object;// declaration: GenertorASM&lt;E&gt;public class GenertorASM { // compiled from: GenertorASM.java // access flags 0x2 // signature TE; // declaration: data extends E private Ljava/lang/Object; data // access flags 0x1 public &lt;init&gt;()V L0 LINENUMBER 8 L0 ALOAD 0 INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V RETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature ()TE; // declaration: E getData() public getData()Ljava/lang/Object; L0 LINENUMBER 12 L0 ALOAD 0 GETFIELD GenertorASM.data : Ljava/lang/Object; ARETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature (TE;)V // declaration: void setData(E) public setData(Ljava/lang/Object;)V L0 LINENUMBER 16 L0 ALOAD 0 ALOAD 1 PUTFIELD GenertorASM.data : Ljava/lang/Object; L1 LINENUMBER 17 L1 RETURN L2 LOCALVARIABLE this LGenertorASM; L0 L2 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; LOCALVARIABLE data Ljava/lang/Object; L0 L2 1 // signature TE; // declaration: data extends E MAXSTACK = 2 MAXLOCALS = 2} æˆ–è€…ä½¿ç”¨javapå‘½ä»¤åç¼–è¯‘.classæ–‡ä»¶ 123456789101112131415161718192021222324252627282930313233343536373839javap -c -l GenertorASM.class // -cå¯¹ä»£ç è¿›è¡Œåæ±‡ç¼–,-lè¾“å‡ºè¡Œå·å’Œæœ¬åœ°å˜é‡è¡¨ public class GenertorASM&lt;E&gt; { public GenertorASM(); Code: 0: aload_0 1: invokespecial #1 // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V 4: return LineNumberTable: line 8: 0 LocalVariableTable: Start Length Slot Name Signature 0 5 0 this LGenertorASM; public E getData(); Code: 0: aload_0 1: getfield #2 // Field data:Ljava/lang/Object; 4: areturn LineNumberTable: line 12: 0 LocalVariableTable: Start Length Slot Name Signature 0 5 0 this LGenertorASM; public void setData(E); Code: 0: aload_0 1: aload_1 2: putfield #2 // Field data:Ljava/lang/Object; 5: return LineNumberTable: line 16: 0 line 17: 5 LocalVariableTable: Start Length Slot Name Signature 0 6 0 this LGenertorASM; 0 6 1 data Ljava/lang/Object;} é€šè¿‡åç¼–è¯‘åï¼Œå¯ä»¥çœ‹åˆ°æ³›å‹è¢«æ“¦é™¤äº†ï¼Œå¯¹åº”çš„æ˜¯Objectå¯¹è±¡ï¼Œä½†åœ¨çš„signatureä¸­è®°å½•äº†æ³›å‹ã€‚ æ³›å‹æ“¦é™¤çš„åŸå› ï¼š åœ¨Java1.5ä¹‹å‰ä¸å­˜åœ¨æ³›å‹çš„ï¼Œ1.5ä¹‹åæ‰æ·»åŠ çš„æ³›å‹ï¼Œä¸ºäº†å‘ä¸‹å…¼å®¹ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨äº†æ³›å‹æ“¦é™¤ç”¨Objectä»£æ›¿ã€‚ ä½¿ç”¨æ³›å‹é™å®šç¬¦æ—¶,javaç¼–è¯‘æ—¶ä¼šå°†æ³›å‹è½¬æˆé™å®šç¬¦çš„ç±» 123456789public class GenertorASM&lt;E extends Fruit&gt; { private E data; public E getData() { return data; } public void setData(E data) { this.data = data; }} å­—èŠ‚ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465// class version 52.0 (52)// access flags 0x21// signature &lt;E:LFruit;&gt;Ljava/lang/Object;// declaration: GenertorASM&lt;E extends Fruit&gt;public class GenertorASM { // compiled from: GenertorASM.java // access flags 0x2 // signature TE; // declaration: data extends E private LFruit; data // access flags 0x1 public &lt;init&gt;()V L0 LINENUMBER 8 L0 ALOAD 0 INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V RETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature ()TE; // declaration: E getData() public getData()LFruit; L0 LINENUMBER 11 L0 ALOAD 0 GETFIELD GenertorASM.data : LFruit; ARETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature (TE;)V // declaration: void setData(E) public setData(LFruit;)V L0 LINENUMBER 14 L0 ALOAD 0 ALOAD 1 PUTFIELD GenertorASM.data : LFruit; L1 LINENUMBER 15 L1 RETURN L2 LOCALVARIABLE this LGenertorASM; L0 L2 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; LOCALVARIABLE data LFruit; L0 L2 1 // signature TE; // declaration: data extends E MAXSTACK = 2 MAXLOCALS = 2} å¦‚æœé™å®šç¬¦æœ‰å¤šä¸ªæ—¶ï¼Œå­—èŠ‚ç ä¸­æ³›å‹ä½¿ç”¨ç¬¬ä¸€ä¸ªé™å®šçš„ç±»å‹ï¼Œåœ¨ä½¿ç”¨å…¶ä»–çš„ç±»å‹æ—¶ï¼Œä¼šä½¿ç”¨å¼ºè½¬æˆå¯¹åº”çš„ç±»å‹ï¼ˆæ‰€ä»¥å¤šä¸ªé™å®šç¬¦æ—¶è¦æ³¨æ„å¼ºè½¬å¼‚å¸¸ï¼‰ 123456789101112131415public class GenertorASM&lt;E extends Fruit &amp; Comparable&gt; { private E data; public E getData() { return data; } public void setData(E data) { this.data = data; } public E compare(E data1, E data2) { return data1.compareTo(data2) &gt; 0 ? data1 : data2; }} å­—èŠ‚ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798// class version 52.0 (52)// access flags 0x21// signature &lt;E:LFruit;:Ljava/lang/Comparable;&gt;Ljava/lang/Object;// declaration: GenertorASM&lt;E extends Fruit extends java.lang.Comparable&gt;public class GenertorASM { // compiled from: GenertorASM.java // access flags 0x2 // signature TE; // declaration: data extends E private LFruit; data // access flags 0x1 public &lt;init&gt;()V L0 LINENUMBER 8 L0 ALOAD 0 INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V RETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature ()TE; // declaration: E getData() public getData()LFruit; L0 LINENUMBER 12 L0 ALOAD 0 GETFIELD GenertorASM.data : LFruit; ARETURN L1 LOCALVARIABLE this LGenertorASM; L0 L1 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x1 // signature (TE;)V // declaration: void setData(E) public setData(LFruit;)V L0 LINENUMBER 16 L0 ALOAD 0 ALOAD 1 PUTFIELD GenertorASM.data : LFruit; L1 LINENUMBER 17 L1 RETURN L2 LOCALVARIABLE this LGenertorASM; L0 L2 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; LOCALVARIABLE data LFruit; L0 L2 1 // signature TE; // declaration: data extends E MAXSTACK = 2 MAXLOCALS = 2 // access flags 0x1 // signature (TE;TE;)TE; // declaration: E compare(E, E) public compare(LFruit;LFruit;)LFruit; L0 LINENUMBER 20 L0 ALOAD 1 CHECKCAST java/lang/Comparable ALOAD 2 INVOKEINTERFACE java/lang/Comparable.compareTo (Ljava/lang/Object;)I (itf) IFLE L1 ALOAD 1 GOTO L2 L1 FRAME SAME ALOAD 2 L2 FRAME SAME1 Fruit ARETURN L3 LOCALVARIABLE this LGenertorASM; L0 L3 0 // signature LGenertorASM&lt;TE;&gt;; // declaration: this extends GenertorASM&lt;E&gt; LOCALVARIABLE data1 LFruit; L0 L3 1 // signature TE; // declaration: data1 extends E LOCALVARIABLE data2 LFruit; L0 L3 2 // signature TE; // declaration: data2 extends E MAXSTACK = 2 MAXLOCALS = 3} åœ¨å­—èŠ‚ç ä¸­CHECKCAST java/lang/Comparable å°†å¯¹è±¡å¼ºè½¬æˆComparableç±»å‹ 8ã€åå°„è·å–æ³›å‹çš„çœŸå®ç±»å‹å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªæ³›å‹ç±»è¿›è¡Œåå°„æ—¶ï¼Œéœ€è¦å¾—åˆ°æ³›å‹ä¸­çš„çœŸå®æ•°æ®ç±»å‹ï¼Œä¸šå®Œæˆå¦‚jsonååºåˆ—åŒ–çš„æ“ä½œã€‚æ­¤æ—¶éœ€è¦é€šè¿‡Typeä½“ç³»æ¥å®Œæˆã€‚Typeæ¥å£åŒ…å«äº†ä¸€ä¸ªå®ç°ç±»(Class)å’Œå››ä¸ªå®ç°æ¥å£ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯ï¼š TypeVariable æ³›å‹ç±»å‹å˜é‡ã€‚å¯ä»¥è·å¾—æ³›å‹ä¸Šä¸‹é™ç­‰ä¿¡æ¯ã€‚ ParameterizedType å…·ä½“çš„æ³›å‹ç±»å‹ï¼Œå¯ä»¥è·å¾—å…ƒæ•°æ®ä¸­æ³›å‹ç­¾åç±»å‹ï¼ˆæ³›å‹çœŸå®ç±»å‹ï¼‰ã€‚ GenericArrayType å½“éœ€è¦æè¿°çš„ç±»å‹æ˜¯æ³›å‹ç±»çš„æ•°ç»„æ—¶ï¼Œæ¯”å¦‚List[],Map[]ï¼Œæ­¤æ¥å£ä¼šä½œä¸ºTypeçš„å®ç°ã€‚ WildcardType é€šé…ç¬¦æ³›å‹ï¼Œè·å¾—ä¸Šä¸‹é™ä¿¡æ¯ã€‚ Typeæ˜¯ä¸ªæ¥å£,å®ƒçš„ç›´æ¥å®ç°ç±»å°±æ˜¯Class 123456789package java.lang.reflect;/** * @since 1.5 */public interface Type { default String getTypeName() { return toString(); }} 123public final class Class&lt;T&gt; implements Type{ } æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªResponseæ³›å‹ç±» 1234567891011121314151617181920212223242526272829public class Response&lt;T&gt; { T data; int code; String message; public Response(T data, int code, String message) { this.data = data; this.code = code; this.message = message; } static class Data { String result; public Data(String result) { this.result = result; } } public static void main(String[] args) { Response&lt;Data&gt; response = new Response&lt;&gt;(new Data(&quot;æ•°æ®&quot;), 0, &quot;æˆåŠŸ&quot;); Gson gson = new Gson(); String json = gson.toJson(response); System.out.println(json); Response&lt;Data&gt; result = gson.fromJson(json,Response.class); System.out.println(result.data.getClass()); }} æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªresponseå¯¹è±¡ä¼ å…¥Dataæ•°æ®ç±»å‹ï¼Œæ‰“å°åºåˆ—åŒ–åçš„æ•°æ® {&quot;data&quot;:{&quot;result&quot;:&quot;æ•°æ®&quot;},&quot;code&quot;:0,&quot;message&quot;:&quot;æˆåŠŸ&quot;} ç„¶åæˆ‘ä»¬é€šè¿‡gsonååºåˆ—åŒ–æ‰“å°dataç±»å‹ 12//Exception in thread &quot;main&quot; java.lang.ClassCastException: com.google.gson.internal.LinkedTreeMap cannot be cast to com.lis.wanjob.jol.Response$Data// at com.lis.wanjob.jol.Response.main(Response.java:35) gsonè§£ææ—¶ä¼šæŠŠDataè®¤ä¸ºæ˜¯LinkedTreeMapç±»å‹ï¼Œæ‰€ä»¥åœ¨æ‰“å°æ—¶å¼ºåˆ¶è½¬æ¢æ—¶æŠ¥é”™äº†ã€‚ æ­£ç¡®çš„è§£ææ˜¯é€šè¿‡Type 12345678Type type = new TypeToken&lt;Response&lt;Data&gt;&gt;() { }.getType();System.out.println(type);Response&lt;Data&gt; result = gson.fromJson(json, type);System.out.println(result.data.getClass());--æ‰“å°ç»“æœä¸ºï¼šcom.lis.wanjob.jol.Response&lt;com.lis.wanjob.jol.Response$Data&gt;class com.lis.wanjob.jol.Response$Data æˆ‘ä»¬çœ‹ä¸€ä¸‹TypeTokençš„æºç ï¼š 1234567891011121314151617 protected TypeToken() { this.type = getSuperclassTypeParameter(this.getClass()); this.rawType = Types.getRawType(this.type); this.hashCode = this.type.hashCode(); } static Type getSuperclassTypeParameter(Class&lt;?&gt; subclass) { Type superclass = subclass.getGenericSuperclass(); if (superclass instanceof Class) { throw new RuntimeException(&quot;Missing type parameter.&quot;); } else { ParameterizedType parameterized = (ParameterizedType)superclass; return Types.canonicalize(parameterized.getActualTypeArguments()[0]); } }public final Type getType() { return this.type; } è¿™é‡Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯TypeToken å—ä¿æŠ¤çš„æ„é€ å‡½æ•°ï¼ŒgetType()å°±æ˜¯è¿”å›çš„type. getSuperclassTypeParameter()æ–¹æ³•ä¸­ï¼Œå¦‚æœTypeTokenç±»çš„ç±»å‹typeæ˜¯æ³›å‹ç±»å‹çš„è¯ï¼Œä¼šè¢«è£…è½½ä¸ºTypeçš„å­æ¥å£ParameterizedTypeï¼Œå¯ä»¥è®©æˆ‘ä»¬å¾—åˆ°å…·ä½“çš„æ³›å‹ç±»å‹ã€‚ åœ¨å®ä¾‹åŒ–TypeTokenæ—¶ä½¿ç”¨{}ï¼Œå®é™…ä¸Šæ˜¯åŒ¿åå†…éƒ¨ç±»ã€‚ æˆ‘ä»¬è‡ªå·±åˆ›å»ºä¸ªç±»æ¥è§£ææ³›å‹çš„çœŸå®ç±»å‹ 123456789101112131415static class TypeReference&lt;T&gt; { Type actualTyep; Type getType() { return actualTyep; } public TypeReference() { Type superclass = getClass().getGenericSuperclass(); ParameterizedType type = (ParameterizedType) superclass; //è¿™é‡Œæ˜¯æ•°ç»„ï¼Œå› ä¸ºæ³›å‹å¯ä»¥æœ‰å¤šä¸ª&lt;T,E&gt; Type[] actualTypeArguments = type.getActualTypeArguments(); actualTyep = actualTypeArguments[0]; }} ä¸åŠ {}12345//ä¸åŠ {}æ—¶ï¼Œnew TypeReference&lt;Response&lt;Data&gt;&gt;()ä»£è¡¨ä¸€ä¸ªå¯¹è±¡Type type2 = new TypeReference&lt;Response&lt;Data&gt;&gt;(){}.getType();System.out.println(type2);Response&lt;Data&gt; result = gson.fromJson(json, type2);System.out.println(result.data.getClass()); æˆ‘ä»¬åœ¨è¾“å‡ºæ—¶ï¼Œä¸åŠ {}æ—¶æŠ¥é”™ 123Exception in thread &quot;main&quot; java.lang.ClassCastException: java.lang.Class cannot be cast to java.lang.reflect.ParameterizedType at com.lis.wanjob.jol.Response$TypeReference.&lt;init&gt;(Response.java:41) at com.lis.wanjob.jol.Response.main(Response.java:62) åŠ {}12345//åŠ {}æ—¶ï¼Œnew TypeReference&lt;Response&lt;Data&gt;&gt;(){}ä»£è¡¨ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»Type type2 = new TypeReference&lt;Response&lt;Data&gt;&gt;(){}.getType();System.out.println(type2);Response&lt;Data&gt; result = gson.fromJson(json, type2);System.out.println(result.data.getClass()); æˆ‘ä»¬è¾“å‡ºæ—¶ï¼šèƒ½æ­£å¸¸çš„æ‰“å°æ³›å‹çš„çœŸå®ç±»å‹ 12com.lis.wanjob.jol.Response&lt;com.lis.wanjob.jol.Response$Data&gt;class com.lis.wanjob.jol.Response$Data å› ä¸ºä¸åŠ {}æ—¶ï¼Œnew TypeReference&lt;Response&gt;()åªæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨TypeReferenceæ²¡æœ‰è®°å½•æ³›å‹çœŸå®ç±»å‹çš„åœ°æ–¹ï¼Œæ­¤æ—¶çš„Typeå°±æ˜¯Class,æ‰€ä»¥å¼ºè½¬ParameterizedTypeæ—¶ä¼šæŠ¥é”™ã€‚ç¼–è¯‘æ–‡ä»¶Response$TypeReference.classï¼Œasä¸­æŸ¥çœ‹ï¼š 1234567891011121314class Response$TypeReference&lt;T&gt; { Type actualTyep; Type getType() { return this.actualTyep; } public Response$TypeReference() { Type superclass = this.getClass().getGenericSuperclass(); ParameterizedType type = (ParameterizedType)superclass; Type[] actualTypeArguments = type.getActualTypeArguments(); this.actualTyep = actualTypeArguments[0]; }} åŠ äº†{}æ—¶ï¼Œnew TypeReference&lt;Response&gt;(){}æ˜¯åŒ¿åå†…éƒ¨ç±»ï¼Œç¼–è¯‘æ—¶ï¼Œä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆå¯¹åº”çš„å†…éƒ¨ç±»çš„æ–‡ä»¶Response$1.classï¼Œæˆ‘ä»¬åœ¨asä¸­æ‰“å¼€çœ‹åˆ°å¦‚ä¸‹ä»£ç  1234final class Response$1 extends TypeReference&lt;Response&lt;Data&gt;&gt; { Response$1() { }} å†…éƒ¨ç±»ä¸­è®°å½•äº†æ³›å‹çš„çœŸå®ç±»å‹ã€‚åœ¨getType()è·å–ç±»å‹æ—¶ï¼Œå…¶å®æ˜¯è·å–çš„å†…éƒ¨ç±»çš„ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—åˆ°æ³›å‹çš„çœŸå®ç±»å‹ã€‚ PSï¼šæˆ‘ä»¬å¯ä»¥å°†è§£ææ³›å‹çš„çœŸå®ç±»å‹çš„ç±»å®šä¹‰ä¸ºæŠ½è±¡æˆ–å°†æ„é€ æ–¹æ³•æ”¹ä¸ºå—ä¿æŠ¤çš„ï¼ˆå¿…éœ€ä¸åŒåŒ…ä¸‹ï¼‰ï¼Œè¿™æ ·åœ¨åˆ›å»ºè§£æç±»æ—¶å¿…éœ€åŠ {}æˆä¸ºåŒ¿åå†…éƒ¨ç±»ï¼Œæ¥è·å–æ³›å‹çš„çœŸå®ç±»å‹ã€‚ 123456static abstract class TypeReference&lt;T&gt;{}æˆ–static class TypeReference&lt;T&gt; { protected TypeReference() { }}","link":"/2021/11/28/%E6%B3%9B%E5%9E%8B/"}],"tags":[{"name":"activity","slug":"activity","link":"/tags/activity/"},{"name":"dispatch","slug":"dispatch","link":"/tags/dispatch/"},{"name":"OkHttp","slug":"OkHttp","link":"/tags/OkHttp/"},{"name":"Java","slug":"Java","link":"/tags/Java/"},{"name":"æ³›å‹","slug":"æ³›å‹","link":"/tags/%E6%B3%9B%E5%9E%8B/"}],"categories":[{"name":"Androidä¸‰æ–¹åº“æºç åˆ†æ","slug":"Androidä¸‰æ–¹åº“æºç åˆ†æ","link":"/categories/Android%E4%B8%89%E6%96%B9%E5%BA%93%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},{"name":"JavaåŸºç¡€ä¸è¿›é˜¶","slug":"JavaåŸºç¡€ä¸è¿›é˜¶","link":"/categories/Java%E5%9F%BA%E7%A1%80%E4%B8%8E%E8%BF%9B%E9%98%B6/"}]}